name: pii-scan

on:
  pull_request:
    paths:
      - 'tests/**'
      - 'apps/**'
      - 'deltacrown/**'
  push:
    branches: [master]

# Default permissions: read-only
permissions:
  contents: read

jobs:
  scan-pii:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for PII in code
        run: |
          echo "üîç Scanning for PII patterns (emails, IPs, usernames)..."
          
          # Email pattern (reject real emails, allow example.com and project email)
          echo "Checking for real email addresses..."
          if grep -rE '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' tests/ apps/ deltacrown/ 2>/dev/null | \
             grep -v 'example\.com' | \
             grep -v 'example\.org' | \
             grep -v 'test\.local' | \
             grep -v '@faker' | \
             grep -v '@localhost' | \
             grep -v 'deltacrownhq@gmail\.com' | \
             grep -v 'DeltaCrownEmail' | \
             grep -v 'tests/fixtures/' | \
             grep -v '# PII: safe' | \
             grep -v 'EmailField' | \
             grep -v 'email_field' | \
             grep -v 'serializers\.py' | \
             grep -v 'models\.py' | \
             grep -v '__pycache__'; then
            echo "‚ùå Real email addresses found in code"
            echo "Use example.com/test.local or hashed user IDs instead"
            exit 1
          fi
          echo "‚úÖ No real email addresses found"
          
          # IP address pattern (allow localhost/private ranges in tests)
          echo "Checking for IP addresses..."
          if grep -rE '\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b' tests/ apps/ deltacrown/ 2>/dev/null | \
             grep -v '127\.0\.0\.1' | \
             grep -v '0\.0\.0\.0' | \
             grep -v '192\.168\.' | \
             grep -v '10\.' | \
             grep -v 'tests/fixtures/' | \
             grep -v '__pycache__' | \
             grep -v '# IP: safe'; then
            echo "‚ö†Ô∏è  IP addresses found (review if these are test IPs)"
            echo "This is a warning only, not failing the workflow"
          else
            echo "‚úÖ No suspicious IP addresses found"
          fi
          
          # Username patterns (reject user_* patterns, allow in fixtures)
          echo "Checking for username patterns..."
          if grep -rE '\buser_[a-zA-Z0-9_]{5,}\b' tests/ apps/ 2>/dev/null | \
             grep -v 'tests/fixtures/' | \
             grep -v '__pycache__' | \
             grep -v '# Username: safe' | \
             grep -v 'smoketest_user' | \
             grep -v 'test_user'; then
            echo "‚ö†Ô∏è  Suspicious username patterns found (review if these are test users)"
            echo "This is a warning only, not failing the workflow"
          else
            echo "‚úÖ No suspicious username patterns found"
          fi
          
          echo ""
          echo "‚úÖ PII scan complete - no violations found"
      
      - name: Check observability code for PII
        run: |
          echo "üîç Checking observability/metrics code for PII..."
          
          # Check if observability/moderation directories exist
          DIRS_TO_CHECK=""
          [ -d "apps/observability" ] && DIRS_TO_CHECK="$DIRS_TO_CHECK apps/observability/"
          [ -d "apps/moderation" ] && DIRS_TO_CHECK="$DIRS_TO_CHECK apps/moderation/"
          
          if [ -z "$DIRS_TO_CHECK" ]; then
            echo "‚ÑπÔ∏è  No observability/moderation directories found (OK - may not be implemented yet)"
          else
            # Observability modules should never log/emit PII
            if grep -rE 'user\.email|user\.username|request\.META\["REMOTE_ADDR"\]' \
               $DIRS_TO_CHECK 2>/dev/null | \
               grep -v '# PII: hashed' | \
               grep -v '__pycache__' | \
               grep -v '# PII: safe'; then
              echo "‚ùå PII found in observability code"
              echo "Use hashed user IDs or anonymized data instead"
              exit 1
            fi
            echo "‚úÖ Observability code is PII-safe"
          fi
