# Workflow Security Guard
#
# Purpose: Scans workflow files for hardcoded secrets/credentials
# Runs: Only when workflow files (.github/workflows/**) are modified
# Note: If no workflow files are changed, GitHub shows "No jobs were run" (expected)
name: Guard Workflow Secrets

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches: [ master, main ]
    paths:
      - '.github/workflows/**'

jobs:
  lint-workflows:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for hardcoded passwords
        run: |
          echo "üîç Scanning workflows for hardcoded secrets..."
          
          # Patterns to reject (case-insensitive)
          VIOLATIONS=0
          
          # Check for PASSWORD: or SECRET: without ${{ secrets.* }}
          if grep -rniE '^\s*(POSTGRES_)?PASSWORD:\s*[^$]' .github/workflows/; then
            echo "‚ùå VIOLATION: Found PASSWORD without secrets reference"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if grep -rniE '^\s*.*SECRET:\s*[^$]' .github/workflows/; then
            echo "‚ùå VIOLATION: Found SECRET without secrets reference"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check for postgres:// URLs with embedded credentials
          if grep -rniE 'postgres(ql)?://[^:]+:[^@]+@' .github/workflows/ | grep -v '\${{'; then
            echo "‚ùå VIOLATION: Found database URL with embedded credentials"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check for common password values
          if grep -rniE '(password|passwd|pwd):\s*(password|admin|root|test|dev|prod|secret|pass123)' .github/workflows/; then
            echo "‚ùå VIOLATION: Found common/weak password value"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "‚ùå FAILED: Found $VIOLATIONS secret violations in workflows"
            echo "‚ö†Ô∏è  All credentials must use GitHub Actions secrets: \${{ secrets.SECRET_NAME }}"
            exit 1
          else
            echo ""
            echo "‚úÖ PASSED: No hardcoded secrets found in workflows"
          fi
      
      - name: Check for exposed ports
        run: |
          echo "üîç Checking for unnecessary port mappings..."
          
          # Warn about port mappings in service containers (informational)
          if grep -rn 'ports:' .github/workflows/ | grep -v '# '; then
            echo "‚ö†Ô∏è  WARNING: Found port mappings in workflows"
            echo "   Consider using service hostnames instead of localhost"
            grep -rn 'ports:' .github/workflows/
          else
            echo "‚úÖ No unnecessary port mappings found"
          fi
      
      - name: Verify secret references
        run: |
          echo "üîç Verifying secret reference format..."
          
          # Extract all secret references
          SECRETS=$(grep -rhEo '\$\{\{\s*secrets\.[A-Z_]+\s*\}\}' .github/workflows/ | sort -u || true)
          
          if [ -z "$SECRETS" ]; then
            echo "‚ÑπÔ∏è  No secrets referenced (OK if workflows don't need them)"
          else
            echo "‚úÖ Found valid secret references:"
            echo "$SECRETS"
          fi
