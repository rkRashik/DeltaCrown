name: perf-baseline

on:
  schedule:
    - cron: '0 3 * * *' # nightly
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  perf-baseline:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: deltacrown_perf
          POSTGRES_USER: deltacrown
          POSTGRES_PASSWORD: ${{ secrets.PERF_DB_PASSWORD }}   # <-- moved to secrets
        # No ports mapping needed inside Actions; use service hostname "postgres"
        options: >-
          --health-cmd "pg_isready -U deltacrown -d deltacrown_perf"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    env:
      PERF_DATABASE_URL: postgresql://deltacrown:${{ secrets.PERF_DB_PASSWORD }}@postgres:5432/deltacrown_perf
      PERF_REDIS_URL: redis://redis:6379/0
      # keep baseline uploads behind secrets; safe defaults below
      PERF_BASELINE_S3_BUCKET: ${{ secrets.PERF_BASELINE_S3_BUCKET }}
      PERF_BASELINE_S3_PREFIX: nightly
      PERF_BASELINE_SLACK_WEBHOOK: ${{ secrets.PERF_SLACK_WEBHOOK }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psycopg2-binary

      - name: Wait for services healthy
        run: |
          for i in {1..30}; do
            pg_isready -h postgres -U deltacrown -d deltacrown_perf && break
            sleep 2
          done

      - name: Run perf harness (baseline mode)
        run: |
          python tests/perf/perf_harness.py --samples 150 --json artifacts/performance/baseline.json

      - name: Upload baseline artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-baseline
          path: artifacts/performance/baseline.json
          retention-days: 90

      - name: OPTIONAL - upload to S3
        if: ${{ github.event_name == 'schedule' && secrets.PERF_BASELINE_S3_BUCKET != '' }}
        run: |
          pip install awscli
          aws s3 cp artifacts/performance/baseline.json s3://$PERF_BASELINE_S3_BUCKET/$PERF_BASELINE_S3_PREFIX/${{ github.run_id }}_baseline.json

      - name: OPTIONAL - Slack notify
        if: ${{ github.event_name == 'schedule' && secrets.PERF_BASELINE_SLACK_WEBHOOK != '' }}
        run: |
          pip install curlify
          python - << 'PY'
          import json, os, urllib.request
          with open('artifacts/performance/baseline.json') as f:
              data = json.load(f)
          msg = {'text': f"Perf baseline complete: p95s={data.get('p95_summary',{})}"}
          req = urllib.request.Request(os.environ['PERF_BASELINE_SLACK_WEBHOOK'], method='POST')
          req.add_header('Content-Type','application/json')
          urllib.request.urlopen(req, json.dumps(msg).encode('utf-8'))
          PY
