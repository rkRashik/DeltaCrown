BEGIN;
--
-- Create model Organization
--
CREATE TABLE "organizations_organization" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "name" varchar(100) NOT NULL UNIQUE, "slug" varchar(100) NOT NULL UNIQUE, "is_verified" boolean NOT NULL, "verification_date" timestamp with time zone NULL, "logo" varchar(100) NULL, "badge" varchar(100) NULL, "banner" varchar(100) NULL, "description" text NOT NULL, "website" varchar(200) NOT NULL, "twitter" varchar(50) NOT NULL, "master_wallet_id" integer NULL, "revenue_split_config" jsonb NOT NULL, "enforce_brand" boolean NOT NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, "ceo_id" bigint NOT NULL);
--
-- Create model Team
--
CREATE TABLE "organizations_team" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "name" varchar(100) NOT NULL, "slug" varchar(100) NOT NULL UNIQUE, "game_id" integer NOT NULL, "region" varchar(50) NOT NULL, "status" varchar(20) NOT NULL, "logo" varchar(100) NULL, "banner" varchar(100) NULL, "description" text NOT NULL, "preferred_server" varchar(50) NOT NULL, "emergency_contact_discord" varchar(50) NOT NULL, "emergency_contact_phone" varchar(20) NOT NULL, "is_temporary" boolean NOT NULL, "created_at" timestamp with time zone NOT NULL, "updated_at" timestamp with time zone NOT NULL, "organization_id" bigint NULL, "owner_id" bigint NULL);
--
-- Create model OrganizationMembership
--
CREATE TABLE "organizations_org_membership" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "role" varchar(20) NOT NULL, "permissions" jsonb NOT NULL, "joined_at" timestamp with time zone NOT NULL, "organization_id" bigint NOT NULL, "user_id" bigint NOT NULL);
--
-- Create model TeamRanking
--
CREATE TABLE "organizations_ranking" ("team_id" bigint NOT NULL PRIMARY KEY, "current_cp" integer NOT NULL, "season_cp" integer NOT NULL, "all_time_cp" integer NOT NULL, "tier" varchar(20) NOT NULL, "global_rank" integer NULL, "regional_rank" integer NULL, "rank_change_24h" integer NOT NULL, "rank_change_7d" integer NOT NULL, "is_hot_streak" boolean NOT NULL, "streak_count" integer NOT NULL, "last_activity_date" timestamp with time zone NOT NULL, "last_decay_applied" timestamp with time zone NULL);
--
-- Create model TeamActivityLog
--
CREATE TABLE "organizations_activity_log" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "action_type" varchar(50) NOT NULL, "actor_id" integer NOT NULL, "actor_username" varchar(150) NOT NULL, "description" text NOT NULL, "metadata" jsonb NOT NULL, "timestamp" timestamp with time zone NOT NULL, "team_id" bigint NOT NULL);
--
-- Create model TeamMembership
--
CREATE TABLE "organizations_membership" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "status" varchar(20) NOT NULL, "role" varchar(20) NOT NULL, "roster_slot" varchar(20) NULL, "player_role" varchar(50) NOT NULL, "is_tournament_captain" boolean NOT NULL, "joined_at" timestamp with time zone NOT NULL, "left_at" timestamp with time zone NULL, "left_reason" varchar(100) NOT NULL, "team_id" bigint NOT NULL, "user_id" bigint NOT NULL);
--
-- Create model TeamMigrationMap
--
CREATE TABLE "organizations_migration_map" ("id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY, "legacy_team_id" integer NOT NULL UNIQUE, "vnext_team_id" integer NOT NULL UNIQUE, "legacy_slug" varchar(100) NOT NULL, "migration_date" timestamp with time zone NOT NULL, "verified" boolean NOT NULL, "verification_notes" text NOT NULL, "migrated_by_id" bigint NULL);
--
-- Create model OrganizationRanking
--
CREATE TABLE "organizations_org_ranking" ("organization_id" bigint NOT NULL PRIMARY KEY, "empire_score" integer NOT NULL, "global_rank" integer NULL, "regional_rank" integer NULL, "total_trophies" integer NOT NULL, "last_calculated" timestamp with time zone NOT NULL);
--
-- Create index org_slug_idx on field(s) slug of model organization
--
CREATE INDEX "org_slug_idx" ON "organizations_organization" ("slug");
--
-- Create index org_ceo_idx on field(s) ceo of model organization
--
CREATE INDEX "org_ceo_idx" ON "organizations_organization" ("ceo_id");
--
-- Create index org_verified_idx on field(s) is_verified of model organization
--
CREATE INDEX "org_verified_idx" ON "organizations_organization" ("is_verified");
--
-- Create index orgmem_org_role_idx on field(s) organization, role of model organizationmembership
--
CREATE INDEX "orgmem_org_role_idx" ON "organizations_org_membership" ("organization_id", "role");
--
-- Create index orgmem_user_idx on field(s) user of model organizationmembership
--
CREATE INDEX "orgmem_user_idx" ON "organizations_org_membership" ("user_id");
--
-- Alter unique_together for organizationmembership (1 constraint(s))
--
ALTER TABLE "organizations_org_membership" ADD CONSTRAINT "organizations_org_member_organization_id_user_id_f9bd90e6_uniq" UNIQUE ("organization_id", "user_id");
--
-- Create index ranking_cp_desc_idx on field(s) -current_cp of model teamranking
--
CREATE INDEX "ranking_cp_desc_idx" ON "organizations_ranking" ("current_cp" DESC);
--
-- Create index ranking_tier_idx on field(s) tier of model teamranking
--
CREATE INDEX "ranking_tier_idx" ON "organizations_ranking" ("tier");
--
-- Create index ranking_streak_idx on field(s) is_hot_streak of model teamranking
--
CREATE INDEX "ranking_streak_idx" ON "organizations_ranking" ("is_hot_streak");
--
-- Create index ranking_cp_tier_idx on field(s) -current_cp, tier of model teamranking
--
CREATE INDEX "ranking_cp_tier_idx" ON "organizations_ranking" ("current_cp" DESC, "tier");
--
-- Create index team_slug_idx on field(s) slug of model team
--
CREATE INDEX "team_slug_idx" ON "organizations_team" ("slug");
--
-- Create index team_game_region_idx on field(s) game_id, region of model team
--
CREATE INDEX "team_game_region_idx" ON "organizations_team" ("game_id", "region");
--
-- Create index team_org_idx on field(s) organization of model team
--
CREATE INDEX "team_org_idx" ON "organizations_team" ("organization_id");
--
-- Create index team_status_idx on field(s) status of model team
--
CREATE INDEX "team_status_idx" ON "organizations_team" ("status");
--
-- Create index team_owner_game_idx on field(s) owner, game_id of model team
--
CREATE INDEX "team_owner_game_idx" ON "organizations_team" ("owner_id", "game_id");
--
-- Create constraint one_independent_team_per_game on model team
--
CREATE UNIQUE INDEX "one_independent_team_per_game" ON "organizations_team" ("owner_id", "game_id") WHERE ("owner_id" IS NOT NULL AND "status" = 'ACTIVE');
--
-- Create constraint team_has_organization_xor_owner on model team
--
ALTER TABLE "organizations_team" ADD CONSTRAINT "team_has_organization_xor_owner" CHECK ((("organization_id" IS NOT NULL AND "owner_id" IS NULL) OR ("organization_id" IS NULL AND "owner_id" IS NOT NULL)));
--
-- Create index activity_team_time_idx on field(s) team, -timestamp of model teamactivitylog
--
CREATE INDEX "activity_team_time_idx" ON "organizations_activity_log" ("team_id", "timestamp" DESC);
--
-- Create index activity_type_idx on field(s) action_type of model teamactivitylog
--
CREATE INDEX "activity_type_idx" ON "organizations_activity_log" ("action_type");
--
-- Create index activity_time_idx on field(s) -timestamp of model teamactivitylog
--
CREATE INDEX "activity_time_idx" ON "organizations_activity_log" ("timestamp" DESC);
--
-- Create index activity_actor_time_idx on field(s) actor_id, -timestamp of model teamactivitylog
--
CREATE INDEX "activity_actor_time_idx" ON "organizations_activity_log" ("actor_id", "timestamp" DESC);
--
-- Create index membership_team_status_idx on field(s) team, status of model teammembership
--
CREATE INDEX "membership_team_status_idx" ON "organizations_membership" ("team_id", "status");
--
-- Create index membership_user_status_idx on field(s) user, status of model teammembership
--
CREATE INDEX "membership_user_status_idx" ON "organizations_membership" ("user_id", "status");
--
-- Create index membership_role_idx on field(s) role of model teammembership
--
CREATE INDEX "membership_role_idx" ON "organizations_membership" ("role");
--
-- Create index membership_captain_idx on field(s) is_tournament_captain of model teammembership
--
CREATE INDEX "membership_captain_idx" ON "organizations_membership" ("is_tournament_captain");
--
-- Create constraint one_active_membership_per_user_team on model teammembership
--
CREATE UNIQUE INDEX "one_active_membership_per_user_team" ON "organizations_membership" ("team_id", "user_id") WHERE "status" = 'ACTIVE';
--
-- Create constraint one_tournament_captain_per_team on model teammembership
--
CREATE UNIQUE INDEX "one_tournament_captain_per_team" ON "organizations_membership" ("team_id") WHERE ("is_tournament_captain" AND "status" = 'ACTIVE');
--
-- Create index migration_legacy_idx on field(s) legacy_team_id of model teammigrationmap
--
CREATE INDEX "migration_legacy_idx" ON "organizations_migration_map" ("legacy_team_id");
--
-- Create index migration_vnext_idx on field(s) vnext_team_id of model teammigrationmap
--
CREATE INDEX "migration_vnext_idx" ON "organizations_migration_map" ("vnext_team_id");
--
-- Create index migration_slug_idx on field(s) legacy_slug of model teammigrationmap
--
CREATE INDEX "migration_slug_idx" ON "organizations_migration_map" ("legacy_slug");
ALTER TABLE "organizations_organization" ADD CONSTRAINT "organizations_organization_ceo_id_0e19ee00_fk_accounts_user_id" FOREIGN KEY ("ceo_id") REFERENCES "accounts_user" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_organization_name_71edc74b_like" ON "organizations_organization" ("name" varchar_pattern_ops);
CREATE INDEX "organizations_organization_slug_e36fd8f9_like" ON "organizations_organization" ("slug" varchar_pattern_ops);
CREATE INDEX "organizations_organization_is_verified_630f2f42" ON "organizations_organization" ("is_verified");
CREATE INDEX "organizations_organization_ceo_id_0e19ee00" ON "organizations_organization" ("ceo_id");
ALTER TABLE "organizations_team" ADD CONSTRAINT "organizations_team_organization_id_beeec88b_fk_organizat" FOREIGN KEY ("organization_id") REFERENCES "organizations_organization" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "organizations_team" ADD CONSTRAINT "organizations_team_owner_id_4c72e7c9_fk_accounts_user_id" FOREIGN KEY ("owner_id") REFERENCES "accounts_user" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_team_slug_d27e8ddf_like" ON "organizations_team" ("slug" varchar_pattern_ops);
CREATE INDEX "organizations_team_game_id_ab5f5d02" ON "organizations_team" ("game_id");
CREATE INDEX "organizations_team_status_1bed3788" ON "organizations_team" ("status");
CREATE INDEX "organizations_team_status_1bed3788_like" ON "organizations_team" ("status" varchar_pattern_ops);
CREATE INDEX "organizations_team_organization_id_beeec88b" ON "organizations_team" ("organization_id");
CREATE INDEX "organizations_team_owner_id_4c72e7c9" ON "organizations_team" ("owner_id");
ALTER TABLE "organizations_org_membership" ADD CONSTRAINT "organizations_org_me_organization_id_0f9d7fb2_fk_organizat" FOREIGN KEY ("organization_id") REFERENCES "organizations_organization" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "organizations_org_membership" ADD CONSTRAINT "organizations_org_me_user_id_8aa73985_fk_accounts_" FOREIGN KEY ("user_id") REFERENCES "accounts_user" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_org_membership_organization_id_0f9d7fb2" ON "organizations_org_membership" ("organization_id");
CREATE INDEX "organizations_org_membership_user_id_8aa73985" ON "organizations_org_membership" ("user_id");
ALTER TABLE "organizations_ranking" ADD CONSTRAINT "organizations_ranking_team_id_c5c6886e_fk_organizations_team_id" FOREIGN KEY ("team_id") REFERENCES "organizations_team" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_ranking_current_cp_2e21ccd6" ON "organizations_ranking" ("current_cp");
CREATE INDEX "organizations_ranking_tier_2aefaad7" ON "organizations_ranking" ("tier");
CREATE INDEX "organizations_ranking_tier_2aefaad7_like" ON "organizations_ranking" ("tier" varchar_pattern_ops);
CREATE INDEX "organizations_ranking_is_hot_streak_99ad8a0d" ON "organizations_ranking" ("is_hot_streak");
ALTER TABLE "organizations_activity_log" ADD CONSTRAINT "organizations_activi_team_id_ed088f7d_fk_organizat" FOREIGN KEY ("team_id") REFERENCES "organizations_team" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_activity_log_action_type_c38f66d6" ON "organizations_activity_log" ("action_type");
CREATE INDEX "organizations_activity_log_action_type_c38f66d6_like" ON "organizations_activity_log" ("action_type" varchar_pattern_ops);
CREATE INDEX "organizations_activity_log_timestamp_5e24221a" ON "organizations_activity_log" ("timestamp");
CREATE INDEX "organizations_activity_log_team_id_ed088f7d" ON "organizations_activity_log" ("team_id");
ALTER TABLE "organizations_membership" ADD CONSTRAINT "organizations_member_team_id_8edecac8_fk_organizat" FOREIGN KEY ("team_id") REFERENCES "organizations_team" ("id") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "organizations_membership" ADD CONSTRAINT "organizations_membership_user_id_a8e72055_fk_accounts_user_id" FOREIGN KEY ("user_id") REFERENCES "accounts_user" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_membership_status_c1269b0e" ON "organizations_membership" ("status");
CREATE INDEX "organizations_membership_status_c1269b0e_like" ON "organizations_membership" ("status" varchar_pattern_ops);
CREATE INDEX "organizations_membership_team_id_8edecac8" ON "organizations_membership" ("team_id");
CREATE INDEX "organizations_membership_user_id_a8e72055" ON "organizations_membership" ("user_id");
ALTER TABLE "organizations_migration_map" ADD CONSTRAINT "organizations_migrat_migrated_by_id_a74491db_fk_accounts_" FOREIGN KEY ("migrated_by_id") REFERENCES "accounts_user" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_migration_map_legacy_slug_3cdd4b13" ON "organizations_migration_map" ("legacy_slug");
CREATE INDEX "organizations_migration_map_legacy_slug_3cdd4b13_like" ON "organizations_migration_map" ("legacy_slug" varchar_pattern_ops);
CREATE INDEX "organizations_migration_map_migrated_by_id_a74491db" ON "organizations_migration_map" ("migrated_by_id");
ALTER TABLE "organizations_org_ranking" ADD CONSTRAINT "organizations_org_ra_organization_id_412ba23e_fk_organizat" FOREIGN KEY ("organization_id") REFERENCES "organizations_organization" ("id") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "organizations_org_ranking_empire_score_541664a3" ON "organizations_org_ranking" ("empire_score");
CREATE INDEX "org_ranking_score_desc_idx" ON "organizations_org_ranking" ("empire_score" DESC);
CREATE INDEX "org_ranking_rank_idx" ON "organizations_org_ranking" ("global_rank");
COMMIT;
