{% extends "base.html" %}
{% load static %}

{% block title %}Transaction History — DeltaCrown{% endblock %}

{% block content %}
<main class="container mx-auto px-4 max-w-7xl py-6 md:py-8">
    <!-- Breadcrumb Navigation -->
    <nav aria-label="Breadcrumb" class="text-xs md:text-sm text-gray-500 mb-6">
        <div class="flex items-center flex-wrap gap-2">
            <a href="/" class="hover:text-z-cyan transition-colors duration-200">Home</a>
            <i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
            <a href="/@{{ request.user.username }}/" class="hover:text-z-cyan transition-colors duration-200">Profile</a>
            <i class="fa-solid fa-chevron-right text-xs opacity-50"></i>
            <span class="text-white font-medium">Transactions</span>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="glass-panel p-5 md:p-6 rounded-xl border border-white/10 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <!-- Title Section -->
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-lg bg-gradient-to-br from-z-cyan/10 to-z-cyan/5 border border-z-cyan/20 flex items-center justify-center flex-shrink-0">
                    <i class="fa-solid fa-receipt text-z-cyan text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-white tracking-tight">Transaction History</h1>
                    <p class="text-gray-400 text-xs md:text-sm mt-0.5">View and track all wallet activity</p>
                </div>
            </div>
            
            <!-- Balance Card -->
            {% if wallet %}
            <div class="glass-panel px-4 py-3 rounded-lg border border-z-gold/20 bg-gradient-to-br from-z-gold/5 to-transparent backdrop-blur-sm lg:min-w-[200px]">
                <div class="text-[10px] text-gray-500 uppercase tracking-widest mb-1 font-bold">Current Balance</div>
                <div class="text-2xl md:text-3xl font-bold text-white flex items-baseline gap-2">
                    <span>{{ wallet.cached_balance|default:0 }}</span>
                    <span class="text-sm text-z-gold font-semibold">DCC</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="glass-panel p-4 md:p-5 rounded-xl border border-white/10 mb-6">
        <form method="get" class="space-y-4">
            <!-- Transaction Type Filter Chips -->
            <div>
                <label class="text-gray-400 text-[11px] font-bold uppercase tracking-wider mb-2.5 block">Transaction Type</label>
                <div class="overflow-x-auto -mx-1 px-1 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
                    <div class="flex gap-2 pb-2 min-w-max md:flex-wrap md:min-w-0">
                        <button type="submit" name="reason" value="" 
                                class="filter-chip {% if not reason %}active{% endif %}">
                            <i class="fa-solid fa-layer-group"></i>
                            <span>All Transactions</span>
                        </button>
                        {% for k, label in reason_choices %}
                            {% if k %}
                            <button type="submit" name="reason" value="{{ k }}" 
                                    class="filter-chip {% if reason == k %}active{% endif %}">
                                {% if 'reward' in label|lower or 'win' in label|lower or 'kill' in label|lower or 'assist' in label|lower %}
                                    <i class="fa-solid fa-trophy"></i>
                                {% elif 'top' in label|lower or 'deposit' in label|lower or 'credit' in label|lower %}
                                    <i class="fa-solid fa-arrow-down"></i>
                                {% elif 'with' in label|lower or 'debit' in label|lower %}
                                    <i class="fa-solid fa-arrow-up"></i>
                                {% elif 'purchase' in label|lower or 'shop' in label|lower %}
                                    <i class="fa-solid fa-cart-shopping"></i>
                                {% elif 'entry' in label|lower or 'registration' in label|lower or 'tournament' in label|lower %}
                                    <i class="fa-solid fa-ticket"></i>
                                {% elif 'admin' in label|lower %}
                                    <i class="fa-solid fa-user-shield"></i>
                                {% elif 'transfer' in label|lower %}
                                    <i class="fa-solid fa-exchange-alt"></i>
                                {% else %}
                                    <i class="fa-solid fa-circle"></i>
                                {% endif %}
                                <span>{{ label }}</span>
                            </button>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Date Range & Actions -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3">
                <div class="lg:col-span-3">
                    <label class="text-gray-400 text-[11px] font-bold uppercase tracking-wider mb-2 block">From Date</label>
                    <input type="date" name="start" value="{{ start }}" 
                           class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-z-cyan/50 focus:ring-1 focus:ring-z-cyan/30 transition-all">
                </div>
                <div class="lg:col-span-3">
                    <label class="text-gray-400 text-[11px] font-bold uppercase tracking-wider mb-2 block">To Date</label>
                    <input type="date" name="end" value="{{ end }}" 
                           class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2.5 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-z-cyan/50 focus:ring-1 focus:ring-z-cyan/30 transition-all">
                </div>
                <div class="sm:col-span-2 lg:col-span-6 flex items-end gap-2">
                    <button type="submit" 
                            class="flex-1 bg-z-cyan/10 hover:bg-z-cyan/15 text-z-cyan border border-z-cyan/30 font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 text-sm flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-z-cyan/40">
                        <i class="fa-solid fa-filter text-xs"></i>
                        <span>Apply</span>
                    </button>
                    {% if reason or start or end %}
                    <a href="{% url 'economy:transaction_history' %}" 
                       class="bg-white/5 hover:bg-white/8 text-gray-400 hover:text-white border border-white/10 hover:border-white/20 font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-rotate-left text-xs"></i>
                        <span class="hidden sm:inline">Clear</span>
                    </a>
                    {% endif %}
                    <a href="?{% if reason %}reason={{ reason }}&{% endif %}{% if start %}start={{ start }}&{% endif %}{% if end %}end={{ end }}&{% endif %}format=csv" 
                       class="bg-white/5 hover:bg-white/8 text-gray-400 hover:text-white border border-white/10 hover:border-white/20 font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download text-xs"></i>
                        <span class="hidden sm:inline">CSV</span>
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Transactions List -->
    {% if page_obj and page_obj.object_list %}
    <div class="glass-panel rounded-xl border border-white/10 overflow-hidden">
        <!-- Desktop Table View -->
        <div class="hidden md:block overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-white/5 border-b border-white/10">
                        <th class="px-5 py-3.5 text-left text-gray-500 font-bold text-[11px] uppercase tracking-wider">Date & Time</th>
                        <th class="px-5 py-3.5 text-left text-gray-500 font-bold text-[11px] uppercase tracking-wider">Type</th>
                        <th class="px-5 py-3.5 text-left text-gray-500 font-bold text-[11px] uppercase tracking-wider">Description</th>
                        <th class="px-5 py-3.5 text-right text-gray-500 font-bold text-[11px] uppercase tracking-wider">Amount</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for tx in page_obj.object_list %}
                    <tr class="hover:bg-white/5 transition-colors group">
                        <td class="px-5 py-3.5">
                            <div class="text-white font-medium text-sm">{{ tx.created_at|date:"M d, Y" }}</div>
                            <div class="text-gray-500 text-xs mt-0.5">{{ tx.created_at|date:"g:i A" }}</div>
                        </td>
                        <td class="px-5 py-3.5">
                            <span class="tx-badge tx-{{ tx.reason }}">
                                {{ tx.get_reason_display|default:tx.reason }}
                            </span>
                        </td>
                        <td class="px-5 py-3.5">
                            <div class="text-white text-sm font-medium max-w-md">
                                {% if tx.note %}
                                    {{ tx.note|truncatewords:12 }}
                                {% elif tx.tournament %}
                                    <span class="text-purple-400">{{ tx.tournament.title }}</span>
                                {% elif tx.match %}
                                    <span class="text-blue-400">Match #{{ tx.match.id }}</span>
                                {% else %}
                                    {{ tx.get_reason_display|default:"Transaction" }}
                                {% endif %}
                            </div>
                            <div class="text-gray-600 text-xs mt-0.5 font-mono opacity-0 group-hover:opacity-100 transition-opacity">
                                Ref: {{ tx.idempotency_key|slice:":12" }}...
                            </div>
                        </td>
                        <td class="px-5 py-3.5 text-right">
                            <div class="text-base font-bold font-mono {% if tx.amount < 0 %}text-red-400{% else %}text-emerald-400{% endif %}">
                                {% if tx.amount >= 0 %}+{% endif %}{{ tx.amount }}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Mobile Card View -->
        <div class="md:hidden divide-y divide-white/5">
            {% for tx in page_obj.object_list %}
            <div class="p-4 hover:bg-white/5 transition-colors">
                <div class="flex items-start justify-between gap-3 mb-2.5">
                    <div class="flex-1 min-w-0">
                        <span class="tx-badge tx-{{ tx.reason }} text-[10px]">
                            {{ tx.get_reason_display|default:tx.reason }}
                        </span>
                        <div class="text-gray-500 text-xs mt-1.5">
                            {{ tx.created_at|date:"M d, Y" }} • {{ tx.created_at|date:"g:i A" }}
                        </div>
                    </div>
                    <div class="text-xl font-bold font-mono {% if tx.amount < 0 %}text-red-400{% else %}text-emerald-400{% endif %} flex-shrink-0">
                        {% if tx.amount >= 0 %}+{% endif %}{{ tx.amount }}
                    </div>
                </div>
                <div class="text-white text-sm leading-relaxed">
                    {% if tx.note %}
                        {{ tx.note|truncatewords:15 }}
                    {% elif tx.tournament %}
                        <span class="text-purple-400">{{ tx.tournament.title }}</span>
                    {% elif tx.match %}
                        <span class="text-blue-400">Match #{{ tx.match.id }}</span>
                    {% else %}
                        {{ tx.get_reason_display|default:"Transaction" }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="border-t border-white/10 bg-white/5 px-4 md:px-5 py-3.5">
            <div class="flex items-center justify-between">
                <div class="text-xs text-gray-500 font-medium">
                    Page <span class="text-white font-bold">{{ page_obj.number }}</span> of <span class="text-white font-bold">{{ page_obj.paginator.num_pages }}</span>
                </div>
                <div class="flex gap-2">
                    {% if page_obj.has_previous %}
                    <a href="?{% if reason %}reason={{ reason }}&{% endif %}{% if start %}start={{ start }}&{% endif %}{% if end %}end={{ end }}&{% endif %}page={{ page_obj.previous_page_number }}" 
                       class="px-3 py-2 bg-white/10 hover:bg-white/15 text-white rounded-lg transition-all text-xs font-semibold border border-white/10 hover:border-white/20 flex items-center gap-1.5">
                        <i class="fa-solid fa-chevron-left text-[10px]"></i>
                        <span class="hidden sm:inline">Prev</span>
                    </a>
                    {% endif %}
                    {% if page_obj.has_next %}
                    <a href="?{% if reason %}reason={{ reason }}&{% endif %}{% if start %}start={{ start }}&{% endif %}{% if end %}end={{ end }}&{% endif %}page={{ page_obj.next_page_number }}" 
                       class="px-3 py-2 bg-white/10 hover:bg-white/15 text-white rounded-lg transition-all text-xs font-semibold border border-white/10 hover:border-white/20 flex items-center gap-1.5">
                        <span class="hidden sm:inline">Next</span>
                        <i class="fa-solid fa-chevron-right text-[10px]"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="glass-panel p-10 md:p-16 rounded-xl border border-white/10 text-center">
        <div class="w-20 h-20 mx-auto mb-5 rounded-full bg-gradient-to-br from-white/5 to-transparent flex items-center justify-center border border-white/10">
            <i class="fa-solid fa-receipt text-gray-600 text-3xl"></i>
        </div>
        <h3 class="text-lg font-bold text-white mb-2">No Transactions Found</h3>
        <p class="text-gray-400 text-sm mb-5 max-w-md mx-auto leading-relaxed">
            {% if reason or start or end %}
                No transactions match your current filters. Try adjusting your search criteria or clearing filters to see all activity.
            {% else %}
                Your transaction history will appear here once you start earning or spending DCC.
            {% endif %}
        </p>
        {% if reason or start or end %}
        <a href="{% url 'economy:transaction_history' %}" 
           class="inline-flex items-center gap-2 px-5 py-2.5 bg-z-cyan/10 hover:bg-z-cyan/15 text-z-cyan border border-z-cyan/30 hover:border-z-cyan/40 rounded-lg transition-all font-semibold text-sm">
            <i class="fa-solid fa-rotate-left"></i>
            Clear All Filters
        </a>
        {% endif %}
    </div>
    {% endif %}
</main>

<style>
/* Transaction Type Badges */
.tx-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    white-space: nowrap;
}

/* Color Coding for Transaction Types */
.tx-REWARD_WIN,
.tx-REWARD_KILL,
.tx-REWARD_ASSIST {
    background-color: rgba(16, 185, 129, 0.15);
    color: rgb(52, 211, 153);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.tx-TOPUP_APPROVED,
.tx-DEPOSIT {
    background-color: rgba(59, 130, 246, 0.15);
    color: rgb(96, 165, 250);
    border: 1px solid rgba(59, 130, 246, 0.25);
}

.tx-WITHDRAW_APPROVED,
.tx-WITHDRAWAL {
    background-color: rgba(239, 68, 68, 0.15);
    color: rgb(248, 113, 113);
    border: 1px solid rgba(239, 68, 68, 0.25);
}

.tx-TOURNAMENT_ENTRY,
.tx-REGISTRATION_FEE {
    background-color: rgba(168, 85, 247, 0.15);
    color: rgb(192, 132, 252);
    border: 1px solid rgba(168, 85, 247, 0.25);
}

.tx-PURCHASE,
.tx-SHOP_PURCHASE {
    background-color: rgba(234, 179, 8, 0.15);
    color: rgb(250, 204, 21);
    border: 1px solid rgba(234, 179, 8, 0.25);
}

.tx-ADMIN_CREDIT,
.tx-ADMIN_DEBIT {
    background-color: rgba(0, 255, 255, 0.15);
    color: rgb(34, 211, 238);
    border: 1px solid rgba(0, 255, 255, 0.25);
}

.tx-TRANSFER_IN,
.tx-TRANSFER_OUT {
    background-color: rgba(249, 115, 22, 0.15);
    color: rgb(251, 146, 60);
    border: 1px solid rgba(249, 115, 22, 0.25);
}

/* Filter Chips */
.filter-chip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.875rem;
    border-radius: 0.5rem;
    background-color: rgba(255, 255, 255, 0.05);
    color: rgb(156, 163, 175);
    font-size: 0.8125rem;
    font-weight: 600;
    border: 1px solid rgba(255, 255, 255, 0.1);
    white-space: nowrap;
    transition: all 0.2s ease;
    cursor: pointer;
}

.filter-chip:hover {
    background-color: rgba(255, 255, 255, 0.08);
    color: rgb(255, 255, 255);
    border-color: rgba(255, 255, 255, 0.15);
}

.filter-chip.active {
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.12), rgba(0, 255, 170, 0.12));
    color: rgb(34, 211, 238);
    border-color: rgba(0, 255, 255, 0.3);
    box-shadow: 0 0 0 1px rgba(0, 255, 255, 0.1);
}

.filter-chip.active i {
    color: rgb(0, 255, 255);
}

/* Custom Scrollbar for Chip Container */
.scrollbar-thin::-webkit-scrollbar {
    height: 6px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.15);
}
</style>
{% endblock %}
