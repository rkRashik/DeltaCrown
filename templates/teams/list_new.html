{% extends "base.html" %}
{% load static %}
{% load game_assets %}

{% block title %}Elite Esports Teams — DeltaCrown{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'teams/css/team-list-modern.css' %}">
{% endblock %}

{% block content %}
<div class="teams-hub-wrapper">
    <!-- Animated Background -->
    <div class="hub-background">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="gradient-orb orb-3"></div>
        <div class="grid-overlay"></div>
    </div>

    <!-- Hero Section -->
    <section class="teams-hero">
        <div class="hero-content">
            <div class="hero-badge">
                <i class="fas fa-trophy"></i>
                <span>Competitive Hub</span>
            </div>
            <h1 class="hero-title">
                <span class="gradient-text">Elite Esports Teams</span>
            </h1>
            <p class="hero-subtitle">
                Join <span class="highlight">{{ total_teams|default:"0" }}</span> competitive teams across <span class="highlight">{{ games_list|length }}</span> games
            </p>
            
            <!-- Hero Stats -->
            <div class="hero-stats">
                <div class="hero-stat">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-info">
                        <span class="stat-value">{{ total_teams|default:"0" }}</span>
                        <span class="stat-label">Teams</span>
                    </div>
                </div>
                <div class="hero-stat">
                    <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
                    <div class="stat-info">
                        <span class="stat-value">{{ recruiting_teams|default:"0" }}</span>
                        <span class="stat-label">Recruiting</span>
                    </div>
                </div>
                <div class="hero-stat">
                    <div class="stat-icon"><i class="fas fa-gamepad"></i></div>
                    <div class="stat-info">
                        <span class="stat-value">{{ games_list|length|default:"0" }}</span>
                        <span class="stat-label">Games</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="hero-actions">
                <a href="{% url 'teams:create' %}" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    <span>Create Team</span>
                </a>
                {% if user.is_authenticated %}
                <a href="{% url 'teams:my_invites' %}" class="btn btn-secondary">
                    <i class="fas fa-envelope"></i>
                    <span>My Invitations</span>
                </a>
                {% else %}
                <a href="/admin/login/" class="btn btn-secondary">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Login</span>
                </a>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <div class="teams-container">
        <!-- Game Filter Bar -->
        <section class="game-filter-section">
            <div class="filter-header">
                <h2><i class="fas fa-gamepad"></i> Filter by Game</h2>
            </div>
            <div class="game-filters-scroll">
                <a href="?{% if query %}q={{ query }}&{% endif %}{% if sort %}sort={{ sort }}{% endif %}" 
                   class="game-filter-chip {% if not active_game %}active{% endif %}">
                    <div class="game-chip-icon all-games">
                        <i class="fas fa-globe"></i>
                    </div>
                    <span class="game-chip-name">All Games</span>
                    <span class="game-chip-count">{{ total_teams|default:"0" }}</span>
                </a>
                
                {% for game_info in games_list %}
                <a href="?game={{ game_info.code }}{% if query %}&q={{ query }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" 
                   class="game-filter-chip {% if active_game == game_info.code %}active{% endif %}">
                    <div class="game-chip-icon">
                        {% with game_code=game_info.code|upper %}
                        <img src="{% game_logo game_code %}" alt="{{ game_info.name }}">
                        {% endwith %}
                    </div>
                    <span class="game-chip-name">{{ game_info.name }}</span>
                    <span class="game-chip-count">{{ game_info.team_count|default:"0" }}</span>
                </a>
                {% endfor %}
            </div>
        </section>

        <!-- Search & Sort Bar -->
        <section class="control-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="search" 
                       placeholder="Search teams..." 
                       value="{{ query }}"
                       id="team-search"
                       autocomplete="off">
                <button type="button" class="clear-search" id="search-clear" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="sort-box">
                <i class="fas fa-sort"></i>
                <select id="sort-select" class="sort-select">
                    <option value="rank_high" {% if sort == "rank_high" %}selected{% endif %}>Rank: High → Low</option>
                    <option value="rank_low" {% if sort == "rank_low" %}selected{% endif %}>Rank: Low → High</option>
                    <option value="points_high" {% if sort == "points_high" %}selected{% endif %}>Points: High → Low</option>
                    <option value="members_high" {% if sort == "members_high" %}selected{% endif %}>Members: Most</option>
                    <option value="name_az" {% if sort == "name_az" %}selected{% endif %}>Name: A → Z</option>
                    <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest First</option>
                </select>
            </div>
        </section>

        <!-- Team Grid -->
        <section class="teams-grid" id="teams-grid">
            {% if object_list %}
                {% for team in object_list %}
                <article class="team-card {% if forloop.counter <= 3 %}top-rank{% endif %}" 
                         data-team-id="{{ team.id }}"
                         onclick="window.location.href='{{ team.get_absolute_url }}';">
                    
                    <!-- Rank Badge -->
                    <div class="rank-badge {% if team.rank_position <= 3 %}podium{% endif %}">
                        {% if team.rank_position <= 3 %}
                            <i class="fas fa-trophy"></i>
                        {% endif %}
                        #{{ team.rank_position|default:forloop.counter }}
                    </div>

                    <!-- Team Banner -->
                    <div class="team-banner">
                        {% if team.banner_image %}
                            <img src="{{ team.banner_image.url }}" alt="{{ team.name }} banner">
                        {% else %}
                            <div class="banner-placeholder"></div>
                        {% endif %}
                        <div class="banner-overlay"></div>
                    </div>

                    <!-- Team Logo -->
                    <div class="team-logo-wrapper">
                        {% if team.logo %}
                            <img src="{{ team.logo.url }}" alt="{{ team.name }} logo" class="team-logo">
                        {% else %}
                            <div class="team-logo-placeholder">
                                {{ team.name|first|upper }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Team Info -->
                    <div class="team-info">
                        <h3 class="team-name">
                            {{ team.name }}
                            {% if team.is_verified %}
                                <i class="fas fa-check-circle verified-badge" title="Verified"></i>
                            {% endif %}
                        </h3>
                        {% if team.tag %}
                            <span class="team-tag">[{{ team.tag }}]</span>
                        {% endif %}
                        
                        {% if team.tagline %}
                            <p class="team-tagline">{{ team.tagline|truncatechars:50 }}</p>
                        {% endif %}

                        <!-- Game Badge -->
                        {% if team.game %}
                        <div class="game-badge">
                            {% with game_code=team.game|upper %}
                                <img src="{% game_logo game_code %}" alt="{{ team.game|title }}">
                                <span>{{ team.game|title }}</span>
                            {% endwith %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Team Stats -->
                    <div class="team-stats-grid">
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span class="stat-value">{{ team.memberships.count|default:0 }}</span>
                            <span class="stat-label">Members</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-bolt"></i>
                            <span class="stat-value">{{ team.total_points|default:0 }}</span>
                            <span class="stat-label">Points</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-trophy"></i>
                            <span class="stat-value">{{ team.tournament_wins|default:0 }}</span>
                            <span class="stat-label">Wins</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span class="stat-value">{{ team.region|default:"GLB"|truncatechars:4 }}</span>
                            <span class="stat-label">Region</span>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="team-actions" onclick="event.stopPropagation();">
                        <a href="{{ team.get_absolute_url }}" class="btn-action primary">
                            <i class="fas fa-eye"></i>
                            <span>View Team</span>
                        </a>
                        {% if team.allow_join_requests %}
                            <button class="btn-action secondary" onclick="joinTeam('{{ team.slug }}');">
                                <i class="fas fa-user-plus"></i>
                                <span>Join</span>
                            </button>
                        {% endif %}
                    </div>

                    <!-- Power Score Indicator -->
                    {% if team.power_rank %}
                    <div class="power-indicator">
                        <i class="fas fa-bolt"></i>
                        <span>{{ team.power_rank|floatformat:0 }}</span>
                    </div>
                    {% endif %}

                    <!-- Recruiting Badge -->
                    {% if team.is_recruiting %}
                    <div class="recruiting-badge">
                        <i class="fas fa-bullhorn"></i>
                        Recruiting
                    </div>
                    {% endif %}
                </article>
                {% endfor %}

                <!-- Load More -->
                {% if paginator.num_pages > 1 and page_obj.has_next %}
                <div class="load-more-wrapper">
                    <button class="btn-load-more" id="load-more-btn" data-next-page="{{ page_obj.next_page_number }}">
                        <span>Load More Teams</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                {% endif %}

            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-users-slash"></i>
                    </div>
                    <h3>No Teams Found</h3>
                    <p>
                        {% if query or active_game %}
                            No teams match your search criteria. Try adjusting your filters.
                        {% else %}
                            Be the first to create a team!
                        {% endif %}
                    </p>
                    <a href="{% url 'teams:create' %}" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        <span>Create First Team</span>
                    </a>
                </div>
            {% endif %}
        </section>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Loading teams...</p>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'teams/js/team-list-modern.js' %}"></script>
{% endblock %}
