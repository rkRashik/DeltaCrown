{% extends "base.html" %}
{% block title %}{{ team.name|default:team.tag|default:"Team" }} — DeltaCrown{% endblock %}

{% block content %}
{% meta_tags
  title=team.name|default:team.tag|default:"Team"
  description="Team roster, invites, and recent activity."
%}

<section aria-labelledby="h1" data-testid="team-detail">
  <header class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 id="h1" class="mb-1">{{ team.name|default:team.tag|default:"Team" }}</h1>
      <p class="text-muted mb-0">
        Tag: <span class="badge">{{ team.tag|default:"—" }}</span>
        {% if team.created_at %} · Created {{ team.created_at|date:"M d, Y" }}{% endif %}
      </p>
    </div>
    <div class="d-flex gap-2">
      <!-- Use literal paths with tag fallback; safe for templates even if backend differs -->
      <a class="btn btn-outline" href="/teams/{{ team.tag|urlencode }}/invite/">Invite member</a>
      <a class="btn btn-outline" href="/teams/{{ team.tag|urlencode }}/transfer/">Transfer captain</a>
      <a class="btn btn-primary" href="/teams/{{ team.tag|urlencode }}/leave/">Leave team</a>
    </div>
  </header>

  <div class="d-flex flex-wrap g-3">
    <!-- Roster -->
    <article class="card p-3" style="flex:1 1 420px;min-width:320px">
      <div class="fw-medium mb-2">Roster</div>
      <div class="table-wrap">
        <table class="table table-striped{% if team.members and team.members.count > 10 %} table-compact{% endif %}">
          <thead>
            <tr><th>Player</th><th>Role</th></tr>
          </thead>
          <tbody>
            {% if members %}
              {% for p in members %}
                <tr>
                  <td>{{ p.display_name|default:p.user.username|default:"—" }}</td>
                  <td>
                    {% if p.id == team.captain_id %}Captain{% else %}Member{% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="text-muted">No members yet</td></tr>
              {% endfor %}
            {% elif team.members %}
              {% for p in team.members.all %}
                <tr>
                  <td>{{ p.display_name|default:p.user.username|default:"—" }}</td>
                  <td>
                    {% if p.id == team.captain_id %}Captain{% else %}Member{% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="text-muted">No members yet</td></tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="2" class="text-muted">No members listed</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </article>

    <!-- Invites -->
    <article class="card p-3" style="flex:1 1 320px;min-width:320px">
      <div class="fw-medium mb-2">Invites</div>
      {% with rows=invites|default:team.invites.all %}
        {% if rows %}
          <ul class="list-unstyled mb-0">
            {% for inv in rows %}
              <li class="mb-2 d-flex align-items-center justify-content-between">
                <div>
                  <div>{{ inv.email|default:inv.to_user.username|default:"Invite" }}</div>
                  <div class="text-muted" style="font-size:.9rem">
                    {% if inv.created_at %}{{ inv.created_at|date:"M d, Y h:i A" }}{% endif %}
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <a class="btn btn-outline btn-sm" href="/teams/invites/{{ inv.id }}/accept/">Accept</a>
                  <a class="btn btn-outline btn-sm" href="/teams/invites/{{ inv.id }}/decline/">Decline</a>
                </div>
              </li>
            {% empty %}
              <li class="text-muted">No pending invites.</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">No pending invites.</p>
        {% endif %}
      {% endwith %}
    </article>
  </div>

  <!-- Share (BD-first) -->
  <div class="mt-3">
    {% include "partials/share_block_bd.html" with title=team.name|default:team.tag|default:"Team" %}
  </div>
</section>
{% endblock %}
