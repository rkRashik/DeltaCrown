{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Post - {{ team.name }}{% endblock %}

{% block extra_css %}
<style>
  body {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  }

  .edit-post-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .edit-post-card {
    background: rgba(22, 27, 34, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(48, 54, 61, 0.8);
    border-radius: 16px;
    padding: 32px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  
  .form-group {
    margin-bottom: 24px;
  }
  
  .form-label {
    display: block;
    color: #e6edf3;
    font-weight: 600;
    margin-bottom: 12px;
    font-size: 16px;
  }
  
  .form-input, .form-textarea {
    width: 100%;
    padding: 16px;
    background: rgba(33, 38, 45, 0.8);
    border: 2px solid rgba(48, 54, 61, 0.5);
    border-radius: 12px;
    color: #e6edf3;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  .form-input:focus, .form-textarea:focus {
    outline: none;
    border-color: #1f6feb;
    box-shadow: 0 0 0 4px rgba(31, 111, 235, 0.1);
    background: rgba(33, 38, 45, 0.95);
  }
  
  .form-textarea {
    min-height: 140px;
    resize: vertical;
    font-family: inherit;
    line-height: 1.5;
  }
  
  .btn {
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-right: 12px;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #1f6feb 0%, #4c8cff 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #1e5fcf 0%, #4179e6 100%);
    box-shadow: 0 6px 20px rgba(31, 111, 235, 0.4);
  }
  
  .btn-secondary {
    background: rgba(33, 38, 45, 0.8);
    color: #e6edf3;
    border: 2px solid rgba(48, 54, 61, 0.5);
  }
  
  .btn-secondary:hover {
    background: rgba(48, 54, 61, 0.8);
    border-color: rgba(125, 133, 144, 0.5);
  }
  
  .media-preview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-top: 12px;
  }
  
  .media-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .media-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
  }
  
  .delete-media-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(248, 81, 73, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="edit-post-container">
  <div class="edit-post-card">
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid rgba(48, 54, 61, 0.5);">
      <div>
        <h1 style="color: #e6edf3; margin: 0; font-size: 28px; font-weight: 700;">Edit Post</h1>
        <p style="color: #7d8590; margin: 8px 0 0 0; font-size: 16px;">Make changes to your post</p>
      </div>
      <a href="{% url 'teams:teams_social:team_social_detail' team.slug %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Team
      </a>
    </div>
    
    <!-- Current Post Preview -->
    {% if post %}
    <div style="background: rgba(16, 21, 34, 0.8); border: 1px solid rgba(48, 54, 61, 0.5); border-radius: 12px; padding: 20px; margin-bottom: 32px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        {% if post.author.avatar %}
          <img src="{{ post.author.avatar.url }}" alt="{{ post.author.user.username }}" style="width: 40px; height: 40px; border-radius: 20px; object-fit: cover;">
        {% else %}
          <div style="width: 40px; height: 40px; border-radius: 20px; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
            {{ post.author.user.username|first|upper }}
          </div>
        {% endif %}
        <div>
          <div style="color: #e6edf3; font-weight: 600;">{{ post.author.user.get_full_name|default:post.author.user.username }}</div>
          <div style="color: #7d8590; font-size: 13px;">{{ post.created_at|timesince }} ago</div>
        </div>
      </div>
      {% if post.title %}
        <h3 style="color: #e6edf3; margin-bottom: 12px; font-size: 18px;">{{ post.title }}</h3>
      {% endif %}
      <div style="color: #c9d1d9; line-height: 1.5;">{{ post.content|linebreaks|truncatewords:50 }}</div>
      {% if post.media.exists %}
        <div style="margin-top: 12px; color: #7d8590; font-size: 14px;">
          <i class="fas fa-paperclip"></i> {{ post.media.count }} media file{{ post.media.count|pluralize }}
        </div>
      {% endif %}
    </div>
    {% endif %}
    
            <form method="post" enctype="multipart/form-data" style="
            background: linear-gradient(145deg, #21262d 0%, #161b22 100%);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        ">
      {% csrf_token %}
      
      {% if form.errors %}
        <div style="background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
          <h4 style="color: #f85149; margin: 0 0 8px 0; font-size: 16px;">Please fix the following errors:</h4>
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <div style="color: #f85149; font-size: 14px; margin: 4px 0;">{{ field }}: {{ error }}</div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="form-group">
        <label class="form-label" for="{{ form.title.id_for_label }}">Title (Optional)</label>
        <input type="text" name="{{ form.title.name }}" id="{{ form.title.id_for_label }}" 
               value="{{ form.title.value|default:'' }}" class="form-input" 
               placeholder="Enter a title for your post" maxlength="200">
      </div>
      
      <div class="form-group">
        <label class="form-label" for="{{ form.content.id_for_label }}">Content *</label>
        <textarea name="{{ form.content.name }}" id="{{ form.content.id_for_label }}" 
                  class="form-textarea" placeholder="What's happening with your team?" 
                  required maxlength="5000">{{ form.content.value|default:'' }}</textarea>
        <small style="color: #7d8590; font-size: 13px; margin-top: 4px; display: block;">Maximum 5000 characters</small>
      </div>
      
      <div class="form-group">
        <label class="form-label" for="{{ form.visibility.id_for_label }}">Visibility</label>
        <select name="{{ form.visibility.name }}" id="{{ form.visibility.id_for_label }}" class="form-input">
          {% for value, label in form.visibility.field.choices %}
            <option value="{{ value }}" {% if form.visibility.value == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      {% if form.post_type %}
      <div class="form-group">
        <label class="form-label" for="{{ form.post_type.id_for_label }}">Post Type</label>
        <select name="{{ form.post_type.name }}" id="{{ form.post_type.id_for_label }}" class="form-input">
          {% for value, label in form.post_type.field.choices %}
            <option value="{{ value }}" {% if form.post_type.value == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      {% if post.media.exists %}
      <div class="form-group">
        <label class="form-label">Current Media</label>
        <div class="media-preview">
          {% for media in post.media.all %}
          <div class="media-item" id="media-{{ media.id }}">
            {% if media.media_type == 'image' %}
              <img src="{{ media.file.url }}" alt="Post media">
            {% endif %}
            <button type="button" class="delete-media-btn" onclick="deleteMedia({{ media.id }})">
              <i class="fas fa-times" style="font-size: 12px;"></i>
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      
      <div class="form-group">
        <label class="form-label" for="new-media">Add New Media</label>
        <input type="file" name="media" id="new-media" multiple accept="image/*,video/*" class="form-input">
        <small style="color: #7d8590; font-size: 12px;">You can select multiple images or videos</small>
      </div>
      
      <div style="margin-top: 24px;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Update Post
        </button>
        <a href="{% url 'teams:teams_social:team_social_detail' team.slug %}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
// Character counter for content
document.addEventListener('DOMContentLoaded', function() {
  const contentTextarea = document.getElementById('{{ form.content.id_for_label }}');
  const maxLength = 5000;
  
  if (contentTextarea) {
    // Create character counter
    const counter = document.createElement('div');
    counter.style.cssText = 'color: #7d8590; font-size: 12px; text-align: right; margin-top: 4px;';
    counter.id = 'char-counter';
    contentTextarea.parentNode.appendChild(counter);
    
    function updateCounter() {
      const remaining = maxLength - contentTextarea.value.length;
      counter.textContent = `${contentTextarea.value.length}/${maxLength} characters`;
      counter.style.color = remaining < 100 ? '#f85149' : '#7d8590';
    }
    
    updateCounter();
    contentTextarea.addEventListener('input', updateCounter);
  }
  
  // Form submission enhancement
  const form = document.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      // Debug form data
      const formData = new FormData(form);
      console.log('Form submission data:');
      for (let [key, value] of formData.entries()) {
        console.log(key, value);
      }
      
      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        submitBtn.disabled = true;
      }
    });
  }
  
  // Auto-resize textarea
  if (contentTextarea) {
    contentTextarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.max(140, this.scrollHeight) + 'px';
    });
    
    // Initial resize
    contentTextarea.style.height = Math.max(140, contentTextarea.scrollHeight) + 'px';
  }
});

function deleteMedia(mediaId) {
  if (confirm('Are you sure you want to delete this media? This action cannot be undone.')) {
    const mediaElement = document.getElementById('media-' + mediaId);
    
    // Add loading state
    mediaElement.style.opacity = '0.5';
    mediaElement.style.pointerEvents = 'none';
    
    fetch(`{% url 'teams:teams_social:delete_post_media' team.slug post.id 0 %}`.replace('0', mediaId), {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Smooth removal animation
        mediaElement.style.transition = 'all 0.3s ease';
        mediaElement.style.transform = 'scale(0.8)';
        mediaElement.style.opacity = '0';
        
        setTimeout(() => {
          mediaElement.remove();
        }, 300);
      } else {
        // Restore on error
        mediaElement.style.opacity = '1';
        mediaElement.style.pointerEvents = 'auto';
        alert('Error: ' + (data.error || 'Failed to delete media'));
      }
    })
    .catch(error => {
      // Restore on error
      mediaElement.style.opacity = '1';
      mediaElement.style.pointerEvents = 'auto';
      console.error('Error:', error);
      alert('Error deleting media. Please try again.');
    });
  }
}

// File input preview
document.getElementById('new-media').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  const preview = document.getElementById('new-media-preview') || createPreviewContainer();
  
  preview.innerHTML = '';
  
  files.forEach((file, index) => {
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const div = document.createElement('div');
        div.className = 'media-item';
        div.innerHTML = `
          <img src="${e.target.result}" alt="Preview" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
          <div style="color: #e6edf3; font-size: 12px; margin-top: 4px; text-align: center;">${file.name}</div>
        `;
        preview.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
  });
});

function createPreviewContainer() {
  const container = document.createElement('div');
  container.id = 'new-media-preview';
  container.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;';
  
  const fileInput = document.getElementById('new-media');
  fileInput.parentNode.appendChild(container);
  
  return container;
}
</script>
{% endblock %}