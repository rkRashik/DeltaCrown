{% comment %}
Roster Ops — Full member management with roster config bar, lock indicator,
player/staff split, game passport, role edit, remove, invite.
Section 7.2 of the Master Plan.
{% endcomment %}
<section id="roster" class="hq-section space-y-4" aria-label="Roster Operations">

    {# ── Roster Lock Banner ── #}
    {% if roster_locked %}
    <div class="rounded-2xl border border-red-500/30 bg-red-500/8 p-4 flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-red-500/15 grid place-items-center shrink-0">
            <i data-lucide="lock" class="w-5 h-5 text-red-400"></i>
        </div>
        <div class="min-w-0">
            <p class="text-sm font-semibold text-red-400">Roster Locked</p>
            <p class="text-xs text-white/40">
                {% if roster_lock_source == 'organization' %}Locked by organization policy. Contact your org admin to unlock.
                {% elif roster_lock_source == 'tournament' %}Locked due to active tournament registration.
                {% else %}Locked by team owner.{% endif %}
            </p>
        </div>
    </div>
    {% endif %}

    {# ── Roster Summary Bar ── #}
    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-4">
            <div>
                <h2 class="text-base font-bold flex items-center gap-2">
                    <i data-lucide="shield" class="w-4 h-4 text-blue-400"></i>
                    Roster Operations
                </h2>
                <p class="text-sm text-white/50 mt-0.5">{{ game_display }} · {{ current_roster_size }} / {{ max_roster_size }} slots</p>
            </div>
            {% if can_manage_roster and not roster_locked %}
            <button onclick="ManageHQ.openInviteModal()"
                class="rounded-xl px-4 py-2 text-sm font-medium border transition"
                style="background:linear-gradient(135deg,color-mix(in oklab,var(--team-primary) 60%,transparent),rgba(255,255,255,.06));border-color:color-mix(in oklab,var(--team-primary) 38%,rgba(255,255,255,.16))">
                <i data-lucide="user-plus" class="w-3.5 h-3.5 inline mr-1"></i>Invite
            </button>
            {% endif %}
        </div>

        {# Roster config metrics #}
        {% if roster_config %}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-4">
            <div class="rounded-xl bg-white/5 border border-white/8 p-2.5 text-center">
                <div class="text-lg font-bold">{{ roster_config.max_team_size }}</div>
                <div class="text-[10px] text-white/40 uppercase tracking-wide">Max Roster</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/8 p-2.5 text-center">
                <div class="text-lg font-bold">{{ roster_config.min_team_size }}</div>
                <div class="text-[10px] text-white/40 uppercase tracking-wide">Min Players</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/8 p-2.5 text-center">
                <div class="text-lg font-bold">{{ roster_config.starters|default:"—" }}</div>
                <div class="text-[10px] text-white/40 uppercase tracking-wide">Starters</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/8 p-2.5 text-center">
                <div class="text-lg font-bold">{{ roster_config.substitutes|default:"—" }}</div>
                <div class="text-[10px] text-white/40 uppercase tracking-wide">Substitutes</div>
            </div>
        </div>
        {% endif %}

        {# Roster fill progress bar #}
        <div class="h-1.5 rounded-full bg-white/10 overflow-hidden mb-1">
            {% widthratio current_roster_size max_roster_size 100 as fill_pct %}
            <div class="h-full rounded-full transition-all duration-500 {% if fill_pct|add:0 >= 90 %}bg-red-500{% elif fill_pct|add:0 >= 70 %}bg-amber-500{% else %}bg-emerald-500{% endif %}"
                 style="width:{{ fill_pct }}%"></div>
        </div>
        <div class="flex justify-between text-[10px] text-white/30 mb-4">
            <span>{{ current_roster_size }} filled</span>
            <span>{{ max_roster_size }} max</span>
        </div>

        {# ── Players Section ── #}
        <h3 class="text-xs font-semibold text-white/50 uppercase tracking-wider mb-2 flex items-center gap-2">
            <i data-lucide="swords" class="w-3 h-3"></i> Players
        </h3>
        <div class="space-y-2 mb-5">
            {% for membership in members %}
            {% if membership.role == 'PLAYER' or membership.role == 'SUBSTITUTE' or membership.role == 'OWNER' %}
            <div class="rounded-xl border border-line bg-white/5 p-3 flex items-center gap-3 group"
                 data-membership-id="{{ membership.id }}">
                {# Avatar #}
                <div class="h-10 w-10 rounded-lg border border-white/15 bg-white/5 grid place-items-center shrink-0 overflow-hidden">
                    {% if membership.user.profile.avatar %}
                    <img src="{{ membership.user.profile.avatar.url }}" alt="" class="w-full h-full object-cover">
                    {% else %}
                    <span class="font-bold text-sm">{{ membership.user.username|slice:":1"|upper }}</span>
                    {% endif %}
                </div>

                {# Info #}
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="font-semibold text-sm truncate">{{ membership.user.username }}</span>
                        {% if membership.role == 'OWNER' %}
                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-300 font-bold">OWNER</span>
                        {% elif membership.role == 'SUBSTITUTE' %}
                        <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-300 font-medium">SUB</span>
                        {% endif %}
                        {% if membership.is_tournament_captain %}
                        <span class="text-amber-400 text-xs" title="Team Captain">⭐</span>
                        {% endif %}
                    </div>
                    <div class="text-xs text-white/40 flex items-center gap-2 mt-0.5">
                        <span>{{ membership.get_role_display }}</span>
                        {% if membership.player_role %}
                        <span class="text-white/30">·</span>
                        <span class="text-blue-400">{{ membership.player_role }}</span>
                        {% endif %}
                        {% if membership.roster_slot %}
                        <span class="text-white/30">·</span>
                        <span>{{ membership.roster_slot }}</span>
                        {% endif %}
                    </div>
                </div>

                {# Actions #}
                {% if can_manage_roster and membership.role != 'OWNER' and not roster_locked %}
                <div class="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 focus-within:opacity-100 sm:opacity-100 md:opacity-0 md:group-hover:opacity-100 md:focus-within:opacity-100 transition shrink-0">
                    <button onclick="ManageHQ.openRoleModal({{ membership.id }}, '{{ membership.role }}', '{{ membership.user.username|escapejs }}', {{ membership.is_tournament_captain|yesno:'true,false' }}, '{{ membership.player_role|default:""|escapejs }}')" aria-label="Edit role for {{ membership.user.username }}"
                        class="h-8 w-8 rounded-lg border border-line bg-white/5 hover:bg-white/10 transition grid place-items-center" title="Edit Role">
                        <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="ManageHQ.openRemoveModal({{ membership.id }}, '{{ membership.user.username|escapejs }}')"
                        class="h-8 w-8 rounded-lg border border-red-500/30 bg-red-500/5 hover:bg-red-500/15 transition grid place-items-center text-red-400" title="Remove">
                        <i data-lucide="user-x" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
                {% elif membership.role == 'OWNER' and is_owner %}
                <span class="text-[11px] text-white/30 shrink-0">You</span>
                {% endif %}
            </div>
            {% endif %}
            {% empty %}
            <div class="rounded-xl border border-line bg-white/5 p-6 text-center">
                <i data-lucide="users" class="w-8 h-8 text-white/20 mx-auto mb-2"></i>
                <p class="text-sm text-white/40">No active members</p>
            </div>
            {% endfor %}
        </div>

        {# ── Staff Section ── #}
        {% if has_staff %}
        <h3 class="text-xs font-semibold text-white/50 uppercase tracking-wider mb-2 flex items-center gap-2">
            <i data-lucide="briefcase" class="w-3 h-3"></i> Staff
        </h3>
        <div class="space-y-2 mb-4">
        {% for membership in members %}
            {% if membership.role == 'MANAGER' or membership.role == 'COACH' or membership.role == 'ANALYST' or membership.role == 'SCOUT' %}
                <div class="rounded-xl border border-line bg-white/5 p-3 flex items-center gap-3 group"
                     data-membership-id="{{ membership.id }}">
                    <div class="h-10 w-10 rounded-lg border border-white/15 bg-white/5 grid place-items-center shrink-0 overflow-hidden">
                        {% if membership.user.profile.avatar %}
                        <img src="{{ membership.user.profile.avatar.url }}" alt="" class="w-full h-full object-cover">
                        {% else %}
                        <span class="font-bold text-sm">{{ membership.user.username|slice:":1"|upper }}</span>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-sm truncate">{{ membership.user.username }}</span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-purple-500/20 text-purple-300 font-medium">{{ membership.get_role_display|upper }}</span>
                        </div>
                        <div class="text-xs text-white/40 mt-0.5">Joined {{ membership.joined_at|timesince }} ago</div>
                    </div>
                    {% if can_manage_roster and not roster_locked %}
                    <div class="flex items-center gap-1.5 opacity-0 group-hover:opacity-100 focus-within:opacity-100 sm:opacity-100 md:opacity-0 md:group-hover:opacity-100 md:focus-within:opacity-100 transition shrink-0">
                        <button onclick="ManageHQ.openRoleModal({{ membership.id }}, '{{ membership.role }}', '{{ membership.user.username|escapejs }}', false, '')" aria-label="Edit role for {{ membership.user.username }}"
                            class="h-8 w-8 rounded-lg border border-line bg-white/5 hover:bg-white/10 transition grid place-items-center" title="Edit Role">
                            <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                        </button>
                        <button onclick="ManageHQ.openRemoveModal({{ membership.id }}, '{{ membership.user.username|escapejs }}')" aria-label="Remove {{ membership.user.username }}"
                            class="h-8 w-8 rounded-lg border border-red-500/30 bg-red-500/5 hover:bg-red-500/15 transition grid place-items-center text-red-400" title="Remove">
                            <i data-lucide="user-x" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
        </div>
        {% endif %}
    </div>

    {# ── Pending Invites ── #}
    <div id="pending-invites-section" class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6 {% if not pending_invites %}hidden{% endif %}">
        <h2 class="text-base font-bold mb-3 flex items-center gap-2">
            <i data-lucide="mail" class="w-4 h-4 text-amber-400"></i>
            Pending Invitations
        </h2>
        <div id="pending-invites-list" class="space-y-2">
            {% for invite in pending_invites %}
            <div id="invite-{{ invite.id }}" class="rounded-xl border border-amber-500/20 bg-amber-500/5 p-3 flex items-center justify-between">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="h-9 w-9 rounded-lg bg-white/10 grid place-items-center text-xs font-bold shrink-0">
                        {% if invite.invited_user and invite.invited_user.profile.avatar %}
                        <img src="{{ invite.invited_user.profile.avatar.url }}" alt="" class="w-full h-full object-cover rounded-lg">
                        {% elif invite.invited_user %}
                        {{ invite.invited_user.username|slice:":1"|upper }}
                        {% else %}
                        {{ invite.invited_email|slice:":1"|upper|default:"?" }}
                        {% endif %}
                    </div>
                    <div class="min-w-0">
                        <div class="font-semibold text-sm truncate">{{ invite.invited_user.username|default:invite.invited_email }}</div>
                        <div class="text-xs text-white/40 truncate">
                            {{ invite.get_role_display|default:invite.role }} · {{ invite.created_at|timesince }} ago
                            {% if invite.inviter %}· by {{ invite.inviter.username }}{% endif %}
                        </div>
                    </div>
                </div>
                {% if can_manage_roster and not roster_locked %}
                <button onclick="ManageHQ.cancelInvite({{ invite.id }}, this)"
                    class="text-xs px-3 py-1.5 rounded-lg border border-red-500/30 bg-red-500/10 text-red-400 hover:bg-red-500/20 transition shrink-0 ml-2">
                    Cancel
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

</section>

{% comment %}
MODALS (placed outside sections so they overlay correctly)
{% endcomment %}

{# ── Invite Modal ── #}
<div id="modal-invite" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="modal-invite-title"
     onclick="if(event.target===this)ManageHQ.closeModal('modal-invite')">
    <div class="bg-[#0f1525] border border-white/15 rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 id="modal-invite-title" class="font-bold text-base">Invite Player</h3>
            <button onclick="ManageHQ.closeModal('modal-invite')" aria-label="Close invite dialog" class="h-8 w-8 rounded-lg hover:bg-white/10 transition grid place-items-center">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <form id="invite-form" class="p-4 space-y-4">
            <div id="invite-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-3"></div>
            <div>
                <label class="block text-xs text-white/60 mb-1.5 font-medium">Username or Email</label>
                <input id="invite-username" type="text" placeholder="Enter username or email…"
                    class="w-full px-3 py-2.5 rounded-xl bg-white/5 border border-white/15 text-sm placeholder-white/30 focus:border-white/30 focus:outline-none transition" required>
            </div>
            <div>
                <label class="block text-xs text-white/60 mb-1.5 font-medium">Role</label>
                <select id="invite-role"
                    class="w-full px-3 py-2.5 rounded-xl bg-white/5 border border-white/15 text-sm focus:border-white/30 focus:outline-none transition">
                    {% for rc in role_choices %}
                    <option value="{{ rc.value }}" {% if rc.value == 'PLAYER' %}selected{% endif %}>{{ rc.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-2 pt-2">
                <button type="button" onclick="ManageHQ.closeModal('modal-invite')"
                    class="flex-1 px-4 py-2.5 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition text-sm font-medium">
                    Cancel
                </button>
                <button id="invite-submit-btn" type="submit"
                    class="flex-1 px-4 py-2.5 rounded-xl text-sm font-medium text-white transition"
                    style="background:linear-gradient(135deg,color-mix(in oklab,var(--team-primary) 70%,transparent),rgba(255,255,255,.08))">
                    Send Invite
                </button>
            </div>
        </form>
    </div>
</div>

{# ── Role Edit Modal ── #}
<div id="modal-role-edit" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="modal-role-edit-title"
     onclick="if(event.target===this)ManageHQ.closeModal('modal-role-edit')">
    <div class="bg-[#0f1525] border border-white/15 rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 id="modal-role-edit-title" class="font-bold text-base">Edit Role: <span id="role-username-display"></span></h3>
            <button onclick="ManageHQ.closeModal('modal-role-edit')" aria-label="Close role edit dialog" class="h-8 w-8 rounded-lg hover:bg-white/10 transition grid place-items-center">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <form id="role-edit-form" class="p-4 space-y-4">
            <input type="hidden" id="role-membership-id">
            <div id="role-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-3"></div>
            <div>
                <label class="block text-xs text-white/60 mb-1.5 font-medium">Organizational Role</label>
                <select id="role-select"
                    class="w-full px-3 py-2.5 rounded-xl bg-white/5 border border-white/15 text-sm focus:border-white/30 focus:outline-none transition">
                    {% for rc in role_choices %}
                    {% if rc.value != 'OWNER' or is_owner %}
                    <option value="{{ rc.value }}">{{ rc.label }}{% if rc.value == 'OWNER' %} (Transfer Ownership){% endif %}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            {% if can_assign_captain_title %}
            <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/10">
                <input id="role-captain-cb" type="checkbox" class="w-4 h-4 rounded accent-amber-400">
                <div>
                    <label for="role-captain-cb" class="text-sm font-medium cursor-pointer">Captain Title ⭐</label>
                    <p class="text-xs text-white/40 mt-0.5">In-game team leader designation</p>
                </div>
            </div>
            {% endif %}
            <div>
                <label class="block text-xs text-white/60 mb-1.5 font-medium">In-Game Role (optional)</label>
                <input id="role-player-role" type="text" placeholder="e.g. Duelist, IGL, AWPer, Support…"
                    class="w-full px-3 py-2.5 rounded-xl bg-white/5 border border-white/15 text-sm placeholder-white/30 focus:border-white/30 focus:outline-none transition">
            </div>
            <div class="flex gap-2 pt-2">
                <button type="button" onclick="ManageHQ.closeModal('modal-role-edit')"
                    class="flex-1 px-4 py-2.5 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition text-sm font-medium">
                    Cancel
                </button>
                <button id="role-submit-btn" type="submit"
                    class="flex-1 px-4 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 transition text-sm font-medium text-white">
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

{# ── Remove Member Modal ── #}
<div id="modal-remove" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="modal-remove-title"
     onclick="if(event.target===this)ManageHQ.closeModal('modal-remove')">
    <div class="bg-[#0f1525] border border-red-500/25 rounded-2xl w-full max-w-md shadow-2xl" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between p-4 border-b border-red-500/15">
            <h3 id="modal-remove-title" class="font-bold text-base text-red-400 flex items-center gap-2">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                Remove Member
            </h3>
            <button onclick="ManageHQ.closeModal('modal-remove')" aria-label="Close remove dialog" class="h-8 w-8 rounded-lg hover:bg-white/10 transition grid place-items-center">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <div id="remove-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-3"></div>
            <input type="hidden" id="remove-membership-id">
            <p class="text-sm text-white/70">
                You are about to remove <strong id="remove-username-display" class="text-white"></strong> from the team. This action cannot be undone.
            </p>
            <div>
                <label class="block text-xs text-white/60 mb-1.5 font-medium">
                    Type <strong id="remove-confirm-target" class="text-red-400"></strong> to confirm
                </label>
                <input id="remove-confirm-input" type="text" placeholder="Type username to confirm…"
                    class="w-full px-3 py-2.5 rounded-xl bg-white/5 border border-red-500/25 text-sm placeholder-white/30 focus:border-red-500/40 focus:outline-none transition">
            </div>
            <div class="flex gap-2 pt-1">
                <button type="button" onclick="ManageHQ.closeModal('modal-remove')"
                    class="flex-1 px-4 py-2.5 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition text-sm font-medium">
                    Cancel
                </button>
                <button id="remove-submit-btn" type="button" onclick="ManageHQ.confirmRemove()"
                    class="flex-1 px-4 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 transition text-sm font-medium text-white">
                    Remove Member
                </button>
            </div>
        </div>
    </div>
</div>
