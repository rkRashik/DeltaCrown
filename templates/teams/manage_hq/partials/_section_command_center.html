{% comment %}
Command Center — Dashboard overview with live stats, health bar, alerts, activity feed.
Section 7.1 of the Master Plan.
{% endcomment %}
<section id="command" class="hq-section is-active space-y-4" aria-label="Command Center">

    {# ── Org Policy Banner (if org team) ── #}
    {% if team.organization %}
    <div class="rounded-3xl border border-indigo-500/20 bg-gradient-to-br from-indigo-500/8 via-indigo-500/3 to-transparent shadow-soft p-5 lg:p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="h-10 w-10 rounded-xl bg-indigo-500/15 grid place-items-center shrink-0">
                {% if org_context.logo_url %}
                <img src="{{ org_context.logo_url }}" alt="" class="w-full h-full rounded-xl object-cover">
                {% else %}
                <i data-lucide="building-2" class="w-5 h-5 text-indigo-400"></i>
                {% endif %}
            </div>
            <div class="min-w-0 flex-1">
                <p class="text-sm font-semibold flex items-center gap-1.5">
                    Managed by {{ team.organization.name }}
                    {% if org_context.is_verified %}
                    <i data-lucide="badge-check" class="w-4 h-4 text-indigo-400" title="Verified"></i>
                    {% endif %}
                </p>
                <p class="text-xs text-white/40">Organization policies may override local team settings</p>
            </div>
            {% if org_control_plane_url %}
            <a href="{{ org_control_plane_url }}"
               class="shrink-0 px-3 py-1.5 text-[10px] rounded-lg bg-indigo-500/15 text-indigo-400 hover:bg-indigo-500/25 transition font-semibold">
                Control Plane →
            </a>
            {% endif %}
        </div>

        {# ── Inherited Policies List ── #}
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            {# Roster Lock Policy #}
            <div class="flex items-center gap-2 p-2.5 rounded-xl bg-white/5">
                {% if org_policies.roster_locked %}
                <i data-lucide="lock" class="w-3.5 h-3.5 text-red-400 shrink-0"></i>
                <span class="text-xs text-red-400/80">Roster Locked by Org</span>
                {% else %}
                <i data-lucide="unlock" class="w-3.5 h-3.5 text-emerald-400 shrink-0"></i>
                <span class="text-xs text-white/50">Roster Open</span>
                {% endif %}
            </div>

            {# Brand Enforcement #}
            <div class="flex items-center gap-2 p-2.5 rounded-xl bg-white/5">
                {% if org_policies.enforce_brand %}
                <i data-lucide="palette" class="w-3.5 h-3.5 text-amber-400 shrink-0"></i>
                <span class="text-xs text-amber-400/80">Brand Inherited</span>
                {% else %}
                <i data-lucide="brush" class="w-3.5 h-3.5 text-emerald-400 shrink-0"></i>
                <span class="text-xs text-white/50">Custom Branding</span>
                {% endif %}
            </div>

            {# Revenue Split #}
            <div class="flex items-center gap-2 p-2.5 rounded-xl bg-white/5">
                {% if org_policies.revenue_split_config %}
                <i data-lucide="split" class="w-3.5 h-3.5 text-blue-400 shrink-0"></i>
                <span class="text-xs text-blue-400/80">Revenue Split Active</span>
                {% else %}
                <i data-lucide="circle-dollar-sign" class="w-3.5 h-3.5 text-white/30 shrink-0"></i>
                <span class="text-xs text-white/50">No Split Config</span>
                {% endif %}
            </div>
        </div>

        {# Empire Score (if org has ranking) #}
        {% if org_context.empire_score %}
        <div class="mt-3 flex items-center gap-3 p-3 rounded-xl bg-amber-500/5 border border-amber-500/15">
            <i data-lucide="crown" class="w-4 h-4 text-amber-400 shrink-0"></i>
            <div>
                <span class="text-sm font-bold text-amber-400">{{ org_context.empire_score }}</span>
                <span class="text-xs text-white/40 ml-1">Empire Score</span>
            </div>
            {% if org_context.global_rank %}
            <span class="ml-auto text-xs text-white/40">#{{ org_context.global_rank }} <span class="text-white/25">Global</span></span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# ── Stats Grid ── #}
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <div class="rounded-2xl border border-line bg-card p-4 text-center">
            <div class="text-2xl font-black">{{ current_roster_size }}</div>
            <div class="text-xs text-white/50 mt-1">Members</div>
        </div>
        <div class="rounded-2xl border border-line bg-card p-4 text-center">
            <div class="text-2xl font-black">{{ pending_invites.count }}</div>
            <div class="text-xs text-white/50 mt-1">Pending Invites</div>
        </div>
        <div class="rounded-2xl border border-line bg-card p-4 text-center">
            <div class="text-2xl font-black">{{ join_request_count }}</div>
            <div class="text-xs text-white/50 mt-1">Join Requests</div>
        </div>
        <div class="rounded-2xl border border-line bg-card p-4 text-center">
            <div class="text-2xl font-black text-white/60">—</div>
            <div class="text-xs text-white/50 mt-1">Tournaments</div>
        </div>
    </div>

    {# ── Team Health Bar ── #}
    {% with has_logo=team.logo has_banner=team.banner has_desc=team.description has_social=team.twitter_url|default:team.instagram_url|default:team.youtube_url|default:team.twitch_url has_region=team.region %}
    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <h2 class="text-base font-bold mb-3 flex items-center gap-2">
            <i data-lucide="heart-pulse" class="w-4 h-4 text-rose-400"></i>
            Team Health
        </h2>
        <div class="space-y-2">
            {# Progress bar #}
            {% widthratio current_roster_size max_roster_size 100 as roster_pct %}
            <div class="flex items-center justify-between text-xs text-white/50 mb-1">
                <span>Profile completion</span>
                <span class="font-semibold text-white/70" id="health-pct"></span>
            </div>
            <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                <div id="health-bar" class="h-full rounded-full transition-all duration-700 bg-gradient-to-r from-emerald-500 to-emerald-400" style="width:0%"></div>
            </div>

            {# Checklist #}
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 mt-3">
                <div class="flex items-center gap-2 text-xs {% if has_logo %}text-emerald-400{% else %}text-white/30{% endif %}">
                    <i data-lucide="{% if has_logo %}check-circle{% else %}circle{% endif %}" class="w-3.5 h-3.5 shrink-0"></i>
                    Logo
                </div>
                <div class="flex items-center gap-2 text-xs {% if has_banner %}text-emerald-400{% else %}text-white/30{% endif %}">
                    <i data-lucide="{% if has_banner %}check-circle{% else %}circle{% endif %}" class="w-3.5 h-3.5 shrink-0"></i>
                    Banner
                </div>
                <div class="flex items-center gap-2 text-xs {% if has_desc %}text-emerald-400{% else %}text-white/30{% endif %}">
                    <i data-lucide="{% if has_desc %}check-circle{% else %}circle{% endif %}" class="w-3.5 h-3.5 shrink-0"></i>
                    Description
                </div>
                <div class="flex items-center gap-2 text-xs {% if has_social %}text-emerald-400{% else %}text-white/30{% endif %}">
                    <i data-lucide="{% if has_social %}check-circle{% else %}circle{% endif %}" class="w-3.5 h-3.5 shrink-0"></i>
                    Social links
                </div>
                <div class="flex items-center gap-2 text-xs {% if has_region %}text-emerald-400{% else %}text-white/30{% endif %}">
                    <i data-lucide="{% if has_region %}check-circle{% else %}circle{% endif %}" class="w-3.5 h-3.5 shrink-0"></i>
                    Region
                </div>
            </div>
        </div>
    </div>
    <script>
        (function() {
            var score = 0, total = 5;
            if ({{ has_logo|yesno:"true,false" }}) score++;
            if ({{ has_banner|yesno:"true,false" }}) score++;
            if ({{ has_desc|yesno:"true,false" }}) score++;
            if ({{ has_social|yesno:"true,false" }}) score++;
            if ({{ has_region|yesno:"true,false" }}) score++;
            var pct = Math.round((score / total) * 100);
            var bar = document.getElementById('health-bar');
            var txt = document.getElementById('health-pct');
            if (bar) setTimeout(function() { bar.style.width = pct + '%'; }, 100);
            if (txt) txt.textContent = pct + '%';
        })();
    </script>
    {% endwith %}

    {# ── Alerts Panel ── #}
    {% if not team.logo or not team.banner or current_roster_size < min_roster_size %}
    <div class="rounded-3xl border border-amber-500/20 bg-amber-500/5 shadow-soft p-5 lg:p-6">
        <h2 class="text-base font-bold mb-3 flex items-center gap-2 text-amber-400">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            Attention Required
        </h2>
        <div class="space-y-2">
            {% if not team.logo %}
            <div class="flex items-center gap-3 p-2.5 rounded-xl bg-white/5 text-sm">
                <i data-lucide="image" class="w-4 h-4 text-amber-400 shrink-0"></i>
                <span class="text-white/70">No team logo uploaded — <button onclick="setActiveRoute('profile')" class="text-amber-400 hover:underline">add one</button></span>
            </div>
            {% endif %}
            {% if not team.banner %}
            <div class="flex items-center gap-3 p-2.5 rounded-xl bg-white/5 text-sm">
                <i data-lucide="panorama" class="w-4 h-4 text-amber-400 shrink-0"></i>
                <span class="text-white/70">No banner image — <button onclick="setActiveRoute('profile')" class="text-amber-400 hover:underline">upload banner</button></span>
            </div>
            {% endif %}
            {% if current_roster_size < min_roster_size %}
            <div class="flex items-center gap-3 p-2.5 rounded-xl bg-white/5 text-sm">
                <i data-lucide="users" class="w-4 h-4 text-amber-400 shrink-0"></i>
                <span class="text-white/70">Roster below minimum ({{ current_roster_size }}/{{ min_roster_size }}) — <button onclick="ManageHQ.openInviteModal()" class="text-amber-400 hover:underline">invite players</button></span>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# ── Quick Action Bar ── #}
    {% if can_manage_roster %}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button onclick="ManageHQ.openInviteModal()"
            class="rounded-2xl border border-line bg-card hover:bg-card2 transition p-4 flex flex-col items-center gap-2 group cursor-pointer">
            <div class="h-10 w-10 rounded-xl bg-emerald-500/15 text-emerald-400 grid place-items-center group-hover:scale-110 transition-transform">
                <i data-lucide="user-plus" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">Invite Player</span>
        </button>
        <button onclick="setActiveRoute('roster')"
            class="rounded-2xl border border-line bg-card hover:bg-card2 transition p-4 flex flex-col items-center gap-2 group cursor-pointer">
            <div class="h-10 w-10 rounded-xl bg-blue-500/15 text-blue-400 grid place-items-center group-hover:scale-110 transition-transform">
                <i data-lucide="users" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">Manage Roster</span>
        </button>
        <button onclick="setActiveRoute('competition')"
            class="rounded-2xl border border-line bg-card hover:bg-card2 transition p-4 flex flex-col items-center gap-2 group cursor-pointer">
            <div class="h-10 w-10 rounded-xl bg-amber-500/15 text-amber-400 grid place-items-center group-hover:scale-110 transition-transform">
                <i data-lucide="trophy" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">Competitions</span>
        </button>
        <button onclick="setActiveRoute('profile')"
            class="rounded-2xl border border-line bg-card hover:bg-card2 transition p-4 flex flex-col items-center gap-2 group cursor-pointer">
            <div class="h-10 w-10 rounded-xl bg-purple-500/15 text-purple-400 grid place-items-center group-hover:scale-110 transition-transform">
                <i data-lucide="palette" class="w-5 h-5"></i>
            </div>
            <span class="text-xs font-medium">Edit Profile</span>
        </button>
    </div>
    {% endif %}

    {# ── Pending Actions ── #}
    {% if join_requests or pending_invites %}
    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <h2 class="text-base font-bold flex items-center gap-2">
            <i data-lucide="bell-ring" class="w-4 h-4 text-amber-400"></i>
            Pending Actions
        </h2>

        {% if join_requests %}
        <div class="mt-4" data-jr-section>
            <h3 class="text-sm font-semibold text-white/70 mb-2 flex items-center gap-2">
                Join Requests
                <span id="jr-count-badge" class="text-[11px] px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-300">{{ join_request_count }}</span>
            </h3>
            <div class="space-y-2">
                {% for jr in join_requests %}
                <div id="jr-{{ jr.id }}" class="rounded-xl border border-line bg-white/5 p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="h-9 w-9 rounded-lg bg-white/10 grid place-items-center text-xs font-bold shrink-0">
                            {% if jr.applicant.avatar %}
                            <img src="{{ jr.applicant.avatar.url }}" alt="" class="w-full h-full object-cover rounded-lg">
                            {% else %}
                            {{ jr.applicant.user.username|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div class="min-w-0">
                            <div class="text-sm font-semibold truncate">{{ jr.applicant.user.username }}</div>
                            <div class="text-xs text-white/40 truncate">{{ jr.created_at|timesince }} ago{% if jr.message %} · "{{ jr.message|truncatewords:8 }}"{% endif %}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 shrink-0 ml-2">
                        <button onclick="ManageHQ.handleJoinRequest({{ jr.id }}, 'approve', this)"
                            class="text-xs px-3 py-1.5 rounded-lg bg-emerald-500/15 text-emerald-400 hover:bg-emerald-500/25 transition font-medium">
                            Approve
                        </button>
                        <button onclick="ManageHQ.handleJoinRequest({{ jr.id }}, 'reject', this)"
                            class="text-xs px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition font-medium">
                            Reject
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if pending_invites %}
        <div class="mt-4" id="pending-invites-section">
            <h3 class="text-sm font-semibold text-white/70 mb-2">Pending Invites ({{ pending_invites.count }})</h3>
            <div class="space-y-1" id="pending-invites-list">
                {% for invite in pending_invites|slice:":5" %}
                <div id="invite-{{ invite.id }}" class="rounded-lg border border-line bg-white/5 p-2 px-3 flex items-center justify-between text-sm">
                    <span>
                        <span class="font-medium">{{ invite.invited_user.username|default:invite.invited_email }}</span>
                        <span class="text-white/40 ml-1">{{ invite.created_at|timesince }} ago</span>
                    </span>
                    <button onclick="ManageHQ.cancelInvite({{ invite.id }}, this)"
                        class="text-xs text-red-400 hover:text-red-300 transition">Cancel</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# ── Team Overview ── #}
    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <h2 class="text-base font-bold mb-4">Team Overview</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-1">
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Team Name</span>
                <span class="text-sm font-semibold">{{ team.name }}</span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Tag</span>
                <span class="text-sm font-semibold">[{{ team.tag }}]</span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Game</span>
                <span class="text-sm font-semibold">{{ game_display }}</span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Region</span>
                <span class="text-sm font-semibold">{{ team.region|default:"Not set" }}</span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Status</span>
                <span class="text-xs px-2.5 py-1 rounded-full font-medium {% if team.status == 'ACTIVE' %}bg-emerald-500/15 text-emerald-400{% else %}bg-red-500/15 text-red-400{% endif %}">
                    {% if team.status == 'ACTIVE' %}Active{% else %}{{ team.status|title }}{% endif %}
                </span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Visibility</span>
                <span class="text-xs px-2.5 py-1 rounded-full font-medium bg-white/10 text-white/50">
                    {{ team.visibility|default:"PUBLIC"|title }}
                </span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Roster</span>
                <span class="text-sm font-semibold">{{ current_roster_size }} / {{ max_roster_size }}</span>
            </div>
            <div class="flex justify-between items-center py-2.5 border-b border-white/8">
                <span class="text-sm text-white/50">Founded</span>
                <span class="text-sm font-semibold">{{ team.created_at|date:"M d, Y" }}</span>
            </div>
        </div>
    </div>

    {# ── Recent Activity ── #}
    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <h2 class="text-base font-bold mb-3 flex items-center gap-2">
            <i data-lucide="activity" class="w-4 h-4 text-blue-400"></i>
            Recent Activity
        </h2>
        <div id="activity-feed">
            <div class="text-sm text-white/40 text-center py-6">
                <i data-lucide="loader" class="w-5 h-5 animate-spin inline-block mb-2"></i><br>
                Loading activity…
            </div>
        </div>
    </div>

</section>
