{% extends "base.html" %}
{% load static %}

{% block title %}{% if post %}Edit Post{% else %}Create New Post{% endif %} - {{ team.name }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 40px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .form-group {
        margin-bottom: 24px;
    }
    
    .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        display: block;
    }
    
    .form-label .required {
        color: #dc3545;
    }
    
    .form-input, .form-select, .form-textarea {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        font-family: inherit;
        font-size: 1em;
        transition: border-color 0.2s;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-textarea {
        resize: vertical;
        min-height: 300px;
        font-family: 'Courier New', monospace;
    }
    
    .form-help {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 6px;
    }
    
    .markdown-toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }
    
    .markdown-btn {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px 12px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .markdown-btn:hover {
        background: #e9ecef;
    }
    
    .preview-toggle {
        background: #667eea;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
    }
    
    .preview-pane {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 20px;
        min-height: 300px;
        margin-top: 12px;
    }
    
    .submit-section {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }
    
    .submit-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
    }
    
    .cancel-btn {
        background: white;
        color: #6c757d;
        border: 1px solid #dee2e6;
        padding: 12px 32px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .cancel-btn:hover {
        background: #f8f9fa;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 20px;
    }
    
    .post-type-option {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .post-type-option:hover {
        background: #f8f9fa;
    }
    
    .post-type-option input[type="radio"] {
        margin-right: 12px;
    }
    
    .post-type-option.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .post-type-icon {
        font-size: 1.5em;
        margin-right: 12px;
    }
    
    .post-type-info {
        flex: 1;
    }
    
    .post-type-name {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .post-type-desc {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="form-header">
    <h2>{% if post %}<i class="fa-solid fa-pen" aria-hidden="true"></i> Edit Post{% else %}<i class="fa-solid fa-plus" aria-hidden="true"></i> Create New Post{% endif %}</h2>
        <p class="mb-0 opacity-75">{{ team.name }} Discussion Board</p>
    </div>
    
    <div class="form-container">
        {% if messages %}
        <div class="error-message">
            {% for message in messages %}
                {{ message }}
            {% endfor %}
        </div>
        {% endif %}
        
        <form method="POST" id="postForm">
            {% csrf_token %}
            
            <!-- Post Type -->
            <div class="form-group">
                <label class="form-label">
                    Post Type <span class="required">*</span>
                </label>
                <div id="postTypeOptions">
                    <label class="post-type-option {% if not post or post.post_type == 'discussion' %}selected{% endif %}">
                        <input type="radio" name="post_type" value="discussion" 
                               {% if not post or post.post_type == 'discussion' %}checked{% endif %}>
                        <span class="post-type-icon">üí¨</span>
                        <div class="post-type-info">
                            <div class="post-type-name">Discussion</div>
                            <div class="post-type-desc">General team discussions and conversations</div>
                        </div>
                    </label>
                    
                    <label class="post-type-option {% if post and post.post_type == 'question' %}selected{% endif %}">
                        <input type="radio" name="post_type" value="question"
                               {% if post and post.post_type == 'question' %}checked{% endif %}>
                        <span class="post-type-icon">‚ùì</span>
                        <div class="post-type-info">
                            <div class="post-type-name">Question</div>
                            <div class="post-type-desc">Ask questions to team members</div>
                        </div>
                    </label>
                    
                    {% if can_create_announcement %}
                    <label class="post-type-option {% if post and post.post_type == 'announcement' %}selected{% endif %}">
                        <input type="radio" name="post_type" value="announcement"
                               {% if post and post.post_type == 'announcement' %}checked{% endif %}>
                        <span class="post-type-icon">üì¢</span>
                        <div class="post-type-info">
                            <div class="post-type-name">Announcement</div>
                            <div class="post-type-desc">Important team announcements (staff only)</div>
                        </div>
                    </label>
                    {% endif %}
                    
                    <label class="post-type-option {% if post and post.post_type == 'poll' %}selected{% endif %}">
                        <input type="radio" name="post_type" value="poll"
                               {% if post and post.post_type == 'poll' %}checked{% endif %}>
                        <span class="post-type-icon">üìä</span>
                        <div class="post-type-info">
                            <div class="post-type-name">Poll</div>
                            <div class="post-type-desc">Create a poll for team voting</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Title -->
            <div class="form-group">
                <label class="form-label" for="title">
                    Title <span class="required">*</span>
                </label>
                <input type="text" 
                       id="title" 
                       name="title" 
                       class="form-input" 
                       placeholder="Enter a descriptive title..."
                       value="{% if post %}{{ post.title }}{% endif %}"
                       required>
                <div class="form-help">Make it clear and descriptive (max 200 characters)</div>
            </div>
            
            <!-- Content -->
            <div class="form-group">
                <label class="form-label" for="content">
                    Content <span class="required">*</span>
                </label>
                <div class="markdown-toolbar">
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('**', '**')">
                        <strong>B</strong>
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('*', '*')">
                        <em>I</em>
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('~~', '~~')">
                        <s>S</s>
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('[', '](url)')">
                        üîó Link
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('![alt](', ')')">
                        üñºÔ∏è Image
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('```\n', '\n```')">
                        üíª Code
                    </button>
                    <button type="button" class="markdown-btn" onclick="insertMarkdown('> ', '')">
                        üí≠ Quote
                    </button>
                    <button type="button" class="preview-toggle" onclick="togglePreview()">
                        üëÅÔ∏è Preview
                    </button>
                </div>
                <textarea id="content" 
                          name="content" 
                          class="form-textarea" 
                          placeholder="Write your post... (Markdown supported)"
                          required>{% if post %}{{ post.content }}{% endif %}</textarea>
                <div id="previewPane" class="preview-pane" style="display: none;"></div>
                <div class="form-help">
                    Supports Markdown formatting. You can embed YouTube, Twitter, and other social media links.
                </div>
            </div>
            
            <!-- Visibility -->
            <div class="form-group">
                <label class="form-label" for="visibility">
                    Visibility
                </label>
                <select id="visibility" name="visibility" class="form-select">
                    <option value="public" {% if not post or post.visibility == 'public' %}selected{% endif %}>
                        üåê Public (visible to everyone)
                    </option>
                    <option value="private" {% if post and post.visibility == 'private' %}selected{% endif %}>
                        üîí Team Only (only team members can see)
                    </option>
                </select>
            </div>
            
            <!-- Submit Section -->
            <div class="submit-section">
                <a href="{% if post %}{% url 'teams:discussion_post_detail' team.slug post.slug %}{% else %}{% url 'teams:discussion_board' team.slug %}{% endif %}" 
                   class="cancel-btn">
                    Cancel
                </a>
                <button type="submit" class="submit-btn">
                    {% if post %}üíæ Update Post{% else %}üìù Create Post{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let previewMode = false;

// Post type selection visual feedback
document.querySelectorAll('.post-type-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.post-type-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        this.classList.add('selected');
        this.querySelector('input[type="radio"]').checked = true;
    });
});

// Insert markdown syntax
function insertMarkdown(before, after) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const replacement = before + selectedText + after;
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    
    // Set cursor position
    const newCursorPos = start + before.length + selectedText.length;
    textarea.focus();
    textarea.setSelectionRange(newCursorPos, newCursorPos);
}

// Toggle preview
async function togglePreview() {
    previewMode = !previewMode;
    const preview = document.getElementById('previewPane');
    const textarea = document.getElementById('content');
    
    if (previewMode) {
        const content = textarea.value;
        
        const formData = new FormData();
        formData.append('content', content);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        
        try {
            const response = await fetch('{% url "teams:markdown_preview" %}', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.success) {
                preview.innerHTML = `
                    <div style="margin-bottom: 16px; color: #6c757d; font-size: 0.9em;">
                        üìñ Reading Time: ${data.reading_time} min | üìù Word Count: ${data.word_count}
                    </div>
                    ${data.html}
                `;
                preview.style.display = 'block';
                textarea.style.display = 'none';
            } else {
                alert('Preview error: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to generate preview');
        }
    } else {
        preview.style.display = 'none';
        textarea.style.display = 'block';
    }
}

// Form validation
document.getElementById('postForm').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title) {
        e.preventDefault();
        alert('Please enter a title');
        return false;
    }
    
    if (title.length > 200) {
        e.preventDefault();
        alert('Title must be 200 characters or less');
        return false;
    }
    
    if (!content) {
        e.preventDefault();
        alert('Please enter content');
        return false;
    }
    
    if (content.length < 10) {
        e.preventDefault();
        alert('Content must be at least 10 characters');
        return false;
    }
    
    return true;
});

// Auto-save to localStorage (optional enhancement)
let autoSaveTimer;
const AUTOSAVE_INTERVAL = 30000; // 30 seconds

function autoSave() {
    const formData = {
        title: document.getElementById('title').value,
        content: document.getElementById('content').value,
        post_type: document.querySelector('input[name="post_type"]:checked').value,
        visibility: document.getElementById('visibility').value
    };
    
    localStorage.setItem('discussion_post_draft', JSON.stringify(formData));
}

// Load draft on page load
window.addEventListener('load', function() {
    {% if not post %}
    const draft = localStorage.getItem('discussion_post_draft');
    if (draft && confirm('Would you like to restore your previous draft?')) {
        const formData = JSON.parse(draft);
        document.getElementById('title').value = formData.title || '';
        document.getElementById('content').value = formData.content || '';
        document.querySelector(`input[name="post_type"][value="${formData.post_type}"]`).checked = true;
        document.getElementById('visibility').value = formData.visibility || 'public';
    }
    {% endif %}
    
    // Start auto-save
    document.getElementById('title').addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, AUTOSAVE_INTERVAL);
    });
    
    document.getElementById('content').addEventListener('input', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(autoSave, AUTOSAVE_INTERVAL);
    });
});

// Clear draft on successful submit
document.getElementById('postForm').addEventListener('submit', function() {
    localStorage.removeItem('discussion_post_draft');
});
</script>
{% endblock %}
