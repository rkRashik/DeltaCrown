{% extends "base.html" %}
{% load static %}

{% block title %}{{ team.name }} - Team Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px 8px 0 0;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f5f7fa;
    }
    
    .chat-message {
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
    }
    
    .chat-message.pinned {
        background: #fff3cd;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
    }
    
    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .message-content {
        flex: 1;
    }
    
    .message-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }
    
    .message-sender {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .message-time {
        font-size: 0.85em;
        color: #95a5a6;
    }
    
    .message-edited {
        font-size: 0.8em;
        color: #f39c12;
        font-style: italic;
    }
    
    .message-text {
        color: #34495e;
        line-height: 1.6;
        word-wrap: break-word;
    }
    
    .message-text .mention {
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .message-attachment {
        margin-top: 10px;
        padding: 10px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }
    
    .message-attachment img {
        max-width: 300px;
        max-height: 300px;
        border-radius: 6px;
    }
    
    .message-reply-to {
        background: #f8f9fa;
        padding: 8px;
        border-left: 3px solid #667eea;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 0.9em;
    }
    
    .message-reactions {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap;
    }
    
    .reaction-badge {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .reaction-badge:hover {
        background: #e9ecef;
        transform: scale(1.05);
    }
    
    .reaction-badge.user-reacted {
        background: #e3f2fd;
        border-color: #1976d2;
    }
    
    .message-actions {
        display: none;
        gap: 8px;
        margin-top: 8px;
    }
    
    .chat-message:hover .message-actions {
        display: flex;
    }
    
    .message-action-btn {
        background: none;
        border: none;
        color: #95a5a6;
        cursor: pointer;
        padding: 4px 8px;
        font-size: 0.85em;
        transition: color 0.2s;
    }
    
    .message-action-btn:hover {
        color: #667eea;
    }
    
    .chat-input-container {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        background: white;
        border-radius: 0 0 8px 8px;
    }
    
    .typing-indicator {
        padding: 10px 20px;
        font-size: 0.9em;
        color: #95a5a6;
        font-style: italic;
        min-height: 40px;
    }
    
    .chat-input-box {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }
    
    .chat-textarea {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        resize: none;
        font-family: inherit;
        font-size: 1em;
        max-height: 120px;
    }
    
    .chat-textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .chat-send-btn:hover {
        transform: translateY(-2px);
    }
    
    .chat-send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .unread-badge {
        background: #dc3545;
        color: white;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.85em;
        margin-left: 10px;
    }
    
    .pin-icon {
        color: #ffc107;
        margin-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">üí¨ {{ team.name }} Team Chat</h4>
                            <p class="mb-0 opacity-75">Real-time team communication</p>
                        </div>
                        <div>
                            {% if unread_count > 0 %}
                            <span class="unread-badge">{{ unread_count }} unread</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                    <div class="chat-message {% if message.is_pinned %}pinned{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-avatar">
                            {{ message.sender.user.username.0|upper }}
                        </div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">{{ message.sender.user.username }}</span>
                                <span class="message-time">{{ message.created_at|date:"M d, Y g:i A" }}</span>
                                {% if message.is_edited %}
                                <span class="message-edited">(edited)</span>
                                {% endif %}
                                {% if message.is_pinned %}
                                <span class="pin-icon" title="Pinned">üìå</span>
                                {% endif %}
                            </div>
                            
                            {% if message.reply_to %}
                            <div class="message-reply-to">
                                ‚Ü©Ô∏è Replying to <strong>{{ message.reply_to.sender.user.username }}</strong>: 
                                {{ message.reply_to.message|truncatewords:15 }}
                            </div>
                            {% endif %}
                            
                            <div class="message-text">
                                {{ message.message|linebreaks }}
                            </div>
                            
                            {% if message.attachment %}
                            <div class="message-attachment">
                                {% if message.attachment_type == 'image' %}
                                <img src="{{ message.attachment.url }}" alt="Attachment">
                                {% else %}
                                üìé <a href="{{ message.attachment.url }}" target="_blank">{{ message.attachment.name }}</a>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if message.reaction_summary %}
                            <div class="message-reactions">
                                {% for emoji, count in message.reaction_summary.items %}
                                <span class="reaction-badge" onclick="toggleReaction({{ message.id }}, '{{ emoji }}')">
                                    {{ emoji }} {{ count }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            <div class="message-actions">
                                <button class="message-action-btn" onclick="replyToMessage({{ message.id }}, '{{ message.sender.user.username }}')">
                                    ‚Ü©Ô∏è Reply
                                </button>
                                <button class="message-action-btn" onclick="addReaction({{ message.id }})">
                                    ‚ù§Ô∏è React
                                </button>
                                {% if can_pin %}
                                <button class="message-action-btn" onclick="pinMessage({{ message.id }})">
                                    üìå {% if message.is_pinned %}Unpin{% else %}Pin{% endif %}
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <h5>No messages yet</h5>
                        <p>Be the first to start the conversation!</p>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    {% if typing_users %}
                    {% for user in typing_users %}
                        {{ user.user.username }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    {% if typing_users|length == 1 %}is{% else %}are{% endif %} typing...
                    {% endif %}
                </div>
                
                <!-- Chat Input -->
                <div class="chat-input-container">
                    <div id="replyPreview" style="display:none; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <span id="replyText"></span>
                        <button onclick="cancelReply()" style="float: right; background: none; border: none; cursor: pointer;">‚úï</button>
                    </div>
                    <form id="chatForm" class="chat-input-box">
                        {% csrf_token %}
                        <textarea 
                            id="messageInput" 
                            class="chat-textarea" 
                            rows="2" 
                            placeholder="Type your message... (@ to mention someone)"
                            required
                        ></textarea>
                        <button type="submit" class="chat-send-btn">
                            Send üì§
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let replyToId = null;
let typingTimeout = null;

// Auto-scroll to bottom on load
window.addEventListener('load', function() {
    scrollToBottom();
});

function scrollToBottom() {
    const messages = document.getElementById('chatMessages');
    messages.scrollTop = messages.scrollHeight;
}

// Send message
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = document.getElementById('messageInput').value.trim();
    if (!message) return;
    
    const formData = new FormData();
    formData.append('action', 'send_message');
    formData.append('message', message);
    if (replyToId) {
        formData.append('reply_to', replyToId);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('{% url "teams:chat_api" team.slug %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            document.getElementById('messageInput').value = '';
            cancelReply();
            // Reload messages (in production, use WebSocket instead)
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// Typing indicator
document.getElementById('messageInput').addEventListener('input', function() {
    clearTimeout(typingTimeout);
    
    // Set typing
    setTyping();
    
    // Clear after 3 seconds
    typingTimeout = setTimeout(clearTyping, 3000);
});

async function setTyping() {
    const formData = new FormData();
    formData.append('action', 'set_typing');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    await fetch('{% url "teams:chat_api" team.slug %}', {
        method: 'POST',
        body: formData
    });
}

async function clearTyping() {
    const formData = new FormData();
    formData.append('action', 'clear_typing');
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    await fetch('{% url "teams:chat_api" team.slug %}', {
        method: 'POST',
        body: formData
    });
}

// Reply to message
function replyToMessage(messageId, senderUsername) {
    replyToId = messageId;
    document.getElementById('replyPreview').style.display = 'block';
    document.getElementById('replyText').textContent = `Replying to ${senderUsername}`;
    document.getElementById('messageInput').focus();
}

function cancelReply() {
    replyToId = null;
    document.getElementById('replyPreview').style.display = 'none';
}

// Add reaction
async function addReaction(messageId) {
    const emoji = prompt('Enter emoji:', 'üëç');
    if (!emoji) return;
    
    const formData = new FormData();
    formData.append('action', 'add_reaction');
    formData.append('message_id', messageId);
    formData.append('emoji', emoji);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('{% url "teams:chat_api" team.slug %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Toggle reaction
async function toggleReaction(messageId, emoji) {
    const formData = new FormData();
    formData.append('action', 'remove_reaction');
    formData.append('message_id', messageId);
    formData.append('emoji', emoji);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('{% url "teams:chat_api" team.slug %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Pin message
async function pinMessage(messageId) {
    if (!confirm('Toggle pin status for this message?')) return;
    
    const formData = new FormData();
    formData.append('action', 'pin_message');
    formData.append('message_id', messageId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('{% url "teams:chat_api" team.slug %}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Poll for typing users every 3 seconds
setInterval(async function() {
    try {
        const response = await fetch('{% url "teams:chat_typing_status" team.slug %}');
        const data = await response.json();
        
        if (data.success && data.typing_users.length > 0) {
            const usernames = data.typing_users.map(u => u.username).join(', ');
            const verb = data.typing_users.length === 1 ? 'is' : 'are';
            document.getElementById('typingIndicator').textContent = `${usernames} ${verb} typing...`;
        } else {
            document.getElementById('typingIndicator').textContent = '';
        }
    } catch (error) {
        console.error('Error polling typing status:', error);
    }
}, 3000);
</script>
{% endblock %}
