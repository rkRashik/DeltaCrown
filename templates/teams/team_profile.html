{% extends "base.html" %}
{% load static %}

{% block title %}{{ team.name }} - Team Profile{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'teams/css/team-profile.css' %}">
{% endblock %}

{% block content %}
<div class="team-profile">
    <!-- Hero Section with Banner -->
    <section class="profile-hero">
        {% if team.banner_image %}
        <div class="hero-banner" style="background-image: url('{{ team.banner_image.url }}');"></div>
        {% else %}
        <div class="hero-banner hero-banner-default"></div>
        {% endif %}
        
        <div class="hero-overlay"></div>
        
        <div class="container hero-content">
            <div class="team-header">
                <div class="team-logo-large">
                    {% if team.logo %}
                    <img src="{{ team.logo.url }}" alt="{{ team.name }}">
                    {% else %}
                    <div class="logo-placeholder-large">{{ team.tag|slice:":2"|upper }}</div>
                    {% endif %}
                </div>
                
                <div class="team-identity">
                    <div class="team-badges">
                        {% if team.is_verified %}
                        <span class="badge badge-verified">
                            <i class="icon-check-circle"></i> Verified
                        </span>
                        {% endif %}
                        {% if team.is_featured %}
                        <span class="badge badge-featured">
                            <i class="icon-star"></i> Featured
                        </span>
                        {% endif %}
                    </div>
                    
                    <h1 class="team-name">{{ team.name }}</h1>
                    <div class="team-tagline">[{{ team.tag }}]</div>
                    
                    <div class="team-quick-info">
                        <span class="info-chip">
                            <i class="icon-game"></i>
                            {{ team.get_game_display|default:team.game }}
                        </span>
                        <span class="info-chip">
                            <i class="icon-map-pin"></i>
                            {{ team.region|default:"Global" }}
                        </span>
                        <span class="info-chip">
                            <i class="icon-calendar"></i>
                            Est. {{ team.created_at|date:"Y" }}
                        </span>
                    </div>
                    
                    <div class="team-stats-bar">
                        <div class="stat-item">
                            <div class="stat-value">{{ followers_count }}</div>
                            <div class="stat-label">Followers</div>
                        </div>
                        <div class="stat-divider"></div>
                        <div class="stat-item">
                            <div class="stat-value">{{ roster_count }}</div>
                            <div class="stat-label">Players</div>
                        </div>
                        <div class="stat-divider"></div>
                        <div class="stat-item">
                            <div class="stat-value">{{ total_achievements }}</div>
                            <div class="stat-label">Achievements</div>
                        </div>
                    </div>
                </div>
                
                <div class="team-actions">
                    {% if is_captain %}
                    <a href="{% url 'teams:manage' team.slug %}" class="btn btn-primary btn-lg">
                        <i class="icon-settings"></i> Manage Team
                    </a>
                    {% elif is_member %}
                    <button class="btn btn-secondary btn-lg" disabled>
                        <i class="icon-check"></i> Member
                    </button>
                    {% elif can_request_join %}
                    <button class="btn btn-primary btn-lg" onclick="requestJoin()">
                        <i class="icon-user-plus"></i> Request to Join
                    </button>
                    {% elif already_in_team_for_game %}
                    <button class="btn btn-secondary btn-lg" disabled title="You're already in a {{ team.get_game_display }} team">
                        <i class="icon-lock"></i> Already in Team
                    </button>
                    {% endif %}
                    
                    {% if request.user.is_authenticated %}
                        {% if is_following %}
                        <button class="btn btn-secondary btn-lg" onclick="unfollowTeam()" id="follow-btn">
                            <i class="icon-check"></i> Following
                        </button>
                        {% else %}
                        <button class="btn btn-outline btn-lg" onclick="followTeam()" id="follow-btn">
                            <i class="icon-heart"></i> Follow
                        </button>
                        {% endif %}
                    {% endif %}
                    
                    <button class="btn btn-outline btn-icon-only" onclick="shareProfile()" title="Share">
                        <i class="icon-share"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Navigation Tabs -->
    <nav class="profile-nav">
        <div class="container">
            <ul class="nav-tabs">
                <li class="nav-item active" data-tab="overview">
                    <i class="icon-home"></i> Overview
                </li>
                <li class="nav-item" data-tab="roster">
                    <i class="icon-users"></i> Roster
                </li>
                <li class="nav-item" data-tab="achievements">
                    <i class="icon-award"></i> Achievements
                </li>
                <li class="nav-item" data-tab="matches">
                    <i class="icon-trophy"></i> Matches
                </li>
                <li class="nav-item" data-tab="media">
                    <i class="icon-image"></i> Media
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container profile-content">
        <div class="content-grid">
            <!-- Main Content Column -->
            <main class="main-content">
                <!-- Overview Tab -->
                <div class="tab-content active" id="tab-overview">
                    <!-- About Section -->
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-info"></i> About</h2>
                        <div class="card-body">
                            {% if team.description %}
                            <p class="team-description">{{ team.description|linebreaks }}</p>
                            {% else %}
                            <p class="text-muted">This team hasn't added a description yet.</p>
                            {% endif %}
                        </div>
                    </section>

                    <!-- Statistics Section -->
                    {% if latest_stats %}
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-bar-chart"></i> Statistics</h2>
                        <div class="card-body">
                            <div class="stats-grid">
                                <div class="stat-box stat-wins">
                                    <div class="stat-icon">
                                        <i class="icon-trophy"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number">{{ latest_stats.wins }}</div>
                                        <div class="stat-label">Wins</div>
                                    </div>
                                </div>
                                
                                <div class="stat-box stat-losses">
                                    <div class="stat-icon">
                                        <i class="icon-x-circle"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number">{{ latest_stats.losses }}</div>
                                        <div class="stat-label">Losses</div>
                                    </div>
                                </div>
                                
                                <div class="stat-box stat-winrate">
                                    <div class="stat-icon">
                                        <i class="icon-percent"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number">{{ latest_stats.win_rate|floatformat:1 }}%</div>
                                        <div class="stat-label">Win Rate</div>
                                    </div>
                                </div>
                                
                                <div class="stat-box stat-streak">
                                    <div class="stat-icon">
                                        <i class="icon-zap"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number">{{ latest_stats.streak|default:0 }}</div>
                                        <div class="stat-label">
                                            {% if latest_stats.streak > 0 %}Win Streak{% elif latest_stats.streak < 0 %}Loss Streak{% else %}No Streak{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    {% endif %}

                    <!-- Recent Posts/Activity -->
                    {% if posts %}
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-file-text"></i> Recent Updates</h2>
                        <div class="card-body">
                            <div class="posts-feed">
                                {% for post in posts %}
                                <article class="post-card">
                                    <div class="post-header">
                                        <div class="post-author">
                                            {% if post.author.avatar %}
                                            <img src="{{ post.author.avatar.url }}" alt="{{ post.author.display_name }}" class="author-avatar">
                                            {% else %}
                                            <div class="author-avatar-placeholder">{{ post.author.display_name|slice:":1"|upper }}</div>
                                            {% endif %}
                                            <div class="author-info">
                                                <div class="author-name">{{ post.author.display_name|default:post.author.user.username }}</div>
                                                <div class="post-time">{{ post.published_at|timesince }} ago</div>
                                            </div>
                                        </div>
                                        <span class="post-type-badge">{{ post.get_post_type_display }}</span>
                                    </div>
                                    
                                    {% if post.title %}
                                    <h3 class="post-title">{{ post.title }}</h3>
                                    {% endif %}
                                    
                                    <div class="post-content">
                                        {{ post.content|truncatewords:50|linebreaks }}
                                    </div>
                                    
                                    {% if post.media.all %}
                                    <div class="post-media-grid">
                                        {% for media in post.media.all|slice:":3" %}
                                        {% if media.media_type == "image" %}
                                        <img src="{{ media.file.url }}" alt="{{ media.alt_text }}" class="post-media-item">
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="post-engagement">
                                        <button class="engagement-btn">
                                            <i class="icon-heart"></i> {{ post.likes_count }}
                                        </button>
                                        <button class="engagement-btn">
                                            <i class="icon-message-circle"></i> {{ post.comments_count }}
                                        </button>
                                        <button class="engagement-btn">
                                            <i class="icon-share-2"></i> {{ post.shares_count }}
                                        </button>
                                    </div>
                                </article>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                    {% endif %}
                </div>

                <!-- Roster Tab -->
                <div class="tab-content" id="tab-roster">
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-users"></i> Team Roster</h2>
                        <div class="card-body">
                            <div class="roster-grid">
                                {% for member in roster %}
                                <div class="player-profile-card {% if member.is_captain %}captain{% endif %}">
                                    {% if member.is_captain %}
                                    <div class="captain-crown">
                                        <i class="icon-crown"></i>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="player-avatar-section">
                                        {% if member.profile.avatar %}
                                        <img src="{{ member.profile.avatar.url }}" alt="{{ member.profile.display_name }}" class="player-avatar">
                                        {% else %}
                                        <div class="player-avatar-placeholder">{{ member.profile.display_name|slice:":1"|upper }}</div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="player-details">
                                        <h3 class="player-name">{{ member.profile.display_name|default:member.profile.user.username }}</h3>
                                        <div class="player-ign">IGN: {{ member.in_game_name|default:"Not set" }}</div>
                                        
                                        <div class="player-role-section">
                                            {% if game_config %}
                                            <span class="role-badge role-{{ member.role|lower }}">
                                                {{ member.get_role_display|default:member.role }}
                                            </span>
                                            {% else %}
                                            <span class="role-badge">
                                                {% if member.is_captain %}Captain{% else %}{{ member.get_role_display|default:"Member" }}{% endif %}
                                            </span>
                                            {% endif %}
                                            
                                            {% if not member.is_starter %}
                                            <span class="status-badge status-sub">Substitute</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="player-meta">
                                            <small><i class="icon-calendar"></i> Joined {{ member.joined_at|date:"M Y" }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <p class="text-muted">No roster members yet.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Achievements Tab -->
                <div class="tab-content" id="tab-achievements">
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-award"></i> Team Achievements</h2>
                        <div class="card-body">
                            {% if achievements_by_year %}
                            <div class="achievements-timeline">
                                {% for year, achs in achievements_by_year.items %}
                                <div class="achievement-year-section">
                                    <h3 class="year-header">{{ year }}</h3>
                                    <div class="achievements-list">
                                        {% for ach in achs %}
                                        <div class="achievement-card placement-{{ ach.placement|lower }}">
                                            <div class="achievement-medal">
                                                {% if ach.placement == "WINNER" %}
                                                <i class="icon-trophy gold"></i>
                                                {% elif ach.placement == "RUNNER_UP" %}
                                                <i class="icon-award silver"></i>
                                                {% elif ach.placement == "TOP4" %}
                                                <i class="icon-medal bronze"></i>
                                                {% else %}
                                                <i class="icon-star participant"></i>
                                                {% endif %}
                                            </div>
                                            <div class="achievement-details">
                                                <h4 class="achievement-title">{{ ach.title }}</h4>
                                                <div class="achievement-placement">{{ ach.get_placement_display }}</div>
                                                {% if ach.notes %}
                                                <p class="achievement-notes">{{ ach.notes }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="empty-state">
                                <i class="icon-award empty-icon"></i>
                                <p>No achievements yet. Check back later!</p>
                            </div>
                            {% endif %}
                        </div>
                    </section>
                </div>

                <!-- Matches Tab -->
                <div class="tab-content" id="tab-matches">
                    <!-- Upcoming Matches -->
                    {% if upcoming_matches %}
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-calendar"></i> Upcoming Matches</h2>
                        <div class="card-body">
                            <div class="matches-list">
                                {% for match in upcoming_matches %}
                                <div class="match-card upcoming">
                                    <div class="match-date-badge">
                                        <div class="date-day">{{ match.start_at|date:"d" }}</div>
                                        <div class="date-month">{{ match.start_at|date:"M" }}</div>
                                    </div>
                                    <div class="match-details">
                                        <div class="match-tournament">{{ match.tournament.name }}</div>
                                        <div class="match-teams-row">
                                            <div class="match-team">
                                                <span class="team-tag">{{ match.team_a.tag }}</span>
                                            </div>
                                            <div class="match-vs">VS</div>
                                            <div class="match-team">
                                                <span class="team-tag">{{ match.team_b.tag }}</span>
                                            </div>
                                        </div>
                                        <div class="match-time">{{ match.start_at|date:"h:i A" }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                    {% endif %}

                    <!-- Recent Matches -->
                    {% if recent_matches %}
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-list"></i> Recent Matches</h2>
                        <div class="card-body">
                            <div class="matches-list">
                                {% for match in recent_matches %}
                                <div class="match-card completed">
                                    <div class="match-result-badge {% if match.winner == team %}win{% else %}loss{% endif %}">
                                        {% if match.winner == team %}W{% else %}L{% endif %}
                                    </div>
                                    <div class="match-details">
                                        <div class="match-tournament">{{ match.tournament.name }}</div>
                                        <div class="match-teams-row">
                                            <div class="match-team">
                                                <span class="team-tag">{{ match.team_a.tag }}</span>
                                                <span class="team-score">{{ match.team_a_score }}</span>
                                            </div>
                                            <div class="match-vs">-</div>
                                            <div class="match-team">
                                                <span class="team-score">{{ match.team_b_score }}</span>
                                                <span class="team-tag">{{ match.team_b.tag }}</span>
                                            </div>
                                        </div>
                                        <div class="match-date">{{ match.start_at|date:"M d, Y" }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </section>
                    {% endif %}
                    
                    {% if not upcoming_matches and not recent_matches %}
                    <section class="profile-card">
                        <div class="empty-state">
                            <i class="icon-calendar empty-icon"></i>
                            <p>No match history available yet.</p>
                        </div>
                    </section>
                    {% endif %}
                </div>

                <!-- Media Tab -->
                <div class="tab-content" id="tab-media">
                    <section class="profile-card">
                        <h2 class="card-title"><i class="icon-image"></i> Team Gallery</h2>
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="icon-image empty-icon"></i>
                                <p>Media gallery coming soon!</p>
                            </div>
                        </div>
                    </section>
                </div>
            </main>

            <!-- Sidebar -->
            <aside class="sidebar-content">
                <!-- Social Links -->
                {% if social_links %}
                <div class="profile-card">
                    <h3 class="card-title"><i class="icon-link"></i> Connect</h3>
                    <div class="card-body">
                        <div class="social-links">
                            {% for link in social_links %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener" class="social-link social-{{ link.icon }}">
                                <i class="icon-{{ link.icon }}"></i>
                                <span>{{ link.name }}</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Activity Stream -->
                {% if activities %}
                <div class="profile-card">
                    <h3 class="card-title"><i class="icon-activity"></i> Recent Activity</h3>
                    <div class="card-body">
                        <div class="activity-stream">
                            {% for activity in activities %}
                            <div class="activity-item-mini">
                                <div class="activity-icon-mini activity-{{ activity.activity_type }}">
                                    {% if activity.activity_type == "member_joined" %}
                                    <i class="icon-user-plus"></i>
                                    {% elif activity.activity_type == "achievement_earned" %}
                                    <i class="icon-award"></i>
                                    {% elif activity.activity_type == "match_completed" %}
                                    <i class="icon-trophy"></i>
                                    {% else %}
                                    <i class="icon-bell"></i>
                                    {% endif %}
                                </div>
                                <div class="activity-text-mini">
                                    <div class="activity-desc">{{ activity.description|truncatewords:10 }}</div>
                                    <div class="activity-time-mini">{{ activity.created_at|timesince }} ago</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Team Info -->
                <div class="profile-card">
                    <h3 class="card-title"><i class="icon-info"></i> Information</h3>
                    <div class="card-body">
                        <div class="info-list">
                            <div class="info-row">
                                <span class="info-label">Game</span>
                                <span class="info-value">{{ team.get_game_display|default:team.game }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Region</span>
                                <span class="info-value">{{ team.region|default:"Not specified" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Founded</span>
                                <span class="info-value">{{ team.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Captain</span>
                                <span class="info-value">
                                    {% if team.captain %}
                                    {{ team.captain.display_name|default:team.captain.user.username }}
                                    {% else %}
                                    —
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'teams/js/team-profile.js' %}"></script>
<script>
    const csrfToken = '{{ csrf_token }}';
    const teamSlug = '{{ team.slug }}';
    const isAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
    const isFollowing = {% if is_following %}true{% else %}false{% endif %};
</script>
{% endblock %}
