{% extends "base_no_footer.html" %}
{% load static %}

{% block title %}Teams — DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/teams-list.css' %}?v=5.0">
<link rel="preload" href="{% static 'siteui/js/teams-list.js' %}" as="script">
{% endblock %}

{% block content %}
<div class="professional-teams-page">
  <!-- Professional Header Section -->
  <div class="teams-header">
    <div class="container">
      <h1 class="teams-title">Team Rankings</h1>
      <p class="teams-subtitle">Professional esports teams ranked by performance and achievements</p>
    </div>
  </div>

  <!-- Mobile Second Navbar (visible only on mobile) -->
  <div class="mobile-second-navbar" id="mobile-navbar">
    <div class="mobile-nav-content">
      <!-- Mobile Search -->
      <div class="mobile-search-wrapper">
        <input type="search" id="mobile-search" name="q" value="{{ query }}"
               placeholder="Search teams..." class="mobile-search-input">
        <button class="mobile-search-btn" type="button">
          <i class="fas fa-search"></i>
        </button>
      </div>
      
      <!-- Mobile Filter Buttons -->
      <div class="mobile-filter-buttons">
        <button class="mobile-filter-btn" data-filter="game">
          <i class="fas fa-gamepad"></i>
          <span>Game</span>
        </button>
        <button class="mobile-filter-btn" data-filter="sort">
          <i class="fas fa-sort"></i>
          <span>Sort</span>
        </button>
        <button class="mobile-filter-btn" data-filter="actions">
          <i class="fas fa-plus"></i>
          <span>Quick</span>
        </button>
        <button class="mobile-filter-btn" id="toggle-sidebar">
          <i class="fas fa-chart-bar"></i>
          <span>Stats</span>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Team Ranking Rules Section -->
    <div class="ranking-rules-section">
      <div class="rules-header">
        <h3>
          <i class="fas fa-info-circle"></i>
          Team Ranking System
        </h3>
        <button class="rules-toggle" id="rules-toggle">
          <i class="fas fa-chevron-down"></i>
        </button>
      </div>
      
      <div class="rules-content" id="rules-content">
        <div class="rules-grid">
          <div class="rule-category">
            <h4><i class="fas fa-trophy"></i> Tournament Performance</h4>
            <div class="rule-items">
              <div class="rule-item">
                <span class="rule-name">Tournament Victory</span>
                <span class="rule-points">{{ ranking_settings.tournament_victory_points }} points</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Runner-up</span>
                <span class="rule-points">{{ ranking_settings.runner_up_points }} points</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Top 4 Finish</span>
                <span class="rule-points">{{ ranking_settings.top4_finish_points }} points</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Top 8 Finish</span>
                <span class="rule-points">{{ ranking_settings.top8_finish_points }} points</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Tournament Participation</span>
                <span class="rule-points">{{ ranking_settings.participation_points }} points</span>
              </div>
            </div>
          </div>
          
          <div class="rule-category">
            <h4><i class="fas fa-users"></i> Team Bonuses</h4>
            <div class="rule-items">
              <div class="rule-item">
                <span class="rule-name">Per Active Member</span>
                <span class="rule-points">{{ ranking_settings.member_bonus_points }} points</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Team Age Bonus</span>
                <span class="rule-points">{{ ranking_settings.age_bonus_points }}/month</span>
              </div>
              <div class="rule-item">
                <span class="rule-name">Multiplier Cap</span>
                <span class="rule-points">{{ ranking_settings.multiplier_cap }}x</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="rules-note">
          <i class="fas fa-lightbulb"></i>
          <p>Rankings are calculated using configurable point values and updated in real-time based on tournament results and team activity.</p>
        </div>
      </div>
    </div>

    <!-- Desktop Search & Filter Control Bar -->
    <div class="search-control-bar desktop-only">
      <form method="get" id="teams-search-form" class="search-form">
        <!-- Search Input -->
        <div class="form-group">
          <label for="q" class="form-label">Search Teams</label>
          <input type="search" id="q" name="q" value="{{ query }}"
            placeholder="Team name or tag..."
            class="search-input">
        </div>

        <!-- Game Filter -->
        <div class="form-group">
          <label for="game" class="form-label">Game</label>
          <select id="game" name="game" class="filter-select">
            <option value="">All Games</option>
            {% for game in games %}
              <option value="{{ game }}" {% if active_game == game %}selected{% endif %}>{{ game }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Sort Options -->
        <div class="form-group">
          <label for="sort" class="form-label">Sort By</label>
          <select name="sort" id="sort" class="filter-select">
            <option value="powerrank" {% if sort == "powerrank" %}selected{% endif %}>Ranking</option>
            <option value="recent" {% if sort == "recent" %}selected{% endif %}>Recent</option>
            <option value="members" {% if sort == "members" %}selected{% endif %}>Members</option>
            <option value="az" {% if sort == "az" %}selected{% endif %}>Name</option>
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="submit" class="action-btn primary">
            <i class="fas fa-filter"></i>
            Filter
          </button>
          <a href="{% url 'teams:create' %}" class="action-btn secondary">
            <i class="fas fa-plus"></i>
            Create Team
          </a>
        </div>
      </form>
    </div>

    <!-- Mobile Filter Overlays -->
    <div class="mobile-filter-overlays">
      <!-- Game Filter Overlay -->
      <div class="mobile-overlay" id="game-overlay">
        <div class="mobile-overlay-content">
          <div class="mobile-overlay-header">
            <h3>Select Game</h3>
            <button class="mobile-overlay-close">&times;</button>
          </div>
          <div class="mobile-overlay-body">
            <div class="mobile-filter-option active" data-value="">All Games</div>
            {% for game in games %}
              <div class="mobile-filter-option {% if active_game == game %}active{% endif %}" data-value="{{ game }}">
                {{ game }}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Sort Filter Overlay -->
      <div class="mobile-overlay" id="sort-overlay">
        <div class="mobile-overlay-content">
          <div class="mobile-overlay-header">
            <h3>Sort Teams By</h3>
            <button class="mobile-overlay-close">&times;</button>
          </div>
          <div class="mobile-overlay-body">
            <div class="mobile-filter-option {% if sort == 'powerrank' %}active{% endif %}" data-value="powerrank">Ranking</div>
            <div class="mobile-filter-option {% if sort == 'recent' %}active{% endif %}" data-value="recent">Recent</div>
            <div class="mobile-filter-option {% if sort == 'members' %}active{% endif %}" data-value="members">Members</div>
            <div class="mobile-filter-option {% if sort == 'az' %}active{% endif %}" data-value="az">Name</div>
          </div>
        </div>
      </div>

      <!-- Actions Overlay -->
      <div class="mobile-overlay" id="actions-overlay">
        <div class="mobile-overlay-content">
          <div class="mobile-overlay-header">
            <h3>Quick Actions</h3>
            <button class="mobile-overlay-close">&times;</button>
          </div>
          <div class="mobile-overlay-body">
            <!-- Primary Actions -->
            <div class="mobile-action-section">
              <div class="mobile-action-section-title">Team Management</div>
              <a href="{% url 'teams:create' %}" class="mobile-action-item primary">
                <i class="fas fa-plus-circle"></i>
                <div class="mobile-action-content">
                  <span class="mobile-action-label">Create New Team</span>
                  <span class="mobile-action-desc">Start building your esports team</span>
                </div>
              </a>
              {% if user.is_authenticated %}
                <a href="#" class="mobile-action-item">
                  <i class="fas fa-users"></i>
                  <div class="mobile-action-content">
                    <span class="mobile-action-label">My Teams</span>
                    <span class="mobile-action-desc">View and manage your teams</span>
                  </div>
                </a>
              {% endif %}
            </div>
            
            <!-- Secondary Actions -->
            <div class="mobile-action-section">
              <div class="mobile-action-section-title">Invitations</div>
              <a href="{% url 'teams:invitations' %}" class="mobile-action-item">
                <i class="fas fa-paper-plane"></i>
                <div class="mobile-action-content">
                  <span class="mobile-action-label">Send Invitations</span>
                  <span class="mobile-action-desc">Invite players to your team</span>
                </div>
              </a>
              <a href="{% url 'teams:my_invites' %}" class="mobile-action-item">
                <i class="fas fa-inbox"></i>
                <div class="mobile-action-content">
                  <span class="mobile-action-label">My Invites</span>
                  <span class="mobile-action-desc">View received invitations</span>
                </div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-content">
      <!-- Main Teams Rankings -->
      <div class="teams-list-container">
        {% if object_list %}
          <div class="teams-rankings">
            <!-- Rankings Header -->
            <div class="ranking-header">
              <div class="rank-col">Rank</div>
              <div class="team-col">Team</div>
              <div class="game-col desktop-only">Game</div>
              <div class="members-col desktop-only">Members</div>
              <div class="points-col desktop-only">Points</div>
              <div class="actions-col">Actions</div>
            </div>
            
            <!-- Team Rankings List -->
            {% for team in object_list %}
              <div class="team-card" data-team-id="{{ team.id }}">
                <!-- Desktop Row Layout -->
                <div class="desktop-team-row desktop-only" onclick="window.location.href='{{ team.get_absolute_url }}'">
                  <div class="rank-number {% if forloop.counter <= 3 %}top-3{% endif %}">
                    {{ forloop.counter }}
                  </div>
                  
                  <div class="team-info-desktop">
                    {% if team.logo %}
                      <img src="{{ team.logo.url }}" alt="{{ team.name }} logo" class="team-logo" loading="lazy">
                    {% else %}
                      <div class="team-logo-placeholder">
                        {{ team.name|first|upper }}
                      </div>
                    {% endif %}
                    <div class="team-details">
                      <div class="team-name">{{ team.name }}</div>
                      {% if team.tag %}
                        <div class="team-tag">[{{ team.tag }}]</div>
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="team-game">
                    {% if team.game %}
                      <div class="game-info">
                        {% if team.game == 'valorant' %}
                          <img src="{% static 'img/game_logos/Valorant_logo.jpg' %}" alt="Valorant" class="game-logo">
                          <span>Valorant</span>
                        {% elif team.game == 'efootball' %}
                          <img src="{% static 'img/game_logos/efootball_logo.jpeg' %}" alt="eFootball" class="game-logo">
                          <span>eFootball</span>
                        {% elif team.game == 'cs2' %}
                          <img src="{% static 'img/game_logos/CS2_logo.jpeg' %}" alt="Counter-Strike 2" class="game-logo">
                          <span>CS2</span>
                        {% elif team.game == 'pubg' %}
                          <img src="{% static 'img/game_logos/PUBG_logo.jpg' %}" alt="PUBG" class="game-logo">
                          <span>PUBG</span>
                        {% elif team.game == 'mlbb' %}
                          <img src="{% static 'img/game_logos/mobile_legend_logo.jpeg' %}" alt="Mobile Legends" class="game-logo">
                          <span>MLBB</span>
                        {% elif team.game == 'fc26' %}
                          <img src="{% static 'img/game_logos/fc26_logo.jpg' %}" alt="EA SPORTS FC 26" class="game-logo">
                          <span>FC 26</span>
                        {% else %}
                          <span>{{ team.game|title }}</span>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="no-game">--</span>
                    {% endif %}
                  </div>
                  
                  <div class="team-members">{{ team.memberships.count }}</div>
                  
                  <div class="team-points">
                    <div class="points-display">
                      <span class="points-value">{{ team.total_points|default:0 }}</span>
                      <span class="points-label">pts</span>
                    </div>
                  </div>
                  
                  <div class="team-actions-desktop" onclick="event.stopPropagation()">
                    <a href="{{ team.get_absolute_url }}" class="btn-view">View</a>
                    {% if team.allow_join_requests %}
                      <a href="{% url 'teams:join' team.id %}" class="btn-apply">Apply</a>
                    {% endif %}
                  </div>
                </div>

                <!-- Mobile Card Layout -->
                <div class="mobile-team-card mobile-only" onclick="window.location.href='{{ team.get_absolute_url }}'">
                  <div class="mobile-card-header">
                    <div class="rank-badge {% if forloop.counter <= 3 %}top-3{% endif %}">
                      #{{ forloop.counter }}
                    </div>
                    
                    <div class="team-badges">
                      {% if team.allow_join_requests %}
                        <span class="team-badge recruiting" title="Recruiting">
                          <i class="fas fa-user-plus"></i>
                        </span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="mobile-card-content">
                    <div class="team-avatar">
                      {% if team.logo %}
                        <img src="{{ team.logo.url }}" alt="{{ team.name }} logo" class="team-logo-mobile" loading="lazy">
                      {% else %}
                        <div class="team-logo-placeholder-mobile">
                          {{ team.name|first|upper }}
                        </div>
                      {% endif %}
                    </div>

                    <div class="team-info-mobile">
                      <div class="team-name-mobile">{{ team.name }}</div>
                      {% if team.tag %}
                        <div class="team-tag-mobile">[{{ team.tag }}]</div>
                      {% endif %}
                      
                      <div class="team-stats-mobile">
                        <div class="stat-item">
                          <i class="fas fa-users"></i>
                          <span>{{ team.memberships.count }} members</span>
                        </div>
                        <div class="stat-item">
                          <i class="fas fa-map-marker-alt"></i>
                          <span>{{ team.region|default:"Global" }}</span>
                        </div>
                        {% if team.achievements_count > 0 %}
                          <div class="stat-item">
                            <i class="fas fa-trophy"></i>
                            <span>{{ team.achievements_count }} achievement{{ team.achievements_count|pluralize }}</span>
                          </div>
                        {% endif %}
                        {% if team.tournament_wins > 0 %}
                          <div class="stat-item tournament-wins">
                            <i class="fas fa-crown"></i>
                            <span>{{ team.tournament_wins }} tournament win{{ team.tournament_wins|pluralize }}</span>
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>

                  <div class="mobile-card-actions">
                    <a href="{{ team.get_absolute_url }}" class="mobile-btn mobile-btn-view">
                      <i class="fas fa-eye"></i>
                      <span>View Team</span>
                    </a>
                    {% if team.allow_join_requests %}
                      <a href="{% url 'teams:join' team.id %}" class="mobile-btn mobile-btn-apply">
                        <i class="fas fa-paper-plane"></i>
                        <span>Apply</span>
                      </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Pagination -->
          {% if paginator.num_pages > 1 %}
            <div class="pagination-container">
              <nav class="pagination">
                {% if page_obj.has_previous %}
                  <a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if active_game %}game={{ active_game }}&{% endif %}sort={{ sort }}&page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-chevron-left"></i>
                    <span class="desktop-only">Previous</span>
                  </a>
                {% endif %}
                <span class="page-stat">{{ page_obj.number }} / {{ paginator.num_pages }}</span>
                {% if page_obj.has_next %}
                  <a class="page-link" href="?{% if query %}q={{ query|urlencode }}&{% endif %}{% if active_game %}game={{ active_game }}&{% endif %}sort={{ sort }}&page={{ page_obj.next_page_number }}">
                    <span class="desktop-only">Next</span>
                    <i class="fas fa-chevron-right"></i>
                  </a>
                {% endif %}
              </nav>
            </div>
          {% endif %}
        {% else %}
          <div class="empty-state">
            <div class="empty-state-icon">
              <i class="fas fa-users"></i>
            </div>
            <h3>No Teams Found</h3>
            <p>No teams match your current filters. Try adjusting your search criteria.</p>
            <a href="{% url 'teams:create' %}" class="action-btn primary">
              <i class="fas fa-plus"></i>
              Create Team
            </a>
          </div>
        {% endif %}
      </div>

      <!-- Professional Sidebar -->
      <div class="teams-sidebar" id="teams-sidebar">
        <!-- Mobile Sidebar Overlay -->
        <div class="sidebar-overlay mobile-only" id="sidebar-overlay"></div>
        
        <div class="sidebar-content">
          <!-- Mobile Sidebar Header -->
          <div class="sidebar-header mobile-only">
            <h3>Team Stats & Filters</h3>
            <button class="sidebar-close" id="sidebar-close">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Quick Actions Card -->
          <div class="sidebar-card desktop-only">
            <h4 class="sidebar-title">
              <i class="fas fa-plus"></i>
              Quick Actions
            </h4>
            <div class="sidebar-links">
              <a href="{% url 'teams:create' %}" class="filter-option">
                <i class="fas fa-plus"></i>
                Create Team
              </a>
              <a href="{% url 'teams:invitations' %}" class="filter-option">
                <i class="fas fa-envelope"></i>
                Invitations
              </a>
              <a href="{% url 'teams:my_invites' %}" class="filter-option">
                <i class="fas fa-inbox"></i>
                My Invites
              </a>
              {% if user.is_authenticated %}
                <a href="#" class="filter-option">
                  <i class="fas fa-users"></i>
                  My Teams
                </a>
              {% endif %}
            </div>
          </div>

          <!-- Team Stats & Filters -->
          <div class="sidebar-card">
            <h4 class="sidebar-title">
              <i class="fas fa-chart-bar"></i>
              Team Stats & Filters
            </h4>
            <div class="sidebar-stats">
              <div class="stat-item">
                <span class="stat-label">Total Teams</span>
                <span class="stat-value">{{ paginator.count|default:"0" }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Active</span>
                <span class="stat-value success">{{ active_teams|default:"0" }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Recruiting</span>
                <span class="stat-value primary">{{ recruiting_teams|default:"0" }}</span>
              </div>
            </div>
          </div>

          <!-- Games Filter Card -->
          <div class="sidebar-card desktop-only">
            <h4 class="sidebar-title">
              <i class="fas fa-gamepad"></i>
              Filter by Game
            </h4>
            <div class="sidebar-links">
              <a href="?" class="filter-option {% if not active_game %}active{% endif %}">
                <i class="fas fa-globe"></i>
                All Games
              </a>
              {% for game in games %}
                <a href="?game={{ game }}" class="filter-option {% if active_game == game %}active{% endif %}">
                  <i class="fas fa-gamepad"></i>
                  {{ game }}
                </a>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile Backdrop for Overlays -->
<div class="mobile-backdrop" id="mobile-backdrop"></div>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'siteui/js/teams-list.js' %}?v=5.0" defer></script>
<script>
// Initialize teams list functionality when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎮 Teams List v2.0 - DOM loaded, initializing...');
    
    // Initialize immediately after DOM is ready
    if (typeof TeamsListManager !== 'undefined') {
        console.log('✅ TeamsListManager found, initializing...');
        window.teamsManager = new TeamsListManager();
    } else {
        console.log('⏳ Waiting for TeamsListManager to load...');
        // Wait for deferred script
        setTimeout(function() {
            if (typeof TeamsListManager !== 'undefined') {
                console.log('✅ TeamsListManager loaded, initializing...');
                window.teamsManager = new TeamsListManager();
            } else {
                console.error('❌ TeamsListManager failed to load!');
                console.error('Check if teams-list.js is accessible at:', document.querySelector('script[src*="teams-list.js"]')?.src);
            }
        }, 200);
    }
});
</script>
{% endblock %}
