{% extends "base.html" %}
{% load static %}

{% block title %}Manage Permissions - {{ member.profile.user.username }} - {{ team.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="flex items-center space-x-4">
        <a href="{% url 'teams:member_list' team.slug %}" 
           class="p-2 hover:bg-gray-700 rounded-lg transition-colors">
            <i class="fas fa-arrow-left text-gray-400"></i>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-white">Manage Permissions</h1>
            <p class="text-gray-400">
                {{ member.profile.user.get_full_name|default:member.profile.user.username }}
                <span class="text-gray-600">â€¢</span>
                {{ member.get_role_display }}
            </p>
        </div>
    </div>

    <!-- Info Banner -->
    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
        <div class="flex items-start space-x-3">
            <i class="fas fa-info-circle text-blue-400 mt-1"></i>
            <div class="text-sm text-gray-300">
                <p class="font-medium text-blue-400 mb-1">Permission System</p>
                <p>Grant specific permissions to allow this member to perform team management tasks. Team owners automatically have all permissions.</p>
            </div>
        </div>
    </div>

    <!-- Permission Form -->
    <form method="POST" class="space-y-6">
        {% csrf_token %}

        {% for category_key, category in permission_categories.items %}
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <!-- Category Header -->
            <div class="bg-gray-900 px-6 py-3 border-b border-gray-700">
                <h3 class="text-white font-semibold">{{ category.label }}</h3>
            </div>

            <!-- Permissions List -->
            <div class="p-6 space-y-4">
                {% for permission in category.permissions %}
                <label class="flex items-center justify-between p-4 bg-gray-750 hover:bg-gray-700 rounded-lg cursor-pointer transition-colors group">
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center h-5">
                            <input type="checkbox" 
                                   name="{{ permission.key }}" 
                                   id="perm_{{ permission.key }}"
                                   {% if permission.enabled %}checked{% endif %}
                                   class="w-5 h-5 text-primary bg-gray-700 border-gray-600 rounded focus:ring-primary focus:ring-2">
                        </div>
                        <div>
                            <span class="text-white font-medium group-hover:text-primary transition-colors">
                                {{ permission.label }}
                            </span>
                            <p class="text-xs text-gray-400 mt-0.5">
                                {{ permission.key }}
                            </p>
                        </div>
                    </div>
                    <div class="permission-status">
                        {% if permission.enabled %}
                        <span class="text-green-400 text-sm">
                            <i class="fas fa-check-circle"></i> Granted
                        </span>
                        {% else %}
                        <span class="text-gray-500 text-sm">
                            <i class="fas fa-times-circle"></i> Not granted
                        </span>
                        {% endif %}
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Action Buttons -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-700">
            <a href="{% url 'teams:member_list' team.slug %}" 
               class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors">
                Cancel
            </a>
            <button type="submit" 
                    class="px-8 py-3 bg-primary hover:bg-secondary text-white rounded-lg font-semibold transition-colors">
                <i class="fas fa-save mr-2"></i>Save Permissions
            </button>
        </div>
    </form>

    <!-- Quick Presets (Optional) -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
        <h3 class="text-white font-semibold mb-4">Quick Permission Presets</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button type="button" onclick="applyPreset('tournament_manager')"
                    class="p-4 bg-gray-750 hover:bg-gray-700 border border-gray-600 rounded-lg transition-colors text-left">
                <div class="text-white font-medium mb-1">Tournament Manager</div>
                <div class="text-xs text-gray-400">Register & manage tournaments</div>
            </button>
            <button type="button" onclick="applyPreset('roster_manager')"
                    class="p-4 bg-gray-750 hover:bg-gray-700 border border-gray-600 rounded-lg transition-colors text-left">
                <div class="text-white font-medium mb-1">Roster Manager</div>
                <div class="text-xs text-gray-400">Invite & manage team members</div>
            </button>
            <button type="button" onclick="applyPreset('content_manager')"
                    class="p-4 bg-gray-750 hover:bg-gray-700 border border-gray-600 rounded-lg transition-colors text-left">
                <div class="text-white font-medium mb-1">Content Manager</div>
                <div class="text-xs text-gray-400">Manage posts & announcements</div>
            </button>
        </div>
    </div>
</div>

<script>
// Permission status update on checkbox change
document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const label = this.closest('label');
        const statusDiv = label.querySelector('.permission-status');
        
        if (this.checked) {
            statusDiv.innerHTML = '<span class="text-green-400 text-sm"><i class="fas fa-check-circle"></i> Granted</span>';
        } else {
            statusDiv.innerHTML = '<span class="text-gray-500 text-sm"><i class="fas fa-times-circle"></i> Not granted</span>';
        }
    });
});

// Permission presets
const presets = {
    tournament_manager: [
        'can_register_tournaments',
        'can_withdraw_tournaments',
        'can_submit_match_results',
        'can_view_financial_reports'
    ],
    roster_manager: [
        'can_invite_members',
        'can_remove_members',
        'can_manage_roles',
        'can_schedule_practice'
    ],
    content_manager: [
        'can_create_posts',
        'can_manage_posts',
        'can_manage_announcements',
        'can_manage_social_links'
    ]
};

function applyPreset(presetName) {
    // Uncheck all first
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
    });
    
    // Check preset permissions
    const permissions = presets[presetName];
    permissions.forEach(perm => {
        const checkbox = document.getElementById(`perm_${perm}`);
        if (checkbox) {
            checkbox.checked = true;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
}
</script>

{% endblock %}
