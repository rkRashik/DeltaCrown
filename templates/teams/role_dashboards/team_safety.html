{% extends "base.html" %}
{% load static %}

{% block title %}Team Safety - {{ team.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center gap-4 mb-4">
      <a href="{% url 'teams:detail' team.slug %}" class="text-cyan-400 hover:text-cyan-300">
        <i class="fas fa-arrow-left"></i> Back to Team
      </a>
    </div>
    <h1 class="text-4xl font-bold flex items-center gap-3">
      <i class="fas fa-shield-alt text-yellow-400"></i>
      Team Settings & Safety
    </h1>
    <p class="text-gray-400 mt-2">{{ team.name }} - Member Settings</p>
  </div>

  <!-- Safety Information -->
  <div class="card glass p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
      <i class="fas fa-info-circle text-cyan-400"></i>
      About Team Safety
    </h2>
    <p class="text-gray-300 mb-4">
      This page provides access to sensitive team membership actions. All critical actions require email verification for your security.
    </p>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 rounded-lg bg-green-500/10 border border-green-500/20">
        <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
        <div class="font-semibold">Email Verification Required</div>
        <div class="text-sm text-gray-400">All actions require OTP verification</div>
      </div>
      <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
        <i class="fas fa-lock text-blue-400 text-2xl mb-2"></i>
        <div class="font-semibold">Secure Process</div>
        <div class="text-sm text-gray-400">10-minute expiration on verification codes</div>
      </div>
    </div>
  </div>

  <!-- Current Membership Status -->
  <div class="card glass p-6 mb-6">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
      <i class="fas fa-id-badge text-purple-400"></i>
      Your Membership
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="p-4 rounded-lg bg-white/5">
        <div class="text-sm text-gray-400">Role</div>
        <div class="text-lg font-semibold">
          {% if membership.role == 'OWNER' %}
            <i class="fas fa-crown text-yellow-400"></i> Owner
          {% elif membership.role == 'MANAGER' %}
            <i class="fas fa-user-tie text-blue-400"></i> Manager
          {% elif membership.role == 'COACH' %}
            <i class="fas fa-chalkboard-teacher text-green-400"></i> Coach
          {% else %}
            <i class="fas fa-user text-purple-400"></i> Player
          {% endif %}
        </div>
      </div>
      <div class="p-4 rounded-lg bg-white/5">
        <div class="text-sm text-gray-400">Joined</div>
        <div class="text-lg font-semibold">{{ membership.joined_at|date:"M d, Y" }}</div>
      </div>
      <div class="p-4 rounded-lg bg-white/5">
        <div class="text-sm text-gray-400">Status</div>
        <div class="text-lg font-semibold">
          <span class="text-green-400">
            <i class="fas fa-check-circle"></i> Active
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card glass p-6 border-2 border-red-500/30">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2 text-red-400">
      <i class="fas fa-exclamation-triangle"></i>
      Danger Zone
    </h2>
    
    {% if is_owner %}
    <!-- Owner Cannot Leave -->
    <div class="p-6 rounded-lg bg-red-500/10 border border-red-500/20">
      <h3 class="text-xl font-bold mb-2 flex items-center gap-2">
        <i class="fas fa-crown text-yellow-400"></i>
        Team Owner
      </h3>
      <p class="text-gray-300 mb-4">
        As the team owner, you cannot leave the team directly. You must first transfer ownership to another team member.
      </p>
      <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-3">
          <i class="fas fa-info-circle text-yellow-400 text-xl mt-1"></i>
          <div>
            <div class="font-semibold text-yellow-300 mb-1">Transfer Ownership First</div>
            <div class="text-sm text-gray-300">
              Go to Team Settings â†’ Transfer Ownership to assign a new owner. After that, you'll be able to leave the team as a regular member.
            </div>
          </div>
        </div>
      </div>
      <a href="{% url 'teams:settings' team.slug %}" class="btn btn-primary">
        <i class="fas fa-cog"></i> Go to Team Settings
      </a>
    </div>
    
    {% elif can_leave_team %}
    <!-- Leave Team Section -->
    <div class="p-6 rounded-lg bg-red-500/10 border border-red-500/20">
      <h3 class="text-xl font-bold mb-2 flex items-center gap-2 text-red-300">
        <i class="fas fa-sign-out-alt"></i>
        Leave Team
      </h3>
      <p class="text-gray-300 mb-4">
        Leaving the team will remove you from all team activities and you'll lose access to team features.
      </p>
      
      <!-- Warning Box -->
      <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-3">
          <i class="fas fa-exclamation-triangle text-yellow-400 text-xl mt-1"></i>
          <div>
            <div class="font-semibold text-yellow-300 mb-1">This action requires verification</div>
            <div class="text-sm text-gray-300">
              You'll receive a verification code via email to confirm this action. The code expires in 10 minutes.
            </div>
          </div>
        </div>
      </div>
      
      <!-- What Happens Section -->
      <div class="mb-4">
        <div class="font-semibold mb-2">What happens when you leave:</div>
        <ul class="list-disc list-inside text-sm text-gray-400 space-y-1">
          <li>You'll be removed from the team roster</li>
          <li>You'll lose access to team chat and discussions</li>
          <li>Your team stats will remain in history</li>
          <li>You can request to rejoin later (subject to approval)</li>
        </ul>
      </div>
      
      <!-- Leave Button -->
      <button 
        id="leaveTeamBtn" 
        class="btn btn-danger w-full mb-4"
        onclick="showOtpModal()"
      >
        <i class="fas fa-sign-out-alt"></i> Leave Team
      </button>
      
      <p class="text-xs text-gray-500 text-center">
        This action is permanent and requires email verification
      </p>
    </div>
    
    {% else %}
    <!-- Cannot Leave (Other Reasons) -->
    <div class="p-6 rounded-lg bg-red-500/10 border border-red-500/20">
      <h3 class="text-xl font-bold mb-2 text-red-300">
        <i class="fas fa-ban"></i> Unable to Leave Team
      </h3>
      <p class="text-gray-300">
        You are currently unable to leave this team. This may be due to:
      </p>
      <ul class="list-disc list-inside text-gray-400 mt-2 space-y-1">
        <li>Active tournament registration</li>
        <li>Roster lock period</li>
        <li>Pending administrative action</li>
      </ul>
      <p class="text-sm text-gray-500 mt-4">
        Contact a team manager for more information.
      </p>
    </div>
    {% endif %}
  </div>
</div>

<!-- OTP Verification Modal -->
<div id="otpModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50" style="display: none;">
  <div class="card glass p-8 max-w-md w-full mx-4">
    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2">
      <i class="fas fa-shield-alt text-yellow-400"></i>
      Verify Your Action
    </h3>
    
    <div id="otpStep1">
      <p class="text-gray-300 mb-4">
        We'll send a 6-digit verification code to your email address:
      </p>
      <div class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/20 mb-4">
        <i class="fas fa-envelope text-cyan-400"></i>
        <span class="ml-2 font-mono">{{ user.email }}</span>
      </div>
      <p class="text-sm text-gray-400 mb-6">
        The code will expire in 10 minutes.
      </p>
      
      <button onclick="requestOTP()" class="btn btn-primary w-full mb-3" id="requestOtpBtn">
        <i class="fas fa-paper-plane"></i> Send Verification Code
      </button>
      <button onclick="closeOtpModal()" class="btn btn-secondary w-full">
        Cancel
      </button>
    </div>
    
    <div id="otpStep2" style="display: none;">
      <p class="text-gray-300 mb-4">
        Enter the 6-digit code sent to <span class="font-mono text-cyan-400">{{ user.email }}</span>
      </p>
      
      <div class="mb-4">
        <input 
          type="text" 
          id="otpCodeInput" 
          maxlength="6" 
          placeholder="000000"
          class="w-full px-4 py-3 text-2xl font-mono text-center rounded-lg bg-white/5 border border-white/10 focus:border-cyan-400 focus:outline-none"
          autocomplete="off"
        />
      </div>
      
      <div id="otpError" class="hidden mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-300 text-sm"></div>
      
      <button onclick="confirmLeave()" class="btn btn-danger w-full mb-3" id="confirmLeaveBtn">
        <i class="fas fa-check"></i> Confirm & Leave Team
      </button>
      
      <button onclick="requestOTP()" class="btn btn-secondary w-full mb-3" id="resendOtpBtn">
        <i class="fas fa-redo"></i> Resend Code
      </button>
      
      <button onclick="closeOtpModal()" class="btn btn-secondary w-full">
        Cancel
      </button>
      
      <p class="text-xs text-gray-500 text-center mt-4">
        Code expires in <span id="otpTimer">10:00</span>
      </p>
    </div>
  </div>
</div>

<script>
let otpTimerInterval = null;

function showOtpModal() {
  document.getElementById('otpModal').style.display = 'flex';
  document.getElementById('otpStep1').style.display = 'block';
  document.getElementById('otpStep2').style.display = 'none';
  document.getElementById('otpError').classList.add('hidden');
}

function closeOtpModal() {
  document.getElementById('otpModal').style.display = 'none';
  if (otpTimerInterval) {
    clearInterval(otpTimerInterval);
  }
}

async function requestOTP() {
  const btn = document.getElementById('requestOtpBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
  
  try {
    const response = await fetch('{% url "teams:leave_request_otp" team.slug %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Show step 2
      document.getElementById('otpStep1').style.display = 'none';
      document.getElementById('otpStep2').style.display = 'block';
      
      // Start timer
      startOtpTimer(data.expires_minutes || 10);
      
      // Focus on input
      document.getElementById('otpCodeInput').focus();
    } else {
      alert(data.message || 'Failed to send verification code');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Verification Code';
    }
  } catch (error) {
    alert('An error occurred. Please try again.');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Verification Code';
  }
}

async function confirmLeave() {
  const code = document.getElementById('otpCodeInput').value.trim();
  const errorDiv = document.getElementById('otpError');
  const btn = document.getElementById('confirmLeaveBtn');
  
  if (!code || code.length !== 6) {
    errorDiv.textContent = 'Please enter a valid 6-digit code';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
  errorDiv.classList.add('hidden');
  
  try {
    const response = await fetch('{% url "teams:leave_confirm_otp" team.slug %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ code: code })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Show success message
      alert(data.message || 'You have successfully left the team.');
      // Redirect
      window.location.href = data.redirect_url || '/teams/';
    } else {
      // Show error
      errorDiv.textContent = data.message || 'Invalid or expired code';
      errorDiv.classList.remove('hidden');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-check"></i> Confirm & Leave Team';
      
      // Clear input if locked
      if (data.locked) {
        setTimeout(() => {
          closeOtpModal();
          alert('Too many failed attempts. Please request a new verification code.');
        }, 2000);
      }
    }
  } catch (error) {
    errorDiv.textContent = 'An error occurred. Please try again.';
    errorDiv.classList.remove('hidden');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check"></i> Confirm & Leave Team';
  }
}

function startOtpTimer(minutes) {
  let totalSeconds = minutes * 60;
  const timerElement = document.getElementById('otpTimer');
  
  if (otpTimerInterval) {
    clearInterval(otpTimerInterval);
  }
  
  otpTimerInterval = setInterval(() => {
    totalSeconds--;
    
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    
    timerElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    
    if (totalSeconds <= 0) {
      clearInterval(otpTimerInterval);
      timerElement.textContent = 'Expired';
      timerElement.classList.add('text-red-400');
    }
  }, 1000);
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeOtpModal();
  }
});

// Auto-format OTP input
document.getElementById('otpCodeInput').addEventListener('input', (e) => {
  e.target.value = e.target.value.replace(/[^0-9]/g, '').substring(0, 6);
});
</script>

<style>
.card.glass {
  background: rgba(15, 23, 42, 0.7);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
}

#otpModal {
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>
{% endblock %}
