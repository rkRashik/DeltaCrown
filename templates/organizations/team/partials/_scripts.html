{# SCRIPTS — Page JS (no demo controller) #}
{# Rebuilt from Demo_Team_detail_templete.html — production-ready #}

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ── BOOTSTRAP: Read data attributes & apply to body ───────────────────
  const bootstrap = document.getElementById("dc-detail-bootstrap");
  if (bootstrap) {
    const role  = bootstrap.dataset.role  || "PUBLIC";
    const theme = bootstrap.dataset.theme || "CROWN";
    const game  = bootstrap.dataset.game  || "unknown";

    document.body.setAttribute("data-role",  role);
    document.body.setAttribute("data-theme", theme);
    document.body.setAttribute("data-game",  game);

    // Game type for conditional visibility (FPS, MOBA, BR, SPORTS, etc.)
    const gameType = (bootstrap.dataset.gameType || "FPS").toUpperCase();
    document.body.setAttribute("data-game-type", gameType);

    // Custom colors override theme
    if (bootstrap.dataset.customColors === "true") {
      document.body.setAttribute("data-custom-colors", "true");
    }
  }

  // ── ROLE-BASED BUTTON VISIBILITY ──────────────────────────────────────
  const currentRole = document.body.getAttribute("data-role") || "PUBLIC";
  document.querySelectorAll("[data-role-show]").forEach(el => {
    el.style.display = "none";
  });

  // Map viewer roles to visible UI roles
  const roleVisMap = {
    "PUBLIC":  ["PUBLIC"],
    "MEMBER":  ["MEMBER", "TEAM"],
    "PLAYER":  ["MEMBER", "TEAM"],
    "COACH":   ["STAFF", "TEAM"],
    "MANAGER": ["STAFF", "TEAM"],
    "OWNER":   ["OWNER", "STAFF", "TEAM"],
  };

  const visibleRoles = roleVisMap[currentRole] || ["PUBLIC"];
  visibleRoles.forEach(r => {
    document.querySelectorAll(`[data-role-show="${r}"]`).forEach(el => {
      el.style.display = "flex";
    });
  });

  // ── (Subnav removed — single-scroll page) ─────────────────────────────

  // ── MATCH FILTER TABS ─────────────────────────────────────────────────
  document.querySelectorAll(".dc-match-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".dc-match-filter").forEach(b => {
        b.classList.remove("bg-white/10", "text-white");
        b.classList.add("text-slate-500");
      });
      btn.classList.remove("text-slate-500");
      btn.classList.add("bg-white/10", "text-white");
    });
  });

  // ── MATCH HISTORY FILTER TABS ─────────────────────────────────────────
  document.querySelectorAll(".dc-history-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".dc-history-filter").forEach(b => {
        b.classList.remove("bg-white/10", "text-white");
        b.classList.add("text-slate-500", "hover:bg-white/5");
      });
      btn.classList.remove("text-slate-500", "hover:bg-white/5");
      btn.classList.add("bg-white/10", "text-white");

      const filter = btn.dataset.filter || "all";
      const section = document.getElementById("match-history");
      if (!section) return;
      section.querySelectorAll("[data-match-type]").forEach(card => {
        if (filter === "all") {
          card.style.display = "";
        } else {
          card.style.display = card.dataset.matchType === filter ? "" : "none";
        }
      });
    });
  });

  // ── COUNTDOWN TIMERS ──────────────────────────────────────────────────
  document.querySelectorAll(".dc-countdown").forEach(el => {
    const expires = el.dataset.expires;
    if (!expires) return;
    const target = new Date(expires).getTime();
    function tick() {
      const diff = target - Date.now();
      if (diff <= 0) { el.textContent = "Expired"; return; }
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      el.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      requestAnimationFrame(tick);
    }
    tick();
  });

  // ── ROSTER TOGGLE (Starting Lineup / Full Squad) ──────────────────────
  const rosterToggle = document.getElementById("dc-roster-toggle");
  if (rosterToggle) {
    rosterToggle.addEventListener("click", () => {
      const benchPlayers = document.querySelectorAll(".dc-bench-player");
      const benchLabel = document.getElementById("dc-bench-label");
      const isHidden = benchPlayers[0]?.classList.contains("hidden");

      benchPlayers.forEach(p => p.classList.toggle("hidden"));
      if (benchLabel) benchLabel.classList.toggle("hidden");

      rosterToggle.textContent = isHidden ? "Show Starting Lineup" : "View Full Squad";
    });
  }

  // ── SET REMINDER BUTTON ───────────────────────────────────────────────
  document.querySelectorAll(".dc-set-reminder").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.disabled = true;
      btn.textContent = "REMINDER SET ✓";
      btn.classList.remove("bg-white", "text-black");
      btn.classList.add("bg-white/10", "text-slate-400");
    });
  });

  // ── LAZY LOADING FOR IMAGES ───────────────────────────────────────────
  const lazyImages = document.querySelectorAll(".lazy-media");
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.classList.add("loaded");
        observer.unobserve(img);
      }
    });
  }, { rootMargin: "50px" });

  lazyImages.forEach(img => {
    img.classList.remove("loaded");
    imageObserver.observe(img);
  });

  // ── SCROLL ANIMATIONS ────────────────────────────────────────────────
  const animatedElements = document.querySelectorAll("section");
  const scrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = "0";
        entry.target.style.transform = "translateY(20px)";
        requestAnimationFrame(() => {
          entry.target.style.transition = "opacity 0.6s ease, transform 0.6s ease";
          entry.target.style.opacity = "1";
          entry.target.style.transform = "translateY(0)";
        });
        scrollObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  animatedElements.forEach(el => scrollObserver.observe(el));

  // ── SMART SIDEBAR POSITIONING ─────────────────────────────────────────
  function adjustSidebarPosition() {
    const mainContent = document.querySelector(".lg\\:col-span-8");
    const sidebar = document.querySelector(".lg\\:col-span-4");
    if (!mainContent || !sidebar || window.innerWidth < 1024) return;

    const mainHeight = mainContent.offsetHeight;
    const sidebarHeight = sidebar.offsetHeight;

    if (sidebarHeight < mainHeight) {
      sidebar.style.position = "sticky";
      sidebar.style.top = "80px";
      sidebar.style.alignSelf = "start";
    }
  }
  adjustSidebarPosition();
  window.addEventListener("resize", adjustSidebarPosition);

  // ── APPLY BUTTON (Join Request) ───────────────────────────────────────
  document.querySelectorAll(".dc-apply-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const slug = btn.dataset.teamSlug;
      if (!slug) return;
      btn.disabled = true;
      btn.textContent = "SENDING…";

      try {
        const resp = await fetch(`/api/teams/${slug}/apply/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
        });
        const data = await resp.json();
        if (resp.ok) {
          btn.textContent = "APPLICATION SENT";
          btn.classList.remove("bg-white", "text-black");
          btn.classList.add("bg-white/10", "text-slate-400");
        } else {
          btn.textContent = data.detail || "Error";
          setTimeout(() => { btn.textContent = "APPLY FOR TRYOUTS"; btn.disabled = false; }, 3000);
        }
      } catch {
        btn.textContent = "NETWORK ERROR";
        setTimeout(() => { btn.textContent = "APPLY FOR TRYOUTS"; btn.disabled = false; }, 3000);
      }
    });
  });

  // ── INVITE ACCEPT / DECLINE ───────────────────────────────────────────
  document.querySelectorAll(".dc-invite-accept").forEach(btn => {
    btn.addEventListener("click", async () => {
      const inviteId = btn.dataset.inviteId;
      if (!inviteId) return;
      btn.disabled = true;
      btn.textContent = "ACCEPTING…";

      try {
        const resp = await fetch(`/api/teams/invites/${inviteId}/accept/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken"), "Content-Type": "application/json" },
        });
        if (resp.ok) {
          window.location.reload();
        } else {
          btn.textContent = "Error";
        }
      } catch {
        btn.textContent = "Error";
      }
    });
  });

  document.querySelectorAll(".dc-invite-decline").forEach(btn => {
    btn.addEventListener("click", async () => {
      const inviteId = btn.dataset.inviteId;
      if (!inviteId) return;
      btn.disabled = true;
      btn.textContent = "DECLINING…";

      try {
        const resp = await fetch(`/api/teams/invites/${inviteId}/decline/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken"), "Content-Type": "application/json" },
        });
        if (resp.ok) {
          window.location.reload();
        } else {
          btn.textContent = "Error";
        }
      } catch {
        btn.textContent = "Error";
      }
    });
  });

  // ── CSRF COOKIE HELPER ────────────────────────────────────────────────
  function getCookie(name) {
    const cookies = document.cookie.split(";");
    for (const c of cookies) {
      const [k, v] = c.trim().split("=");
      if (k === name) return decodeURIComponent(v);
    }
    return "";
  }

  // ── MENU DROPDOWN TOGGLE ──────────────────────────────────────────────
  const menuToggle = document.getElementById("dc-menu-toggle");
  const menuDropdown = document.getElementById("dc-menu-dropdown");
  if (menuToggle && menuDropdown) {
    menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle("hidden");
    });
    document.addEventListener("click", (e) => {
      if (!menuDropdown.contains(e.target) && e.target !== menuToggle) {
        menuDropdown.classList.add("hidden");
      }
    });
  }

  // ── CHALLENGE HUB — Issue Challenge + Accept ──────────────────────────
  document.querySelectorAll(".dc-issue-challenge").forEach(btn => {
    btn.addEventListener("click", () => {
      const slug = btn.dataset.teamSlug;
      if (slug) {
        window.location.href = `/competition/challenges/?team=${slug}`;
      }
    });
  });

  document.querySelectorAll(".dc-challenge-accept").forEach(btn => {
    btn.addEventListener("click", async () => {
      const challengeId = btn.dataset.challengeId;
      if (!challengeId) return;

      btn.disabled = true;
      btn.textContent = "ACCEPTING…";

      try {
        const resp = await fetch(`/api/v1/challenges/${challengeId}/accept/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
          body: JSON.stringify({}),
        });
        const data = await resp.json();
        if (resp.ok) {
          btn.textContent = "ACCEPTED ✓";
          btn.classList.remove("bg-red-600", "hover:bg-red-500");
          btn.classList.add("bg-emerald-600/50", "text-emerald-300");
          setTimeout(() => window.location.reload(), 1500);
        } else {
          btn.textContent = data.detail || "Error";
          setTimeout(() => { btn.textContent = "ACCEPT"; btn.disabled = false; }, 3000);
        }
      } catch {
        btn.textContent = "NETWORK ERROR";
        setTimeout(() => { btn.textContent = "ACCEPT"; btn.disabled = false; }, 3000);
      }
    });
  });

  document.querySelectorAll(".dc-challenge-info").forEach(btn => {
    btn.addEventListener("click", () => {
      const challengeId = btn.dataset.challengeId;
      if (challengeId) {
        window.open(`/api/v1/challenges/${challengeId}/`, "_blank");
      }
    });
  });

  // ── MEDIA LIGHTBOX ────────────────────────────────────────────────────
  document.querySelectorAll(".dc-media-item").forEach(item => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      const type = item.dataset.mediaType || "image";
      const url = item.dataset.mediaUrl;
      const title = item.dataset.mediaTitle || "";
      if (!url) return;
      dcOpenLightbox(type, url, title);
    });
  });

});

// ── Global Media Lightbox Functions ─────────────────────────────────────
function dcOpenLightbox(type, url, title) {
  const lb = document.getElementById("dc-media-lightbox");
  const content = document.getElementById("dc-lightbox-content");
  const titleEl = document.getElementById("dc-lightbox-title");
  if (!lb || !content) return;

  titleEl.textContent = title;
  content.innerHTML = "";

  if (type === "video") {
    // Check if it's a YouTube/Vimeo URL
    const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/);
    const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);

    if (ytMatch) {
      content.innerHTML = `<iframe src="https://www.youtube.com/embed/${ytMatch[1]}?autoplay=1&rel=0" 
        class="w-full max-w-4xl aspect-video rounded-2xl shadow-2xl" 
        frameborder="0" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>`;
    } else if (vimeoMatch) {
      content.innerHTML = `<iframe src="https://player.vimeo.com/video/${vimeoMatch[1]}?autoplay=1" 
        class="w-full max-w-4xl aspect-video rounded-2xl shadow-2xl" 
        frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    } else {
      // Direct video file
      content.innerHTML = `<video src="${url}" controls autoplay 
        class="w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl bg-black" 
        controlslist="nodownload"></video>`;
    }
  } else {
    // Image
    content.innerHTML = `<img src="${url}" alt="${title}" 
      class="max-w-full max-h-[85vh] rounded-2xl shadow-2xl object-contain select-none"
      style="cursor:zoom-out" onclick="dcCloseLightbox()">`;
  }

  lb.classList.remove("hidden");
  lb.classList.add("flex");
  // Animate in
  requestAnimationFrame(() => lb.style.opacity = "1");
  document.body.style.overflow = "hidden";
}

function dcCloseLightbox() {
  const lb = document.getElementById("dc-media-lightbox");
  if (!lb) return;
  // Stop any playing media
  lb.querySelectorAll("video, iframe").forEach(el => el.remove());
  lb.classList.add("hidden");
  lb.classList.remove("flex");
  document.body.style.overflow = "";
}

// Close lightbox on Escape
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    dcCloseLightbox();
    dcClosePlayerPopup();
  }
});

// ── Player Profile Popup Functions ──────────────────────────────────────
function dcOpenPlayerPopup(cardEl) {
  const popup = document.getElementById("dc-player-popup");
  const card = document.getElementById("dc-player-popup-card");
  if (!popup || !card) return;

  // Read data from card
  const name = cardEl.dataset.playerName || "Player";
  const username = cardEl.dataset.playerUsername || "";
  const avatar = cardEl.dataset.playerAvatar || "";
  const role = cardEl.dataset.playerRole || "";
  const country = cardEl.dataset.playerCountry || "";
  const isCaptain = cardEl.dataset.playerCaptain === "1";
  const ign = cardEl.dataset.playerIgn || "";
  const rank = cardEl.dataset.playerRank || "";
  const profileUrl = cardEl.dataset.playerProfileUrl || "";

  // Populate
  document.getElementById("pp-display-name").textContent = name;
  document.getElementById("pp-username").textContent = "@" + username;
  document.getElementById("pp-role-tag").textContent = role;

  const avatarEl = document.getElementById("pp-avatar");
  if (avatar) { avatarEl.src = avatar; avatarEl.style.display = ""; }
  else { avatarEl.style.display = "none"; }

  const flagEl = document.getElementById("pp-flag");
  if (country) {
    flagEl.src = `https://flagcdn.com/${country.toLowerCase()}.svg`;
    flagEl.classList.remove("hidden");
  } else { flagEl.classList.add("hidden"); }

  const badge = document.getElementById("pp-badge");
  if (isCaptain) {
    badge.textContent = "⭐ Captain";
    badge.className = "absolute top-3 left-3 px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider bg-amber-500/20 border border-amber-500/30 text-amber-400";
  } else { badge.classList.add("hidden"); }

  const passport = document.getElementById("pp-passport");
  if (ign || rank) {
    passport.classList.remove("hidden");
    document.getElementById("pp-ign").textContent = ign || "—";
    document.getElementById("pp-rank").textContent = rank || "—";
  } else { passport.classList.add("hidden"); }

  const profileLink = document.getElementById("pp-profile-link");
  if (profileUrl) {
    profileLink.href = profileUrl;
    profileLink.style.display = "";
  } else if (username) {
    profileLink.href = `/profile/${username}/`;
    profileLink.style.display = "";
  } else {
    profileLink.style.display = "none";
  }

  // Show with animation
  popup.classList.remove("hidden");
  popup.classList.add("flex");
  document.body.style.overflow = "hidden";
  requestAnimationFrame(() => {
    card.classList.remove("scale-95", "opacity-0");
    card.classList.add("scale-100", "opacity-100");
  });
}

function dcClosePlayerPopup() {
  const popup = document.getElementById("dc-player-popup");
  const card = document.getElementById("dc-player-popup-card");
  if (!popup) return;
  card.classList.remove("scale-100", "opacity-100");
  card.classList.add("scale-95", "opacity-0");
  setTimeout(() => {
    popup.classList.add("hidden");
    popup.classList.remove("flex");
    document.body.style.overflow = "";
  }, 200);
}
</script>
