{# SCRIPTS — Page JS (no demo controller) #}
{# Rebuilt from Demo_Team_detail_templete.html — production-ready #}

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ── BOOTSTRAP: Read data attributes & apply to body ───────────────────
  const bootstrap = document.getElementById("dc-detail-bootstrap");
  if (bootstrap) {
    const role  = bootstrap.dataset.role  || "PUBLIC";
    const theme = bootstrap.dataset.theme || "CROWN";
    const game  = bootstrap.dataset.game  || "unknown";

    document.body.setAttribute("data-role",  role);
    document.body.setAttribute("data-theme", theme);
    document.body.setAttribute("data-game",  game);

    // Game type for conditional visibility (FPS, MOBA, BR, SPORTS, etc.)
    const gameType = (bootstrap.dataset.gameType || "FPS").toUpperCase();
    document.body.setAttribute("data-game-type", gameType);

    // Custom colors override theme
    if (bootstrap.dataset.customColors === "true") {
      document.body.setAttribute("data-custom-colors", "true");
    }
  }

  // ── ROLE-BASED BUTTON VISIBILITY ──────────────────────────────────────
  const currentRole = document.body.getAttribute("data-role") || "PUBLIC";
  document.querySelectorAll("[data-role-show]").forEach(el => {
    el.style.display = "none";
  });

  // Map viewer roles to visible UI roles
  const roleVisMap = {
    "PUBLIC":  ["PUBLIC"],
    "MEMBER":  ["MEMBER", "TEAM"],
    "PLAYER":  ["MEMBER", "TEAM"],
    "COACH":   ["STAFF", "TEAM"],
    "MANAGER": ["STAFF", "TEAM"],
    "OWNER":   ["OWNER", "STAFF", "TEAM"],
  };

  const visibleRoles = roleVisMap[currentRole] || ["PUBLIC"];
  visibleRoles.forEach(r => {
    document.querySelectorAll(`[data-role-show="${r}"]`).forEach(el => {
      el.style.display = "flex";
    });
  });

  // ── (Subnav removed — single-scroll page) ─────────────────────────────

  // ── MATCH FILTER TABS ─────────────────────────────────────────────────
  document.querySelectorAll(".dc-match-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".dc-match-filter").forEach(b => {
        b.classList.remove("bg-white/10", "text-white");
        b.classList.add("text-slate-500");
      });
      btn.classList.remove("text-slate-500");
      btn.classList.add("bg-white/10", "text-white");
    });
  });

  // ── MATCH HISTORY FILTER TABS ─────────────────────────────────────────
  document.querySelectorAll(".dc-history-filter").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".dc-history-filter").forEach(b => {
        b.classList.remove("bg-white/10", "text-white");
        b.classList.add("text-slate-500", "hover:bg-white/5");
      });
      btn.classList.remove("text-slate-500", "hover:bg-white/5");
      btn.classList.add("bg-white/10", "text-white");

      const filter = btn.dataset.filter || "all";
      const section = document.getElementById("match-history");
      if (!section) return;
      section.querySelectorAll("[data-match-type]").forEach(card => {
        if (filter === "all") {
          card.style.display = "";
        } else {
          card.style.display = card.dataset.matchType === filter ? "" : "none";
        }
      });
    });
  });

  // ── COUNTDOWN TIMERS ──────────────────────────────────────────────────
  document.querySelectorAll(".dc-countdown").forEach(el => {
    const expires = el.dataset.expires;
    if (!expires) return;
    const target = new Date(expires).getTime();
    function tick() {
      const diff = target - Date.now();
      if (diff <= 0) { el.textContent = "Expired"; return; }
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      el.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
      requestAnimationFrame(tick);
    }
    tick();
  });

  // ── ROSTER TOGGLE (Starting Lineup / Full Squad) ──────────────────────
  const rosterToggle = document.getElementById("dc-roster-toggle");
  if (rosterToggle) {
    rosterToggle.addEventListener("click", () => {
      const benchPlayers = document.querySelectorAll(".dc-bench-player");
      const benchLabel = document.getElementById("dc-bench-label");
      const isHidden = benchPlayers[0]?.classList.contains("hidden");

      benchPlayers.forEach(p => p.classList.toggle("hidden"));
      if (benchLabel) benchLabel.classList.toggle("hidden");

      rosterToggle.textContent = isHidden ? "Show Starting Lineup" : "View Full Squad";
    });
  }

  // ── SET REMINDER BUTTON ───────────────────────────────────────────────
  document.querySelectorAll(".dc-set-reminder").forEach(btn => {
    btn.addEventListener("click", () => {
      btn.disabled = true;
      btn.textContent = "REMINDER SET ✓";
      btn.classList.remove("bg-white", "text-black");
      btn.classList.add("bg-white/10", "text-slate-400");
    });
  });

  // ── LAZY LOADING FOR IMAGES ───────────────────────────────────────────
  const lazyImages = document.querySelectorAll(".lazy-media");
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.classList.add("loaded");
        observer.unobserve(img);
      }
    });
  }, { rootMargin: "50px" });

  lazyImages.forEach(img => {
    img.classList.remove("loaded");
    imageObserver.observe(img);
  });

  // ── SCROLL ANIMATIONS ────────────────────────────────────────────────
  const animatedElements = document.querySelectorAll("section");
  const scrollObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = "0";
        entry.target.style.transform = "translateY(20px)";
        requestAnimationFrame(() => {
          entry.target.style.transition = "opacity 0.6s ease, transform 0.6s ease";
          entry.target.style.opacity = "1";
          entry.target.style.transform = "translateY(0)";
        });
        scrollObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });

  animatedElements.forEach(el => scrollObserver.observe(el));

  // ── SMART SIDEBAR POSITIONING ─────────────────────────────────────────
  function adjustSidebarPosition() {
    const mainContent = document.querySelector(".lg\\:col-span-8");
    const sidebar = document.querySelector(".lg\\:col-span-4");
    if (!mainContent || !sidebar || window.innerWidth < 1024) return;

    const mainHeight = mainContent.offsetHeight;
    const sidebarHeight = sidebar.offsetHeight;

    if (sidebarHeight < mainHeight) {
      sidebar.style.position = "sticky";
      sidebar.style.top = "80px";
      sidebar.style.alignSelf = "start";
    }
  }
  adjustSidebarPosition();
  window.addEventListener("resize", adjustSidebarPosition);

  // ── APPLY BUTTON (Join Request) ───────────────────────────────────────
  document.querySelectorAll(".dc-apply-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const slug = btn.dataset.teamSlug;
      if (!slug) return;
      btn.disabled = true;
      btn.textContent = "SENDING…";

      try {
        const resp = await fetch(`/api/teams/${slug}/apply/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
        });
        const data = await resp.json();
        if (resp.ok) {
          btn.textContent = "APPLICATION SENT";
          btn.classList.remove("bg-white", "text-black");
          btn.classList.add("bg-white/10", "text-slate-400");
        } else {
          btn.textContent = data.detail || "Error";
          setTimeout(() => { btn.textContent = "APPLY FOR TRYOUTS"; btn.disabled = false; }, 3000);
        }
      } catch {
        btn.textContent = "NETWORK ERROR";
        setTimeout(() => { btn.textContent = "APPLY FOR TRYOUTS"; btn.disabled = false; }, 3000);
      }
    });
  });

  // ── INVITE ACCEPT / DECLINE ───────────────────────────────────────────
  document.querySelectorAll(".dc-invite-accept").forEach(btn => {
    btn.addEventListener("click", async () => {
      const inviteId = btn.dataset.inviteId;
      if (!inviteId) return;
      btn.disabled = true;
      btn.textContent = "ACCEPTING…";

      try {
        const resp = await fetch(`/api/teams/invites/${inviteId}/accept/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken"), "Content-Type": "application/json" },
        });
        if (resp.ok) {
          window.location.reload();
        } else {
          btn.textContent = "Error";
        }
      } catch {
        btn.textContent = "Error";
      }
    });
  });

  document.querySelectorAll(".dc-invite-decline").forEach(btn => {
    btn.addEventListener("click", async () => {
      const inviteId = btn.dataset.inviteId;
      if (!inviteId) return;
      btn.disabled = true;
      btn.textContent = "DECLINING…";

      try {
        const resp = await fetch(`/api/teams/invites/${inviteId}/decline/`, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken"), "Content-Type": "application/json" },
        });
        if (resp.ok) {
          window.location.reload();
        } else {
          btn.textContent = "Error";
        }
      } catch {
        btn.textContent = "Error";
      }
    });
  });

  // ── CSRF COOKIE HELPER ────────────────────────────────────────────────
  function getCookie(name) {
    const cookies = document.cookie.split(";");
    for (const c of cookies) {
      const [k, v] = c.trim().split("=");
      if (k === name) return decodeURIComponent(v);
    }
    return "";
  }

  // ── MENU DROPDOWN TOGGLE ──────────────────────────────────────────────
  const menuToggle = document.getElementById("dc-menu-toggle");
  const menuDropdown = document.getElementById("dc-menu-dropdown");
  if (menuToggle && menuDropdown) {
    menuToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      menuDropdown.classList.toggle("hidden");
    });
    document.addEventListener("click", (e) => {
      if (!menuDropdown.contains(e.target) && e.target !== menuToggle) {
        menuDropdown.classList.add("hidden");
      }
    });
  }

});
</script>
