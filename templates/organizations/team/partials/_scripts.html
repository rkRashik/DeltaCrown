    <script>
    /**
     * Team Detail Page — Client-Side Controller
     * Phase 3 Production Build
     *
     * Modules:
     *   1. Body Data-Attribute Injection (role, theme, game)
     *   2. Sticky Nav Glass Effect
     *   3. Scrollspy (IntersectionObserver)
     *   4. Match Filter Tabs
     *   5. Lazy Image Loading
     *   6. Scroll-In Animations
     *   7. Sticky Sidebar Positioning
     */
    document.addEventListener("DOMContentLoaded", () => {

      // ─── 1. BODY DATA-ATTRIBUTES ───────────────────────────
      // Inject role/theme/game from Django context via data-bootstrap
      const bootstrapEl = document.getElementById("dc-detail-bootstrap");
      if (bootstrapEl) {
        const { role, theme, game, customColors } = bootstrapEl.dataset;
        if (role)  document.body.setAttribute("data-role", role);
        if (theme) document.body.setAttribute("data-theme", theme);
        if (game)  document.body.setAttribute("data-game", game);
        if (customColors === "true") document.body.setAttribute("data-custom-colors", "true");
      }

      // ─── 2. STICKY NAV GLASS ──────────────────────────────
      const nav = document.getElementById("dc-subnav");
      if (nav) {
        let lastScroll = 0;
        window.addEventListener("scroll", () => {
          const scrollY = window.scrollY;
          if (scrollY > 400) {
            nav.classList.add("bg-[#000]/90", "backdrop-blur-xl", "shadow-2xl");
            nav.classList.remove("bg-[#000]/80", "backdrop-blur-md");
          } else {
            nav.classList.remove("bg-[#000]/90", "backdrop-blur-xl", "shadow-2xl");
            nav.classList.add("bg-[#000]/80", "backdrop-blur-md");
          }
          lastScroll = scrollY;
        }, { passive: true });
      }

      // ─── 3. SCROLLSPY ─────────────────────────────────────
      const sections = document.querySelectorAll("section[id]");
      const navLinks = document.querySelectorAll("#dc-subnav .nav-link");

      if (sections.length && navLinks.length) {
        const observerOptions = {
          root: null,
          rootMargin: "-20% 0px -60% 0px",
          threshold: 0
        };

        const scrollspyObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const sectionId = entry.target.getAttribute("id");
              navLinks.forEach(link => {
                const linkTarget = link.getAttribute("data-nav");
                const underline = link.querySelector(".nav-underline");

                if (linkTarget === sectionId) {
                  link.classList.add("text-[var(--team-primary)]");
                  link.classList.remove("text-slate-500");
                  if (underline) underline.style.display = "block";
                  // Also create dynamic underline if not exists
                  if (!underline) {
                    const span = document.createElement("span");
                    span.className = "nav-underline absolute bottom-0 left-0 w-full h-0.5 bg-[var(--team-primary)] shadow-[0_0_10px_var(--team-primary)]";
                    link.appendChild(span);
                  }
                } else {
                  link.classList.remove("text-[var(--team-primary)]");
                  link.classList.add("text-slate-500");
                  if (underline) underline.style.display = "none";
                }
              });
            }
          });
        }, observerOptions);

        sections.forEach(section => scrollspyObserver.observe(section));

        // Smooth scroll on nav click
        navLinks.forEach(link => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const targetId = link.getAttribute("href")?.replace("#", "");
            const target = targetId && document.getElementById(targetId);
            if (target) {
              const offset = nav ? nav.offsetHeight + 20 : 80;
              const top = target.getBoundingClientRect().top + window.scrollY - offset;
              window.scrollTo({ top, behavior: "smooth" });
            }
          });
        });
      }

      // ─── 4. MATCH FILTER TABS ─────────────────────────────
      const filterBtns = document.querySelectorAll(".match-filter-btn");
      filterBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          filterBtns.forEach(b => {
            b.classList.remove("bg-white/10", "text-white");
            b.classList.add("text-slate-500", "hover:bg-white/5");
          });
          btn.classList.remove("text-slate-500", "hover:bg-white/5");
          btn.classList.add("bg-white/10", "text-white");
          // Future: filter match cards by btn.dataset.filter
        });
      });

      // ─── 5. LAZY IMAGE LOADING ────────────────────────────
      const lazyImages = document.querySelectorAll(".lazy-media");
      if (lazyImages.length) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add("loaded");
              observer.unobserve(entry.target);
            }
          });
        }, { rootMargin: "100px" });

        lazyImages.forEach(img => {
          img.classList.remove("loaded");
          imageObserver.observe(img);
        });
      }

      // ─── 6. SCROLL-IN ANIMATIONS ─────────────────────────
      const animatedSections = document.querySelectorAll("section.transition-smooth");
      if (animatedSections.length) {
        const scrollAnimObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = "0";
              entry.target.style.transform = "translateY(20px)";
              requestAnimationFrame(() => {
                entry.target.style.transition = "opacity 0.6s ease, transform 0.6s ease";
                entry.target.style.opacity = "1";
                entry.target.style.transform = "translateY(0)";
              });
              scrollAnimObserver.unobserve(entry.target);
            }
          });
        }, { threshold: 0.08 });

        animatedSections.forEach(el => scrollAnimObserver.observe(el));
      }

      // ─── 7. STICKY SIDEBAR ────────────────────────────────
      function adjustSidebar() {
        const mainCol = document.getElementById("dc-main-col");
        const sidebar = document.getElementById("dc-sidebar");
        if (!mainCol || !sidebar || window.innerWidth < 1024) {
          if (sidebar) {
            sidebar.style.position = "";
            sidebar.style.top = "";
            sidebar.style.alignSelf = "";
          }
          return;
        }
        const mainH = mainCol.offsetHeight;
        const sideH = sidebar.offsetHeight;
        if (sideH < mainH) {
          sidebar.style.position = "sticky";
          sidebar.style.top = "80px";
          sidebar.style.alignSelf = "start";
        } else {
          sidebar.style.position = "";
          sidebar.style.top = "";
          sidebar.style.alignSelf = "";
        }
      }
      adjustSidebar();
      window.addEventListener("resize", adjustSidebar, { passive: true });

    });

    // ═══════════════════════════════════════════════════════════
    // 8. INVITE ACCEPT / DECLINE
    // ═══════════════════════════════════════════════════════════
    {% if pending_actions.has_pending_invite and pending_actions.pending_invite_id %}
    function dcInviteAction(action) {
      const inviteId = {{ pending_actions.pending_invite_id }};
      const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")?.value
                     || document.cookie.match(/csrftoken=([^;]+)/)?.[1] || "";

      // Disable all invite buttons across both CTA and sidebar
      document.querySelectorAll("#dc-invite-actions button, #dc-sidebar-invite-actions button").forEach(b => {
        b.disabled = true;
        b.style.opacity = "0.5";
      });

      // Try the notifications API first (used by bell/dashboard), fallback to vNext API
      const urls = [
        `/notifications/api/team-invite/${inviteId}/${action}/`,
        `/api/vnext/teams/invites/membership/${inviteId}/${action}/`
      ];

      (async function tryInvite(urlIdx) {
        if (urlIdx >= urls.length) {
          showInviteMsg("error", "Something went wrong. Please reload and try again.");
          return;
        }
        try {
          const resp = await fetch(urls[urlIdx], {
            method: "POST",
            headers: {
              "X-CSRFToken": csrfToken,
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
            credentials: "same-origin"
          });
          if (resp.ok || resp.status === 200 || resp.status === 204) {
            const isAccept = action === "accept";
            showInviteMsg(
              isAccept ? "success" : "info",
              isAccept ? "Welcome to the team! Reloading..." : "Invite declined."
            );
            if (isAccept) {
              setTimeout(() => window.location.reload(), 1200);
            } else {
              setTimeout(() => {
                // Hide invite UI elements
                const dd = document.getElementById("dc-invite-dropdown");
                const wrap = document.getElementById("dc-invite-cta-wrap");
                const sidebar = document.getElementById("dc-sidebar-invite");
                if (dd) dd.classList.add("hidden");
                if (wrap) wrap.style.display = "none";
                if (sidebar) sidebar.style.display = "none";
              }, 1500);
            }
          } else if (resp.status === 404 || resp.status === 405) {
            // This API endpoint doesn't exist, try next
            tryInvite(urlIdx + 1);
          } else {
            const data = await resp.json().catch(() => ({}));
            showInviteMsg("error", data.detail || data.error || `Failed (${resp.status})`);
          }
        } catch (err) {
          tryInvite(urlIdx + 1);
        }
      })(0);
    }

    function showInviteMsg(type, text) {
      const colors = { success: "text-emerald-400", error: "text-red-400", info: "text-slate-300" };
      // Update both CTA dropdown and sidebar messages
      ["dc-invite-msg", "dc-sidebar-invite-msg"].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.className = `mt-2 text-center text-xs font-bold ${colors[type] || "text-white"}`;
          el.textContent = text;
        }
      });
    }
    {% endif %}

    // ═══════════════════════════════════════════════════════════
    // 9. PLAYER POPUP
    // ═══════════════════════════════════════════════════════════
    function dcShowPlayerPopup(cardEl) {
      const popup = document.getElementById("dc-player-popup");
      if (!popup) return;

      // Extract data from card
      const d = cardEl.dataset;
      document.getElementById("pp-avatar").src = d.avatar || "";
      document.getElementById("pp-avatar").alt = d.display || "";
      document.getElementById("pp-name").textContent = d.display || d.username || "";
      document.getElementById("pp-username").textContent = d.username || "";
      document.getElementById("pp-role-chip").textContent = d.role || "PLAYER";
      document.getElementById("pp-profile-link").href = d.profileUrl || "#";

      // Player role (game-specific)
      const prEl = document.getElementById("pp-player-role");
      if (d.playerRole) {
        prEl.textContent = d.playerRole;
        prEl.style.display = "";
      } else {
        prEl.style.display = "none";
      }

      // Captain chip
      const captainChip = document.getElementById("pp-captain-chip");
      if (d.captain === "true") {
        captainChip.classList.remove("hidden");
      } else {
        captainChip.classList.add("hidden");
      }

      // Show popup
      popup.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function dcClosePlayerPopup() {
      const popup = document.getElementById("dc-player-popup");
      if (popup) {
        popup.classList.add("hidden");
        document.body.style.overflow = "";
      }
    }

    // Close popup on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        dcClosePlayerPopup();
        // Also close invite dropdown
        const dd = document.getElementById("dc-invite-dropdown");
        if (dd) dd.classList.add("hidden");
      }
    });

    // Close invite dropdown when clicking outside
    document.addEventListener("click", (e) => {
      const wrap = document.getElementById("dc-invite-cta-wrap");
      const dd = document.getElementById("dc-invite-dropdown");
      if (wrap && dd && !wrap.contains(e.target)) {
        dd.classList.add("hidden");
      }
    });
    </script>
