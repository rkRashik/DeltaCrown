<!-- Journey 3 — Team Manage HQ API Wiring -->
<script>
    // ========================================
    // JOURNEY 3 — Team Manage HQ API Wiring
    // ========================================

    const hqBootstrapEl = document.getElementById('hqBootstrap');

    function parseTeamSlugFromPath(pathname) {
        // Supports:
        // - /teams/<team_slug>/manage/
        // - /orgs/<org_slug>/teams/<team_slug>/manage/
        if (!pathname) return null;
        const parts = pathname.split('/').filter(Boolean);
        const teamsIndex = parts.indexOf('teams');
        if (teamsIndex === -1) return null;
        return parts[teamsIndex + 1] || null;
    }

    const teamSlug = hqBootstrapEl?.dataset?.teamSlug || parseTeamSlugFromPath(window.location.pathname);

    let teamData = null;
    let membersData = [];
    let userPermissions = {};
    let gameRoles = [];      // In-game roles from GameRole model (per-game)
    let roleChoices = [];    // MembershipRole choices from backend
    let slotChoices = [];    // RosterSlot choices from backend

    const globalMessageEl = document.getElementById('hqGlobalMessage');
    const rosterMessageEl = document.getElementById('hqRosterMessage');
    const rosterSummaryEl = document.getElementById('hqRosterSummary');
    const membersGridEl = document.getElementById('hqMembersGrid');
    const inviteBtnEl = document.getElementById('hqInviteBtn');
    const addMemberCardEl = document.getElementById('hqAddMemberCard');

    const teamNameEl = document.getElementById('hqTeamName');
    const gameChipEl = document.getElementById('gameChip');

    const editSettingsBtnEl = document.getElementById('hqEditSettingsBtn');

    function setBanner(el, message, kind = 'info') {
        if (!el) return;
        if (!message) {
            el.classList.add('hidden');
            el.textContent = '';
            return;
        }

        const palette = {
            info: 'border-blue-500/20 bg-blue-500/5 text-blue-200',
            success: 'border-green-500/20 bg-green-500/5 text-green-200',
            error: 'border-red-500/20 bg-red-500/5 text-red-200',
            warn: 'border-yellow-500/20 bg-yellow-500/5 text-yellow-200',
        };

        el.className = el.className
            .replace(/border-(blue|green|red|yellow)-500\/20\s+bg-(blue|green|red|yellow)-500\/5\s+text-(blue|green|red|yellow)-200/g, '')
            .trim();

        el.classList.remove('hidden');
        el.classList.add('rounded-2xl', 'border', ...palette[kind].split(' '));
        el.textContent = message;
    }

    function roleLabel(role) {
        const map = {
            PLAYER: 'Player',
            COACH: 'Coach',
            MANAGER: 'Manager',
            SUBSTITUTE: 'Substitute',
            ANALYST: 'Analyst',
            SCOUT: 'Scout',
            OWNER: 'Owner',
        };
        return map[role] || role || 'Member';
    }

    function rolePillClass(role) {
        const palette = {
            OWNER:      'border-yellow-500/30 bg-yellow-500/10 text-yellow-400',
            MANAGER:    'border-orange-500/30 bg-orange-500/10 text-orange-400',
            COACH:      'border-blue-500/30 bg-blue-500/10 text-blue-400',
            PLAYER:     'border-green-500/30 bg-green-500/10 text-green-400',
            SUBSTITUTE: 'border-teal-500/30 bg-teal-500/10 text-teal-400',
            ANALYST:    'border-purple-500/30 bg-purple-500/10 text-purple-400',
            SCOUT:      'border-cyan-500/30 bg-cyan-500/10 text-cyan-400',
        };
        return palette[role] || 'border-white/20 bg-white/5 text-white/60';
    }

    function escapeHtml(str) {
        return String(str ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function renderMemberCard(member) {
        const username = escapeHtml(member.username || 'Unknown');
        const displayName = escapeHtml(member.display_name || member.username || 'Unknown');
        const email = escapeHtml(member.email || '');
        const role = member.role || 'PLAYER';
        const playerRole = escapeHtml(member.player_role || '');
        const letter = escapeHtml((member.username || 'U')[0]?.toUpperCase() || 'U');
        const isCaptain = member.is_tournament_captain;
        const avatarUrl = member.avatar_url;

        const canManage = !!userPermissions?.can_manage;
        const actionsButton = canManage
            ? `
                <button type="button" class="text-muted hover:text-white transition" data-member-action="menu" data-membership-id="${member.id}">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                </button>
            `
            : '';

        // Avatar: show roster_image or profile avatar, fallback to letter
        const avatarInner = avatarUrl
            ? `<img src="${escapeHtml(avatarUrl)}" class="h-full w-full rounded-xl object-cover" alt="${username}" />`
            : `<div class="h-full w-full rounded-xl grid place-items-center text-lg font-bold">${letter}</div>`;

        // Captain badge
        const captainBadge = isCaptain
            ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full border border-yellow-500/30 bg-yellow-500/10 text-yellow-400 font-bold" title="Tournament Captain">C</span>`
            : '';

        // Player role pill
        const playerRolePill = playerRole
            ? `<span class="text-[10px] px-1.5 py-0.5 rounded-full border border-white/15 bg-white/5 text-white/60">${playerRole}</span>`
            : '';

        return `
            <div class="rounded-2xl border border-white/15 bg-gradient-to-br from-white/10 to-white/[0.02] backdrop-blur-sm p-4 relative group hover:border-white/25 transition-all">
                <div class="absolute top-2 right-2 flex items-center gap-1">
                    <span class="h-2 w-2 rounded-full bg-green-500"></span>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <div class="h-12 w-12 rounded-xl border-2 overflow-hidden flex-shrink-0" style="border-color: var(--team-primary); background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));">
                        ${avatarInner}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm truncate">${displayName}</div>
                        <div class="text-xs text-muted truncate">${username !== displayName ? '@' + username : email}</div>
                    </div>
                </div>
                <div class="flex items-center gap-1.5 flex-wrap mb-3">
                    <span class="text-xs px-2 py-1 rounded-full border ${rolePillClass(role)} font-medium">${escapeHtml(roleLabel(role))}</span>
                    ${captainBadge}
                    ${playerRolePill}
                </div>
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-1 text-green-400">
                        <i data-lucide="check-circle-2" class="w-3 h-3"></i>
                        <span>Active</span>
                    </div>
                    ${actionsButton}
                </div>
            </div>
        `;
    }

    function updateRosterSummary() {
        if (!rosterSummaryEl) return;
        const total = Array.isArray(membersData) ? membersData.length : 0;
        const counts = {};
        for (const m of membersData || []) {
            if (m?.role) counts[m.role] = (counts[m.role] || 0) + 1;
        }
        const parts = [`${total} Members`];
        for (const [r, c] of Object.entries(counts)) {
            parts.push(`${c} ${roleLabel(r)}${c > 1 ? 's' : ''}`);
        }
        rosterSummaryEl.textContent = parts.join(' • ');
    }

    function updateMembersList() {
        if (!membersGridEl) return;
        if (!Array.isArray(membersData)) {
            membersGridEl.innerHTML = '';
            return;
        }

        membersGridEl.innerHTML = membersData.map(renderMemberCard).join('');

        // Re-render lucide icons in injected markup
        try {
            lucide?.createIcons?.();
        } catch (_) { }
    }

    function updateTeamHeader() {
        if (!teamData) return;

        if (teamNameEl) {
            teamNameEl.textContent = teamData.name || 'Team HQ';
        }

        // We only have game_id from this endpoint; keep existing chip if unknown.
        if (gameChipEl && teamData.game_id) {
            const chipText = gameChipEl.querySelector('#gameChipText') || gameChipEl;
            chipText.textContent = `Game ${teamData.game_id}`;
        }
    }

    function applyPermissionsToTemplate() {
        const canManage = !!userPermissions?.can_manage;
        const isCreator = !!userPermissions?.is_creator;

        // Map real permissions to role hierarchy for UI gating
        // OWNER gates should only open for creator; MANAGER for any manager
        let effectiveRole = 'MEMBER';
        if (canManage) effectiveRole = 'MANAGER';
        if (isCreator) effectiveRole = 'OWNER';

        // Override the demo role gating to match real permission state
        try {
            if (typeof window.applyRole === 'function') {
                window.applyRole(effectiveRole);
            } else if (typeof applyRole === 'function') {
                applyRole(effectiveRole);
            }
        } catch (err) {
            console.error('applyRole failed:', err);
        }
    }

    async function apiGetTeamDetail() {
        const response = await fetch(`/api/vnext/teams/${teamSlug}/detail/`, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            const msg = payload?.error || `Failed to load team detail (${response.status})`;
            throw new Error(msg);
        }
        return payload;
    }

    async function bootstrapTeamData() {
        if (!teamSlug) {
            setBanner(globalMessageEl, 'Team slug not found in URL. Manage wiring disabled.', 'error');
            return;
        }

        setBanner(globalMessageEl, null);
        setBanner(rosterMessageEl, null);

        try {
            const data = await apiGetTeamDetail();
            teamData = data.team || null;
            membersData = Array.isArray(data.members) ? data.members : [];
            userPermissions = data.permissions || {};
            gameRoles = Array.isArray(data.game_roles) ? data.game_roles : [];
            roleChoices = data.choices?.membership_roles || [];
            slotChoices = data.choices?.roster_slots || [];

            applyPermissionsToTemplate();
            updateTeamHeader();
            updateRosterSummary();
            updateMembersList();
        } catch (error) {
            console.error('Failed to load team data:', error);
            setBanner(globalMessageEl, error?.message || 'Failed to load team data', 'error');
        }
    }

    async function addTeamMember(identifier, role = 'PLAYER') {
        if (!userPermissions?.can_manage) {
            throw new Error('You do not have permission to manage this team');
        }

        const formData = new FormData();
        formData.append('identifier', identifier);
        formData.append('role', role);

        const response = await fetch(`/api/vnext/teams/${teamSlug}/members/add/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload?.error || 'Failed to add member');
        }

        await bootstrapTeamData();
        return payload;
    }

    async function changeTeamMemberRole(membershipId, newRole, extras = {}) {
        if (!userPermissions?.can_manage) {
            throw new Error('You do not have permission to manage this team');
        }

        const formData = new FormData();
        formData.append('role', newRole);
        // Optional roster fields
        if ('player_role' in extras) formData.append('player_role', extras.player_role);
        if ('roster_slot' in extras) formData.append('roster_slot', extras.roster_slot);
        if ('display_name' in extras) formData.append('display_name', extras.display_name);
        if ('is_tournament_captain' in extras) formData.append('is_tournament_captain', extras.is_tournament_captain ? 'true' : 'false');

        const response = await fetch(`/api/vnext/teams/${teamSlug}/members/${membershipId}/role/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload?.error || 'Failed to change role');
        }

        await bootstrapTeamData();
        return payload;
    }

    async function removeTeamMember(membershipId) {
        const response = await fetch(`/api/vnext/teams/${teamSlug}/members/${membershipId}/remove/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload?.error || 'Failed to remove member');
        }

        await bootstrapTeamData();
        return payload;
    }

    async function uploadRosterPhoto(membershipId, file) {
        const formData = new FormData();
        formData.append('roster_image', file);

        const response = await fetch(`/api/vnext/teams/${teamSlug}/members/${membershipId}/roster-photo/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload?.error || 'Failed to upload roster photo');
        }

        await bootstrapTeamData();
        return payload;
    }

    async function updateTeamSettings(settings) {
        if (!userPermissions?.can_manage) {
            throw new Error('You do not have permission to manage this team');
        }

        const formData = new FormData();
        for (const [key, value] of Object.entries(settings || {})) {
            formData.append(key, value);
        }

        const response = await fetch(`/api/vnext/teams/${teamSlug}/settings/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
            credentials: 'same-origin',
        });

        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
            throw new Error(payload?.error || 'Failed to update settings');
        }

        return payload;
    }

    function openModalWithAsyncConfirm({ title, subtitle, bodyHtml, confirmText, onConfirm }) {
        if (typeof MODAL?.open !== 'function') {
            console.warn('MODAL framework not available');
            return;
        }

        MODAL.open({
            title,
            subtitle,
            body: bodyHtml,
            confirmText: confirmText || 'Confirm',
        });

        // Ensure lucide icons render inside modal body
        try { lucide?.createIcons?.(); } catch (_) { }

        const modalConfirmBtn = document.getElementById('modalConfirm');
        const modalErrorEl = document.getElementById('hqModalError');

        if (modalConfirmBtn) {
            modalConfirmBtn.onclick = async () => {
                setBanner(modalErrorEl, null);
                modalConfirmBtn.disabled = true;
                const originalText = modalConfirmBtn.textContent;
                modalConfirmBtn.textContent = 'Working…';

                try {
                    await onConfirm?.();
                    MODAL.close();
                } catch (err) {
                    setBanner(modalErrorEl, err?.message || 'Action failed', 'error');
                } finally {
                    modalConfirmBtn.disabled = false;
                    modalConfirmBtn.textContent = originalText;
                }
            };
        }
    }

    function showAddMemberModal() {
        if (!userPermissions?.can_manage) {
            setBanner(rosterMessageEl, 'You do not have permission to manage this team.', 'error');
            return;
        }

        openModalWithAsyncConfirm({
            title: 'Add Member',
            subtitle: 'Add an existing user by email or username',
            confirmText: 'Add',
            bodyHtml: `
                <div class="space-y-4">
                    <div id="hqModalError" class="hidden rounded-xl border border-line bg-white/5 p-3 text-sm"></div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Email or Username</label>
                        <input type="text" id="hqAddMemberIdentifier" placeholder="player@example.com or username"
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" />
                    </div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Role</label>
                        <select id="hqAddMemberRole" class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition">
                            ${(roleChoices.length ? roleChoices : [
                                {value:'PLAYER',label:'Player'},{value:'COACH',label:'Coach'},
                                {value:'MANAGER',label:'Manager'},{value:'SUBSTITUTE',label:'Substitute'},
                                {value:'ANALYST',label:'Analyst'},{value:'SCOUT',label:'Scout'}
                            ]).map(c => `<option value="${c.value}">${escapeHtml(c.label)}</option>`).join('')}
                        </select>
                        <p class="text-xs text-muted mt-2">OWNER is not assignable in vNext.</p>
                    </div>
                </div>
            `,
            onConfirm: async () => {
                const identifier = document.getElementById('hqAddMemberIdentifier')?.value?.trim();
                const role = document.getElementById('hqAddMemberRole')?.value || 'PLAYER';
                if (!identifier) throw new Error('Please enter an email or username');

                await addTeamMember(identifier, role);
                setBanner(rosterMessageEl, `Added ${identifier} as ${roleLabel(role)}.`, 'success');
            },
        });
    }

    function showMemberActionsModal(membershipId) {
        const member = (membersData || []).find(m => String(m.id) === String(membershipId));
        if (!member) return;

        // Build role options from backend choices
        const roleOptions = (roleChoices.length ? roleChoices : [
            {value:'PLAYER',label:'Player'},{value:'COACH',label:'Coach'},
            {value:'MANAGER',label:'Manager'},{value:'SUBSTITUTE',label:'Substitute'},
            {value:'ANALYST',label:'Analyst'},{value:'SCOUT',label:'Scout'}
        ]).map(c => `<option value="${c.value}" ${member.role === c.value ? 'selected' : ''}>${escapeHtml(c.label)}</option>`).join('');

        // Build in-game role options from GameRole model
        const gameRoleOptions = gameRoles.length
            ? `<option value="">— None —</option>` + gameRoles.map(gr =>
                `<option value="${escapeHtml(gr.role_name)}" ${member.player_role === gr.role_name ? 'selected' : ''}>${escapeHtml(gr.icon ? gr.icon + ' ' : '')}${escapeHtml(gr.role_name)}</option>`
              ).join('')
            : '';

        // Build roster slot options
        const slotOptions = (slotChoices.length ? slotChoices : [
            {value:'STARTER',label:'Starter'},{value:'SUBSTITUTE',label:'Substitute'},
            {value:'COACH',label:'Coach (Non-playing)'},{value:'ANALYST',label:'Analyst (Non-playing)'}
        ]).map(c => `<option value="${c.value}" ${member.roster_slot === c.value ? 'selected' : ''}>${escapeHtml(c.label)}</option>`).join('');

        // Avatar preview
        const avatarSrc = member.avatar_url || '';
        const avatarLetter = escapeHtml((member.username || 'U')[0]?.toUpperCase() || 'U');
        const avatarPreview = avatarSrc
            ? `<img src="${escapeHtml(avatarSrc)}" class="h-16 w-16 rounded-xl object-cover border-2 border-white/15" />`
            : `<div class="h-16 w-16 rounded-xl border-2 border-white/15 grid place-items-center text-xl font-bold bg-white/5">${avatarLetter}</div>`;

        openModalWithAsyncConfirm({
            title: `Manage: ${member.username}`,
            subtitle: 'Edit roster details, role, or remove from team',
            confirmText: 'Save Changes',
            bodyHtml: `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
                    <div id="hqModalError" class="hidden rounded-xl border border-line bg-white/5 p-3 text-sm"></div>

                    <!-- Member identity card -->
                    <div class="rounded-2xl border border-line bg-white/5 p-3 flex items-center gap-3">
                        <div id="hqMemberAvatarPreview">${avatarPreview}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-semibold">${escapeHtml(member.display_name || member.username)}</div>
                            <div class="text-xs text-muted">${escapeHtml(member.email || '@' + member.username)}</div>
                        </div>
                    </div>

                    <!-- Roster Photo Upload -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">Roster Photo</label>
                        <div class="flex items-center gap-3">
                            <label class="cursor-pointer rounded-xl border border-dashed border-white/20 bg-white/5 hover:bg-white/10 transition px-4 py-2 text-sm text-muted">
                                <i data-lucide="upload" class="w-4 h-4 inline-block mr-1"></i> Upload Photo
                                <input type="file" id="hqRosterPhotoInput" accept="image/jpeg,image/png,image/webp" class="hidden" />
                            </label>
                            <span id="hqRosterPhotoName" class="text-xs text-muted"></span>
                        </div>
                        <p class="text-xs text-muted mt-1">Max 5 MB. JPEG, PNG, or WebP.</p>
                    </div>

                    <!-- Display Name -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">Roster Display Name</label>
                        <input type="text" id="hqMemberDisplayName" value="${escapeHtml(member.display_name || '')}" placeholder="Custom name for this team..."
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" maxlength="80" />
                        <p class="text-xs text-muted mt-1">Leave blank to use profile display name.</p>
                    </div>

                    <!-- Organizational Role -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">Organizational Role</label>
                        <select id="hqMemberNewRole" class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition">
                            ${roleOptions}
                        </select>
                    </div>

                    <!-- Roster Slot -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">Roster Slot</label>
                        <select id="hqMemberRosterSlot" class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition">
                            <option value="">— Unassigned —</option>
                            ${slotOptions}
                        </select>
                    </div>

                    ${gameRoleOptions ? `
                    <!-- In-Game Role (from game app) -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">In-Game Role</label>
                        <select id="hqMemberPlayerRole" class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition">
                            ${gameRoleOptions}
                        </select>
                        <p class="text-xs text-muted mt-1">Game-specific tactical role (e.g., Duelist, IGL).</p>
                    </div>
                    ` : `
                    <!-- In-Game Role (free text fallback when no game roles configured) -->
                    <div>
                        <label class="text-sm font-semibold block mb-2">In-Game Role</label>
                        <input type="text" id="hqMemberPlayerRole" value="${escapeHtml(member.player_role || '')}" placeholder="e.g., Duelist, IGL, AWPer..."
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" maxlength="50" />
                    </div>
                    `}

                    <!-- Tournament Captain -->
                    <div class="flex items-center gap-3 rounded-2xl border border-line bg-white/5 p-3">
                        <input type="checkbox" id="hqMemberCaptain" ${member.is_tournament_captain ? 'checked' : ''}
                            class="h-4 w-4 rounded border-white/30 bg-white/5 accent-yellow-500" />
                        <div>
                            <div class="text-sm font-semibold">Tournament Captain</div>
                            <div class="text-xs text-muted">Can check-in for tournaments and act as primary contact.</div>
                        </div>
                    </div>

                    <!-- Danger Zone: Remove -->
                    <div class="rounded-2xl border border-red-500/30 bg-red-500/10 p-3">
                        <div class="text-sm font-semibold text-red-300">Remove member</div>
                        <p class="text-xs text-red-200/70 mt-1">This will deactivate their membership.</p>
                        <button type="button" id="hqRemoveMemberBtn" class="mt-3 w-full rounded-xl border border-red-500/30 bg-red-500/10 hover:bg-red-500/20 transition px-4 py-2 text-sm font-semibold">Remove</button>
                    </div>
                </div>
            `,
            onConfirm: async () => {
                const newRole = document.getElementById('hqMemberNewRole')?.value;
                const playerRole = document.getElementById('hqMemberPlayerRole')?.value?.trim() ?? '';
                const rosterSlot = document.getElementById('hqMemberRosterSlot')?.value ?? '';
                const displayName = document.getElementById('hqMemberDisplayName')?.value?.trim() ?? '';
                const isCaptain = document.getElementById('hqMemberCaptain')?.checked ?? false;
                const photoFile = document.getElementById('hqRosterPhotoInput')?.files?.[0];

                if (!newRole) throw new Error('Select a role');

                // Upload roster photo first if selected
                if (photoFile) {
                    await uploadRosterPhoto(member.id, photoFile);
                }

                // Check if anything changed
                const hasChanges = (
                    newRole !== member.role ||
                    playerRole !== (member.player_role || '') ||
                    rosterSlot !== (member.roster_slot || '') ||
                    displayName !== (member.display_name || '') ||
                    isCaptain !== member.is_tournament_captain
                );

                if (hasChanges) {
                    await changeTeamMemberRole(member.id, newRole, {
                        player_role: playerRole,
                        roster_slot: rosterSlot,
                        display_name: displayName,
                        is_tournament_captain: isCaptain,
                    });
                    setBanner(rosterMessageEl, `Updated ${member.username} roster details.`, 'success');
                } else if (!photoFile) {
                    setBanner(rosterMessageEl, 'No changes made.', 'info');
                } else {
                    setBanner(rosterMessageEl, `Updated roster photo for ${member.username}.`, 'success');
                }
            },
        });

        // Wire remove button and photo preview (after modal renders)
        setTimeout(() => {
            // Remove button
            const removeBtn = document.getElementById('hqRemoveMemberBtn');
            removeBtn?.addEventListener('click', async () => {
                try {
                    await removeTeamMember(member.id);
                    MODAL.close();
                    setBanner(rosterMessageEl, `Removed ${member.username} from team.`, 'success');
                } catch (err) {
                    const modalErrorEl = document.getElementById('hqModalError');
                    setBanner(modalErrorEl, err?.message || 'Failed to remove member', 'error');
                }
            });

            // Photo preview on file select
            const photoInput = document.getElementById('hqRosterPhotoInput');
            const photoName = document.getElementById('hqRosterPhotoName');
            const avatarPreviewEl = document.getElementById('hqMemberAvatarPreview');
            photoInput?.addEventListener('change', () => {
                const file = photoInput.files?.[0];
                if (file) {
                    if (photoName) photoName.textContent = file.name;
                    if (avatarPreviewEl) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            avatarPreviewEl.innerHTML = `<img src="${e.target.result}" class="h-16 w-16 rounded-xl object-cover border-2 border-white/15" />`;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });
        }, 0);
    }

    function showSettingsModal(prefill = {}) {
        if (!userPermissions?.can_manage) {
            setBanner(globalMessageEl, 'You do not have permission to manage this team.', 'error');
            return;
        }

        const twitterEl = document.getElementById('hqTwitterValue');
        const discordEl = document.getElementById('hqDiscordValue');
        const websiteEl = document.getElementById('hqWebsiteValue');

        const current = {
            twitter: (prefill.twitter ?? twitterEl?.textContent ?? '').trim(),
            discord: (prefill.discord ?? discordEl?.textContent ?? '').trim(),
            website: (prefill.website ?? websiteEl?.textContent ?? '').trim(),
        };

        openModalWithAsyncConfirm({
            title: 'Team Settings',
            subtitle: 'Update socials and public-facing metadata',
            confirmText: 'Save',
            bodyHtml: `
                <div class="space-y-4">
                    <div id="hqModalError" class="hidden rounded-xl border border-line bg-white/5 p-3 text-sm"></div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Twitter</label>
                        <input type="text" id="hqSettingsTwitter" value="${escapeHtml(current.twitter === '—' ? '' : current.twitter)}" placeholder="@yourteam"
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" />
                    </div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Discord</label>
                        <input type="text" id="hqSettingsDiscord" value="${escapeHtml(current.discord === '—' ? '' : current.discord)}" placeholder="discord.gg/yourteam"
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" />
                    </div>
                    <div>
                        <label class="text-sm font-semibold block mb-2">Website</label>
                        <input type="text" id="hqSettingsWebsite" value="${escapeHtml(current.website === '—' ? '' : current.website)}" placeholder="https://yourteam.gg"
                            class="w-full px-4 py-2 rounded-xl border border-line bg-white/5 outline-none focus:border-white/30 transition" />
                    </div>
                </div>
            `,
            onConfirm: async () => {
                const twitter = document.getElementById('hqSettingsTwitter')?.value?.trim() || '';
                const discord = document.getElementById('hqSettingsDiscord')?.value?.trim() || '';
                const website = document.getElementById('hqSettingsWebsite')?.value?.trim() || '';

                await updateTeamSettings({ twitter, discord, website });

                if (twitterEl) twitterEl.textContent = twitter || '—';
                if (discordEl) discordEl.textContent = discord || '—';
                if (websiteEl) websiteEl.textContent = website || '—';

                setBanner(globalMessageEl, 'Team settings updated.', 'success');
            },
        });
    }

    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ========================================
    // TEAM PROFILE SAVE FUNCTIONALITY
    // ========================================
    async function saveTeamProfile() {
        const profileMessageEl = document.getElementById('hqProfileMessage');
        const saveBtn = document.getElementById('hqSaveProfileBtn');

        try {
            // Collect form data (Brand Identity + About only)
            const formData = new FormData();
            formData.append('name', document.getElementById('profileTeamName')?.value?.trim() || '');
            formData.append('tagline', document.getElementById('profileTagline')?.value?.trim() || '');
            formData.append('description', document.getElementById('profileDescription')?.value?.trim() || '');
            formData.append('region', document.getElementById('profileRegion')?.value?.trim() || '');
            formData.append('primary_color', document.getElementById('profilePrimaryColorHex')?.value?.trim() || '#8b5cf6');
            formData.append('accent_color', document.getElementById('profileAccentColorHex')?.value?.trim() || '#3b82f6');

            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 inline mr-1 animate-spin"></i> Saving...';

            // Send request
            const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
            });

            const payload = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(payload?.error || 'Failed to update team profile');
            }

            // Success
            setBanner(profileMessageEl, 'Team profile updated successfully!', 'success');
            
            // Update team name in sidebar if changed
            const newName = document.getElementById('profileTeamName')?.value?.trim();
            if (newName && document.getElementById('hqTeamName')) {
                document.getElementById('hqTeamName').textContent = newName;
            }

            // Reload to reflect changes
            setTimeout(() => window.location.reload(), 1500);

        } catch (error) {
            setBanner(profileMessageEl, error.message || 'Failed to update team profile', 'error');
        } finally {
            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="save" class="w-3.5 h-3.5 inline mr-1"></i> Save Changes';
            lucide.createIcons(); // Reinitialize icon
        }
    }

    // Tournament Operations save function
    async function saveTournamentOps() {
        const saveBtn = document.getElementById('hqSaveTournamentOps');
        
        try {
            // Collect tournament ops data
            const formData = new FormData();
            formData.append('preferred_server', document.getElementById('compPreferredServer')?.value?.trim() || '');
            formData.append('emergency_contact_discord', document.getElementById('compEmergencyDiscord')?.value?.trim() || '');
            formData.append('emergency_contact_phone', document.getElementById('compEmergencyPhone')?.value?.trim() || '');

            // Disable button during save
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 inline mr-1 animate-spin"></i> Saving...';

            // Send request
            const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
            });

            const payload = await response.json().catch(() => ({}));

            if (!response.ok) {
                throw new Error(payload?.error || 'Failed to update tournament operations');
            }

            // Success - show temporary success message
            saveBtn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5 inline mr-1"></i> Saved!';
            saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            saveBtn.classList.add('bg-green-500');
            
            setTimeout(() => {
                saveBtn.innerHTML = '<i data-lucide="save" class="w-3.5 h-3.5 inline mr-1"></i> Save';
                saveBtn.classList.remove('bg-green-500');
                saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                saveBtn.disabled = false;
                lucide.createIcons();
            }, 2000);

        } catch (error) {
            alert(error.message || 'Failed to update tournament operations');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="save" class="w-3.5 h-3.5 inline mr-1"></i> Save';
            lucide.createIcons();
        }
    }

    // Sync color picker and hex input
    document.getElementById('profilePrimaryColor')?.addEventListener('input', (e) => {
        document.getElementById('profilePrimaryColorHex').value = e.target.value;
    });
    document.getElementById('profilePrimaryColorHex')?.addEventListener('input', (e) => {
        const val = e.target.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
            document.getElementById('profilePrimaryColor').value = val;
        }
    });
    document.getElementById('profileAccentColor')?.addEventListener('input', (e) => {
        document.getElementById('profileAccentColorHex').value = e.target.value;
    });
    document.getElementById('profileAccentColorHex')?.addEventListener('input', (e) => {
        const val = e.target.value;
        if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
            document.getElementById('profileAccentColor').value = val;
        }
    });

    // Wire save buttons
    document.getElementById('hqSaveProfileBtn')?.addEventListener('click', saveTeamProfile);
    document.getElementById('hqSaveTournamentOps')?.addEventListener('click', saveTournamentOps);
    document.getElementById('hqSaveBrandingBtn')?.addEventListener('click', async function() {
        const btn = this;
        const originalHTML = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-3.5 h-3.5 inline mr-1 animate-spin"></i>Saving...';
            
            const formData = new FormData();
            formData.append('primary_color', document.getElementById('profilePrimaryColorHex')?.value?.trim() || '#8b5cf6');
            formData.append('accent_color', document.getElementById('profileAccentColorHex')?.value?.trim() || '#3b82f6');
            formData.append('region', document.getElementById('profileRegion')?.value?.trim() || '');
            
            const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
            });
            
            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                throw new Error(data.error || 'Failed to save branding');
            }
            
            alert('Branding saved successfully!');
            setTimeout(() => location.reload(), 500);
        } catch (error) {
            alert(error.message || 'Failed to save branding');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
            lucide?.createIcons();
        }
    });

    // About section Edit/Cancel buttons
    document.getElementById('hqEditAboutBtn')?.addEventListener('click', () => {
        document.getElementById('aboutReadView').classList.add('hidden');
        document.getElementById('aboutEditView').classList.remove('hidden');
        document.getElementById('hqEditAboutBtn').classList.add('hidden');
    });

    document.getElementById('hqCancelAboutBtn')?.addEventListener('click', () => {
        document.getElementById('aboutEditView').classList.add('hidden');
        document.getElementById('aboutReadView').classList.remove('hidden');
        document.getElementById('hqEditAboutBtn').classList.remove('hidden');
        // Reset form values
        location.reload();
    });

    // Logo upload handler
    document.getElementById('profileLogoInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('Logo file size must be less than 2MB');
            e.target.value = '';
            return;
        }
        
        // Upload file
        const formData = new FormData();
        formData.append('logo', file);
        
        try {
            const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
            });
            
            if (!response.ok) throw new Error('Failed to upload logo');
            
            alert('Logo uploaded successfully!');
            setTimeout(() => location.reload(), 500);
        } catch (error) {
            alert(error.message || 'Failed to upload logo');
        }
    });

    // Banner upload handler
    document.getElementById('profileBannerInput')?.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        // Validate file size (max 3MB)
        if (file.size > 3 * 1024 * 1024) {
            alert('Banner file size must be less than 3MB');
            e.target.value = '';
            return;
        }
        
        // Upload file
        const formData = new FormData();
        formData.append('banner', file);
        
        try {
            const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
                credentials: 'same-origin',
            });
            
            if (!response.ok) throw new Error('Failed to upload banner');
            
            alert('Banner uploaded successfully!');
            setTimeout(() => location.reload(), 500);
        } catch (error) {
            alert(error.message || 'Failed to upload banner');
        }
    });

    // Social Links Edit button handler
    document.getElementById('hqEditSocialLinksBtn')?.addEventListener('click', () => {
        // Get current values from the display
        const currentTwitter = document.querySelector('[href*="twitter.com"]')?.href || document.querySelector('[href*="x.com"]')?.href || '';
        const currentInstagram = document.querySelector('[href*="instagram.com"]')?.href || '';
        const currentYoutube = document.querySelector('[href*="youtube.com"]')?.href || '';
        const currentTwitch = document.querySelector('[href*="twitch.tv"]')?.href || '';
        
        openModalWithAsyncConfirm({
            title: 'Edit Social Links',
            subtitle: 'Update your team\'s social media presence',
            bodyHtml: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i data-lucide="twitter" class="w-4 h-4 inline mr-1"></i>
                            Twitter / X URL
                        </label>
                        <input type="url" id="modalTwitterUrl" value="${currentTwitter}"
                            class="w-full bg-white/5 border border-line rounded-xl px-4 py-2.5 text-sm"
                            placeholder="https://twitter.com/yourteam">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i data-lucide="instagram" class="w-4 h-4 inline mr-1"></i>
                            Instagram URL
                        </label>
                        <input type="url" id="modalInstagramUrl" value="${currentInstagram}"
                            class="w-full bg-white/5 border border-line rounded-xl px-4 py-2.5 text-sm"
                            placeholder="https://instagram.com/yourteam">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i data-lucide="youtube" class="w-4 h-4 inline mr-1"></i>
                            YouTube URL
                        </label>
                        <input type="url" id="modalYoutubeUrl" value="${currentYoutube}"
                            class="w-full bg-white/5 border border-line rounded-xl px-4 py-2.5 text-sm"
                            placeholder="https://youtube.com/@yourteam">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">
                            <i data-lucide="twitch" class="w-4 h-4 inline mr-1"></i>
                            Twitch URL
                        </label>
                        <input type="url" id="modalTwitchUrl" value="${currentTwitch}"
                            class="w-full bg-white/5 border border-line rounded-xl px-4 py-2.5 text-sm"
                            placeholder="https://twitch.tv/yourteam">
                    </div>
                </div>
            `,
            confirmText: 'Save Changes',
            onConfirm: async () => {
                const formData = new FormData();
                formData.append('twitter_url', document.getElementById('modalTwitterUrl')?.value || '');
                formData.append('instagram_url', document.getElementById('modalInstagramUrl')?.value || '');
                formData.append('youtube_url', document.getElementById('modalYoutubeUrl')?.value || '');
                formData.append('twitch_url', document.getElementById('modalTwitchUrl')?.value || '');

                const response = await fetch(`/api/vnext/teams/${teamSlug}/profile/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData,
                    credentials: 'same-origin',
                });

                if (!response.ok) throw new Error('Failed to update social links');
                
                alert('Social links updated successfully!');
                setTimeout(() => location.reload(), 500);
            }
        });
    });

    // Post Announcement button handler
    document.getElementById('hqPostAnnouncementBtn')?.addEventListener('click', () => {
        openModalWithAsyncConfirm({
            title: 'Post Team Announcement',
            subtitle: 'Share news and updates with your team',
            bodyHtml: `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Announcement Message</label>
                        <textarea id="modalAnnouncementMessage" rows="4"
                            class="w-full bg-white/5 border border-line rounded-xl px-4 py-2.5 text-sm resize-none"
                            placeholder="Share important updates, match schedules, practice times, etc."></textarea>
                    </div>
                    <div class="text-xs text-muted">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                        This will be visible to all team members
                    </div>
                </div>
            `,
            confirmText: 'Post Announcement',
            onConfirm: async () => {
                const message = document.getElementById('modalAnnouncementMessage')?.value?.trim();
                
                if (!message) {
                    throw new Error('Please enter a message');
                }

                // TODO: Replace with actual API endpoint when backend is ready
                alert('Announcement posting feature coming soon! Message: ' + message);
                // For now, just close the modal
                // In production, this would POST to an announcements API endpoint
            }
        });
    });

    // Media Gallery Upload button handler
    document.getElementById('hqUploadMediaBtn')?.addEventListener('click', () => {
        document.getElementById('hqMediaUploadInput')?.click();
    });

    document.getElementById('hqMediaUploadInput')?.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;

        // Validate files
        const maxSize = 10 * 1024 * 1024; // 10MB per file
        const invalidFiles = files.filter(f => f.size > maxSize);
        
        if (invalidFiles.length > 0) {
            alert(`Some files exceed 10MB limit and will be skipped: ${invalidFiles.map(f => f.name).join(', ')}`);
        }

        const validFiles = files.filter(f => f.size <= maxSize);
        
        if (validFiles.length === 0) {
            e.target.value = '';
            return;
        }

        // TODO: Replace with actual API endpoint when backend is ready
        alert(`Media upload feature coming soon! ${validFiles.length} file(s) selected:\n${validFiles.map(f => f.name).join('\n')}`);
        e.target.value = '';
        
        // In production, this would:
        // 1. Create FormData with all files
        // 2. POST to media upload API endpoint
        // 3. Show progress indicator
        // 4. Reload page or update gallery on success
    });

    // Make functions globally accessible for button onclick handlers
    window.addTeamMember = addTeamMember;
    window.changeTeamMemberRole = changeTeamMemberRole;
    window.removeTeamMember = removeTeamMember;
    window.updateTeamSettings = updateTeamSettings;
    window.saveTeamProfile = saveTeamProfile;
    window.saveTournamentOps = saveTournamentOps;
    window.uploadRosterPhoto = uploadRosterPhoto;

    // UI event wiring
    inviteBtnEl?.addEventListener('click', () => showAddMemberModal());
    addMemberCardEl?.addEventListener('click', () => showAddMemberModal());

    // Member action buttons (event delegation)
    membersGridEl?.addEventListener('click', (e) => {
        const btn = e.target?.closest?.('[data-member-action="menu"]');
        if (!btn) return;
        const membershipId = btn.getAttribute('data-membership-id');
        if (!membershipId) return;
        showMemberActionsModal(membershipId);
    });

    // Settings wiring
    editSettingsBtnEl?.addEventListener('click', () => showSettingsModal());
    document.querySelectorAll('[data-settings-edit]').forEach(btn => {
        btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-settings-edit');
            const prefill = {};
            if (key === 'twitter') prefill.twitter = document.getElementById('hqTwitterValue')?.textContent?.trim() || '';
            if (key === 'discord') prefill.discord = document.getElementById('hqDiscordValue')?.textContent?.trim() || '';
            if (key === 'website') prefill.website = document.getElementById('hqWebsiteValue')?.textContent?.trim() || '';
            showSettingsModal(prefill);
        });
    });

    // Bootstrap data on page load
    if (teamSlug) bootstrapTeamData();
    else setBanner(globalMessageEl, 'Team slug not found in URL - API wiring disabled.', 'error');
</script>
