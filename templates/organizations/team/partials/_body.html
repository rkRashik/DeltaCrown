{% load team_filters %}
{% load humanize %}
{% load static %}

{# ================================================================== #}
{# TEAM DETAIL PAGE — BODY PARTIAL                                    #}
{# Phase 3 Production Build                                           #}
{# Context keys: team, organization, viewer, permissions, ui,         #}
{#   roster, stats, streams, partners, merch, pending_actions, page   #}
{# ================================================================== #}

{# ── AMBIENT BACKGROUND ───────────────────────────────────────────── #}
{# Hidden CSRF token for AJAX calls (invite accept/decline) #}
{% csrf_token %}
<div class="fixed inset-0 z-0 pointer-events-none">
  <div class="absolute -top-40 -right-40 w-[800px] h-[800px] rounded-full blur-[200px] opacity-10" style="background: var(--team-primary)"></div>
  <div class="absolute -bottom-56 -left-56 w-[900px] h-[900px] rounded-full blur-[220px] opacity-[0.06]" style="background: var(--team-primary)"></div>
</div>

<div class="relative z-10">

{# ══════════════════════════════════════════════════════════════════ #}
{# HERO BANNER                                                       #}
{# ══════════════════════════════════════════════════════════════════ #}
<header class="relative mb-0">
  {# Banner Image #}
  <div class="relative w-full h-[340px] sm:h-[400px] md:h-[480px] overflow-hidden">
    <div class="absolute inset-0">
      {% if team.banner_url %}
        <img id="dc-hero-banner" src="{{ team.banner_url }}" alt="{{ team.name }} banner"
             class="w-full h-full object-cover object-center hero-mask opacity-90 scale-[1.02] lazy-media"
             onerror="this.onerror=null; this.src='{% static 'img/teams/default-banner.svg' %}';" loading="lazy" />
      {% else %}
        <img id="dc-hero-banner" src="{% static 'img/teams/default-banner.svg' %}" alt="{{ team.name }} banner"
             class="w-full h-full object-cover object-center hero-mask opacity-90 scale-[1.02]" />
      {% endif %}
    </div>
    <div class="absolute inset-0 bg-gradient-to-t from-black via-black/30 to-transparent"></div>
    <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
  </div>

  {# Team Card (overlaps banner) #}
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 relative -mt-20 md:-mt-24 z-20">
    <div class="liquid-glass team-card rounded-3xl p-5 sm:p-6 md:p-8 flex flex-col lg:flex-row gap-6 md:gap-8 items-stretch lg:items-center">

      {# Logo Slab #}
      <div class="relative shrink-0">
        <div class="logo-slab">
          <div class="logo-slab__inner">
            {% if team.logo_url %}
              <img src="{{ team.logo_url }}" alt="{{ team.name }} logo" class="dc-team-logo"
                   onerror="this.onerror=null; this.src='{% static 'img/teams/default-logo.svg' %}';" />
            {% else %}
              <img src="{% static 'img/teams/default-logo.svg' %}" alt="{{ team.name }} logo" class="dc-team-logo" />
            {% endif %}
          </div>
        </div>
        {# Verified badge #}
        {% if organization %}
        <div class="absolute -bottom-2 -right-2 verified-dot flex items-center justify-center z-10" title="Organization Verified">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
        </div>
        {% endif %}
      </div>

      {# Team Identity #}
      <div class="flex-1 min-w-0">
        <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4">
          <h1 class="text-3xl sm:text-4xl md:text-5xl font-display font-bold tracking-tight leading-none text-white break-words">
            {{ team.name|default:"Unknown Team" }}
          </h1>
          {% if team.tag %}
            <span class="chip primary">[{{ team.tag }}]</span>
          {% endif %}
          <div class="flex flex-wrap items-center gap-2">
            {% if stats.rank %}
              <span class="tag tag--rank">RANK #{{ stats.rank }}</span>
            {% elif stats.tier and stats.tier != 'UNRANKED' %}
              <span class="tag tag--rank">{{ stats.tier }}</span>
            {% endif %}
          </div>
        </div>

        <p class="mt-3 text-slate-400 text-sm leading-relaxed max-w-3xl line-clamp-2">
          {{ team.tagline|default:"A competitive team ready to compete." }}
        </p>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          {% if organization and organization.name %}
            <span class="meta-pill">
              {% if organization.logo_url %}
              <img src="{{ organization.logo_url }}" alt="" class="w-4 h-4 rounded object-cover">
              {% else %}
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21V7a2 2 0 012-2h14a2 2 0 012 2v14M9 21V9h6v12"/></svg>
              {% endif %}
              <span>ORG</span>
              <b><a href="{{ organization.url }}" class="hover:text-[var(--team-primary)] transition">{{ organization.name }}</a></b>
              {% if organization.is_verified %}
              <svg class="w-3.5 h-3.5 text-indigo-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              {% endif %}
            </span>
          {% endif %}
          {% if team.game.name %}
            <span class="meta-pill">
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L8 21h8l-1.75-4M3 13h18M5 4h14a2 2 0 012 2v9H3V6a2 2 0 012-2z"/></svg>
              <span>GAME</span>
              <b>{{ team.game.name|upper }}</b>
            </span>
          {% endif %}
          {% if team.founded_date %}
            <span class="meta-pill">
              <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <span>EST</span>
              <b>{{ team.founded_date }}</b>
            </span>
          {% endif %}
        </div>
      </div>

      {# CTAs + Stats (Right side) #}
      <div class="flex flex-col justify-between gap-5 lg:items-end">
        <div id="team-info-actions" class="flex items-center gap-3 lg:justify-end">
          {% if permissions.can_edit_team %}
            <a href="{% url 'organizations:team_manage' team.slug %}" class="btn-primary flex items-center gap-2" title="Manage team">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              <span>MANAGE</span>
            </a>
          {% elif permissions.is_member %}
            <a href="{% url 'organizations:team_manage' team.slug %}" class="btn-primary flex items-center gap-2" title="Team Headquarters">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
              <span>TEAM HQ</span>
            </a>
            <a href="{% url 'organizations:team_manage' team.slug %}#discord"
               class="btn-secondary flex items-center gap-2"
               title="Open Team Chat in HQ">
              <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <span>TEAM CHAT</span>
            </a>
          {% elif pending_actions.has_pending_invite %}
            <div class="relative" id="dc-invite-cta-wrap">
              <button type="button" class="btn-primary flex items-center gap-2 animate-pulse" onclick="document.getElementById('dc-invite-dropdown').classList.toggle('hidden')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <span>VIEW INVITE</span>
              </button>
              {# Inline accept/decline dropdown #}
              <div id="dc-invite-dropdown" class="hidden absolute top-full right-0 mt-2 w-72 rounded-2xl bg-[#0A0A0F] border border-white/15 p-4 shadow-2xl z-50" onclick="event.stopPropagation()">
                <p class="text-xs text-white/50 mb-3">You've been invited to join this team</p>
                <div class="flex gap-2" id="dc-invite-actions">
                  <button onclick="dcInviteAction('accept')" class="flex-1 h-10 rounded-xl bg-emerald-500/15 border border-emerald-500/30 text-emerald-300 text-xs font-bold uppercase tracking-wider hover:bg-emerald-500/25 transition flex items-center justify-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                    Accept
                  </button>
                  <button onclick="dcInviteAction('decline')" class="flex-1 h-10 rounded-xl bg-white/5 border border-white/10 text-white/40 text-xs font-bold uppercase tracking-wider hover:bg-red-500/10 hover:border-red-500/20 hover:text-red-400 transition flex items-center justify-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                    Decline
                  </button>
                </div>
                <div id="dc-invite-msg" class="hidden mt-2 text-center text-xs font-bold"></div>
              </div>
            </div>
          {% elif pending_actions.has_pending_request %}
            <button type="button" class="btn-primary flex items-center gap-2 opacity-75" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span>PENDING</span>
            </button>
          {% elif pending_actions.can_request_to_join %}
            <button type="button" class="btn-primary flex items-center gap-2" title="Applications coming soon" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              <span>APPLY</span>
            </button>
          {% endif %}

          {# Share — always visible #}
          <button type="button" class="btn-secondary" title="Share team profile"
                  onclick="navigator.share ? navigator.share({title: '{{ team.name }}', url: window.location.href}) : navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied!'))">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
          </button>
        </div>

        {# Hero Stats Grid #}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-6 gap-y-3">
          <div class="text-right">
            <div class="text-[9px] font-mono uppercase text-slate-500 tracking-wider">Crown Pts</div>
            <div class="text-2xl font-display font-bold text-white">{{ team.crown_points|default:0|intcomma }}</div>
          </div>
          <div class="text-right">
            <div class="text-[9px] font-mono uppercase text-slate-500 tracking-wider">Wins</div>
            <div class="text-2xl font-display font-bold text-emerald-400">{{ team.total_wins|default:0 }}</div>
          </div>
          <div class="text-right">
            <div class="text-[9px] font-mono uppercase text-slate-500 tracking-wider">Win Rate</div>
            <div class="text-2xl font-display font-bold text-white">
              {% widthratio team.total_wins 1 100 as wr_num %}
              {% if team.total_wins and team.total_losses %}
                {% widthratio team.total_wins team.total_wins|add:team.total_losses 100 %}%
              {% else %}
                —
              {% endif %}
            </div>
          </div>
          <div class="text-right">
            <div class="text-[9px] font-mono uppercase text-slate-500 tracking-wider">Rank</div>
            <div class="text-2xl font-display font-bold text-[var(--team-primary)]">
              {% if stats.rank %}#{{ stats.rank }}{% else %}—{% endif %}
            </div>
          </div>
          {% if organization and organization.empire_score %}
          <div class="text-right col-span-2 sm:col-span-4 border-t border-white/10 pt-3 mt-1">
            <div class="flex items-center justify-end gap-3">
              <div>
                <div class="text-[9px] font-mono uppercase text-amber-500/70 tracking-wider">Empire Score</div>
                <div class="text-2xl font-display font-bold text-amber-400">{{ organization.empire_score|intcomma }}</div>
              </div>
              {% if organization.global_rank %}
              <div>
                <div class="text-[9px] font-mono uppercase text-slate-500 tracking-wider">Org Rank</div>
                <div class="text-2xl font-display font-bold text-white/60">#{{ organization.global_rank }}</div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</header>

{# ══════════════════════════════════════════════════════════════════ #}
{# SCROLLSPY NAVIGATION                                              #}
{# ══════════════════════════════════════════════════════════════════ #}
<nav class="sticky top-0 z-40 bg-[#000]/80 backdrop-blur-md border-b border-white/10 mt-8 mb-8 transition-all duration-300" id="dc-subnav">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6">
    <div class="flex items-center justify-between h-14 md:h-16 overflow-x-auto no-scrollbar mask-fade-sides">
      {# Section Links #}
      <div class="flex items-center gap-1 md:gap-6 text-xs md:text-sm font-bold tracking-widest uppercase font-mono h-full min-w-max">
        <a href="#overview" class="relative h-full flex items-center px-2 text-[var(--team-primary)] nav-link" data-nav="overview">
          Overview
          <span class="nav-underline absolute bottom-0 left-0 w-full h-0.5 bg-[var(--team-primary)] shadow-[0_0_10px_var(--team-primary)]"></span>
        </a>
        <a href="#roster" class="relative h-full flex items-center px-2 text-slate-500 hover:text-white transition-colors nav-link" data-nav="roster">Roster</a>
        <a href="#matches" class="relative h-full flex items-center px-2 text-slate-500 hover:text-white transition-colors nav-link" data-nav="matches">Matches</a>
        <a href="#stats" class="relative h-full flex items-center px-2 text-slate-500 hover:text-white transition-colors nav-link" data-nav="stats">Stats</a>
        <a href="#media" class="relative h-full flex items-center px-2 text-slate-500 hover:text-white transition-colors nav-link" data-nav="media">Media</a>
        {% if permissions.can_view_operations %}
          <a href="#operations" class="relative h-full flex items-center px-2 text-slate-500 hover:text-emerald-400 transition-colors nav-link gap-2" data-nav="operations">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
            Ops
          </a>
        {% endif %}
      </div>

      {# Live Indicator #}
      <div class="hidden md:flex items-center gap-3 pl-6 border-l border-white/10 ml-4">
        <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-slate-500">
          <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span>
          <span class="text-[9px] font-bold tracking-widest uppercase">{{ roster.count|default:0 }} Members</span>
        </div>
      </div>
    </div>
  </div>
</nav>

{# ══════════════════════════════════════════════════════════════════ #}
{# MAIN CONTENT GRID (8 + 4)                                        #}
{# ══════════════════════════════════════════════════════════════════ #}
<main class="max-w-[1600px] mx-auto px-4 sm:px-6 pb-24">
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 xl:gap-12 items-start">

    {# ── LEFT COLUMN (8 cols) ─────────────────────────────────── #}
    <div class="lg:col-span-8 flex flex-col gap-10" id="dc-main-col">

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 1: OVERVIEW — Mission & Identity                 #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="overview" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="section-heading__bar"></span>
          Mission &amp; Identity
        </h3>

        {# Mission Statement + Description #}
        <div class="liquid-trace rounded-2xl p-6 mb-6">
          {% if team.tagline %}
          <p class="text-white/80 text-sm font-medium italic mb-2">
            "{{ team.tagline }}"
          </p>
          {% endif %}
          {% if team.description %}
          <p class="text-slate-300 text-sm leading-relaxed">
            {{ team.description }}
          </p>
          {% elif not team.tagline %}
          <p class="text-slate-400 text-sm leading-relaxed italic">
            No mission statement has been set for this team yet.
          </p>
          {% endif %}
          {% if organization %}
            <p class="mt-3 text-xs text-slate-500 flex items-center gap-2">
              {% if organization.logo_url %}
              <img src="{{ organization.logo_url }}" alt="" class="w-4 h-4 rounded object-cover opacity-60">
              {% endif %}
              Part of <a href="{{ organization.url }}" class="text-[var(--team-primary)] hover:underline font-medium">{{ organization.name }}</a>
              {% if organization.is_verified %}
              <svg class="w-3.5 h-3.5 text-indigo-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              {% endif %}
              {% if organization.type %}· {{ organization.type|title }} Organization{% endif %}
            </p>
          {% endif %}
        </div>

        {# Quick Stats Cards #}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="liquid-trace rounded-xl p-4 text-center hover-lift">
            <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Members</div>
            <div class="text-2xl font-display font-bold text-white">{{ roster.count|default:0 }}</div>
          </div>
          <div class="liquid-trace rounded-xl p-4 text-center hover-lift">
            <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Wins</div>
            <div class="text-2xl font-display font-bold text-emerald-400">{{ team.total_wins|default:0 }}</div>
          </div>
          <div class="liquid-trace rounded-xl p-4 text-center hover-lift">
            <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Losses</div>
            <div class="text-2xl font-display font-bold text-red-400">{{ team.total_losses|default:0 }}</div>
          </div>
          <div class="liquid-trace rounded-xl p-4 text-center hover-lift">
            <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Crown Points</div>
            <div class="text-2xl font-display font-bold text-[var(--team-primary)]">{{ team.crown_points|default:0|intcomma }}</div>
          </div>
        </div>
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 2: ROSTER — Active Roster                        #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="roster" class="transition-smooth">
        <div class="flex items-center justify-between mb-6">
          <h3 class="section-heading">
            <span class="section-heading__bar"></span>
            Active Roster
            {% if roster.count %}
              <span class="section-heading__badge">{{ roster.count }}</span>
            {% endif %}
          </h3>
          {% if permissions.can_manage_roster %}
            <a href="{% url 'organizations:team_manage' team.slug %}" class="text-[10px] font-mono font-bold uppercase tracking-widest text-slate-500 hover:text-[var(--team-primary)] transition">
              Manage Roster →
            </a>
          {% endif %}
        </div>

        {% if roster.items %}
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4" id="dc-roster-grid">
            {% for member in roster.items %}
              <div class="group relative h-[280px] sm:h-[320px] rounded-2xl overflow-hidden bg-[#0A0A0F] border border-white/10 hover-lift hover-glow cursor-pointer dc-roster-card"
                   data-username="{{ member.username }}"
                   data-display="{{ member.display_name }}"
                   data-avatar="{{ member.avatar_url }}"
                   data-role="{{ member.role|default:'PLAYER' }}"
                   data-player-role="{{ member.player_role|default:'' }}"
                   data-profile-url="{{ member.user_profile_url }}"
                   data-captain="{{ member.is_captain|yesno:'true,false' }}"
                   onclick="dcShowPlayerPopup(this)">
                {# Player Photo #}
                <div class="absolute inset-0">
                  <img src="{{ member.avatar_url }}" alt="{{ member.display_name }}"
                       class="w-full h-full object-cover opacity-50 group-hover:opacity-70 group-hover:scale-105 transition-smooth lazy-media"
                       loading="lazy"
                       onerror="this.onerror=null; this.style.display='none';" />
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>

                {# Role Badge (top-right) #}
                <div class="absolute top-3 right-3 w-8 h-8 rounded-full bg-black/50 backdrop-blur border border-white/10 flex items-center justify-center">
                  {% if member.is_captain %}
                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                  {% elif member.role == 'OWNER' %}
                    <svg class="w-4 h-4 text-[var(--team-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                  {% elif member.role == 'COACH' or member.role == 'MANAGER' %}
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                  {% else %}
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  {% endif %}
                </div>

                {# Status indicator (top-left) — online/offline dot #}
                {% if member.status == 'ACTIVE' %}
                <div class="absolute top-3 left-3 flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-black/50 backdrop-blur border border-white/10">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                  <span class="text-[8px] font-mono uppercase text-emerald-400/80">Active</span>
                </div>
                {% endif %}

                {# Player Info (bottom overlay) — enhanced layout #}
                <div class="absolute bottom-0 left-0 w-full p-4">
                  {% if member.player_role %}
                    <div class="text-[9px] font-mono font-bold uppercase text-[var(--team-primary)] tracking-widest mb-1">{{ member.player_role }}</div>
                  {% endif %}
                  <h4 class="text-lg font-display font-bold text-white mb-1.5 truncate leading-tight">{{ member.display_name }}</h4>
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="chip">{{ member.role|default:"PLAYER" }}</span>
                    {% if member.is_captain %}
                      <span class="chip" style="background: rgba(234,179,8,0.15); color: #EAB308; border-color: rgba(234,179,8,0.25);">Captain</span>
                    {% endif %}
                  </div>
                  {# Hover prompt #}
                  <div class="mt-2 flex items-center gap-1 text-[9px] text-white/0 group-hover:text-white/40 transition font-mono uppercase tracking-wider">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    View player
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          {# Empty Roster State #}
          <div class="empty-state">
            <div class="empty-state__icon">
              <svg class="w-16 h-16 mx-auto text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            </div>
            <h4 class="text-lg font-bold text-white mb-2">No Roster Yet</h4>
            <p class="text-sm text-slate-400 mb-4">This team is still building its roster.</p>
            {% if permissions.can_invite %}
              <a href="{% url 'organizations:team_manage' team.slug %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--team-primary)]/10 border border-[var(--team-primary)]/20 text-[var(--team-primary)] text-xs font-bold uppercase tracking-wider hover:bg-[var(--team-primary)]/20 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                Invite Players
              </a>
            {% endif %}
          </div>
        {% endif %}
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 3: MATCHES — Match Schedule                      #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="matches" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="section-heading__bar"></span>
          Match Schedule
        </h3>

        {# Filter Tabs #}
        <div class="flex items-center gap-2 mb-6">
          <button type="button" class="match-filter-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider bg-white/10 text-white" data-filter="all">All</button>
          <button type="button" class="match-filter-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-slate-500 hover:bg-white/5" data-filter="upcoming">Upcoming</button>
          <button type="button" class="match-filter-btn px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider text-slate-500 hover:bg-white/5" data-filter="results">Results</button>
        </div>

        {# Coming Soon Placeholder #}
        <div class="coming-soon-section">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-lg bg-[var(--team-primary)]/10 flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 text-[var(--team-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            </div>
            <div class="flex-1">
              <h4 class="text-white font-bold mb-1">Match Schedule &amp; Results</h4>
              <p class="text-sm text-slate-400">Coming soon – view upcoming matches, past results, and performance analytics.</p>
              {% if permissions.can_report_matches %}
                <p class="text-xs text-slate-500 mt-2">Report matches in <a href="{% url 'organizations:team_manage' team.slug %}" class="text-[var(--team-primary)] hover:underline">Team HQ</a></p>
              {% endif %}
            </div>
          </div>
        </div>
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 4: STATS — Team Statistics                       #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="stats" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="section-heading__bar"></span>
          Team Statistics &amp; Performance
        </h3>

        {% if stats.tier and stats.tier != 'UNRANKED' %}
          {# Rank Card #}
          <div class="liquid-trace rounded-2xl p-6 mb-6" data-accent="team">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
              <div>
                <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Tier</div>
                <div class="text-xl font-display font-bold text-[var(--team-primary)]">{{ stats.tier }}</div>
              </div>
              <div>
                <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Score</div>
                <div class="text-xl font-display font-bold text-white">{{ stats.score|intcomma }}</div>
              </div>
              <div>
                <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Matches Verified</div>
                <div class="text-xl font-display font-bold text-white">{{ stats.verified_match_count|default:0 }}</div>
              </div>
              <div>
                <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Confidence</div>
                <div class="text-xl font-display font-bold text-white">{{ stats.confidence_level|default:"—" }}</div>
              </div>
            </div>
          </div>
        {% else %}
          {# Unranked Placeholder #}
          <div class="coming-soon-section">
            <div class="flex items-start gap-4">
              <div class="w-10 h-10 rounded-lg bg-[var(--team-primary)]/10 flex items-center justify-center shrink-0">
                <svg class="w-5 h-5 text-[var(--team-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
              </div>
              <div class="flex-1">
                <h4 class="text-white font-bold mb-1">Performance Statistics</h4>
                <p class="text-sm text-slate-400">This team hasn't been ranked yet. Play verified matches to earn a ranking.</p>
              </div>
            </div>
          </div>
        {% endif %}
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 5: JOURNEY — The Journey (Timeline)              #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="journey" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="section-heading__bar"></span>
          The Journey
        </h3>

        <div class="coming-soon-section">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-lg bg-[var(--team-primary)]/10 flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 text-[var(--team-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div class="flex-1">
              <h4 class="text-white font-bold mb-1">Team Timeline</h4>
              <p class="text-sm text-slate-400">Coming soon – milestones, achievements, roster changes, and tournament history documented chronologically.</p>
            </div>
          </div>
        </div>
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 6: COMMUNITY — Team Transmission                 #}
      {# ──────────────────────────────────────────────────────── #}
      <section id="community" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="w-1 h-5 bg-[#5865F2] rounded-full"></span>
          Team Transmission
        </h3>

        {% if permissions.is_member or permissions.can_edit_team %}
        {# ── Members see a CTA to open Team Chat in HQ ── #}
        <div class="rounded-2xl border border-indigo-500/20 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 p-6">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-xl bg-[#5865F2]/15 flex items-center justify-center shrink-0">
              <svg class="w-6 h-6 text-[#5865F2]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            </div>
            <div class="flex-1">
              <h4 class="text-white font-bold mb-1">Team Chat &amp; Discord</h4>
              <p class="text-sm text-slate-400 mb-4">Chat with your team, sync messages with Discord, and coordinate matches — all from Team HQ.</p>
              <a href="{% url 'organizations:team_manage' team.slug %}#discord"
                 class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-[#5865F2]/20 border border-[#5865F2]/30 text-[#5865F2] text-sm font-semibold hover:bg-[#5865F2]/30 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                Open Team Chat
              </a>
            </div>
          </div>
        </div>
        {% else %}
        {# ── Non-members see the coming-soon placeholder ── #}
        <div class="coming-soon-section">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 rounded-lg bg-[#5865F2]/10 flex items-center justify-center shrink-0">
              <svg class="w-5 h-5 text-[#5865F2]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/></svg>
            </div>
            <div class="flex-1">
              <h4 class="text-white font-bold mb-1">Team Feed &amp; Announcements</h4>
              <p class="text-sm text-slate-400">Coming soon – team posts, match callouts, community polls, and pinned announcements.</p>
            </div>
          </div>
        </div>
        {% endif %}
      </section>

      {# ──────────────────────────────────────────────────────── #}
      {# SECTION 7: OPERATIONS — Staff Only                       #}
      {# ──────────────────────────────────────────────────────── #}
      {% if permissions.can_view_operations %}
      <section id="operations" class="transition-smooth">
        <h3 class="section-heading mb-6">
          <span class="w-1 h-5 bg-blue-500 rounded-full"></span>
          Team Status &amp; Recent Activity
          <span class="ml-2 px-2 py-0.5 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[9px] font-bold">STAFF</span>
        </h3>

        <div class="liquid-trace rounded-2xl p-6" data-accent="electric">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="text-center">
              <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Team Status</div>
              <div class="text-lg font-display font-bold text-emerald-400">{{ team.status|default:"ACTIVE"|upper }}</div>
            </div>
            <div class="text-center">
              <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Roster Size</div>
              <div class="text-lg font-display font-bold text-white">{{ roster.count|default:0 }}</div>
            </div>
            <div class="text-center">
              <div class="text-[9px] font-mono uppercase text-slate-500 mb-1">Visibility</div>
              <div class="text-lg font-display font-bold text-white">{{ team.visibility|default:"PUBLIC" }}</div>
            </div>
          </div>

          <div class="text-center pt-4 border-t border-white/10">
            <a href="{% url 'organizations:team_manage' team.slug %}" class="inline-flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-[var(--team-primary)] hover:underline">
              Open Team HQ for full operations →
            </a>
          </div>
        </div>
      </section>
      {% endif %}

    </div>

    {# ── RIGHT COLUMN (4 cols — Sidebar) ──────────────────────── #}
    <div class="lg:col-span-4 flex flex-col gap-6" id="dc-sidebar">

      {# ── Widget 1: Team Information ─────────────────────────── #}
      <div class="sidebar-widget" data-accent="team">
        <h4 class="sidebar-widget__title">Team Info</h4>
        <dl class="space-y-3 text-sm">
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Status</dt>
            <dd class="font-medium">
              {% if team.status == 'active' or team.status == 'ACTIVE' %}
                <span class="text-emerald-400">● Active</span>
              {% else %}
                <span class="text-slate-400">{{ team.status|default:"Active"|title }}</span>
              {% endif %}
            </dd>
          </div>
          {% if team.founded_date %}
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Founded</dt>
            <dd class="text-white font-medium">{{ team.founded_date }}</dd>
          </div>
          {% endif %}
          {% if team.game.name %}
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Primary Game</dt>
            <dd class="text-white font-medium">{{ team.game.name }}</dd>
          </div>
          {% endif %}
          {% if organization %}
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Organization</dt>
            <dd class="text-white font-medium flex items-center gap-1.5">
              {% if organization.logo_url %}
              <img src="{{ organization.logo_url }}" alt="" class="w-4 h-4 rounded object-cover">
              {% endif %}
              <a href="{{ organization.url }}" class="hover:text-[var(--team-primary)] transition">{{ organization.name }}</a>
              {% if organization.is_verified %}
              <svg class="w-3.5 h-3.5 text-indigo-400 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
              {% endif %}
            </dd>
          </div>
          {% if organization.empire_score %}
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Empire Score</dt>
            <dd class="text-amber-400 font-bold">{{ organization.empire_score|intcomma }}{% if organization.global_rank %} <span class="text-xs text-white/40 font-normal">#{{ organization.global_rank }}</span>{% endif %}</dd>
          </div>
          {% endif %}
          {% endif %}
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Team Type</dt>
            <dd class="text-white font-medium">
              {% if organization %}
              <span class="inline-flex items-center gap-1 text-indigo-400">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21V7a2 2 0 012-2h14a2 2 0 012 2v14M9 21V9h6v12"/></svg>
                Organization Team
              </span>
              {% else %}
              {{ team.team_type|default:"Independent"|title }}
              {% endif %}
            </dd>
          </div>
          <div class="flex items-center justify-between">
            <dt class="text-slate-500 text-xs">Members</dt>
            <dd class="text-white font-medium">{{ roster.count|default:0 }}</dd>
          </div>
        </dl>
      </div>

      {# ── Widget 2: Connect (Social Links) ───────────────────── #}
      {% if streams and ui.enable_streams %}
      <div class="sidebar-widget">
        <h4 class="sidebar-widget__title">Connect</h4>
        <div class="flex flex-wrap gap-2">
          {% for stream in streams %}
            <a href="{{ stream.url }}" target="_blank" rel="noopener noreferrer"
               class="flex-1 min-w-[80px] h-10 rounded-lg flex items-center justify-center gap-2 text-xs font-bold uppercase tracking-wider transition hover-glow
               {% if stream.platform == 'twitch' %}bg-[#9146FF]/20 border border-[#9146FF]/30 text-[#9146FF] hover:bg-[#9146FF]/30
               {% elif stream.platform == 'twitter' %}bg-white/5 border border-white/20 text-white hover:bg-white/10
               {% elif stream.platform == 'youtube' %}bg-[#FF0000]/20 border border-[#FF0000]/30 text-[#FF0000] hover:bg-[#FF0000]/30
               {% elif stream.platform == 'instagram' %}bg-[#E4405F]/20 border border-[#E4405F]/30 text-[#E4405F] hover:bg-[#E4405F]/30
               {% else %}bg-white/5 border border-white/10 text-white hover:bg-white/10
               {% endif %}">
              {{ stream.platform|title }}
            </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {# ── Widget 3: Join the Ranks (Recruitment) ─────────────── #}
      {% if not permissions.is_member %}
      <div class="relative group sidebar-widget border-[var(--team-primary)]/30 hover:border-[var(--team-primary)]/50 overflow-hidden">
        <div class="absolute top-0 right-0 w-40 h-40 opacity-5 pointer-events-none" style="background: radial-gradient(circle, var(--team-primary), transparent 70%)"></div>
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-sm font-display font-bold text-white">Join the Ranks</h4>
          <span class="text-[9px] font-mono font-bold uppercase tracking-widest text-emerald-400 animate-pulse">Open</span>
        </div>
        <p class="text-xs text-slate-400 mb-4">Interested in competing? This team is looking for talented players.</p>
        {% if pending_actions.can_request_to_join %}
          <button type="button" class="w-full h-10 rounded-xl bg-[var(--team-primary)] text-black font-bold uppercase text-[10px] tracking-[0.18em] hover:brightness-110 transition shadow-[0_0_22px_var(--team-glow)]" disabled title="Applications coming soon">
            Apply for Tryouts
          </button>
        {% elif pending_actions.has_pending_invite %}
          <div class="w-full h-10 rounded-xl bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 font-bold uppercase text-[10px] tracking-[0.18em] flex items-center justify-center">
            Invite Pending
          </div>
        {% else %}
          <div class="w-full h-10 rounded-xl bg-white/5 border border-white/10 text-slate-500 font-bold uppercase text-[10px] tracking-[0.18em] flex items-center justify-center">
            Applications Closed
          </div>
        {% endif %}
      </div>
      {% endif %}

      {# ── Widget 4: Match History ────────────────────────────── #}
      <div class="sidebar-widget">
        <h4 class="sidebar-widget__title">Match History</h4>
        <div class="text-center py-6">
          <svg class="w-10 h-10 mx-auto text-slate-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
          <p class="text-xs text-slate-500">No match history yet</p>
        </div>
      </div>

      {# ── Widget 5: Trophy Cabinet ───────────────────────────── #}
      <div class="sidebar-widget">
        <h4 class="sidebar-widget__title">Trophy Cabinet</h4>
        <div class="text-center py-6">
          <div class="text-4xl mb-2 opacity-30">🏆</div>
          <p class="text-xs text-slate-500">No trophies earned yet</p>
          <p class="text-[10px] text-slate-600 mt-1">Win tournaments to fill this cabinet</p>
        </div>
      </div>

      {# ── Widget 6: Highlights & Media ───────────────────────── #}
      <div class="sidebar-widget" id="media">
        <h4 class="sidebar-widget__title">Highlights &amp; Media</h4>
        <div class="text-center py-6">
          <svg class="w-10 h-10 mx-auto text-slate-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          <p class="text-xs text-slate-500">No media highlights yet</p>
          <p class="text-[10px] text-slate-600 mt-1">Team clips and highlights will appear here</p>
        </div>
      </div>

      {# ── Widget 7: Pending Actions (Member Only) ────────────── #}
      {% if viewer.is_authenticated and pending_actions.has_pending_invite %}
      <div class="sidebar-widget border-[var(--team-primary)]/30" id="dc-sidebar-invite">
        <h4 class="sidebar-widget__title text-[var(--team-primary)]">Action Required</h4>
        <p class="text-sm text-slate-300 mb-4">You have a pending invitation to join <strong class="text-white">{{ team.name }}</strong>.</p>
        <div class="flex gap-2" id="dc-sidebar-invite-actions">
          <button onclick="dcInviteAction('accept')" class="flex-1 h-10 rounded-xl bg-emerald-500/15 border border-emerald-500/30 text-emerald-300 font-bold uppercase text-[10px] tracking-[0.18em] hover:bg-emerald-500/25 transition flex items-center justify-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
            Accept
          </button>
          <button onclick="dcInviteAction('decline')" class="flex-1 h-10 rounded-xl bg-white/5 border border-white/10 text-slate-400 font-bold uppercase text-[10px] tracking-[0.18em] hover:bg-red-500/10 hover:text-red-400 transition flex items-center justify-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
            Decline
          </button>
        </div>
        <div id="dc-sidebar-invite-msg" class="hidden mt-3 text-center text-xs font-bold"></div>
      </div>
      {% endif %}

    </div>

  </div>
</main>

{# ══════════════════════════════════════════════════════════════════ #}
{# ORG FOOTER ATTRIBUTION (Phase 4)                                   #}
{# ══════════════════════════════════════════════════════════════════ #}
{% if organization %}
<section class="border-t border-white/10 bg-[#050507] py-8">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6 flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      {% if organization.logo_url %}
      <img src="{{ organization.logo_url }}" alt="{{ organization.name }}" class="h-8 w-8 rounded-lg object-cover opacity-50" />
      {% endif %}
      <div>
        <p class="text-xs text-slate-500">A team managed by</p>
        <a href="{{ organization.url }}" class="text-sm font-bold text-white/60 hover:text-white transition">
          {{ organization.name }}
          {% if organization.is_verified %}
          <svg class="w-3.5 h-3.5 text-indigo-400 inline-block -mt-0.5 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
          {% endif %}
        </a>
      </div>
    </div>
    {% if organization.empire_score %}
    <div class="flex items-center gap-2">
      <span class="text-[10px] font-mono uppercase text-amber-500/50 tracking-wider">Empire Score</span>
      <span class="text-sm font-bold text-amber-400">{{ organization.empire_score|intcomma }}</span>
    </div>
    {% endif %}
  </div>
</section>
{% endif %}

{# ══════════════════════════════════════════════════════════════════ #}
{# PARTNERS BAR                                                      #}
{# ══════════════════════════════════════════════════════════════════ #}
{% if partners %}
<section class="border-t border-white/10 bg-[#050507] py-12">
  <div class="max-w-[1600px] mx-auto px-4 sm:px-6">
    <p class="text-[10px] text-center text-slate-600 font-mono uppercase tracking-[0.2em] mb-8">Partners</p>
    <div class="flex flex-wrap justify-center items-center gap-8 md:gap-16 opacity-50 grayscale hover:grayscale-0 transition-all duration-500">
      {% for partner in partners %}
        <a href="{{ partner.url }}" target="_blank" rel="noopener noreferrer" class="has-tooltip" data-tooltip="{{ partner.name }}">
          {% if partner.logo_url %}
            <img src="{{ partner.logo_url }}" alt="{{ partner.name }}" class="h-8 md:h-10 object-contain" loading="lazy" />
          {% else %}
            <span class="text-xl font-display font-bold text-white tracking-tighter">{{ partner.name }}</span>
          {% endif %}
        </a>
      {% endfor %}
    </div>
  </div>
</section>
{% endif %}

</div>{# /relative z-10 #}

{# ══════════════════════════════════════════════════════════════════ #}
{# PLAYER POPUP MODAL                                                #}
{# ══════════════════════════════════════════════════════════════════ #}
<div id="dc-player-popup" class="fixed inset-0 z-[9999] hidden" role="dialog" aria-modal="true">
  {# Backdrop #}
  <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="dcClosePlayerPopup()"></div>
  {# Card #}
  <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-[340px] max-w-[92vw]">
    <div class="relative rounded-3xl bg-[#0C0C14] border border-white/12 shadow-2xl overflow-hidden">
      {# Close #}
      <button onclick="dcClosePlayerPopup()" class="absolute top-3 right-3 z-20 w-8 h-8 rounded-full bg-black/50 backdrop-blur border border-white/10 flex items-center justify-center text-white/60 hover:text-white transition">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      {# Hero image area #}
      <div class="relative h-48 bg-gradient-to-b from-[var(--team-dim)] to-[#0C0C14]">
        <img id="pp-avatar" src="" alt="" class="w-full h-full object-cover opacity-60" />
        <div class="absolute inset-0 bg-gradient-to-t from-[#0C0C14] via-[#0C0C14]/40 to-transparent"></div>
      </div>
      {# Player info #}
      <div class="relative px-5 pb-5 -mt-10">
        <div id="pp-player-role" class="text-[9px] font-mono font-bold uppercase tracking-[0.18em] text-[var(--team-primary)] mb-1"></div>
        <h3 id="pp-name" class="text-2xl font-display font-bold text-white mb-2 truncate"></h3>
        <div class="flex items-center gap-2 flex-wrap mb-4">
          <span id="pp-role-chip" class="chip"></span>
          <span id="pp-captain-chip" class="chip hidden" style="background: rgba(234,179,8,0.15); color: #EAB308; border-color: rgba(234,179,8,0.25);">Captain</span>
        </div>
        <div class="flex items-center gap-2 text-xs text-slate-400 mb-5">
          <svg class="w-3.5 h-3.5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <span>@<span id="pp-username"></span></span>
          <span class="text-white/15">·</span>
          <span>Member of <b class="text-white">{{ team.name }}</b></span>
        </div>
        <a id="pp-profile-link" href="#" class="flex items-center justify-center gap-2 w-full h-11 rounded-xl bg-[var(--team-primary)]/15 border border-[var(--team-primary)]/25 text-[var(--team-primary)] text-xs font-bold uppercase tracking-[0.15em] hover:bg-[var(--team-primary)]/25 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          View Full Profile
        </a>
      </div>
    </div>
  </div>
</div>

{# ══════════════════════════════════════════════════════════════════ #}
{# BODY-SCOPED STYLES                                                #}
{# ══════════════════════════════════════════════════════════════════ #}
<style>
  .btn-primary {
    @apply h-11 px-6 bg-[var(--team-primary)] text-black font-bold uppercase text-[10px] tracking-[0.18em] rounded-xl hover:brightness-110 transition shadow-[0_0_22px_var(--team-glow)];
  }
  .btn-secondary {
    @apply h-11 w-11 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 transition flex items-center justify-center text-slate-200;
  }
</style>
