{% load static %}
{% comment %}
Sidebar — Team branding, 9-section navigation with role gating, quick actions, roster snapshot.
Drawer on mobile, fixed on desktop.
{% endcomment %}
<aside id="sidebar"
    class="fixed inset-y-0 left-0 z-50 w-[85vw] max-w-[320px] lg:w-[320px] border-r border-line overflow-y-auto
           -translate-x-[110%] lg:translate-x-0 lg:relative transition-transform duration-300
           bg-gradient-to-b from-[var(--bg0)] via-[var(--bg1)] to-black/95">

    {# Close button (mobile) #}
    <button id="closeSidebar" aria-label="Close navigation menu"
        class="absolute top-3 right-3 lg:hidden w-10 h-10 grid place-items-center rounded-xl bg-white/8 hover:bg-white/12 transition">
        <i data-lucide="x" class="w-4 h-4"></i>
    </button>

    {# ── Team Header ── #}
    <div class="p-5 pt-6 pb-4 border-b border-line">
        <a href="/teams/{{ team.slug }}/" class="group flex items-center gap-3">
            <div class="h-12 w-12 rounded-2xl overflow-hidden border border-white/15 bg-white/10 grid place-items-center shrink-0"
                 style="box-shadow:0 0 26px color-mix(in oklab,var(--team-primary) 38%,transparent)">
                {% if team.logo and team.logo.url %}
                <img src="{{ team.logo.url }}" alt="{{ team.name }}" class="w-full h-full object-cover">
                {% else %}
                <span class="text-lg font-black leading-none"
                      style="background:linear-gradient(135deg,var(--team-primary),var(--team-accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent">{{ team.tag|default:team.name|truncatechars:3 }}</span>
                {% endif %}
            </div>
            <div class="min-w-0">
                <h1 class="text-sm font-bold truncate group-hover:text-white transition text-white/90">{{ team.name }}</h1>
                <p class="text-[11px] text-white/60 truncate">
                    [{{ team.tag }}]  &middot;  {{ game_display }}
                </p>
            </div>
        </a>
        {% if team.organization %}
        <div class="mt-2 flex items-center gap-2 px-1">
            <div class="h-5 w-5 rounded bg-white/10 grid place-items-center overflow-hidden shrink-0">
                {% if org_context.logo_url %}
                <img src="{{ org_context.logo_url }}" alt="" class="w-full h-full object-cover">
                {% else %}
                <i data-lucide="building-2" class="w-3 h-3 text-white/50"></i>
                {% endif %}
            </div>
            <span class="text-[10px] text-white/50 truncate">Part of <span class="text-white/70 font-medium">{{ team.organization.name }}</span></span>
            {% if org_context.is_verified %}
            <i data-lucide="badge-check" class="w-3.5 h-3.5 text-indigo-400 shrink-0" title="Verified Organization"></i>
            {% endif %}
        </div>
        {% if org_context.empire_score %}
        <div class="mt-1.5 flex items-center gap-1.5 px-1">
            <i data-lucide="crown" class="w-3 h-3 text-amber-400"></i>
            <span class="text-[10px] text-amber-400 font-semibold">Empire Score {{ org_context.empire_score }}</span>
            {% if org_context.global_rank %}
            <span class="text-[10px] text-white/40">#{{ org_context.global_rank }} Global</span>
            {% endif %}
        </div>
        {% endif %}
        {% if is_org_ceo or is_admin %}
        <a href="{{ org_control_plane_url }}"
           class="mt-2 flex items-center gap-2 px-2 py-1.5 rounded-lg bg-indigo-500/8 border border-indigo-500/15 hover:bg-indigo-500/15 transition group">
            <i data-lucide="gauge" class="w-3 h-3 text-indigo-400"></i>
            <span class="text-[10px] text-indigo-400 font-medium group-hover:text-indigo-300">Org Control Plane →</span>
        </a>
        {% endif %}
        {% endif %}
    </div>

    {# ── Navigation ── #}
    <nav class="p-3 space-y-0.5" aria-label="Team management navigation">
        {# ── Operations ── #}
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 pt-1 pb-1.5">Operations</p>

        <a data-route="command" href="#command"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="layout-dashboard" class="w-4 h-4 text-purple-400"></i>
            </div>
            <span>Command Center</span>
        </a>

        <a data-route="roster" href="#roster"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="users" class="w-4 h-4 text-cyan-400"></i>
            </div>
            <span>Roster Ops</span>
        </a>

        {% if is_admin or is_owner %}
        <a data-route="join-requests" href="#join-requests"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6 relative">
                <i data-lucide="user-plus" class="w-4 h-4 text-emerald-400"></i>
            </div>
            <span>Scouting Grounds</span>
        </a>
        {% endif %}

        <a data-route="competition" href="#competition"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="trophy" class="w-4 h-4 text-amber-400"></i>
            </div>
            <span>Competition Hub</span>
        </a>

        <a data-route="training" href="#training"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="crosshair" class="w-4 h-4 text-red-400"></i>
            </div>
            <span>Training Lab</span>
        </a>

        <a data-route="community" href="#community"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="message-square" class="w-4 h-4 text-pink-400"></i>
            </div>
            <span>Community</span>
        </a>

        <a href="#" data-discord-chat="true" data-team-slug="{{ team.slug }}"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition group"
           data-route="discord">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-indigo-500/15">
                <i data-lucide="message-circle" class="w-4 h-4 text-indigo-400"></i>
            </div>
            <span>Discord</span>
            {% if team.discord_bot_active %}
            <span class="ml-auto h-2 w-2 rounded-full bg-emerald-400 animate-pulse" title="Bot connected"></span>
            {% endif %}
        </a>

        {# ── Management (admin/coach sections) ── #}
        {% if is_admin or is_coach %}
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 pt-4 pb-1.5">Management</p>
        {% endif %}

        {% if is_admin %}
        <a data-route="profile" href="#profile"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="palette" class="w-4 h-4 text-emerald-400"></i>
            </div>
            <span>Team Profile</span>
        </a>
        {% endif %}

        {% if is_owner %}
        <a data-route="settings" href="#settings"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="settings" class="w-4 h-4 text-amber-400"></i>
            </div>
            <span>Settings</span>
        </a>
        {% endif %}

        {# ── Intelligence (per Plan Section 4.1: Treasury visible to OWNER/MANAGER/COACH/PLAYER) ── #}
        {% if is_admin or is_coach or is_member %}
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 pt-4 pb-1.5">Intelligence</p>

        <a data-route="treasury" href="#treasury"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="wallet" class="w-4 h-4 text-yellow-400"></i>
            </div>
            <span>Treasury</span>
        </a>
        {% endif %}

        {% if is_admin or is_owner %}
        <a data-route="achievements" href="#achievements"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="trophy" class="w-4 h-4 text-amber-400"></i>
            </div>
            <span>Trophy Cabinet</span>
        </a>

        <a data-route="store" href="#store"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="shopping-bag" class="w-4 h-4 text-violet-400"></i>
            </div>
            <span>Team Store</span>
        </a>

        <a data-route="sponsors" href="#sponsors"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="handshake" class="w-4 h-4 text-teal-400"></i>
            </div>
            <span>Sponsors</span>
        </a>
        {% endif %}

        {% if is_admin or is_coach %}
        <a data-route="history" href="#history"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="scroll-text" class="w-4 h-4 text-slate-400"></i>
            </div>
            <span>History</span>
        </a>
        {% endif %}

        {# ── Resources ── #}
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 pt-4 pb-1.5">Resources</p>

        <a data-route="guide" href="#guide"
           class="nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl border border-transparent text-sm font-medium hover:bg-white/6 transition">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-white/6">
                <i data-lucide="book-open" class="w-4 h-4 text-teal-400"></i>
            </div>
            <span>Guide &amp; Rules</span>
        </a>
    </nav>

    {# ── Quick Actions ── #}
    <div class="px-3 py-4 border-t border-line mt-2">
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 mb-2">Quick Actions</p>

        {% if can_manage_roster %}
        <button onclick="ManageHQ.openInviteModal()"
            class="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium hover:bg-white/6 transition group">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-purple-500/15 border border-purple-500/25">
                <i data-lucide="user-plus" class="w-4 h-4 text-purple-400"></i>
            </div>
            <span class="text-white/80 group-hover:text-white">Invite Player</span>
        </button>
        {% endif %}

        <a href="/teams/{{ team.slug }}/"
            class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium hover:bg-white/6 transition group">
            <div class="h-8 w-8 rounded-lg grid place-items-center bg-blue-500/15 border border-blue-500/25">
                <i data-lucide="external-link" class="w-4 h-4 text-blue-400"></i>
            </div>
            <span class="text-white/80 group-hover:text-white">View Public Page</span>
        </a>
    </div>

    {# ── Roster Snapshot ── #}
    <div class="px-3 py-4 border-t border-line">
        <p class="text-[10px] text-white/45 uppercase tracking-wider font-semibold px-3 mb-2">Roster</p>
        <div class="px-3 flex items-center gap-1">
            <div class="flex -space-x-2">
                {% for m in members|slice:":5" %}
                <div class="h-7 w-7 rounded-full border-2 border-[var(--bg0)] bg-white/10 overflow-hidden grid place-items-center"
                     title="{{ m.user.username }}">
                    {% if m.user.profile.avatar %}
                    <img src="{{ m.user.profile.avatar.url }}" alt="" class="w-full h-full object-cover">
                    {% else %}
                    <span class="text-[10px] font-bold">{{ m.user.username|make_list|first|upper }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <span class="text-xs text-white/60 font-medium ml-2">{{ current_roster_size }}/{{ max_roster_size }}</span>
        </div>
    </div>

    {# ── Footer badge ── #}
    <div class="mt-auto p-5 border-t border-line">
        {% if is_org_ceo %}
        <div class="flex items-center gap-2 mb-2">
            <span class="text-[10px] px-2 py-0.5 rounded-full bg-indigo-500/15 text-indigo-400 font-semibold border border-indigo-500/25">
                <i data-lucide="shield" class="w-3 h-3 inline-block -mt-0.5"></i>
                Org Admin
            </span>
            <span class="text-[10px] text-white/30">Full owner-level access</span>
        </div>
        {% endif %}
        <p class="text-[10px] text-white/40 leading-relaxed">
            <span class="font-semibold text-white/50">Team HQ</span> &middot; DeltaCrown Platform
        </p>
    </div>
</aside>
