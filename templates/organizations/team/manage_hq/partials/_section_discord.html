<!-- Discord Integration ‚Äî Setup, Chat Lobby, Announcements, Voice Join.
     Bi-directional sync between DeltaCrown ‚Üî Discord. -->
<section id="discord" class="hq-section space-y-4" aria-label="Discord Integration">

    {# ‚îÄ‚îÄ Discord Setup Card (Admin only) ‚îÄ‚îÄ #}
    {% if is_admin %}
    <div class="rounded-3xl border border-indigo-500/20 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 shadow-soft p-4 sm:p-5 lg:p-6"
         data-discord-invite-url="{{ discord_bot_invite_url }}">

        {# ‚îÄ‚îÄ Header row: title + status + toggle ‚îÄ‚îÄ #}
        <div class="flex items-center justify-between flex-wrap gap-2">
            <h3 class="text-base font-bold flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-400" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286z"/>
                </svg>
                Discord Integration
            </h3>
            <div class="flex items-center gap-3">
                {# ‚îÄ‚îÄ Bot status badge ‚îÄ‚îÄ #}
                <div id="discordBotStatus" class="flex items-center gap-1.5 text-xs">
                    {% if team.discord_bot_active %}
                    <span class="h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
                    <span class="text-emerald-400 font-medium">Bot Online</span>
                    {% else %}
                    <span class="h-2 w-2 rounded-full bg-red-400/60"></span>
                    <span class="text-red-400/80 font-medium">Bot Offline</span>
                    {% endif %}
                </div>
                <button type="button" id="discordConfigToggle"
                        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-[11px] font-semibold bg-white/5 border border-white/10 text-white/60 hover:bg-white/10 hover:text-white/80 transition"
                        aria-controls="discordConfigPanel" aria-expanded="false">
                    <i data-lucide="settings" class="w-3 h-3"></i>
                    <span id="discordConfigToggleLabel">Edit Configuration</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 transition-transform" id="discordConfigChevron"></i>
                </button>
            </div>
        </div>

        <!-- VIEW MODE ‚Äî Rich summary card (visible when collapsed & configured) -->
        <div id="discordConfigSummary" class="mt-4 {% if not team.discord_guild_id %}hidden{% endif %}">
            {# ‚îÄ‚îÄ Connection status hero ‚îÄ‚îÄ #}
            <div id="discordViewHero" class="rounded-2xl border {% if team.discord_bot_active %}border-emerald-500/15 bg-emerald-500/[0.03]{% else %}border-red-500/15 bg-red-500/[0.03]{% endif %} px-4 py-3.5 mb-3">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-xl {% if team.discord_bot_active %}bg-emerald-500/15{% else %}bg-red-500/10{% endif %} grid place-items-center shrink-0">
                        <svg class="w-5 h-5 {% if team.discord_bot_active %}text-emerald-400{% else %}text-red-400{% endif %}" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.79 19.79 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.865-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.618-1.25.077.077 0 00-.079-.037A19.74 19.74 0 003.677 4.37a.07.07 0 00-.032.028C.533 9.046-.32 13.58.099 18.058a.082.082 0 00.031.056c2.053 1.508 4.041 2.423 5.993 3.03a.077.077 0 00.084-.028c.462-.63.873-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.11 13.11 0 01-1.872-.892.077.077 0 01-.008-.128c.126-.094.252-.192.372-.291a.074.074 0 01.078-.01c3.928 1.793 8.18 1.793 12.061 0a.074.074 0 01.079.01c.12.099.245.197.372.291a.077.077 0 01-.006.128 12.3 12.3 0 01-1.873.891.076.076 0 00-.041.107c.36.698.772 1.363 1.225 1.993a.076.076 0 00.084.028c1.961-.607 3.95-1.522 6.002-3.029a.077.077 0 00.031-.055c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.029z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p id="discordViewStatusText" class="text-sm font-bold {% if team.discord_bot_active %}text-emerald-300{% else %}text-red-400{% endif %}">
                            {% if team.discord_bot_active %}‚úÖ Active{% else %}üî¥ Disconnected{% endif %}
                        </p>
                        <p class="text-[11px] text-white/40 mt-0.5 truncate">
                            Linked to Server:
                            <span class="font-mono text-white/50">
                                {% if team.discord_guild_id|length > 8 %}{{ team.discord_guild_id|truncatechars:6 }}‚Ä¶{{ team.discord_guild_id|slice:"-4:" }}{% else %}{{ team.discord_guild_id }}{% endif %}
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            {# ‚îÄ‚îÄ Synced channels grid ‚îÄ‚îÄ #}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2.5">
                {% if team.discord_chat_channel_id %}
                <div class="flex items-center gap-2 rounded-xl bg-indigo-500/5 border border-indigo-500/15 px-3 py-2">
                    <i data-lucide="message-circle" class="w-3.5 h-3.5 text-indigo-400 shrink-0"></i>
                    <span class="text-xs text-indigo-300 truncate">Chat synced</span>
                </div>
                {% endif %}
                {% if team.discord_voice_channel_id %}
                <div class="flex items-center gap-2 rounded-xl bg-emerald-500/5 border border-emerald-500/15 px-3 py-2">
                    <i data-lucide="headphones" class="w-3.5 h-3.5 text-emerald-400 shrink-0"></i>
                    <span class="text-xs text-emerald-300 truncate">Voice ready</span>
                </div>
                {% endif %}
                {% if team.discord_announcement_channel_id %}
                <div class="flex items-center gap-2 rounded-xl bg-amber-500/5 border border-amber-500/15 px-3 py-2">
                    <i data-lucide="megaphone" class="w-3.5 h-3.5 text-amber-400 shrink-0"></i>
                    <span class="text-xs text-amber-300 truncate">Announcements on</span>
                </div>
                {% endif %}
                {% if team.discord_webhook_url %}
                <div class="flex items-center gap-2 rounded-xl bg-violet-500/5 border border-violet-500/15 px-3 py-2">
                    <i data-lucide="webhook" class="w-3.5 h-3.5 text-violet-400 shrink-0"></i>
                    <span class="text-xs text-violet-300 truncate">Webhook ‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                </div>
                {% endif %}
                {% if team.discord_captain_role_id %}
                <div class="flex items-center gap-2 rounded-xl bg-yellow-500/5 border border-yellow-500/15 px-3 py-2">
                    <i data-lucide="shield" class="w-3.5 h-3.5 text-yellow-400 shrink-0"></i>
                    <span class="text-xs text-yellow-300 truncate">Captain role synced</span>
                </div>
                {% endif %}
                {% if team.discord_manager_role_id %}
                <div class="flex items-center gap-2 rounded-xl bg-yellow-500/5 border border-yellow-500/15 px-3 py-2">
                    <i data-lucide="shield-check" class="w-3.5 h-3.5 text-yellow-400 shrink-0"></i>
                    <span class="text-xs text-yellow-300 truncate">Manager role synced</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- EDIT MODE ‚Äî Config form (hidden by default if already configured) -->
        <div id="discordConfigPanel" class="{% if team.discord_guild_id %}hidden{% endif %} mt-4">

            {# ‚îÄ‚îÄ ü§ñ Connect Bot CTA ‚Äî Top of Edit Mode ‚îÄ‚îÄ #}
            {% if discord_bot_invite_url %}
            <div class="rounded-2xl border border-indigo-500/20 bg-indigo-500/[0.06] px-4 py-4 mb-5">
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                    <div class="h-10 w-10 rounded-xl bg-indigo-500/20 grid place-items-center shrink-0">
                        <span class="text-lg">ü§ñ</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-indigo-300">Step 1: Connect Bot to your Server</p>
                        <p class="text-[11px] text-white/40 mt-0.5">Authorize the DeltaCrown bot in your Discord server. You must have "Manage Server" permissions.</p>
                    </div>
                    <a href="{{ discord_bot_invite_url }}" target="_blank" rel="noopener"
                       id="discordConnectBotBtn"
                       class="flex items-center gap-2 px-4 py-2.5 rounded-xl bg-indigo-500 text-white text-sm font-bold hover:bg-indigo-400 transition shadow-lg shadow-indigo-500/25 shrink-0">
                        <span>ü§ñ</span>
                        Connect Bot to Server
                        <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                    </a>
                </div>
            </div>
            {% endif %}

            {# ‚îÄ‚îÄ How to Connect ‚Äî Collapsible Guide ‚îÄ‚îÄ #}
            <details id="discordHowToGuide" class="rounded-2xl border border-indigo-500/15 bg-indigo-500/[0.03] mb-5 group">
                <summary class="flex items-center gap-2.5 px-4 py-3 cursor-pointer select-none list-none [&::-webkit-details-marker]:hidden">
                    <span class="text-lg leading-none">üìö</span>
                    <span class="text-sm font-bold text-indigo-300 flex-1">How to find your IDs</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-white/30 transition-transform group-open:rotate-90"></i>
                </summary>
                <div class="px-4 pb-4 pt-1 space-y-4 border-t border-indigo-500/10">

                    {# Step 1 #}
                    <div class="flex gap-3">
                        <div class="h-7 w-7 rounded-lg bg-indigo-500/15 grid place-items-center shrink-0 mt-0.5">
                            <span class="text-xs font-black text-indigo-400">1</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white/80 mb-1">Enable Developer Mode</p>
                            <p class="text-[11px] text-white/45 leading-relaxed">
                                Open Discord <strong class="text-white/60">Settings ‚öôÔ∏è</strong> ‚Üí <strong class="text-white/60">Advanced</strong>.<br>
                                Turn <strong class="text-emerald-400">ON</strong> "Developer Mode".<br>
                                <span class="text-white/30 italic">This allows you to right-click and copy IDs.</span>
                            </p>
                        </div>
                    </div>

                    {# Step 2 #}
                    <div class="flex gap-3">
                        <div class="h-7 w-7 rounded-lg bg-indigo-500/15 grid place-items-center shrink-0 mt-0.5">
                            <span class="text-xs font-black text-indigo-400">2</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white/80 mb-1">Copy IDs</p>
                            <div class="text-[11px] text-white/45 leading-relaxed space-y-1.5">
                                <p>
                                    <strong class="text-white/60">Server ID:</strong>
                                    Right-click your <strong class="text-white/60">Server Icon</strong> on the left sidebar ‚Üí click
                                    <span class="inline-block px-1.5 py-0.5 rounded bg-white/10 text-white/70 text-[10px] font-mono">Copy Server ID</span>
                                </p>
                                <p>
                                    <strong class="text-white/60">Channel IDs:</strong>
                                    Right-click the specific channel (e.g. <span class="text-white/60">#general</span>) ‚Üí click
                                    <span class="inline-block px-1.5 py-0.5 rounded bg-white/10 text-white/70 text-[10px] font-mono">Copy Channel ID</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    {# Step 3 #}
                    <div class="flex gap-3">
                        <div class="h-7 w-7 rounded-lg bg-emerald-500/15 grid place-items-center shrink-0 mt-0.5">
                            <span class="text-xs font-black text-emerald-400">3</span>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-white/80 mb-1">Save &amp; Test</p>
                            <p class="text-[11px] text-white/45 leading-relaxed">
                                Paste the IDs below and click <strong class="text-indigo-400">"Save Discord Config"</strong>.<br>
                                If the Bot Status shows <span class="text-emerald-400 font-medium">‚úÖ Active</span>, you're connected!
                            </p>
                        </div>
                    </div>

                    {# Tip bar #}
                    <div class="flex items-start gap-2 rounded-lg bg-amber-500/5 border border-amber-500/15 px-3 py-2">
                        <span class="text-sm leading-none mt-0.5">üí°</span>
                        <p class="text-[11px] text-amber-300/80 leading-relaxed">
                            <strong>Tip:</strong> If you paste a full Discord URL (e.g. <code class="text-[10px] bg-white/5 px-1 rounded">https://discord.com/channels/123/456</code>),
                            we'll automatically extract just the ID number for you.
                        </p>
                    </div>
                </div>
            </details>

            <form id="discordConfigForm" class="space-y-4">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {# Server ID #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Discord Server (Guild) ID</label>
                        <input type="text" name="discord_guild_id"
                               value="{{ team.discord_guild_id }}"
                               placeholder="e.g. 123456789012345678"
                               class="discord-id-input w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                    </div>
                    {# Announcement Channel #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Announcement Channel ID</label>
                        <input type="text" name="discord_announcement_channel_id"
                               value="{{ team.discord_announcement_channel_id }}"
                               placeholder="Channel for team announcements"
                               class="discord-id-input w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                    </div>
                    {# Chat Channel #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Chat Channel ID (Lobby)</label>
                        <input type="text" name="discord_chat_channel_id"
                               value="{{ team.discord_chat_channel_id }}"
                               placeholder="Channel for real-time chat sync"
                               class="discord-id-input w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                    </div>
                    {# Voice Channel #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Voice Channel ID</label>
                        <input type="text" name="discord_voice_channel_id"
                               value="{{ team.discord_voice_channel_id }}"
                               placeholder="Voice channel for one-click join"
                               class="discord-id-input w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {# Community Invite URL (renamed from "Invite Link") #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Community Invite URL</label>
                        <input type="url" name="discord_url" id="discordInviteUrlInput"
                               value="{{ team.discord_url }}"
                               placeholder="https://discord.gg/your-server"
                               pattern="https://(discord\.gg|discord\.com/invite)/[a-zA-Z0-9\-]+"
                               class="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                        <p class="text-[10px] text-white/30 mt-1 leading-relaxed">
                            Paste your public Discord server link (e.g., <code class="bg-white/5 px-1 rounded">https://discord.gg/‚Ä¶</code>).
                            This will be displayed on your Organization Profile so fans can join your community.
                        </p>
                    </div>
                    {# Webhook URL ‚Äî masked by default, revealed on focus #}
                    <div>
                        <label class="block text-xs text-white/50 mb-1.5 font-medium">Webhook URL (optional fallback)
                            {% if team.discord_webhook_url %}<span class="text-[10px] text-amber-400/60 ml-1">üîí Secret</span>{% endif %}
                        </label>
                        <input type="password" name="discord_webhook_url"
                               id="discordWebhookInput"
                               value="{{ team.discord_webhook_url }}"
                               placeholder="https://discord.com/api/webhooks/‚Ä¶"
                               autocomplete="off"
                               class="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                        <button type="button" id="discordWebhookReveal"
                                class="mt-1 text-[10px] text-white/30 hover:text-white/60 transition flex items-center gap-1">
                            <i data-lucide="eye" class="w-3 h-3"></i>
                            <span>Show URL</span>
                        </button>
                    </div>
                </div>

                {# ‚îÄ‚îÄ Role Sync IDs (collapsed subsection) ‚îÄ‚îÄ #}
                <details class="rounded-xl border border-white/8 bg-white/[0.02]">
                    <summary class="flex items-center gap-2 px-3 py-2.5 cursor-pointer select-none list-none [&::-webkit-details-marker]:hidden text-xs font-medium text-white/50 hover:text-white/70 transition">
                        <i data-lucide="shield" class="w-3.5 h-3.5 text-yellow-400/60"></i>
                        <span class="flex-1">Role Sync (optional)</span>
                        <i data-lucide="chevron-right" class="w-3 h-3 text-white/20 transition-transform group-open:rotate-90"></i>
                    </summary>
                    <div class="px-3 pb-3 pt-1 grid grid-cols-1 md:grid-cols-2 gap-3 border-t border-white/5">
                        <div>
                            <label class="block text-[11px] text-white/40 mb-1 font-medium">Captain Role ID</label>
                            <input type="text" name="discord_captain_role_id"
                                   value="{{ team.discord_captain_role_id }}"
                                   placeholder="Assigned to team Captains"
                                   class="discord-id-input w-full rounded-lg border border-white/10 bg-white/5 px-2.5 py-1.5 text-xs text-white placeholder-white/25 focus:border-yellow-500/40 focus:ring-1 focus:ring-yellow-500/20 transition">
                        </div>
                        <div>
                            <label class="block text-[11px] text-white/40 mb-1 font-medium">Manager Role ID</label>
                            <input type="text" name="discord_manager_role_id"
                                   value="{{ team.discord_manager_role_id }}"
                                   placeholder="Assigned to Managers"
                                   class="discord-id-input w-full rounded-lg border border-white/10 bg-white/5 px-2.5 py-1.5 text-xs text-white placeholder-white/25 focus:border-yellow-500/40 focus:ring-1 focus:ring-yellow-500/20 transition">
                        </div>
                        <p class="col-span-full text-[10px] text-white/25 leading-relaxed">
                            Right-click a Role in Server Settings ‚Üí "Copy Role ID". When a member is promoted/demoted, the Discord role is auto-assigned/removed.
                        </p>
                    </div>
                </details>

                <div class="flex items-center gap-3 pt-2">
                    <button type="submit"
                            class="flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold bg-indigo-500/20 text-indigo-300 border border-indigo-500/30 hover:bg-indigo-500/30 transition">
                        <i data-lucide="save" class="w-3.5 h-3.5"></i>
                        Save Discord Config
                    </button>
                    <button type="button" id="discordCancelEditBtn"
                            class="flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold bg-white/5 text-white/50 border border-white/10 hover:bg-white/10 hover:text-white/70 transition {% if not team.discord_guild_id %}hidden{% endif %}">
                        <i data-lucide="x" class="w-3.5 h-3.5"></i>
                        Cancel
                    </button>
                    <button type="button" id="discordTestWebhookBtn"
                            class="flex items-center gap-1.5 px-4 py-2 rounded-xl text-xs font-semibold bg-violet-500/15 text-violet-300 border border-violet-500/25 hover:bg-violet-500/25 transition {% if not team.discord_webhook_url %}hidden{% endif %}"
                            onclick="TeamHQ.testDiscordWebhook()">
                        <i data-lucide="send" class="w-3.5 h-3.5"></i>
                        Test Webhook
                    </button>
                    <span id="discordSaveStatus" class="text-xs text-white/40 hidden">Saved!</span>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Voice Join Button ‚Äî Smart Deep-link (Item 3) ‚îÄ‚îÄ #}
    {% if team.discord_voice_channel_id and team.discord_guild_id %}
    <div class="rounded-2xl border border-emerald-500/20 bg-emerald-500/5 p-4 flex items-center gap-4">
        <div class="h-12 w-12 rounded-xl bg-emerald-500/15 grid place-items-center shrink-0">
            <i data-lucide="headphones" class="w-6 h-6 text-emerald-400"></i>
        </div>
        <div class="flex-1 min-w-0">
            <h4 class="text-sm font-bold text-emerald-300">Voice Channel</h4>
            <p class="text-xs text-white/40 mt-0.5">Join your team's voice comms in Discord</p>
        </div>
        <button type="button"
                class="discord-voice-join flex items-center gap-2 px-4 py-2.5 rounded-xl bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 text-sm font-semibold hover:bg-emerald-500/30 transition shrink-0"
                data-guild-id="{{ team.discord_guild_id }}"
                data-channel-id="{{ team.discord_voice_channel_id }}"
                title="Opens Discord app if installed, otherwise opens in browser">
            <i data-lucide="phone" class="w-4 h-4"></i>
            Join Voice
        </button>
    </div>
    {% endif %}

    {# ‚îÄ‚îÄ Team HQ Chat ‚îÄ‚îÄ #}
    <div class="rounded-3xl border border-line bg-card shadow-soft overflow-hidden">
        <div class="flex items-center justify-between px-4 sm:px-5 py-3 border-b border-line">
            <h3 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="message-circle" class="w-4 h-4 text-indigo-400"></i>
                Team HQ
            </h3>
            <div class="flex items-center gap-2">
                <span id="chatSyncIndicator" class="text-[10px] text-white/30 hidden">
                    <i data-lucide="refresh-cw" class="w-3 h-3 inline-block animate-spin"></i>
                    Syncing‚Ä¶
                </span>
                <span id="chatWsStatus" class="text-[10px] text-emerald-400/60 flex items-center gap-1 hidden">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                    Live
                </span>
                {% if team.discord_chat_channel_id %}
                <span class="text-[10px] text-indigo-400/60 flex items-center gap-1">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.79 19.79 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.865-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.618-1.25.077.077 0 00-.079-.037A19.74 19.74 0 003.677 4.37a.07.07 0 00-.032.028C.533 9.046-.32 13.58.099 18.058a.082.082 0 00.031.056c2.053 1.508 4.041 2.423 5.993 3.03a.078.078 0 00.084-.028c.462-.63.873-1.295 1.226-1.994a.076.076 0 00-.041-.106 13.11 13.11 0 01-1.872-.892.077.077 0 01-.008-.128c.126-.094.252-.192.372-.291a.074.074 0 01.078-.01c3.928 1.793 8.18 1.793 12.061 0a.074.074 0 01.079.01c.12.099.245.197.372.291a.077.077 0 01-.006.128 12.3 12.3 0 01-1.873.891.076.076 0 00-.041.107c.36.698.772 1.363 1.225 1.993a.076.076 0 00.084.028c1.961-.607 3.95-1.522 6.002-3.029a.077.077 0 00.031-.055c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.029z"/></svg>
                    Synced
                </span>
                {% endif %}
            </div>
        </div>

        {# Messages area ‚Äî modern chat bubble layout #}
        <div id="chatMessages"
             class="h-96 overflow-y-auto px-4 sm:px-5 py-3 space-y-1 scroll-smooth"
             data-team-slug="{{ team.slug }}"
             data-team-id="{{ team.pk }}"
             data-current-user-id="{{ request.user.id }}"
             data-current-username="{{ request.user.username }}"
             data-time-format="{% if request.user.is_authenticated %}{{ request.user.profile.time_format|default:'12h' }}{% else %}12h{% endif %}">
            <div class="flex items-center justify-center h-full">
                <p class="text-sm text-white/30">
                    {% if team.discord_chat_channel_id %}
                    Loading messages‚Ä¶
                    {% else %}
                    Configure a chat channel above to enable the lobby.
                    {% endif %}
                </p>
            </div>
        </div>

        {# Input area #}
        <div class="border-t border-line px-4 sm:px-5 py-3">
            <form id="chatSendForm" class="flex items-center gap-2">
                {% csrf_token %}
                <input type="text" id="chatInput"
                       placeholder="Type a message‚Ä¶"
                       maxlength="2000"
                       autocomplete="off"
                       class="flex-1 rounded-2xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm text-white placeholder-white/25 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/30 transition">
                <button type="submit"
                        class="h-10 w-10 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 grid place-items-center text-white hover:from-indigo-400 hover:to-purple-500 transition-all shadow-lg shadow-indigo-500/20 shrink-0">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

</section>