{% load static %}
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <title>{{ team.name|default:"Team" }} — Team HQ</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Team colors */
            --team-primary: {{ team.primary_color|default:"#7c3aed" }};
            --team-accent: {{ team.accent_color|default:"#22c55e" }};

            /* Base surface */
            --bg0: #070a12;
            --bg1: #0b1020;
            --card: rgba(255, 255, 255, .06);
            --card2: rgba(255, 255, 255, .085);
            --line: rgba(255, 255, 255, .12);
            --txt: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .62);
            --shadow: 0 18px 60px rgba(0, 0, 0, .55);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, .18) transparent;
        }

        *::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        *::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .14);
            border-radius: 999px;
        }

        *::-webkit-scrollbar-track {
            background: transparent;
        }

        body {
            background:
                radial-gradient(900px 600px at 12% 8%, color-mix(in oklab, var(--team-primary) 32%, transparent), transparent 55%),
                radial-gradient(800px 560px at 86% 18%, color-mix(in oklab, var(--team-accent) 22%, transparent), transparent 55%),
                radial-gradient(900px 680px at 50% 92%, rgba(59, 130, 246, .14), transparent 60%),
                linear-gradient(180deg, var(--bg0), var(--bg1));
            color: var(--txt);
        }

        .bg-card {
            background: var(--card);
        }

        .bg-card2 {
            background: var(--card2);
        }

        .border-line {
            border-color: var(--line);
        }

        .text-muted {
            color: var(--muted);
        }

        .shadow-soft {
            box-shadow: var(--shadow);
        }

        .hq-section {
            display: none;
        }

        .hq-section.is-active {
            display: block;
        }

        .nav-item[aria-current="page"] {
            background: linear-gradient(135deg,
                    color-mix(in oklab, var(--team-primary) 28%, rgba(255, 255, 255, .06)),
                    rgba(255, 255, 255, .05));
            border-color: color-mix(in oklab, var(--team-primary) 38%, rgba(255, 255, 255, .14));
        }

        /* Safe area for mobile bottom nav */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        /* Mobile-first responsive helpers */
        @media (max-width: 639px) {
            .rounded-3xl { border-radius: 1.25rem; }
        }

        /* xs breakpoint for very small screens */
        @media (min-width: 400px) {
            .xs\:inline { display: inline; }
        }

        /* ── Dark-theme native <select> / <option> fix ─────────── */
        select {
            color-scheme: dark;
        }
        select option {
            background-color: #131a2e;
            color: #e5e7eb;
        }
        select option:checked {
            background-color: #2563eb;
            color: #fff;
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="scrim" class="fixed inset-0 bg-black/60 hidden z-40"></div>

    <div class="min-h-screen grid lg:grid-cols-[320px_1fr]">
        {% include "organizations/team/manage_hq/partials/_sidebar.html" %}
        
        <main class="min-h-screen lg:pl-0">
            {% include "organizations/team/manage_hq/partials/_topbar.html" %}
            
            <div class="mx-3 lg:mx-6 mt-4 lg:mt-6 pb-20 lg:pb-24">
                <div class="mt-5 space-y-4">
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
        </main>
    </div>

    {% include "organizations/team/manage_hq/partials/_mobile_nav.html" %}

    <script>
        lucide.createIcons();

        const sidebar = document.getElementById('sidebar');
        const scrim = document.getElementById('scrim');
        const openSidebarBtn = document.getElementById('openSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        const pageTitle = document.getElementById('pageTitle');
        const pageSub = document.getElementById('pageSub');

        const ROUTES = {
            command:     { title: "Command Center",      sub: "Real-time team overview" },
            roster:      { title: "Roster Ops",          sub: "Players & staff management" },
            'join-requests': { title: "Scouting Grounds", sub: "Recruit talent & review applications" },
            competition: { title: "Competition Hub",     sub: "Tournaments & matches" },
            training:    { title: "Training Lab",        sub: "Practice & scrims" },
            community:   { title: "Community & Media",   sub: "Announcements & content" },
            profile:     { title: "Team Profile",        sub: "Public identity editor" },
            settings:    { title: "Settings & Security", sub: "Visibility & danger zone" },
            treasury:    { title: "Treasury & Economy",  sub: "Prizes, fees & wallet" },
            achievements:{ title: "Trophy Cabinet",      sub: "Awards & achievements" },
            store:       { title: "Team Store",          sub: "Merch & digital items" },
            sponsors:    { title: "Sponsors & Partners", sub: "Brand affiliations & partnerships" },
            history:     { title: "History & Archive",   sub: "Activity log & timeline" },
            guide:       { title: "Guide & Rules",       sub: "Platform rulebook & team handbook" },
        };

        function openSidebar() {
            sidebar.classList.remove('-translate-x-[110%]');
            scrim.classList.remove('hidden');
        }
        
        function closeSidebar() {
            sidebar.classList.add('-translate-x-[110%]');
            scrim.classList.add('hidden');
        }

        function setActiveRoute(route) {
            document.querySelectorAll('.hq-section').forEach(sec => {
                sec.classList.toggle('is-active', sec.id === route);
            });

            document.querySelectorAll('.nav-item').forEach(a => {
                const isActive = a.dataset.route === route;
                if (isActive) a.setAttribute('aria-current', 'page');
                else a.removeAttribute('aria-current');
            });

            const meta = ROUTES[route] || ROUTES.command;
            if (pageTitle) pageTitle.textContent = meta.title;
            if (pageSub) pageSub.textContent = meta.sub;

            // Update breadcrumb
            const bc = document.getElementById('breadcrumbSection');
            if (bc) bc.textContent = meta.title;

            // Update dynamic topbar quick actions
            updateTopbarActions(route);

            if (location.hash.replace('#', '') !== route) {
                history.replaceState(null, '', '#' + route);
            }

            if (window.matchMedia('(max-width: 1023px)').matches) {
                closeSidebar();
            }

            // Update mobile nav active state
            // Routes that live under More menu (not in the main 4 bottom buttons)
            const MORE_ROUTES = new Set(['competition', 'profile', 'settings', 'treasury', 'achievements', 'store', 'sponsors', 'history', 'guide']);
            const isMoreRoute = MORE_ROUTES.has(route);
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                const btnRoute = btn.dataset.route;
                let isActive = false;
                if (btnRoute === 'more') {
                    isActive = isMoreRoute;
                } else {
                    isActive = btnRoute === route;
                }
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('text-white/40', !isActive);
            });
        }

        // Dynamic quick actions per section
        const TOPBAR_ACTIONS = {
            command: [
                { label: 'Invite Player', icon: 'user-plus', onclick: "ManageHQ.openInviteModal()", color: 'cyan' },
            ],
            roster: [
                { label: 'Invite', icon: 'user-plus', onclick: "ManageHQ.openInviteModal()", color: 'blue' },
            ],
            competition: [
                { label: 'Find Tournament', icon: 'trophy', onclick: "setActiveRoute('competition')", color: 'amber' },
            ],
            training: [
                { label: 'New Session', icon: 'calendar-plus', onclick: "ManageHQ.Training.openScheduleModal()", color: 'cyan' },
                { label: 'Post LFG', icon: 'radar', onclick: "ManageHQ.Training.openScrimModal()", color: 'emerald' },
                { label: 'Add VOD', icon: 'video', onclick: "ManageHQ.Training.openVodModal()", color: 'purple' },
            ],
            community: [
                { label: 'New Post', icon: 'pen-line', onclick: "ManageHQ.Community.openPostModal()", color: 'pink' },
                { label: 'Upload', icon: 'image-plus', onclick: "ManageHQ.Community.openMediaUpload()", color: 'violet' },
                { label: 'Highlight', icon: 'play', onclick: "ManageHQ.Community.openHighlightModal()", color: 'rose' },
            ],
            profile: [
                { label: 'View Public', icon: 'external-link', onclick: "window.open('/teams/{{ team.slug|escapejs }}/', '_blank')", color: 'white' },
            ],
            settings: [],
            treasury: [],
            achievements: [
                { label: 'Add Trophy', icon: 'trophy', onclick: "TrophyManager.openForm()", color: 'amber' },
            ],
            store: [
                { label: 'Add Item', icon: 'shopping-bag', onclick: "MerchStore.openForm()", color: 'violet' },
            ],
            history: [],
            guide: [],
        };

        function updateTopbarActions(route) {
            const container = document.getElementById('topbarActions');
            if (!container) return;
            const actions = TOPBAR_ACTIONS[route] || [];
            if (!actions.length) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            container.innerHTML = actions.map(a => `
                <button onclick="${a.onclick}"
                    class="flex items-center gap-1.5 px-2.5 py-1.5 rounded-xl text-[11px] font-semibold bg-${a.color}-500/15 text-${a.color}-400 border border-${a.color}-500/20 hover:bg-${a.color}-500/25 transition whitespace-nowrap">
                    <i data-lucide="${a.icon}" class="w-3 h-3"></i>
                    <span class="hidden md:inline">${a.label}</span>
                </button>
            `).join('');
            if (window.lucide) lucide.createIcons({ nodes: [container] });
        }

        document.querySelectorAll('.nav-item').forEach(a => {
            a.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveRoute(a.dataset.route);
            });
        });

        openSidebarBtn?.addEventListener('click', openSidebar);
        closeSidebarBtn?.addEventListener('click', closeSidebar);
        scrim?.addEventListener('click', closeSidebar);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSidebar();
        });

        const initialRoute = (location.hash || '#command').replace('#', '');
        setActiveRoute(document.getElementById(initialRoute) ? initialRoute : 'command');
    </script>

    <!-- Manage HQ config & controller -->
    <script>
        window.MANAGE_HQ = {
            slug: "{{ team.slug|escapejs }}",
            csrfToken: "{{ csrf_token }}",
            teamName: "{{ team.name|escapejs }}",
        };
    </script>
    <script src="{% static 'organizations/js/team-manage-hq.js' %}"></script>
</body>
</html>
