{# SECTION: Scouting Grounds ‚Äî Smart Recruitment Hub (5-Point 1A/1B) #}
{# Route: #join-requests                                             #}
{# Features:                                                         #}
{#   ‚Ä¢ Recruitment Post builder (positions + requirements CRUD)        #}
{#   ‚Ä¢ Tryout Manager workflow (Schedule ‚Üí Complete ‚Üí Offer ‚Üí Sign)   #}
{#   ‚Ä¢ Recruitment profile & stats                                    #}
{% if is_admin or is_owner %}
<section id="join-requests" class="hq-section space-y-6">

    {# ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
            <h1 class="text-2xl font-display font-bold tracking-tight flex items-center gap-2">
                <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                Scouting Grounds
            </h1>
            <p class="text-sm text-white/40 mt-0.5">Recruit talent for <span class="text-white/60 font-medium">{{ team.name }}</span></p>
        </div>
        <div class="flex items-center gap-3">
            <span id="jr-count-badge" class="hidden text-xs font-bold px-3 py-1.5 rounded-full bg-emerald-500/15 text-emerald-400 border border-emerald-500/20">
                <span id="jr-count-num">0</span> active
            </span>
            <button onclick="ScoutingGrounds.refresh()" class="h-9 px-4 rounded-xl bg-white/5 border border-white/10 text-xs font-bold uppercase tracking-wider text-white/60 hover:bg-white/10 transition flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
            </button>
        </div>
    </div>

    {# ‚îÄ‚îÄ Tab Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
    <div class="flex border-b border-white/10 gap-0">
        <button onclick="ScoutingGrounds.switchTab('pipeline')" id="sg-tab-pipeline"
            class="sg-tab sg-tab--active px-5 py-2.5 text-xs font-bold uppercase tracking-wider border-b-2 transition">
            <svg class="w-3.5 h-3.5 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Pipeline
        </button>
        <button onclick="ScoutingGrounds.switchTab('jobpost')" id="sg-tab-jobpost"
            class="sg-tab px-5 py-2.5 text-xs font-bold uppercase tracking-wider border-b-2 border-transparent text-white/40 hover:text-white/60 transition">
            <svg class="w-3.5 h-3.5 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Recruitment Post
        </button>
        <button onclick="ScoutingGrounds.switchTab('profile')" id="sg-tab-profile"
            class="sg-tab px-5 py-2.5 text-xs font-bold uppercase tracking-wider border-b-2 border-transparent text-white/40 hover:text-white/60 transition">
            <svg class="w-3.5 h-3.5 inline -mt-0.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            Profile
        </button>
    </div>

    {# TAB 1: APPLICATION PIPELINE ‚Äî Tryout Manager       #}
    <div id="sg-panel-pipeline" class="sg-panel">

        {# Stats Row #}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-5">
            <div class="rounded-xl border border-white/10 bg-white/[0.03] p-3 text-center">
                <div class="text-xl font-display font-bold text-white" id="jr-stat-total">--</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-0.5">Total</div>
            </div>
            <div class="rounded-xl border border-amber-500/15 bg-amber-500/[0.03] p-3 text-center">
                <div class="text-xl font-display font-bold text-amber-400" id="jr-stat-pending">--</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-0.5">Pending</div>
            </div>
            <div class="rounded-xl border border-blue-500/15 bg-blue-500/[0.03] p-3 text-center">
                <div class="text-xl font-display font-bold text-blue-400" id="jr-stat-tryouts">--</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-0.5">In Tryouts</div>
            </div>
            <div class="rounded-xl border border-emerald-500/15 bg-emerald-500/[0.03] p-3 text-center">
                <div class="text-xl font-display font-bold text-emerald-400" id="jr-stat-accepted">--</div>
                <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-0.5">Signed</div>
            </div>
        </div>

        {# Pipeline Board #}
        <div id="jr-list" class="space-y-3">
            <div id="jr-loading" class="text-center py-12">
                <div class="inline-flex items-center gap-2 text-xs text-white/40">
                    <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2" stroke-dasharray="31.4 31.4"/></svg>
                    Loading pipeline‚Ä¶
                </div>
            </div>

            <div id="jr-empty" class="hidden text-center py-16">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-white/5 grid place-items-center">
                    <svg class="w-8 h-8 text-white/15" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                </div>
                <p class="text-sm font-medium text-white/40 mb-1">No active applications</p>
                <p class="text-xs text-white/25">When players apply, their pipeline cards will appear here.</p>
            </div>

            <div id="jr-items" class="hidden space-y-3"></div>
        </div>
    </div>

    {# TAB 2: RECRUITMENT POST ‚Äî Positions + Requirements #}
    <div id="sg-panel-jobpost" class="sg-panel hidden">

        {# Open Positions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
        <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-5 mb-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold flex items-center gap-2">
                    <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                    Open Positions
                </h3>
                <span class="text-[10px] text-white/30 font-mono" id="sg-pos-count">0 / 10</span>
            </div>

            {# Position list #}
            <div id="sg-positions-list" class="space-y-2 mb-4">
                <p class="text-xs text-white/30 text-center py-4" id="sg-positions-empty">No positions defined yet</p>
            </div>

            {# Add position form (enriched) #}
            <div id="sg-pos-form" class="space-y-3 border-t border-white/10 pt-4">
                <p class="text-[10px] text-white/50 uppercase tracking-wider font-bold">New Position</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <select id="sg-pos-role" class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white focus:outline-none focus:border-emerald-500/40">
                        <option value="">‚Äî Role Category ‚Äî</option>
                    </select>
                    <input type="text" id="sg-pos-title" placeholder='Custom title (e.g. "Entry Fragger")'
                        maxlength="60"
                        class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/40" />
                    <input type="text" id="sg-pos-rank" placeholder='Rank Requirement (e.g. "Immortal 3+")'
                        maxlength="60"
                        class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/40" />
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="sg-pos-region" placeholder="Region"
                            maxlength="30"
                            class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/40" />
                        <input type="text" id="sg-pos-platform" placeholder="Platform"
                            maxlength="30"
                            class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/40" />
                    </div>
                </div>
                <input type="text" id="sg-pos-pitch" placeholder='Short Pitch (max 140 chars, shown on public listing)'
                    maxlength="140"
                    class="w-full text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-emerald-500/40" />
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="sg-pos-crosspost" class="w-3.5 h-3.5 rounded accent-emerald-500" />
                        <span class="text-[10px] text-white/50">Publish to Community App</span>
                    </label>
                    <button onclick="ScoutingGrounds.addPosition()" class="h-8 px-5 rounded-xl bg-emerald-500/15 border border-emerald-500/25 text-emerald-400 text-xs font-bold hover:bg-emerald-500/25 transition">Add Position</button>
                </div>
            </div>
        </div>

        {# Requirements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ #}
        <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-sm font-bold flex items-center gap-2">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                    Requirements
                </h3>
                <span class="text-[10px] text-white/30 font-mono" id="sg-req-count">0 / 15</span>
            </div>

            {# Requirement list #}
            <div id="sg-requirements-list" class="space-y-2 mb-4">
                <p class="text-xs text-white/30 text-center py-4" id="sg-requirements-empty">No requirements defined yet</p>
            </div>

            {# Add requirement form #}
            <div class="grid grid-cols-[1fr_1.5fr_auto] gap-2">
                <input type="text" id="sg-req-label" placeholder='Label (e.g. "Min Rank")'
                    maxlength="40"
                    class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-blue-500/40" />
                <input type="text" id="sg-req-value" placeholder='Value (e.g. "Diamond+")'
                    maxlength="100"
                    class="text-xs px-3 py-2 rounded-xl bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-blue-500/40" />
                <button onclick="ScoutingGrounds.addRequirement()" class="h-8 px-4 rounded-xl bg-blue-500/15 border border-blue-500/25 text-blue-400 text-xs font-bold hover:bg-blue-500/25 transition">Add</button>
            </div>
        </div>
    </div>

    {# TAB 3: RECRUITMENT PROFILE                         #}
    <div id="sg-panel-profile" class="sg-panel hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {# Status Card #}
            <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-5">
                <div class="flex items-center gap-3 mb-4">
                    <div class="h-10 w-10 rounded-xl grid place-items-center {% if team.is_recruiting %}bg-emerald-500/15{% else %}bg-red-500/15{% endif %}">
                        {% if team.is_recruiting %}
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        {% else %}
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-white">Recruiting is <span class="{% if team.is_recruiting %}text-emerald-400{% else %}text-red-400{% endif %}">{{ team.is_recruiting|yesno:"Active,Paused" }}</span></p>
                        <p class="text-xs text-white/40">
                            {% if team.is_recruiting %}
                                Players can discover and apply to join.
                            {% else %}
                                Enable in <a href="#settings" class="text-[var(--team-primary)] hover:underline">Settings</a>.
                            {% endif %}
                        </p>
                    </div>
                </div>

                {# Recruitment profile tags #}
                <div class="flex flex-wrap gap-2">
                    {% if team.platform %}
                    <span class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-[10px] font-mono text-slate-300 uppercase">
                        üñ•Ô∏è {{ team.platform }}
                    </span>
                    {% endif %}
                    {% if team.region %}
                    <span class="px-2 py-1 rounded-lg bg-white/5 border border-white/10 text-[10px] font-mono text-slate-300 uppercase">
                        üåç {{ team.region }}
                    </span>
                    {% endif %}
                    {% if team.playstyle %}
                    <span class="px-2 py-1 rounded-lg bg-blue-500/10 border border-blue-500/20 text-[10px] font-mono text-blue-300 uppercase">
                        Style: {{ team.playstyle }}
                    </span>
                    {% endif %}
                    {% if team.playpace %}
                    <span class="px-2 py-1 rounded-lg bg-purple-500/10 border border-purple-500/20 text-[10px] font-mono text-purple-300 uppercase">
                        Pace: {{ team.playpace }}
                    </span>
                    {% endif %}
                    {% if team.playfocus %}
                    <span class="px-2 py-1 rounded-lg bg-amber-500/10 border border-amber-500/20 text-[10px] font-mono text-amber-300 uppercase">
                        Focus: {{ team.playfocus }}
                    </span>
                    {% endif %}
                </div>
            </div>

            {# Stats Card #}
            <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-5">
                <h3 class="text-xs font-mono font-bold uppercase tracking-widest text-slate-500 mb-4">Application Stats</h3>
                <div class="grid grid-cols-3 gap-4 text-center" id="jr-stats-grid">
                    <div>
                        <div class="text-2xl font-display font-bold text-white" id="jr-stat-total2">--</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-1">Total</div>
                    </div>
                    <div>
                        <div class="text-2xl font-display font-bold text-emerald-400" id="jr-stat-accepted2">--</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-1">Signed</div>
                    </div>
                    <div>
                        <div class="text-2xl font-display font-bold text-amber-400" id="jr-stat-pending2">--</div>
                        <div class="text-[9px] text-slate-500 uppercase font-bold tracking-wider mt-1">Active</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

{# SCOUTING GROUNDS ‚Äî STYLE + LOGIC                       #}
<style>
    .sg-tab--active { border-color: #34d399; color: #fff; }
    .sg-tab:not(.sg-tab--active) { border-color: transparent; color: rgba(255,255,255,.35); }
    .sg-tab:hover:not(.sg-tab--active) { color: rgba(255,255,255,.6); }

    .tryout-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; padding: 2px 8px; border-radius: 8px; }
    .tryout-badge--pending { background: rgba(251,191,36,.12); color: #fbbf24; border: 1px solid rgba(251,191,36,.2); }
    .tryout-badge--scheduled { background: rgba(96,165,250,.12); color: #60a5fa; border: 1px solid rgba(96,165,250,.2); }
    .tryout-badge--completed { background: rgba(167,139,250,.12); color: #a78bfa; border: 1px solid rgba(167,139,250,.2); }
    .tryout-badge--offer { background: rgba(52,211,153,.12); color: #34d399; border: 1px solid rgba(52,211,153,.2); }
</style>

<script>
(function() {
    const SLUG = "{{ team.slug }}";
    const API_BASE = `/api/vnext/teams/${SLUG}`;
    const CSRF = document.querySelector("[name=csrfmiddlewaretoken]")?.value || "{{ csrf_token }}";
    const HEADERS = { "Content-Type": "application/json", "X-CSRFToken": CSRF };

    // ‚îÄ‚îÄ Utility ‚îÄ‚îÄ
    function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }
    function relTime(iso) {
        const s = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
        if (s < 60) return "just now";
        const m = Math.floor(s / 60); if (m < 60) return m + "m ago";
        const h = Math.floor(m / 60); if (h < 24) return h + "h ago";
        const d = Math.floor(h / 24); if (d < 7) return d + "d ago";
        return new Date(iso).toLocaleDateString(undefined, { month: "short", day: "numeric" });
    }

    const STATUS_META = {
        PENDING:           { label: "Pending",    css: "tryout-badge--pending",   next: null },
        TRYOUT_SCHEDULED:  { label: "Tryout Set",  css: "tryout-badge--scheduled", next: "advance" },
        TRYOUT_COMPLETED:  { label: "Tryout Done", css: "tryout-badge--completed", next: "advance" },
        OFFER_SENT:        { label: "Offer Sent",  css: "tryout-badge--offer",     next: "advance" },
    };

    const NEXT_LABELS = {
        TRYOUT_SCHEDULED: "Mark Complete",
        TRYOUT_COMPLETED: "Send Offer",
        OFFER_SENT: "Sign Player",
    };

    // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
    const ScoutingGrounds = {
        switchTab(tab) {
            document.querySelectorAll('.sg-panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.sg-tab').forEach(t => { t.classList.remove('sg-tab--active'); });
            const panel = document.getElementById(`sg-panel-${tab}`);
            const tabEl = document.getElementById(`sg-tab-${tab}`);
            if (panel) panel.classList.remove('hidden');
            if (tabEl) tabEl.classList.add('sg-tab--active');

            if (tab === 'jobpost') ScoutingGrounds.loadJobPost();
            if (tab === 'pipeline') ScoutingGrounds.refresh();
        },

        // ‚îÄ‚îÄ Pipeline (applications) ‚îÄ‚îÄ
        async refresh() {
            const loading = document.getElementById("jr-loading");
            const empty = document.getElementById("jr-empty");
            const items = document.getElementById("jr-items");
            const badge = document.getElementById("jr-count-badge");
            const badgeNum = document.getElementById("jr-count-num");

            if (loading) loading.classList.remove("hidden");
            if (empty) empty.classList.add("hidden");
            if (items) items.classList.add("hidden");

            try {
                const resp = await fetch(`${API_BASE}/join-requests/`, { headers: { "X-CSRFToken": CSRF } });
                const data = await resp.json();
                if (!resp.ok) return;
                if (loading) loading.classList.add("hidden");

                const pending = data.requests.filter(r => r.status === 'PENDING').length;
                const tryouts = data.requests.filter(r => ['TRYOUT_SCHEDULED','TRYOUT_COMPLETED','OFFER_SENT'].includes(r.status)).length;

                const el = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
                el("jr-stat-total", data.total_count || 0);
                el("jr-stat-pending", pending);
                el("jr-stat-tryouts", tryouts);
                el("jr-stat-accepted", data.accepted_count || 0);
                el("jr-stat-total2", data.total_count || 0);
                el("jr-stat-accepted2", data.accepted_count || 0);
                el("jr-stat-pending2", data.count || 0);

                if (data.count === 0) {
                    if (empty) empty.classList.remove("hidden");
                    if (badge) badge.classList.add("hidden");
                    return;
                }

                if (badge) { badge.classList.remove("hidden"); badgeNum.textContent = data.count; }
                if (items) {
                    items.innerHTML = data.requests.map(r => ScoutingGrounds._renderCard(r)).join("");
                    items.classList.remove("hidden");
                }
            } catch (err) {
                console.error("Pipeline load error:", err);
                if (loading) loading.innerHTML = '<p class="text-xs text-red-400">Failed to load.</p>';
            }
        },

        _renderCard(r) {
            const meta = STATUS_META[r.status] || STATUS_META.PENDING;
            const avatar = r.avatar_url
                ? `<img src="${r.avatar_url}" alt="${esc(r.display_name)}" class="w-full h-full object-cover"/>`
                : `<span class="text-sm font-bold text-white/50">${(r.display_name||r.username)[0].toUpperCase()}</span>`;
            const msg = r.message ? `<p class="text-xs text-white/40 italic mt-1 truncate max-w-xs">"${esc(r.message)}"</p>` : '';
            const pos = r.applied_position ? `<span class="text-[10px] text-blue-300 ml-2">\u2192 ${esc(r.applied_position)}</span>` : '';
            const tryoutInfo = r.tryout_date ? `<span class="text-[10px] text-white/30 ml-2">\ud83d\udcc5 ${new Date(r.tryout_date).toLocaleDateString(undefined, {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span>` : '';

            // Action buttons based on status
            let actions = '';
            if (r.status === 'PENDING') {
                actions = `
                    <button onclick="ScoutingGrounds.openTryout(${r.id})" class="h-8 px-3 rounded-lg bg-blue-500/15 border border-blue-500/25 text-blue-400 text-[10px] font-bold uppercase hover:bg-blue-500/25 transition" title="Schedule tryout">
                        <svg class="w-3 h-3 inline -mt-0.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Tryout
                    </button>
                    <button onclick="ScoutingGrounds.quickAction(${r.id},'accept')" class="h-8 px-3 rounded-lg bg-emerald-500/15 border border-emerald-500/25 text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-500/25 transition">
                        <svg class="w-3 h-3 inline -mt-0.5 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                        Accept
                    </button>
                    <button onclick="ScoutingGrounds.quickAction(${r.id},'decline')" class="h-8 px-3 rounded-lg bg-white/5 border border-white/10 text-white/30 text-[10px] font-bold uppercase hover:bg-red-500/10 hover:text-red-400 transition">
                        <svg class="w-3 h-3 inline -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>`;
            } else if (NEXT_LABELS[r.status]) {
                actions = `
                    <button onclick="ScoutingGrounds.advanceTryout(${r.id})" class="h-8 px-3 rounded-lg bg-emerald-500/15 border border-emerald-500/25 text-emerald-400 text-[10px] font-bold uppercase hover:bg-emerald-500/25 transition">
                        ${esc(NEXT_LABELS[r.status])} \u2192
                    </button>
                    <button onclick="ScoutingGrounds.quickAction(${r.id},'decline')" class="h-8 px-3 rounded-lg bg-white/5 border border-white/10 text-white/30 text-[10px] font-bold uppercase hover:bg-red-500/10 hover:text-red-400 transition" title="Decline">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>`;
            }

            return `
            <div class="rounded-2xl border border-white/10 bg-white/[0.03] p-4 hover:border-white/15 transition-all" id="jr-card-${r.id}">
                <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="h-10 w-10 rounded-xl overflow-hidden bg-white/10 flex-shrink-0 grid place-items-center ring-2 ring-white/5">
                            ${avatar}
                        </div>
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <p class="text-sm font-semibold text-white truncate">${esc(r.display_name)}</p>
                                <span class="tryout-badge ${meta.css}">${meta.label}</span>
                                ${pos}
                            </div>
                            <div class="flex items-center gap-1 flex-wrap">
                                <p class="text-[10px] font-mono text-white/30">@${esc(r.username)}</p>
                                <span class="text-[10px] text-white/20">\u00b7 ${relTime(r.created_at)}</span>
                                ${tryoutInfo}
                            </div>
                            ${msg}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0" id="jr-actions-${r.id}">
                        ${actions}
                    </div>
                </div>
                <div id="jr-tryout-form-${r.id}" class="hidden mt-3 p-3 rounded-xl bg-white/[0.03] border border-blue-500/15 space-y-2">
                    <p class="text-xs font-bold text-blue-400">Schedule Tryout</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                        <input type="datetime-local" id="jr-tryout-date-${r.id}"
                            class="text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:outline-none focus:border-blue-500/40"/>
                        <input type="text" id="jr-tryout-pos-${r.id}" placeholder="Position (optional)"
                            maxlength="60"
                            class="text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-blue-500/40"/>
                        <button onclick="ScoutingGrounds.confirmTryout(${r.id})" class="h-8 px-4 rounded-lg bg-blue-500/20 border border-blue-500/30 text-blue-300 text-xs font-bold hover:bg-blue-500/30 transition">
                            Confirm
                        </button>
                    </div>
                    <textarea id="jr-tryout-notes-${r.id}" placeholder="Internal notes (optional)" rows="2" maxlength="1000"
                        class="w-full text-xs px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-white/20 focus:outline-none focus:border-blue-500/40 resize-none"></textarea>
                </div>
            </div>`;
        },

        openTryout(id) { document.getElementById(`jr-tryout-form-${id}`)?.classList.toggle('hidden'); },

        async confirmTryout(id) {
            const date = document.getElementById(`jr-tryout-date-${id}`)?.value;
            const pos = document.getElementById(`jr-tryout-pos-${id}`)?.value;
            const notes = document.getElementById(`jr-tryout-notes-${id}`)?.value;
            if (!date) { alert("Pick a date/time."); return; }

            const resp = await fetch(`${API_BASE}/join-requests/${id}/tryout/schedule/`, {
                method: "POST", headers: HEADERS,
                body: JSON.stringify({ tryout_date: date, position: pos, notes }),
            });
            const data = await resp.json();
            if (data.success) ScoutingGrounds.refresh();
            else alert(data.error || "Failed");
        },

        async advanceTryout(id) {
            const resp = await fetch(`${API_BASE}/join-requests/${id}/tryout/advance/`, {
                method: "POST", headers: HEADERS, body: "{}",
            });
            const data = await resp.json();
            if (data.success) ScoutingGrounds.refresh();
            else alert(data.error || "Failed");
        },

        async quickAction(id, action) {
            const actionsEl = document.getElementById(`jr-actions-${id}`);
            if (actionsEl) actionsEl.innerHTML = '<span class="text-xs text-white/40 animate-pulse">\u2026</span>';

            const resp = await fetch(`${API_BASE}/join-requests/${id}/review/`, {
                method: "POST", headers: HEADERS,
                body: JSON.stringify({ action }),
            });
            const data = await resp.json();
            if (resp.ok && data.success) {
                const card = document.getElementById(`jr-card-${id}`);
                const isAccept = action === "accept";
                if (actionsEl) actionsEl.innerHTML = `<span class="text-xs font-bold ${isAccept ? 'text-emerald-400' : 'text-red-400'}">${isAccept ? '\u2713 Signed' : '\u2717 Declined'}</span>`;
                if (card) setTimeout(() => { card.style.transition="opacity .5s,transform .5s"; card.style.opacity="0"; card.style.transform="translateX(20px)"; setTimeout(()=>card.remove(),500); }, 1500);
                setTimeout(() => ScoutingGrounds.refresh(), 2500);
            } else {
                if (actionsEl) actionsEl.innerHTML = `<span class="text-xs text-red-400">${data.error||'Failed'}</span>`;
            }
        },

        // ‚îÄ‚îÄ Recruitment Post Builder ‚îÄ‚îÄ
        _teamDefaults: null,

        async loadJobPost() {
            const [posResp, reqResp] = await Promise.all([
                fetch(`${API_BASE}/recruitment/positions/`, { headers: { "X-CSRFToken": CSRF } }),
                fetch(`${API_BASE}/recruitment/requirements/`, { headers: { "X-CSRFToken": CSRF } }),
            ]);
            const posData = await posResp.json();
            const reqData = await reqResp.json();

            // Populate role dropdown from API choices
            const roleSelect = document.getElementById("sg-pos-role");
            if (roleSelect && posData.role_choices) {
                roleSelect.innerHTML = '<option value="">‚Äî Role Category ‚Äî</option>' +
                    posData.role_choices.map(c => `<option value="${c.value}">${esc(c.label)}</option>`).join('');
            }

            // Auto-fill region/platform from team defaults (first load only)
            if (!ScoutingGrounds._teamDefaults && posData.team_defaults) {
                ScoutingGrounds._teamDefaults = posData.team_defaults;
                const regionIn = document.getElementById("sg-pos-region");
                const platIn = document.getElementById("sg-pos-platform");
                if (regionIn && !regionIn.value) regionIn.value = posData.team_defaults.region || '';
                if (platIn && !platIn.value) platIn.value = posData.team_defaults.platform || '';
            }

            // Render positions
            const posList = document.getElementById("sg-positions-list");
            const posCount = document.getElementById("sg-pos-count");
            const positions = posData.positions || [];
            if (posCount) posCount.textContent = `${positions.length} / 10`;

            if (positions.length === 0) {
                if (posList) posList.innerHTML = '<p class="text-xs text-white/30 text-center py-4">No positions defined yet</p>';
            } else {
                posList.innerHTML = positions.map(p => `
                    <div class="flex items-center justify-between py-2.5 px-3 rounded-xl bg-white/[0.02] border border-white/5 group hover:border-white/10 transition">
                        <div class="flex items-center gap-2 min-w-0 flex-wrap">
                            <span class="w-1.5 h-1.5 rounded-full ${p.is_active ? 'bg-emerald-400' : 'bg-white/20'} shrink-0"></span>
                            <span class="text-xs font-semibold text-white">${esc(p.title)}</span>
                            ${p.role_category && p.role_category !== 'OTHER' ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-indigo-500/10 text-indigo-300 uppercase font-bold">${esc(p.role_category)}</span>` : ''}
                            ${p.rank_requirement ? `<span class="text-[9px] px-1.5 py-0.5 rounded bg-amber-500/10 text-amber-300">${esc(p.rank_requirement)}</span>` : ''}
                            ${p.region ? `<span class="text-[9px] text-white/25">${esc(p.region)}</span>` : ''}
                            ${p.platform ? `<span class="text-[9px] text-white/25">${esc(p.platform)}</span>` : ''}
                        </div>
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition shrink-0">
                            ${p.cross_post_community ? '<span class="text-[9px] text-emerald-400" title="Cross-posted to Community">\ud83d\udce2</span>' : ''}
                            <button onclick="ScoutingGrounds.deletePosition(${p.id})" class="text-white/20 hover:text-red-400 transition p-0.5" title="Remove">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>
                `).join("");
                // Show short pitches below cards
                positions.filter(p => p.short_pitch).forEach(p => {
                    const card = posList.querySelector(`[onclick*="deletePosition(${p.id})"]`);
                    if (card) {
                        const parent = card.closest('.flex');
                        if (parent && parent.parentElement) {
                            const pitchEl = document.createElement('div');
                            pitchEl.className = 'text-[10px] text-white/30 italic px-3 pb-1 -mt-1';
                            pitchEl.textContent = '"' + p.short_pitch + '"';
                            parent.parentElement.appendChild(pitchEl);
                        }
                    }
                });
            }

            // Render requirements
            const reqList = document.getElementById("sg-requirements-list");
            const reqCount = document.getElementById("sg-req-count");
            const requirements = reqData.requirements || [];
            if (reqCount) reqCount.textContent = `${requirements.length} / 15`;

            if (requirements.length === 0) {
                if (reqList) reqList.innerHTML = '<p class="text-xs text-white/30 text-center py-4">No requirements defined yet</p>';
            } else {
                reqList.innerHTML = requirements.map(r => `
                    <div class="flex items-center justify-between py-2 px-3 rounded-xl bg-white/[0.02] border border-white/5 group hover:border-white/10 transition">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-mono text-blue-300 uppercase bg-blue-500/10 px-1.5 py-0.5 rounded">${esc(r.label)}</span>
                            <span class="text-xs text-white/70">${esc(r.value)}</span>
                        </div>
                        <button onclick="ScoutingGrounds.deleteRequirement(${r.id})" class="opacity-0 group-hover:opacity-100 text-white/20 hover:text-red-400 transition" title="Remove">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                `).join("");
            }
        },

        async addPosition() {
            const titleIn = document.getElementById("sg-pos-title");
            const roleIn = document.getElementById("sg-pos-role");
            const title = (titleIn?.value || '').trim();
            // Auto-fill title from role if empty
            const roleLabel = roleIn?.selectedOptions?.[0]?.textContent || '';
            const finalTitle = title || roleLabel;
            if (!finalTitle) { alert('Enter a position title or pick a role.'); return; }

            const body = {
                title: finalTitle,
                role_category: roleIn?.value || '',
                rank_requirement: document.getElementById("sg-pos-rank")?.value || '',
                region: document.getElementById("sg-pos-region")?.value || '',
                platform: document.getElementById("sg-pos-platform")?.value || '',
                short_pitch: document.getElementById("sg-pos-pitch")?.value || '',
                cross_post_community: document.getElementById("sg-pos-crosspost")?.checked || false,
            };
            const resp = await fetch(`${API_BASE}/recruitment/positions/save/`, {
                method: "POST", headers: HEADERS, body: JSON.stringify(body),
            });
            const data = await resp.json();
            if (data.success) {
                if (titleIn) titleIn.value = '';
                if (roleIn) roleIn.value = '';
                const pitchIn = document.getElementById("sg-pos-pitch");
                const rankIn = document.getElementById("sg-pos-rank");
                const crossIn = document.getElementById("sg-pos-crosspost");
                if (pitchIn) pitchIn.value = '';
                if (rankIn) rankIn.value = '';
                if (crossIn) crossIn.checked = false;
                ScoutingGrounds.loadJobPost();
            }
            else alert(data.error || "Failed");
        },

        async deletePosition(id) {
            const resp = await fetch(`${API_BASE}/recruitment/positions/${id}/delete/`, {
                method: "POST", headers: HEADERS, body: "{}",
            });
            const data = await resp.json();
            if (data.success) ScoutingGrounds.loadJobPost();
        },

        async addRequirement() {
            const labelInput = document.getElementById("sg-req-label");
            const valueInput = document.getElementById("sg-req-value");
            const label = (labelInput?.value || '').trim();
            const value = (valueInput?.value || '').trim();
            if (!label || !value) return;
            const resp = await fetch(`${API_BASE}/recruitment/requirements/save/`, {
                method: "POST", headers: HEADERS, body: JSON.stringify({ label, value }),
            });
            const data = await resp.json();
            if (data.success) { labelInput.value = ''; valueInput.value = ''; ScoutingGrounds.loadJobPost(); }
            else alert(data.error || "Failed");
        },

        async deleteRequirement(id) {
            const resp = await fetch(`${API_BASE}/recruitment/requirements/${id}/delete/`, {
                method: "POST", headers: HEADERS, body: "{}",
            });
            const data = await resp.json();
            if (data.success) ScoutingGrounds.loadJobPost();
        },
    };

    window.ScoutingGrounds = ScoutingGrounds;

    // Auto-load when section becomes visible
    const observer = new MutationObserver(() => {
        const section = document.getElementById('join-requests');
        if (section && section.classList.contains('is-active')) {
            ScoutingGrounds.refresh();
            observer.disconnect();
        }
    });
    const section = document.getElementById('join-requests');
    if (section) observer.observe(section, { attributes: true, attributeFilter: ["class"] });
})();
</script>
{% endif %}
