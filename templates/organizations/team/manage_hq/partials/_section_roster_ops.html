{% load team_filters %}
<section id="roster" class="hq-section space-y-5" aria-label="Roster Operations">

    {% if roster_locked %}
    <div class="rounded-2xl border border-red-500/30 bg-red-500/8 p-4 flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-red-500/15 grid place-items-center shrink-0">
            <i data-lucide="lock" class="w-5 h-5 text-red-400"></i>
        </div>
        <div class="min-w-0 flex-1">
            <p class="text-sm font-semibold text-red-400">Roster Locked</p>
            <p class="text-xs text-white/50">
                {% if roster_lock_source == 'organization' %}Locked by organization policy. Contact org admin.
                {% elif roster_lock_source == 'tournament' %}Locked due to active tournament registration.
                {% else %}Locked by team owner.{% endif %}
            </p>
        </div>
        {% if is_owner and roster_lock_source == 'owner' %}
        <button onclick="ManageHQ.toggleRosterLock(false)"
            class="shrink-0 text-xs px-3 py-1.5 rounded-lg border border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/15 transition font-medium">
            Unlock
        </button>
        {% endif %}
    </div>
    {% endif %}

    <div class="rounded-3xl border border-line bg-card shadow-soft overflow-hidden">
        <div class="p-5 lg:p-6">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-5">
                <div>
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5 text-cyan-400"></i>
                        Roster Management
                    </h2>
                    <p class="text-sm text-white/50 mt-0.5">{{ game_display }} &middot; {{ current_roster_size }}/{{ max_roster_size }} members</p>
                </div>
                <div class="flex items-center gap-2">
                    {% if is_owner and roster_lock_source != 'organization' and not roster_locked %}
                    <button onclick="ManageHQ.toggleRosterLock(true)"
                        class="text-xs px-3 py-1.5 rounded-lg border border-white/15 text-white/50 hover:border-red-500/30 hover:text-red-400 hover:bg-red-500/10 transition font-medium inline-flex items-center gap-1.5">
                        <i data-lucide="lock" class="w-3 h-3"></i>Lock
                    </button>
                    {% endif %}
                    {% if can_manage_roster and not roster_locked %}
                    <button onclick="ManageHQ.openInviteModal()"
                        class="text-xs px-4 py-2 rounded-xl bg-cyan-500/15 text-cyan-400 border border-cyan-500/25 hover:bg-cyan-500/25 transition font-semibold inline-flex items-center gap-1.5">
                        <i data-lucide="user-plus" class="w-3.5 h-3.5"></i>Invite Member
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <div class="rounded-xl bg-white/5 border border-white/8 p-3 text-center">
                    <div class="text-xl font-black text-emerald-400" id="starter-count">0</div>
                    <div class="text-[11px] text-white/45 mt-0.5">Starters</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/8 p-3 text-center">
                    <div class="text-xl font-black text-blue-400" id="sub-count">0</div>
                    <div class="text-[11px] text-white/45 mt-0.5">Substitutes</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/8 p-3 text-center">
                    <div class="text-xl font-black text-purple-400" id="staff-count">0</div>
                    <div class="text-[11px] text-white/45 mt-0.5">Staff</div>
                </div>
                <div class="rounded-xl bg-white/5 border border-white/8 p-3 text-center">
                    <div class="text-xl font-black {% if has_captain %}text-amber-400{% else %}text-red-400{% endif %}">
                        {% if has_captain %}&#10003;{% else %}&#10007;{% endif %}
                    </div>
                    <div class="text-[11px] text-white/45 mt-0.5">Captain</div>
                </div>
            </div>

            <div class="mt-3">
                <div class="flex items-center justify-between text-xs text-white/40 mb-1">
                    <span>Roster Fill</span>
                    <span class="font-semibold text-white/70">{{ current_roster_size }}/{{ max_roster_size }}</span>
                </div>
                <div class="h-2 rounded-full bg-white/8 overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-cyan-500 to-emerald-500 transition-all duration-500"
                         style="width: {% widthratio current_roster_size max_roster_size 100 %}%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6" id="team-intel-card">
        <div class="flex items-center gap-2 mb-4">
            <div class="h-8 w-8 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 grid place-items-center shrink-0">
                <i data-lucide="radar" class="w-4 h-4 text-cyan-400"></i>
            </div>
            <div>
                <h3 class="text-sm font-bold text-white">Team Intelligence</h3>
                <p class="text-xs text-white/40">Key roles, leadership &amp; tournament readiness</p>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
            {% for m in members %}{% if m.role == 'OWNER' %}
            <div class="rounded-xl border border-amber-500/20 bg-amber-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-amber-500/25 to-orange-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-amber-500/20 shrink-0">
                    {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                    {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-amber-400 uppercase tracking-wider">Team Owner</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ m.display_name|default:m.user.username }}</div>
                    <div class="text-[10px] text-white/35">@{{ m.user.username }}</div>
                </div>
                <span class="text-lg">&#128081;</span>
            </div>
            {% endif %}{% endfor %}

            {% for m in members %}{% if m.is_tournament_captain %}
            <div class="rounded-xl border border-emerald-500/20 bg-emerald-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-emerald-500/25 to-cyan-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-emerald-500/20 shrink-0">
                    {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                    {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">Tournament Captain</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ m.display_name|default:m.user.username }}</div>
                    <div class="text-[10px] text-white/35">Check-in authority &middot; Team rep</div>
                </div>
                <span class="text-lg">&#11088;</span>
            </div>
            {% endif %}{% endfor %}

            {% if not has_captain %}
            <div class="rounded-xl border border-dashed border-red-500/25 bg-red-500/[0.03] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-red-500/10 grid place-items-center shrink-0">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-400/60"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-red-400 uppercase tracking-wider">No Captain Set</div>
                    <div class="text-xs text-white/40">Required for tournament registration</div>
                </div>
                {% if can_manage_roster %}
                <button onclick="document.querySelector('[data-membership-id]')?.querySelector('[title=Edit]')?.click()"
                    class="text-[10px] px-2 py-1 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500/20 transition font-medium">Assign</button>
                {% endif %}
            </div>
            {% endif %}

            {% for m in members %}{% if m.role == 'MANAGER' %}
            <div class="rounded-xl border border-blue-500/20 bg-blue-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500/25 to-indigo-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-blue-500/20 shrink-0">
                    {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                    {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-blue-400 uppercase tracking-wider">Manager</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ m.display_name|default:m.user.username }}</div>
                    <div class="text-[10px] text-white/35">Roster &amp; tournament ops</div>
                </div>
                <i data-lucide="shield-check" class="w-5 h-5 text-blue-400/40"></i>
            </div>
            {% endif %}{% endfor %}

            {% for m in members %}{% if m.role == 'COACH' %}
            <div class="rounded-xl border border-purple-500/20 bg-purple-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-purple-500/25 to-pink-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-purple-500/20 shrink-0">
                    {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                    {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-purple-400 uppercase tracking-wider">Head Coach</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ m.display_name|default:m.user.username }}</div>
                    <div class="text-[10px] text-white/35">Strategy &amp; scrims</div>
                </div>
                <i data-lucide="graduation-cap" class="w-5 h-5 text-purple-400/40"></i>
            </div>
            {% endif %}{% endfor %}

            {% if org_context %}
            <div class="rounded-xl border border-violet-500/20 bg-violet-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-violet-500/25 to-fuchsia-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-violet-500/15 shrink-0">
                    <i data-lucide="building-2" class="w-5 h-5 text-violet-400"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-violet-400 uppercase tracking-wider">Organization</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ org_context.name }}</div>
                    <div class="text-[10px] text-white/35">{% if org_context.is_verified %}Verified{% endif %} &middot; Empire #{{ org_context.global_rank|default:"â€”" }}</div>
                </div>
                <a href="{{ org_context.url }}" class="text-[10px] px-2 py-1 rounded-lg bg-white/5 text-white/40 hover:text-white/70 hover:bg-white/10 transition">View</a>
            </div>
            {% endif %}

            {% for s in org_staff %}
            <div class="rounded-xl border border-fuchsia-500/20 bg-fuchsia-500/[0.04] p-3.5 flex items-center gap-3">
                <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-fuchsia-500/25 to-violet-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-fuchsia-500/20 shrink-0">
                    {% if s.avatar_url %}<img src="{{ s.avatar_url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ s.username|slice:':2'|upper|escapejs }}')">
                    {% else %}{{ s.username|slice:":2"|upper }}{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-[10px] font-bold text-fuchsia-400 uppercase tracking-wider">Org {{ s.role_display }}</div>
                    <div class="text-sm font-semibold text-white/90 truncate">{{ s.username }}</div>
                    <div class="text-[10px] text-white/35">
                        {% if s.role == 'CEO' %}Full team authority &middot; Registration
                        {% else %}Team management &middot; Registration{% endif %}
                    </div>
                </div>
                {% if s.role == 'CEO' %}<span class="text-lg">&#128142;</span>
                {% else %}<i data-lucide="building" class="w-5 h-5 text-fuchsia-400/40"></i>{% endif %}
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 rounded-xl bg-white/[0.025] border border-white/6 p-3">
            <h4 class="text-[10px] font-bold text-white/40 uppercase tracking-wider mb-2">Registration Authority</h4>
            <div class="flex flex-wrap gap-2">
                {% for m in members %}
                {% if m.role == 'OWNER' or m.role == 'MANAGER' %}
                <span class="inline-flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-lg bg-white/5 border border-white/8 text-white/60">
                    <span class="h-4 w-4 rounded-full bg-white/10 grid place-items-center text-[8px] font-bold overflow-hidden shrink-0">
                        {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':1'|upper|escapejs }}')">
                        {% else %}{{ m.user.username|slice:":1"|upper }}{% endif %}
                    </span>
                    {{ m.user.username }}
                    <span class="text-[9px] px-1 py-0.5 rounded bg-cyan-500/10 text-cyan-400/60 font-medium">{{ m.get_role_display }}</span>
                </span>
                {% endif %}
                {% endfor %}
                {% for s in org_staff %}
                <span class="inline-flex items-center gap-1.5 text-xs px-2.5 py-1 rounded-lg bg-fuchsia-500/5 border border-fuchsia-500/15 text-white/60">
                    <span class="h-4 w-4 rounded-full bg-fuchsia-500/15 grid place-items-center text-[8px] font-bold overflow-hidden shrink-0">
                        {% if s.avatar_url %}<img src="{{ s.avatar_url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ s.username|slice:':1'|upper|escapejs }}')">
                        {% else %}{{ s.username|slice:":1"|upper }}{% endif %}
                    </span>
                    {{ s.username }}
                    <span class="text-[9px] px-1 py-0.5 rounded bg-fuchsia-500/10 text-fuchsia-400/60 font-medium">Org {{ s.role }}</span>
                </span>
                {% endfor %}
            </div>
            <p class="text-[10px] text-white/25 mt-2">These members and org staff can register this team for tournaments.</p>
        </div>
    </div>

    <div class="rounded-3xl border border-emerald-500/15 bg-card shadow-soft overflow-hidden">
        <div class="px-5 lg:px-6 pt-5 lg:pt-6 pb-3 flex items-center justify-between">
            <h3 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="swords" class="w-4 h-4 text-emerald-400"></i>
                Starting Lineup
                <span class="text-xs font-mono text-white/40 ml-1" id="starter-count-label">0/{{ max_team_size }}</span>
            </h3>
        </div>
        <div class="px-5 lg:px-6 pb-5 lg:pb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="roster-starters">
                {% for m in members %}
                {% if m.roster_slot == 'STARTER' or m.role == 'PLAYER' and not m.roster_slot or m.role == 'OWNER' and not m.roster_slot %}
                <div class="group relative rounded-2xl border border-white/10 bg-white/[0.04] hover:bg-white/[0.07] hover:border-white/20 transition-all duration-200 p-4"
                     data-membership-id="{{ m.id }}" data-permissions='{{ m|effective_perms_json }}'
                     data-gp-ign="{{ m.gp_in_game_name|default:'' }}" data-gp-rank="{{ m.gp_rank_name|default:'' }}"
                     data-gp-rank-img="{{ m.gp_rank_image_url|default:'' }}" data-gp-role="{{ m.gp_main_role|default:'' }}"
                     data-gp-region="{{ m.gp_region|default:'' }}" data-gp-matches="{{ m.gp_matches_played|default:'0' }}"
                     data-gp-winrate="{{ m.gp_win_rate|default:'0' }}" data-gp-kd="{{ m.gp_kd_ratio|default:'' }}"
                     data-profile-url="/@{{ m.user.username }}/">

                    <div class="flex items-start gap-3">
                        <div class="relative shrink-0">
                            <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 grid place-items-center text-sm font-bold overflow-hidden border border-white/10">
                                {% if m.roster_image %}<img src="{{ m.roster_image.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                                {% elif m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                                {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                            </div>
                            {% if m.is_tournament_captain %}
                            <div class="absolute -top-1.5 -right-1.5 h-5 w-5 rounded-full bg-amber-500 grid place-items-center text-[10px] border-2 border-[#0b1020]" title="Tournament Captain">&#11088;</div>
                            {% endif %}
                            {% if m.role == 'OWNER' %}
                            <div class="absolute -bottom-1 -left-1 h-4 w-4 rounded-full bg-amber-500/20 grid place-items-center text-[9px]" title="Team Owner">&#128081;</div>
                            {% endif %}
                        </div>

                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1.5">
                                <span class="text-sm font-semibold text-white truncate">{{ m.display_name|default:m.user.username }}</span>
                            </div>
                            <div class="text-xs text-white/40 truncate">@{{ m.user.username }}</div>
                            <div class="flex items-center gap-1.5 mt-1.5 flex-wrap">
                                {% if m.player_role %}
                                <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/15 text-blue-400 font-medium">{{ m.player_role }}</span>
                                {% endif %}
                                <span class="text-[10px] px-1.5 py-0.5 rounded bg-emerald-500/10 text-emerald-400/70 font-medium">{{ m.get_role_display }}</span>
                            </div>
                        </div>
                    </div>

                    {% if can_manage_roster and not roster_locked %}
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <button onclick="ManageHQ.showMemberInfo({{ m.id }}, '{{ m.display_name|default:m.user.username|escapejs }}', '{{ m.user.username|escapejs }}', '{{ m.get_role_display|escapejs }}', '{{ m.player_role|default:""|escapejs }}', '{{ m.user.email|escapejs }}', '{{ m.joined_at|date:"Y-m-d"|default:""|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-cyan-500/20 grid place-items-center transition" title="Player Info">
                            <i data-lucide="info" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.openRoleModal({{ m.id }}, '{{ m.role }}', '{{ m.user.username|escapejs }}', {{ m.is_tournament_captain|yesno:'true,false' }}, '{{ m.player_role|default:""|escapejs }}', '{{ m.roster_slot|default:""|escapejs }}', '{{ m.display_name|default:""|escapejs }}', '{% if m.roster_image %}{{ m.roster_image.url }}{% endif %}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-blue-500/20 grid place-items-center transition" title="Edit">
                            <i data-lucide="pencil" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.swapSlot({{ m.id }}, 'SUBSTITUTE')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-amber-500/20 grid place-items-center transition" title="Move to Bench">
                            <i data-lucide="arrow-down" class="w-3 h-3 text-white/60"></i>
                        </button>
                        {% if m.role != 'OWNER' %}
                        <button onclick="ManageHQ.openRemoveModal({{ m.id }}, '{{ m.user.username|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-red-500/20 grid place-items-center transition" title="Remove">
                            <i data-lucide="x" class="w-3 h-3 text-white/60"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if m.user.id == request.user.id and not can_manage_roster %}
                    <div class="absolute top-2 right-2">
                        <button onclick="ManageHQ.openSelfEditModal({{ m.id }}, '{{ m.user.username|escapejs }}', '{{ m.player_role|default:""|escapejs }}', '{{ m.roster_slot|default:""|escapejs }}', '{{ m.display_name|default:""|escapejs }}', '{% if m.roster_image %}{{ m.roster_image.url }}{% endif %}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-white/20 grid place-items-center transition" title="Edit your info">
                            <i data-lucide="pencil" class="w-3 h-3 text-white/50"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div id="starters-empty" class="rounded-xl border border-dashed border-white/10 p-6 text-center hidden">
                <p class="text-sm text-white/30">No starters assigned yet</p>
            </div>
        </div>
    </div>

    <div class="rounded-3xl border border-blue-500/15 bg-card shadow-soft overflow-hidden">
        <div class="px-5 lg:px-6 pt-5 lg:pt-6 pb-3 flex items-center justify-between">
            <h3 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="arrow-left-right" class="w-4 h-4 text-blue-400"></i>
                Substitutes
                <span class="text-xs font-mono text-white/40 ml-1" id="sub-count-label">0</span>
            </h3>
        </div>
        <div class="px-5 lg:px-6 pb-5 lg:pb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="roster-subs">
                {% for m in members %}
                {% if m.roster_slot == 'SUBSTITUTE' or m.role == 'SUBSTITUTE' %}
                <div class="group relative rounded-2xl border border-white/8 bg-white/[0.03] hover:bg-white/[0.06] hover:border-white/15 transition-all duration-200 p-4"
                     data-membership-id="{{ m.id }}" data-permissions='{{ m|effective_perms_json }}'
                     data-gp-ign="{{ m.gp_in_game_name|default:'' }}" data-gp-rank="{{ m.gp_rank_name|default:'' }}"
                     data-gp-rank-img="{{ m.gp_rank_image_url|default:'' }}" data-gp-role="{{ m.gp_main_role|default:'' }}"
                     data-gp-region="{{ m.gp_region|default:'' }}" data-gp-matches="{{ m.gp_matches_played|default:'0' }}"
                     data-gp-winrate="{{ m.gp_win_rate|default:'0' }}" data-gp-kd="{{ m.gp_kd_ratio|default:'' }}"
                     data-profile-url="/@{{ m.user.username }}/">
                    <div class="flex items-start gap-3">
                        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-blue-500/15 to-indigo-500/15 grid place-items-center text-sm font-bold overflow-hidden border border-white/8 shrink-0">
                            {% if m.roster_image %}<img src="{{ m.roster_image.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                            {% elif m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                            {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-semibold text-white truncate block">{{ m.display_name|default:m.user.username }}</span>
                            <div class="text-xs text-white/35">@{{ m.user.username }}</div>
                            {% if m.player_role %}
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400/70 font-medium mt-1 inline-block">{{ m.player_role }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if can_manage_roster and not roster_locked %}
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <button onclick="ManageHQ.showMemberInfo({{ m.id }}, '{{ m.display_name|default:m.user.username|escapejs }}', '{{ m.user.username|escapejs }}', '{{ m.get_role_display|escapejs }}', '{{ m.player_role|default:""|escapejs }}', '{{ m.user.email|escapejs }}', '{{ m.joined_at|date:"Y-m-d"|default:""|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-cyan-500/20 grid place-items-center transition" title="Player Info">
                            <i data-lucide="info" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.swapSlot({{ m.id }}, 'STARTER')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-emerald-500/20 grid place-items-center transition" title="Promote to Starter">
                            <i data-lucide="arrow-up" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.openRoleModal({{ m.id }}, '{{ m.role }}', '{{ m.user.username|escapejs }}', {{ m.is_tournament_captain|yesno:'true,false' }}, '{{ m.player_role|default:""|escapejs }}', '{{ m.roster_slot|default:""|escapejs }}', '{{ m.display_name|default:""|escapejs }}', '{% if m.roster_image %}{{ m.roster_image.url }}{% endif %}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-blue-500/20 grid place-items-center transition" title="Edit">
                            <i data-lucide="pencil" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.openRemoveModal({{ m.id }}, '{{ m.user.username|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-red-500/20 grid place-items-center transition" title="Remove">
                            <i data-lucide="x" class="w-3 h-3 text-white/60"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div id="subs-empty" class="rounded-xl border border-dashed border-white/10 p-6 text-center hidden">
                <p class="text-sm text-white/30">No substitutes on bench</p>
            </div>
        </div>
    </div>

    <div class="rounded-3xl border border-purple-500/15 bg-card shadow-soft overflow-hidden">
        <div class="px-5 lg:px-6 pt-5 lg:pt-6 pb-3">
            <h3 class="text-base font-bold flex items-center gap-2">
                <i data-lucide="briefcase" class="w-4 h-4 text-purple-400"></i>
                Coaching &amp; Staff
            </h3>
        </div>
        <div class="px-5 lg:px-6 pb-5 lg:pb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="roster-staff">
                {% for m in members %}
                {% if m.role == 'MANAGER' or m.role == 'COACH' or m.role == 'ANALYST' or m.role == 'SCOUT' %}
                <div class="group relative rounded-2xl border border-purple-500/10 bg-purple-500/[0.03] hover:bg-purple-500/[0.06] hover:border-purple-500/20 transition-all duration-200 p-4"
                     data-membership-id="{{ m.id }}" data-permissions='{{ m|effective_perms_json }}'
                     data-gp-ign="{{ m.gp_in_game_name|default:'' }}" data-gp-rank="{{ m.gp_rank_name|default:'' }}"
                     data-gp-rank-img="{{ m.gp_rank_image_url|default:'' }}" data-gp-role="{{ m.gp_main_role|default:'' }}"
                     data-gp-region="{{ m.gp_region|default:'' }}" data-gp-matches="{{ m.gp_matches_played|default:'0' }}"
                     data-gp-winrate="{{ m.gp_win_rate|default:'0' }}" data-gp-kd="{{ m.gp_kd_ratio|default:'' }}"
                     data-profile-url="/@{{ m.user.username }}/">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-purple-500/20 to-pink-500/15 grid place-items-center text-sm font-bold overflow-hidden border border-white/8 shrink-0">
                            {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':2'|upper|escapejs }}')">
                            {% else %}{{ m.user.username|slice:":2"|upper }}{% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-semibold text-white truncate block">{{ m.display_name|default:m.user.username }}</span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-purple-500/15 text-purple-400 font-bold uppercase tracking-wider">{{ m.get_role_display }}</span>
                        </div>
                    </div>
                    {% if can_manage_roster and not roster_locked and m.role != 'OWNER' %}
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <button onclick="ManageHQ.showMemberInfo({{ m.id }}, '{{ m.display_name|default:m.user.username|escapejs }}', '{{ m.user.username|escapejs }}', '{{ m.get_role_display|escapejs }}', '{{ m.player_role|default:""|escapejs }}', '{{ m.user.email|escapejs }}', '{{ m.joined_at|date:"Y-m-d"|default:""|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-cyan-500/20 grid place-items-center transition" title="Player Info">
                            <i data-lucide="info" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.openRoleModal({{ m.id }}, '{{ m.role }}', '{{ m.user.username|escapejs }}', {{ m.is_tournament_captain|yesno:'true,false' }}, '{{ m.player_role|default:""|escapejs }}', '{{ m.roster_slot|default:""|escapejs }}', '{{ m.display_name|default:""|escapejs }}', '')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-blue-500/20 grid place-items-center transition" title="Edit">
                            <i data-lucide="pencil" class="w-3 h-3 text-white/60"></i>
                        </button>
                        <button onclick="ManageHQ.openRemoveModal({{ m.id }}, '{{ m.user.username|escapejs }}')"
                            class="h-7 w-7 rounded-lg bg-white/10 hover:bg-red-500/20 grid place-items-center transition" title="Remove">
                            <i data-lucide="x" class="w-3 h-3 text-white/60"></i>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div id="staff-empty" class="rounded-xl border border-dashed border-white/10 p-6 text-center hidden">
                <p class="text-sm text-white/30">No coaching or support staff yet</p>
                {% if can_manage_roster %}
                <button onclick="ManageHQ.openInviteModal()" class="text-xs text-cyan-400 hover:underline mt-1">+ Invite Staff</button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if pending_invites %}
    <div class="rounded-3xl border border-amber-500/15 bg-card shadow-soft p-5 lg:p-6" id="pending-invites-section">
        <h3 class="text-sm font-bold mb-3 flex items-center gap-2">
            <i data-lucide="mail" class="w-4 h-4 text-amber-400"></i>
            Pending Invitations
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-amber-500/15 text-amber-300">{{ pending_invites.count }}</span>
        </h3>
        <div class="space-y-2" id="pending-invites-list">
            {% for inv in pending_invites %}
            <div id="invite-{{ inv.id }}" class="rounded-xl border border-white/8 bg-white/[0.03] p-3 flex items-center justify-between">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="h-8 w-8 rounded-lg bg-white/10 grid place-items-center text-xs font-bold shrink-0">
                        {{ inv.invited_user.username|slice:":1"|upper }}
                    </div>
                    <div class="min-w-0">
                        <div class="text-sm font-semibold truncate">{{ inv.invited_user.username }}</div>
                        <div class="text-xs text-white/40">{{ inv.role|default:"PLAYER" }} &middot; {{ inv.created_at|timesince }} ago</div>
                    </div>
                </div>
                {% if can_manage_roster %}
                <button onclick="ManageHQ.cancelInvite({{ inv.id }}, this)"
                    class="text-xs px-3 py-1 rounded-lg border border-red-500/20 text-red-400 hover:bg-red-500/15 transition shrink-0">
                    Cancel
                </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="rounded-3xl border border-line bg-card shadow-soft p-5 lg:p-6">
        <button class="w-full flex items-center justify-between" onclick="this.closest('.rounded-3xl').querySelector('#guide-content').classList.toggle('hidden'); this.querySelector('[data-lucide]').classList.toggle('rotate-180')">
            <h3 class="text-sm font-bold flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4 text-white/50"></i>
                Roster Guide &amp; Rules
            </h3>
            <i data-lucide="chevron-down" class="w-4 h-4 text-white/40 transition-transform"></i>
        </button>
        <div id="guide-content" class="hidden mt-4 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="rounded-xl bg-white/[0.03] border border-white/8 p-3">
                    <h4 class="text-xs font-bold text-white/60 mb-1.5">Role System</h4>
                    <ul class="text-xs text-white/45 space-y-1">
                        <li><strong class="text-amber-400">Owner</strong> &mdash; Full control, wallet, deletion</li>
                        <li><strong class="text-blue-400">Manager</strong> &mdash; Roster, tournaments, settings (1 per team)</li>
                        <li><strong class="text-purple-400">Coach</strong> &mdash; Stats, scrims, tactics (1 per team)</li>
                        <li><strong class="text-emerald-400">Player</strong> &mdash; Active competitor, needs Game Passport</li>
                        <li><strong class="text-cyan-400">Substitute</strong> &mdash; Backup player, needs Game Passport</li>
                        <li><strong class="text-pink-400">Analyst</strong> &mdash; Data &amp; strategy (1 per team)</li>
                        <li><strong class="text-white/50">Scout</strong> &mdash; View-only stats access</li>
                    </ul>
                </div>
                <div class="rounded-xl bg-white/[0.03] border border-white/8 p-3">
                    <h4 class="text-xs font-bold text-white/60 mb-1.5">Tournament Rules</h4>
                    <ul class="text-xs text-white/45 space-y-1">
                        <li>&#11088; One captain designated per team for check-ins</li>
                        <li>&#128274; Roster locks when bracket is generated</li>
                        <li>&#128100; One team per player per game title</li>
                        <li>&#127970; Org can enter only 1 team per tournament</li>
                        <li>&#127918; Active lineup &le; {{ max_team_size }} players</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-invite" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onclick="if(event.target===this) ManageHQ.closeModal('modal-invite')">
        <div class="w-full max-w-md rounded-3xl border border-line bg-[#0c1020] shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/8">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-bold flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5 text-cyan-400"></i>
                        Invite Member
                    </h3>
                    <button onclick="ManageHQ.closeModal('modal-invite')" class="h-8 w-8 rounded-lg hover:bg-white/10 grid place-items-center transition">
                        <i data-lucide="x" class="w-4 h-4 text-white/50"></i>
                    </button>
                </div>
            </div>
            <form id="invite-form" class="p-6 space-y-4">
                <div id="invite-search-wrapper">
                    <label class="block text-xs font-semibold text-white/60 mb-1.5">Username or Email</label>
                    <input type="text" id="invite-username" placeholder="Search player..."
                        class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white placeholder:text-white/30 focus:border-cyan-500/40 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-white/60 mb-1.5">Role</label>
                    <select id="invite-role" class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white focus:border-cyan-500/40 focus:outline-none transition">
                        <option value="PLAYER">Player</option>
                        <option value="SUBSTITUTE">Substitute</option>
                        <option value="COACH">Coach</option>
                        <option value="ANALYST">Analyst</option>
                        <option value="SCOUT">Scout</option>
                        {% if is_owner %}<option value="MANAGER">Manager</option>{% endif %}
                    </select>
                </div>
                <div id="invite-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-xl p-3"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="ManageHQ.closeModal('modal-invite')"
                        class="flex-1 py-2.5 rounded-xl border border-white/10 text-sm text-white/60 hover:bg-white/5 transition font-medium">Cancel</button>
                    <button type="submit" id="invite-submit-btn"
                        class="flex-1 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-semibold transition">Send Invite</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-role-edit" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onclick="if(event.target===this) ManageHQ.closeModal('modal-role-edit')">
        <div class="w-full max-w-lg rounded-3xl border border-line bg-[#0c1020] shadow-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-5 border-b border-white/8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div id="role-modal-avatar" class="h-12 w-12 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-500/20 grid place-items-center text-base font-bold overflow-hidden border border-white/10 shrink-0">
                            <i data-lucide="user-cog" class="w-5 h-5 text-white/40"></i>
                        </div>
                        <div>
                            <h3 class="text-base font-bold">Edit Member</h3>
                            <p class="text-xs text-white/40" id="role-username-display"></p>
                        </div>
                    </div>
                    <button onclick="ManageHQ.closeModal('modal-role-edit')" class="h-8 w-8 rounded-lg hover:bg-white/10 grid place-items-center transition">
                        <i data-lucide="x" class="w-4 h-4 text-white/50"></i>
                    </button>
                </div>
            </div>
            <form id="role-edit-form" class="p-5 space-y-4">
                <input type="hidden" id="role-membership-id" value="">

                <div class="rounded-xl border border-white/8 bg-white/[0.025] p-4 space-y-4">
                    <h4 class="text-[10px] font-bold text-white/50 uppercase tracking-widest flex items-center gap-1.5">
                        <i data-lucide="shield" class="w-3 h-3"></i> Organization Role
                    </h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-medium text-white/50 mb-1">Team Role</label>
                            <select id="role-select" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white focus:border-cyan-500/40 focus:outline-none transition">
                                {% for rc in role_choices %}
                                <option value="{{ rc.value }}">{{ rc.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-[11px] font-medium text-white/50 mb-1">Roster Slot</label>
                            <select id="role-roster-slot" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white focus:border-cyan-500/40 focus:outline-none transition">
                                <option value="">Auto</option>
                                <option value="STARTER">Starter</option>
                                <option value="SUBSTITUTE">Substitute</option>
                                <option value="COACH">Coach</option>
                                <option value="ANALYST">Analyst</option>
                            </select>
                        </div>
                    </div>
                    <div id="role-constraint-warning" class="hidden rounded-lg bg-amber-500/10 border border-amber-500/20 p-2.5 text-xs text-amber-400 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-3.5 h-3.5 shrink-0"></i>
                        <span id="role-constraint-text"></span>
                    </div>
                </div>

                <div class="rounded-xl border border-white/8 bg-white/[0.025] p-4 space-y-4">
                    <h4 class="text-[10px] font-bold text-white/50 uppercase tracking-widest flex items-center gap-1.5">
                        <i data-lucide="gamepad-2" class="w-3 h-3"></i> Player Identity
                    </h4>
                    <div class="flex items-center gap-3 p-2.5 rounded-lg border {% if True %}border-white/8{% endif %} bg-white/[0.02]">
                        <input type="checkbox" id="role-captain-cb" class="h-4 w-4 rounded border-white/20 bg-white/5 accent-amber-400">
                        <label for="role-captain-cb" class="text-sm text-white/70 flex items-center gap-1.5 cursor-pointer">
                            <span class="text-base">&#11088;</span> Designate as Tournament Captain
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] font-medium text-white/50 mb-1">In-Game Role</label>
                            {% if game_roles %}
                            <select id="role-player-role" class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white focus:border-cyan-500/40 focus:outline-none transition">
                                <option value="">None</option>
                                {% for gr in game_roles %}
                                <option value="{{ gr.role_name }}">{{ gr.role_name }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <input type="text" id="role-player-role" placeholder="e.g. Duelist, IGL"
                                class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white placeholder:text-white/25 focus:border-cyan-500/40 focus:outline-none transition">
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-[11px] font-medium text-white/50 mb-1">Display Name</label>
                            <input type="text" id="role-display-name" placeholder="Custom name"
                                class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-sm text-white placeholder:text-white/25 focus:border-cyan-500/40 focus:outline-none transition">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[11px] font-medium text-white/50 mb-1.5">Roster Photo</label>
                        <div class="flex items-center gap-3">
                            <div id="role-photo-preview" class="h-14 w-14 rounded-xl bg-white/5 border border-white/10 grid place-items-center overflow-hidden shrink-0">
                                <i data-lucide="image" class="w-5 h-5 text-white/15"></i>
                            </div>
                            <div>
                                <label for="role-photo-input"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white/10 text-xs font-semibold text-white/70 hover:bg-white/15 transition cursor-pointer">
                                    <i data-lucide="upload" class="w-3 h-3"></i> Choose Photo
                                </label>
                                <input type="file" id="role-photo-input" accept="image/jpeg,image/png,image/webp" class="hidden"
                                    onchange="if(this.files[0]){var r=new FileReader();r.onload=function(e){document.getElementById('role-photo-preview').innerHTML='<img src=&quot;'+e.target.result+'&quot; class=&quot;w-full h-full object-cover&quot;>'};r.readAsDataURL(this.files[0])}">
                                <p class="text-[10px] text-white/25 mt-1">Max 5 MB &middot; JPEG, PNG, WebP</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="role-permissions-section" class="rounded-xl border border-white/8 bg-white/[0.025] overflow-hidden">
                    <button type="button" onclick="document.getElementById('role-perm-grid').classList.toggle('hidden'); this.querySelector('.perm-chevron').classList.toggle('rotate-180')"
                        class="w-full flex items-center justify-between p-4 hover:bg-white/[0.02] transition">
                        <div class="flex items-center gap-2">
                            <i data-lucide="key" class="w-4 h-4 text-amber-400"></i>
                            <span class="text-[10px] font-bold uppercase tracking-widest text-white/60">Granular Permissions</span>
                            <span id="perm-override-badge" class="text-[9px] px-1.5 py-0.5 rounded bg-amber-500/15 text-amber-400 font-semibold hidden">Override Active</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-white/40 transition-transform perm-chevron"></i>
                    </button>
                    <div id="role-perm-grid" class="hidden border-t border-white/6 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <p class="text-xs text-white/40">Checked = granted. Unchecked = revoked (falls back to role default).</p>
                            <button type="button" id="perm-reset-btn" onclick="window._resetPermsToRoleDefaults()"
                                class="text-[10px] px-2 py-1 rounded-md bg-white/5 text-white/40 hover:text-white/70 hover:bg-white/10 transition font-medium">
                                Reset to Role Defaults
                            </button>
                        </div>
                        <div id="perm-role-defaults-indicator" class="hidden mb-3 rounded-lg bg-cyan-500/8 border border-cyan-500/15 p-2 text-xs text-cyan-400 flex items-center gap-2">
                            <i data-lucide="info" class="w-3.5 h-3.5 shrink-0"></i>
                            <span>Showing defaults for <strong id="perm-role-label"></strong>. Toggle to override.</span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="register_tournaments">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Register Tournaments</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="edit_roster">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Edit Roster</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="edit_team">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Edit Team Profile</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="schedule_scrims">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Schedule Scrims</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="edit_toc">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Edit TOC</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="view_analytics">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">View Analytics</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="view_dashboard">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">View Dashboard</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="view_player_stats">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">View Player Stats</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="manage_bounties">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Manage Bounties</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="manage_economy">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Manage Economy</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="manage_media">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Manage Media</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="send_announcements">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Send Announcements</span>
                                </div>
                            </label>
                            <label class="flex items-center gap-2.5 p-2 rounded-lg hover:bg-white/[0.03] transition cursor-pointer group">
                                <input type="checkbox" class="perm-cb h-4 w-4 rounded border-white/20 bg-white/5 accent-emerald-400" data-perm="manage_discord">
                                <div class="flex-1 min-w-0">
                                    <span class="text-[13px] text-white/75 group-hover:text-white/90 transition">Manage Discord</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="role-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-xl p-3"></div>

                <div class="flex gap-3">
                    <button type="button" onclick="ManageHQ.closeModal('modal-role-edit')"
                        class="flex-1 py-2.5 rounded-xl border border-white/10 text-sm text-white/60 hover:bg-white/5 transition font-medium">Cancel</button>
                    <button type="submit" id="role-submit-btn"
                        class="flex-1 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold transition inline-flex items-center justify-center gap-1.5">
                        <i data-lucide="check" class="w-4 h-4"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-remove" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onclick="if(event.target===this) ManageHQ.closeModal('modal-remove')">
        <div class="w-full max-w-sm rounded-3xl border border-red-500/20 bg-[#0c1020] shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/8">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-bold text-red-400 flex items-center gap-2">
                        <i data-lucide="user-minus" class="w-5 h-5"></i>
                        Remove Member
                    </h3>
                    <button onclick="ManageHQ.closeModal('modal-remove')" class="h-8 w-8 rounded-lg hover:bg-white/10 grid place-items-center transition">
                        <i data-lucide="x" class="w-4 h-4 text-white/50"></i>
                    </button>
                </div>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="remove-membership-id" value="">
                <p class="text-sm text-white/60">
                    Remove <strong class="text-white" id="remove-username-display"></strong> from the team? This cannot be undone.
                </p>
                <div>
                    <label class="block text-xs text-white/40 mb-1.5">Type "<span id="remove-confirm-target" class="text-red-400 font-semibold"></span>" to confirm</label>
                    <input type="text" id="remove-confirm-input"
                        class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white focus:border-red-500/40 focus:outline-none transition">
                </div>
                <div id="remove-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-xl p-3"></div>
                <div class="flex gap-3">
                    <button onclick="ManageHQ.closeModal('modal-remove')"
                        class="flex-1 py-2.5 rounded-xl border border-white/10 text-sm text-white/60 hover:bg-white/5 transition font-medium">Cancel</button>
                    <button onclick="ManageHQ.confirmRemove()" id="remove-submit-btn"
                        class="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white text-sm font-semibold transition">Remove</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-self-edit" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70 backdrop-blur-sm" onclick="if(event.target===this) ManageHQ.closeModal('modal-self-edit')">
        <div class="w-full max-w-md rounded-3xl border border-line bg-[#0c1020] shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <div class="p-6 border-b border-white/8">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-bold flex items-center gap-2">
                        <i data-lucide="user-pen" class="w-5 h-5 text-cyan-400"></i>
                        Edit Your Info
                    </h3>
                    <button onclick="ManageHQ.closeModal('modal-self-edit')" class="h-8 w-8 rounded-lg hover:bg-white/10 grid place-items-center transition">
                        <i data-lucide="x" class="w-4 h-4 text-white/50"></i>
                    </button>
                </div>
            </div>
            <form id="self-edit-form" class="p-6 space-y-4">
                <input type="hidden" id="self-edit-membership-id" value="">
                <div>
                    <label class="block text-xs font-semibold text-white/60 mb-1.5">Display Name</label>
                    <input type="text" id="self-edit-display-name" placeholder="Custom display name"
                        class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white placeholder:text-white/25 focus:border-cyan-500/40 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-white/60 mb-1.5">In-Game Role</label>
                    {% if game_roles %}
                    <select id="self-edit-player-role" class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white focus:border-cyan-500/40 focus:outline-none transition">
                        <option value="">None</option>
                        {% for gr in game_roles %}
                        <option value="{{ gr.role_name }}">{{ gr.role_name }}</option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <input type="text" id="self-edit-player-role" placeholder="e.g. Duelist, IGL"
                        class="w-full px-4 py-2.5 rounded-xl bg-white/5 border border-white/10 text-sm text-white placeholder:text-white/25 focus:border-cyan-500/40 focus:outline-none transition">
                    {% endif %}
                </div>
                <div>
                    <label class="block text-xs font-semibold text-white/60 mb-2">Roster Photo</label>
                    <div class="flex items-center gap-4">
                        <div id="self-edit-photo-preview" class="h-14 w-14 rounded-xl bg-white/5 border border-white/10 grid place-items-center overflow-hidden shrink-0">
                            <i data-lucide="camera" class="w-5 h-5 text-white/20"></i>
                        </div>
                        <div>
                            <label for="self-edit-photo-input"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-white/10 text-xs font-semibold text-white/70 hover:bg-white/15 transition cursor-pointer">
                                <i data-lucide="upload" class="w-3 h-3"></i> Choose Photo
                            </label>
                            <input type="file" id="self-edit-photo-input" accept="image/jpeg,image/png,image/webp" class="hidden"
                                onchange="ManageHQ.previewSelfPhoto(this)">
                            <p class="text-[11px] text-white/30 mt-1">Max 5 MB</p>
                        </div>
                    </div>
                </div>
                <div id="self-edit-error" class="hidden text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-xl p-3"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="ManageHQ.closeModal('modal-self-edit')"
                        class="flex-1 py-2.5 rounded-xl border border-white/10 text-sm text-white/60 hover:bg-white/5 transition font-medium">Cancel</button>
                    <button type="submit" id="self-edit-submit-btn"
                        class="flex-1 py-2.5 rounded-xl bg-cyan-600 hover:bg-cyan-500 text-white text-sm font-semibold transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    (function() {
        /* â”€â”€ Role-based permission defaults (mirrors backend) â”€â”€ */
        var ROLE_DEFAULTS = {
            OWNER:      ['ALL'],
            MANAGER:    ['register_tournaments','edit_roster','edit_team','schedule_scrims','edit_toc'],
            COACH:      ['edit_toc','schedule_scrims','view_analytics'],
            PLAYER:     ['view_dashboard'],
            SUBSTITUTE: ['view_dashboard'],
            ANALYST:    ['view_analytics'],
            SCOUT:      ['view_player_stats']
        };

        /* When role dropdown changes, auto-fill permissions to role defaults */
        var roleSelect = document.getElementById('role-select');
        if (roleSelect) {
            roleSelect.addEventListener('change', function() {
                var newRole = this.value;
                var defaults = ROLE_DEFAULTS[newRole] || [];
                var isAll = defaults.indexOf('ALL') !== -1;

                /* Hide permissions section for OWNER */
                var permSection = document.getElementById('role-permissions-section');
                if (permSection) {
                    permSection.classList.toggle('hidden', isAll);
                }

                /* Set checkboxes to role defaults */
                document.querySelectorAll('.perm-cb').forEach(function(cb) {
                    cb.checked = isAll || defaults.indexOf(cb.dataset.perm) !== -1;
                });

                /* Show role defaults indicator */
                var indicator = document.getElementById('perm-role-defaults-indicator');
                var label = document.getElementById('perm-role-label');
                if (indicator && !isAll) {
                    indicator.classList.remove('hidden');
                    if (label) label.textContent = newRole.charAt(0) + newRole.slice(1).toLowerCase();
                }

                /* Update override badge */
                _updateOverrideBadge();

                /* Role constraint check */
                _checkRoleConstraint(newRole);
            });
        }

        /* Unique role constraint check */
        var uniqueRoles = {};
        {% for m in members %}
        {% if m.role == 'MANAGER' or m.role == 'COACH' or m.role == 'ANALYST' or m.role == 'SCOUT' %}
        uniqueRoles['{{ m.role }}'] = { id: {{ m.id }}, name: '{{ m.display_name|default:m.user.username|escapejs }}' };
        {% endif %}
        {% endfor %}

        function _checkRoleConstraint(val) {
            var constraintWarn = document.getElementById('role-constraint-warning');
            var constraintText = document.getElementById('role-constraint-text');
            if (!constraintWarn) return;
            var membershipId = document.getElementById('role-membership-id') ? document.getElementById('role-membership-id').value : '';
            if (['MANAGER','COACH','ANALYST','SCOUT'].indexOf(val) !== -1 && uniqueRoles[val]) {
                if (String(uniqueRoles[val].id) !== String(membershipId)) {
                    constraintText.textContent = uniqueRoles[val].name + ' already holds this role. Only one ' + val.charAt(0) + val.slice(1).toLowerCase() + ' is allowed per team.';
                    constraintWarn.classList.remove('hidden');
                    return;
                }
            }
            constraintWarn.classList.add('hidden');
        }

        /* Reset permissions to current role defaults */
        window._resetPermsToRoleDefaults = function() {
            var role = document.getElementById('role-select')?.value || 'PLAYER';
            var defaults = ROLE_DEFAULTS[role] || [];
            document.querySelectorAll('.perm-cb').forEach(function(cb) {
                cb.checked = defaults.indexOf(cb.dataset.perm) !== -1;
            });
            var indicator = document.getElementById('perm-role-defaults-indicator');
            var label = document.getElementById('perm-role-label');
            if (indicator) { indicator.classList.remove('hidden'); }
            if (label) label.textContent = role.charAt(0) + role.slice(1).toLowerCase();
            _updateOverrideBadge();
        };

        /* Track whether any permission differs from role defaults */
        function _updateOverrideBadge() {
            var badge = document.getElementById('perm-override-badge');
            if (!badge) return;
            var role = document.getElementById('role-select')?.value || 'PLAYER';
            var defaults = ROLE_DEFAULTS[role] || [];
            if (defaults.indexOf('ALL') !== -1) { badge.classList.add('hidden'); return; }
            var hasOverride = false;
            document.querySelectorAll('.perm-cb').forEach(function(cb) {
                var isDefault = defaults.indexOf(cb.dataset.perm) !== -1;
                if (cb.checked !== isDefault) hasOverride = true;
            });
            badge.classList.toggle('hidden', !hasOverride);
        }
        document.querySelectorAll('.perm-cb').forEach(function(cb) {
            cb.addEventListener('change', function() {
                _updateOverrideBadge();
                var indicator = document.getElementById('perm-role-defaults-indicator');
                if (indicator) indicator.classList.add('hidden');
            });
        });

        /* â”€â”€ Roster count updater â”€â”€ */
        function updateCounts() {
            var starters = document.querySelectorAll('#roster-starters [data-membership-id]').length;
            var subs = document.querySelectorAll('#roster-subs [data-membership-id]').length;
            var staff = document.querySelectorAll('#roster-staff [data-membership-id]').length;
            var el;
            el = document.getElementById('starter-count'); if (el) el.textContent = starters;
            el = document.getElementById('sub-count'); if (el) el.textContent = subs;
            el = document.getElementById('staff-count'); if (el) el.textContent = staff;
            el = document.getElementById('starter-count-label'); if (el) el.textContent = starters + '/{{ max_team_size }}';
            el = document.getElementById('sub-count-label'); if (el) el.textContent = subs;

            var empty;
            empty = document.getElementById('starters-empty');
            if (empty) empty.classList.toggle('hidden', starters > 0);
            empty = document.getElementById('subs-empty');
            if (empty) empty.classList.toggle('hidden', subs > 0);
            empty = document.getElementById('staff-empty');
            if (empty) empty.classList.toggle('hidden', staff > 0);
        }

        document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', updateCounts) : updateCounts();
    })();
    </script>

</section>
