{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard — DeltaCrown{% endblock %}

{% block content %}
<section class="container py-8">
  <div class="flex items-center justify-between mb-6">
    <h1 class="sec-h">Welcome{% if request.user.first_name %}, {{ request.user.first_name }}{% endif %}</h1>
    <a href="{% url 'teams:create' %}" class="btn-primary">
      <i class="fas fa-plus-circle mr-2"></i>Create Team
    </a>
  </div>

  <!-- Check-in Reminders (FE-T-027: Dashboard Integration) -->
  {% if checkin_reminders %}
    {% for reminder in checkin_reminders %}
      <div class="mb-6 p-4 rounded-xl bg-gradient-to-r from-accent/20 to-primary/20 border border-accent/30">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-lg bg-accent/30 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-clipboard-check text-accent text-xl"></i>
          </div>
          <div class="flex-1">
            <h3 class="font-semibold text-lg mb-1">Check-in Required</h3>
            <p class="text-muted text-sm mb-3">
              <strong>{{ reminder.tournament.name }}</strong> starts {{ reminder.tournament.tournament_start|timeuntil }}. 
              Check-in {% if reminder.tournament.checkin_opens %}opens {{ reminder.tournament.checkin_opens|timeuntil }}{% else %}is now open{% endif %}.
            </p>
            <div class="flex items-center gap-3">
              {% if reminder.has_checked_in %}
                <span class="text-sm px-3 py-1.5 rounded-full bg-green-600/20 text-green-400 flex items-center gap-2">
                  <i class="fas fa-check-circle"></i>
                  Checked In
                </span>
              {% else %}
                <a href="{% url 'tournaments:detail' reminder.tournament.slug %}" class="btn-sm bg-accent hover:bg-accent/80 text-white">
                  <i class="fas fa-clipboard-check mr-1"></i>Check In Now
                </a>
              {% endif %}
              <a href="{% url 'tournaments:detail' reminder.tournament.slug %}" class="btn-sm btn-secondary">
                View Tournament
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  <div class="grid lg:grid-cols-3 gap-6 mt-2">
    <!-- My Teams -->
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-users mr-2 text-primary"></i>
          My Teams
        </h3>
        <a href="{% url 'teams:hub' %}" class="text-sm text-primary hover:underline">View All</a>
      </div>
      {% if my_teams %}
        <ul class="grid gap-3">
          {% for team in my_teams %}
            <li class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 transition">
              <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 bg-gradient-to-br from-primary to-accent">
                {% if team.logo %}
                  <img src="{{ team.logo.url }}" alt="{{ team.name }}" class="w-full h-full object-cover">
                {% else %}
                  <div class="w-full h-full flex items-center justify-center text-white font-bold">
                    {{ team.name|slice:":2"|upper }}
                  </div>
                {% endif %}
              </div>
              <div class="flex-1 min-w-0">
                {% if team.slug %}
                  <a href="{% url 'teams:detail' team.slug %}" class="link-nav font-medium block truncate">{{ team.name }}</a>
                {% else %}
                  <span class="font-medium block truncate opacity-60" title="Team pending setup">{{ team.name }}</span>
                {% endif %}
                <p class="text-xs text-muted">{{ team.game|default:"Multi-game" }}</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-primary/20 text-primary">
                {{ team.member_count|default:1 }}/{{ team.max_roster|default:5 }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-center py-6">
          <i class="fas fa-users text-4xl text-muted/30 mb-3"></i>
          <p class="text-muted text-sm mb-3">You're not part of any teams yet.</p>
          <a href="{% url 'teams:create' %}" class="btn-sm btn-primary">
            <i class="fas fa-plus mr-1"></i>Create Your First Team
          </a>
        </div>
      {% endif %}
    </article>

    <!-- Team Invites -->
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-envelope mr-2 text-accent"></i>
          Team Invites
        </h3>
        <a href="{% url 'teams:my_invites' %}" class="text-sm text-accent hover:underline">View All</a>
      </div>
      {% if pending_invites %}
        <ul class="grid gap-3">
          {% for invite in pending_invites %}
            <li class="p-3 rounded-lg border border-accent/20 bg-accent/5">
              <div class="flex items-center justify-between mb-2">
                {% if invite.team.slug %}
                  <a href="{% url 'teams:detail' invite.team.slug %}" class="link-nav font-medium">{{ invite.team.name }}</a>
                {% else %}
                  <span class="font-medium opacity-60" title="Team pending setup">{{ invite.team.name }}</span>
                {% endif %}
                <span class="text-xs text-muted">{{ invite.get_role_display|default:"Player" }}</span>
              </div>
              <p class="text-xs text-muted mb-2">
                {% if invite.inviter %}
                  Invited by {{ invite.inviter.display_name|default:invite.inviter.user.username }} • {{ invite.created_at|timesince }} ago
                {% else %}
                  Invited {{ invite.created_at|timesince }} ago
                {% endif %}
              </p>
              <div class="flex gap-2">
                <form method="post" action="{% url 'teams:accept_invite' invite.token %}" class="flex-1">
                  {% csrf_token %}
                  <button type="submit" class="w-full btn-sm bg-green-600 hover:bg-green-700 text-white">
                    <i class="fas fa-check mr-1"></i>Accept
                  </button>
                </form>
                <form method="post" action="{% url 'teams:decline_invite' invite.token %}">
                  {% csrf_token %}
                  <button type="submit" class="btn-sm bg-red-600/20 hover:bg-red-600/30 text-red-400">
                    <i class="fas fa-times"></i>
                  </button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-center py-6">
          <i class="fas fa-envelope-open text-4xl text-muted/30 mb-3"></i>
          <p class="text-muted text-sm">No pending invites.</p>
        </div>
      {% endif %}
    </article>

    <!-- Upcoming Matches -->
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-calendar-alt mr-2 text-yellow-500"></i>
          Upcoming Matches
        </h3>
        <a href="{% url 'dashboard:my_matches' %}" class="text-sm text-yellow-500 hover:underline">View All</a>
      </div>
      {% if matches %}
        <ul class="grid gap-2 text-sm">
          {% for m in matches %}
            <li class="flex items-center justify-between p-2 rounded hover:bg-white/5">
              <span class="flex-1 truncate">Match</span>
              <span class="text-muted text-xs">{% if m.when %}{{ m.when|date:"M d, H:i" }}{% else %}TBA{% endif %}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-center py-6">
          <i class="fas fa-calendar-times text-4xl text-muted/30 mb-3"></i>
          <p class="text-muted text-sm">No upcoming matches.</p>
        </div>
      {% endif %}
    </article>
  </div>

  <!-- Second Row: Tournaments & Payouts -->
  <div class="grid lg:grid-cols-2 gap-6 mt-6">
    <!-- My Hosted Tournaments (FE-T-027: Organizer Dashboard Integration) -->
    {% if hosted_tournaments %}
    <article class="glass p-6 rounded-2xl border border-accent/30">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-crown mr-2 text-accent"></i>
          My Hosted Tournaments
        </h3>
        <a href="{% url 'tournaments:list' %}?organizer={{ request.user.username }}" class="text-sm text-accent hover:underline">View All</a>
      </div>
      <ul class="grid gap-3">
        {% for tournament in hosted_tournaments %}
          <li class="p-3 rounded-lg hover:bg-white/5 transition border border-accent/20">
            <div class="flex items-center justify-between mb-2">
              <a href="{% url 'tournaments:organizer_hub' tournament.slug 'overview' %}" class="link-nav font-medium truncate flex-1">
                {{ tournament.name }}
              </a>
              <span class="text-xs px-2 py-1 rounded-full ml-2 flex-shrink-0
                {% if tournament.status == 'LIVE' %}bg-green-600/20 text-green-400
                {% elif tournament.status == 'UPCOMING' %}bg-blue-600/20 text-blue-400
                {% elif tournament.status == 'COMPLETED' %}bg-gray-600/20 text-gray-400
                {% else %}bg-yellow-600/20 text-yellow-400{% endif %}">
                {{ tournament.get_status_display }}
              </span>
            </div>
            <div class="flex items-center gap-3 text-xs text-muted mb-2">
              {% if tournament.game %}
                <span class="px-2 py-0.5 rounded bg-accent/10 text-accent">{{ tournament.game.name }}</span>
              {% endif %}
              <span><i class="fas fa-users mr-1"></i>{{ tournament.registration_count|default:0 }} participants</span>
            </div>
            {% if tournament.pending_actions > 0 %}
              <div class="flex items-center gap-2 text-xs bg-red-600/10 text-red-400 px-2 py-1 rounded">
                <i class="fas fa-bell"></i>
                <span>{{ tournament.pending_actions }} action{{ tournament.pending_actions|pluralize }} needed</span>
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </article>
    {% endif %}

    <!-- Upcoming Matches (FE-T-027: Dashboard Integration) -->
    {% if upcoming_matches %}
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-gamepad mr-2 text-primary"></i>
          Upcoming Matches
        </h3>
        <a href="{% url 'tournaments:my_tournaments' %}" class="text-sm text-primary hover:underline">View All</a>
      </div>
      <ul class="grid gap-3">
        {% for match in upcoming_matches %}
          <li class="p-3 rounded-lg hover:bg-white/5 transition border border-primary/20">
            <div class="flex items-center justify-between mb-2">
              <a href="{% url 'tournaments:detail' match.tournament.slug %}" class="link-nav font-medium text-sm truncate flex-1">
                {{ match.tournament.name }}
              </a>
              <span class="text-xs text-accent ml-2">
                {% if match.scheduled_time %}
                  {% if match.scheduled_time|timeuntil == "0 minutes" %}
                    Now!
                  {% else %}
                    in {{ match.scheduled_time|timeuntil }}
                  {% endif %}
                {% endif %}
              </span>
            </div>
            <div class="flex items-center justify-between text-sm">
              <span class="text-muted">{{ match.participant_a_name }}</span>
              <span class="text-primary font-bold">vs</span>
              <span class="text-muted">{{ match.participant_b_name }}</span>
            </div>
            {% if match.round_name %}
              <div class="text-xs text-muted mt-2">
                <i class="fas fa-layer-group mr-1"></i>{{ match.round_name }}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </article>
    {% endif %}

    <!-- My Tournaments (Sprint 2: Player Dashboard) -->
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-trophy mr-2 text-primary"></i>
          My Tournaments
        </h3>
        <a href="{% url 'tournaments:my_tournaments' %}" class="text-sm text-primary hover:underline">View All</a>
      </div>
      {% if user_tournaments %}
        <ul class="grid gap-3">
          {% for registration in user_tournaments %}
            <li class="p-3 rounded-lg hover:bg-white/5 transition">
              <div class="flex items-center justify-between mb-2">
                <a href="{% url 'tournaments:detail' registration.tournament.slug %}" class="link-nav font-medium truncate flex-1">
                  {{ registration.tournament.name }}
                </a>
                <span class="text-xs px-2 py-1 rounded-full ml-2 flex-shrink-0
                  {% if registration.status == 'confirmed' %}bg-green-600/20 text-green-400
                  {% elif registration.status == 'payment_submitted' %}bg-yellow-600/20 text-yellow-400
                  {% elif registration.status == 'pending' %}bg-blue-600/20 text-blue-400
                  {% else %}bg-gray-600/20 text-gray-400{% endif %}">
                  {{ registration.get_status_display }}
                </span>
              </div>
              <div class="flex items-center gap-3 text-xs text-muted">
                {% if registration.tournament.game %}
                  <span class="px-2 py-0.5 rounded bg-primary/10 text-primary">{{ registration.tournament.game.name }}</span>
                {% endif %}
                {% if registration.tournament.tournament_start %}
                  <span><i class="fas fa-calendar mr-1"></i>{{ registration.tournament.tournament_start|date:"M d" }}</span>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-center py-6">
          <i class="fas fa-trophy text-4xl text-muted/30 mb-3"></i>
          <p class="text-muted text-sm mb-3">You haven't registered for any tournaments yet.</p>
          <a href="{% url 'tournaments:list' %}" class="btn-sm btn-primary">
            <i class="fas fa-search mr-1"></i>Browse Tournaments
          </a>
        </div>
      {% endif %}
    </article>

    <!-- Payouts -->
    <article class="glass p-6 rounded-2xl">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold flex items-center">
          <i class="fas fa-money-bill-wave mr-2 text-green-500"></i>
          Payouts
        </h3>
      </div>
      {% if payouts %}
        <ul class="grid gap-2 text-sm">
          {% for p in payouts %}
            <li class="flex items-center justify-between p-2 rounded hover:bg-white/5">
              <span class="flex-1 truncate">Payout</span>
              <span class="text-green-400 font-semibold">{% if p.amount_bdt %}৳{{ p.amount_bdt }}{% else %}—{% endif %}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="text-center py-6">
          <i class="fas fa-piggy-bank text-4xl text-muted/30 mb-3"></i>
          <p class="text-muted text-sm">No payouts yet. Keep competing!</p>
        </div>
      {% endif %}
    </article>
  </div>
</section>
{% endblock %}
