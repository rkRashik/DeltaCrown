{% extends "base.html" %}
{% block title %}Bracket — {{ tournament.name|default:"Tournament" }} · DeltaCrown{% endblock %}

{% block content %}
{% meta_tags
  title="Bracket — "|add:tournament.name|default:"Bracket"
  description="Tournament bracket, rounds, and matches."
%}

<section aria-labelledby="h1" data-testid="tournament-bracket">
  <header class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 id="h1" class="mb-1">Bracket</h1>
      <p class="text-muted mb-0">
        {{ tournament.name|default:"Tournament" }}
        {% if tournament.game_name %} · {{ tournament.game_name }}{% endif %}
      </p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline" href="{% url 'tournaments:detail' tournament.slug %}">Back to Tournament</a>
    </div>
  </header>

  {#
    Expected context (defensive):
      - rounds: iterable of round objects
        round.title / round.name
        round.matches -> iterable
          match.round_no, match.scheduled_at
          match.team_a{tag|name}/user_a{display_name|username}
          match.team_b{tag|name}/user_b{display_name|username}
          match.score_a, match.score_b
          match.id (for review URL)
          match.status (optional)
  #}

  {% with rs=rounds|default:bracket.rounds %}
  <div class="bracket-scroll" role="region" aria-label="Bracket rounds">
    {% if rs %}
      <div class="bracket-grid">
        {% for r in rs %}
          <section class="bracket-round" aria-labelledby="round-{{ forloop.counter }}">
            <h2 id="round-{{ forloop.counter }}" class="bracket-round-header">
              {{ r.title|default:r.name|default:"Round " }}{% if not r.title and not r.name %}{{ forloop.counter }}{% endif %}
            </h2>

            {% if r.matches %}
              {% for m in r.matches %}
                <article class="match-card">
                  <div class="match-meta">
                    {% if m.round_no %}Round {{ m.round_no }} · {% endif %}
                    {% if m.scheduled_at %}{{ m.scheduled_at|date:"M d, Y h:i A" }}{% else %}TBD{% endif %}
                    {% if m.status %} · {{ m.status|title }}{% endif %}
                  </div>

                  <div class="match-teams">
                    <div class="match-team">
                      <span>
                        {% firstof m.team_a.tag m.team_a.name m.user_a.display_name m.user_a.username "Team A" %}
                      </span>
                      <strong>{% if m.score_a is not None %}{{ m.score_a }}{% else %}—{% endif %}</strong>
                    </div>
                    <div class="match-team">
                      <span>
                        {% firstof m.team_b.tag m.team_b.name m.user_b.display_name m.user_b.username "Team B" %}
                      </span>
                      <strong>{% if m.score_b is not None %}{{ m.score_b }}{% else %}—{% endif %}</strong>
                    </div>
                  </div>

                  <div class="match-actions">
                    {% if m.url %}
                      <a class="btn btn-outline btn-sm" href="{{ m.url }}">Open</a>
                    {% elif m.id %}
                      <a class="btn btn-outline btn-sm" href="{% url 'tournaments:match_review' m.id %}">Open</a>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            {% else %}
              <div class="text-muted small">No matches in this round yet.</div>
            {% endif %}
          </section>
        {% endfor %}
      </div>
    {% else %}
      <article class="card p-3">
        <div class="fw-medium mb-1">No bracket rounds to display</div>
        <p class="mb-0 text-muted">The bracket will appear once matches are generated.</p>
      </article>
    {% endif %}
  </div>
  {% endwith %}

  <div class="mt-3">
    {% include "partials/share_block_bd.html" with title="Bracket — "|add:tournament.name %}
  </div>
</section>
{% endblock %}
