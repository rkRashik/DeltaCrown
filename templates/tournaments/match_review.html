{% extends "base.html" %}
{% load static %}
{% block title %}Match Review — DeltaCrown{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'src/css/matches.css' %}">
{% endblock %}

{% block content %}
{% meta_tags title="Match Review — DeltaCrown" description="Review details, timeline, and share this match." %}

{% with m=match %}
<section aria-labelledby="h1" data-testid="match-review">
  <header class="match-header mb-3">
    <div>
      <h1 id="h1" class="mb-1">Match Review</h1>
      <div class="match-meta">
        {% if m.tournament %}{{ m.tournament.name }}{% else %}Tournament: —{% endif %}
        {% if m.round_no %} · Round {{ m.round_no }}{% endif %}
        {% if m.scheduled_at %} · {{ m.scheduled_at|date:"M d, Y h:i A" }}{% endif %}
      </div>
      {% if error %}
        <div class="alert alert-info mt-3">{{ error }}</div>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      {% if m.id %}
        <a class="btn btn-primary" href="{% url 'tournaments:match_report' m.id %}">Report Result</a>
      {% endif %}
      {% if m.dispute_url %}
        <a class="btn btn-outline" href="{{ m.dispute_url }}">Open Dispute</a>
      {% endif %}
    </div>
  </header>

  <!-- Teams / Score -->
  <article class="card p-3 mb-3">
    <div class="vs-wrap">
      <span>
        {% firstof m.team_a.tag m.user_a.display_name "Team A" %}
      </span>
      <strong>{% if m.score_a is not None %}{{ m.score_a }}{% else %}—{% endif %}</strong>
      <span class="vs-dot">vs</span>
      <strong>{% if m.score_b is not None %}{{ m.score_b }}{% else %}—{% endif %}</strong>
      <span>
        {% firstof m.team_b.tag m.user_b.display_name "Team B" %}
      </span>
    </div>
    {% if m.best_of %}<div class="text-muted mt-2">Best of {{ m.best_of }}</div>{% endif %}
  </article>

  <!-- Timeline / Events (defensive) -->
  <article class="card p-3 mb-3">
    <div class="fw-medium mb-2">Timeline</div>
    {% if events %}
      <div class="timeline">
        {% for e in events %}
          <div class="timeline-item">
            <div class="fw-medium">{{ e.title|default:"Event" }}</div>
            {% if e.at %}<div class="t">{{ e.at|date:"M d, Y h:i A" }}</div>{% endif %}
            {% if e.body %}<div class="mt-1">{{ e.body|safe }}</div>{% endif %}
          </div>
        {% empty %}
          <div class="text-muted">No events yet.</div>
        {% endfor %}
      </div>
    {% elif m.timeline_html %}
      <div class="timeline">{{ m.timeline_html|safe }}</div>
    {% else %}
      <p class="mb-0 text-muted">No events to display.</p>
    {% endif %}
  </article>

  <!-- Comments / Discussion (defensive shell) -->
  <article class="card p-3 mb-3">
    <div class="fw-medium mb-2">Comments</div>
    {% if comments %}
      <ul class="mb-0">
        {% for c in comments %}
          <li class="mb-2">
            <div class="fw-medium">{{ c.author_name|default:c.author.username|default:"User" }}</div>
            <div class="text-muted" style="font-size:.9rem">
              {% if c.created_at %}{{ c.created_at|date:"M d, Y h:i A" }}{% endif %}
            </div>
            {% if c.body %}<div class="mt-1">{{ c.body|linebreaksbr }}</div>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="mb-0 text-muted">No comments yet.</p>
    {% endif %}
  </article>

  <!-- Share (BD-first) -->
  <div class="mt-3">
    {% include "partials/share_block_bd.html" with title="Match Review" %}
  </div>
</section>
{% endwith %}
{% endblock %}
