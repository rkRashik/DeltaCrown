{% extends "tournaments/manage/_base.html" %}
{% load humanize %}

{% block manage_content %}

<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-6">
  <div>
    <h2 class="text-lg font-display font-bold text-white">Brackets &amp; Matches</h2>
    <p class="text-sm text-white/45 mt-0.5">
      {{ matches|length|default:"0" }} matches
      {% if match_stats.completed %}Â· <span class="text-emerald-400">{{ match_stats.completed }} completed</span>{% endif %}
    </p>
  </div>
  <div class="flex items-center gap-2">
    {% if can_manage_bracket %}
      <button class="btn-secondary text-xs !py-2">
        <i data-lucide="shuffle" class="w-3.5 h-3.5"></i>
        Generate Bracket
      </button>
      <button class="btn-secondary text-xs !py-2">
        <i data-lucide="list-ordered" class="w-3.5 h-3.5"></i>
        Seed Participants
      </button>
    {% endif %}
  </div>
</div>

<div class="liquid-glass rounded-2xl p-6 mb-6">
  <div class="flex items-center gap-2 mb-5">
    <i data-lucide="git-merge" class="w-4 h-4 text-purple-400"></i>
    <h3 class="text-sm font-display font-semibold text-white">Bracket Visualization</h3>
  </div>

  {% if bracket_data %}
    <div class="overflow-x-auto pb-4">
      <div class="flex gap-8 min-w-max">
        {% for round in bracket_data.rounds %}
          <div class="flex flex-col gap-4 min-w-[220px]">
            <div class="text-xs font-semibold text-white/50 text-center mb-2 uppercase tracking-wider">
              Round {{ round.number }}
            </div>
            {% for match in round.matches %}
              <div class="liquid-glass rounded-xl p-3 hover:border-white/[0.15] transition">
                <div class="text-[11px] text-white/35 font-mono mb-2">M{{ match.match_number }}</div>
                <div class="space-y-1.5">
                  <div class="flex items-center justify-between gap-2 px-2 py-1.5 rounded-lg
                    {% if match.winner_id == match.participant1_id %}bg-emerald-500/5 border border-emerald-500/10{% else %}bg-white/[0.02]{% endif %}">
                    <span class="text-sm text-white/70 truncate">{{ match.participant1_name|default:"TBD" }}</span>
                    <span class="text-sm font-mono font-bold text-white/60">{{ match.score1|default:"-" }}</span>
                  </div>
                  <div class="flex items-center justify-between gap-2 px-2 py-1.5 rounded-lg
                    {% if match.winner_id == match.participant2_id %}bg-emerald-500/5 border border-emerald-500/10{% else %}bg-white/[0.02]{% endif %}">
                    <span class="text-sm text-white/70 truncate">{{ match.participant2_name|default:"TBD" }}</span>
                    <span class="text-sm font-mono font-bold text-white/60">{{ match.score2|default:"-" }}</span>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div class="empty-state py-12">
      <i data-lucide="git-merge" class="w-10 h-10 mx-auto"></i>
      <p>Bracket not generated yet</p>
      <p class="sub">Generate or import a bracket once registrations are finalized.</p>
    </div>
  {% endif %}
</div>

<div class="liquid-glass rounded-2xl overflow-hidden">
  <div class="flex items-center gap-2 px-6 pt-5 pb-3">
    <i data-lucide="list" class="w-4 h-4 text-cyan-400"></i>
    <h3 class="text-sm font-display font-semibold text-white">Match List</h3>
  </div>

  {% if matches %}
    <div class="overflow-x-auto">
      <table class="data-table">
        <thead>
          <tr>
            <th>Round</th>
            <th>Match</th>
            <th>Participant 1</th>
            <th>Score</th>
            <th>Participant 2</th>
            <th>State</th>
            {% if can_manage_bracket %}<th class="text-right">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for match in matches %}
            <tr class="group">
              <td>
                <span class="text-sm font-mono text-white/50">R{{ match.round_number }}</span>
              </td>
              <td>
                <span class="text-sm font-mono text-white/50">M{{ match.match_number }}</span>
              </td>
              <td>
                <span class="text-sm text-white/70">{{ match.participant1_name|default:"TBD" }}</span>
              </td>
              <td>
                <span class="text-sm font-mono text-white/60">
                  {{ match.participant1_score|default:"-" }} : {{ match.participant2_score|default:"-" }}
                </span>
              </td>
              <td>
                <span class="text-sm text-white/70">{{ match.participant2_name|default:"TBD" }}</span>
              </td>
              <td>
                <span class="badge
                  {% if match.state == 'completed' %}badge-green
                  {% elif match.state == 'in_progress' or match.state == 'live' %}badge-red
                  {% elif match.state == 'scheduled' %}badge-blue
                  {% elif match.state == 'pending_result' %}badge-yellow
                  {% else %}badge-gray{% endif %}">
                  {{ match.get_state_display|default:match.state|title }}
                </span>
              </td>
              {% if can_manage_bracket %}
                <td class="text-right">
                  <div class="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition">
                    <button title="Edit Match"
                            class="p-1.5 rounded-lg hover:bg-white/10 text-white/30 hover:text-white/60 transition">
                      <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <button title="Report Result"
                            class="p-1.5 rounded-lg hover:bg-cyan-500/15 text-white/30 hover:text-cyan-400 transition">
                      <i data-lucide="trophy" class="w-3.5 h-3.5"></i>
                    </button>
                  </div>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty-state py-12">
      <i data-lucide="swords" class="w-10 h-10 mx-auto"></i>
      <p>No matches created yet</p>
      <p class="sub">Matches will appear once a bracket is generated.</p>
    </div>
  {% endif %}
</div>

{% endblock %}
