{% extends "tournaments/base.html" %}
{% load static %}
{% comment %}
  THE HUB — Unified Participant Mission Control (Sprint 12)
  Full-screen SPA shell. Tabs swap via JS; data refreshes via JSON polling.
{% endcomment %}

{% block title %}The Hub — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_css %}
<link rel="stylesheet" href="{% static 'tournaments/css/hub.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  /* Game Theme CSS Custom Properties */
  :root {
    --game-primary: {{ game_primary_color|default:"#00F0FF" }};
    --game-secondary: {{ game_secondary_color|default:"#0C0C10" }};
    --game-accent: {{ game_accent_color|default:"#FFFFFF" }};
  }
  /* Hide primary navigation on Hub page — replaced with hub-specific navbar */
  #dc-navbar, #dc-bottom-nav, #dc-mobile-header { display: none !important; }
  /* Override body padding from primary_navigation.css (nav is hidden) */
  body {
    padding-top: 0 !important;
    padding-bottom: 0 !important;
    margin: 0 !important;
    overflow: hidden;
  }
</style>
{% endblock %}

{% block footer %}{% endblock %}

{% block tournament_content %}

{% comment %}Hub Shell — sits under the primary navigation{% endcomment %}
<div class="hub-shell" id="hub-shell"
     data-slug="{{ tournament.slug }}"
     data-api-state="{{ api_state_url }}"
     data-api-checkin="{{ api_checkin_url }}"
     data-api-announcements="{{ api_announcements_url }}"
     data-api-roster="{{ api_roster_url }}"
     data-api-squad="{{ api_squad_url }}"
     data-api-resources="{{ api_resources_url }}"
     data-api-prize-claim="{{ api_prize_claim_url }}"
     data-api-bracket="{{ api_bracket_url }}"
     data-api-standings="{{ api_standings_url }}"
     data-api-matches="{{ api_matches_url }}"
     data-api-participants="{{ api_participants_url }}"
     data-api-support="{{ api_support_url }}"
     data-tournament-status="{{ tournament.status }}"
     data-check-in-status="{{ check_in_status }}"
     data-is-checked-in="{{ is_checked_in|yesno:'true,false' }}"
     data-is-captain="{{ is_captain|yesno:'true,false' }}"
     data-is-team="{{ is_team|yesno:'true,false' }}"
     data-roster-locked="{{ roster_locked|yesno:'true,false' }}"
>

  {% comment %}Cinematic Background Layers{% endcomment %}
  <div class="hub-bg-cinematic"></div>
  <div class="hub-bg-gradient"></div>
  <div class="hub-tactical-grid"></div>

  {% comment %}Hub Navbar — Replaces site primary nav for immersive experience{% endcomment %}
  <nav class="hub-navbar" id="hub-navbar">
    <div class="hub-navbar-inner">
      {% comment %}Left: Back + Logo + Tournament Identity{% endcomment %}
      <div class="flex items-center gap-3 min-w-0">
        {% comment %}Go Back Button{% endcomment %}
        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="hub-back-btn shrink-0" title="Back to Tournament">
          <i data-lucide="arrow-left" class="w-4 h-4"></i>
        </a>
        <div class="h-6 w-px bg-white/8 hidden sm:block"></div>
        {% comment %}DeltaCrown Logo{% endcomment %}
        <a href="/" class="hub-logo-link shrink-0" title="DeltaCrown Home">
          <img src="{% static 'img/deltaCrown_logos/logo_animated.svg' %}" alt="DeltaCrown" class="w-9 h-9">
        </a>
        <div class="h-6 w-px bg-white/8 hidden sm:block"></div>
        {% comment %}Tournament Identity{% endcomment %}
        <div class="flex flex-col min-w-0">
          <span class="text-base font-bold text-white truncate leading-tight" style="font-family:Outfit,sans-serif;">
            {{ tournament.name|truncatechars:40 }}
          </span>
          <div class="flex items-center gap-2 mt-0.5">
            <span class="hub-badge hub-badge-{% if tournament.status == 'live' %}live{% elif tournament.status == 'completed' %}neutral{% else %}info{% endif %}">
              {% if tournament.status == 'live' %}<span class="w-1.5 h-1.5 rounded-full bg-[#00FF66] animate-pulse"></span>{% endif %}
              {{ tournament.get_status_display|default:tournament.status }}
            </span>
            {% if game_name %}
              <span class="text-[10px] text-gray-500 hidden md:inline" style="font-family:'Space Grotesk',monospace;">{{ game_name }}</span>
            {% endif %}
          </div>
        </div>
      </div>

      {% comment %}Right: Status Chip (clickable) + Mobile Toggle + User{% endcomment %}
      <div class="flex items-center gap-3 shrink-0">
        {% comment %}Status Chip — clickable, opens status detail modal{% endcomment %}
        <button onclick="HubEngine.showStatusModal()" class="hub-status-chip hidden sm:flex" id="hub-status-chip" title="View registration status details">
          <span class="hub-status-dot
            {% if is_checked_in %}bg-[#00FF66] shadow-[0_0_6px_#00FF66]
            {% elif user_status == 'Pending Approval' %}bg-[#FFB800] shadow-[0_0_6px_#FFB800]
            {% elif user_status == 'Confirmed' %}bg-[#00FF66] shadow-[0_0_6px_#00FF66]
            {% else %}bg-[#00F0FF] shadow-[0_0_6px_#00F0FF]{% endif %}"></span>
          <span class="text-[10px] font-bold uppercase tracking-wider" id="hub-status-label">{{ user_status }}</span>
          <i data-lucide="chevron-down" class="w-3 h-3 text-gray-500"></i>
        </button>

        {% comment %}Mobile Sidebar Toggle{% endcomment %}
        <button class="hub-mobile-toggle lg:hidden p-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5"
                onclick="HubEngine.openMobileSidebar()">
          <i data-lucide="panel-left" class="w-4 h-4 text-gray-400"></i>
        </button>

        <div class="h-5 w-px bg-white/8 hidden sm:block"></div>

        {% comment %}User Avatar + Info{% endcomment %}
        <a href="/dashboard/" class="flex items-center gap-2 group cursor-pointer" title="{{ request.user.username }} — Dashboard">
          <div class="text-right hidden md:block">
            <p class="text-sm font-bold text-white group-hover:text-[var(--game-primary)] transition-colors leading-none">{{ request.user.get_full_name|default:request.user.username }}</p>
            {% if is_team and team_name %}
              <p class="text-[10px] text-gray-500 group-hover:text-gray-400 transition-colors" style="font-family:'Space Grotesk',monospace;">{{ team_tag }}{% if is_captain %} (C){% endif %}</p>
            {% endif %}
          </div>
          <div class="w-9 h-9 rounded-lg bg-gradient-to-tr from-[var(--game-primary)]/20 to-[#7000FF]/20 border border-white/10 overflow-hidden">
            {% if request.user.profile.avatar %}
              <img src="{{ request.user.profile.avatar.url }}" class="w-full h-full object-cover" alt="{{ request.user.username }}">
            {% else %}
              <div class="w-full h-full flex items-center justify-center text-[11px] font-bold text-white">{{ request.user.username|truncatechars:2 }}</div>
            {% endif %}
          </div>
        </a>
      </div>
    </div>
  </nav>

  {% comment %}Main Layout: Sidebar + Content{% endcomment %}
  <div class="flex-1 flex overflow-hidden w-full relative" style="z-index:10;">

    {% comment %}Desktop Sidebar{% endcomment %}
    <aside class="hub-sidebar-desktop w-[240px] xl:w-[270px] flex flex-col hub-glass-heavy border-r border-white/5 shrink-0" style="z-index:20;">
      {% include "tournaments/hub/_sidebar.html" %}
    </aside>

    {% comment %}Mobile Sidebar Overlay{% endcomment %}
    <div class="hub-mobile-overlay" id="hub-mobile-overlay" onclick="HubEngine.closeMobileSidebar()"></div>
    <aside class="hub-sidebar-mobile fixed top-0 left-0 bottom-0 w-[280px] flex flex-col hub-glass-heavy border-r border-white/5" id="hub-mobile-sidebar" style="z-index:70;">
      {% include "tournaments/hub/_sidebar.html" %}
    </aside>

    {% comment %}Main Viewport{% endcomment %}
    <main class="flex-1 overflow-y-auto relative" id="hub-viewport">

      {% comment %}Tab: Command Center (Overview){% endcomment %}
      <div id="hub-tab-overview" class="hub-tab-content active">
        {% include "tournaments/hub/_tab_overview.html" %}
      </div>

      {% comment %}Tab: Match Lobby{% endcomment %}
      <div id="hub-tab-matches" class="hub-tab-content">
        {% include "tournaments/hub/_tab_matches.html" %}
      </div>

      {% comment %}Tab: Squad Management{% endcomment %}
      <div id="hub-tab-squad" class="hub-tab-content">
        {% include "tournaments/hub/_tab_squad.html" %}
      </div>

      {% comment %}Tab: Bracket{% endcomment %}
      <div id="hub-tab-bracket" class="hub-tab-content">
        {% include "tournaments/hub/_tab_bracket.html" %}
      </div>

      {% comment %}Tab: Standings{% endcomment %}
      <div id="hub-tab-standings" class="hub-tab-content">
        {% include "tournaments/hub/_tab_standings.html" %}
      </div>

      {% comment %}Tab: Schedule{% endcomment %}
      <div id="hub-tab-schedule" class="hub-tab-content">
        {% include "tournaments/hub/_tab_schedule.html" %}
      </div>

      {% comment %}Tab: Prizes (Bounty Board){% endcomment %}
      <div id="hub-tab-prizes" class="hub-tab-content">
        {% include "tournaments/hub/_tab_prizes.html" %}
      </div>

      {% comment %}Tab: Resources Hub{% endcomment %}
      <div id="hub-tab-resources" class="hub-tab-content">
        {% include "tournaments/hub/_tab_resources.html" %}
      </div>

      {% comment %}Tab: Participants Directory{% endcomment %}
      <div id="hub-tab-participants" class="hub-tab-content">
        {% include "tournaments/hub/_tab_participants.html" %}
      </div>

      {% comment %}Tab: Rulebook (Inline){% endcomment %}
      <div id="hub-tab-rulebook" class="hub-tab-content">
        {% include "tournaments/hub/_tab_rulebook.html" %}
      </div>

      {% comment %}Tab: Support & Disputes{% endcomment %}
      <div id="hub-tab-support" class="hub-tab-content">
        {% include "tournaments/hub/_tab_support.html" %}
      </div>

    </main>
  </div>

  {% comment %}Registration Status Detail Modal{% endcomment %}
  <div id="hub-status-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden" onclick="if(event.target===this)HubEngine.closeStatusModal()">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-md mx-4 hub-glass rounded-2xl border border-white/10 overflow-hidden">
      {% comment %}Modal Header with gradient{% endcomment %}
      <div class="relative p-6 pb-4">
        <div class="absolute inset-0 bg-gradient-to-b from-[#00F0FF]/5 to-transparent pointer-events-none"></div>
        <div class="relative flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#00F0FF]/20 to-[#7000FF]/20 border border-white/10 flex items-center justify-center">
              <i data-lucide="shield-check" class="w-5 h-5 text-[#00F0FF]"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-white" style="font-family:Outfit,sans-serif;">Registration Status</h3>
              <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-0.5" style="font-family:'Space Grotesk',monospace;">{{ status_detail.registered_at_display }}</p>
            </div>
          </div>
          <button onclick="HubEngine.closeStatusModal()" class="p-1.5 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      {% comment %}Current Status Badge{% endcomment %}
      <div class="px-6 pb-4">
        <div class="flex items-center gap-3 p-4 rounded-xl
          {% if status_detail.raw_status == 'confirmed' or status_detail.raw_status == 'auto_approved' %}bg-[#00FF66]/5 border border-[#00FF66]/15
          {% elif status_detail.raw_status == 'pending' %}bg-[#FFB800]/5 border border-[#FFB800]/15
          {% elif status_detail.raw_status == 'payment_submitted' %}bg-[#00F0FF]/5 border border-[#00F0FF]/15
          {% else %}bg-white/[0.02] border border-white/5{% endif %}">
          <div class="w-3 h-3 rounded-full animate-pulse
            {% if status_detail.raw_status == 'confirmed' or status_detail.raw_status == 'auto_approved' %}bg-[#00FF66] shadow-[0_0_10px_#00FF66]
            {% elif status_detail.raw_status == 'pending' %}bg-[#FFB800] shadow-[0_0_10px_#FFB800]
            {% elif status_detail.raw_status == 'payment_submitted' %}bg-[#00F0FF] shadow-[0_0_10px_#00F0FF]
            {% else %}bg-white/40{% endif %}"></div>
          <span class="text-sm font-bold
            {% if status_detail.raw_status == 'confirmed' or status_detail.raw_status == 'auto_approved' %}text-[#00FF66]
            {% elif status_detail.raw_status == 'pending' %}text-[#FFB800]
            {% elif status_detail.raw_status == 'payment_submitted' %}text-[#00F0FF]
            {% else %}text-white{% endif %}">{{ status_detail.label }}</span>
        </div>
      </div>

      {% comment %}Status Timeline{% endcomment %}
      <div class="px-6 pb-6">
        <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest mb-4">Progress Timeline</p>
        <div class="space-y-0" id="status-timeline">
          {% for step in status_detail.steps %}
          <div class="flex items-start gap-3 relative {% if not forloop.last %}pb-5{% endif %}">
            {% if not forloop.last %}
            <div class="absolute left-[11px] top-6 bottom-0 w-px {% if step.done %}bg-[#00F0FF]/30{% else %}bg-white/5{% endif %}"></div>
            {% endif %}
            <div class="w-6 h-6 rounded-full flex items-center justify-center shrink-0 relative z-10
              {% if step.error %}bg-[#FF2A55]/20 text-[#FF2A55]
              {% elif step.done %}bg-[#00F0FF]/15 text-[#00F0FF]
              {% elif step.active %}bg-[#FFB800]/15 text-[#FFB800]
              {% else %}bg-white/5 text-gray-600{% endif %}">
              <i data-lucide="{{ step.icon }}" class="w-3.5 h-3.5"></i>
            </div>
            <span class="text-sm pt-0.5
              {% if step.error %}text-[#FF2A55] font-bold
              {% elif step.done %}text-white font-medium
              {% elif step.active %}text-[#FFB800] font-bold
              {% else %}text-gray-500{% endif %}">{{ step.label }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      {% comment %}Action Buttons{% endcomment %}
      <div class="px-6 pb-6 space-y-2">
        {% if status_detail.raw_status == 'pending' or status_detail.raw_status == 'needs_review' %}
        <p class="text-xs text-gray-400 mb-3">The organizer will review your registration. You'll be notified once it's confirmed.</p>
        {% endif %}
        {% if contact_email %}
        <a href="mailto:{{ contact_email }}?subject=Registration%20Status%20-%20{{ tournament.name|urlencode }}"
           class="w-full px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-all flex items-center justify-center gap-2 text-xs font-bold text-white">
          <i data-lucide="mail" class="w-4 h-4 text-[#00F0FF]"></i> Contact Organizer
        </a>
        {% endif %}
        <button onclick="HubEngine.closeStatusModal()"
           class="w-full px-4 py-2.5 rounded-xl bg-white/[0.03] hover:bg-white/[0.06] text-xs font-medium text-gray-400 hover:text-white transition-all">
          Close
        </button>
      </div>
    </div>
  </div>

  {% comment %}Contact Admin Modal{% endcomment %}
  <div id="hub-contact-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden" onclick="if(event.target===this)HubEngine.closeContactModal()">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-md mx-4 hub-glass rounded-2xl border border-white/10 p-6 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-bold text-white" style="font-family:Outfit,sans-serif;">Contact Organizer</h3>
        <button onclick="HubEngine.closeContactModal()" class="p-1.5 rounded-lg hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <p class="text-sm text-gray-400">Reach out to the tournament organizer.</p>
      <div class="space-y-3">
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
          <div class="w-10 h-10 rounded-lg bg-[#7000FF]/10 flex items-center justify-center">
            <i data-lucide="user" class="w-5 h-5 text-[#7000FF]"></i>
          </div>
          <div>
            <p class="text-[10px] text-gray-500 uppercase tracking-widest">Organizer</p>
            <p class="text-sm font-medium text-white">{{ organizer_name }}</p>
          </div>
        </div>
        {% if contact_email %}
        <a href="mailto:{{ contact_email }}?subject=Tournament%20Inquiry%20-%20{{ tournament.name|urlencode }}"
           class="w-full px-4 py-3 rounded-xl bg-[#00F0FF]/10 hover:bg-[#00F0FF]/20 border border-[#00F0FF]/20 transition-all flex items-center justify-center gap-2 text-sm font-bold text-[#00F0FF]">
          <i data-lucide="mail" class="w-4 h-4"></i> Send Email
        </a>
        {% endif %}
        {% if discord_url %}
        <a href="{{ discord_url }}" target="_blank" rel="noopener"
           class="w-full px-4 py-3 rounded-xl bg-[#5865F2]/10 hover:bg-[#5865F2]/20 border border-[#5865F2]/20 transition-all flex items-center justify-center gap-2 text-sm font-bold text-[#5865F2]">
          <i data-lucide="message-circle" class="w-4 h-4"></i> Join Discord
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  {% comment %}Welcome Guide Overlay (shown once){% endcomment %}
  <div id="hub-welcome-guide" class="fixed inset-0 z-[100] flex items-center justify-center hidden" onclick="if(event.target===this)HubEngine.dismissGuide()">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-lg mx-4 hub-glass rounded-2xl border border-white/10 p-8 space-y-6">
      <div class="text-center">
        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-[#00F0FF]/20 to-[#7000FF]/20 border border-white/10 flex items-center justify-center mx-auto mb-4">
          <i data-lucide="compass" class="w-7 h-7 text-[#00F0FF]"></i>
        </div>
        <h3 class="text-xl font-bold text-white" style="font-family:Outfit,sans-serif;">Welcome to The Hub</h3>
        <p class="text-sm text-gray-400 mt-2">Your tournament mission control. Here's what you can do:</p>
      </div>
      <div class="space-y-3">
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
          <i data-lucide="layout-dashboard" class="w-5 h-5 text-[#00F0FF] shrink-0"></i>
          <div>
            <p class="text-sm font-medium text-white">Overview</p>
            <p class="text-xs text-gray-500">Announcements, countdown, and tournament status at a glance.</p>
          </div>
        </div>
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
          <i data-lucide="swords" class="w-5 h-5 text-[#FF2A55] shrink-0"></i>
          <div>
            <p class="text-sm font-medium text-white">Match Lobby</p>
            <p class="text-xs text-gray-500">Check in, view match details, and submit results.</p>
          </div>
        </div>
        {% if is_team %}
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
          <i data-lucide="shield" class="w-5 h-5 text-[#FFB800] shrink-0"></i>
          <div>
            <p class="text-sm font-medium text-white">Squad Management</p>
            <p class="text-xs text-gray-500">Manage your roster, verify Game IDs, and swap players.</p>
          </div>
        </div>
        {% endif %}
        <div class="flex items-center gap-3 p-3 rounded-xl bg-white/[0.02] border border-white/5">
          <i data-lucide="git-merge" class="w-5 h-5 text-[#00FF66] shrink-0"></i>
          <div>
            <p class="text-sm font-medium text-white">Bracket & Standings</p>
            <p class="text-xs text-gray-500">Live bracket visualization and leaderboard rankings.</p>
          </div>
        </div>
      </div>
      <button onclick="HubEngine.dismissGuide()"
              class="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-[#00F0FF] to-[#7000FF] text-white font-bold text-sm hover:opacity-90 transition-opacity">
        Got it, let's go!
      </button>
    </div>
  </div>

</div>
{% endblock %}

{% block tournament_js %}
<script src="{% static 'tournaments/js/hub-engine.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') lucide.createIcons();
    HubEngine.init();
  });
</script>
{% endblock %}
