{# Knockout Panel - Displays knockout bracket for GROUP_PLAYOFF tournaments #}

{% if bracket %}
  <div class="td-knockout-wrapper">
    <div class="td-knockout-scroller">
      <div class="td-knockout-rounds">

        {# TODO: Implement rounds iteration when bracket structure is finalized #}
        {# For now, we'll show a skeleton based on bracket nodes #}
        {# This will need to be enhanced based on actual bracket.rounds or BracketNode structure #}
        
        {% comment %}
        STRUCTURE NOTES:
        - If bracket.rounds exists: iterate directly
        - If not, query BracketNode objects grouped by round
        - Each round should have matches ordered vertically
        {% endcomment %}
        
        {# Placeholder rounds - will be replaced with actual data #}
        {% if bracket.nodes.exists %}
          {# Get unique rounds from bracket nodes #}
          {% regroup bracket.nodes.all by round_number as rounds_grouped %}
          
          {% for round_group in rounds_grouped %}
            <section class="td-knockout-round">
              <header class="td-knockout-round-header">
                <h3 class="td-knockout-round-title">
                  {% if round_group.grouper == 1 %}
                    Finals
                  {% elif round_group.grouper == 2 %}
                    Semi-Finals
                  {% elif round_group.grouper == 3 %}
                    Quarter-Finals
                  {% else %}
                    Round {{ round_group.grouper }}
                  {% endif %}
                </h3>
              </header>

              <div class="td-knockout-round-body">
                {% for node in round_group.list %}
                  {# Get associated match if exists #}
                  {% with match=node.match %}
                    <article class="td-knockout-match td-knockout-match-state-{{ match.state|default:'scheduled' }}">
                      <div class="td-ko-team {% if match.winner_id == match.participant1_id %}is-winner{% endif %}">
                        <span class="td-ko-team-name">
                          {% if node.participant1_name %}
                            {{ node.participant1_name }}
                          {% else %}
                            TBD
                          {% endif %}
                        </span>
                        <span class="td-ko-team-score">
                          {% if match.state == 'completed' or match.state == 'live' %}
                            {{ match.participant1_score|default:'-' }}
                          {% else %}
                            -
                          {% endif %}
                        </span>
                      </div>
                      <div class="td-ko-team {% if match.winner_id == match.participant2_id %}is-winner{% endif %}">
                        <span class="td-ko-team-name">
                          {% if node.participant2_name %}
                            {{ node.participant2_name }}
                          {% else %}
                            TBD
                          {% endif %}
                        </span>
                        <span class="td-ko-team-score">
                          {% if match.state == 'completed' or match.state == 'live' %}
                            {{ match.participant2_score|default:'-' }}
                          {% else %}
                            -
                          {% endif %}
                        </span>
                      </div>

                      {% if match %}
                        {% if match.state == 'live' %}
                          <div class="td-ko-match-status is-live">LIVE</div>
                        {% elif match.state == 'completed' %}
                          <div class="td-ko-match-status is-completed">Final</div>
                        {% else %}
                          <div class="td-ko-match-status is-upcoming">Upcoming</div>
                        {% endif %}
                      {% else %}
                        <div class="td-ko-match-status is-upcoming">Scheduled</div>
                      {% endif %}
                    </article>
                  {% endwith %}
                {% endfor %}
              </div>
            </section>
          {% endfor %}
          
        {% else %}
          {# Fallback: Show simple message if no nodes yet #}
          <div class="td-knockout-placeholder">
            <div class="td-empty-icon">üèÜ</div>
            <p class="td-empty-title">Bracket generation in progress...</p>
            <p class="td-empty-subtitle">The knockout bracket structure will appear here shortly.</p>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
{% else %}
  <div class="td-knockout-empty">
    {% if is_multi_stage and current_stage == 'group_stage' %}
      <div class="td-empty-icon">üèÜ</div>
      <p class="td-empty-title">Knockout has not started yet.</p>
      <p class="td-empty-subtitle">Once the group stage is complete, the bracket will appear here.</p>
    {% else %}
      <div class="td-empty-icon">üèÜ</div>
      <p class="td-empty-title">No bracket available.</p>
      <p class="td-empty-subtitle">The bracket will be generated after tournament seeding is complete.</p>
    {% endif %}
  </div>
{% endif %}
