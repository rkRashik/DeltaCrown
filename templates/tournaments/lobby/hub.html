{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Lobby Hub — FE-T-007
   Context: tournament, lobby, registration, check_in,
            roster_data, announcements, is_check_in_open,
            check_in_status, check_in_countdown
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Lobby — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

{# ── Tournament & Lobby Header ── #}
<div class="relative overflow-hidden">
  <div class="absolute inset-0 bg-gradient-to-b from-dc-cyan/5 to-transparent"></div>
  <div class="relative max-w-6xl mx-auto px-4 sm:px-6 py-10">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition mb-2 inline-block">
          <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Back to Tournament
        </a>
        <h1 class="text-2xl sm:text-3xl font-display font-bold text-white">{{ tournament.name }}</h1>
        <p class="text-sm text-gray-400 mt-1">Participant Lobby</p>
      </div>
      <div class="flex items-center gap-3">
        {% if registration %}
          <span class="px-3 py-1.5 text-xs rounded-full
            {% if registration.status == 'confirmed' %}bg-green-900/40 text-green-400 border border-green-700/30
            {% elif registration.status == 'pending' %}bg-yellow-900/40 text-yellow-400 border border-yellow-700/30
            {% else %}bg-gray-800/40 text-gray-400 border border-gray-700/30{% endif %}
          ">{{ registration.get_status_display|default:registration.status|title }}</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="max-w-6xl mx-auto px-4 sm:px-6 pb-12">

  {# ── Check-In Card ── #}
  <div class="glass rounded-xl p-6 mb-6 neon-border-cyan">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center
          {% if check_in %}bg-green-900/30{% elif is_check_in_open %}bg-dc-cyan/10{% else %}bg-dc-surface{% endif %}">
          {% if check_in %}
            <i data-lucide="check-circle-2" class="w-7 h-7 text-green-400"></i>
          {% elif is_check_in_open %}
            <i data-lucide="radio" class="w-7 h-7 text-dc-cyan animate-pulse"></i>
          {% else %}
            <i data-lucide="clock" class="w-7 h-7 text-gray-500"></i>
          {% endif %}
        </div>
        <div>
          {% if check_in %}
            <h3 class="text-lg font-display font-bold text-green-400">Checked In</h3>
            <p class="text-xs text-gray-400">You're ready to compete</p>
          {% elif is_check_in_open %}
            <h3 class="text-lg font-display font-bold text-dc-cyan">Check-In Open</h3>
            <p class="text-xs text-gray-400">
              {% if check_in_countdown > 0 %}
                Closes in <span class="text-white font-mono" id="countdown">{{ check_in_countdown|floatformat:0 }}s</span>
              {% else %}
                Check in now to confirm your spot
              {% endif %}
            </p>
          {% else %}
            <h3 class="text-lg font-display font-bold text-gray-400">Check-In Not Open</h3>
            <p class="text-xs text-gray-500">{{ check_in_status|default:"Check-in will open soon" }}</p>
          {% endif %}
        </div>
      </div>
      {% if not check_in and is_check_in_open %}
        <form method="post" action="{% url 'tournaments:check_in' tournament.slug %}">
          {% csrf_token %}
          <button type="submit"
                  class="px-6 py-3 bg-dc-cyan text-dc-dark font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition-all shadow-[0_0_20px_rgba(6,182,212,0.3)]">
            <i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Check In Now
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    {# ── Left Column: Roster ── #}
    <div class="lg:col-span-2 space-y-6">

      {# Roster Section #}
      <div class="glass rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-dc-border flex items-center justify-between">
          <h3 class="text-sm font-display font-semibold text-white">
            <i data-lucide="users" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Participant Roster
          </h3>
          {% if roster_data.stats %}
            <span class="text-xs text-gray-500">
              {{ roster_data.stats.checked_in|default:0 }}/{{ roster_data.stats.total|default:0 }} checked in
            </span>
          {% endif %}
        </div>

        {# Check-in progress bar #}
        {% if roster_data.stats.total %}
          <div class="px-6 py-2 bg-white/[0.01]">
            <div class="h-1.5 bg-dc-surface rounded-full overflow-hidden">
              <div class="h-full bg-gradient-to-r from-dc-cyan to-green-400 rounded-full transition-all duration-700"
                   style="width: {% widthratio roster_data.stats.checked_in roster_data.stats.total 100 %}%"></div>
            </div>
          </div>
        {% endif %}

        <div class="divide-y divide-dc-border" id="roster-list"
             hx-get="{% url 'tournaments:lobby_roster' tournament.slug %}"
             hx-trigger="every 15s"
             hx-swap="innerHTML">
          {% if roster_data.participants %}
            {% for p in roster_data.participants %}
              <div class="flex items-center justify-between px-6 py-3 hover:bg-white/[0.02] transition">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-full bg-dc-surface flex items-center justify-center text-xs font-mono text-gray-400">
                    {{ forloop.counter }}
                  </div>
                  <div>
                    <p class="text-sm text-white">{{ p.display_name|default:p.username }}</p>
                    {% if p.team_name %}
                      <p class="text-[10px] text-gray-500">{{ p.team_name }}</p>
                    {% endif %}
                  </div>
                </div>
                <div>
                  {% if p.checked_in %}
                    <span class="px-2 py-0.5 text-[10px] rounded-full bg-green-900/40 text-green-400 border border-green-700/30">
                      <i data-lucide="check" class="w-3 h-3 inline"></i> Ready
                    </span>
                  {% else %}
                    <span class="px-2 py-0.5 text-[10px] rounded-full bg-gray-800/40 text-gray-500 border border-gray-700/30">Waiting</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="px-6 py-12 text-center">
              <i data-lucide="users" class="w-8 h-8 text-gray-700 mx-auto mb-2"></i>
              <p class="text-sm text-gray-500">No participants yet</p>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    {# ── Right Column: Announcements & Info ── #}
    <div class="space-y-6">

      {# Announcements #}
      <div class="glass rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-dc-border">
          <h3 class="text-sm font-display font-semibold text-white">
            <i data-lucide="megaphone" class="w-4 h-4 inline mr-1 text-dc-gold"></i> Announcements
          </h3>
        </div>
        <div class="divide-y divide-dc-border" id="announcements-list"
             hx-get="{% url 'tournaments:lobby_announcements' tournament.slug %}"
             hx-trigger="every 30s"
             hx-swap="innerHTML">
          {% if announcements %}
            {% for ann in announcements %}
              <div class="px-6 py-4 {% if ann.is_pinned %}bg-dc-gold/[0.03]{% endif %}">
                {% if ann.is_pinned %}
                  <span class="text-[10px] text-dc-gold uppercase tracking-wider">
                    <i data-lucide="pin" class="w-3 h-3 inline"></i> Pinned
                  </span>
                {% endif %}
                <p class="text-sm text-white mt-1">{{ ann.message }}</p>
                <p class="text-[10px] text-gray-600 mt-1">
                  {{ ann.created_at|timesince }} ago
                  {% if ann.posted_by %} · {{ ann.posted_by }}{% endif %}
                </p>
              </div>
            {% endfor %}
          {% else %}
            <div class="px-6 py-8 text-center">
              <i data-lucide="bell-off" class="w-6 h-6 text-gray-700 mx-auto mb-1"></i>
              <p class="text-xs text-gray-600">No announcements yet</p>
            </div>
          {% endif %}
        </div>
      </div>

      {# Tournament Quick Info #}
      <div class="glass rounded-xl p-6">
        <h3 class="text-sm font-display font-semibold text-white mb-4">
          <i data-lucide="info" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Quick Info
        </h3>
        <dl class="space-y-3 text-sm">
          {% if tournament.game %}
            <div class="flex justify-between">
              <dt class="text-gray-500">Game</dt>
              <dd class="text-white">{{ tournament.game.name }}</dd>
            </div>
          {% endif %}
          <div class="flex justify-between">
            <dt class="text-gray-500">Format</dt>
            <dd class="text-white">{{ tournament.get_format_display|default:tournament.format|title }}</dd>
          </div>
          {% if tournament.tournament_start %}
            <div class="flex justify-between">
              <dt class="text-gray-500">Starts</dt>
              <dd class="text-white">{{ tournament.tournament_start|date:"M d, g:i A" }}</dd>
            </div>
          {% endif %}
          {% if tournament.prize_pool %}
            <div class="flex justify-between">
              <dt class="text-gray-500">Prize Pool</dt>
              <dd class="text-dc-gold font-mono">৳{{ tournament.prize_pool|intcomma }}</dd>
            </div>
          {% endif %}
        </dl>
        <div class="mt-4 pt-4 border-t border-dc-border">
          <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-xs text-dc-cyan hover:underline">
            View Full Details <i data-lucide="external-link" class="w-3 h-3 inline"></i>
          </a>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block tournament_js %}
<script>
  // Countdown timer
  {% if is_check_in_open and check_in_countdown > 0 and not check_in %}
  (function() {
    let remaining = {{ check_in_countdown }};
    const el = document.getElementById('countdown');
    if (!el) return;
    const tick = setInterval(() => {
      remaining--;
      if (remaining <= 0) { clearInterval(tick); location.reload(); return; }
      const m = Math.floor(remaining / 60);
      const s = remaining % 60;
      el.textContent = m > 0 ? `${m}m ${s}s` : `${s}s`;
    }, 1000);
  })();
  {% endif %}
</script>
{% endblock %}
