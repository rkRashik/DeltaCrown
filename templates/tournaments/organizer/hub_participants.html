{% extends "tournaments/organizer/_hub_base.html" %}
{% load humanize %}

{# ─────────────────────────────────────────────────────────
   Organizer Hub — Participants Tab
   Registration list with approve/reject, filters, search
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block hub_content %}

{# ── Header + Actions ── #}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
  <h2 class="text-lg font-display font-bold text-white">Participants</h2>

  {% if can_manage %}
    <div class="flex items-center gap-2">
      <button onclick="document.getElementById('bulk-actions').classList.toggle('hidden')"
              class="text-xs px-3 py-2 rounded-lg bg-white/[0.05] text-gray-400 hover:text-white transition">
        <i data-lucide="check-square" class="w-3 h-3 inline mr-1"></i> Bulk Actions
      </button>
    </div>
  {% endif %}
</div>

{# ── Filters ── #}
<form method="get" class="flex flex-wrap items-center gap-3 mb-6">
  {# Search #}
  <div class="relative flex-1 min-w-[200px]">
    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-600"></i>
    <input type="text" name="search" value="{{ request.GET.search }}"
           placeholder="Search by username, email, or team…"
           class="w-full pl-10 pr-4 py-2.5 bg-dc-surface border border-dc-border rounded-xl text-sm text-white placeholder-gray-600 focus:border-dc-cyan/40 focus:outline-none transition">
  </div>

  {# Status filter #}
  <select name="status"
          class="bg-dc-surface border border-dc-border rounded-xl text-sm text-white px-3 py-2.5 focus:border-dc-cyan/40 focus:outline-none">
    <option value="">All Statuses</option>
    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
    <option value="confirmed" {% if request.GET.status == 'confirmed' %}selected{% endif %}>Confirmed</option>
    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
    <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
  </select>

  {# Check-in filter #}
  <select name="checked_in"
          class="bg-dc-surface border border-dc-border rounded-xl text-sm text-white px-3 py-2.5 focus:border-dc-cyan/40 focus:outline-none">
    <option value="">Check-in</option>
    <option value="yes" {% if request.GET.checked_in == 'yes' %}selected{% endif %}>Checked In</option>
    <option value="no" {% if request.GET.checked_in == 'no' %}selected{% endif %}>Not Checked In</option>
  </select>

  <button type="submit" class="px-4 py-2.5 bg-dc-cyan/10 text-dc-cyan text-sm rounded-xl hover:bg-dc-cyan/20 transition">
    Filter
  </button>
</form>

{# ── Bulk Actions Bar (hidden by default) ── #}
{% if can_manage %}
<div id="bulk-actions" class="hidden mb-4 glass rounded-xl p-4 flex items-center gap-3">
  <span class="text-xs text-gray-400"><span id="selected-count-display">0</span> selected</span>
  <button class="text-xs px-3 py-1.5 bg-green-600/20 text-green-400 rounded-lg hover:bg-green-600/30 transition">Approve</button>
  <button class="text-xs px-3 py-1.5 bg-red-600/20 text-red-400 rounded-lg hover:bg-red-600/30 transition">Reject</button>
  <button class="text-xs px-3 py-1.5 bg-dc-cyan/20 text-dc-cyan rounded-lg hover:bg-dc-cyan/30 transition">Check In</button>
</div>
{% endif %}

{# ── Registration Table ── #}
{% if registrations %}
  <div class="glass rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-dc-border text-[11px] uppercase tracking-wider text-gray-500">
            {% if can_manage %}<th class="px-4 py-3 text-left"><input type="checkbox" id="select-all" class="rounded"></th>{% endif %}
            <th class="px-4 py-3 text-left">Player</th>
            <th class="px-4 py-3 text-left">Team</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">Check-In</th>
            <th class="px-4 py-3 text-left">Registered</th>
            {% if can_manage %}<th class="px-4 py-3 text-right">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-dc-border">
          {% for reg in registrations %}
            <tr class="hover:bg-white/[0.02] transition">
              {% if can_manage %}
                <td class="px-4 py-3"><input type="checkbox" name="reg_ids" value="{{ reg.id }}" class="reg-checkbox rounded"></td>
              {% endif %}
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-full bg-dc-surface flex items-center justify-center text-[10px] font-bold text-dc-cyan flex-shrink-0">
                    {{ reg.user.username|first|upper }}
                  </div>
                  <div>
                    <p class="text-white">{{ reg.user.username }}</p>
                    <p class="text-[10px] text-gray-600">{{ reg.user.email|default:"—" }}</p>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3 text-gray-400">{{ reg.team.name|default:"—" }}</td>
              <td class="px-4 py-3">
                <span class="text-[10px] px-2 py-0.5 rounded-full font-mono
                  {% if reg.status == 'confirmed' %}bg-green-600/20 text-green-400
                  {% elif reg.status == 'pending' %}bg-yellow-600/20 text-yellow-400
                  {% elif reg.status == 'rejected' %}bg-red-600/20 text-red-400
                  {% else %}bg-gray-600/20 text-gray-400{% endif %}">
                  {{ reg.status|title }}
                </span>
              </td>
              <td class="px-4 py-3">
                {% if reg.checked_in %}
                  <span class="text-green-400"><i data-lucide="check-circle-2" class="w-4 h-4 inline"></i></span>
                {% else %}
                  <span class="text-gray-600"><i data-lucide="circle" class="w-4 h-4 inline"></i></span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-gray-500 text-xs">{{ reg.created_at|timesince }} ago</td>
              {% if can_manage %}
                <td class="px-4 py-3 text-right">
                  <div class="flex items-center justify-end gap-1">
                    {% if reg.status == 'pending' %}
                      <button title="Approve" class="p-1.5 rounded-lg hover:bg-green-600/20 text-gray-500 hover:text-green-400 transition">
                        <i data-lucide="check" class="w-3.5 h-3.5"></i>
                      </button>
                      <button title="Reject" class="p-1.5 rounded-lg hover:bg-red-600/20 text-gray-500 hover:text-red-400 transition">
                        <i data-lucide="x" class="w-3.5 h-3.5"></i>
                      </button>
                    {% endif %}
                    {% if not reg.checked_in %}
                      <button title="Check In" class="p-1.5 rounded-lg hover:bg-dc-cyan/20 text-gray-500 hover:text-dc-cyan transition">
                        <i data-lucide="log-in" class="w-3.5 h-3.5"></i>
                      </button>
                    {% endif %}
                  </div>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="text-center py-16 glass rounded-xl">
    <i data-lucide="users" class="w-10 h-10 text-gray-700 mx-auto mb-3"></i>
    <p class="text-gray-400 mb-1">No participants found</p>
    <p class="text-xs text-gray-600">Participants will appear here when players register.</p>
  </div>
{% endif %}

{% endblock %}
