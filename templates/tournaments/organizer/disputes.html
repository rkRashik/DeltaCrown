{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Dispute Management — FE-T-025
   Context: tournament, disputes, all_disputes_count,
            open_count, under_review_count, resolved_count,
            status_filter
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Disputes — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">

  {# ── Header ── #}
  <div class="mb-6">
    <a href="{% url 'tournaments:organizer_tournament_detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition mb-2 inline-block">
      <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Organizer Hub
    </a>
    <h1 class="text-2xl font-display font-bold text-white">Dispute Management</h1>
  </div>

  {# ── Stats Row ── #}
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
    <a href="?" class="glass rounded-xl p-4 text-center hover:bg-white/[0.03] transition {% if not status_filter %}neon-border-cyan{% endif %}">
      <p class="text-2xl font-display font-bold text-white">{{ all_disputes_count }}</p>
      <p class="text-[10px] text-gray-500 uppercase tracking-wider">All</p>
    </a>
    <a href="?status=open" class="glass rounded-xl p-4 text-center hover:bg-white/[0.03] transition {% if status_filter == 'open' %}neon-border-cyan{% endif %}">
      <p class="text-2xl font-display font-bold text-red-400">{{ open_count }}</p>
      <p class="text-[10px] text-gray-500 uppercase tracking-wider">Open</p>
    </a>
    <a href="?status=under_review" class="glass rounded-xl p-4 text-center hover:bg-white/[0.03] transition {% if status_filter == 'under_review' %}neon-border-cyan{% endif %}">
      <p class="text-2xl font-display font-bold text-yellow-400">{{ under_review_count }}</p>
      <p class="text-[10px] text-gray-500 uppercase tracking-wider">Reviewing</p>
    </a>
    <a href="?status=resolved" class="glass rounded-xl p-4 text-center hover:bg-white/[0.03] transition {% if status_filter == 'resolved' %}neon-border-cyan{% endif %}">
      <p class="text-2xl font-display font-bold text-green-400">{{ resolved_count }}</p>
      <p class="text-[10px] text-gray-500 uppercase tracking-wider">Resolved</p>
    </a>
  </div>

  {# ── Dispute List ── #}
  {% if disputes %}
    <div class="space-y-4">
      {% for dispute in disputes %}
        <div class="glass rounded-xl p-6">
          <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 text-[10px] rounded-full
                  {% if dispute.status == 'open' %}bg-red-900/40 text-red-400 border border-red-700/30
                  {% elif dispute.status == 'under_review' %}bg-yellow-900/40 text-yellow-400 border border-yellow-700/30
                  {% elif dispute.status == 'resolved' %}bg-green-900/40 text-green-400 border border-green-700/30
                  {% else %}bg-gray-800/40 text-gray-400 border border-gray-700/30{% endif %}">
                  {{ dispute.get_status_display|default:dispute.status|title }}
                </span>
                {% if dispute.match %}
                  <span class="text-[10px] text-gray-600 font-mono">
                    R{{ dispute.match.round_number }}·M{{ dispute.match.match_number }}
                  </span>
                {% endif %}
              </div>

              <h3 class="text-sm font-medium text-white">{{ dispute.reason|default:"Dispute" }}</h3>

              {% if dispute.match %}
                <p class="text-xs text-gray-400 mt-1">
                  {% if dispute.match.participant1 %}{{ dispute.match.participant1.user.username }}{% endif %}
                  vs
                  {% if dispute.match.participant2 %}{{ dispute.match.participant2.user.username }}{% endif %}
                </p>
              {% endif %}

              {% if dispute.initiated_by %}
                <p class="text-[10px] text-gray-600 mt-1">
                  Filed by {{ dispute.initiated_by.username }} · {{ dispute.created_at|timesince }} ago
                </p>
              {% endif %}

              {% if dispute.evidence %}
                <div class="mt-3 p-3 bg-dc-surface rounded-lg">
                  <p class="text-xs text-gray-400">{{ dispute.evidence|truncatewords:50 }}</p>
                </div>
              {% endif %}
            </div>

            {# Actions #}
            {% if dispute.status != 'resolved' %}
              <div class="flex items-center gap-2 flex-shrink-0">
                {% if dispute.status == 'open' %}
                  <button class="px-3 py-2 bg-yellow-900/40 text-yellow-400 text-xs rounded-lg border border-yellow-700/30 hover:bg-yellow-900/60 transition">
                    <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i> Review
                  </button>
                {% endif %}
                <button class="px-3 py-2 bg-green-900/40 text-green-400 text-xs rounded-lg border border-green-700/30 hover:bg-green-900/60 transition">
                  <i data-lucide="check" class="w-3 h-3 inline mr-1"></i> Resolve
                </button>
              </div>
            {% else %}
              {% if dispute.resolved_by %}
                <p class="text-[10px] text-gray-600 flex-shrink-0">Resolved by {{ dispute.resolved_by.username }}</p>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="glass rounded-xl p-12 text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-green-900/10 flex items-center justify-center">
        <i data-lucide="shield-check" class="w-8 h-8 text-green-500"></i>
      </div>
      <h2 class="text-lg font-display font-bold text-white mb-2">No Disputes</h2>
      <p class="text-sm text-gray-400">
        {% if status_filter %}No {{ status_filter|title }} disputes found.{% else %}No disputes have been filed.{% endif %}
      </p>
    </div>
  {% endif %}

</div>

{% endblock %}
