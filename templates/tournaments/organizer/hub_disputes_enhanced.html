{% extends "tournaments/organizer/_hub_base.html" %}
{% load humanize %}

{# ─────────────────────────────────────────────────────────
   Organizer Hub — Disputes Tab (Enhanced)
   Dispute handling with status filters and resolution
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block hub_content %}

{# ── Dispute Stats Strip ── #}
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
  <div class="glass rounded-xl p-4 text-center">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Total</p>
    <p class="text-xl font-display font-bold text-white">{{ total_count|default:"0" }}</p>
  </div>
  <div class="glass rounded-xl p-4 text-center border border-red-600/20">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Open</p>
    <p class="text-xl font-display font-bold text-red-400">{{ open_count|default:"0" }}</p>
  </div>
  <div class="glass rounded-xl p-4 text-center border border-yellow-600/20">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Under Review</p>
    <p class="text-xl font-display font-bold text-yellow-400">{{ under_review_count|default:"0" }}</p>
  </div>
  <div class="glass rounded-xl p-4 text-center border border-green-600/20">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Resolved</p>
    <p class="text-xl font-display font-bold text-green-400">{{ resolved_count|default:"0" }}</p>
  </div>
</div>

{# ── Status Filter Tabs ── #}
<div class="flex items-center gap-2 mb-6">
  <a href="?status="
     class="nav-pill text-xs {% if not request.GET.status %}active{% endif %}">
    All <span class="ml-1 font-mono opacity-60">{{ total_count }}</span>
  </a>
  <a href="?status=open"
     class="nav-pill text-xs {% if request.GET.status == 'open' %}active{% endif %}">
    Open <span class="ml-1 font-mono opacity-60">{{ open_count }}</span>
  </a>
  <a href="?status=under_review"
     class="nav-pill text-xs {% if request.GET.status == 'under_review' %}active{% endif %}">
    Under Review <span class="ml-1 font-mono opacity-60">{{ under_review_count }}</span>
  </a>
  <a href="?status=resolved"
     class="nav-pill text-xs {% if request.GET.status == 'resolved' %}active{% endif %}">
    Resolved <span class="ml-1 font-mono opacity-60">{{ resolved_count }}</span>
  </a>
</div>

{# ── Dispute List ── #}
{% if disputes %}
  <div class="space-y-3">
    {% for dispute in disputes %}
      <div class="glass rounded-xl p-5 hover:border-dc-border/40 transition">
        <div class="flex items-start gap-4">
          {# Status icon #}
          <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0
            {% if dispute.status == 'open' %}bg-red-600/10
            {% elif dispute.status == 'under_review' %}bg-yellow-600/10
            {% elif dispute.status == 'resolved' %}bg-green-600/10
            {% else %}bg-gray-600/10{% endif %}">
            <i data-lucide="{% if dispute.status == 'open' %}alert-circle{% elif dispute.status == 'under_review' %}search{% elif dispute.status == 'resolved' %}check-circle{% else %}help-circle{% endif %}"
               class="w-5 h-5
                {% if dispute.status == 'open' %}text-red-400
                {% elif dispute.status == 'under_review' %}text-yellow-400
                {% elif dispute.status == 'resolved' %}text-green-400
                {% else %}text-gray-400{% endif %}"></i>
          </div>

          {# Content #}
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1">
              <h4 class="text-sm font-semibold text-white truncate">
                {{ dispute.title|default:"Dispute" }}
              </h4>
              <span class="text-[10px] px-2 py-0.5 rounded-full font-mono
                {% if dispute.status == 'open' %}bg-red-600/20 text-red-400
                {% elif dispute.status == 'under_review' %}bg-yellow-600/20 text-yellow-400
                {% elif dispute.status == 'resolved' %}bg-green-600/20 text-green-400
                {% else %}bg-gray-600/20 text-gray-400{% endif %}">
                {{ dispute.status|title }}
              </span>
            </div>

            <p class="text-xs text-gray-500 mb-2 line-clamp-2">
              {{ dispute.description|default:dispute.reason|default:"No description provided"|truncatewords:30 }}
            </p>

            <div class="flex flex-wrap items-center gap-3 text-[10px] text-gray-600">
              <span>
                <i data-lucide="swords" class="w-3 h-3 inline"></i>
                Match: R{{ dispute.match.round_number|default:"?" }}M{{ dispute.match.match_number|default:"?" }}
              </span>
              <span>
                <i data-lucide="user" class="w-3 h-3 inline"></i>
                {{ dispute.filed_by|default:"Unknown" }}
              </span>
              <span>
                <i data-lucide="clock" class="w-3 h-3 inline"></i>
                {{ dispute.created_at|timesince }} ago
              </span>
            </div>
          </div>

          {# Actions #}
          {% if can_resolve %}
            <div class="flex items-center gap-1 flex-shrink-0">
              {% if dispute.status == 'open' %}
                <button title="Start Review" class="p-2 rounded-lg hover:bg-yellow-600/20 text-gray-500 hover:text-yellow-400 transition">
                  <i data-lucide="search" class="w-4 h-4"></i>
                </button>
              {% endif %}
              {% if dispute.status == 'open' or dispute.status == 'under_review' %}
                <button title="Resolve" class="p-2 rounded-lg hover:bg-green-600/20 text-gray-500 hover:text-green-400 transition">
                  <i data-lucide="check-circle" class="w-4 h-4"></i>
                </button>
              {% endif %}
              <button title="View Details" class="p-2 rounded-lg hover:bg-white/10 text-gray-500 hover:text-white transition">
                <i data-lucide="external-link" class="w-4 h-4"></i>
              </button>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="text-center py-16 glass rounded-xl">
    <i data-lucide="shield-check" class="w-10 h-10 text-gray-700 mx-auto mb-3"></i>
    <p class="text-gray-400 mb-1">No disputes found</p>
    <p class="text-xs text-gray-600">All clear! Disputes will appear here when players report them.</p>
  </div>
{% endif %}

{% endblock %}
