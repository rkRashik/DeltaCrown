{% extends "tournaments/organizer/_hub_base.html" %}
{% load humanize %}

{# ─────────────────────────────────────────────────────────
   Organizer Hub — Payments Tab
   Payment tracking, verification, stats
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block hub_content %}

{# ── Payment Stats Strip ── #}
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="glass rounded-xl p-4 text-center">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Submitted</p>
    <p class="text-xl font-display font-bold text-white">{{ payment_stats.total_submitted|default:"0" }}</p>
  </div>
  <div class="glass rounded-xl p-4 text-center">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Pending Verification</p>
    <p class="text-xl font-display font-bold text-yellow-400">{{ payment_stats.pending_verification|default:"0" }}</p>
  </div>
  <div class="glass rounded-xl p-4 text-center">
    <p class="text-[10px] uppercase tracking-wider text-gray-500 mb-1">Verified Total</p>
    <p class="text-xl font-display font-bold text-green-400">৳{{ payment_stats.total_amount|default:"0"|intcomma }}</p>
  </div>
</div>

{# ── Filters ── #}
<form method="get" class="flex flex-wrap items-center gap-3 mb-6">
  <select name="status"
          class="bg-dc-surface border border-dc-border rounded-xl text-sm text-white px-3 py-2.5 focus:border-dc-cyan/40 focus:outline-none">
    <option value="">All Statuses</option>
    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
    <option value="submitted" {% if request.GET.status == 'submitted' %}selected{% endif %}>Submitted</option>
    <option value="verified" {% if request.GET.status == 'verified' %}selected{% endif %}>Verified</option>
    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
  </select>

  <select name="method"
          class="bg-dc-surface border border-dc-border rounded-xl text-sm text-white px-3 py-2.5 focus:border-dc-cyan/40 focus:outline-none">
    <option value="">All Methods</option>
    <option value="bkash" {% if request.GET.method == 'bkash' %}selected{% endif %}>bKash</option>
    <option value="nagad" {% if request.GET.method == 'nagad' %}selected{% endif %}>Nagad</option>
    <option value="bank" {% if request.GET.method == 'bank' %}selected{% endif %}>Bank Transfer</option>
  </select>

  <button type="submit" class="px-4 py-2.5 bg-dc-cyan/10 text-dc-cyan text-sm rounded-xl hover:bg-dc-cyan/20 transition">
    Filter
  </button>
</form>

{# ── Payment List ── #}
{% if payments %}
  <div class="glass rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-dc-border text-[11px] uppercase tracking-wider text-gray-500">
            <th class="px-4 py-3 text-left">Player</th>
            <th class="px-4 py-3 text-left">Amount</th>
            <th class="px-4 py-3 text-left">Method</th>
            <th class="px-4 py-3 text-left">Transaction ID</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">Submitted</th>
            {% if can_approve %}<th class="px-4 py-3 text-right">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody class="divide-y divide-dc-border">
          {% for payment in payments %}
            <tr class="hover:bg-white/[0.02] transition">
              <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-full bg-dc-surface flex items-center justify-center text-[10px] font-bold text-dc-cyan flex-shrink-0">
                    {{ payment.registration.user.username|first|upper }}
                  </div>
                  <span class="text-white">{{ payment.registration.user.username }}</span>
                </div>
              </td>
              <td class="px-4 py-3 text-white font-mono">৳{{ payment.amount|default:"0"|intcomma }}</td>
              <td class="px-4 py-3 text-gray-400 capitalize">{{ payment.payment_method|default:"—" }}</td>
              <td class="px-4 py-3">
                <span class="text-[11px] font-mono text-gray-500 bg-dc-surface px-2 py-0.5 rounded">
                  {{ payment.transaction_id|default:"—"|truncatechars:16 }}
                </span>
              </td>
              <td class="px-4 py-3">
                <span class="text-[10px] px-2 py-0.5 rounded-full font-mono
                  {% if payment.status == 'verified' %}bg-green-600/20 text-green-400
                  {% elif payment.status == 'submitted' %}bg-blue-600/20 text-blue-400
                  {% elif payment.status == 'pending' %}bg-yellow-600/20 text-yellow-400
                  {% elif payment.status == 'rejected' %}bg-red-600/20 text-red-400
                  {% else %}bg-gray-600/20 text-gray-400{% endif %}">
                  {{ payment.status|title }}
                </span>
              </td>
              <td class="px-4 py-3 text-gray-500 text-xs">{{ payment.submitted_at|timesince }} ago</td>
              {% if can_approve %}
                <td class="px-4 py-3 text-right">
                  {% if payment.status == 'submitted' %}
                    <div class="flex items-center justify-end gap-1">
                      <button title="Verify" class="p-1.5 rounded-lg hover:bg-green-600/20 text-gray-500 hover:text-green-400 transition">
                        <i data-lucide="check" class="w-3.5 h-3.5"></i>
                      </button>
                      <button title="Reject" class="p-1.5 rounded-lg hover:bg-red-600/20 text-gray-500 hover:text-red-400 transition">
                        <i data-lucide="x" class="w-3.5 h-3.5"></i>
                      </button>
                    </div>
                  {% elif payment.status == 'verified' %}
                    <span class="text-[10px] text-green-500"><i data-lucide="check-circle" class="w-3.5 h-3.5 inline"></i></span>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="text-center py-16 glass rounded-xl">
    <i data-lucide="credit-card" class="w-10 h-10 text-gray-700 mx-auto mb-3"></i>
    <p class="text-gray-400 mb-1">No payments found</p>
    <p class="text-xs text-gray-600">Payment records will appear here when players submit them.</p>
  </div>
{% endif %}

{% endblock %}
