{% extends "tournaments/organizer/hub_overview.html" %}

{% block hub_content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Payment Management</h2>
        
        <div class="flex gap-2">
            <!-- FE-T-023: Export Payments -->
            <a href="{% url 'tournaments:export_payments_csv' slug=tournament.slug %}" 
               class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                <i class="fas fa-download"></i> Export CSV
            </a>
            
            {% if can_approve %}
            <!-- FE-T-023: Bulk Verify -->
            <button onclick="bulkVerifyPayments()" 
                    id="bulk-verify-btn"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 hidden">
                <i class="fas fa-check"></i> Verify Selected
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="flex gap-4 mb-6">
        <div class="bg-green-50 px-6 py-4 rounded">
            <div class="text-2xl font-bold text-green-600">৳{{ payment_stats.total_amount|floatformat:0 }}</div>
            <div class="text-sm text-gray-600">Total Collected</div>
        </div>
        <div class="bg-yellow-50 px-6 py-4 rounded">
            <div class="text-2xl font-bold text-yellow-600">{{ payment_stats.pending_verification }}</div>
            <div class="text-sm text-gray-600">Pending Verification</div>
        </div>
        <div class="bg-blue-50 px-6 py-4 rounded">
            <div class="text-2xl font-bold text-blue-600">{{ payment_stats.total_submitted }}</div>
            <div class="text-sm text-gray-600">Total Submitted</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex gap-4 mb-6">
        <select onchange="window.location.search='?status='+this.value" class="px-4 py-2 border rounded">
            <option value="">All Statuses</option>
            <option value="submitted" {% if request.GET.status == 'submitted' %}selected{% endif %}>Submitted</option>
            <option value="verified" {% if request.GET.status == 'verified' %}selected{% endif %}>Verified</option>
            <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
            <option value="refunded" {% if request.GET.status == 'refunded' %}selected{% endif %}>Refunded</option>
        </select>
    </div>

    <!-- Payments Table -->
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="bg-gray-50 border-b">
                    {% if can_approve %}
                    <th class="px-4 py-3">
                        <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    </th>
                    {% endif %}
                    <th class="px-4 py-3 text-left">Participant</th>
                    <th class="px-4 py-3 text-left">Method</th>
                    <th class="px-4 py-3 text-left">Amount</th>
                    <th class="px-4 py-3 text-left">Transaction ID</th>
                    <th class="px-4 py-3 text-left">Status</th>
                    <th class="px-4 py-3 text-left">Submitted</th>
                    {% if can_approve %}
                    <th class="px-4 py-3 text-left">Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr class="border-b hover:bg-gray-50">
                    {% if can_approve %}
                    <td class="px-4 py-3">
                        {% if payment.status == 'submitted' %}
                        <input type="checkbox" class="payment-checkbox" value="{{ payment.id }}">
                        {% endif %}
                    </td>
                    {% endif %}
                    <td class="px-4 py-3">
                        <strong>{{ payment.registration.user.username }}</strong>
                    </td>
                    <td class="px-4 py-3">
                        {{ payment.payment_method|upper }}
                    </td>
                    <td class="px-4 py-3">
                        <strong>৳{{ payment.amount|floatformat:0 }}</strong>
                    </td>
                    <td class="px-4 py-3 font-mono text-sm">
                        {{ payment.transaction_id }}
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-3 py-1 rounded-full text-sm {% if payment.status == 'verified' %}bg-green-100 text-green-800{% elif payment.status == 'submitted' %}bg-yellow-100 text-yellow-800{% elif payment.status == 'rejected' %}bg-red-100 text-red-800{% elif payment.status == 'refunded' %}bg-purple-100 text-purple-800{% endif %}">
                            {{ payment.get_status_display }}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        {{ payment.submitted_at|date:"M d, Y H:i" }}
                    </td>
                    {% if can_approve %}
                    <td class="px-4 py-3">
                        <div class="flex gap-2">
                            {% if payment.status == 'submitted' %}
                            <button onclick="verifyPayment({{ payment.id }})" 
                                    class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">
                                Verify
                            </button>
                            <button onclick="rejectPayment({{ payment.id }})" 
                                    class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">
                                Reject
                            </button>
                            {% endif %}
                            
                            {% if payment.status == 'verified' %}
                            <!-- FE-T-023: Refund Action -->
                            <button onclick="processRefund({{ payment.id }}, {{ payment.amount }})" 
                                    class="px-3 py-1 bg-purple-500 text-white rounded hover:bg-purple-600"
                                    title="Process refund">
                                <i class="fas fa-undo"></i> Refund
                            </button>
                            {% endif %}
                            
                            <!-- FE-T-023: Payment History -->
                            <button onclick="viewPaymentHistory({{ payment.registration.id }})" 
                                    class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600"
                                    title="View payment history">
                                <i class="fas fa-history"></i>
                            </button>
                            
                            {% if payment.proof_image %}
                            <a href="{{ payment.proof_image.url }}" target="_blank" 
                               class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                                View Proof
                            </a>
                            {% endif %}
                        </div>
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if can_approve %}8{% else %}7{% endif %}" class="px-4 py-8 text-center text-gray-500">
                        No payments found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// FE-T-023: Checkbox management for bulk actions
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.payment-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateBulkVerifyButton();
}

document.addEventListener('DOMContentLoaded', function() {
    // Add listeners to all checkboxes
    document.querySelectorAll('.payment-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkVerifyButton);
    });
});

function updateBulkVerifyButton() {
    const checked = document.querySelectorAll('.payment-checkbox:checked').length;
    const verifyBtn = document.getElementById('bulk-verify-btn');
    
    if (checked > 0) {
        verifyBtn.classList.remove('hidden');
    } else {
        verifyBtn.classList.add('hidden');
    }
}

function getSelectedPaymentIds() {
    const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

// FE-T-023: Bulk verify payments
function bulkVerifyPayments() {
    const ids = getSelectedPaymentIds();
    if (ids.length === 0) {
        alert('Please select payments to verify');
        return;
    }
    
    if (!confirm(`Verify ${ids.length} payment(s)?`)) return;
    
    fetch(`/tournaments/organizer/{{ tournament.slug }}/bulk-verify-payments/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ payment_ids: ids })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// FE-T-023: Process refund
function processRefund(paymentId, amount) {
    const refundAmount = prompt(`Refund amount (max ৳${amount}):`, amount);
    if (!refundAmount) return;
    
    const reason = prompt('Refund reason (required):');
    if (!reason || reason.trim() === '') {
        alert('Refund reason is required');
        return;
    }
    
    const method = prompt('Refund method (manual/bkash/nagad):', 'manual');
    if (!method) return;
    
    if (!confirm(`Process refund of ৳${refundAmount}?`)) return;
    
    fetch(`/tournaments/organizer/{{ tournament.slug }}/refund-payment/${paymentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            amount: refundAmount, 
            reason: reason,
            refund_method: method 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// FE-T-023: View payment history
function viewPaymentHistory(registrationId) {
    fetch(`/tournaments/organizer/{{ tournament.slug }}/registrations/${registrationId}/payment-history/`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const payments = data.payments;
            let html = `<h3>Payment History for ${data.participant}</h3><table border="1" style="width:100%; margin-top: 10px;"><tr><th>ID</th><th>Amount</th><th>Method</th><th>Status</th><th>Submitted</th></tr>`;
            
            payments.forEach(p => {
                html += `<tr><td>${p.id}</td><td>৳${p.amount}</td><td>${p.method}</td><td>${p.status}</td><td>${p.submitted_at || 'N/A'}</td></tr>`;
            });
            
            html += '</table>';
            
            // Show in modal or alert
            const win = window.open('', 'Payment History', 'width=800,height=600');
            win.document.write(`<html><head><title>Payment History</title></head><body>${html}</body></html>`);
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function verifyPayment(id) {
    if (!confirm('Verify this payment?')) return;
    
    fetch(`/tournaments/organizer/{{ tournament.slug }}/verify-payment/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function rejectPayment(id) {
    if (!confirm('Reject this payment?')) return;
    
    fetch(`/tournaments/organizer/{{ tournament.slug }}/reject-payment/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}
</script>
{% endblock %}
