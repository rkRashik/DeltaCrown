{% extends "tournaments/organizer/_hub_base.html" %}
{% load humanize %}

{# ─────────────────────────────────────────────────────────
   Organizer Hub — Brackets Tab
   Bracket visualization, match list, result management
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block hub_content %}

{# ── Bracket Status ── #}
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
  <div>
    <h2 class="text-lg font-display font-bold text-white">Bracket &amp; Matches</h2>
    {% if bracket %}
      <p class="text-xs text-gray-500 mt-1">
        {{ bracket.bracket_type|default:"Single Elimination"|title }} — Round {{ bracket.current_round|default:"1" }}
      </p>
    {% endif %}
  </div>

  <div class="flex items-center gap-2">
    {% if pending_results_count %}
      <span class="text-xs px-3 py-2 bg-yellow-600/20 text-yellow-400 rounded-xl font-mono">
        <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i> {{ pending_results_count }} pending result{{ pending_results_count|pluralize }}
      </span>
    {% endif %}
    {% if can_manage %}
      <button class="text-xs px-3 py-2 bg-dc-cyan/10 text-dc-cyan rounded-xl hover:bg-dc-cyan/20 transition">
        <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i> Generate Bracket
      </button>
    {% endif %}
  </div>
</div>

{# ── Bracket Visualization Placeholder ── #}
{% if bracket %}
  <div class="glass rounded-xl p-6 mb-6">
    <div class="flex items-center gap-2 mb-4">
      <i data-lucide="git-merge" class="w-5 h-5 text-dc-purple"></i>
      <h3 class="text-sm font-display font-semibold text-white">Bracket View</h3>
    </div>
    <div class="min-h-[200px] flex items-center justify-center border border-dashed border-dc-border rounded-lg">
      <div class="text-center text-gray-600">
        <i data-lucide="git-branch" class="w-8 h-8 mx-auto mb-2"></i>
        <p class="text-sm">Interactive bracket visualization</p>
        <p class="text-[10px] text-gray-700 mt-1">Coming in Phase 4.7</p>
      </div>
    </div>
  </div>
{% else %}
  <div class="glass rounded-xl p-6 mb-6 text-center">
    <i data-lucide="git-merge" class="w-10 h-10 text-gray-700 mx-auto mb-3"></i>
    <p class="text-gray-400 mb-1">No bracket generated yet</p>
    <p class="text-xs text-gray-600 mb-4">Generate a bracket to start creating matches.</p>
    {% if can_manage %}
      <button class="px-4 py-2.5 bg-dc-cyan text-black font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition">
        <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Generate Bracket
      </button>
    {% endif %}
  </div>
{% endif %}

{# ── Match List ── #}
<div class="glass rounded-xl overflow-hidden">
  <div class="px-6 py-4 border-b border-dc-border flex items-center justify-between">
    <h3 class="text-sm font-display font-semibold text-white">Matches</h3>
    <span class="text-[10px] text-gray-500 font-mono">{{ matches|length }} total</span>
  </div>

  {% if matches %}
    <div class="divide-y divide-dc-border">
      {% for match in matches %}
        <div class="px-6 py-4 hover:bg-white/[0.02] transition">
          <div class="flex items-center gap-4">
            {# Round/Match Number #}
            <div class="text-center flex-shrink-0 w-14">
              <p class="text-[10px] text-gray-600">R{{ match.round_number }}</p>
              <p class="text-xs font-mono text-gray-400">M{{ match.match_number }}</p>
            </div>

            {# Participants #}
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-sm text-white truncate {% if match.winner == match.participant1 %}font-bold{% endif %}">
                  {{ match.participant1|default:"TBD" }}
                </span>
                <span class="text-[10px] text-gray-600">vs</span>
                <span class="text-sm text-white truncate {% if match.winner == match.participant2 %}font-bold{% endif %}">
                  {{ match.participant2|default:"TBD" }}
                </span>
              </div>
              {% if match.scheduled_time %}
                <p class="text-[10px] text-gray-600 mt-0.5">
                  <i data-lucide="clock" class="w-3 h-3 inline"></i>
                  {{ match.scheduled_time|date:"M d, Y H:i" }}
                </p>
              {% endif %}
            </div>

            {# Score #}
            {% if match.score_participant1 is not None and match.score_participant2 is not None %}
              <div class="text-center font-mono text-sm flex-shrink-0">
                <span class="{% if match.score_participant1 > match.score_participant2 %}text-green-400{% else %}text-gray-400{% endif %}">{{ match.score_participant1 }}</span>
                <span class="text-gray-600 mx-1">-</span>
                <span class="{% if match.score_participant2 > match.score_participant1 %}text-green-400{% else %}text-gray-400{% endif %}">{{ match.score_participant2 }}</span>
              </div>
            {% endif %}

            {# State badge #}
            <span class="text-[10px] px-2 py-0.5 rounded-full font-mono flex-shrink-0
              {% if match.state == 'completed' %}bg-green-600/20 text-green-400
              {% elif match.state == 'live' %}bg-red-600/20 text-red-400 animate-pulse
              {% elif match.state == 'scheduled' %}bg-blue-600/20 text-blue-400
              {% elif match.state == 'pending_result' %}bg-yellow-600/20 text-yellow-400
              {% else %}bg-gray-600/20 text-gray-400{% endif %}">
              {{ match.state|default:"Unknown"|title }}
            </span>

            {# Actions #}
            {% if can_manage %}
              <div class="flex items-center gap-1 flex-shrink-0">
                {% if match.state == 'pending_result' or match.state == 'PENDING_RESULT' %}
                  <button title="Submit Score" class="p-1.5 rounded-lg hover:bg-dc-cyan/20 text-gray-500 hover:text-dc-cyan transition">
                    <i data-lucide="edit-3" class="w-3.5 h-3.5"></i>
                  </button>
                {% endif %}
                <button title="Details" class="p-1.5 rounded-lg hover:bg-white/10 text-gray-500 hover:text-white transition">
                  <i data-lucide="more-horizontal" class="w-3.5 h-3.5"></i>
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-12 text-gray-600">
      <i data-lucide="swords" class="w-8 h-8 mx-auto mb-2"></i>
      <p class="text-sm">No matches yet</p>
    </div>
  {% endif %}
</div>

{% endblock %}
