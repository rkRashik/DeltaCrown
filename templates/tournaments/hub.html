{% extends "base.html" %}
{% load static tournament_dict_utils humanize game_assets_tags %}

{% block title %}Tournaments - Bangladesh's Premier Esports Platform | DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tournaments-hub-v2.css' %}">
<link rel="stylesheet" href="{% static 'siteui/css/tournaments-hub-v2-polish.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block body_class %}tournament-hub hide-footer{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="dc-hub-hero">
    <div class="hub-container">
        <div class="dc-hero-content">
            {% if live_tournaments %}
            <div class="dc-hero-badge">
                <span class="dc-pulse-dot"></span>
                <span>{{ live_tournaments|length }} TOURNAMENT{{ live_tournaments|length|pluralize }} LIVE NOW</span>
            </div>
            {% endif %}
            
            <h1 class="dc-hero-title">Bangladesh's Premier Esports Platform</h1>
            <p class="dc-hero-subtitle">Compete, Win, and Claim Your Crown in the Ultimate Gaming Arena</p>
            
            <div class="dc-hero-stats">
                <div class="dc-stat-card">
                    <div class="dc-stat-value">{{ stats.total_active|default:0 }}</div>
                    <div class="dc-stat-label">Active Tournaments</div>
                </div>
                <div class="dc-stat-card">
                    <div class="dc-stat-value">{{ stats.players_this_month|default:0|intcomma }}+</div>
                    <div class="dc-stat-label">Players</div>
                </div>
                <div class="dc-stat-card">
                    <div class="dc-stat-value">৳{{ stats.prize_pool_month|default:0|intcomma }}</div>
                    <div class="dc-stat-label">Prize Pool</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Search Section -->
<section class="dc-search-section">
    <div class="hub-container">
        <form method="get" action="{% url 'tournaments:hub' %}">
            <div class="dc-search-box">
                <i class="fas fa-search dc-search-icon"></i>
                <input 
                    type="text" 
                    name="q" 
                    class="dc-search-input"
                    placeholder="Search tournaments, games, or prizes..."
                    value="{{ filters.q }}"
                >
                <button type="submit" class="dc-search-btn">
                    <span>Search</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>
</section>

<!-- Browse by Game -->
<section class="dc-games-section">
    <div class="hub-container">
        <h2 class="dc-section-title">Browse by Game</h2>
        
        <div class="dc-games-grid">
            <!-- All Games -->
            <a href="{% url 'tournaments:hub' %}" class="dc-game-card {% if not filters.game %}active{% endif %}">
                <div class="dc-game-overlay"></div>
                <div class="dc-game-content">
                    <i class="fas fa-th dc-game-icon" style="font-size: 48px; color: var(--dc-primary);"></i>
                    <div class="dc-game-name">All Games</div>
                    <div class="dc-game-count">{{ pagination.total_count }} Tournaments</div>
                </div>
            </a>
            
            <!-- Dynamic Games -->
            {% for game in games %}
            <a href="?game={{ game.slug }}" class="dc-game-card {% if filters.game == game.slug %}active{% endif %}">
                <div class="dc-game-bg">
                    <img src="{% static game.card %}" alt="{{ game.name }}">
                </div>
                <div class="dc-game-overlay"></div>
                <div class="dc-game-content">
                    <img src="{% static game.icon %}" alt="{{ game.name }}" class="dc-game-icon">
                    <div class="dc-game-name">{{ game.display_name|default:game.name }}</div>
                    <div class="dc-game-count">{{ game.count }} Active</div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Tournament Listing -->
<section class="dc-listing-section">
    <div class="hub-container">
        <div class="dc-listing-layout">
            <!-- Filters Panel -->
            <aside class="dc-filters-panel" id="filters-panel">
                <div class="dc-filters-header">
                    <h3 class="dc-filters-title">Filters</h3>
                    <button type="button" class="dc-close-filters" id="close-filters" style="background: none; border: none; color: var(--dc-text-muted); cursor: pointer; font-size: 1.5rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form method="get" action="{% url 'tournaments:hub' %}" id="filters-form">
                    {% if filters.q %}<input type="hidden" name="q" value="{{ filters.q }}">{% endif %}
                    
                    <!-- Status -->
                    <div class="dc-filter-group">
                        <label class="dc-filter-label">Status</label>
                        <label class="dc-filter-option">
                            <input type="radio" name="status" value="" {% if not filters.status %}checked{% endif %}>
                            <span>All</span>
                            <span class="dc-filter-count">{{ pagination.total_count }}</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="status" value="open" {% if filters.status == 'open' %}checked{% endif %}>
                            <span>Open</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="status" value="live" {% if filters.status == 'live' %}checked{% endif %}>
                            <span>Live</span>
                            {% if live_tournaments %}
                            <span class="dc-filter-count">{{ live_tournaments|length }}</span>
                            {% endif %}
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="status" value="upcoming" {% if filters.status == 'upcoming' %}checked{% endif %}>
                            <span>Upcoming</span>
                        </label>
                    </div>
                    
                    <!-- Entry Fee -->
                    <div class="dc-filter-group">
                        <label class="dc-filter-label">Entry Fee</label>
                        <label class="dc-filter-option">
                            <input type="radio" name="fee" value="" {% if not filters.fee %}checked{% endif %}>
                            <span>All</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="fee" value="free" {% if filters.fee == 'free' %}checked{% endif %}>
                            <span>Free</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="fee" value="paid" {% if filters.fee == 'paid' %}checked{% endif %}>
                            <span>Paid</span>
                        </label>
                    </div>
                    
                    <!-- Prize Pool -->
                    <div class="dc-filter-group">
                        <label class="dc-filter-label">Prize Pool</label>
                        <label class="dc-filter-option">
                            <input type="radio" name="prize" value="" {% if not filters.prize %}checked{% endif %}>
                            <span>All</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="prize" value="high" {% if filters.prize == 'high' %}checked{% endif %}>
                            <span>৳50K+</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="prize" value="medium" {% if filters.prize == 'medium' %}checked{% endif %}>
                            <span>৳10K-50K</span>
                        </label>
                        <label class="dc-filter-option">
                            <input type="radio" name="prize" value="low" {% if filters.prize == 'low' %}checked{% endif %}>
                            <span><৳10K</span>
                        </label>
                    </div>
                    
                    <button type="button" class="dc-reset-btn" id="reset-filters">
                        <i class="fas fa-redo"></i>
                        <span>Reset Filters</span>
                    </button>
                </form>
            </aside>
            
            <!-- Main Content -->
            <div class="dc-listing-main">
                <!-- Header -->
                <div class="dc-listing-header">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h2 class="dc-listing-count">
                            <span>{{ pagination.total_count }}</span> Tournament{{ pagination.total_count|pluralize }}
                        </h2>
                        <button type="button" class="dc-mobile-filter-btn" id="open-filters" style="display: none;">
                            <i class="fas fa-filter"></i>
                            <span>Filters</span>
                        </button>
                    </div>
                    
                    <div class="dc-sort-dropdown">
                        <label>Sort by</label>
                        <select id="sort-select">
                            <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                            <option value="starting_soon" {% if filters.sort == 'starting_soon' %}selected{% endif %}>Starting Soon</option>
                            <option value="prize_high" {% if filters.sort == 'prize_high' %}selected{% endif %}>Highest Prize</option>
                            <option value="popular" {% if filters.sort == 'popular' %}selected{% endif %}>Popular</option>
                        </select>
                    </div>
                </div>
                
                <!-- Tournament Cards -->
                <div class="dc-tournaments-grid">
                    {% for tournament in tournaments %}
                    <article class="dc-tournament-card">
                        <div class="dc-card-image">
                            <a href="{% url 'tournaments:detail' slug=tournament.slug %}">
                                {% if tournament.banner_url %}
                                <img src="{{ tournament.banner_url }}" alt="{{ tournament.name }}">
                                {% else %}
                                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: 900; color: rgba(255,255,255,0.3);">
                                    {{ tournament.game|slice:":1"|upper }}
                                </div>
                                {% endif %}
                            </a>
                            <!-- Game Logo Badge -->
                            <div class="dc-game-logo-badge">
                                {% load game_assets_tags %}
                                <img src="{% static tournament.game_logo %}" alt="{{ tournament.dc_game }}" class="dc-game-logo">
                            </div>
                            <!-- Status Badges -->
                            <div class="dc-card-badges">
                                {% if my_reg_states|get_tournament_item:tournament.id %}
                                <span class="dc-badge dc-badge-registered">
                                    <i class="fas fa-check-circle"></i>
                                    REGISTERED
                                </span>
                                {% elif tournament.status == 'RUNNING' %}
                                <span class="dc-badge dc-badge-live">
                                    <span class="dc-pulse-dot"></span>
                                    LIVE
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="dc-card-body">
                            <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-card-title">
                                {{ tournament.name }}
                            </a>
                            
                            <div class="dc-card-meta">
                                <div class="dc-card-meta-item">
                                    <div class="dc-meta-label">
                                        <i class="far fa-calendar"></i>
                                        <span>Starts</span>
                                    </div>
                                    <div class="dc-meta-value">{{ tournament.start_at|date:"M d, Y" }}</div>
                                </div>
                                <div class="dc-card-meta-item">
                                    <div class="dc-meta-label">
                                        <i class="fas fa-trophy"></i>
                                        <span>Prize Pool</span>
                                    </div>
                                    <div class="dc-meta-value dc-meta-prize">
                                        {% if tournament.prize_pool_bdt %}৳{{ tournament.prize_pool_bdt|intcomma }}{% else %}TBA{% endif %}
                                    </div>
                                </div>
                                <div class="dc-card-meta-item">
                                    <div class="dc-meta-label">
                                        <i class="fas fa-users"></i>
                                        <span>Teams</span>
                                    </div>
                                    <div class="dc-meta-value">
                                        {% if tournament.max_teams %}
                                            <span class="dc-slots-remaining">{{ tournament.max_teams|add:tournament.registrations.count|add:-1 }}</span>
                                            <span class="dc-slots-text">left</span>
                                            <span class="dc-slots-total">({{ tournament.registrations.count }}/{{ tournament.max_teams }})</span>
                                        {% else %}
                                            <span class="dc-registration-count">{{ tournament.registrations.count }}</span>
                                            <span class="dc-unlimited-text">registered</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="dc-card-meta-item">
                                    <div class="dc-meta-label">
                                        <i class="fas fa-coins"></i>
                                        <span>Entry Fee</span>
                                    </div>
                                    <div class="dc-meta-value dc-meta-fee">
                                        {% if tournament.entry_fee_bdt %}৳{{ tournament.entry_fee_bdt }}{% else %}<span class="dc-free-badge">FREE</span>{% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            {% if tournament.max_teams %}
                            <div class="dc-card-progress">
                                <div class="dc-progress-header">
                                    <div class="dc-progress-label">
                                        <i class="fas fa-chart-line"></i>
                                        <span>Registration Progress</span>
                                    </div>
                                    <div class="dc-progress-stats">
                                        <span class="dc-current-count">{{ tournament.registrations.count }}</span>
                                        <span class="dc-progress-separator">/</span>
                                        <span class="dc-total-count">{{ tournament.max_teams }}</span>
                                        <span class="dc-progress-percent">({% widthratio tournament.registrations.count tournament.max_teams 100 %}%)</span>
                                    </div>
                                </div>
                                <div class="dc-progress-bar-wrap">
                                    <div class="dc-progress-bar" style="width: {% widthratio tournament.registrations.count tournament.max_teams 100 %}%"></div>
                                </div>
                                {% if tournament.registrations.count >= tournament.max_teams %}
                                <div class="dc-full-notice">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Tournament is full!</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="dc-card-actions">
                                {% if user.is_authenticated %}
                                    {% if my_reg_states|get_tournament_item:tournament.id %}
                                        <!-- Already registered -->
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-registered">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Registered</span>
                                        </a>
                                        {% if my_reg_states|get_tournament_item:tournament.id == 'confirmed' %}
                                        <a href="{% url 'tournaments:dashboard' slug=tournament.slug %}" class="dc-btn dc-btn-outline">
                                            <i class="fas fa-gamepad"></i>
                                            <span>Dashboard</span>
                                        </a>
                                        {% else %}
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-outline">
                                            <i class="fas fa-receipt"></i>
                                            <span>View Receipt</span>
                                        </a>
                                        {% endif %}
                                    {% elif tournament.registration_open %}
                                        <!-- Can register - Registration is open -->
                                        <a href="{% url 'tournaments:modern_register' slug=tournament.slug %}" class="dc-btn dc-btn-primary neon" aria-label="Register Now">
                                            <i class="dc-btn-icon fa-solid fa-plus" aria-hidden="true"></i>
                                            <span>Register Now</span>
                                        </a>
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-outline">
                                            <i class="dc-btn-icon fa-solid fa-circle-info" aria-hidden="true"></i>
                                            <span>View Details</span>
                                        </a>
                                    {% elif tournament.status == 'RUNNING' %}
                                        <!-- Tournament is live -->
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-primary">
                                            <i class="dc-btn-icon fa-solid fa-trophy" aria-hidden="true"></i>
                                            <span>View Tournament</span>
                                        </a>
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}#bracket" class="dc-btn dc-btn-outline">
                                            <i class="fas fa-sitemap"></i>
                                            <span>Bracket</span>
                                        </a>
                                    {% elif tournament.status == 'COMPLETED' %}
                                        <!-- Tournament finished -->
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-outline">
                                            <i class="fas fa-trophy"></i>
                                            <span>View Results</span>
                                        </a>
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}#standings" class="dc-btn dc-btn-secondary">
                                            <i class="fas fa-medal"></i>
                                            <span>Standings</span>
                                        </a>
                                    {% else %}
                                        <!-- Registration closed, tournament upcoming -->
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-primary">
                                            <i class="dc-btn-icon fa-solid fa-circle-info" aria-hidden="true"></i>
                                            <span>View Details</span>
                                        </a>
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}#schedule" class="dc-btn dc-btn-outline">
                                            <i class="fas fa-calendar"></i>
                                            <span>Schedule</span>
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <!-- Not logged in -->
                                    {% if tournament.registration_open %}
                                        <a href="{% url 'account:login' %}?next={% url 'tournaments:modern_register' slug=tournament.slug %}" class="dc-btn dc-btn-primary">
                                            <i class="fas fa-sign-in-alt"></i>
                                            <span>Login to Register</span>
                                        </a>
                                    {% else %}
                                        <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-primary">
                                            <i class="fas fa-info-circle"></i>
                                            <span>View Details</span>
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="dc-btn dc-btn-outline">
                                        <i class="fas fa-eye"></i>
                                        <span>Learn More</span>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% empty %}
                    <div class="dc-empty-state" style="grid-column: 1 / -1;">
                        <div class="dc-empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="dc-empty-title">No Tournaments Found</h3>
                        <p class="dc-empty-text">Try adjusting your filters or search query.</p>
                        <a href="{% url 'tournaments:hub' %}" class="dc-btn dc-btn-primary">Reset All</a>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if pagination.total_pages > 1 %}
                <div class="dc-pagination">
                    {% if pagination.has_previous %}
                    <a href="?page={{ pagination.page|add:'-1' }}{% if filters.game %}&game={{ filters.game }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.fee %}&fee={{ filters.fee }}{% endif %}{% if filters.prize %}&prize={{ filters.prize }}{% endif %}{% if filters.sort %}&sort={{ filters.sort }}{% endif %}{% if filters.q %}&q={{ filters.q }}{% endif %}" class="dc-pagination-btn">
                        <i class="fas fa-chevron-left"></i>
                        <span>Previous</span>
                    </a>
                    {% endif %}
                    
                    <span class="dc-pagination-info">
                        Page <strong>{{ pagination.page }}</strong> of <strong>{{ pagination.total_pages }}</strong>
                    </span>
                    
                    {% if pagination.has_next %}
                    <a href="?page={{ pagination.page|add:'1' }}{% if filters.game %}&game={{ filters.game }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.fee %}&fee={{ filters.fee }}{% endif %}{% if filters.prize %}&prize={{ filters.prize }}{% endif %}{% if filters.sort %}&sort={{ filters.sort }}{% endif %}{% if filters.q %}&q={{ filters.q }}{% endif %}" class="dc-pagination-btn">
                        <span>Next</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Filters Backdrop (Mobile) -->
<div class="dc-filters-backdrop" id="filters-backdrop"></div>

<!-- Scroll to Top -->
<button class="dc-scroll-top" id="scroll-top">
    <i class="fas fa-arrow-up"></i>
</button>

<script>
// Filter Panel Toggle (Mobile)
const openFiltersBtn = document.getElementById('open-filters');
const closeFiltersBtn = document.getElementById('close-filters');
const filtersPanel = document.getElementById('filters-panel');
const filtersBackdrop = document.getElementById('filters-backdrop');

function openFilters() {
    filtersPanel.classList.add('open');
    filtersBackdrop.classList.add('show');
}

function closeFilters() {
    filtersPanel.classList.remove('open');
    filtersBackdrop.classList.remove('show');
}

if (openFiltersBtn) openFiltersBtn.addEventListener('click', openFilters);
if (closeFiltersBtn) closeFiltersBtn.addEventListener('click', closeFilters);
if (filtersBackdrop) filtersBackdrop.addEventListener('click', closeFilters);

// Show mobile filter button on small screens
function checkScreenSize() {
    if (window.innerWidth <= 1024) {
        openFiltersBtn.style.display = 'inline-flex';
    } else {
        openFiltersBtn.style.display = 'none';
        closeFilters();
    }
}
checkScreenSize();
window.addEventListener('resize', checkScreenSize);

// Auto-submit filters on change
const filtersForm = document.getElementById('filters-form');
const radioInputs = filtersForm.querySelectorAll('input[type="radio"]');
radioInputs.forEach(input => {
    input.addEventListener('change', () => {
        filtersForm.submit();
    });
});

// Sort dropdown
const sortSelect = document.getElementById('sort-select');
if (sortSelect) {
    sortSelect.addEventListener('change', function() {
        const url = new URL(window.location);
        url.searchParams.set('sort', this.value);
        window.location = url.toString();
    });
}

// Reset filters
const resetBtn = document.getElementById('reset-filters');
if (resetBtn) {
    resetBtn.addEventListener('click', function() {
        window.location = '{% url "tournaments:hub" %}';
    });
}

// Scroll to top
const scrollTopBtn = document.getElementById('scroll-top');
window.addEventListener('scroll', () => {
    if (window.pageYOffset > 300) {
        scrollTopBtn.classList.add('show');
    } else {
        scrollTopBtn.classList.remove('show');
    }
});

scrollTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
});
</script>

<!-- Polish & Animations -->
<script src="{% static 'js/tournaments-v7-polish.js' %}" defer></script>

{% endblock %}
