{% extends "base.html" %}
{% load static tournament_dict_utils humanize game_assets_tags %}

{% block title %}Tournaments - Bangladesh's Premier Esports Platform | DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tournaments-v5-hub.css' %}?v=6">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="{% static 'js/tournaments-v5-hub.js' %}?v=6" defer></script>
{% endblock %}

{% block body_class %}tournament-hub-v5 hide-footer{% endblock %}

{% block content %}
<!-- ============================================
     HERO SECTION
     ============================================ -->
<section class="hub-hero">
    <div class="hero-bg-effects"></div>
    <div class="container">
        <div class="hero-wrapper">
            {% if live_tournaments %}
            <div class="hero-live-pill">
                <span class="pulse-dot"></span>
                <span class="live-text">{{ live_tournaments|length }} LIVE NOW</span>
            </div>
            {% endif %}
            
            <h1 class="hero-title">
                <span class="title-sub">Bangladesh's Premier</span>
                <span class="title-main">ESPORTS PLATFORM</span>
            </h1>
            
            <div class="hero-stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ stats.total_active|default:0 }}</div>
                    <div class="stat-label">Active Tournaments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ stats.players_this_month|default:0|intcomma }}+</div>
                    <div class="stat-label">Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">৳{{ stats.prize_pool_month|default:0|intcomma }}</div>
                    <div class="stat-label">Prize Pool</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ============================================
     MODERN SEARCH BAR
     ============================================ -->
<section class="search-section">
    <div class="container">
        <div class="search-modern">
            <div class="search-icon-wrap">
                <svg class="search-icon" width="22" height="22" viewBox="0 0 22 22" fill="none">
                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="2.5"/>
                    <path d="M15 15L20 20" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                </svg>
            </div>
            <input 
                type="text" 
                id="search-tournaments" 
                class="search-input-modern"
                placeholder="Search tournaments, games, or prizes..."
                value="{{ filters.q }}"
                autocomplete="off"
            >
            <button id="clear-search" class="search-clear-btn" aria-label="Clear" style="display: none;">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M14 6L6 14M6 6L14 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
            <button class="search-submit-btn">
                <span>Search</span>
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                    <path d="M3 9H15M15 9L11 5M15 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
    </div>
</section>

<!-- ============================================
     BROWSE BY GAME - Using game_assets.py
     ============================================ -->
<section class="games-browse-section">
    <div class="container">
        <h2 class="section-title">Browse by Game</h2>
        
        <div class="games-carousel">
            <!-- All Games -->
            <a href="{% url 'tournaments:hub' %}" 
               class="game-tile {% if not filters.game %}active{% endif %}"
               data-game="all">
                <div class="game-tile-bg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                <div class="game-tile-glow"></div>
                <div class="game-tile-content">
                    <div class="game-tile-icon">
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="currentColor">
                            <path d="M20 5C11.716 5 5 11.716 5 20s6.716 15 15 15 15-6.716 15-15S28.284 5 20 5zm0 26c-6.065 0-11-4.935-11-11S13.935 9 20 9s11 4.935 11 11-4.935 11-11 11z"/>
                            <circle cx="20" cy="20" r="4"/>
                        </svg>
                    </div>
                    <h3 class="game-tile-name">All Games</h3>
                    <p class="game-tile-count">{{ pagination.total_count }} Tournaments</p>
                </div>
            </a>
            
            <!-- Dynamic Games from games context -->
            {% for game in games %}
            <a href="?game={{ game.slug }}" 
               class="game-tile {% if filters.game == game.slug %}active{% endif %}"
               data-game="{{ game.slug }}"
               style="--game-color: {{ game.color_primary|default:'#00ff88' }}">
                <div class="game-tile-bg">
                    <img src="{% static game.card %}" alt="{{ game.name }}" loading="lazy">
                </div>
                <div class="game-tile-glow"></div>
                <div class="game-tile-content">
                    <div class="game-tile-icon">
                        <img src="{% static game.icon %}" alt="{{ game.name }}" loading="lazy">
                    </div>
                    <h3 class="game-tile-name">{{ game.display_name|default:game.name }}</h3>
                    <p class="game-tile-count">{{ game.count }} Active</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>

<!-- ============================================
     FEATURED TOURNAMENT - Compact & Promotional
     ============================================ -->
{% if featured.0 %}
<section class="featured-compact-section">
    <div class="container">
        <div class="featured-compact-header">
            <div class="featured-star-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                </svg>
            </div>
            <h2 class="featured-compact-title">Featured Tournament</h2>
        </div>
        
        {% with tournament=featured.0 %}
        <div class="featured-compact-card">
            <div class="featured-compact-visual">
                {% if tournament.banner_image %}
                <img src="{{ tournament.banner_image.url }}" alt="{{ tournament.name }}" loading="eager">
                {% else %}
                <div class="featured-compact-placeholder"></div>
                {% endif %}
                <div class="featured-compact-badges">
                    <span class="badge-compact-game">{{ tournament.game|upper }}</span>
                    {% if tournament.status == 'RUNNING' %}
                    <span class="badge-compact-live">
                        <span class="pulse-mini"></span>
                        LIVE
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="featured-compact-body">
                <h3 class="featured-compact-name">{{ tournament.name }}</h3>
                
                <div class="featured-compact-meta">
                    <div class="compact-meta-item">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <rect x="2" y="3" width="12" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M6 1V5M10 1V5M2 7H14" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>{{ tournament.start_at|date:"M d" }}</span>
                    </div>
                    
                    {% if tournament.prize_pool_bdt %}
                    <div class="compact-meta-item prize">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 1L9.5 5L14 5.5L10.5 8.5L11.5 13L8 10.5L4.5 13L5.5 8.5L2 5.5L6.5 5L8 1Z" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>৳{{ tournament.prize_pool_bdt|intcomma }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="compact-meta-item">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M11 7C11 8.65685 9.65685 10 8 10C6.34315 10 5 8.65685 5 7C5 5.34315 6.34315 4 8 4C9.65685 4 11 5.34315 11 7Z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M3 14C3 11.7909 4.79086 10 7 10H9C11.2091 10 13 11.7909 13 14" stroke="currentColor" stroke-width="1.5"/>
                        </svg>
                        <span>
                            {% if tournament.max_teams %}{{ tournament.registrations.count }}/{{ tournament.max_teams }}{% else %}{{ tournament.registrations.count }}{% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="featured-compact-actions">
                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="btn-compact-view">
                        View Details
                    </a>
                    {% if tournament.is_registration_open %}
                    <a href="{% url 'tournaments:modern_register' slug=tournament.slug %}" class="btn-compact-register">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Register</span>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endwith %}
    </div>
</section>
{% endif %}

<!-- ============================================
     TOURNAMENTS LISTING
     ============================================ -->
<section class="tournaments-listing-section">
    <div class="container">
        <div class="listing-layout">
            <!-- Sidebar Filters -->
            <aside class="filters-panel" id="filters-panel">
                <div class="filters-panel-header">
                    <h3>Filters</h3>
                    <button id="close-filters" class="close-filters-btn">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Status -->
                <div class="filter-block">
                    <h4 class="filter-block-title">Status</h4>
                    <div class="filter-block-options">
                        <label class="filter-radio-option">
                            <input type="radio" name="status" value="all" {% if not filters.status %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">All</span>
                            <span class="radio-badge">{{ pagination.total_count }}</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="status" value="open" {% if filters.status == 'open' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Open</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="status" value="live" {% if filters.status == 'live' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Live</span>
                            {% if live_tournaments %}
                            <span class="radio-badge">{{ live_tournaments|length }}</span>
                            {% endif %}
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="status" value="upcoming" {% if filters.status == 'upcoming' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Upcoming</span>
                        </label>
                    </div>
                </div>
                
                <!-- Entry Fee -->
                <div class="filter-block">
                    <h4 class="filter-block-title">Entry Fee</h4>
                    <div class="filter-block-options">
                        <label class="filter-radio-option">
                            <input type="radio" name="fee" value="all" {% if not filters.fee %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">All</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="fee" value="free" {% if filters.fee == 'free' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Free</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="fee" value="paid" {% if filters.fee == 'paid' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">Paid</span>
                        </label>
                    </div>
                </div>
                
                <!-- Prize Pool -->
                <div class="filter-block">
                    <h4 class="filter-block-title">Prize Pool</h4>
                    <div class="filter-block-options">
                        <label class="filter-radio-option">
                            <input type="radio" name="prize" value="all" {% if not filters.prize %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">All</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="prize" value="high" {% if filters.prize == 'high' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">৳50K+</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="prize" value="medium" {% if filters.prize == 'medium' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label">৳10K-50K</span>
                        </label>
                        <label class="filter-radio-option">
                            <input type="radio" name="prize" value="low" {% if filters.prize == 'low' %}checked{% endif %}>
                            <span class="radio-custom"></span>
                            <span class="radio-label"><৳10K</span>
                        </label>
                    </div>
                </div>
                
                <button class="filters-reset-btn" id="reset-filters">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M14 6.5C13.5 3.5 11 1.5 8 1.5C4.5 1.5 1.5 4.5 1.5 8C1.5 11.5 4.5 14.5 8 14.5C10.5 14.5 12.5 13 13.5 11" stroke="currentColor" stroke-width="2"/>
                        <path d="M11 6.5H14V3.5" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span>Reset Filters</span>
                </button>
            </aside>
            
            <!-- Main Content -->
            <div class="listing-main">
                <!-- Header -->
                <div class="listing-header">
                    <div class="listing-header-left">
                        <h2 class="listing-count">
                            <span class="count-num">{{ pagination.total_count }}</span>
                            <span class="count-text">Tournament{{ pagination.total_count|pluralize }}</span>
                        </h2>
                        <button class="mobile-filter-toggle" id="open-filters">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M4 6H16M6 10H14M8 14H12" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <span>Filters</span>
                        </button>
                    </div>
                    
                    <div class="listing-sort">
                        <label for="sort-dropdown">Sort</label>
                        <select id="sort-dropdown" class="sort-select-modern">
                            <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                            <option value="starting_soon" {% if filters.sort == 'starting_soon' %}selected{% endif %}>Starting Soon</option>
                            <option value="prize_high" {% if filters.sort == 'prize_high' %}selected{% endif %}>Highest Prize</option>
                            <option value="popular" {% if filters.sort == 'popular' %}selected{% endif %}>Popular</option>
                        </select>
                    </div>
                </div>
                
                <!-- Tournament Cards Grid -->
                <div class="tournament-cards-grid" id="tournaments-grid">
                    {% for tournament in tournaments %}
                    <article class="tournament-card-modern">
                        <!-- Thumbnail -->
                        <div class="card-modern-thumb">
                            <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="thumb-link">
                                {% if tournament.banner_image %}
                                <img src="{{ tournament.banner_image.url }}" alt="{{ tournament.name }}" loading="lazy">
                                {% else %}
                                <div class="thumb-placeholder">
                                    <span>{{ tournament.game|slice:":1"|upper }}</span>
                                </div>
                                {% endif %}
                            </a>
                            
                            <!-- Status Badges -->
                            <div class="card-modern-status">
                                <span class="status-badge-game">{{ tournament.game|upper }}</span>
                                {% if tournament.status == 'RUNNING' %}
                                <span class="status-badge-live">
                                    <span class="pulse-mini"></span>
                                    LIVE
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Quick Action Overlay -->
                            <div class="card-quick-overlay">
                                {% if tournament.is_registration_open %}
                                <a href="{% url 'tournaments:modern_register' slug=tournament.slug %}" class="quick-action-btn">
                                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                                        <path d="M9 4V14M4 9H14" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                                    </svg>
                                    <span>Quick Register</span>
                                </a>
                                {% else %}
                                <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="quick-action-btn secondary">
                                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                                        <path d="M9 4C5.5 4 3 7 2 9C3 11 5.5 14 9 14C12.5 14 15 11 16 9C15 7 12.5 4 9 4Z" stroke="currentColor" stroke-width="2"/>
                                        <circle cx="9" cy="9" r="2" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                    <span>View Details</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Card Body -->
                        <div class="card-modern-body">
                            <h3 class="card-modern-title">
                                <a href="{% url 'tournaments:detail' slug=tournament.slug %}">{{ tournament.name }}</a>
                            </h3>
                            
                            <div class="card-modern-meta-grid">
                                <div class="meta-grid-item">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                        <rect x="1.5" y="2.5" width="11" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M5 0.5V4.5M9 0.5V4.5M1.5 6.5H12.5" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    <span>{{ tournament.start_at|date:"M d, Y" }}</span>
                                </div>
                                
                                <div class="meta-grid-item prize">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                        <path d="M7 0.5L8.5 4.5L13 5L9.5 8L10.5 12.5L7 10L3.5 12.5L4.5 8L1 5L5.5 4.5L7 0.5Z" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    <span>
                                        {% if tournament.prize_pool_bdt %}৳{{ tournament.prize_pool_bdt|intcomma }}{% else %}TBA{% endif %}
                                    </span>
                                </div>
                                
                                <div class="meta-grid-item">
                                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                                        <path d="M10 6C10 7.65685 8.65685 9 7 9C5.34315 9 4 7.65685 4 6C4 4.34315 5.34315 3 7 3C8.65685 3 10 4.34315 10 6Z" stroke="currentColor" stroke-width="1.5"/>
                                        <path d="M2 13C2 10.7909 3.79086 9 6 9H8C10.2091 9 12 10.7909 12 13" stroke="currentColor" stroke-width="1.5"/>
                                    </svg>
                                    <span>
                                        {% if tournament.max_teams %}{{ tournament.registrations.count }}/{{ tournament.max_teams }}{% else %}{{ tournament.registrations.count }}{% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Registration Progress -->
                            {% if tournament.max_teams %}
                            <div class="card-modern-progress">
                                <div class="progress-modern-header">
                                    <span class="progress-modern-label">Registration</span>
                                    <span class="progress-modern-value">
                                        {% widthratio tournament.registrations.count tournament.max_teams 100 as progress %}
                                        {{ progress }}%
                                    </span>
                                </div>
                                <div class="progress-modern-track">
                                    <div class="progress-modern-bar" style="width: {{ progress }}%"></div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Dynamic Action Buttons -->
                            <div class="card-modern-actions">
                                {% if tournament.is_registration_open %}
                                    <a href="{% url 'tournaments:modern_register' slug=tournament.slug %}" class="btn-card-action primary">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <path d="M8 3V13M3 8H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                        <span>Register Now</span>
                                    </a>
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="btn-card-action outline">
                                        Details
                                    </a>
                                {% elif tournament.status == 'RUNNING' %}
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="btn-card-action live">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                            <circle cx="8" cy="8" r="3" fill="currentColor"/>
                                        </svg>
                                        <span>Watch Live</span>
                                    </a>
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}#standings" class="btn-card-action outline">
                                        Standings
                                    </a>
                                {% elif tournament.status == 'COMPLETED' %}
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}#results" class="btn-card-action outline">
                                        View Results
                                    </a>
                                {% else %}
                                    <a href="{% url 'tournaments:detail' slug=tournament.slug %}" class="btn-card-action primary">
                                        View Details
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </article>
                    {% empty %}
                    <div class="empty-results">
                        <div class="empty-icon">
                            <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                                <circle cx="32" cy="32" r="24" stroke="currentColor" stroke-width="2"/>
                                <path d="M24 32H40M32 24V40" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <h3 class="empty-title">No Tournaments Found</h3>
                        <p class="empty-text">Try adjusting your filters or search query.</p>
                        <a href="{% url 'tournaments:hub' %}" class="empty-reset-btn">Reset All</a>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if pagination.total_pages > 1 %}
                <div class="listing-pagination">
                    {% if pagination.has_previous %}
                    <a href="?page={{ pagination.page|add:'-1' }}{% if filters.game %}&game={{ filters.game }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}" class="pagination-btn prev">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <span>Previous</span>
                    </a>
                    {% endif %}
                    
                    <span class="pagination-current">
                        Page <strong>{{ pagination.page }}</strong> of <strong>{{ pagination.total_pages }}</strong>
                    </span>
                    
                    {% if pagination.has_next %}
                    <a href="?page={{ pagination.page|add:'1' }}{% if filters.game %}&game={{ filters.game }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}" class="pagination-btn next">
                        <span>Next</span>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Scroll to Top -->
<button class="scroll-top-btn" id="scroll-top" aria-label="Scroll to top">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
        <path d="M10 15V5M10 5L5 10M10 5L15 10" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
</button>

{% endblock %}
