{% extends "base.html" %}
{% load static %}
{% block title %}Report Match Result — DeltaCrown{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'src/css/matches.css' %}">
{% endblock %}

{% block content %}
{% meta_tags title="Report Match Result — DeltaCrown" description="Submit scores and report the outcome for this match." %}

{% with m=match %}
<section aria-labelledby="h1" data-testid="match-report">
  <header class="match-header mb-3">
    <div>
      <h1 id="h1" class="mb-1">Report Match Result</h1>
      <div class="match-meta">
        {% if m.tournament %}{{ m.tournament.name }}{% else %}Tournament: —{% endif %}
        {% if m.round_no %} · Round {{ m.round_no }}{% endif %}
        {% if m.scheduled_at %} · {{ m.scheduled_at|date:"M d, Y h:i A" }}{% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      {% if m.id %}
        <a class="btn btn-outline" href="{% url 'tournaments:match_review' m.id %}">Back to Review</a>
      {% endif %}
    </div>
  </header>

  <!-- Reporting form (defensive) -->
  <article class="card p-3">
    <form method="post" class="report-grid">
      {% csrf_token %}

      {% if form %}
        {{ form.non_field_errors }}

        {# Use our component for consistent, accessible fields #}
        {% if form.score_a %}{% include "components/form_field.html" with field=form.score_a %}{% endif %}
        {% if form.score_b %}{% include "components/form_field.html" with field=form.score_b %}{% endif %}
        {% if form.notes %}{% include "components/form_field.html" with field=form.notes %}{% endif %}

      {% else %}
        <div class="form-field">
          <label class="label" for="score_a">Score — A</label>
          <input id="score_a" name="score_a" inputmode="numeric" required>
        </div>
        <div class="form-field">
          <label class="label" for="score_b">Score — B</label>
          <input id="score_b" name="score_b" inputmode="numeric" required>
        </div>
        <div class="form-field" style="grid-column:1/-1">
          <label class="label" for="notes">Notes (optional)</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Any context about the result"></textarea>
        </div>
      {% endif %}

      <div style="grid-column:1/-1" class="d-flex gap-2">
        <button class="btn btn-primary" type="submit" data-busy-text="Submitting…">Submit Report</button>
        {% if m.id %}
        <a class="btn btn-outline" href="{% url 'tournaments:match_review' m.id %}">Cancel</a>
        {% endif %}
      </div>
    </form>
  </article>

  <!-- Teams summary (optional quick context) -->
  <article class="card p-3 mt-3">
    <div class="vs-wrap">
      <span>{% firstof m.team_a.tag m.user_a.display_name "Team A" %}</span>
      <span class="vs-dot">vs</span>
      <span>{% firstof m.team_b.tag m.user_b.display_name "Team B" %}</span>
    </div>
  </article>

  <!-- Share (BD-first) -->
  <div class="mt-3">
    {% include "partials/share_block_bd.html" with title="Report Match Result" %}
  </div>
</section>
{% endwith %}
{% endblock %}
