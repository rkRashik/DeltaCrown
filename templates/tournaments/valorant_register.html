{% extends "base.html" %}
{% load static %}

{% block title %}Valorant Tournament Registration - {{ title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tokens.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* Valorant Gaming Theme */
:root {
  --valorant-red: #ff4655;
  --valorant-blue: #0f1419;
  --valorant-dark: #0f1419;
  --valorant-light: #ece8e1;
  --valorant-accent: #53212b;
  --gaming-gradient: linear-gradient(135deg, #0f1419 0%, #53212b 50%, #ff4655 100%);
  --card-shadow: 0 8px 32px rgba(255, 70, 85, 0.15);
  --glow-effect: 0 0 20px rgba(255, 70, 85, 0.3);
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  min-height: 100vh;
}

/* Dark mode (default) */
body {
  background: linear-gradient(135deg, #0f1419 0%, #1a1d23 100%);
  color: var(--valorant-light);
}

/* Light mode compatibility */
@media (prefers-color-scheme: light) {
  :root {
    --valorant-light: #2d3748;
    --valorant-dark: #f7fafc;
    --card-shadow: 0 8px 32px rgba(255, 70, 85, 0.25);
  }
  
  body {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    color: var(--valorant-light);
  }
  
  .form-container {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 70, 85, 0.3);
  }
  
  .form-section {
    border-bottom: 1px solid rgba(255, 70, 85, 0.2);
  }
  
  .form-input {
    background: rgba(0, 0, 0, 0.05);
    border: 2px solid rgba(255, 70, 85, 0.4);
    color: var(--valorant-light);
  }
  
  .form-input:focus {
    background: rgba(255, 70, 85, 0.08);
  }
  
  .player-card {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 70, 85, 0.3);
  }
  
  .info-note {
    background: rgba(59, 130, 246, 0.15);
    border: 1px solid rgba(59, 130, 246, 0.4);
    color: #2c5aa0;
  }
}

.valorant-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.valorant-header {
  text-align: center;
  margin-bottom: 3rem;
  position: relative;
}

.valorant-title {
  font-family: 'Orbitron', monospace;
  font-size: 3rem;
  font-weight: 900;
  background: var(--gaming-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.valorant-subtitle {
  font-size: 1.2rem;
  color: #a8a8a8;
  margin-bottom: 0.5rem;
}

.tournament-info-banner {
  background: rgba(255, 70, 85, 0.1);
  border: 2px solid var(--valorant-red);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(10px);
}

.form-container {
  background: rgba(15, 20, 25, 0.9);
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 70, 85, 0.2);
  overflow: hidden;
}

.form-section {
  padding: 2rem;
  border-bottom: 1px solid rgba(255, 70, 85, 0.1);
}

.form-section:last-child {
  border-bottom: none;
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
}

.section-number {
  background: var(--valorant-red);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  margin-right: 1rem;
  font-family: 'Orbitron', monospace;
}

.section-title {
  font-family: 'Orbitron', monospace;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--valorant-light);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-grid {
  display: grid;
  gap: 1.5rem;
}

.form-grid-2 {
  grid-template-columns: 1fr 1fr;
}

.form-grid-3 {
  grid-template-columns: 1fr 1fr 1fr;
}

@media (max-width: 768px) {
  .form-grid-2,
  .form-grid-3 {
    grid-template-columns: 1fr;
  }
}

.form-group {
  position: relative;
}

.form-label {
  display: block;
  font-weight: 500;
  color: var(--valorant-light);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-label .required {
  color: var(--valorant-red);
  margin-left: 4px;
}

.form-input {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 70, 85, 0.3);
  border-radius: 8px;
  padding: 12px 16px;
  color: var(--valorant-light);
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus {
  outline: none;
  border-color: var(--valorant-red);
  background: rgba(255, 70, 85, 0.05);
  box-shadow: var(--glow-effect);
}

.form-input::placeholder {
  color: #666;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ff4655' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

.file-upload-zone {
  border: 2px dashed rgba(255, 70, 85, 0.3);
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  background: rgba(255, 70, 85, 0.02);
  transition: all 0.3s ease;
  cursor: pointer;
}

.file-upload-zone:hover {
  border-color: var(--valorant-red);
  background: rgba(255, 70, 85, 0.05);
}

.player-roster {
  background: rgba(255, 70, 85, 0.05);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.player-card {
  background: rgba(15, 20, 25, 0.8);
  border: 1px solid rgba(255, 70, 85, 0.2);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  position: relative;
}

.player-card:last-child {
  margin-bottom: 0;
}

.player-card-header {
  display: flex;
  align-items: center;
  justify-content: between;
  margin-bottom: 1rem;
}

.player-role-badge {
  background: var(--valorant-red);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.player-role-badge.substitute {
  background: #fbbf24;
  color: #000;
}

.checkbox-group {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 1rem;
  background: rgba(255, 70, 85, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 70, 85, 0.2);
  margin: 1rem 0;
}

.checkbox-input {
  width: 20px;
  height: 20px;
  accent-color: var(--valorant-red);
  margin-top: 2px;
  flex-shrink: 0;
}

.rules-section {
  background: rgba(255, 70, 85, 0.08);
  border: 1px solid rgba(255, 70, 85, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.rules-link {
  color: var(--valorant-red);
  text-decoration: underline;
  font-weight: 500;
  transition: color 0.3s ease;
}

.rules-link:hover {
  color: #ff6b7a;
}

.submit-section {
  background: var(--gaming-gradient);
  padding: 2rem;
  text-align: center;
}

.submit-button {
  background: var(--valorant-red);
  color: white;
  border: none;
  padding: 16px 48px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', monospace;
  box-shadow: 0 4px 20px rgba(255, 70, 85, 0.3);
}

.submit-button:hover {
  background: #ff6b7a;
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(255, 70, 85, 0.4);
}

.submit-button:active {
  transform: translateY(0);
}

.add-player-btn {
  background: transparent;
  border: 2px solid var(--valorant-red);
  color: var(--valorant-red);
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 1rem 0;
}

.add-player-btn:hover {
  background: var(--valorant-red);
  color: white;
}

.info-note {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 1rem;
  color: #93c5fd;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 6px;
  padding: 12px;
  color: #fca5a5;
  font-size: 0.9rem;
  margin-top: 8px;
}

.validation-error {
  color: #f87171;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: none;
}

.validation-success {
  color: #4ade80;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: none;
}

.form-input.error {
  border-color: #ef4444 !important;
  background: rgba(239, 68, 68, 0.05);
  box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.2);
}

.form-input.success {
  border-color: #22c55e !important;
  background: rgba(34, 197, 94, 0.05);
  box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.2);
}

.form-input:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
}

.loading {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn-loading {
  position: relative;
}

.btn-loading::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 0.5rem;
  animation: pulse 2s infinite;
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-section {
  animation: fadeInUp 0.6s ease forwards;
}

.form-section:nth-child(2) { animation-delay: 0.1s; }
.form-section:nth-child(3) { animation-delay: 0.2s; }
.form-section:nth-child(4) { animation-delay: 0.3s; }
.form-section:nth-child(5) { animation-delay: 0.4s; }

/* Gaming effects */
.form-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--gaming-gradient);
  z-index: 1;
}

.glow-text {
  text-shadow: 0 0 10px rgba(255, 70, 85, 0.5);
}
</style>
{% endblock %}

{% block content %}
<div class="valorant-container">
    {% if messages %}
        {% for message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}error-message{% elif message.tags == 'success' %}bg-green-500/10 text-green-300 border border-green-500/30{% else %}info-note{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Header Section -->
    <div class="valorant-header">
        <h1 class="valorant-title glow-text">Valorant Tournament</h1>
        <h2 class="valorant-subtitle">{{ title }}</h2>
        
        <div class="tournament-info-banner">
            <div class="flex items-center justify-center gap-6">
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-valorant-red">Entry Fee</div>
                    <div class="text-2xl font-bold">{% if entry_fee %}‡ß≥{{ entry_fee }}{% else %}FREE{% endif %}</div>
                </div>
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-valorant-red">Format</div>
                    <div class="text-2xl font-bold">5v5 Team Tournament</div>
                </div>
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-valorant-red">Region</div>
                    <div class="text-2xl font-bold">Bangladesh</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Form -->
    <form method="post" enctype="multipart/form-data" class="form-container">
        {% csrf_token %}
        
        <!-- Honeypot -->
        <input type="text" name="website" style="display:none;" tabindex="-1" autocomplete="off">

        <!-- Section 1: Team Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">1</div>
                <h3 class="section-title">Team Information</h3>
            </div>
            
            {% if user_team %}
                <div class="info-note mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-valorant-red">üéÆ</span>
                        <strong>Existing Team Found: {{ user_team.name }}</strong>
                    </div>
                    <div class="text-sm">Your team information has been automatically loaded. You can update it below if needed.</div>
                </div>
            {% else %}
                <div class="info-note mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-valorant-red">‚ûï</span>
                        <strong>Create New Team</strong>
                    </div>
                    <div class="text-sm">You don't have a Valorant team yet. Create one below for this tournament.</div>
                </div>
            {% endif %}
            
            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">
                        Team Name <span class="required">*</span>
                    </label>
                    <input type="text" name="team_name" class="form-input" 
                           value="{% if user_team %}{{ user_team.name }}{% endif %}"
                           placeholder="Enter your team's official name" required>
                    <div class="info-note">
                        This name will appear on the tournament bracket and all official communications.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Team Tag <span class="text-gray-400">(Optional)</span>
                    </label>
                    <input type="text" name="team_tag" class="form-input" 
                           value="{% if user_team %}{{ user_team.tag|default:'' }}{% endif %}"
                           placeholder="e.g., NGA, VLR" maxlength="5">
                    <div class="info-note">
                        A short abbreviation of your team name (max 5 characters).
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Team Logo <span class="text-gray-400">(Optional)</span></label>
                <div class="file-upload-zone">
                    <input type="file" name="team_logo" accept="image/*" style="display: none;" id="team-logo-input">
                    <label for="team-logo-input" class="cursor-pointer">
                        {% if user_team and user_team.logo %}
                            <img src="{{ user_team.logo.url }}" alt="Current team logo" class="max-h-16 mb-2 mx-auto">
                            <div class="font-medium">Click to change team logo</div>
                        {% else %}
                            <div class="text-valorant-red text-2xl mb-2">üìÅ</div>
                            <div class="font-medium">Click to upload team logo</div>
                        {% endif %}
                        <div class="text-sm text-gray-400 mt-1">PNG, JPG up to 5MB</div>
                    </label>
                </div>
            </div>
            
            {% if not user_team %}
                <div class="checkbox-group">
                    <input type="checkbox" name="save_team" class="checkbox-input" checked>
                    <label class="text-sm">
                        <span class="font-medium text-valorant-light">Save this team to my profile for future tournaments</span>
                        <div class="text-gray-400 mt-1">
                            This will create a permanent team that you can use across multiple Valorant tournaments.
                        </div>
                    </label>
                </div>
            {% endif %}
        </div>

        <!-- Section 2: Team Captain Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">2</div>
                <h3 class="section-title">Team Captain Information</h3>
            </div>
            
            <div class="info-note mb-4">
                The Team Captain is the main point of contact for tournament-related updates and communications.
            </div>

            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">
                        Full Name <span class="required">*</span>
                    </label>
                    <input type="text" name="captain_full_name" class="form-input" 
                           placeholder="Enter captain's full name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Email Address <span class="required">*</span>
                    </label>
                    <input type="email" name="captain_email" class="form-input" 
                           placeholder="captain@example.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="captain_riot_id">
                        Riot ID & Tagline <span class="required">*</span>
                    </label>
                    <input type="text" 
                           name="captain_riot_id" 
                           id="captain_riot_id"
                           class="form-input" 
                           placeholder="PlayerName#TAG" 
                           required
                           pattern="^[a-zA-Z0-9\s]{3,16}#[a-zA-Z0-9]{3,5}$"
                           title="Must be in format: Username#TAG (e.g., PlayerName#NA1)"
                           aria-describedby="riot-id-help riot-id-error">
                    <div class="info-note" id="riot-id-help">
                        Enter your Riot ID exactly as it appears in-game (e.g., PlayerName#NA1).
                    </div>
                    <div class="validation-error" id="riot-id-error" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="captain_discord">
                        Discord ID <span class="required">*</span>
                    </label>
                    <input type="text" 
                           name="captain_discord" 
                           id="captain_discord"
                           class="form-input" 
                           placeholder="Username#1234" 
                           required
                           pattern="^.{3,32}#[0-9]{4}$"
                           title="Must be in format: Username#1234"
                           aria-describedby="discord-help discord-error">
                    <div class="info-note" id="discord-help">
                        Your Discord username with discriminator for tournament communications.
                    </div>
                    <div class="validation-error" id="discord-error" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Phone Number <span class="text-gray-400">(Optional)</span>
                    </label>
                    <input type="tel" name="captain_phone" class="form-input" 
                           placeholder="+880 1XXX-XXXXXX">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Country <span class="required">*</span>
                    </label>
                    <select name="captain_country" class="form-input form-select" required>
                        <option value="">Select Country</option>
                        <option value="BD">Bangladesh</option>
                        <option value="IN">India</option>
                        <option value="PK">Pakistan</option>
                        <option value="LK">Sri Lanka</option>
                        <option value="NP">Nepal</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 3: Player Roster -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">3</div>
                <h3 class="section-title">Player Roster</h3>
            </div>
            
            <div class="info-note mb-4">
                The Team Captain is automatically added as Player 1. Add your team members below - you can register up to 5 main players and 2 substitutes.
            </div>

            <div class="player-roster" id="player-roster">
                <!-- Player 1 (Captain) - Auto-populated -->
                <div class="player-card" id="captain-card">
                    <div class="player-card-header">
                        <div class="flex items-center gap-3">
                            <span class="player-role-badge">Captain</span>
                            <span class="font-medium">Player 1 (Team Captain)</span>
                        </div>
                        <span class="text-sm text-gray-400">Auto-populated from captain info</span>
                    </div>
                    
                    <div class="form-grid form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Full Name <span class="required">*</span></label>
                            <input type="text" name="player_1_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Riot ID & Tagline <span class="required">*</span></label>
                            <input type="text" name="player_1_riot_id" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord ID <span class="required">*</span></label>
                            <input type="text" name="player_1_discord" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                            <input type="email" name="player_1_email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone <span class="text-gray-400">(Optional)</span></label>
                            <input type="tel" name="player_1_phone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country <span class="required">*</span></label>
                            <select name="player_1_country" class="form-input form-select" required>
                                <option value="">Select Country</option>
                                <option value="BD">Bangladesh</option>
                                <option value="IN">India</option>
                                <option value="PK">Pakistan</option>
                                <option value="LK">Sri Lanka</option>
                                <option value="NP">Nepal</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Player 2 -->
                <div class="player-card">
                    <div class="player-card-header">
                        <div class="flex items-center gap-3">
                            <span class="player-role-badge">Main</span>
                            <span class="font-medium">Player 2</span>
                        </div>
                        <button type="button" onclick="removePlayer(this)" class="text-red-400 hover:text-red-300">
                            ‚úï
                        </button>
                    </div>
                    
                    <div class="form-grid form-grid-3">
                        <div class="form-group">
                            <label class="form-label">Full Name <span class="required">*</span></label>
                            <input type="text" name="player_2_name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Riot ID & Tagline <span class="required">*</span></label>
                            <input type="text" name="player_2_riot_id" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord ID <span class="required">*</span></label>
                            <input type="text" name="player_2_discord" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                            <input type="email" name="player_2_email" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone <span class="text-gray-400">(Optional)</span></label>
                            <input type="tel" name="player_2_phone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country <span class="required">*</span></label>
                            <select name="player_2_country" class="form-input form-select" required>
                                <option value="">Select Country</option>
                                <option value="BD">Bangladesh</option>
                                <option value="IN">India</option>
                                <option value="PK">Pakistan</option>
                                <option value="LK">Sri Lanka</option>
                                <option value="NP">Nepal</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Players 3, 4, 5 would follow the same pattern -->
                <!-- I'll add JavaScript to dynamically generate these -->
            </div>

            <button type="button" class="add-player-btn" onclick="addPlayer()">
                <span>‚ûï</span> Add Another Player
            </button>
        </div>

        <!-- Section 4: Tournament Rules & Agreement -->
        {% if tournament_rules.has_rules %}
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">4</div>
                <h3 class="section-title">Tournament Rules & Agreement</h3>
            </div>
            
            <div class="rules-section">
                {% if tournament_rules.rules_pdf_url %}
                    <div class="mb-4">
                        <a href="{{ tournament_rules.rules_pdf_url }}" target="_blank" class="rules-link">
                            üìÑ Download Tournament Rules PDF
                        </a>
                    </div>
                {% endif %}

                {% if tournament_rules.rules_text %}
                    <div class="mb-4">
                        <h5 class="font-medium text-valorant-light mb-2">Tournament Rules:</h5>
                        <div class="text-sm text-gray-300 prose prose-sm max-w-none">
                            {{ tournament_rules.rules_text|safe }}
                        </div>
                    </div>
                {% endif %}

                {% if tournament_rules.extra_rules %}
                    <div class="mb-4">
                        <h5 class="font-medium text-valorant-light mb-2">Additional Rules:</h5>
                        <div class="text-sm text-gray-300 prose prose-sm max-w-none">
                            {{ tournament_rules.extra_rules|safe }}
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="agree_rules" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-valorant-light">I acknowledge that I have read and agree to the tournament's rules and conditions.</span>
                    <div class="text-gray-400 mt-1">
                        By checking this box, you confirm that you and all team members will abide by the tournament rules and regulations.
                    </div>
                </label>
            </div>
        </div>
        {% endif %}

        <!-- Section 5: Anti-Cheat & Verification -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">5</div>
                <h3 class="section-title">Anti-Cheat & Account Verification</h3>
            </div>
            
            <div class="info-note mb-4">
                Some tournaments require secondary account details for anti-cheat verification. Please provide if requested by tournament organizers.
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="agree_anticheat" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-valorant-light">I agree to anti-cheat measures and account verification if required.</span>
                    <div class="text-gray-400 mt-1">
                        This includes providing secondary account information and allowing organizers to verify player accounts.
                    </div>
                </label>
            </div>
        </div>

        <!-- Section 6: Payment Information -->
        {% if entry_fee %}
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">6</div>
                <h3 class="section-title">Payment Information</h3>
            </div>
            
            <div class="tournament-info-banner mb-4">
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-valorant-red mb-2">Entry Fee Required</div>
                    <div class="text-2xl font-bold">‡ß≥{{ entry_fee }}</div>
                    <div class="text-sm text-gray-300 mt-2">Payment verification will be done manually by organizers</div>
                </div>
            </div>

            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">Payment Method <span class="required">*</span></label>
                    <select name="payment_method" class="form-input form-select" required>
                        <option value="">Select Payment Method</option>
                        {% if payment_config.bkash %}
                            <option value="bkash">bKash - {{ payment_config.bkash }}</option>
                        {% endif %}
                        {% if payment_config.nagad %}
                            <option value="nagad">Nagad - {{ payment_config.nagad }}</option>
                        {% endif %}
                        {% if payment_config.rocket %}
                            <option value="rocket">Rocket - {{ payment_config.rocket }}</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Account Number <span class="required">*</span></label>
                    <input type="text" name="payer_account_number" class="form-input" 
                           placeholder="Account number used for payment" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction ID <span class="required">*</span></label>
                    <input type="text" name="payment_reference" class="form-input" 
                           placeholder="Enter transaction ID/reference" required minlength="6">
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="agree_payment" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-valorant-light">I agree to pay the entry fee of ‡ß≥{{ entry_fee }}.</span>
                    <div class="text-gray-400 mt-1">
                        Payment verification will be completed after registration. You'll receive confirmation within 24 hours.
                    </div>
                </label>
            </div>
        </div>
        {% endif %}

        <!-- Section 7: Privacy & Communication -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">{% if entry_fee %}7{% else %}6{% endif %}</div>
                <h3 class="section-title">Privacy & Communication</h3>
            </div>

            <div class="space-y-4">
                <div class="checkbox-group">
                    <input type="checkbox" name="agree_visibility" class="checkbox-input" required>
                    <label class="text-sm">
                        <span class="font-medium text-valorant-light">I agree that my Riot ID and team information will be visible to other participants.</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="agree_communication" class="checkbox-input" required>
                    <label class="text-sm">
                        <span class="font-medium text-valorant-light">I consent to receive communications regarding match details and tournament updates.</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <div class="checkbox-group mb-6">
                <input type="checkbox" name="confirm_accuracy" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-white">I confirm that all provided information is accurate and complete.</span>
                    <div class="text-gray-200 mt-1">
                        Incorrect information may lead to disqualification. Please double-check all details before submitting.
                    </div>
                </label>
            </div>

            <button type="submit" class="submit-button">
                Submit Registration
            </button>
            
            <div class="text-sm text-gray-200 mt-4">
                After submission, you can update your registration details in your dashboard before the tournament begins.
            </div>
        </div>
    </form>
</div>

<script>
let playerCount = 2; // Start with 2 since captain is player 1
const maxPlayers = 7; // 5 main + 2 substitutes

function addPlayer() {
    if (playerCount >= maxPlayers) {
        alert('Maximum 7 players allowed (5 main players + 2 substitutes)');
        return;
    }
    
    playerCount++;
    const isSubstitute = playerCount > 5;
    const playerRole = isSubstitute ? 'substitute' : 'main';
    const playerRoleText = isSubstitute ? 'Substitute' : 'Main';
    
    const playerCard = document.createElement('div');
    playerCard.className = 'player-card';
    playerCard.innerHTML = `
        <div class="player-card-header">
            <div class="flex items-center gap-3">
                <span class="player-role-badge ${playerRole}">${playerRoleText}</span>
                <span class="font-medium">Player ${playerCount}${isSubstitute ? ' (Substitute)' : ''}</span>
            </div>
            <button type="button" onclick="removePlayer(this)" class="text-red-400 hover:text-red-300">
                ‚úï
            </button>
        </div>
        
        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label class="form-label">Full Name <span class="required">*</span></label>
                <input type="text" name="player_${playerCount}_name" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Riot ID & Tagline <span class="required">*</span></label>
                <input type="text" name="player_${playerCount}_riot_id" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Discord ID <span class="required">*</span></label>
                <input type="text" name="player_${playerCount}_discord" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" name="player_${playerCount}_email" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Phone <span class="text-gray-400">(Optional)</span></label>
                <input type="tel" name="player_${playerCount}_phone" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Country <span class="required">*</span></label>
                <select name="player_${playerCount}_country" class="form-input form-select" required>
                    <option value="">Select Country</option>
                    <option value="BD">Bangladesh</option>
                    <option value="IN">India</option>
                    <option value="PK">Pakistan</option>
                    <option value="LK">Sri Lanka</option>
                    <option value="NP">Nepal</option>
                    <option value="OTHER">Other</option>
                </select>
            </div>
        </div>
    `;
    
    document.getElementById('player-roster').appendChild(playerCard);
    
    // Hide add button if max players reached
    if (playerCount >= maxPlayers) {
        document.querySelector('.add-player-btn').style.display = 'none';
    }
}

function removePlayer(button) {
    const playerCard = button.closest('.player-card');
    playerCard.remove();
    playerCount--;
    
    // Show add button if under max players
    if (playerCount < maxPlayers) {
        document.querySelector('.add-player-btn').style.display = 'flex';
    }
    
    // Renumber remaining players
    const playerCards = document.querySelectorAll('.player-card');
    playerCards.forEach((card, index) => {
        if (index === 0) return; // Skip captain card
        
        const playerNumber = index + 1;
        const isSubstitute = playerNumber > 5;
        const roleText = isSubstitute ? 'Substitute' : 'Main';
        
        // Update header
        const header = card.querySelector('.player-card-header span:last-child');
        header.textContent = `Player ${playerNumber}${isSubstitute ? ' (Substitute)' : ''}`;
        
        // Update badge
        const badge = card.querySelector('.player-role-badge');
        badge.textContent = roleText;
        badge.className = `player-role-badge ${isSubstitute ? 'substitute' : ''}`;
        
        // Update input names
        const inputs = card.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.name;
            if (name && name.startsWith('player_')) {
                const suffix = name.split('_').slice(2).join('_');
                input.name = `player_${playerNumber}_${suffix}`;
            }
        });
    });
}

// Enhanced form validation and user experience
document.addEventListener('DOMContentLoaded', function() {
    initializeFormValidation();
    initializeUserExperience();
    initializeAccessibility();
});

// Real-time form validation
function initializeFormValidation() {
    const form = document.querySelector('form[method="post"]');
    if (!form) return;
    
    // Riot ID validation for all fields
    const riotIdFields = document.querySelectorAll('input[name*="riot_id"]');
    riotIdFields.forEach(field => {
        addRealTimeValidation(field, validateRiotId, field.name + '-error');
    });
    
    // Discord ID validation  
    const discordFields = document.querySelectorAll('input[name*="discord"]');
    discordFields.forEach(field => {
        addRealTimeValidation(field, validateDiscordId, field.name + '-error');
    });
    
    // Email validation
    const emailFields = document.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
        addRealTimeValidation(field, validateEmail, field.name + '-error');
    });
    
    // Phone validation
    const phoneFields = document.querySelectorAll('input[type="tel"]');
    phoneFields.forEach(field => {
        addRealTimeValidation(field, validatePhone, field.name + '-error');
    });
}

function addRealTimeValidation(field, validator, errorId) {
    let errorDiv = document.getElementById(errorId);
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = errorId;
        errorDiv.className = 'validation-error';
        field.parentNode.appendChild(errorDiv);
    }
    
    field.addEventListener('input', function() {
        clearTimeout(field.validationTimeout);
        field.validationTimeout = setTimeout(() => {
            const result = validator(field.value);
            showValidationResult(field, errorDiv, result);
        }, 300);
    });
    
    field.addEventListener('blur', function() {
        const result = validator(field.value);
        showValidationResult(field, errorDiv, result);
    });
}

function showValidationResult(field, errorDiv, result) {
    field.classList.remove('error', 'success');
    errorDiv.style.display = 'none';
    
    if (field.value && result.isValid) {
        field.classList.add('success');
    } else if (field.value && !result.isValid && result.message) {
        field.classList.add('error');
        errorDiv.textContent = result.message;
        errorDiv.style.display = 'block';
    }
}

// Validation functions
function validateRiotId(value) {
    if (!value) return { isValid: false, message: '' };
    
    const riotIdPattern = /^[a-zA-Z0-9\s]{3,16}#[a-zA-Z0-9]{3,5}$/;
    if (!riotIdPattern.test(value)) {
        return { isValid: false, message: '‚ö†Ô∏è Format: Username#TAG (e.g., PlayerName#NA1)' };
    }
    
    return { isValid: true };
}

function validateDiscordId(value) {
    if (!value) return { isValid: false, message: '' };
    
    const discordPattern = /^.{2,32}#[0-9]{4}$/;
    if (!discordPattern.test(value)) {
        return { isValid: false, message: '‚ö†Ô∏è Format: Username#1234' };
    }
    
    return { isValid: true };
}

function validateEmail(value) {
    if (!value) return { isValid: true }; // Optional field
    
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(value)) {
        return { isValid: false, message: '‚ö†Ô∏è Please enter a valid email address' };
    }
    
    return { isValid: true };
}

function validatePhone(value) {
    if (!value) return { isValid: true }; // Optional field
    
    const phonePattern = /^(\+?88)?01[3-9]\d{8}$/;
    if (!phonePattern.test(value.replace(/[\s-]/g, ''))) {
        return { isValid: false, message: '‚ö†Ô∏è Please enter a valid phone number' };
    }
    
    return { isValid: true };
}

// Enhanced user experience features
function initializeUserExperience() {
    // Auto-format input fields
    formatInputFields();
    
    // Form submission with validation
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateAllRequiredFields()) {
                e.preventDefault();
                showNotification('‚ö†Ô∏è Please fill in all required fields correctly', 'error');
                return false;
            }
            
            handleFormSubmission();
        });
    }
    
    // Progress tracking
    trackFormProgress();
}

function formatInputFields() {
    // Auto-format Riot ID
    const riotIdFields = document.querySelectorAll('input[name*="riot_id"]');
    riotIdFields.forEach(field => {
        field.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^a-zA-Z0-9#\s]/g, '');
            const hashCount = (value.match(/#/g) || []).length;
            if (hashCount > 1) {
                value = value.replace(/#.*#/, '#');
            }
            e.target.value = value;
        });
    });
    
    // Auto-format phone numbers
    const phoneFields = document.querySelectorAll('input[type="tel"]');
    phoneFields.forEach(field => {
        field.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('88')) {
                value = '+' + value;
            } else if (value.startsWith('01')) {
                value = '+88' + value;
            }
            e.target.value = value;
        });
    });
}

function trackFormProgress() {
    const requiredFields = document.querySelectorAll('input[required]');
    let completedFields = 0;
    
    requiredFields.forEach(field => {
        field.addEventListener('input', function() {
            completedFields = Array.from(requiredFields).filter(f => f.value.trim()).length;
            const progress = (completedFields / requiredFields.length) * 100;
            updateProgressBar(progress);
        });
    });
}

function updateProgressBar(percentage) {
    let progressBar = document.querySelector('.form-progress-bar');
    if (!progressBar) {
        progressBar = createProgressBar();
    }
    
    progressBar.style.width = percentage + '%';
    
    const progressText = document.querySelector('.progress-text');
    if (progressText) {
        progressText.textContent = `${Math.round(percentage)}% Complete`;
    }
}

function createProgressBar() {
    const container = document.createElement('div');
    container.className = 'progress-container fixed top-0 left-0 right-0 z-50';
    container.innerHTML = `
        <div class="bg-gray-800 h-1">
            <div class="form-progress-bar bg-red-500 h-1 transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="progress-text text-xs text-gray-400 text-center py-1 bg-gray-900">0% Complete</div>
    `;
    
    document.body.insertBefore(container, document.body.firstChild);
    return container.querySelector('.form-progress-bar');
}

// Accessibility improvements
function initializeAccessibility() {
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.setAttribute('novalidate', ''); // Use custom validation
    }
    
    // Add keyboard navigation support
    addKeyboardSupport();
}

function addKeyboardSupport() {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.type !== 'submit') {
            e.preventDefault();
            const nextField = getNextField(e.target);
            if (nextField) {
                nextField.focus();
            }
        }
    });
}

function getNextField(currentField) {
    const formFields = Array.from(document.querySelectorAll('input, select, textarea'));
    const currentIndex = formFields.indexOf(currentField);
    return formFields[currentIndex + 1];
}

function validateAllRequiredFields() {
    const requiredFields = document.querySelectorAll('input[required]');
    let allValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('error');
            allValid = false;
        } else {
            field.classList.remove('error');
        }
    });
    
    return allValid;
}

function handleFormSubmission() {
    const submitBtn = document.querySelector('.submit-button');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>‚ö° Processing Registration...';
        submitBtn.classList.add('btn-loading');
        
        showNotification('üéÆ Registering your Valorant team...', 'info');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform ${
        type === 'error' ? 'bg-red-600' : 
        type === 'success' ? 'bg-green-600' : 'bg-blue-600'
    } text-white max-w-sm`;
    
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// Auto-populate captain fields and load team data
document.addEventListener('DOMContentLoaded', function() {
    // Auto-populate captain fields to player 1
    const captainFields = ['full_name', 'email', 'riot_id', 'discord', 'phone', 'country'];
    
    captainFields.forEach(field => {
        const captainInput = document.querySelector(`input[name="captain_${field}"], select[name="captain_${field}"]`);
        const playerInput = document.querySelector(`input[name="player_1_${field}"], select[name="player_1_${field}"]`);
        
        if (captainInput && playerInput) {
            captainInput.addEventListener('input', function() {
                playerInput.value = this.value;
            });
        }
    });
    
    // Load existing team member data if available
    {% if team_members %}
        const teamMembers = {{ team_members|safe }};
        
        // Populate existing team members
        teamMembers.forEach((member, index) => {
            if (index === 0) {
                // Captain (Player 1) - already auto-populated
                if (member.name) {
                    document.querySelector('input[name="captain_full_name"]').value = member.name;
                }
                if (member.email) {
                    document.querySelector('input[name="captain_email"]').value = member.email;
                }
            } else if (index < 7) {
                // Other players (2-7)
                const playerNum = index + 1;
                
                // Create player card if it doesn't exist
                if (!document.querySelector(`input[name="player_${playerNum}_name"]`)) {
                    addPlayer();
                }
                
                // Populate player data
                if (member.name) {
                    const nameInput = document.querySelector(`input[name="player_${playerNum}_name"]`);
                    if (nameInput) nameInput.value = member.name;
                }
                if (member.email) {
                    const emailInput = document.querySelector(`input[name="player_${playerNum}_email"]`);
                    if (emailInput) emailInput.value = member.email;
                }
            }
        });
    {% endif %}
});
</script>
{% endblock %}