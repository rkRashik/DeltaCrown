{% load humanize %}
{# Step 2 (Team): Squad Lineup — categorized by Starters, Substitutes, Coaches #}
<div data-wizard-step="roster" class="wizard-step step-hidden animate-slide-up">

    <div class="mb-6 pb-4 border-b border-white/10">
        <h2 class="font-gaming font-bold text-2xl md:text-3xl text-white mb-1">Squad Lineup</h2>
        <p class="text-sm text-gray-400">Review your roster and assign positions for <span class="text-white font-medium">{{ tournament.name }}</span>.</p>
    </div>

    {# ── Stat Bar ── #}
    <div class="mb-6 grid grid-cols-3 md:grid-cols-4 gap-2">
        <div class="p-3 rounded-xl border border-white/5 bg-white/[0.02] text-center">
            <div class="text-lg font-black text-white" id="count-starters">0</div>
            <div class="text-[10px] font-bold uppercase tracking-widest mt-0.5" style="color: var(--accent);">Starters</div>
            <div class="text-[10px] text-gray-600 mt-0.5">/ {{ roster_config.max_team_size|default:5 }} required</div>
        </div>
        <div class="p-3 rounded-xl border border-white/5 bg-white/[0.02] text-center">
            <div class="text-lg font-black text-white" id="count-subs">0</div>
            <div class="text-[10px] font-bold uppercase tracking-widest text-blue-400 mt-0.5">Substitutes</div>
            <div class="text-[10px] text-gray-600 mt-0.5">/ {{ roster_config.max_substitutes|default:2 }} max</div>
        </div>
        {% if roster_config.allow_coaches %}
        <div class="p-3 rounded-xl border border-white/5 bg-white/[0.02] text-center">
            <div class="text-lg font-black text-white" id="count-coaches">0</div>
            <div class="text-[10px] font-bold uppercase tracking-widest text-purple-400 mt-0.5">Coaches</div>
            <div class="text-[10px] text-gray-600 mt-0.5">/ {{ roster_config.max_coaches|default:1 }} max</div>
        </div>
        {% endif %}
        <div class="p-3 rounded-xl border text-center" style="border-color: rgba(var(--accent-rgb), 0.15); background: rgba(var(--accent-rgb), 0.04);">
            <div class="text-lg font-black" style="color: var(--accent);" id="roster-count-text">{{ roster_members|length }}</div>
            <div class="text-[10px] font-bold uppercase tracking-widest text-gray-400 mt-0.5">Total</div>
            <div class="text-[10px] text-gray-600 mt-0.5">{{ roster_config.team_size_display|default:"5v5" }}</div>
        </div>
    </div>

    {# Validation info #}
    <div class="mb-5 text-xs text-gray-500 flex items-start gap-2">
        <i data-lucide="info" class="w-4 h-4 shrink-0 mt-0.5" style="color: var(--accent);"></i>
        <span>
            This tournament requires <strong class="text-white">{{ roster_config.min_team_size|default:5 }}</strong> starters ({{ roster_config.team_size_display|default:"5v5" }}).
            Click any player to edit their position, in-game role, and view their game passport details.
        </span>
    </div>

    {% if roster_members %}
    {# ══════ STARTERS SECTION ══════ #}
    <div class="mb-6" id="section-starters">
        <div class="flex items-center gap-3 mb-3">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-black uppercase tracking-[0.15em] shrink-0" style="background: rgba(var(--accent-rgb), 0.1); border: 1px solid rgba(var(--accent-rgb), 0.2); color: var(--accent);">
                <i data-lucide="swords" class="w-3.5 h-3.5"></i> Starters
            </div>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        </div>
        <div class="grid gap-2" id="roster-starters">
            {% for member in roster_members %}
            {% if member.roster_slot != 'SUBSTITUTE' and member.roster_slot != 'COACH' and member.role != 'HEAD_COACH' and member.role != 'COACH' %}
            {% include "tournaments/registration/includes/_roster_card.html" with member=member slot_type="starter" %}
            {% endif %}
            {% endfor %}
        </div>
    </div>

    {# ══════ SUBSTITUTES SECTION ══════ #}
    <div class="mb-6" id="section-subs">
        <div class="flex items-center gap-3 mb-3">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-black uppercase tracking-[0.15em] shrink-0 bg-blue-500/10 border border-blue-500/20 text-blue-400">
                <i data-lucide="arrow-left-right" class="w-3.5 h-3.5"></i> Substitutes
            </div>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        </div>
        <div class="grid gap-2" id="roster-subs">
            {% for member in roster_members %}
            {% if member.roster_slot == 'SUBSTITUTE' %}
            {% include "tournaments/registration/includes/_roster_card.html" with member=member slot_type="sub" %}
            {% endif %}
            {% endfor %}
        </div>
        <div class="empty-section-hint text-center py-4 text-gray-600 text-xs hidden">
            <p>No substitutes assigned. Click a player above and change their position.</p>
        </div>
    </div>

    {% if roster_config.allow_coaches %}
    {# ══════ COACHES SECTION ══════ #}
    <div class="mb-6" id="section-coaches">
        <div class="flex items-center gap-3 mb-3">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-black uppercase tracking-[0.15em] shrink-0 bg-purple-500/10 border border-purple-500/20 text-purple-400">
                <i data-lucide="graduation-cap" class="w-3.5 h-3.5"></i> Coaching Staff
            </div>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-white/10 to-transparent"></div>
        </div>
        <div class="grid gap-2" id="roster-coaches">
            {% for member in roster_members %}
            {% if member.roster_slot == 'COACH' or member.role == 'HEAD_COACH' or member.role == 'COACH' %}
            {% include "tournaments/registration/includes/_roster_card.html" with member=member slot_type="coach" %}
            {% endif %}
            {% endfor %}
        </div>
        <div class="empty-section-hint text-center py-4 text-gray-600 text-xs hidden">
            <p>No coaching staff assigned.</p>
        </div>
    </div>
    {% endif %}

    <input type="hidden" name="roster_member_ids" value="{% for m in roster_members %}{{ m.id }}{% if not forloop.last %},{% endif %}{% endfor %}">

    {% else %}
    {# Empty roster fallback #}
    <div class="text-center py-10 text-gray-500">
        <i data-lucide="users" class="w-10 h-10 mx-auto mb-3 text-gray-600"></i>
        <p class="text-sm font-medium mb-1">No active members found</p>
        <p class="text-xs">Invite players to your team before registering.</p>
    </div>
    {% endif %}

    {# Roster validation message #}
    <div id="roster-validation" class="mt-4 p-3 rounded-xl border text-xs font-medium hidden"></div>
</div>
