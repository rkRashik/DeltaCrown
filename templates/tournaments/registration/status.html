{% extends "base.html" %}
{% load static %}

{% block title %}Registration Status - {{ tournament.title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-12">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'tournaments:detail' tournament.slug %}" 
                class="inline-flex items-center text-gray-400 hover:text-white mb-4">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Tournament
            </a>
            <h1 class="text-3xl font-bold text-white mb-2">Registration Status</h1>
            <p class="text-gray-400">{{ tournament.title }}</p>
        </div>

        <!-- Status Card -->
        <div class="gradient-border rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <div class="text-6xl mr-4">{{ status_info.icon }}</div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-1">{{ status_info.title }}</h2>
                        <p class="text-{{ status_info.color }}-400">{{ status_info.message }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Registration ID</div>
                    <div class="text-xl font-mono font-bold text-primary">REG-{{ registration.id|stringformat:"06d" }}</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="relative">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs text-gray-400">Registration Progress</span>
                    <span class="text-xs text-gray-400">
                        {% if status_info.status == 'verified' or status_info.status == 'waived' %}
                            100% Complete
                        {% elif status_info.status == 'submitted' %}
                            66% Complete
                        {% elif status_info.status == 'rejected' %}
                            33% Complete
                        {% else %}
                            0% Complete
                        {% endif %}
                    </span>
                </div>
                <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-primary to-secondary transition-all duration-500"
                        style="width: {% if status_info.status == 'verified' or status_info.status == 'waived' %}100{% elif status_info.status == 'submitted' %}66{% elif status_info.status == 'rejected' %}33{% else %}0{% endif %}%">
                    </div>
                </div>
            </div>
        </div>

        <!-- Registration Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Participant Info -->
            <div class="gradient-border rounded-lg p-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-user text-primary mr-2"></i>
                    Participant Details
                </h3>
                <div class="space-y-3 text-sm">
                    {% if registration.user %}
                        <div class="flex justify-between">
                            <span class="text-gray-400">Type:</span>
                            <span class="text-white">Solo Player</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Player:</span>
                            <span class="text-white">{{ registration.user.username }}</span>
                        </div>
                    {% else %}
                        <div class="flex justify-between">
                            <span class="text-gray-400">Type:</span>
                            <span class="text-white">Team</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Team:</span>
                            <span class="text-white">{{ registration.team.name }}</span>
                        </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-400">Registered:</span>
                        <span class="text-white">{{ registration.created_at|date:"M d, Y H:i" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Status:</span>
                        <span class="px-2 py-1 rounded text-xs font-bold
                            {% if registration.status == 'confirmed' %}bg-green-500/20 text-green-400
                            {% elif registration.status == 'payment_submitted' %}bg-yellow-500/20 text-yellow-400
                            {% elif registration.status == 'rejected' %}bg-red-500/20 text-red-400
                            {% else %}bg-gray-500/20 text-gray-400{% endif %}">
                            {{ registration.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Payment Info -->
            <div class="gradient-border rounded-lg p-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-credit-card text-primary mr-2"></i>
                    Payment Information
                </h3>
                {% if current_payment %}
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Method:</span>
                            <span class="text-white font-medium uppercase">{{ current_payment.payment_method }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Amount:</span>
                            <span class="text-white font-bold">à§³{{ current_payment.amount|floatformat:0 }}</span>
                        </div>
                        {% if current_payment.transaction_id %}
                            <div class="flex justify-between">
                                <span class="text-gray-400">Transaction ID:</span>
                                <span class="text-white font-mono text-xs">{{ current_payment.transaction_id }}</span>
                            </div>
                        {% endif %}
                        <div class="flex justify-between">
                            <span class="text-gray-400">Submitted:</span>
                            <span class="text-white">{{ current_payment.submitted_at|date:"M d, Y H:i" }}</span>
                        </div>
                        {% if current_payment.verified_at %}
                            <div class="flex justify-between">
                                <span class="text-gray-400">Verified:</span>
                                <span class="text-white">{{ current_payment.verified_at|date:"M d, Y H:i" }}</span>
                            </div>
                        {% endif %}
                        {% if current_payment.resubmission_count > 0 %}
                            <div class="flex justify-between">
                                <span class="text-gray-400">Resubmissions:</span>
                                <span class="text-yellow-400 font-medium">{{ current_payment.resubmission_count }}</span>
                            </div>
                        {% endif %}
                    </div>
                {% else %}
                    <p class="text-gray-400 text-sm">No payment submitted yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        {% if status_info.action %}
            <div class="mb-6">
                {% if status_info.action == 'submit_payment' %}
                    <a href="{% url 'tournaments:registration_wizard' tournament.slug %}?type=solo&step=3" 
                        class="block w-full py-4 bg-gradient-to-r from-primary to-secondary text-white text-center font-bold rounded-lg hover:opacity-90 transition-opacity">
                        <i class="fas fa-upload mr-2"></i>
                        Submit Payment
                    </a>
                {% elif status_info.action == 'resubmit_payment' %}
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3 mt-1"></i>
                            <div class="flex-1">
                                <p class="font-bold text-red-400 mb-2">Payment Rejected</p>
                                <p class="text-sm text-gray-300 mb-3">{{ status_info.message }}</p>
                                {% if current_payment.admin_notes %}
                                    <div class="bg-gray-800 rounded-lg p-3 text-sm text-gray-300 mb-3">
                                        <strong class="text-white">Organizer's Note:</strong><br>
                                        {{ current_payment.admin_notes }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <a href="{% url 'tournaments:payment_resubmit' tournament.slug registration.id %}" 
                        class="block w-full py-4 bg-gradient-to-r from-orange-600 to-orange-500 text-white text-center font-bold rounded-lg hover:opacity-90 transition-opacity">
                        <i class="fas fa-redo mr-2"></i>
                        Resubmit Payment
                    </a>
                {% endif %}
            </div>
        {% endif %}

        <!-- Payment Timeline -->
        {% if payment_history %}
            <div class="gradient-border rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-history text-primary mr-2"></i>
                    Payment History
                </h3>
                <div class="space-y-4">
                    {% for payment in payment_history %}
                        <div class="flex items-start">
                            <div class="flex-shrink-0 mr-4">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl
                                    {% if payment.status == 'verified' %}bg-green-500/20
                                    {% elif payment.status == 'rejected' %}bg-red-500/20
                                    {% elif payment.status == 'submitted' %}bg-yellow-500/20
                                    {% elif payment.status == 'refunded' %}bg-blue-500/20
                                    {% elif payment.status == 'waived' %}bg-yellow-500/20
                                    {% else %}bg-gray-500/20{% endif %}">
                                    {% if payment.status == 'verified' %}âœ…
                                    {% elif payment.status == 'rejected' %}âŒ
                                    {% elif payment.status == 'submitted' %}â³
                                    {% elif payment.status == 'refunded' %}â†©ï¸
                                    {% elif payment.status == 'waived' %}â­
                                    {% else %}ğŸ•{% endif %}
                                </div>
                            </div>
                            <div class="flex-1 bg-gray-800 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-bold text-white">{{ payment.get_status_display }}</h4>
                                    <span class="text-xs text-gray-400">{{ payment.submitted_at|date:"M d, Y H:i" }}</span>
                                </div>
                                <div class="text-sm text-gray-400 space-y-1">
                                    <div>Method: <span class="text-white uppercase">{{ payment.payment_method }}</span></div>
                                    <div>Amount: <span class="text-white">à§³{{ payment.amount|floatformat:0 }}</span></div>
                                    {% if payment.transaction_id %}
                                        <div>Transaction: <span class="text-white font-mono text-xs">{{ payment.transaction_id }}</span></div>
                                    {% endif %}
                                    {% if payment.admin_notes %}
                                        <div class="mt-2 pt-2 border-t border-gray-700">
                                            <strong class="text-gray-300">Note:</strong> {{ payment.admin_notes }}
                                        </div>
                                    {% endif %}
                                </div>
                                {% if payment.payment_proof %}
                                    <div class="mt-3">
                                        <a href="{% url 'tournaments:download_payment_proof' tournament.slug payment.id %}" 
                                            class="inline-flex items-center text-xs text-primary hover:text-secondary">
                                            <i class="fas fa-download mr-1"></i>
                                            Download Proof
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Help Section -->
        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-400 text-xl mr-3 mt-1"></i>
                <div class="text-sm text-gray-300">
                    <p class="font-bold text-blue-400 mb-2">Need Help?</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Payment verification usually takes 1-2 hours</li>
                        <li>Check your email for status updates</li>
                        <li>If payment is rejected, check the reason and resubmit</li>
                        <li>Contact organizers if you need assistance</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
