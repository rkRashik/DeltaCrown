{% extends "tournaments/base.html" %}
{% load static humanize %}

{% comment %}
Smart Registration â€” One-Click Flow
DeltaCrown Cinematic Dark Theme
Auto-fills everything, user confirms & registers.
{% endcomment %}

{% block title %}Register â€” {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_css %}
<style>
    :root {
        --game-color: {{ game_color|default:"#06b6d4" }};
        --game-color-rgb: {{ game_color_rgb|default:"6, 182, 212" }};
        --bg-deep: #060608;
        --bg-card: #0c0c10;
        --bg-elevated: #14141c;
        --text-primary: #f0f0f5;
        --text-secondary: #a0a0b8;
        --text-muted: #6b6b80;
        --border-subtle: rgba(255, 255, 255, 0.05);
        --border-hover: rgba(255, 255, 255, 0.12);
    }

    body { background: var(--bg-deep); color: var(--text-primary); }

    /* â”€â”€ Ambient Background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reg-ambient {
        position: fixed; inset: 0; pointer-events: none; z-index: 0;
        background:
            radial-gradient(ellipse 120% 80% at 80% -20%, rgba(var(--game-color-rgb), 0.04) 0%, transparent 60%),
            radial-gradient(ellipse 80% 60% at 10% 90%, rgba(99, 102, 241, 0.03) 0%, transparent 50%);
    }

    /* â”€â”€ Glass Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .smart-glass {
        background: rgba(12, 12, 18, 0.75);
        backdrop-filter: blur(20px) saturate(1.4);
        border: 1px solid var(--border-subtle);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255,255,255,0.03);
    }
    .smart-glass-strong {
        background: rgba(12, 12, 18, 0.92);
        backdrop-filter: blur(24px) saturate(1.5);
        border: 1px solid var(--border-subtle);
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255,255,255,0.04);
    }

    /* â”€â”€ Form Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .smart-input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-subtle);
        border-radius: 0.75rem;
        color: var(--text-primary);
        font-size: 0.875rem;
        line-height: 1.5;
        transition: all 0.2s;
        outline: none;
    }
    .smart-input::placeholder { color: var(--text-muted); }
    .smart-input:hover { border-color: var(--border-hover); }
    .smart-input:focus {
        border-color: rgba(var(--game-color-rgb), 0.5);
        box-shadow: 0 0 0 3px rgba(var(--game-color-rgb), 0.08);
        background: rgba(255, 255, 255, 0.05);
    }
    .smart-input.locked {
        background: rgba(255, 255, 255, 0.02);
        color: var(--text-secondary);
        cursor: not-allowed;
        border-color: rgba(16, 185, 129, 0.15);
    }
    .smart-input.needs-input {
        border-color: rgba(234, 179, 8, 0.25);
        background: rgba(234, 179, 8, 0.02);
    }
    .smart-input.needs-input:focus {
        border-color: rgba(234, 179, 8, 0.5);
        box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.08);
    }

    /* â”€â”€ Field Labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field-label {
        font-size: 0.6875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
    }

    /* â”€â”€ Section Headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-icon {
        width: 1.75rem; height: 1.75rem;
        border-radius: 0.5rem;
        display: flex; align-items: center; justify-content: center;
    }

    /* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge-verified {
        font-size: 0.5625rem; font-weight: 700;
        padding: 0.125rem 0.375rem;
        border-radius: 0.375rem;
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.15);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .badge-missing {
        font-size: 0.5625rem; font-weight: 700;
        padding: 0.125rem 0.375rem;
        border-radius: 0.375rem;
        background: rgba(234, 179, 8, 0.1);
        color: #eab308;
        border: 1px solid rgba(234, 179, 8, 0.15);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .badge-auto {
        font-size: 0.5rem; font-weight: 700;
        padding: 0.125rem 0.375rem;
        border-radius: 0.375rem;
        background: rgba(var(--game-color-rgb), 0.1);
        color: var(--game-color);
        border: 1px solid rgba(var(--game-color-rgb), 0.15);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-register {
        display: inline-flex;
        align-items: center; justify-content: center;
        gap: 0.625rem;
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, var(--game-color), rgba(var(--game-color-rgb), 0.8));
        color: #000;
        font-weight: 900;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        border-radius: 1rem;
        border: none;
        cursor: pointer;
        transition: all 0.25s;
        box-shadow: 0 4px 25px rgba(var(--game-color-rgb), 0.3);
        position: relative;
        overflow: hidden;
    }
    .btn-register::before {
        content: '';
        position: absolute; inset: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.5s;
    }
    .btn-register:hover::before { transform: translateX(100%); }
    .btn-register:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 40px rgba(var(--game-color-rgb), 0.4);
    }
    .btn-register:active { transform: scale(0.98); }
    .btn-register:disabled {
        opacity: 0.5; cursor: not-allowed;
        transform: none; box-shadow: none;
    }

    /* â”€â”€ Payment Radio Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pay-card {
        padding: 0.875rem;
        border-radius: 0.75rem;
        border: 1.5px solid var(--border-subtle);
        background: rgba(255, 255, 255, 0.02);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .pay-card:hover { border-color: var(--border-hover); }
    .pay-radio:checked + .pay-card {
        border-color: var(--game-color);
        background: rgba(var(--game-color-rgb), 0.06);
        box-shadow: 0 0 20px rgba(var(--game-color-rgb), 0.08);
    }

    /* â”€â”€ Upload Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .upload-zone {
        border: 2px dashed rgba(255,255,255,0.08);
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: rgba(var(--game-color-rgb), 0.3);
        background: rgba(var(--game-color-rgb), 0.02);
    }

    /* â”€â”€ Roster Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .roster-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.625rem;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        font-size: 0.75rem;
        color: var(--text-secondary);
    }
    .roster-chip .avatar-sm {
        width: 1.25rem; height: 1.25rem;
        border-radius: 50%;
        background: rgba(var(--game-color-rgb), 0.15);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.5rem; font-weight: 700;
        overflow: hidden;
    }

    /* â”€â”€ Readiness Ring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .readiness-ring {
        width: 5rem; height: 5rem;
        position: relative;
    }
    .readiness-ring svg { transform: rotate(-90deg); }
    .readiness-ring .ring-bg {
        fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 6;
    }
    .readiness-ring .ring-fill {
        fill: none; stroke-width: 6; stroke-linecap: round;
        transition: stroke-dashoffset 1s ease-out;
    }
    .readiness-value {
        position: absolute; inset: 0;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem; font-weight: 900;
    }

    /* â”€â”€ Checkbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .smart-checkbox {
        width: 1.125rem; height: 1.125rem;
        border-radius: 0.25rem;
        border: 1.5px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.03);
        accent-color: var(--game-color);
        cursor: pointer;
        flex-shrink: 0;
    }
    .smart-checkbox:checked { border-color: var(--game-color); }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(16px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fadeUp 0.5s ease-out forwards; }
    .fade-up-1 { animation-delay: 0.05s; opacity: 0; }
    .fade-up-2 { animation-delay: 0.1s; opacity: 0; }
    .fade-up-3 { animation-delay: 0.15s; opacity: 0; }
    .fade-up-4 { animation-delay: 0.2s; opacity: 0; }
    .fade-up-5 { animation-delay: 0.25s; opacity: 0; }
    .fade-up-6 { animation-delay: 0.3s; opacity: 0; }

    @keyframes shimmer {
        from { background-position: -200% 0; }
        to { background-position: 200% 0; }
    }

    /* â”€â”€ Success Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .success-overlay {
        position: fixed; inset: 0; z-index: 100;
        background: rgba(0,0,0,0.85);
        backdrop-filter: blur(20px);
        display: none;
        align-items: center; justify-content: center;
        flex-direction: column;
    }
    .success-overlay.active { display: flex; }
    @keyframes successPop {
        0% { transform: scale(0.5); opacity: 0; }
        60% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }
    .success-icon {
        width: 6rem; height: 6rem;
        border-radius: 50%;
        background: rgba(16, 185, 129, 0.15);
        border: 3px solid #10b981;
        display: flex; align-items: center; justify-content: center;
        animation: successPop 0.6s ease-out forwards;
        margin-bottom: 1.5rem;
    }
    @keyframes confettiDrop {
        0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .confetti-piece {
        position: fixed;
        width: 8px; height: 8px;
        top: -10px;
        animation: confettiDrop 3s ease-in forwards;
    }
</style>
{% endblock %}

{% block tournament_content %}
<div class="reg-ambient"></div>

<div class="max-w-2xl mx-auto px-4 sm:px-6 py-8 sm:py-12 relative z-10">

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    {# â”€â”€ Tournament Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="smart-glass rounded-2xl p-5 mb-6 fade-up">
        <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl overflow-hidden flex-shrink-0 border border-white/10" style="background: rgba(var(--game-color-rgb), 0.1);">
                {% if tournament.thumbnail_image %}
                <img src="{{ tournament.thumbnail_image.url }}" class="w-full h-full object-cover" alt="">
                {% elif tournament.game.logo %}
                <img src="{{ tournament.game.logo.url }}" class="w-full h-full object-cover" alt="">
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <i data-lucide="trophy" class="w-7 h-7" style="color: var(--game-color);"></i>
                </div>
                {% endif %}
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-base font-bold text-white truncate">{{ tournament.name }}</p>
                <p class="text-xs text-gray-500 mt-0.5">
                    {{ tournament.game.name|default:"Tournament" }}
                    <span class="mx-1 text-gray-700">&bull;</span>
                    {{ tournament.get_format_display|default:tournament.format }}
                    <span class="mx-1 text-gray-700">&bull;</span>
                    {{ tournament.tournament_start|date:"M d, Y" }}
                </p>
            </div>
            <div class="flex flex-col items-end gap-1.5 flex-shrink-0">
                <span class="text-[10px] px-2.5 py-1 rounded-lg font-bold uppercase tracking-wider"
                      style="background: rgba(var(--game-color-rgb), 0.1); color: var(--game-color); border: 1px solid rgba(var(--game-color-rgb), 0.15);">
                    {{ registration_type|upper }}
                </span>
                {% if tournament.total_registrations is not None %}
                <span class="text-[10px] text-gray-500 font-mono">
                    {{ tournament.total_registrations }}/{{ tournament.max_participants }} slots
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    {# â”€â”€ Readiness Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="smart-glass rounded-2xl p-5 mb-6 fade-up fade-up-1">
        <div class="flex items-center gap-5">
            <div class="readiness-ring flex-shrink-0">
                <svg viewBox="0 0 80 80" width="80" height="80">
                    <circle cx="40" cy="40" r="34" class="ring-bg"/>
                    <circle cx="40" cy="40" r="34" class="ring-fill"
                            style="stroke: {% if readiness >= 80 %}#10b981{% elif readiness >= 50 %}#eab308{% else %}#ef4444{% endif %};
                                   stroke-dasharray: {{ circumference }};
                                   stroke-dashoffset: {{ dash_offset }};" />
                </svg>
                <div class="readiness-value {% if readiness >= 80 %}text-emerald-400{% elif readiness >= 50 %}text-amber-400{% else %}text-red-400{% endif %}">
                    {{ readiness }}%
                </div>
            </div>
            <div class="flex-1">
                <h3 class="text-sm font-bold text-white mb-1">
                    {% if readiness == 100 %}
                    <i data-lucide="check-circle" class="w-4 h-4 inline text-emerald-400 mr-1"></i>
                    Ready to Register
                    {% elif readiness >= 80 %}
                    Almost Ready
                    {% else %}
                    Complete Your Info
                    {% endif %}
                </h3>
                <p class="text-xs text-gray-500">
                    {% if missing_count > 0 %}
                    {{ filled_count }} of {{ total_fields }} fields auto-filled &middot;
                    <span class="text-amber-400/80">{{ missing_count }} need{{ missing_count|pluralize:"s," }} your input</span>
                    {% else %}
                    All {{ total_fields }} fields auto-filled from your profile
                    <span class="text-emerald-400/80">&middot; One-click registration ready</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    {# â”€â”€ REGISTRATION FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <form method="post" id="smart-reg-form" enctype="multipart/form-data" class="space-y-5">
        {% csrf_token %}
        <input type="hidden" name="registration_type" value="{{ registration_type }}">

        {# â”€â”€ Section: Player Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-2">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon" style="background: rgba(var(--game-color-rgb), 0.1);">
                    <i data-lucide="user" class="w-3.5 h-3.5" style="color: var(--game-color);"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Player Identity</h3>
                {% if identity_complete %}<span class="badge-verified ml-auto"><i data-lucide="check" class="w-2.5 h-2.5 inline -mt-px"></i> Complete</span>{% endif %}
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {# Full Name #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Full Name</label>
                            {% if fields.full_name.locked %}<span class="badge-auto"><i data-lucide="lock" class="w-2 h-2 inline -mt-px"></i> Profile</span>
                            {% elif fields.full_name.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Required</span>{% endif %}
                        </div>
                        <input type="text" name="full_name" value="{{ fields.full_name.value|default:'' }}"
                               class="smart-input {% if fields.full_name.locked %}locked{% elif not fields.full_name.value %}needs-input{% endif %}"
                               {% if fields.full_name.locked %}readonly{% endif %}
                               placeholder="Your full name" required>
                    </div>

                    {# Display Name / Username #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Display Name</label>
                            <span class="badge-auto"><i data-lucide="lock" class="w-2 h-2 inline -mt-px"></i> Username</span>
                        </div>
                        <input type="text" name="display_name" value="{{ fields.display_name.value|default:'' }}"
                               class="smart-input locked" readonly
                               placeholder="Username">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {# Email #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Email</label>
                            <span class="badge-auto"><i data-lucide="lock" class="w-2 h-2 inline -mt-px"></i> Verified</span>
                        </div>
                        <input type="email" name="email" value="{{ fields.email.value|default:'' }}"
                               class="smart-input locked" readonly>
                    </div>

                    {# Phone #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Phone</label>
                            {% if fields.phone.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Optional</span>{% endif %}
                        </div>
                        <input type="tel" name="phone" value="{{ fields.phone.value|default:'' }}"
                               class="smart-input {% if not fields.phone.value %}needs-input{% endif %}"
                               placeholder="+880 1XXXXXXXXX">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {# Discord #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Discord</label>
                            {% if fields.discord.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Optional</span>{% endif %}
                        </div>
                        <input type="text" name="discord" value="{{ fields.discord.value|default:'' }}"
                               class="smart-input {% if not fields.discord.value %}needs-input{% endif %}"
                               placeholder="username">
                    </div>

                    {# Country #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Country</label>
                            {% if fields.country.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Optional</span>{% endif %}
                        </div>
                        <input type="text" name="country" value="{{ fields.country.value|default:'' }}"
                               class="smart-input {% if not fields.country.value %}needs-input{% endif %}"
                               placeholder="Country">
                    </div>
                </div>
            </div>
        </div>

        {# â”€â”€ Section: Game Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-3">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-indigo-500/10">
                    <i data-lucide="gamepad-2" class="w-3.5 h-3.5 text-indigo-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Game Profile</h3>
                {% if game_complete %}<span class="badge-verified ml-auto"><i data-lucide="check" class="w-2.5 h-2.5 inline -mt-px"></i> Complete</span>{% endif %}
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {# Game ID / IGN #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">{{ game_id_label|default:"Game ID" }} <span class="text-red-400/60">*</span></label>
                            {% if fields.game_id.locked %}<span class="badge-auto"><i data-lucide="lock" class="w-2 h-2 inline -mt-px"></i> Passport</span>
                            {% elif fields.game_id.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Required</span>{% endif %}
                        </div>
                        <input type="text" name="game_id" value="{{ fields.game_id.value|default:'' }}"
                               class="smart-input {% if fields.game_id.locked %}locked{% elif not fields.game_id.value %}needs-input{% endif %}"
                               {% if fields.game_id.locked %}readonly{% endif %}
                               placeholder="{{ game_id_placeholder|default:'Your in-game ID' }}" required>
                    </div>

                    {# Platform / Server #}
                    <div>
                        <div class="flex items-center gap-2 mb-1.5">
                            <label class="field-label">Platform / Server</label>
                            {% if fields.platform_server.value %}<span class="badge-auto">Auto-filled</span>
                            {% else %}<span class="badge-missing">Optional</span>{% endif %}
                        </div>
                        <input type="text" name="platform_server" value="{{ fields.platform_server.value|default:'' }}"
                               class="smart-input {% if not fields.platform_server.value %}needs-input{% endif %}"
                               placeholder="e.g., Asia, SEA, PC">
                    </div>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-1.5">
                        <label class="field-label">Rank</label>
                        {% if fields.rank.value %}<span class="badge-auto">Auto-filled</span>{% endif %}
                    </div>
                    <input type="text" name="rank" value="{{ fields.rank.value|default:'' }}"
                           class="smart-input {% if fields.rank.locked %}locked{% endif %}"
                           {% if fields.rank.locked %}readonly{% endif %}
                           placeholder="e.g., Diamond, Global Elite, Conqueror">
                </div>
            </div>
        </div>

        {# â”€â”€ Section: Team Info (Team tournaments) â”€â”€ #}
        {% if registration_type == 'team' %}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-3">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-purple-500/10">
                    <i data-lucide="shield" class="w-3.5 h-3.5 text-purple-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Team</h3>
                {% if team %}<span class="badge-verified ml-auto"><i data-lucide="check" class="w-2.5 h-2.5 inline -mt-px"></i> Selected</span>{% endif %}
            </div>

            {% if team %}
            <input type="hidden" name="team_id" value="{{ team.id }}">

            {# Team Identity Card #}
            <div class="flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/6 mb-4">
                <div class="w-12 h-12 rounded-xl overflow-hidden border border-white/10 flex-shrink-0 bg-purple-500/10 flex items-center justify-center">
                    {% if team.logo %}<img src="{{ team.logo.url }}" class="w-full h-full object-cover" alt="">
                    {% else %}<span class="text-sm font-bold text-purple-400">{{ team.tag|default:team.name|slice:":2"|upper }}</span>{% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate">{{ team.name }}</p>
                    <p class="text-[10px] text-gray-500">[{{ team.tag|upper }}] &middot; {{ team.members.count }} members</p>
                </div>
                <span class="badge-auto"><i data-lucide="lock" class="w-2 h-2 inline -mt-px"></i> Locked</span>
            </div>

            {# Roster Preview #}
            {% if roster_members %}
            <div class="mt-3">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Active Roster</p>
                <div class="flex flex-wrap gap-1.5">
                    {% for m in roster_members %}
                    <span class="roster-chip">
                        <span class="avatar-sm">
                            {% if m.user.profile.avatar %}<img src="{{ m.user.profile.avatar.url }}" class="w-full h-full object-cover rounded-full" alt="" onerror="this.onerror=null;this.replaceWith('{{ m.user.username|slice:':1'|upper|escapejs }}')">
                            {% else %}{{ m.user.username|slice:":1"|upper }}{% endif %}
                        </span>
                        {{ m.display_name|default:m.user.username }}
                        {% if m.is_tournament_captain %}<span class="text-[8px]">â­</span>{% endif %}
                        {% if m.role == 'OWNER' %}<span class="text-[8px]">ğŸ‘‘</span>{% endif %}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% else %}
            {# Team Selection #}
            {% if user_teams %}
            <div class="space-y-2">
                <p class="text-xs text-gray-500 mb-3">Select a team to register:</p>
                {% for t in user_teams %}
                <label class="flex items-center gap-3 p-3.5 rounded-xl border border-white/6 bg-white/[0.02] cursor-pointer hover:border-white/12 hover:bg-white/[0.04] transition">
                    <input type="radio" name="team_id" value="{{ t.id }}" class="smart-checkbox"
                           {% if forloop.first %}checked{% endif %}>
                    <div class="w-9 h-9 rounded-lg overflow-hidden border border-white/10 flex-shrink-0 bg-purple-500/10 flex items-center justify-center">
                        {% if t.logo %}<img src="{{ t.logo.url }}" class="w-full h-full object-cover" alt="">
                        {% else %}<span class="text-xs font-bold text-purple-400">{{ t.tag|default:t.name|slice:":2"|upper }}</span>{% endif %}
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-white truncate">{{ t.name }}</p>
                        <p class="text-[10px] text-gray-500">[{{ t.tag|upper }}]</p>
                    </div>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-6">
                <i data-lucide="users" class="w-8 h-8 text-gray-600 mx-auto mb-3"></i>
                <p class="text-sm text-gray-400 mb-1">No teams available</p>
                <p class="text-xs text-gray-600">Join or create a team to register for team tournaments.</p>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}

        {# â”€â”€ Section: Contact Preference â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-4">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-sky-500/10">
                    <i data-lucide="message-square" class="w-3.5 h-3.5 text-sky-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Contact Preference</h3>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <label class="block">
                    <input type="radio" name="preferred_contact" value="discord" class="pay-radio sr-only"
                           {% if fields.preferred_contact.value == 'discord' or not fields.preferred_contact.value %}checked{% endif %}>
                    <div class="pay-card flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 text-indigo-400" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z"/></svg>
                        <span class="text-xs font-semibold text-white/70">Discord</span>
                    </div>
                </label>
                <label class="block">
                    <input type="radio" name="preferred_contact" value="email" class="pay-radio sr-only"
                           {% if fields.preferred_contact.value == 'email' %}checked{% endif %}>
                    <div class="pay-card flex items-center justify-center gap-2">
                        <i data-lucide="mail" class="w-4 h-4 text-cyan-400"></i>
                        <span class="text-xs font-semibold text-white/70">Email</span>
                    </div>
                </label>
                <label class="block">
                    <input type="radio" name="preferred_contact" value="phone" class="pay-radio sr-only"
                           {% if fields.preferred_contact.value == 'phone' %}checked{% endif %}>
                    <div class="pay-card flex items-center justify-center gap-2">
                        <i data-lucide="phone" class="w-4 h-4 text-emerald-400"></i>
                        <span class="text-xs font-semibold text-white/70">Phone</span>
                    </div>
                </label>
            </div>
        </div>

        {# â”€â”€ Section: Tournament Info (Summary) â”€â”€ #}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-4">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-amber-500/10">
                    <i data-lucide="trophy" class="w-3.5 h-3.5 text-amber-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Tournament Details</h3>
            </div>
            <dl class="space-y-0 text-sm">
                <div class="flex justify-between py-2.5 border-b border-white/5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="gamepad-2" class="w-3 h-3"></i> Game</dt>
                    <dd class="text-white font-semibold">{{ tournament.game.name|default:"TBA" }}</dd>
                </div>
                <div class="flex justify-between py-2.5 border-b border-white/5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="layout-grid" class="w-3 h-3"></i> Format</dt>
                    <dd class="text-white">{{ tournament.get_format_display|default:tournament.format }}</dd>
                </div>
                <div class="flex justify-between py-2.5 border-b border-white/5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="calendar" class="w-3 h-3"></i> Starts</dt>
                    <dd class="text-white">{{ tournament.tournament_start|date:"M d, Y â€” h:i A" }}</dd>
                </div>
                <div class="flex justify-between py-2.5 border-b border-white/5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="users" class="w-3 h-3"></i> Capacity</dt>
                    <dd class="text-white font-mono">{{ tournament.total_registrations }}/{{ tournament.max_participants }}</dd>
                </div>
                {% if tournament.prize_pool %}
                <div class="flex justify-between py-2.5 border-b border-white/5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="gift" class="w-3 h-3"></i> Prize Pool</dt>
                    <dd class="text-emerald-400 font-bold">à§³{{ tournament.prize_pool|intcomma }}</dd>
                </div>
                {% endif %}
                <div class="flex justify-between py-2.5">
                    <dt class="text-gray-500 flex items-center gap-1.5"><i data-lucide="banknote" class="w-3 h-3"></i> Entry Fee</dt>
                    <dd class="{% if tournament.has_entry_fee %}text-amber-400 font-bold{% else %}text-emerald-400{% endif %}">
                        {% if tournament.has_entry_fee %}
                        à§³{{ tournament.entry_fee_amount|intcomma }}
                        {% else %}
                        FREE
                        {% endif %}
                    </dd>
                </div>
            </dl>
        </div>

        {# â”€â”€ Section: Payment (only if entry fee) â”€â”€ #}
        {% if tournament.has_entry_fee %}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-5">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-emerald-500/10">
                    <i data-lucide="wallet" class="w-3.5 h-3.5 text-emerald-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Payment</h3>
                <span class="ml-auto text-sm font-bold text-amber-400">à§³{{ tournament.entry_fee_amount|intcomma }}</span>
            </div>

            {# Payment Method Selection #}
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-5">
                {% if deltacoin_can_afford %}
                <label class="block">
                    <input type="radio" name="payment_method" value="deltacoin" class="pay-radio sr-only" checked>
                    <div class="pay-card">
                        <span class="text-lg">ğŸ’°</span>
                        <p class="text-[10px] font-bold text-white/70 mt-1">DeltaCoin</p>
                        <p class="text-[9px] text-emerald-400/70 font-mono">{{ deltacoin_balance }} DC</p>
                    </div>
                </label>
                {% endif %}
                <label class="block">
                    <input type="radio" name="payment_method" value="bkash" class="pay-radio sr-only"
                           {% if not deltacoin_can_afford %}checked{% endif %}>
                    <div class="pay-card">
                        <span class="text-lg">ğŸ“±</span>
                        <p class="text-[10px] font-bold text-white/70 mt-1">bKash</p>
                    </div>
                </label>
                <label class="block">
                    <input type="radio" name="payment_method" value="nagad" class="pay-radio sr-only">
                    <div class="pay-card">
                        <span class="text-lg">ğŸ“²</span>
                        <p class="text-[10px] font-bold text-white/70 mt-1">Nagad</p>
                    </div>
                </label>
                <label class="block">
                    <input type="radio" name="payment_method" value="rocket" class="pay-radio sr-only">
                    <div class="pay-card">
                        <span class="text-lg">ğŸš€</span>
                        <p class="text-[10px] font-bold text-white/70 mt-1">Rocket</p>
                    </div>
                </label>
            </div>

            {# Cash Payment Fields (shown dynamically) #}
            <div id="cash-payment-fields" class="space-y-4 {% if deltacoin_can_afford %}hidden{% endif %}">
                <div>
                    <label class="field-label block mb-1.5">Transaction ID <span class="text-red-400/60">*</span></label>
                    <input type="text" name="transaction_id" class="smart-input" placeholder="Enter transaction/reference ID">
                </div>
                <div>
                    <label class="field-label block mb-1.5">Payment Screenshot <span class="text-red-400/60">*</span></label>
                    <label class="upload-zone block cursor-pointer" id="upload-zone">
                        <input type="file" name="payment_proof" accept=".jpg,.jpeg,.png,.pdf" class="sr-only" id="file-input">
                        <div id="upload-placeholder">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-600 mx-auto mb-2"></i>
                            <p class="text-xs text-gray-400 mb-1">Drag & drop or click to upload</p>
                            <p class="text-[10px] text-gray-600">JPG, PNG or PDF &middot; Max 5MB</p>
                        </div>
                        <div id="upload-preview" class="hidden">
                            <i data-lucide="file-image" class="w-8 h-8 text-emerald-400 mx-auto mb-2"></i>
                            <p class="text-xs text-emerald-400 font-semibold" id="file-name"></p>
                            <p class="text-[10px] text-gray-500" id="file-size"></p>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        {% endif %}

        {# â”€â”€ Section: Terms & Agreement â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="smart-glass-strong rounded-2xl p-6 fade-up fade-up-5">
            <div class="flex items-center gap-2 mb-5">
                <div class="section-icon bg-rose-500/10">
                    <i data-lucide="file-text" class="w-3.5 h-3.5 text-rose-400"></i>
                </div>
                <h3 class="text-sm font-bold text-white">Terms & Agreement</h3>
            </div>

            {% if tournament.terms_and_conditions %}
            <div class="mb-4 p-4 rounded-xl bg-white/[0.02] border border-white/5 max-h-32 overflow-y-auto">
                <p class="text-xs text-gray-400 leading-relaxed">{{ tournament.terms_and_conditions|linebreaksbr }}</p>
            </div>
            {% endif %}

            <div class="space-y-3">
                <label class="flex items-start gap-3 cursor-pointer group">
                    <input type="checkbox" name="accept_terms" class="smart-checkbox mt-0.5" id="cb-terms" required>
                    <span class="text-xs text-gray-400 group-hover:text-gray-300 transition">
                        I accept the <a href="#" class="underline" style="color: var(--game-color);">tournament rules</a> and
                        <a href="#" class="underline" style="color: var(--game-color);">DeltaCrown Terms of Service</a>
                    </span>
                </label>
                <label class="flex items-start gap-3 cursor-pointer group">
                    <input type="checkbox" name="accept_data" class="smart-checkbox mt-0.5" id="cb-data" required>
                    <span class="text-xs text-gray-400 group-hover:text-gray-300 transition">
                        I consent to share my in-game stats and registration data for tournament operations
                    </span>
                </label>
                {% if registration_type == 'team' %}
                <label class="flex items-start gap-3 cursor-pointer group">
                    <input type="checkbox" name="accept_roster" class="smart-checkbox mt-0.5" id="cb-roster" required>
                    <span class="text-xs text-gray-400 group-hover:text-gray-300 transition">
                        I confirm I am authorized to register this team and all roster members are available
                    </span>
                </label>
                {% endif %}
            </div>
        </div>

        {# â”€â”€ Submit Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
        <div class="fade-up fade-up-6">
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="p-3 rounded-xl text-xs font-semibold
                    {% if message.tags == 'error' %}bg-red-500/10 border border-red-500/20 text-red-400
                    {% elif message.tags == 'success' %}bg-emerald-500/10 border border-emerald-500/20 text-emerald-400
                    {% else %}bg-amber-500/10 border border-amber-500/20 text-amber-400{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <button type="submit" class="btn-register" id="submit-btn" disabled>
                <i data-lucide="zap" class="w-5 h-5"></i>
                {% if tournament.has_entry_fee %}
                Register &amp; Pay à§³{{ tournament.entry_fee_amount|intcomma }}
                {% else %}
                Register Now
                {% endif %}
            </button>

            <p class="text-center text-[10px] text-gray-600 mt-3">
                By registering you agree to DeltaCrown's community guidelines.
                {% if tournament.enable_check_in %}
                <br>Check-in opens {{ tournament.check_in_minutes_before }} minutes before the match.
                {% endif %}
            </p>
        </div>
    </form>

</div>

{# â”€â”€ Success Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="success-overlay" id="success-overlay">
    <div class="success-icon">
        <i data-lucide="check" class="w-10 h-10 text-emerald-400"></i>
    </div>
    <h2 class="text-2xl font-black text-white mb-2" style="animation: fadeUp 0.5s ease-out 0.3s both;">Registration Complete!</h2>
    <p class="text-sm text-gray-400 mb-6" style="animation: fadeUp 0.5s ease-out 0.4s both;">You're in. Good luck, competitor.</p>
    <a href="#" id="success-link" class="btn-register inline-flex !w-auto" style="animation: fadeUp 0.5s ease-out 0.5s both;">
        <i data-lucide="arrow-right" class="w-4 h-4"></i> View My Tournament
    </a>
</div>
{% endblock %}

{% block tournament_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') lucide.createIcons();

    // â”€â”€ Enable submit when all checkboxes checked â”€â”€
    const submitBtn = document.getElementById('submit-btn');
    const checkboxes = document.querySelectorAll('.smart-checkbox[required]');

    function updateSubmit() {
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        submitBtn.disabled = !allChecked;
    }
    checkboxes.forEach(cb => cb.addEventListener('change', updateSubmit));
    updateSubmit();

    // â”€â”€ Payment method toggle (show/hide cash fields) â”€â”€
    const cashFields = document.getElementById('cash-payment-fields');
    if (cashFields) {
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'deltacoin') {
                    cashFields.classList.add('hidden');
                } else {
                    cashFields.classList.remove('hidden');
                }
            });
        });
    }

    // â”€â”€ File upload preview â”€â”€
    const fileInput = document.getElementById('file-input');
    const uploadZone = document.getElementById('upload-zone');
    if (fileInput && uploadZone) {
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                const file = this.files[0];
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('upload-preview').classList.remove('hidden');
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            }
        });

        // Drag & drop
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    }

    // â”€â”€ Form submission with loading state â”€â”€
    const form = document.getElementById('smart-reg-form');
    form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" stroke-dasharray="30 70" stroke-linecap="round"/></svg> Processing...';
    });
});
</script>
{% endblock %}
