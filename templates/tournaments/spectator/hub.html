{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Spectator Hub — FE-T-006
   Context: tournament, active_tab, bracket, has_bracket,
            groups, has_groups, standings, game_columns,
            recent_matches, upcoming_matches,
            total_matches, completed_matches, live_matches
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Spectate — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">

  {# ── Tournament Header ── #}
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition mb-2 inline-block">
        <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> {{ tournament.name }}
      </a>
      <h1 class="text-2xl sm:text-3xl font-display font-bold text-white">
        <i data-lucide="eye" class="w-6 h-6 inline mr-2 text-dc-cyan"></i> Spectator View
      </h1>
    </div>
    <div class="flex items-center gap-3">
      {% if live_matches > 0 %}
        <span class="px-3 py-1 text-xs rounded-full bg-red-900/40 text-red-400 border border-red-700/30 animate-pulse">
          <i data-lucide="radio" class="w-3 h-3 inline mr-1"></i> {{ live_matches }} Live
        </span>
      {% endif %}
      <span class="px-3 py-1 text-xs text-gray-400 bg-white/5 rounded-full border border-dc-border">
        {{ completed_matches }}/{{ total_matches }} Matches
      </span>
    </div>
  </div>

  {# ── Tab Navigation ── #}
  <div class="flex gap-1 mb-6 overflow-x-auto pb-1 -mx-4 px-4 sm:mx-0 sm:px-0">
    {% with tabs="bracket,standings,matches" %}
      {% for tab_name in tabs|make_list %}{% endfor %}
    {% endwith %}
    <a href="?tab=bracket"
       class="px-4 py-2 text-sm rounded-lg whitespace-nowrap transition
         {% if active_tab == 'bracket' %}bg-dc-cyan/10 text-dc-cyan border border-dc-cyan/30{% else %}text-gray-400 hover:bg-white/5{% endif %}">
      <i data-lucide="git-branch" class="w-3.5 h-3.5 inline mr-1"></i> Bracket
    </a>
    {% if has_groups %}
      <a href="?tab=groups"
         class="px-4 py-2 text-sm rounded-lg whitespace-nowrap transition
           {% if active_tab == 'groups' %}bg-dc-purple/10 text-dc-purple border border-dc-purple/30{% else %}text-gray-400 hover:bg-white/5{% endif %}">
        <i data-lucide="layout-grid" class="w-3.5 h-3.5 inline mr-1"></i> Groups
      </a>
    {% endif %}
    <a href="?tab=standings"
       class="px-4 py-2 text-sm rounded-lg whitespace-nowrap transition
         {% if active_tab == 'standings' %}bg-dc-gold/10 text-dc-gold border border-dc-gold/30{% else %}text-gray-400 hover:bg-white/5{% endif %}">
      <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 inline mr-1"></i> Standings
    </a>
    <a href="?tab=matches"
       class="px-4 py-2 text-sm rounded-lg whitespace-nowrap transition
         {% if active_tab == 'matches' %}bg-white/10 text-white border border-white/10{% else %}text-gray-400 hover:bg-white/5{% endif %}">
      <i data-lucide="swords" class="w-3.5 h-3.5 inline mr-1"></i> Matches
    </a>
  </div>

  {# Tab: Bracket #}
  {% if active_tab == 'bracket' %}
    {% if has_bracket and bracket %}
      <div class="glass rounded-xl p-6">
        <h3 class="text-sm font-display font-semibold text-white mb-4">
          <i data-lucide="git-branch" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Live Bracket
        </h3>
        <p class="text-sm text-gray-400 mb-4">
          View the full interactive bracket for detailed match information.
        </p>
        <a href="{% url 'tournaments:bracket' tournament.slug %}"
           class="inline-flex items-center px-5 py-2.5 bg-dc-cyan/10 text-dc-cyan text-sm rounded-xl border border-dc-cyan/30 hover:bg-dc-cyan/20 transition">
          <i data-lucide="external-link" class="w-4 h-4 mr-2"></i> Open Full Bracket
        </a>
      </div>
    {% else %}
      <div class="glass rounded-xl p-12 text-center">
        <i data-lucide="git-branch" class="w-12 h-12 text-gray-600 mx-auto mb-3"></i>
        <p class="text-sm text-gray-400">Bracket is being prepared</p>
      </div>
    {% endif %}

  {# Tab: Groups #}
  {% elif active_tab == 'groups' and has_groups %}
    {% for group in groups %}
      <div class="glass rounded-xl overflow-hidden mb-4">
        <div class="px-6 py-3 border-b border-dc-border bg-white/[0.02]">
          <h3 class="text-sm font-display font-semibold text-white">{{ group.name }}</h3>
        </div>
        {% if group.standings.all %}
          <div class="divide-y divide-dc-border">
            {% for standing in group.standings.all %}
              <div class="flex items-center justify-between px-6 py-2.5 hover:bg-white/[0.02] transition">
                <div class="flex items-center gap-3">
                  <span class="w-6 h-6 rounded-full bg-dc-surface flex items-center justify-center text-xs font-mono
                    {% if standing.rank <= 2 %}text-green-400{% else %}text-gray-500{% endif %}">
                    {{ standing.rank|default:forloop.counter }}
                  </span>
                  <span class="text-sm text-white">
                    {% if standing.team %}{{ standing.team.name }}{% elif standing.user %}{{ standing.user.username }}{% else %}—{% endif %}
                  </span>
                </div>
                <span class="text-sm font-mono text-dc-gold">{{ standing.points|default:0 }} pts</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="px-6 py-6 text-center">
            <p class="text-xs text-gray-600">No standings yet</p>
          </div>
        {% endif %}
      </div>
    {% endfor %}

  {# Tab: Standings #}
  {% elif active_tab == 'standings' %}
    {% if standings %}
      <div class="glass rounded-xl overflow-hidden">
        <div class="divide-y divide-dc-border">
          {% for entry in standings %}
            <div class="flex items-center justify-between px-6 py-3 hover:bg-white/[0.02] transition">
              <div class="flex items-center gap-3">
                <span class="w-7 h-7 rounded-full bg-dc-surface flex items-center justify-center text-xs font-mono
                  {% if forloop.counter == 1 %}text-dc-gold{% elif forloop.counter == 2 %}text-gray-400{% elif forloop.counter == 3 %}text-amber-600{% else %}text-gray-500{% endif %}">
                  {{ forloop.counter }}
                </span>
                <span class="text-sm text-white">
                  {% if entry.team %}{{ entry.team.name }}{% elif entry.user %}{{ entry.user.username }}{% else %}—{% endif %}
                </span>
              </div>
              <div class="flex items-center gap-4 text-sm">
                <span class="text-green-400 hidden sm:inline">{{ entry.wins|default:0 }}W</span>
                <span class="text-red-400 hidden sm:inline">{{ entry.losses|default:0 }}L</span>
                <span class="font-mono text-dc-gold font-bold">{{ entry.points|default:0 }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <div class="glass rounded-xl p-12 text-center">
        <i data-lucide="bar-chart-3" class="w-12 h-12 text-gray-600 mx-auto mb-3"></i>
        <p class="text-sm text-gray-400">Standings will populate as matches complete</p>
      </div>
    {% endif %}

  {# Tab: Matches #}
  {% elif active_tab == 'matches' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      {# Upcoming #}
      <div class="glass rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-dc-border">
          <h3 class="text-sm font-display font-semibold text-white">
            <i data-lucide="clock" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Upcoming
          </h3>
        </div>
        {% if upcoming_matches %}
          <div class="divide-y divide-dc-border">
            {% for match in upcoming_matches %}
              <div class="px-6 py-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-white">
                    {% if match.participant1 %}{{ match.participant1.user.username|default:"TBD" }}{% else %}TBD{% endif %}
                    <span class="text-gray-600 mx-1">vs</span>
                    {% if match.participant2 %}{{ match.participant2.user.username|default:"TBD" }}{% else %}TBD{% endif %}
                  </span>
                </div>
                {% if match.scheduled_time %}
                  <p class="text-[10px] text-gray-500 mt-0.5">{{ match.scheduled_time|date:"M d, g:i A" }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="px-6 py-8 text-center">
            <p class="text-xs text-gray-600">No upcoming matches</p>
          </div>
        {% endif %}
      </div>

      {# Recent Results #}
      <div class="glass rounded-xl overflow-hidden">
        <div class="px-6 py-4 border-b border-dc-border">
          <h3 class="text-sm font-display font-semibold text-white">
            <i data-lucide="check-circle" class="w-4 h-4 inline mr-1 text-green-400"></i> Recent Results
          </h3>
        </div>
        {% if recent_matches %}
          <div class="divide-y divide-dc-border">
            {% for match in recent_matches %}
              <div class="px-6 py-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-white">
                    {% if match.participant1 %}{{ match.participant1.user.username|default:"TBD" }}{% else %}TBD{% endif %}
                    <span class="text-gray-600 mx-1">vs</span>
                    {% if match.participant2 %}{{ match.participant2.user.username|default:"TBD" }}{% else %}TBD{% endif %}
                  </span>
                  <span class="text-sm font-mono text-gray-400">
                    {{ match.participant1_score|default:"—" }} - {{ match.participant2_score|default:"—" }}
                  </span>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="px-6 py-8 text-center">
            <p class="text-xs text-gray-600">No completed matches yet</p>
          </div>
        {% endif %}
      </div>

    </div>
  {% endif %}

</div>

{% endblock %}
