{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Match Detail — FE-T-009
   Context: match, tournament, participant1, participant2,
            is_participant, show_lobby_info, timeline
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Match #{{ match.match_number }} — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-4xl mx-auto px-4 sm:px-6 py-8">

  {# ── Breadcrumb ── #}
  <div class="mb-6">
    <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition">
      <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> {{ tournament.name }}
    </a>
    <span class="text-gray-700 mx-1">›</span>
    <a href="{% url 'tournaments:bracket' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition">Bracket</a>
    <span class="text-gray-700 mx-1">›</span>
    <span class="text-xs text-gray-400">Match #{{ match.match_number }}</span>
  </div>

  {# ── Match Header ── #}
  <div class="glass rounded-xl p-8 mb-6
    {% if match.state == 'live' %}neon-border-cyan{% elif match.state == 'completed' %}neon-border-gold{% endif %}">

    {# Round Label #}
    <div class="text-center mb-6">
      <span class="text-xs uppercase tracking-widest text-gray-500">
        {% if match.round_name %}{{ match.round_name }}{% else %}Round {{ match.round_number }}{% endif %}
        · Match {{ match.match_number }}
      </span>
      {% if match.state == 'live' %}
        <div class="mt-2">
          <span class="px-3 py-1 text-xs rounded-full bg-red-900/40 text-red-400 border border-red-700/30 animate-pulse">
            <i data-lucide="radio" class="w-3 h-3 inline mr-1"></i> LIVE
          </span>
        </div>
      {% endif %}
    </div>

    {# ── VS Display ── #}
    <div class="grid grid-cols-3 items-center gap-4">
      {# Participant 1 #}
      <div class="text-center">
        <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 rounded-full bg-dc-surface border-2
          {% if match.winner_id and participant1 and match.winner_id == participant1.id %}border-dc-gold{% else %}border-dc-border{% endif %}
          flex items-center justify-center">
          {% if participant1 %}
            <span class="text-xl sm:text-2xl font-display font-bold text-white">{{ participant1.username|truncatechars:2|upper }}</span>
          {% else %}
            <i data-lucide="user" class="w-8 h-8 text-gray-600"></i>
          {% endif %}
        </div>
        <p class="text-sm font-display font-bold text-white truncate">
          {{ participant1.username|default:"TBD" }}
        </p>
        {% if match.winner_id and participant1 and match.winner_id == participant1.id %}
          <span class="text-[10px] text-dc-gold"><i data-lucide="trophy" class="w-3 h-3 inline"></i> Winner</span>
        {% endif %}
      </div>

      {# Score / VS #}
      <div class="text-center">
        {% if match.participant1_score is not None and match.participant2_score is not None %}
          <div class="flex items-center justify-center gap-3">
            <span class="text-3xl sm:text-4xl font-display font-bold
              {% if match.winner_id and participant1 and match.winner_id == participant1.id %}text-dc-gold{% else %}text-white{% endif %}">
              {{ match.participant1_score }}
            </span>
            <span class="text-lg text-gray-600">:</span>
            <span class="text-3xl sm:text-4xl font-display font-bold
              {% if match.winner_id and participant2 and match.winner_id == participant2.id %}text-dc-gold{% else %}text-white{% endif %}">
              {{ match.participant2_score }}
            </span>
          </div>
        {% else %}
          <span class="text-2xl font-display font-bold text-gray-600">VS</span>
        {% endif %}
        {% if match.state == 'completed' %}
          <p class="text-[10px] text-gray-500 mt-1">Final</p>
        {% elif match.scheduled_time %}
          <p class="text-[10px] text-gray-500 mt-1">{{ match.scheduled_time|date:"M d, g:i A" }}</p>
        {% endif %}
      </div>

      {# Participant 2 #}
      <div class="text-center">
        <div class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 rounded-full bg-dc-surface border-2
          {% if match.winner_id and participant2 and match.winner_id == participant2.id %}border-dc-gold{% else %}border-dc-border{% endif %}
          flex items-center justify-center">
          {% if participant2 %}
            <span class="text-xl sm:text-2xl font-display font-bold text-white">{{ participant2.username|truncatechars:2|upper }}</span>
          {% else %}
            <i data-lucide="user" class="w-8 h-8 text-gray-600"></i>
          {% endif %}
        </div>
        <p class="text-sm font-display font-bold text-white truncate">
          {{ participant2.username|default:"TBD" }}
        </p>
        {% if match.winner_id and participant2 and match.winner_id == participant2.id %}
          <span class="text-[10px] text-dc-gold"><i data-lucide="trophy" class="w-3 h-3 inline"></i> Winner</span>
        {% endif %}
      </div>
    </div>

    {# Participant action #}
    {% if is_participant and match.state == 'live' %}
      <div class="mt-6 text-center">
        <a href="{% url 'tournaments:submit_result' tournament.slug match.id %}"
           class="inline-flex items-center px-5 py-2.5 bg-dc-cyan text-dc-dark font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition shadow-[0_0_20px_rgba(6,182,212,0.3)]">
          <i data-lucide="send" class="w-4 h-4 mr-2"></i> Submit Result
        </a>
      </div>
    {% endif %}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    {# ── Timeline ── #}
    <div class="glass rounded-xl overflow-hidden">
      <div class="px-6 py-4 border-b border-dc-border">
        <h3 class="text-sm font-display font-semibold text-white">
          <i data-lucide="clock" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Match Timeline
        </h3>
      </div>
      <div class="p-6">
        {% if timeline %}
          <div class="relative pl-6 space-y-6">
            <div class="absolute left-2 top-2 bottom-2 w-px bg-dc-border"></div>
            {% for event in timeline %}
              <div class="relative">
                <div class="absolute -left-4 w-4 h-4 rounded-full bg-dc-surface border-2 border-dc-cyan flex items-center justify-center">
                  <div class="w-1.5 h-1.5 rounded-full bg-dc-cyan"></div>
                </div>
                <div>
                  <p class="text-sm font-medium text-white">{{ event.event }}</p>
                  <p class="text-xs text-gray-400 mt-0.5">{{ event.description }}</p>
                  {% if event.timestamp %}
                    <p class="text-[10px] text-gray-600 mt-1">{{ event.timestamp|date:"M d, Y · g:i A" }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-6">
            <i data-lucide="clock" class="w-6 h-6 text-gray-700 mx-auto mb-1"></i>
            <p class="text-xs text-gray-600">No events yet</p>
          </div>
        {% endif %}
      </div>
    </div>

    {# ── Match Info ── #}
    <div class="space-y-6">
      <div class="glass rounded-xl p-6">
        <h3 class="text-sm font-display font-semibold text-white mb-4">
          <i data-lucide="info" class="w-4 h-4 inline mr-1 text-dc-cyan"></i> Match Details
        </h3>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">State</dt>
            <dd>
              <span class="px-2 py-0.5 text-xs rounded-full
                {% if match.state == 'completed' %}bg-green-900/40 text-green-400 border border-green-700/30
                {% elif match.state == 'live' %}bg-red-900/40 text-red-400 border border-red-700/30
                {% elif match.state == 'scheduled' %}bg-blue-900/40 text-blue-400 border border-blue-700/30
                {% else %}bg-gray-800/40 text-gray-400 border border-gray-700/30{% endif %}">
                {{ match.get_state_display|default:match.state|title }}
              </span>
            </dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Round</dt>
            <dd class="text-white">{{ match.round_name|default:match.round_number }}</dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Match #</dt>
            <dd class="text-white font-mono">{{ match.match_number }}</dd>
          </div>
          {% if match.best_of %}
            <div class="flex justify-between">
              <dt class="text-gray-500">Best Of</dt>
              <dd class="text-white">{{ match.best_of }}</dd>
            </div>
          {% endif %}
        </dl>
      </div>

      {# Lobby Info (participants only) #}
      {% if show_lobby_info and match.lobby_info %}
        <div class="glass rounded-xl p-6 neon-border-gold">
          <h3 class="text-sm font-display font-semibold text-dc-gold mb-3">
            <i data-lucide="lock" class="w-4 h-4 inline mr-1"></i> Lobby Info
          </h3>
          <p class="text-sm text-gray-300 font-mono bg-dc-surface rounded-lg p-3 break-all">
            {{ match.lobby_info }}
          </p>
          <p class="text-[10px] text-gray-600 mt-2">Only visible to participants</p>
        </div>
      {% endif %}
    </div>

  </div>
</div>

{% endblock %}
