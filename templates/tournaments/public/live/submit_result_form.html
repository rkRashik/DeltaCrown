{% extends "tournaments/base.html" %}
{% load static %}

{# ─────────────────────────────────────────────────────────
   Submit Match Result — FE-T-014
   Context: match, tournament, is_participant1, is_participant2
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Submit Result — Match #{{ match.match_number }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-xl mx-auto px-4 sm:px-6 py-8">

  {# ── Breadcrumb ── #}
  <div class="mb-6">
    <a href="{% url 'tournaments:match_detail' tournament.slug match.id %}" class="text-xs text-gray-500 hover:text-dc-cyan transition">
      <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Back to Match
    </a>
  </div>

  <div class="glass rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-dc-border bg-dc-cyan/[0.03]">
      <h1 class="text-lg font-display font-bold text-white">
        <i data-lucide="send" class="w-5 h-5 inline mr-2 text-dc-cyan"></i> Submit Match Result
      </h1>
      <p class="text-xs text-gray-400 mt-1">
        Round {{ match.round_number }} · Match #{{ match.match_number }}
      </p>
    </div>

    <form id="result-form" class="p-6 space-y-6">
      {% csrf_token %}

      {# ── Score Entry ── #}
      <div>
        <label class="block text-xs text-gray-400 mb-3 uppercase tracking-wider">Scores</label>
        <div class="grid grid-cols-3 items-center gap-4">
          {# P1 Score #}
          <div class="text-center">
            <p class="text-xs text-gray-400 mb-2 truncate">
              {% if match.participant1 %}{{ match.participant1.username }}{% else %}Player 1{% endif %}
            </p>
            <input type="number" name="participant1_score" min="0" required
                   class="form-input text-center text-2xl font-display font-bold !py-4"
                   placeholder="0"
                   {% if is_participant2 %}{% endif %}>
            {% if is_participant1 %}
              <p class="text-[10px] text-dc-cyan mt-1">You</p>
            {% endif %}
          </div>

          <div class="text-center text-gray-600 text-lg font-display">VS</div>

          {# P2 Score #}
          <div class="text-center">
            <p class="text-xs text-gray-400 mb-2 truncate">
              {% if match.participant2 %}{{ match.participant2.username }}{% else %}Player 2{% endif %}
            </p>
            <input type="number" name="participant2_score" min="0" required
                   class="form-input text-center text-2xl font-display font-bold !py-4"
                   placeholder="0"
                   {% if is_participant1 %}{% endif %}>
            {% if is_participant2 %}
              <p class="text-[10px] text-dc-cyan mt-1">You</p>
            {% endif %}
          </div>
        </div>
        <p class="text-[10px] text-gray-600 mt-2 text-center">Ties are not allowed. One player must win.</p>
      </div>

      {# ── Evidence URL ── #}
      <div>
        <label class="block text-xs text-gray-400 mb-1.5">Evidence URL (optional)</label>
        <input type="url" name="evidence_url" class="form-input" placeholder="https://screenshot-link.com/...">
        <p class="text-[10px] text-gray-600 mt-1">Link to a screenshot or video of the final score screen</p>
      </div>

      {# ── Notes ── #}
      <div>
        <label class="block text-xs text-gray-400 mb-1.5">Notes (optional)</label>
        <textarea name="notes" rows="3" class="form-textarea" placeholder="Any additional notes about the match..."></textarea>
      </div>

      {# ── Submit ── #}
      <div class="flex items-center justify-between pt-2">
        <a href="{% url 'tournaments:match_detail' tournament.slug match.id %}"
           class="text-sm text-gray-500 hover:text-white transition">
          Cancel
        </a>
        <button type="submit" id="submit-btn"
                class="px-6 py-3 bg-dc-cyan text-dc-dark font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition-all shadow-[0_0_20px_rgba(6,182,212,0.3)]">
          <i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Submit Result
        </button>
      </div>

      {# Feedback area #}
      <div id="form-feedback" class="hidden rounded-xl p-4 text-sm"></div>
    </form>
  </div>

</div>

{% endblock %}

{% block tournament_js %}
<script>
  document.getElementById('result-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const feedback = document.getElementById('form-feedback');
    const fd = new FormData(this);

    const s1 = parseInt(fd.get('participant1_score') || 0);
    const s2 = parseInt(fd.get('participant2_score') || 0);
    if (s1 === s2) {
      feedback.className = 'rounded-xl p-4 text-sm bg-red-900/40 text-red-400 border border-red-700/30';
      feedback.textContent = 'Scores cannot be equal — there must be a winner.';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Submitting…';

    try {
      const res = await fetch(window.location.href, {
        method: 'POST',
        body: fd,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await res.json();
      if (data.success) {
        feedback.className = 'rounded-xl p-4 text-sm bg-green-900/40 text-green-400 border border-green-700/30';
        feedback.textContent = data.message;
        if (data.redirect_url) setTimeout(() => window.location.href = data.redirect_url, 1500);
      } else {
        feedback.className = 'rounded-xl p-4 text-sm bg-red-900/40 text-red-400 border border-red-700/30';
        feedback.textContent = data.error || 'Submission failed';
        btn.disabled = false;
        btn.textContent = 'Submit Result';
      }
    } catch {
      feedback.className = 'rounded-xl p-4 text-sm bg-red-900/40 text-red-400 border border-red-700/30';
      feedback.textContent = 'Network error — please try again.';
      btn.disabled = false;
      btn.textContent = 'Submit Result';
    }
  });
</script>
{% endblock %}
