{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Live Bracket — FE-T-008
   Context: tournament, bracket_available, bracket,
            matches_by_round, not_ready_reason
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Bracket — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_css %}
<style>
  /* Bracket connector lines */
  .bracket-round { position: relative; }
  .bracket-match {
    position: relative;
    transition: all 0.3s ease;
  }
  .bracket-match:hover { transform: translateX(4px); }

  /* Horizontal connector to next round */
  .bracket-match::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -2rem;
    width: 2rem;
    height: 2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
  }
  /* Last round has no connector */
  .bracket-round:last-child .bracket-match::after { display: none; }

  /* Vertical connector between pairs */
  .bracket-pair {
    position: relative;
  }
  .bracket-pair::after {
    content: '';
    position: absolute;
    top: 25%;
    right: -2rem;
    width: 2px;
    height: 50%;
    background: rgba(255,255,255,0.06);
  }
  .bracket-round:last-child .bracket-pair::after { display: none; }

  /* Live match pulse border */
  .bracket-live {
    border-color: rgba(239,68,68,0.3) !important;
    box-shadow: 0 0 12px rgba(239,68,68,0.1);
  }

  /* Winner highlight */
  .bracket-winner { background: rgba(250,204,21,0.04); }
</style>
{% endblock %}

{% block tournament_content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 py-8">

  {# ── Header ── #}
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
    <div>
      <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition mb-2 inline-block">
        <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> {{ tournament.name }}
      </a>
      <h1 class="text-2xl font-display font-bold text-white">Tournament Bracket</h1>
      {% if tournament.game %}
        <p class="text-sm text-gray-400 mt-1">{{ tournament.game.name }} · {{ tournament.get_format_display|default:tournament.format|title }}</p>
      {% endif %}
    </div>
    <div class="flex items-center gap-3">
      {% if tournament.status == 'live' %}
        <span class="px-3 py-1 text-xs rounded-full bg-red-900/40 text-red-400 border border-red-700/30 animate-pulse">
          <i data-lucide="radio" class="w-3 h-3 inline mr-1"></i> LIVE
        </span>
      {% endif %}
      <a href="{% url 'tournaments:leaderboard' tournament.slug %}" class="px-3 py-1.5 text-xs text-gray-400 bg-white/5 rounded-lg border border-dc-border hover:bg-white/10 transition">
        <i data-lucide="bar-chart-3" class="w-3 h-3 inline mr-1"></i> Leaderboard
      </a>
    </div>
  </div>

  {% if bracket_available %}
    {# ── Bracket Visualization ── #}
    <div class="overflow-x-auto -mx-4 sm:mx-0">
      <div class="flex gap-8 min-w-max px-4 sm:px-0 pb-4">
        {% for round in matches_by_round %}
          <div class="flex-shrink-0 w-64">
            {# Round Header #}
            <div class="text-center mb-4">
              <span class="text-xs uppercase tracking-widest text-gray-500 font-display">
                {{ round.round_name|default:"Round "|add:round.round_number }}
              </span>
            </div>

            {# Round Matches #}
            <div class="space-y-4">
              {% for match in round.matches %}
                <a href="{% url 'tournaments:match_detail' tournament.slug match.id %}"
                   class="block glass rounded-xl overflow-hidden hover:bg-white/[0.04] transition group bracket-match
                   {% if match.state == 'live' %}bracket-live{% elif match.state == 'completed' %}border border-dc-border{% else %}border border-dc-border/50{% endif %}">

                  {# Match header #}
                  <div class="px-3 py-1.5 bg-white/[0.02] border-b border-dc-border flex items-center justify-between">
                    <span class="text-[10px] text-gray-600 font-mono">M{{ match.match_number }}</span>
                    {% if match.state == 'live' %}
                      <span class="w-2 h-2 rounded-full bg-red-400 animate-pulse"></span>
                    {% elif match.state == 'completed' %}
                      <i data-lucide="check" class="w-3 h-3 text-green-500"></i>
                    {% endif %}
                  </div>

                  {# Participant 1 #}
                  <div class="px-4 py-2.5 flex items-center justify-between border-b border-dc-border/50
                    {% if match.winner_id and match.participant1_id == match.winner_id %}bracket-winner{% endif %}">
                    <div class="flex items-center gap-2 min-w-0">
                      {% if match.participant1_id == match.winner_id %}
                        <i data-lucide="trophy" class="w-3 h-3 text-dc-gold flex-shrink-0"></i>
                      {% endif %}
                      <span class="text-sm text-white truncate">
                        {{ match.participant1_name|default:"TBD" }}
                      </span>
                    </div>
                    <span class="text-sm font-mono {% if match.participant1_id == match.winner_id %}text-dc-gold font-bold{% else %}text-gray-400{% endif %}">
                      {{ match.participant1_score|default:"0" }}
                    </span>
                  </div>

                  {# Participant 2 #}
                  <div class="px-4 py-2.5 flex items-center justify-between
                    {% if match.winner_id and match.participant2_id == match.winner_id %}bracket-winner{% endif %}">
                    <div class="flex items-center gap-2 min-w-0">
                      {% if match.participant2_id == match.winner_id %}
                        <i data-lucide="trophy" class="w-3 h-3 text-dc-gold flex-shrink-0"></i>
                      {% endif %}
                      <span class="text-sm text-white truncate">
                        {{ match.participant2_name|default:"TBD" }}
                      </span>
                    </div>
                    <span class="text-sm font-mono {% if match.participant2_id == match.winner_id %}text-dc-gold font-bold{% else %}text-gray-400{% endif %}">
                      {{ match.participant2_score|default:"0" }}
                    </span>
                  </div>
                </a>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% else %}
    {# ── Not Ready State ── #}
    <div class="glass rounded-xl p-12 text-center">
      <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-dc-surface flex items-center justify-center">
        <i data-lucide="git-branch" class="w-10 h-10 text-gray-600"></i>
      </div>
      <h2 class="text-xl font-display font-bold text-white mb-2">Bracket Not Available</h2>
      <p class="text-sm text-gray-400 max-w-md mx-auto">{{ not_ready_reason }}</p>
      <a href="{% url 'tournaments:detail' tournament.slug %}" class="inline-block mt-6 px-5 py-2.5 text-sm text-dc-cyan border border-dc-cyan/30 rounded-xl hover:bg-dc-cyan/5 transition">
        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Back to Tournament
      </a>
    </div>
  {% endif %}

</div>

{% endblock %}
