{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Register for {{ tournament.name }} — DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/registration-v2.css' %}?v=1" />
{% endblock %}

{% block content %}
<div class="registration-wizard-container">
  
  <!-- Tournament Header -->
  <div class="tournament-header">
    {% if tournament.banner %}
    <div class="tournament-banner">
      <img src="{{ tournament.banner.url }}" alt="{{ tournament.name }}">
    </div>
    {% endif %}
    
    <div class="tournament-info">
      <h1 class="tournament-title">{{ tournament.name }}</h1>
      <div class="tournament-meta">
        <span class="meta-chip">
          <i class="fas fa-gamepad"></i> {{ tournament.get_game_display }}
        </span>
        {% if is_team_event %}
        <span class="meta-chip">
          <i class="fas fa-users"></i> Team Tournament
        </span>
        {% else %}
        <span class="meta-chip">
          <i class="fas fa-user"></i> Solo Tournament
        </span>
        {% endif %}
        {% if tournament.tournament_finance %}
          {% if tournament.tournament_finance.is_free %}
          <span class="meta-chip free">
            <i class="fas fa-gift"></i> Free Entry
          </span>
          {% else %}
          <span class="meta-chip premium">
            <i class="fas fa-coins"></i> ৳{{ tournament.tournament_finance.entry_fee|intcomma }}
          </span>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Registration Wizard -->
  <div class="wizard-wrapper">
    
    <!-- Stepper -->
    <div class="wizard-stepper" id="wizardStepper">
      <!-- Steps will be dynamically generated by JavaScript -->
    </div>

    <!-- Wizard Content -->
    <div class="wizard-content">
      
      <!-- Step 1: Player/Team Information -->
      <div class="wizard-step active" data-step="1" id="step1">
        <div class="step-header">
          <h2 class="step-title">
            {% if is_team_event %}
            <i class="fas fa-shield-alt"></i> TEAM & CAPTAIN INFORMATION
            {% else %}
            <i class="fas fa-user-circle"></i> PLAYER INFORMATION
            {% endif %}
          </h2>
          <p class="step-description">
            {% if is_team_event %}
            Select your team and verify your captain details. Fields will auto-fill from your profile.
            {% else %}
            Enter your game credentials. Fields will auto-fill from your profile.
            {% endif %}
          </p>
        </div>

        <div class="step-content">
          
          {% if is_team_event %}
          <!-- Team Information Card (Auto-filled) -->
          <div class="info-card">
            <div class="card-header">
              <h3><i class="fas fa-users"></i> Your {{ tournament.get_game_display }} Team</h3>
            </div>
            <div class="card-body">
              {% if user_team %}
              <div class="team-info-display">
                {% if user_team.logo %}
                <div class="team-avatar">
                  <img src="{{ user_team.logo.url }}" alt="{{ user_team.name }}">
                </div>
                {% endif %}
                <div class="team-details">
                  <h4>{{ user_team.name }}</h4>
                  <span class="team-tag">[{{ user_team.tag }}]</span>
                </div>
              </div>
              <input type="hidden" id="teamSelect" value="{{ user_team.id }}">
              <span class="field-hint">
                <i class="fas fa-info-circle"></i> 
                This is your registered {{ tournament.get_game_display }} team. You are registering as captain.
              </span>
              {% else %}
              <p class="field-error">
                <i class="fas fa-exclamation-triangle"></i> 
                No {{ tournament.get_game_display }} team found. You must be a captain of a {{ tournament.get_game_display }} team to register.
              </p>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <!-- Player Information Card -->
          <div class="info-card">
            <div class="card-header">
              <h3>
                <i class="fas fa-gamepad"></i> 
                {% if is_team_event %}Captain's {% endif %}Game Information
              </h3>
            </div>
            <div class="card-body">
              <div id="playerFieldsContainer">
                <!-- Dynamic game-specific fields will be inserted here -->
                <div class="loading-state">
                  <div class="spinner"></div>
                  <p>Loading game fields...</p>
                </div>
              </div>

              {% if not is_team_event %}
              <div class="form-field">
                <label>
                  <input type="checkbox" id="saveToProfile" checked>
                  <span>Save my game information to profile for future tournaments</span>
                </label>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Contact Information Card -->
          <div class="info-card">
            <div class="card-header">
              <h3><i class="fas fa-address-card"></i> Contact Information</h3>
            </div>
            <div class="card-body">
              <div class="form-row">
                <div class="form-field">
                  <label for="email">Email Address <span class="required">*</span></label>
                  <input type="email" id="email" class="form-control locked" value="{{ user.email }}" readonly>
                  <span class="field-hint"><i class="fas fa-lock"></i> Locked from your account</span>
                </div>
              </div>
            </div>
          </div>

        </div>

        <div class="step-actions">
          <button type="button" class="btn-wizard btn-next" onclick="wizardController.nextStep()">
            Next: {% if is_team_event %}Build Roster{% else %}Review{% endif %}
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Step 2: Team Roster (Only for Team Tournaments) -->
      {% if is_team_event %}
      <div class="wizard-step" data-step="2" id="step2">
        <div class="step-header">
          <h2 class="step-title">
            <i class="fas fa-clipboard-list"></i> TEAM ROSTER & ROLES
          </h2>
          <p class="step-description">
            Add your team members and assign their roles. Minimum <strong id="minPlayers">5</strong> players required.
          </p>
        </div>

        <div class="step-content">
          
          <!-- Roster Counter -->
          <div class="roster-counter">
            <div class="counter-display">
              <span class="counter-label">ROSTER:</span>
              <span class="counter-value" id="rosterCount">1/5</span>
            </div>
            <button type="button" class="btn-add-player" id="addPlayerBtn">
              <i class="fas fa-plus"></i> ADD PLAYER
            </button>
          </div>

          <!-- Player Cards Container -->
          <div class="player-cards-container" id="playerCardsContainer">
            
            <!-- Captain Card (Always first, locked) -->
            <div class="player-card captain-card locked" data-player-index="0">
              <div class="card-header">
                <span class="player-number">CAPTAIN</span>
                <span class="captain-badge"><i class="fas fa-crown"></i></span>
              </div>
              <div class="card-body">
                <div class="player-info-locked">
                  <p><strong>Name:</strong> <span id="captainName">Loading...</span></p>
                  <p><strong>Game ID:</strong> <span id="captainGameId">Loading...</span></p>
                </div>
                <div class="form-field">
                  <label>Role <span class="required">*</span></label>
                  <select class="form-control player-role" id="captainRole" required>
                    <option value="">Select role...</option>
                    <!-- Roles populated by JavaScript -->
                  </select>
                </div>
              </div>
            </div>

            <!-- Additional player cards will be added here dynamically -->

          </div>

        </div>

        <div class="step-actions">
          <button type="button" class="btn-wizard btn-back" onclick="wizardController.prevStep()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button type="button" class="btn-wizard btn-next" onclick="wizardController.nextStep()">
            Next: Review <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Step 3: Review & Confirm -->
      <div class="wizard-step" data-step="{% if is_team_event %}3{% else %}2{% endif %}" id="stepReview">
        <div class="step-header">
          <h2 class="step-title">
            <i class="fas fa-clipboard-check"></i> REVIEW & CONFIRM
          </h2>
          <p class="step-description">
            Review all information carefully before submitting your registration.
          </p>
        </div>

        <div class="step-content">
          
          <!-- Summary Cards -->
          <div class="summary-section">
            
            <!-- Player/Team Summary -->
            {% if is_team_event %}
            <div class="summary-card">
              <div class="summary-header">
                <h3><i class="fas fa-shield-alt"></i> Team Information</h3>
                <button type="button" class="btn-edit" onclick="wizardController.goToStep(1)">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
              <div class="summary-body" id="teamSummary">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            {% else %}
            <div class="summary-card">
              <div class="summary-header">
                <h3><i class="fas fa-user"></i> Player Information</h3>
                <button type="button" class="btn-edit" onclick="wizardController.goToStep(1)">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
              <div class="summary-body" id="playerSummary">
                <!-- Populated by JavaScript -->
              </div>
            </div>
            {% endif %}

            <!-- Roster Summary (Team only) -->
            {% if is_team_event %}
            <div class="summary-card">
              <div class="summary-header">
                <h3><i class="fas fa-users"></i> Team Roster</h3>
                <button type="button" class="btn-edit" onclick="wizardController.goToStep(2)">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
              <div class="summary-body">
                <div class="roster-summary-table" id="rosterSummary">
                  <!-- Populated by JavaScript -->
                </div>
              </div>
            </div>
            {% endif %}

          </div>

          <!-- Rules Agreement -->
          <div class="rules-agreement">
            <label class="checkbox-wrapper">
              <input type="checkbox" id="agreeRules" required>
              <span class="checkmark"></span>
              <span class="checkbox-label">
                {% if is_team_event %}
                As team captain, I confirm that all player information is accurate and that the entire roster agrees to the 
                {% else %}
                I have read and agree to the 
                {% endif %}
                <a href="#" class="rules-link" onclick="openRulesModal(); return false;">Tournament Rules</a>
              </span>
            </label>
          </div>

        </div>

        <div class="step-actions">
          <button type="button" class="btn-wizard btn-back" onclick="wizardController.prevStep()">
            <i class="fas fa-arrow-left"></i> Back
          </button>
          <button type="button" class="btn-wizard btn-submit" id="submitBtn" onclick="wizardController.submitRegistration()">
            <i class="fas fa-check-circle"></i> 
            {% if tournament.tournament_finance and not tournament.tournament_finance.is_free %}
            Proceed to Payment
            {% else %}
            Complete Registration
            {% endif %}
          </button>
        </div>
      </div>

      <!-- Step 4: Payment (Only for paid tournaments) -->
      {% if tournament.tournament_finance and not tournament.tournament_finance.is_free %}
      <div class="wizard-step" data-step="{% if is_team_event %}4{% else %}3{% endif %}" id="stepPayment">
        <div class="step-header">
          <h2 class="step-title">
            <i class="fas fa-credit-card"></i> FINALIZE & PAY
          </h2>
          <p class="step-description">
            Your roster has been saved. Complete payment to secure your spot.
          </p>
        </div>

        <div class="step-content">
          <div class="payment-redirect-card">
            <div class="payment-icon">
              <i class="fas fa-wallet"></i>
            </div>
            <h3>Registration Fee: ৳{{ tournament.tournament_finance.entry_fee|intcomma }}</h3>
            <p>You will be redirected to the payment page in <span id="countdown">5</span> seconds...</p>
            <button type="button" class="btn-wizard btn-payment" onclick="redirectToPayment()">
              <i class="fas fa-arrow-right"></i> Pay Now
            </button>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>

</div>

<!-- Rules Modal -->
<div id="rulesModal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <h3><i class="fas fa-gavel"></i> Tournament Rules</h3>
      <button class="modal-close" onclick="closeRulesModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="rules-content">
        {{ tournament.rules|safe }}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-wizard btn-secondary" onclick="closeRulesModal()">Close</button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Pass Django context to JavaScript
  window.tournamentData = {
    slug: '{{ tournament.slug }}',
    game: '{{ tournament.game }}',
    isTeam: {{ is_team_event|yesno:"true,false" }},
    isPaid: {% if tournament.tournament_finance and not tournament.tournament_finance.is_free %}true{% else %}false{% endif %},
    minTeamSize: {% if tournament.settings %}{{ tournament.settings.min_team_size|default:5 }}{% else %}5{% endif %},
    maxTeamSize: {% if tournament.settings %}{{ tournament.settings.max_team_size|default:7 }}{% else %}7{% endif %},
    userEmail: '{{ user.email }}',
    teamId: {% if user_team %}'{{ user_team.id }}'{% else %}null{% endif %},
    teamName: {% if user_team %}'{{ user_team.name }}'{% else %}null{% endif %},
    teamTag: {% if user_team %}'{{ user_team.tag }}'{% else %}null{% endif %},
    teamLogo: {% if user_team and user_team.logo %}'{{ user_team.logo.url }}'{% else %}null{% endif %},
    // Profile data for auto-fill
    profileData: {
      displayName: '{{ profile_data.displayName|escapejs }}',
      email: '{{ profile_data.email|escapejs }}',
      phone: '{{ profile_data.phone|escapejs }}',
      discordId: '{{ profile_data.discordId|escapejs }}',
      riotId: '{{ profile_data.riotId|escapejs|default:"" }}',
      steamId: '{{ profile_data.steamId|escapejs|default:"" }}',
      dotaFriendId: '{{ profile_data.dotaFriendId|escapejs|default:"" }}',
      inGameName: '{{ profile_data.inGameName|escapejs|default:"" }}',
      mlbbUserId: '{{ profile_data.mlbbUserId|escapejs|default:"" }}',
      characterName: '{{ profile_data.characterName|escapejs|default:"" }}',
      pubgId: '{{ profile_data.pubgId|escapejs|default:"" }}',
      freeFireUid: '{{ profile_data.freeFireUid|escapejs|default:"" }}',
      efootballUsername: '{{ profile_data.efootballUsername|escapejs|default:"" }}',
      efootballUserId: '{{ profile_data.efootballUserId|escapejs|default:"" }}',
      platform: '{{ profile_data.platform|escapejs|default:"" }}',
      platformId: '{{ profile_data.platformId|escapejs|default:"" }}',
      fc26Username: '{{ profile_data.fc26Username|escapejs|default:"" }}'
    },
    // Team roster data for auto-fill (team tournaments)
    teamRoster: {{ team_roster|safe|default:"[]" }}
  };
</script>
<script src="{% static 'js/registration-v2.js' %}?v=2"></script>
{% endblock %}
