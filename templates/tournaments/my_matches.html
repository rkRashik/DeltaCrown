{% extends "base.html" %}
{% load static %}

{% block title %}My Matches — DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tokens.css' %}?v=mm1">
<link rel="stylesheet" href="{% static 'siteui/css/tournament-matches-neo.css' %}?v=mm1">
{% endblock %}

{% block content %}
<section class="dc-container mmneo">
  <header class="mm-hero">
    <h1><span class="grad">My Matches</span></h1>
    <p class="muted">Live status, lobby codes, quick reporting, and calendar export.</p>
  </header>

  <div class="mm-toolbar">
    <form method="get" action="" class="filters">
      <input type="search" name="q" value="{{ params.q|default:'' }}" placeholder="Search matches, teams…" />
      <select name="game">
        <option value="">Any game</option>
        <option value="valorant" {% if params.game == 'valorant' %}selected{% endif %}>Valorant</option>
        <option value="efootball" {% if params.game == 'efootball' %}selected{% endif %}>eFootball</option>
        <option value="cs2" {% if params.game == 'cs2' %}selected{% endif %}>CS2</option>
        <option value="fc26" {% if params.game == 'fc26' %}selected{% endif %}>FC 26</option>
        <option value="mobilelegend" {% if params.game == 'mobilelegend' %}selected{% endif %}>MLBB</option>
        <option value="pubg" {% if params.game == 'pubg' %}selected{% endif %}>PUBG</option>
      </select>
      <select name="state">
        <option value="">Any state</option>
        <option value="live" {% if params.state == 'live' %}selected{% endif %}>Live</option>
        <option value="confirmed" {% if params.state == 'confirmed' %}selected{% endif %}>Confirmed</option>
        <option value="declined" {% if params.state == 'declined' %}selected{% endif %}>Declined</option>
        <option value="completed" {% if params.state == 'completed' %}selected{% endif %}>Completed</option>
        <option value="verified" {% if params.state == 'verified' %}selected{% endif %}>Verified</option>
      </select>
      <input type="date" name="start_date" value="{{ params.start_date|default:'' }}">
      <input type="date" name="end_date" value="{{ params.end_date|default:'' }}">
      <select name="group">
        <option value="">Ungrouped</option>
        <option value="tournament" {% if group_by == 'tournament' %}selected{% endif %}>By tournament</option>
        <option value="date" {% if group_by == 'date' %}selected{% endif %}>By date</option>
      </select>
      <button class="btn-neo" type="submit">Apply</button>
      <a class="btn-neo btn-ghost" href="{% url 'tournaments:my_matches' %}">Reset</a>
    </form>

    <div class="mm-actions">
      <a class="btn-neo btn-ghost" href="{% url 'tournaments:my_matches_csv' %}?q={{ params.q|urlencode }}&game={{ params.game|urlencode }}&state={{ params.state|urlencode }}&start_date={{ params.start_date|urlencode }}&end_date={{ params.end_date|urlencode }}">Export CSV</a>
      <a class="btn-neo btn-ghost" href="{% url 'tournaments:my_matches_ics_link' %}">Calendar (ICS)</a>
    </div>
  </div>

  <div class="mm-counters">
    <span class="chip">Upcoming: {{ counters.upcoming|default:0 }}</span>
    <span class="chip">Live: {{ counters.live|default:0 }}</span>
    <span class="chip">Completed: {{ counters.completed|default:0 }}</span>
  </div>

  {% if pinned %}
    <div class="mm-pinned">
      <h3 class="h3">Pinned Tournaments</h3>
      <ul class="pin-list">
        {% for t in pinned %}
          <li>
            <a href="{% url 'tournaments:detail' t.slug %}">{{ t.name|default:t.title }}</a>
            <form method="post" action="{% url 'tournaments:my_matches_toggle_pin' t.id %}" style="display:inline">{% csrf_token %}<button class="link">Unpin</button></form>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if page_obj and page_obj.object_list %}
    <form method="post" action="{% url 'tournaments:my_matches_bulk' %}" class="mm-bulk">{% csrf_token %}
      <div class="mm-table">
        <div class="row th">
          <div><input type="checkbox" data-mm="check-all" aria-label="Select all"></div>
          <div>Time</div><div>Tournament</div><div>Match</div><div>Status</div><div>Actions</div>
        </div>
        {% for m in page_obj.object_list %}
        <div class="row">
          <div><input type="checkbox" name="match_ids" value="{{ m.id }}"></div>
          <div>{{ m.start_at|date:"M j, H:i" }}</div>
          <div>
            <a href="{% url 'tournaments:detail' m.tournament.slug %}">{{ m.tournament.name|default:m.tournament.title }}</a>
            {% if m.tournament.game %}<span class="muted small">• {{ m.tournament.game|title }}</span>{% endif %}
          </div>
          <div>
            {% with a=m.team_a_name|default:m.team_a.name|default:m.user_a.username b=m.team_b_name|default:m.team_b.name|default:m.user_b.username %}
              <span>{{ a|default:"TBD" }}</span>
              <span class="muted"> vs </span>
              <span>{{ b|default:"TBD" }}</span>
            {% endwith %}
            {% if m.score_text %}<span class="muted small"> • {{ m.score_text }}</span>{% endif %}
          </div>
          <div>{{ m.state|default:"pending"|title }}</div>
          <div class="act">
            {% if m.lobby_code %}<span class="chip">Lobby: {{ m.lobby_code }}</span>{% endif %}
            {% if m.report_url %}<a class="btn-neo ghost" href="{{ m.report_url }}">Report Result</a>{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mm-bulk-actions">
        <select name="action">
          <option value="confirm">Mark confirmed</option>
          <option value="decline">Mark declined</option>
        </select>
        <button class="btn-neo" type="submit">Apply to selected</button>
      </div>
    </form>

    <nav class="pager">
      {% if page_obj.has_previous %}
        <a class="btn-neo btn-ghost" href="?page={{ page_obj.previous_page_number }}&q={{ params.q|urlencode }}&game={{ params.game|urlencode }}&state={{ params.state|urlencode }}&start_date={{ params.start_date|urlencode }}&end_date={{ params.end_date|urlencode }}">Previous</a>
      {% endif %}
      <span class="muted">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="btn-neo btn-ghost" href="?page={{ page_obj.next_page_number }}&q={{ params.q|urlencode }}&game={{ params.game|urlencode }}&state={{ params.state|urlencode }}&start_date={{ params.start_date|urlencode }}&end_date={{ params.end_date|urlencode }}">Next</a>
      {% endif %}
    </nav>
  {% else %}
    <div class="card">
      <p class="muted">No matches yet. Register for a tournament to see your fixtures here.</p>
    </div>
  {% endif %}

  <aside class="mm-side small">
    <div class="card">
      <h3 class="h3">Subscribe</h3>
      <p>Add your matches to your calendar app.</p>
      <a class="btn-neo btn-ghost" href="{% url 'tournaments:my_matches_ics_link' %}">Get ICS link</a>
    </div>
    <div class="card">
      <h3 class="h3">This week</h3>
      <div class="heat">
        {% for d,c in heat_map.items %}
          <span class="dot" title="{{ d }} — {{ c }} match(es)">{{ c }}</span>
        {% empty %}
          <p class="muted">No scheduled matches this week.</p>
        {% endfor %}
      </div>
    </div>
  </aside>

  <div class="mm-foot small muted">
    <p>Tip: Use the filters to narrow down, then export CSV or add to Calendar.</p>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  // Small enhancement: keep radios/sections in sync if you add JS later.
  document.querySelector('[data-mm="check-all"]')?.addEventListener('change', (e) => {
    document.querySelectorAll('input[name="match_ids"]').forEach(cb => cb.checked = e.target.checked);
  });
</script>
{% endblock %}
