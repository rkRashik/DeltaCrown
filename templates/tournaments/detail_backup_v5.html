{% extends "base.html" %}
{% load static humanize %}

{% block title %}{{ ctx.title|default:"Tournament" }}  DeltaCrown{% endblock %}

{% block extra_head %}
<!-- V3 Modern CSS -->
<link rel="stylesheet" href="{% static 'siteui/css/tournaments-v3-detail.css' %}?v=3" />
<link rel="stylesheet" href="{% static 'siteui/css/countdown-timer.css' %}?v=1" />
<link rel="stylesheet" href="{% static 'siteui/css/capacity-animations.css' %}?v=1" />
{% if ctx.pdf_viewer %}
<link rel="stylesheet" href="{% static 'siteui/css/pdfjs-skin.css' %}?v=1" />
{% endif %}

<!-- V3 Modern JavaScript -->
<script src="{% static 'js/tournaments-v3-detail.js' %}?v=3" defer></script>

<!-- Initialize V3 with data attributes -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set data attributes for V3 JavaScript
    document.body.dataset.tournamentSlug = '{{ ctx.t.slug }}';
    document.body.dataset.authenticated = '{{ request.user.is_authenticated|lower }}';
    document.body.dataset.registered = '{{ ctx.ui.user_registration|lower }}';
});
</script>
{% endblock %}

{% block body_class %}tournament-detail-v3{% endblock %}

{% block content %}
<!-- Hero Banner -->
<section class="detail-hero">
    <div class="detail-hero-bg">
        {% if ctx.banner %}
        <img src="{{ ctx.banner }}" alt="{{ ctx.title|default:'Tournament' }} banner" class="detail-hero-banner-img" loading="eager" />
        {% endif %}
        <div class="detail-hero-overlay"></div>
        <div class="detail-hero-particles">
            <div class="detail-hero-particle"></div>
            <div class="detail-hero-particle"></div>
            <div class="detail-hero-particle"></div>
            <div class="detail-hero-particle"></div>
            <div class="detail-hero-particle"></div>
        </div>
    </div>

    <div class="hub-container">
        <div class="detail-hero-content">
            <!-- Breadcrumb -->
            <nav class="detail-breadcrumb" aria-label="Breadcrumb">
                <a href="{% url 'tournaments:hub' %}">Tournaments</a>
                <span class="detail-breadcrumb-separator"></span>
                {% if ctx.game_slug %}
                <a href="{% url 'tournaments:game' ctx.game_slug %}">{{ ctx.game|default:ctx.game_slug|title }}</a>
                <span class="detail-breadcrumb-separator"></span>
                {% endif %}
                <span class="detail-breadcrumb-current">Details</span>
            </nav>

            <!-- Status Badge -->
            {% if ctx.status == 'live' %}
            <div class="detail-status-badge live"> LIVE NOW</div>
            {% elif ctx.status == 'registration' %}
            <div class="detail-status-badge registration"> REGISTRATION OPEN</div>
            {% elif ctx.status == 'upcoming' %}
            <div class="detail-status-badge upcoming"> COMING SOON</div>
            {% elif ctx.status == 'completed' %}
            <div class="detail-status-badge completed"> COMPLETED</div>
            {% endif %}

            <!-- Title -->
            <h1 class="detail-hero-title">
                <span class="gradient-text">{{ ctx.title|default:"Tournament" }}</span>
            </h1>

            <!-- Subtitle -->
            {% if ctx.short_desc %}
            <p class="detail-hero-subtitle">{{ ctx.short_desc }}</p>
            {% endif %}

            <!-- Quick Info Pills -->
            <div class="detail-hero-pills">
                {% if ctx.schedule.starts_at %}
                <span class="detail-pill">
                    <i class="fa-solid fa-calendar"></i>
                    {{ ctx.schedule.starts_at|date:"M j, H:i" }}
                </span>
                {% endif %}

                {% if ctx.format.type %}
                <span class="detail-pill">
                    <i class="fa-solid fa-trophy"></i>
                    {{ ctx.format.type|title }}
                </span>
                {% endif %}

                {% if ctx.format.team_min or ctx.format.team_max %}
                <span class="detail-pill">
                    <i class="fa-solid fa-users"></i>
                    {% if ctx.format.team_min and ctx.format.team_max %}
                        {{ ctx.format.team_min }}{{ ctx.format.team_max }}
                    {% else %}
                        {{ ctx.format.team_min|default:ctx.format.team_max }}
                    {% endif %} players
                </span>
                {% endif %}

                {% if ctx.region %}
                <span class="detail-pill">
                    <i class="fa-solid fa-map-marker-alt"></i>
                    {{ ctx.region }}
                </span>
                {% endif %}

                {% if ctx.entry_fee is not None %}
                <span class="detail-pill">
                    <i class="fa-solid fa-tag"></i>
                    {% if ctx.entry_fee == 0 %}Free Entry{% else %}{{ ctx.entry_fee|intcomma }} Entry{% endif %}
                </span>
                {% endif %}

                {% if ctx.prize_pool %}
                <span class="detail-pill">
                    <i class="fa-solid fa-gift"></i>
                    {{ ctx.prize_pool|intcomma }} Prize
                </span>
                {% endif %}
            </div>

            <!-- Hero Actions -->
            <div class="detail-hero-actions">
                <a href="#registration" class="btn btn-primary-lg">Register Now</a>
                <a href="#rules" class="btn btn-accent-lg">View Rules</a>
            </div>
        </div>
    </div>
</section>

<!-- Sticky Info Bar -->
<section class="detail-info-bar">
    <div class="hub-container">
        <div class="detail-info-bar-inner">
            <div class="detail-info-stats">
                <div class="detail-info-stat">
                    <div class="detail-info-stat-value">
                        {% if ctx.prize_pool %}{{ ctx.prize_pool|intcomma }}{% else %}TBA{% endif %}
                    </div>
                    <div class="detail-info-stat-label">Prize Pool</div>
                </div>

                <div class="detail-info-stat">
                    <div class="detail-info-stat-value">
                        {% if ctx.slots.capacity %}{{ ctx.slots.current|default:0 }}/{{ ctx.slots.capacity }}{% else %}{% endif %}
                    </div>
                    <div class="detail-info-stat-label">Teams</div>
                </div>

                <div class="detail-info-stat">
                    <div class="detail-info-stat-value">{{ ctx.format.type|default:""|title }}</div>
                    <div class="detail-info-stat-label">Format</div>
                </div>

                <div class="detail-info-stat">
                    <div class="detail-info-stat-value">
                        {% if ctx.entry_fee is not None %}
                            {% if ctx.entry_fee == 0 %}Free{% else %}{{ ctx.entry_fee|intcomma }}{% endif %}
                        {% else %}{% endif %}
                    </div>
                    <div class="detail-info-stat-label">Entry Fee</div>
                </div>
            </div>

            <div class="detail-info-actions">
                <button class="btn btn-primary" onclick="document.getElementById('registration').scrollIntoView({behavior: 'smooth'})">
                    Register Now
                </button>
                <button class="btn btn-ghost" onclick="shareTournament()">
                    <i class="fa-solid fa-share"></i> Share
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Main Layout -->
<div class="hub-container">
    <div class="detail-layout">
        <!-- Main Content -->
        <main class="detail-main">
            <!-- Tabbed Content -->
            <div class="detail-tabs-wrapper">
                <div class="detail-tabs">
                    <button class="detail-tab active" data-tab="overview">Overview</button>
                    <button class="detail-tab" data-tab="rules">Rules</button>
                    <button class="detail-tab" data-tab="prizes">Prizes</button>
                    <button class="detail-tab" data-tab="schedule">Schedule</button>
                    <button class="detail-tab" data-tab="teams">Teams</button>
                </div>
            </div>

            <!-- Overview Tab -->
            <div class="detail-tab-content active" data-tab="overview">
                <section class="overview-section">
                    <h2 class="overview-section-title">About This Tournament</h2>
                    {% if ctx.desc_html %}
                    <div class="overview-description">{{ ctx.desc_html|safe }}</div>
                    {% else %}
                    <div class="overview-description">
                        <p>Welcome to {{ ctx.title|default:"this tournament" }}! Get ready for an exciting competition where skill meets strategy.</p>
                        <p>Compete against players from across the region and prove your dominance in {{ ctx.game|default:"your favorite game" }}.</p>
                    </div>
                    {% endif %}

                    <div class="overview-grid">
                        <div class="overview-card">
                            <div class="overview-card-icon"></div>
                            <div class="overview-card-title">Format</div>
                            <div class="overview-card-value">{{ ctx.format.type|default:"Single Elimination"|title }}</div>
                            <div class="overview-card-label">Tournament Style</div>
                        </div>

                        <div class="overview-card">
                            <div class="overview-card-icon"></div>
                            <div class="overview-card-title">Team Size</div>
                            <div class="overview-card-value">
                                {% if ctx.format.team_min and ctx.format.team_max %}
                                    {{ ctx.format.team_min }}{{ ctx.format.team_max }}
                                {% else %}
                                    {{ ctx.format.team_min|default:ctx.format.team_max|default:"1" }}
                                {% endif %}
                            </div>
                            <div class="overview-card-label">Players per Team</div>
                        </div>

                        <div class="overview-card">
                            <div class="overview-card-icon"></div>
                            <div class="overview-card-title">Best of</div>
                            <div class="overview-card-value">Bo{{ ctx.format.best_of|default:"1" }}</div>
                            <div class="overview-card-label">Match Format</div>
                        </div>

                        {% if ctx.format.check_in_required %}
                        <div class="overview-card">
                            <div class="overview-card-icon"></div>
                            <div class="overview-card-title">Check-in</div>
                            <div class="overview-card-value">Required</div>
                            <div class="overview-card-label">Before Matches</div>
                        </div>
                        {% endif %}
                    </div>
                </section>
            </div>

            <!-- Rules Tab -->
            <div class="detail-tab-content" data-tab="rules">
                <div class="rules-content">
                    <section class="rules-section">
                        <h3 class="rules-section-title">General Rules</h3>
                        {% if ctx.rules.text %}
                        <div class="rules-list">
                            {{ ctx.rules.text|safe }}
                        </div>
                        {% else %}
                        <ul class="rules-list">
                            <li>Registration must be completed before the deadline</li>
                            <li>All players must be registered and verified</li>
                            <li>Check-in is required 30 minutes before match time</li>
                            <li>No substitutions allowed during matches</li>
                            <li>Report technical issues immediately to admins</li>
                        </ul>
                        {% endif %}
                    </section>

                    {% if ctx.rules.extra %}
                    <section class="rules-section">
                        <h3 class="rules-section-title">Additional Rules</h3>
                        <div class="rules-list">
                            {{ ctx.rules.extra|safe }}
                        </div>
                    </section>
                    {% endif %}

                    {% if ctx.pdf_viewer %}
                    <section class="rules-section">
                        <h3 class="rules-section-title">Complete Rules PDF</h3>
                        {% include "tournaments/partials/_pdf_viewer.html" with cfg=ctx.pdf_viewer %}
                    </section>
                    {% endif %}
                </div>
            </div>

            <!-- Prizes Tab -->
            <div class="detail-tab-content" data-tab="prizes">
                {% if ctx.prize_pool %}
                <div class="prizes-pool">
                    <div class="prizes-pool-label">Total Prize Pool</div>
                    <div class="prizes-pool-value">{{ ctx.prize_pool|intcomma }}</div>
                </div>
                {% endif %}

                <div class="prizes-distribution">
                    {% if ctx.prizes %}
                        {% for prize in ctx.prizes %}
                        <div class="prize-item {% if prize.place == 1 %}first{% elif prize.place == 2 %}second{% elif prize.place == 3 %}third{% endif %}">
                            <div class="prize-rank">
                                {% if prize.place == 1 %}
                                <div class="prize-medal"></div>
                                {% elif prize.place == 2 %}
                                <div class="prize-medal"></div>
                                {% elif prize.place == 3 %}
                                <div class="prize-medal"></div>
                                {% else %}
                                <div class="prize-position">#{{ prize.place }}</div>
                                {% endif %}
                            </div>
                            <div class="prize-amount">
                                {% if prize.cash %}{{ prize.cash|intcomma }}{% endif %}
                                {% if prize.coin %} + Δ {{ prize.coin }}{% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="prize-item first">
                            <div class="prize-rank">
                                <div class="prize-medal"></div>
                            </div>
                            <div class="prize-amount">50% of Prize Pool</div>
                        </div>
                        <div class="prize-item second">
                            <div class="prize-rank">
                                <div class="prize-medal"></div>
                            </div>
                            <div class="prize-amount">30% of Prize Pool</div>
                        </div>
                        <div class="prize-item third">
                            <div class="prize-rank">
                                <div class="prize-medal"></div>
                            </div>
                            <div class="prize-amount">20% of Prize Pool</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="detail-tab-content" data-tab="schedule">
                <div class="schedule-timeline">
                    {% if ctx.schedule.reg_open %}
                    <div class="schedule-item {% if ctx.schedule.reg_open < now %}completed{% endif %}">
                        <div class="schedule-date">{{ ctx.schedule.reg_open|date:"M j, H:i" }}</div>
                        <div class="schedule-title">Registration Opens</div>
                        <div class="schedule-description">Tournament registration becomes available</div>
                    </div>
                    {% endif %}

                    {% if ctx.schedule.reg_close %}
                    <div class="schedule-item {% if ctx.schedule.reg_close < now %}completed{% endif %}">
                        <div class="schedule-date">{{ ctx.schedule.reg_close|date:"M j, H:i" }}</div>
                        <div class="schedule-title">Registration Closes</div>
                        <div class="schedule-description">Final deadline for team registration</div>
                    </div>
                    {% endif %}

                    {% if ctx.schedule.checkin_open %}
                    <div class="schedule-item {% if ctx.schedule.checkin_open < now %}completed{% endif %}">
                        <div class="schedule-date">{{ ctx.schedule.checkin_open|date:"M j, H:i" }}</div>
                        <div class="schedule-title">Check-in Opens</div>
                        <div class="schedule-description">Players can check-in for their matches</div>
                    </div>
                    {% endif %}

                    {% if ctx.schedule.starts_at %}
                    <div class="schedule-item {% if ctx.schedule.starts_at < now %}completed{% else %}upcoming{% endif %}">
                        <div class="schedule-date">{{ ctx.schedule.starts_at|date:"M j, H:i" }}</div>
                        <div class="schedule-title">Tournament Starts</div>
                        <div class="schedule-description">First matches begin</div>
                    </div>
                    {% endif %}

                    {% if ctx.schedule.ends_at %}
                    <div class="schedule-item">
                        <div class="schedule-date">{{ ctx.schedule.ends_at|date:"M j, H:i" }}</div>
                        <div class="schedule-title">Tournament Ends</div>
                        <div class="schedule-description">Final matches and winner announcement</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Teams Tab -->
            <div class="detail-tab-content" data-tab="teams">
                <div id="teams-container">
                    <div class="teams-loading">
                        <div class="detail-skeleton detail-skeleton-title"></div>
                        <div class="teams-grid">
                            {% for i in "123456" %}
                            <div class="team-card">
                                <div class="detail-skeleton" style="height: 48px; width: 48px; border-radius: 8px;"></div>
                                <div class="detail-skeleton detail-skeleton-title" style="width: 80%;"></div>
                                <div class="detail-skeleton detail-skeleton-text" style="width: 60%;"></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sidebar -->
        <aside class="detail-sidebar" id="registration">
            <div class="detail-registration-card">
                <!-- Price Card -->
                <div class="detail-registration-price">
                    <div class="detail-registration-price-label">Entry Fee</div>
                    <div class="detail-registration-price-value {% if ctx.entry_fee == 0 %}free{% endif %}">
                        {% if ctx.entry_fee is not None %}
                            {% if ctx.entry_fee == 0 %}FREE{% else %}{{ ctx.entry_fee|intcomma }}{% endif %}
                        {% else %}TBA{% endif %}
                    </div>
                </div>

                <!-- Phase B: Countdown Timer -->
                {% if ctx.hero.countdown and ctx.hero.countdown.target_iso %}
                <div class="countdown-timer"
                     data-countdown-type="registration-close"
                     data-target-time="{{ ctx.hero.countdown.target_iso }}"
                     data-tournament-slug="{{ ctx.t.slug }}">
                </div>
                {% endif %}

                <!-- Phase B: Capacity Bar -->
                {% if ctx.slots.capacity %}
                <div class="detail-sidebar-capacity">
                    <div class="detail-capacity-label">Registration Progress</div>
                    <div class="detail-capacity-bar">
                        {% widthratio ctx.slots.current|default:0 ctx.slots.capacity 100 as capacity_percent %}
                        <div class="detail-capacity-fill {% if capacity_percent >= 80 %}warning{% elif capacity_percent >= 100 %}full{% endif %}"
                             style="width: {{ capacity_percent }}%"></div>
                    </div>
                    <div class="detail-capacity-text">
                        <span>{{ ctx.slots.current|default:0 }} teams registered</span>
                        <span>{{ ctx.slots.capacity|default:0 }} total capacity</span>
                    </div>
                </div>
                {% endif %}

                <!-- Benefits -->
                <ul class="detail-registration-benefits">
                    <li>Easy online registration</li>
                    <li>Verified payout system</li>
                    <li>Public tournament standings</li>
                    <li>24/7 support available</li>
                    {% if ctx.format.check_in_required %}<li>Check-in required before matches</li>{% endif %}
                </ul>

                <!-- Registration Button -->
                <button class="detail-registration-btn" id="registration-btn">
                    Register Now
                </button>

                <!-- Registration Status -->
                {% if ctx.ui.user_registration %}
                <div class="detail-registration-status">
                    <i class="fa-solid fa-check-circle"></i> You are registered for this tournament
                </div>
                {% endif %}

                <!-- Share -->
                <div class="detail-share">
                    <div class="detail-share-title">Share Tournament</div>
                    <div class="detail-share-buttons">
                        <button class="detail-share-btn" onclick="shareOnTwitter()">
                            <i class="fa-brands fa-twitter"></i>
                        </button>
                        <button class="detail-share-btn" onclick="shareOnFacebook()">
                            <i class="fa-brands fa-facebook"></i>
                        </button>
                        <button class="detail-share-btn" onclick="copyLink()">
                            <i class="fa-solid fa-link"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Scripts -->
<script src="{% static 'js/tournaments-v2-detail.js' %}?v=2"></script>
<script src="{% static 'js/countdown-timer.js' %}?v=1"></script>
<script src="{% static 'js/tournament-state-poller.js' %}?v=2"></script>
{% if ctx.pdf_viewer %}
<script src="{% static 'siteui/pdfjs/pdf.js' %}"></script>
<script>window.pdfjsLib && (window.pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'siteui/pdfjs/pdf.worker.js' %}");</script>
<script src="{% static 'siteui/js/pdfjs-init.js' %}?v=1"></script>
{% endif %}

<script>
// Initialize tournament detail page
document.addEventListener('DOMContentLoaded', function() {
    if (window.TournamentDetailV2) {
        window.TournamentDetailV2.init({
            tournamentSlug: '{{ ctx.t.slug }}',
            currentTab: 'overview',
            isRegistered: {{ ctx.ui.user_registration|lower }}
        });
    }
});

// Share functions
function shareTournament() {
    if (navigator.share) {
        navigator.share({
            title: '{{ ctx.title|default:"Tournament" }}',
            text: 'Check out this tournament on DeltaCrown!',
            url: window.location.href
        });
    } else {
        copyLink();
    }
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('Check out this tournament on DeltaCrown! #DeltaCrown #Esports');
    window.open(https://twitter.com/intent/tweet?url=&text=, '_blank');
}

function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(https://www.facebook.com/sharer/sharer.php?u=, '_blank');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        showToast('Link copied to clipboard!', 'success');
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 	oast toast-;
    toast.textContent = message;
    toast.style.cssText = 
        position: fixed;
        top: 20px;
        right: 20px;
        background: ;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    ;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
.toast {
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}
</style>
{% endblock %}
