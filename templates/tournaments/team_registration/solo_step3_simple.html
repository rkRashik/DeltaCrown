{% extends "tournaments/team_registration/base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .payment-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    
    .entry-fee-display {
        background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        padding: 1.5rem;
        border-radius: 0.75rem;
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .fee-amount {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
    }
    
    .fee-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    .payment-methods {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .method-option {
        position: relative;
    }
    
    .method-option input[type="radio"] {
        position: absolute;
        opacity: 0;
    }
    
    .method-label {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        min-height: 120px;
    }
    
    .method-option input[type="radio"]:checked + .method-label {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.2));
        border-color: #3b82f6;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        transform: translateY(-2px);
    }
    
    .method-label i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
    }
    
    .method-label .method-name {
        font-size: 0.875rem;
        font-weight: 600;
        color: #e2e8f0;
    }
    
    .deltacoin-label {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(249, 115, 22, 0.1));
    }
    
    .method-option input[type="radio"]:checked + .deltacoin-label {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(249, 115, 22, 0.2));
        border-color: #eab308;
        box-shadow: 0 0 20px rgba(234, 179, 8, 0.4);
    }
    
    .deltacoin-balance {
        font-size: 0.75rem;
        color: #22c55e;
        margin-top: 0.25rem;
    }
    
    .cash-fields {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        color: #e2e8f0;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .form-label .required {
        color: #ef4444;
    }
    
    .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 0.5rem;
        color: #e2e8f0;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-input.error {
        border-color: #ef4444;
    }
    
    .form-input.success {
        border-color: #22c55e;
    }
    
    .field-hint {
        font-size: 0.75rem;
        color: #94a3b8;
        margin-top: 0.375rem;
    }
    
    .field-error {
        font-size: 0.75rem;
        color: #ef4444;
        margin-top: 0.375rem;
        display: none;
    }
    
    .field-error.show {
        display: block;
    }
    
    .field-success {
        font-size: 0.75rem;
        color: #22c55e;
        margin-top: 0.375rem;
        display: none;
    }
    
    .field-success.show {
        display: flex;
        align-items: center;
    }
    
    .upload-box {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .upload-box:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #3b82f6;
        margin-bottom: 1rem;
    }
    
    .image-preview {
        margin-top: 1rem;
        max-width: 100%;
        max-height: 200px;
        border-radius: 0.5rem;
        display: none;
    }
    
    .image-preview.show {
        display: block;
    }
    
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="payment-card">
    <!-- Entry Fee Display -->
    <div class="entry-fee-display">
        <div class="fee-amount">à§³ {{ entry_fee }} BDT</div>
        <div class="fee-label">Entry Fee</div>
    </div>
    
    <form id="paymentForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="step" value="3">
        
        <!-- Payment Method Selection -->
        <div class="form-group">
            <label class="form-label">Choose Payment Method <span class="required">*</span></label>
            
            <div class="payment-methods">
                <div class="method-option">
                    <input type="radio" name="payment_method" id="bkash" value="bKash" checked>
                    <label for="bkash" class="method-label">
                        <span style="color: #e91e63; font-size: 2rem; font-weight: bold;">bK</span>
                        <span class="method-name">bKash</span>
                    </label>
                </div>
                
                <div class="method-option">
                    <input type="radio" name="payment_method" id="nagad" value="Nagad">
                    <label for="nagad" class="method-label">
                        <span style="color: #ff6b00; font-size: 2rem; font-weight: bold;">N</span>
                        <span class="method-name">Nagad</span>
                    </label>
                </div>
                
                <div class="method-option">
                    <input type="radio" name="payment_method" id="rocket" value="Rocket">
                    <label for="rocket" class="method-label">
                        <span style="color: #8b4789; font-size: 2rem; font-weight: bold;">R</span>
                        <span class="method-name">Rocket</span>
                    </label>
                </div>
                
                <div class="method-option">
                    <input type="radio" name="payment_method" id="bank" value="Bank Transfer">
                    <label for="bank" class="method-label">
                        <i class="fas fa-university" style="color: #3b82f6;"></i>
                        <span class="method-name">Bank Transfer</span>
                    </label>
                </div>
                
                <div class="method-option">
                    <input type="radio" name="payment_method" id="deltacoin" value="DeltaCoin">
                    <label for="deltacoin" class="method-label deltacoin-label">
                        <i class="fas fa-coins" style="color: #eab308;"></i>
                        <span class="method-name">DeltaCoin</span>
                        <span class="deltacoin-balance">Balance: 1,250 DC</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Cash Payment Fields (Hidden for DeltaCoin) -->
        <div id="cashFields" class="cash-fields">
            <div class="form-group">
                <label for="transaction_id" class="form-label">
                    Transaction ID / Reference Number <span class="required">*</span>
                </label>
                <input 
                    type="text" 
                    id="transaction_id" 
                    name="transaction_id" 
                    class="form-input"
                    placeholder="Type your TRX ID"
                    minlength="6"
                >
                <div class="field-hint">ðŸ‘‰ Find this on your payment receipt</div>
                <div class="field-error" id="trxError">Transaction ID must be at least 6 characters</div>
                <div class="field-success" id="trxSuccess"><i class="fas fa-check-circle mr-2"></i>Valid transaction ID</div>
            </div>
            
            <div class="form-group">
                <label for="amount_paid" class="form-label">
                    Amount Paid (BDT) <span class="required">*</span>
                </label>
                <input 
                    type="number" 
                    id="amount_paid" 
                    name="amount_paid" 
                    class="form-input"
                    value="{{ entry_fee }}"
                    min="{{ entry_fee }}"
                >
                <div class="field-hint">ðŸ‘‰ Must match entry fee: à§³{{ entry_fee }}</div>
                <div class="field-error" id="amountError">Amount must be exactly à§³{{ entry_fee }}</div>
            </div>
            
            <div class="form-group">
                <label for="screenshot" class="form-label">
                    Upload Payment Screenshot (Image/PDF) <span class="required">*</span>
                </label>
                <div class="upload-box" id="uploadBox">
                    <i class="fas fa-cloud-upload-alt upload-icon"></i>
                    <div style="color: #e2e8f0; font-weight: 600;">Click to upload or drag & drop</div>
                    <div class="field-hint" style="margin-top: 0.5rem;">JPG, PNG, or PDF (max 5MB)</div>
                </div>
                <input 
                    type="file" 
                    id="screenshot" 
                    name="screenshot" 
                    accept="image/jpeg,image/png,application/pdf"
                    class="hidden"
                >
                <img id="imagePreview" class="image-preview" alt="Preview">
                <div class="field-error" id="fileError">Invalid file type or size too large (max 5MB)</div>
            </div>
            
            <div class="form-group">
                <label for="notes" class="form-label">
                    Notes (Optional)
                </label>
                <textarea 
                    id="notes" 
                    name="notes" 
                    rows="3" 
                    class="form-input"
                    placeholder="Anything you want to say?"
                    maxlength="500"
                ></textarea>
                <div class="field-hint"><span id="noteCount">0</span>/500 characters</div>
            </div>
        </div>
        
        <!-- DeltaCoin Confirmation (Hidden by default) -->
        <div id="deltacoinInfo" class="hidden" style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(249, 115, 22, 0.1)); border-radius: 0.75rem; margin-top: 2rem;">
            <div style="font-size: 1.25rem; color: #eab308; margin-bottom: 1rem;">
                <i class="fas fa-coins mr-2"></i>Your Balance: <strong>1,250 DC</strong>
            </div>
            <div style="color: #e2e8f0;">
                ðŸ’³ Click confirm to pay <strong>{{ entry_fee }} DC</strong> instantly
            </div>
        </div>
        
        <!-- Navigation Buttons -->
        <div class="flex justify-between items-center mt-8">
            <a href="?step=2" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
            
            <button type="submit" id="submitBtn" class="px-8 py-3 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-check-circle mr-2"></i>Submit Payment
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Payment method switching
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const cashFields = document.getElementById('cashFields');
    const deltacoinInfo = document.getElementById('deltacoinInfo');
    
    paymentMethods.forEach(method => {
        method.addEventListener('change', function() {
            const isDeltaCoin = this.value === 'DeltaCoin';
            
            if (isDeltaCoin) {
                cashFields.classList.add('hidden');
                deltacoinInfo.classList.remove('hidden');
                // Remove required attributes from cash fields
                document.querySelectorAll('#cashFields input, #cashFields textarea').forEach(input => {
                    input.removeAttribute('required');
                });
            } else {
                cashFields.classList.remove('hidden');
                deltacoinInfo.classList.add('hidden');
                // Add required attributes back
                document.getElementById('transaction_id').setAttribute('required', 'required');
                document.getElementById('amount_paid').setAttribute('required', 'required');
                document.getElementById('screenshot').setAttribute('required', 'required');
            }
        });
    });
    
    // Real-time validation for Transaction ID
    const trxInput = document.getElementById('transaction_id');
    const trxError = document.getElementById('trxError');
    const trxSuccess = document.getElementById('trxSuccess');
    
    trxInput.addEventListener('input', function() {
        const value = this.value.trim();
        
        if (value.length === 0) {
            this.classList.remove('error', 'success');
            trxError.classList.remove('show');
            trxSuccess.classList.remove('show');
        } else if (value.length < 6) {
            this.classList.add('error');
            this.classList.remove('success');
            trxError.classList.add('show');
            trxSuccess.classList.remove('show');
        } else {
            this.classList.remove('error');
            this.classList.add('success');
            trxError.classList.remove('show');
            trxSuccess.classList.add('show');
        }
    });
    
    // Real-time validation for Amount
    const amountInput = document.getElementById('amount_paid');
    const amountError = document.getElementById('amountError');
    const expectedAmount = {{ entry_fee }};
    
    amountInput.addEventListener('input', function() {
        const value = parseFloat(this.value);
        
        if (value !== expectedAmount) {
            this.classList.add('error');
            this.classList.remove('success');
            amountError.classList.add('show');
        } else {
            this.classList.remove('error');
            this.classList.add('success');
            amountError.classList.remove('show');
        }
    });
    
    // File upload handling
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('screenshot');
    const imagePreview = document.getElementById('imagePreview');
    const fileError = document.getElementById('fileError');
    
    uploadBox.addEventListener('click', () => fileInput.click());
    
    uploadBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = '#3b82f6';
        uploadBox.style.background = 'rgba(59, 130, 246, 0.1)';
    });
    
    uploadBox.addEventListener('dragleave', () => {
        uploadBox.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        uploadBox.style.background = 'transparent';
    });
    
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        uploadBox.style.background = 'transparent';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            validateFile(files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            validateFile(e.target.files[0]);
        }
    });
    
    function validateFile(file) {
        const maxSize = 5 * 1024 * 1024; // 5MB
        const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
        
        if (!validTypes.includes(file.type)) {
            fileError.textContent = `Invalid file type: .${file.name.split('.').pop()}. Use JPG, PNG, or PDF.`;
            fileError.classList.add('show');
            imagePreview.classList.remove('show');
            fileInput.classList.add('error');
            return false;
        }
        
        if (file.size > maxSize) {
            const sizeMB = (file.size / 1024 / 1024).toFixed(1);
            fileError.textContent = `File too large: ${sizeMB}MB. Maximum is 5MB.`;
            fileError.classList.add('show');
            imagePreview.classList.remove('show');
            fileInput.classList.add('error');
            return false;
        }
        
        fileError.classList.remove('show');
        fileInput.classList.remove('error');
        fileInput.classList.add('success');
        
        // Show preview for images
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.add('show');
            };
            reader.readAsDataURL(file);
        }
        
        return true;
    }
    
    // Character count for notes
    const notesField = document.getElementById('notes');
    const noteCount = document.getElementById('noteCount');
    
    notesField.addEventListener('input', function() {
        noteCount.textContent = this.value.length;
    });
    
    // Form submission validation
    document.getElementById('paymentForm').addEventListener('submit', function(e) {
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (paymentMethod === 'DeltaCoin') {
            // DeltaCoin - submit directly
            return true;
        }
        
        // Cash payment - validate all fields
        let isValid = true;
        
        const trxValue = trxInput.value.trim();
        if (trxValue.length < 6) {
            trxInput.classList.add('error');
            trxError.classList.add('show');
            isValid = false;
        }
        
        const amountValue = parseFloat(amountInput.value);
        if (amountValue !== expectedAmount) {
            amountInput.classList.add('error');
            amountError.classList.add('show');
            isValid = false;
        }
        
        if (fileInput.files.length === 0) {
            fileError.textContent = 'Please upload a payment screenshot';
            fileError.classList.add('show');
            fileInput.classList.add('error');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            // Scroll to first error
            const firstError = this.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
</script>
{% endblock %}
