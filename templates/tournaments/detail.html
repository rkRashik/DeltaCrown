{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{% firstof tournament.name t.name tournament.title "Tournament" %} — DeltaCrown{% endblock %}
{% block og_title %}{% firstof tournament.name t.name tournament.title "Tournament" %} — DeltaCrown{% endblock %}
{% block og_image %}{% if tournament.banner_url %}{{ tournament.banner_url }}{% else %}{% static 'siteui/svg/logo-deltacrown.svg' %}{% endif %}{% endblock %}
{% block canonical %}<link rel="canonical" href="{{ request.build_absolute_uri }}" />{% endblock %}

{% block content %}
<section class="t-hero">
  <div class="t-hero__media">
    {% if tournament.banner_url %}
      <img src="{{ tournament.banner_url }}" alt="" class="t-hero__img" loading="eager">
    {% elif t and t.banner_url %}
      <img src="{{ t.banner_url }}" alt="" class="t-hero__img" loading="eager">
    {% else %}
      <div class="t-hero__placeholder" aria-hidden="true"></div>
    {% endif %}
    <div class="t-hero__scrim" aria-hidden="true"></div>
  </div>

  <div class="container t-hero__body">
    <div class="t-hero__meta">
      <a href="{% url 'tournaments:list' %}" class="crumb link-nav">← All Tournaments</a>

      <h1 class="t-hero__title crown-text">
        {% firstof tournament.name t.name tournament.title "Tournament" %}
      </h1>

      <ul class="t-hero__chips">
        <li class="chip"><span class="chip__k">Game</span>
          <span class="chip__v">
            {% if tournament and tournament.get_game_display %}{{ tournament.get_game_display }}
            {% elif t and t.get_game_display %}{{ t.get_game_display }}
            {% else %}—{% endif %}
          </span>
        </li>

        <li class="chip"><span class="chip__k">Status</span>
          <span class="chip__v">
            {% if tournament and tournament.get_status_display %}{{ tournament.get_status_display }}
            {% elif t and t.get_status_display %}{{ t.get_status_display }}
            {% else %}—{% endif %}
          </span>
        </li>

        <li class="chip"><span class="chip__k">Entry</span>
          <span class="chip__v">
            {% if tournament.settings and tournament.settings.entry_fee_bdt %}
              ৳{{ tournament.settings.entry_fee_bdt|floatformat:0|intcomma }}
            {% elif tournament.entry_fee_bdt %}
              ৳{{ tournament.entry_fee_bdt|floatformat:0|intcomma }}
            {% else %}Free{% endif %}
          </span>
        </li>

        <li class="chip"><span class="chip__k">Prize</span>
          <span class="chip__v">
            {% if tournament.settings and tournament.settings.prize_pool_bdt %}
              ৳{{ tournament.settings.prize_pool_bdt|floatformat:0|intcomma }}
            {% elif tournament.prize_pool_bdt %}
              ৳{{ tournament.prize_pool_bdt|floatformat:0|intcomma }}
            {% else %}TBA{% endif %}
          </span>
        </li>

        <li class="chip"><span class="chip__k">Starts</span>
          <span class="chip__v">
            {% if tournament.start_at %}{{ tournament.start_at|date:"M d, Y H:i" }}
            {% elif tournament.settings and tournament.settings.start_at %}{{ tournament.settings.start_at|date:"M d, Y H:i" }}
            {% else %}TBA{% endif %}
          </span>
        </li>
      </ul>
      <div class="mt-3">
        {% include "components/_share.html" with title=tournament.name %}
      </div>
    </div>

    <aside class="t-hero__cta glass">
      <div class="t-hero__cta-top">
        <div class="t-countdown" data-countdown
             {% if tournament.start_at %}data-deadline="{{ tournament.start_at|date:'c' }}"
             {% elif tournament.settings and tournament.settings.start_at %}data-deadline="{{ tournament.settings.start_at|date:'c' }}"
             {% endif %}>
          <div class="t-countdown__label" data-countdown-label>Starts in</div>
          <div class="t-countdown__digits" data-countdown-digits>—</div>
        </div>

        <dl class="t-quick grid">
          <div><dt>Format</dt><dd>
            {% if tournament.settings and tournament.settings.get_tournament_type_display %}
              {{ tournament.settings.get_tournament_type_display }}
            {% else %}TBA{% endif %}
          </dd></div>
          <div><dt>Slots</dt><dd>
            {% if tournament.slot_size %}{{ tournament.slot_size }}{% else %}TBA{% endif %}
          </dd></div>
          <div><dt>Check-in</dt><dd>
            {% if tournament.reg_open_at and tournament.reg_close_at %}
              {{ tournament.reg_open_at|date:"M d, H:i" }} → {{ tournament.reg_close_at|date:"M d, H:i" }}
            {% else %}TBA{% endif %}
          </dd></div>
        </dl>
      </div>

      <div class="t-hero__cta-actions">
        {# Always route through the register view; it will show closed UI if needed #}
        {% if tournament.slug %}
          <a class="btn-primary w-full" href="{% url 'tournaments:register' slug=tournament.slug %}">Register</a>
        {% else %}
          <a class="btn-primary w-full" href="{% url 'tournaments:list' %}">Register</a>
        {% endif %}

        <div class="t-trust">
          <span class="t-badge">Secure Payments</span>
          <span class="t-badge">Verified Brackets</span>
          <span class="t-badge">Fast Payouts</span>
        </div>
      </div>
    </aside>
  </div>
</section>

<section class="container py-10 grid lg:grid-cols-3 gap-6">
  <article class="glass p-6 rounded-2xl lg:col-span-2">
    <nav class="t-tabs border-b border-border mb-6">
      <a href="#overview" class="t-tab is-active" data-tab>Overview</a>
      <a href="#rules" class="t-tab" data-tab>Rules</a>
      <a href="#prizes" class="t-tab" data-tab>Prizes</a>
    </nav>

    <section id="overview" class="t-section">
      {% if tournament.settings and tournament.settings.description %}
        <p>{{ tournament.settings.description|linebreaks }}</p>
      {% else %}
        <p class="text-muted">Details coming soon.</p>
      {% endif %}
    </section>

    <section id="rules" class="t-section mt-10">
      <h3 class="font-semibold mb-2">Rules</h3>
      {% if tournament.settings and tournament.settings.rules_pdf %}
        <p class="text-sm">
          <a class="link-nav" href="{{ tournament.settings.rules_pdf.url }}" target="_blank" rel="noopener">Download Rules (PDF)</a>
        </p>
      {% else %}
        <p class="text-muted">Published rules will appear here.</p>
      {% endif %}
    </section>

    <section id="prizes" class="t-section mt-10">
      <h3 class="font-semibold mb-2">Prizes</h3>
      {% if tournament.settings and tournament.settings.prize_distribution_text %}
        <p>{{ tournament.settings.prize_distribution_text|linebreaks }}</p>
      {% elif tournament.settings and tournament.settings.prize_pool_bdt %}
        <p>Total Prize: ৳{{ tournament.settings.prize_pool_bdt|floatformat:0|intcomma }}</p>
      {% elif tournament.prize_pool_bdt %}
        <p>Total Prize: ৳{{ tournament.prize_pool_bdt|floatformat:0|intcomma }}</p>
      {% else %}
        <p class="text-muted">Prize structure coming soon.</p>
      {% endif %}
    </section>
  </article>

  <aside class="space-y-6">
    <div class="glass p-6 rounded-2xl">
      <h3 class="font-semibold mb-3">Event Info</h3>
      {% include "tournaments/partials/_meta.html" with title="Game" value=tournament.get_game_display %}
      {% include "tournaments/partials/_meta.html" with title="Status" value=tournament.get_status_display %}
      {% include "tournaments/partials/_meta.html" with title="Format" value=tournament.settings.get_tournament_type_display %}
      {% include "tournaments/partials/_meta.html" with title="Entry Fee" value=tournament.settings.entry_fee_bdt %}
      {% include "tournaments/partials/_meta.html" with title="Prize Pool" value=tournament.settings.prize_pool_bdt %}
      {% include "tournaments/partials/_meta.html" with title="Start" value=tournament.start_at %}
      {% include "tournaments/partials/_meta.html" with title="Reg Window" value=None %}
      <div class="mt-4 grid grid-cols-2 gap-2">
        {% if tournament.slug %}
          <a class="btn-secondary" href="{% url 'tournaments:bracket_view' slug=tournament.slug %}">Bracket</a>
        {% else %}
          <a class="btn-secondary" href="{% url 'tournaments:list' %}">Bracket</a>
        {% endif %}
        <a class="btn-secondary" href="/pages/community/">Discord</a>
      </div>
    </div>

    <div class="glass p-6 rounded-2xl">
      <h3 class="font-semibold mb-3">Registration</h3>
      <ol class="list-decimal pl-5 text-sm text-muted space-y-1">
        <li>Fill the registration form.</li>
        <li>Pay via bKash/Nagad as instructed.</li>
        <li>Provide sender number & TXN ID.</li>
        <li>We verify and confirm your slot.</li>
      </ol>
      <div class="mt-4">
        {% if tournament.slug %}
          <a class="btn-primary w-full" href="{% url 'tournaments:register' slug=tournament.slug %}">Register</a>
        {% else %}
          <a class="btn-primary w-full" href="{% url 'tournaments:list' %}">Register</a>
        {% endif %}
      </div>
    </div>
  </aside>
</section>
{% endblock %}
