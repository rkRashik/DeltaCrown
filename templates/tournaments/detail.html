{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load core_meta %}

{# --------------------------------------------------------------------
   SEO meta (canonical + Open Graph). No Twitter/X tags, BD-friendly.
   -------------------------------------------------------------------- #}
{% block meta_og %}
  {% with title=t.name desc=t.short_description|default:"Tournament details and bracket." %}
    {% if t.banner %}
      {% meta_tags request title=title description=desc image=t.banner.url %}
    {% else %}
      {% meta_tags request title=title description=desc %}
    {% endif %}
  {% endwith %}
{% endblock %}

{% block title %}{{ t.name }} — DeltaCrown{% endblock %}

{% block content %}
<div class="container py-4">

  {# Header #}
  <header class="mb-3">
    <h1 class="mb-2">{{ t.name }}</h1>
    <p class="text-muted mb-0">
      {% if t.start_at %}Starts: {{ t.start_at|date:"M d, Y h:i A" }}{% endif %}
      {% if t.end_at %} · Ends: {{ t.end_at|date:"M d, Y h:i A" }}{% endif %}
      {% if t.slot_size %} · Slots: {{ t.slot_size|intcomma }}{% endif %}
      {% if t.status %} · Status: <span class="badge bg-secondary">{{ t.status }}</span>{% endif %}
    </p>
  </header>

  {# Share actions (Bangladesh-favored) #}
  <div class="d-flex align-items-center gap-2 my-3" aria-label="Share this page">
    <span class="text-muted">Share:</span>

    <!-- WhatsApp -->
    <a
      class="btn btn-sm btn-outline-secondary"
      href="https://api.whatsapp.com/send?text={{ t.name|urlencode }}%20{{ request.build_absolute_uri|urlencode }}"
      target="_blank" rel="noopener"
    >WhatsApp</a>

    <!-- Facebook -->
    <a
      class="btn btn-sm btn-outline-secondary"
      href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}"
      target="_blank" rel="noopener"
    >Facebook</a>

    <!-- Gmail (mailto) -->
    <a
      class="btn btn-sm btn-outline-secondary"
      href="mailto:?subject={{ t.name|urlencode }}&body={{ request.build_absolute_uri|urlencode }}"
    >Gmail</a>

    <!-- Native share (mobile share sheet) -->
    <button type="button" class="btn btn-sm btn-outline-secondary" id="native-share-btn"
            data-title="{{ t.name }}" data-url="{{ request.build_absolute_uri }}">
      Share…
    </button>

    <!-- Copy link -->
    <button type="button" class="btn btn-sm btn-outline-secondary" id="copy-share-link"
            data-url="{{ request.build_absolute_uri }}">
      Copy link
    </button>
  </div>

  {# Banner #}
  {% if t.banner %}
    <div class="mb-3">
      <img src="{{ t.banner.url }}" alt="{{ t.name }} banner" class="img-fluid rounded">
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <section class="card p-3 h-100">
        <h2 class="h5 mb-2">About</h2>
        {% if t.description %}
          <div class="prose">
            {{ t.description|safe }}
          </div>
        {% else %}
          <p class="text-muted mb-0">No detailed description provided yet.</p>
        {% endif %}
      </section>
    </div>

    <div class="col-12 col-lg-4">
      <aside class="card p-3 h-100">
        <h2 class="h5 mb-2">Quick facts</h2>
        <dl class="row mb-0">
          {% if t.game_name %}<dt class="col-5">Game</dt><dd class="col-7">{{ t.game_name }}</dd>{% endif %}
          {% if t.format_type %}<dt class="col-5">Format</dt><dd class="col-7">{{ t.format_type }}</dd>{% endif %}
          {% if t.reg_open_at %}<dt class="col-5">Reg. opens</dt><dd class="col-7">{{ t.reg_open_at|date:"M d, Y h:i A" }}</dd>{% endif %}
          {% if t.reg_close_at %}<dt class="col-5">Reg. closes</dt><dd class="col-7">{{ t.reg_close_at|date:"M d, Y h:i A" }}</dd>{% endif %}
          {% if t.entry_fee is not None %}<dt class="col-5">Entry fee</dt><dd class="col-7">{{ t.entry_fee|default:"Free" }}</dd>{% endif %}
          {% if t.prize_pool %}<dt class="col-5">Prize pool</dt><dd class="col-7">{{ t.prize_pool }}</dd>{% endif %}
        </dl>
      </aside>
    </div>
  </div>

</div>

{# Small inline script for Share/Copy UX #}
<script>
(function() {
  var copyBtn = document.getElementById('copy-share-link');
  if (copyBtn) {
    copyBtn.addEventListener('click', function() {
      var url = copyBtn.getAttribute('data-url') || window.location.href;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url).then(function(){
          copyBtn.textContent = 'Copied!';
          setTimeout(function(){ copyBtn.textContent = 'Copy link'; }, 1500);
        }).catch(function(){ window.prompt('Copy this URL:', url); });
      } else {
        window.prompt('Copy this URL:', url);
      }
    });
  }

  var shareBtn = document.getElementById('native-share-btn');
  if (shareBtn && navigator.share) {
    shareBtn.addEventListener('click', function() {
      var url = shareBtn.getAttribute('data-url') || window.location.href;
      var title = shareBtn.getAttribute('data-title') || document.title;
      navigator.share({ title: title, url: url }).catch(function(){ /* user canceled */ });
    });
  } else if (shareBtn) {
    // Hide the native share button if not supported
    shareBtn.style.display = 'none';
  }
})();
</script>
{% endblock %}
