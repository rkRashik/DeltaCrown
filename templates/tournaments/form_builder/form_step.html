{% extends "tournaments/base.html" %}
{% load static %}

{# ─────────────────────────────────────────────────────────
   Dynamic Form Builder Step
   Context: tournament, form_html, step, total_steps,
            progress_percentage, enable_autosave, form_title,
            autofill_data, completion_percentage,
            missing_count, update_prompts, team, errors
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}{{ form_title }} — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-2xl mx-auto px-4 sm:px-6 py-8">

  {# ── Progress Bar ── #}
  <div class="mb-8">
    <div class="flex items-center justify-between mb-2">
      <span class="text-xs text-gray-500">Step {{ step }} of {{ total_steps }}</span>
      <span class="text-xs text-dc-cyan font-mono">{{ form_title }}</span>
    </div>
    <div class="h-1 bg-dc-surface rounded-full overflow-hidden">
      <div class="h-full bg-gradient-to-r from-dc-cyan to-dc-purple rounded-full transition-all duration-500"
           style="width: {{ progress_percentage }}%"></div>
    </div>
  </div>

  {# ── Auto-fill Status ── #}
  {% if step == 1 and completion_percentage is not None %}
    <div class="glass rounded-xl p-4 mb-6 {% if completion_percentage >= 80 %}neon-border-cyan{% endif %}">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i data-lucide="zap" class="w-5 h-5 text-dc-cyan"></i>
          <div>
            <p class="text-sm text-white">Auto-fill: {{ completion_percentage }}% complete</p>
            {% if missing_count > 0 %}
              <p class="text-[10px] text-gray-500">{{ missing_count }} field{{ missing_count|pluralize }} need{{ missing_count|pluralize:"s," }} attention</p>
            {% else %}
              <p class="text-[10px] text-green-400">All fields auto-filled</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# ── Errors ── #}
  {% if errors %}
    <div class="rounded-xl p-4 mb-6 bg-red-900/20 border border-red-700/30">
      <p class="text-sm font-medium text-red-400 mb-2">
        <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i> Please fix the following:
      </p>
      <ul class="space-y-1">
        {% for field, error_list in errors.items %}
          {% for error in error_list %}
            <li class="text-xs text-red-300">{{ field }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# ── Dynamic Form Content ── #}
  <div class="glass rounded-xl overflow-hidden">
    <form method="post" enctype="multipart/form-data" id="reg-form" class="p-6">
      {% csrf_token %}
      <input type="hidden" name="step" value="{{ step }}">

      {# Rendered form HTML from FormRenderService #}
      <div class="space-y-4 [&_input]:form-input [&_textarea]:form-textarea [&_select]:form-select [&_label]:block [&_label]:text-xs [&_label]:text-gray-400 [&_label]:mb-1.5">
        {{ form_html|safe }}
      </div>

      {# ── Navigation ── #}
      <div class="flex items-center justify-between mt-8 pt-4 border-t border-dc-border">
        {% if step > 1 %}
          <a href="?step={{ step|add:-1 }}" class="text-sm text-gray-500 hover:text-white transition">
            <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Previous
          </a>
        {% else %}
          <a href="{% url 'tournaments:detail' tournament.slug %}" class="text-sm text-gray-500 hover:text-white transition">
            <i data-lucide="x" class="w-4 h-4 inline mr-1"></i> Cancel
          </a>
        {% endif %}

        <div class="flex items-center gap-3">
          {% if enable_autosave %}
            <button type="submit" name="save_draft" value="1"
                    class="px-4 py-2 text-xs text-gray-400 border border-dc-border rounded-lg hover:bg-white/5 transition">
              <i data-lucide="save" class="w-3 h-3 inline mr-1"></i> Save Draft
            </button>
          {% endif %}

          {% if step < total_steps %}
            <button type="submit"
                    class="px-6 py-3 bg-dc-cyan text-dc-dark font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition shadow-[0_0_20px_rgba(6,182,212,0.3)]">
              Next <i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>
            </button>
          {% else %}
            <button type="submit"
                    class="px-6 py-3 bg-dc-cyan text-dc-dark font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition shadow-[0_0_20px_rgba(6,182,212,0.3)]">
              <i data-lucide="check" class="w-4 h-4 inline mr-1"></i> Submit Registration
            </button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>

</div>

{% endblock %}
