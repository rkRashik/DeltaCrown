{% extends "base.html" %}
{% load static dc_avatar %}

{% block title %}DeltaCrown | Pro Profile - {{ profile_user.username|default:'Player' }}{% endblock %}

{% block extra_css %}
<!-- Google Fonts for profile design -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Tailwind config for profile page -->
<script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', "Liberation Mono", "Courier New", 'monospace'],
                    },
                    colors: {
                        z: {
                            bg: '#030014',       /* Deep Void */
                            panel: '#0F0B1E',    /* Glass Panel */
                            card: '#15102A',     /* Solid Card */
                            cyan: '#00F0FF',     /* Cyber Cyan */
                            purple: '#7B2CBF',   /* Electric Purple */
                            gold: '#FFD60A',     /* Trophy Gold */
                            red: '#FF007A',      /* Alert Red */
                            green: '#10B981',    /* Success Green */
                            accent: '#6366F1'    /* Indigo Accent */
                        }
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                        'card-shine': 'linear-gradient(105deg, transparent 20%, rgba(255,255,255,0.05) 25%, transparent 30%)',
                    },
                    boxShadow: {
                        'neon-cyan': '0 0 20px rgba(0, 240, 255, 0.25)',
                        'neon-purple': '0 0 20px rgba(123, 44, 191, 0.25)',
                        'neon-gold': '0 0 20px rgba(255, 214, 10, 0.25)',
                        'neon-red': '0 0 20px rgba(255, 0, 122, 0.25)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shine': 'shine 3s infinite linear',
                    },
                    keyframes: {
                        shine: {
                            '0%': { backgroundPosition: '200% center' },
                            '100%': { backgroundPosition: '-200% center' },
                        }
                    }
                }
            }
        }
</script>

<style>
    /* Profile page wrapper styling */
    .profile-zenith-wrapper {
        background-color: #030014;
        color: #e2e8f0;
        overflow-x: hidden;
        min-height: 100vh;
                radial-gradient(circle at 10% 20%, rgba(123, 44, 191, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 240, 255, 0.1) 0%, transparent 20%);
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(15, 11, 30, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.07);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        /* Gradient Text */
        .text-gradient-gold {
            background: linear-gradient(to right, #FFD60A, #FF9F0A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .text-gradient-cyan {
            background: linear-gradient(to right, #00F0FF, #0099FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #030014; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00F0FF; }

        /* Grid Layout Fixes */
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: 1fr;
            align-items: start; /* Prevents stretching to equalize height which looks bad when content differs */
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 320px minmax(0, 1fr) 320px;
            }
        }

        /* Tab UI Styles - Rarity & Item Cards */
        .item-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .item-card:hover { 
            transform: translateY(-4px); 
        }
        
        .rarity-legendary { 
            border: 1px solid rgba(255, 214, 10, 0.3); 
            box-shadow: 0 0 15px rgba(255, 214, 10, 0.1); 
        }
        .rarity-legendary:hover { 
            border-color: rgba(255, 214, 10, 0.8); 
            box-shadow: 0 0 25px rgba(255, 214, 10, 0.3); 
        }
        
        .rarity-epic { 
            border: 1px solid rgba(123, 44, 191, 0.3); 
            box-shadow: 0 0 15px rgba(123, 44, 191, 0.1); 
        }
        .rarity-epic:hover { 
            border-color: rgba(123, 44, 191, 0.8); 
            box-shadow: 0 0 25px rgba(123, 44, 191, 0.3); 
        }
        
        .rarity-rare { 
            border: 1px solid rgba(0, 240, 255, 0.3); 
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.1); 
        }
        .rarity-rare:hover { 
            border-color: rgba(0, 240, 255, 0.8); 
            box-shadow: 0 0 25px rgba(0, 240, 255, 0.3); 
        }

        .scrollbar-hide::-webkit-scrollbar { 
            display: none; 
        }
        
        /* Digital Wallet Mesh */
        .wallet-mesh {
            background-color: #000000;
            background-image: 
                radial-gradient(at 100% 0%, hsla(43,100%,49%,0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(43,100%,49%,0.1) 0px, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1h2v2H1V1zm4 0h2v2H5V1zm4 0h2v2H9V1zm4 0h2v2h-2V1zm4 0h2v2h-2V1z' fill='%23FFD60A' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            border: 1px solid rgba(255, 214, 10, 0.3);
            box-shadow: 0 0 30px rgba(255, 214, 10, 0.1);
        }

        /* Fade-in animation */
        @keyframes fadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Slow spin animation for wallet decoration */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 30s linear infinite;
        }

        /* Modal Overlay for Bounty */
        .modal-overlay {
            background: rgba(3, 0, 20, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
    </style>
{% endblock %}

{% block content %}
<!-- Zenith Profile Wrapper for custom background -->
<div class="profile-zenith-wrapper">

    <header class="relative w-full h-[550px] lg:h-[650px] mb-8 group">
        
        <div class="absolute inset-0 w-full h-full overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-t from-z-bg via-z-bg/80 to-transparent z-10"></div>
            {% if profile.banner_url %}
            <img src="{{ profile.banner_url }}" 
                 class="w-full h-full object-cover object-center opacity-60 group-hover:scale-105 transition duration-[3s]" alt="Cover">
            {% endif %}
        </div>

        <div class="absolute bottom-0 left-0 w-full z-20 px-4 md:px-8 pb-8">
            <div class="max-w-[1600px] mx-auto flex flex-col md:flex-row items-end gap-8">
                
                <div class="relative shrink-0">
                    <div class="w-36 h-36 md:w-44 md:h-44 rounded-3xl p-1 bg-gradient-to-br from-z-cyan via-z-purple to-z-red shadow-neon-cyan relative group">
                        {% user_avatar_url profile_user as avatar_url %}
                        <img src="{{ avatar_url }}" 
                             class="w-full h-full object-cover rounded-2xl bg-z-bg" alt="{{ profile_user.username }}">
                        
                        <div class="absolute -bottom-3 -right-3 bg-z-bg p-1 rounded-xl">
                            <div class="bg-z-gold text-black font-black font-display text-sm px-3 py-1 rounded-lg border border-white/20 shadow-neon-gold">
                                LVL {{ user_profile.level|default:"1" }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 mb-2">
                    <div class="flex items-center gap-3 mb-2">
                        {% if user_teams and user_teams.0 %}
                        <span class="bg-white/10 backdrop-blur text-white text-[10px] font-bold px-2 py-0.5 rounded border border-white/10 hover:bg-white/20 cursor-pointer transition">
                            [{{ user_teams.0.tag|upper }}] {{ user_teams.0.name|upper }}
                        </span>
                        {% endif %}
                        {% if user_profile.kyc_status == 'verified' %}
                        <div class="flex items-center gap-1 bg-z-cyan/10 px-2 py-0.5 rounded border border-z-cyan/20">
                            <i class="fa-solid fa-circle-check text-sm text-z-cyan"></i>
                            <span class="text-[10px] text-z-cyan font-bold uppercase">Verified Pro</span>
                        </div>
                        {% endif %}
                    </div>

                    <h1 class="text-5xl md:text-7xl font-display font-bold text-white tracking-tight flex items-end gap-4 leading-none mb-2">
                        {{ profile.display_name|default:profile_user.username }}
                        <span class="text-xl font-mono font-normal text-gray-500 mb-2 tracking-widest">#{{ profile_user.username }}</span>
                    </h1>

                    {% if profile.bio %}
                    <p class="text-gray-300 text-base max-w-2xl font-light leading-relaxed border-l-2 border-z-purple pl-4 my-4">
                        {{ profile.bio }}
                    </p>
                    {% endif %}

                    <div class="flex flex-wrap items-center gap-8 mt-6">
                        <div class="text-center group cursor-pointer" onclick="openFollowersModal()">
                            <div class="text-2xl font-bold text-white group-hover:text-z-cyan transition" data-follower-count>{{ follower_count|default:0 }}</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Followers</div>
                        </div>
                        <div class="text-center group cursor-pointer" onclick="openFollowingModal()">
                            <div class="text-2xl font-bold text-white group-hover:text-z-purple transition">{{ following_count|default:0 }}</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Following</div>
                        </div>
                        <div class="text-center group cursor-pointer">
                            <div class="text-2xl font-bold text-white group-hover:text-z-gold transition">{{ user_stats.total_wins|default:0 }}</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Wins</div>
                        </div>
                        
                        {% if identity_ctx.country_name %}
                        <div class="ml-auto md:ml-0 flex items-center gap-3 px-4 py-2 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 transition cursor-pointer">
                            {% if identity_ctx.country_flag_url %}
                            <img src="{{ identity_ctx.country_flag_url }}" alt="{{ identity_ctx.country_name }} flag" class="w-5 h-4 object-cover rounded-sm">
                            {% endif %}
                            <span class="text-xs text-white font-bold">{{ identity_ctx.country_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="hidden md:flex flex-col gap-3 shrink-0 mb-4">
                    {% if relationship_ctx.show_edit_button %}
                    <a href="{{ settings_url }}" class="bg-z-cyan text-black font-black font-display uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-white hover:scale-105 transition shadow-neon-cyan flex items-center justify-center gap-2">
                        <i class="fa-solid fa-pen"></i> Edit Profile
                    </a>
                    {% else %}
                        {% if relationship_ctx.can_follow %}
                            {% if relationship_ctx.follow_requested %}
                            <button disabled data-follow-btn data-is-following="false" class="bg-gray-500/50 text-white font-bold uppercase tracking-wider px-10 py-4 rounded-xl cursor-not-allowed flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clock"></i> Requested
                            </button>
                            {% else %}
                            <button data-follow-btn data-is-following="false" class="bg-z-cyan text-black font-black font-display uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-white hover:scale-105 transition shadow-neon-cyan flex items-center justify-center gap-2">
                                <i class="fa-solid fa-user-plus"></i> {% if relationship_ctx.is_private_account %}Request Follow{% else %}Follow{% endif %}
                            </button>
                            {% endif %}
                        {% elif relationship_ctx.is_following %}
                        <button data-follow-btn data-is-following="true" class="bg-white/10 text-white font-bold uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-red-500/20 hover:text-red-400 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-user-check"></i> Following
                        </button>
                        {% endif %}
                        {% if relationship_ctx.can_recruit %}
                        <button data-career-deep-link class="bg-z-purple/20 text-z-purple border border-z-purple/50 font-black font-display uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-z-purple hover:text-white transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-file-signature"></i> Recruit
                        </button>
                        {% endif %}
                    {% endif %}
                    <div class="flex gap-2">
                        {% if preferred_contact.href and not relationship_ctx.show_edit_button %}
                        <a href="{{ preferred_contact.href }}" target="_blank" rel="noopener" class="flex-1 bg-z-purple/20 text-z-purple border border-z-purple/50 px-6 py-3 rounded-xl hover:bg-z-purple hover:text-white transition font-bold flex items-center justify-center gap-2">
                            <i class="{{ preferred_contact.icon }}"></i> Connect
                        </a>
                        {% endif %}
                        <button class="bg-white/5 text-white border border-white/10 px-5 py-3 rounded-xl hover:bg-white/10 transition">
                            <i class="fa-solid fa-share-nodes"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <main class="max-w-[1600px] mx-auto px-4 md:px-8 pb-20 dashboard-grid">

        <aside class="space-y-6 order-2 lg:order-1 lg:col-span-1">
            
            {% if is_owner and completion_data %}
            {# UP PHASE 8: Real Profile Completion Widget (Owner Only) #}
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-8 -top-8 bg-gradient-to-br from-z-gold/20 to-transparent w-32 h-32 rounded-full blur-2xl"></div>
                
                <div class="flex justify-between items-center mb-4 relative z-10">
                    <h3 class="text-white font-bold font-display uppercase text-sm tracking-widest">Profile Status</h3>
                    <div class="bg-z-gold/20 text-z-gold px-2 py-1 rounded text-xs font-bold border border-z-gold/30">{{ completion_data.percentage }}%</div>
                </div>
                
                <div class="relative w-full h-3 bg-white/10 rounded-full mb-4 overflow-hidden">
                    <div class="absolute top-0 left-0 h-full bg-gradient-to-r from-z-gold to-[#FF9F0A] rounded-full" style="width: {{ completion_data.percentage }}%"></div>
                </div>
                
                {% if completion_data.next_action %}
                <p class="text-xs text-gray-400 mb-4">
                    Complete your <span class="text-white font-bold">{{ completion_data.next_action.label }}</span> to boost your profile.
                </p>
                <a href="{{ completion_data.next_action.url }}" class="block w-full py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-xs font-bold hover:bg-z-gold hover:text-black hover:border-z-gold transition uppercase text-center">
                    <i class="{{ completion_data.next_action.icon }} mr-2"></i>Complete Now
                </a>
                {% else %}
                <p class="text-xs text-green-400 mb-4">
                    <i class="fa-solid fa-check-circle mr-1"></i> Your profile is 100% complete!
                </p>
                {% endif %}
            </div>
            {% endif %}

            {# UP PHASE 8: Connect Widget - Now Public #}
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center justify-between mb-5 border-b border-white/5 pb-3">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-link text-z-cyan"></i> Connect
                    </h3>
                </div>

                {# Discord-First Row with proper copy button #}
                {% if discord_handle or discord_url %}
                    <div class="mb-4 p-3 rounded-xl bg-gradient-to-r from-z-purple/20 to-transparent border border-z-purple/30 flex items-center justify-between group">
                        <a href="{{ discord_url|default:'https://discord.com/' }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 flex-1 min-w-0 hover:opacity-80 transition">
                            <div class="w-10 h-10 rounded-lg bg-z-purple flex items-center justify-center text-white text-lg shadow-lg">
                                <i class="fa-brands fa-discord"></i>
                            </div>
                            <div>
                                <div class="text-[9px] text-z-purple font-bold uppercase tracking-wider">Discord</div>
                                <div class="text-white font-mono text-sm font-bold">{{ discord_handle|default:"View Profile" }}</div>
                            </div>
                        </a>
                        {% if discord_handle %}
                        <button type="button" 
                                data-copy-text="{{ discord_handle }}" 
                                aria-label="Copy Discord username"
                                class="text-gray-400 hover:text-white transition-colors p-2 flex-shrink-0">
                            <i class="fa-regular fa-copy"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}

                    {# UP.2 FIX PASS #5 PART B+C: Social Platform Grid - Loop through filtered links (exact URLs, no blanks) #}
                    <div class="grid grid-cols-3 gap-2">
                        {% for link in social_links_renderable %}
                            {% if link.platform != 'discord' %}
                                {% if link.platform == 'twitter' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-black/40 hover:border-white/30 transition group" title="Twitter/X">
                                    <span class="text-gray-400 group-hover:text-white text-2xl font-bold mb-1">ùïè</span>
                                </a>
                                {% elif link.platform == 'twitch' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#9146FF]/20 hover:border-[#9146FF]/50 transition group" title="Twitch">
                                    <i class="fa-brands fa-twitch text-gray-400 group-hover:text-[#9146FF] text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'youtube' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#FF0000]/20 hover:border-[#FF0000]/50 transition group" title="YouTube">
                                    <i class="fa-brands fa-youtube text-gray-400 group-hover:text-[#FF0000] text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'facebook' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#1877F2]/20 hover:border-[#1877F2]/50 transition group" title="Facebook">
                                    <i class="fa-brands fa-facebook text-gray-400 group-hover:text-[#1877F2] text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'instagram' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#E4405F]/20 hover:border-[#E4405F]/50 transition group" title="Instagram">
                                    <i class="fa-brands fa-instagram text-gray-400 group-hover:text-[#E4405F] text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'tiktok' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-black/40 hover:border-white/30 transition group" title="TikTok">
                                    <i class="fa-brands fa-tiktok text-gray-400 group-hover:text-white text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'kick' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#53FC18]/20 hover:border-[#53FC18]/50 transition group" title="Kick">
                                    <i class="fa-solid fa-k text-gray-400 group-hover:text-[#53FC18] text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'steam' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-[#171A21]/20 hover:border-white/30 transition group" title="Steam">
                                    <i class="fa-brands fa-steam text-gray-400 group-hover:text-white text-xl mb-1"></i>
                                </a>
                                {% elif link.platform == 'github' %}
                                <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center justify-center p-3 rounded-xl bg-white/5 border border-white/5 hover:bg-black/40 hover:border-white/30 transition group" title="GitHub">
                                    <i class="fa-brands fa-github text-gray-400 group-hover:text-white text-xl mb-1"></i>
                                </a>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    {% if not social_links and not social_links_map.discord %}
                    <div class="text-center text-gray-500 text-xs py-4 italic">No social links connected</div>
                    {% endif %}
            </div>

            {# UP PHASE 8: Gear Widget - Polished UI #}
            <div class="glass-panel p-6 rounded-2xl group cursor-pointer hover:border-z-green/30 transition">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-microchip text-z-green"></i> Gear
                    </h3>
                    <i class="fa-solid fa-arrow-right text-gray-600 -rotate-45 group-hover:text-z-green transition"></i>
                </div>
                <div class="space-y-3">
                    {% if hardware_gears %}
                        {% for gear in hardware_gears %}
                        <div class="flex items-center gap-3">
                            {% if gear.category == 'MOUSE' %}
                            <i class="fa-solid fa-computer-mouse text-gray-500"></i>
                            {% elif gear.category == 'KEYBOARD' %}
                            <i class="fa-regular fa-keyboard text-gray-500"></i>
                            {% elif gear.category == 'HEADSET' %}
                            <i class="fa-solid fa-headphones text-gray-500"></i>
                            {% elif gear.category == 'MONITOR' %}
                            <i class="fa-solid fa-desktop text-gray-500"></i>
                            {% elif gear.category == 'MOUSEPAD' %}
                            <i class="fa-solid fa-square text-gray-500"></i>
                            {% else %}
                            <i class="fa-solid fa-microchip text-gray-500"></i>
                            {% endif %}
                            <span class="text-sm text-white font-bold">{{ gear.brand }} {{ gear.model }}</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-gray-500 text-xs py-2 italic">No gear configured</div>
                    {% endif %}
                </div>
            </div>

            <div class="glass-panel p-0 rounded-2xl overflow-hidden relative group cursor-pointer border border-z-gold/30">
                <div class="absolute inset-0 bg-gradient-to-br from-z-gold/10 via-z-bg to-z-bg group-hover:from-z-gold/20 transition duration-500"></div>
                
                <div class="p-6 relative z-10">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-z-gold/20 flex items-center justify-center border border-z-gold/50 text-z-gold shadow-[0_0_15px_rgba(255,214,10,0.4)]">
                                <i class="fa-solid fa-coins"></i>
                            </div>
                            <span class="text-xs font-bold text-z-gold uppercase tracking-wider">Wallet</span>
                        </div>
                        <i class="fa-solid fa-chevron-right text-xs text-z-gold/50"></i>
                    </div>
                    
                    {% if is_owner %}
                    <div class="mt-4">
                        <div class="text-[10px] text-gray-400 uppercase font-bold">Current Balance</div>
                        <div class="text-3xl font-display font-black text-white flex items-end gap-1">
                            {{ wallet_balance|floatformat:0 }}
                            <span class="text-sm font-sans text-z-gold font-bold mb-1">DC</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-2">
                        <button class="flex-1 py-2 rounded bg-z-gold text-black text-[10px] font-black uppercase hover:bg-white transition">Top Up</button>
                        <button class="flex-1 py-2 rounded bg-white/5 text-white text-[10px] font-black uppercase border border-white/10 hover:bg-white/10 transition">History</button>
                    </div>
                    {% else %}
                    <div class="mt-4 text-center py-6">
                        <i class="fa-solid fa-lock text-3xl text-gray-600 mb-2"></i>
                        <div class="text-xs text-gray-500 italic">Wallet balance is private</div>
                    </div>
                    {% endif %}
                </div>
            </div>

        </aside>


        <section id="center-column" class="space-y-6 order-1 lg:order-2 lg:col-span-1 min-w-0 transition-all duration-500">

            <!-- Tab Navigation -->
            <nav class="flex overflow-x-auto pb-2 scrollbar-hide gap-2 border-b border-white/10 mb-4">
                <button onclick="switchTab('overview')" data-tab="overview" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl bg-z-cyan/10 border-b-2 border-z-cyan text-z-cyan font-bold text-sm tracking-wide shadow-[0_4px_20px_-10px_rgba(0,240,255,0.3)]">Overview</button>
                <button onclick="switchTab('posts')" data-tab="posts" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Posts</button>
                <button onclick="switchTab('career')" data-tab="career" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Career</button>
                <button onclick="switchTab('highlights')" data-tab="highlights" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Highlights</button>
                <button onclick="switchTab('bounty')" data-tab="bounty" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Bounty</button>
                <button onclick="switchTab('inventory')" data-tab="inventory" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Inventory</button>
                {% if relationship_ctx.is_owner %}
                <button onclick="switchTab('economy')" data-tab="economy" class="tab-btn shrink-0 px-6 py-3 rounded-t-xl text-gray-400 hover:text-white hover:bg-white/5 font-medium text-sm transition">Economy</button>
                {% endif %}
            </nav>

            <!-- Tab Content Containers -->
            <div id="tab-overview" class="tab-content">
                {% include "user_profile/profile/tabs/_tab_overview.html" %}
            </div>

            <div id="tab-posts" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_posts.html" %}
            </div>

            <div id="tab-career" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_career.html" %}
            </div>

            <div id="tab-highlights" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_highlights.html" %}
            </div>

            <div id="tab-bounty" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_bounty.html" %}
            </div>

            <div id="tab-inventory" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_inventory.html" %}
            </div>

            {% if relationship_ctx.is_owner %}
            <div id="tab-economy" class="tab-content hidden">
                {% include "user_profile/profile/tabs/_tab_economy.html" %}
            </div>
            {% endif %}

        </section>


        <aside id="right-sidebar" class="space-y-6 order-3 lg:col-span-1 transition-all duration-500">
            
            {# UP PHASE 8: Live Section - Wired to Stream Settings #}
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-tower-broadcast text-z-red"></i> Live
                    </h3>
                </div>
                
                {% if stream_platforms %}
                    {% for platform in stream_platforms %}
                    <div class="mb-3 last:mb-0">
                        <a href="{{ platform.url }}" target="_blank" rel="noopener" class="block bg-black/40 rounded-xl p-4 border border-white/10 hover:border-z-red/50 transition group">
                            <div class="flex items-center gap-3">
                                {% if platform.platform == 'twitch' %}
                                <div class="w-10 h-10 rounded-lg bg-purple-600 flex items-center justify-center text-white">
                                    <i class="fa-brands fa-twitch"></i>
                                </div>
                                {% elif platform.platform == 'youtube' %}
                                <div class="w-10 h-10 rounded-lg bg-red-600 flex items-center justify-center text-white">
                                    <i class="fa-brands fa-youtube"></i>
                                </div>
                                {% elif platform.platform == 'kick' %}
                                <div class="w-10 h-10 rounded-lg bg-green-500 flex items-center justify-center text-white">
                                    <i class="fa-solid fa-k"></i>
                                </div>
                                {% else %}
                                <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white">
                                    <i class="fa-brands fa-facebook"></i>
                                </div>
                                {% endif %}
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs text-gray-400">{{ platform.platform_display }}</div>
                                    <div class="text-white font-bold text-sm truncate">{{ platform.handle|default:'View Channel' }}</div>
                                </div>
                                <div class="text-gray-500 text-xs">
                                    <i class="fa-solid fa-circle-dot text-gray-600"></i> Offline
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="bg-black/40 rounded-xl p-6 border border-white/10 text-center">
                        <i class="fa-solid fa-video-slash text-3xl text-gray-600 mb-2 block"></i>
                        <div class="text-sm text-gray-400 mb-1">No stream configured</div>
                        {% if is_owner %}
                        <a href="/me/settings/#stream" class="text-xs text-z-cyan hover:underline">Add Stream Settings</a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest">Affiliations</h3>
                </div>
                
                {% if user_teams %}
                    {% for team in user_teams %}
                <div class="flex items-center gap-4 p-3 rounded-xl bg-white/5 border border-white/5 hover:border-z-cyan/50 hover:bg-white/10 transition cursor-pointer group mb-2">
                    {% if team.logo_url %}
                    <img src="{{ team.logo_url }}" alt="{{ team.name }}" class="w-12 h-12 rounded-lg object-cover border border-white/10">
                    {% else %}
                    <div class="w-12 h-12 rounded-lg bg-white/10 flex items-center justify-center font-black text-white border border-white/10">{{ team.tag|upper }}</div>
                    {% endif %}
                    <div class="flex-1">
                        <div class="text-white font-bold text-sm group-hover:text-z-cyan transition">{{ team.name }}</div>
                        <div class="text-[10px] text-gray-400">{{ team.role|default:'Member' }}{% if team.game %} ‚Ä¢ {{ team.game }}{% endif %}</div>
                    </div>
                </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-gray-500 text-xs py-4">No team affiliations yet</div>
                {% endif %}
            </div>

            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-400 font-bold text-xs uppercase tracking-widest">Trophies</h3>
                    <i class="fa-solid fa-chevron-right text-xs text-gray-600"></i>
                </div>
                
                <div class="grid grid-cols-4 gap-2">
                    <div class="aspect-square rounded-xl bg-gradient-to-br from-z-gold/20 to-transparent border border-z-gold/30 flex items-center justify-center text-2xl hover:scale-110 transition cursor-help shadow-[0_0_15px_rgba(255,214,10,0.2)]">üèÜ</div>
                    <div class="aspect-square rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-2xl hover:bg-white/10 transition">ü•á</div>
                    <div class="aspect-square rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-2xl hover:bg-white/10 transition">ü•à</div>
                    <div class="aspect-square rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-2xl hover:bg-white/10 transition">ü•â</div>
                </div>
            </div>

            <div class="glass-panel p-0 rounded-2xl overflow-hidden border border-z-red/30 relative group">
                <div class="absolute inset-0 bg-gradient-to-t from-z-red/10 via-z-bg to-z-bg"></div>
                
                <div class="p-6 relative z-10">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-crosshairs text-z-red animate-pulse"></i>
                            <span class="text-xs font-bold text-z-red uppercase tracking-wider">Active Bounty</span>
                        </div>
                        <div class="text-[10px] text-white bg-z-red px-2 py-0.5 rounded font-bold">HARD</div>
                    </div>
                    
                    <h4 class="text-white font-bold text-sm leading-tight mb-2">Headhunter Challenge</h4>
                    <p class="text-[10px] text-gray-400 mb-3">Get 50 Headshots in Ranked matches this week.</p>
                    
                    <div class="flex justify-between text-[10px] text-gray-300 mb-1 font-mono">
                        <span>32 / 50</span>
                        <span>64%</span>
                    </div>
                    <div class="w-full h-1.5 bg-gray-800 rounded-full mb-4">
                        <div class="h-full bg-z-red rounded-full shadow-neon-red" style="width: 64%"></div>
                    </div>

                    <div class="flex items-center justify-between border-t border-white/10 pt-3">
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-z-gold">500</span>
                            <span class="text-[9px] text-gray-400">DC REWARD</span>
                        </div>
                        <button class="text-[10px] text-white hover:text-z-red transition font-bold uppercase">View Details</button>
                    </div>
                </div>
            </div>

        </aside>

    </main>

    <div class="lg:hidden fixed bottom-0 left-0 w-full glass-panel border-t border-white/10 z-50 px-6 py-4 flex justify-between items-center text-2xl text-gray-500 pb-safe">
        <button class="text-z-cyan drop-shadow-[0_0_10px_rgba(0,240,255,0.5)]"><i class="fa-solid fa-user"></i></button>
        <button class="hover:text-white transition"><i class="fa-solid fa-users"></i></button>
        <div class="w-14 h-14 bg-gradient-to-br from-z-cyan to-z-purple rounded-full -mt-10 border-4 border-z-bg flex items-center justify-center text-white shadow-neon-purple hover:scale-110 transition cursor-pointer">
            <i class="fa-solid fa-plus text-xl"></i>
        </div>
        <button class="hover:text-white transition"><i class="fa-solid fa-trophy"></i></button>
        <button class="hover:text-white transition"><i class="fa-solid fa-bars"></i></button>
    </div>

</div>
<!-- End Zenith Profile Wrapper -->

<!-- UP-PHASE8: Instagram-like Followers/Following Modals -->
<!-- Followers Modal -->
<div id="followersModal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="glass-panel w-full max-w-lg m-4 rounded-2xl border border-white/20 overflow-hidden">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="text-xl font-display font-bold text-white">Followers</h3>
            <button onclick="closeFollowersModal()" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        
        <!-- Search Bar -->
        <div class="p-4 border-b border-white/10">
            <input type="text" id="followersSearch" placeholder="Search followers..." 
                   class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-z-cyan transition">
        </div>
        
        <!-- Followers List -->
        <div id="followersList" class="max-h-96 overflow-y-auto">
            <!-- JavaScript will populate this -->
            <div class="flex items-center justify-center py-12">
                <i class="fa-solid fa-spinner fa-spin text-2xl text-gray-500"></i>
            </div>
        </div>
    </div>
</div>

<!-- Following Modal -->
<div id="followingModal" class="hidden fixed inset-0 z-[999] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="glass-panel w-full max-w-lg m-4 rounded-2xl border border-white/20 overflow-hidden">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h3 class="text-xl font-display font-bold text-white">Following</h3>
            <button onclick="closeFollowingModal()" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
        </div>
        
        <!-- Search Bar -->
        <div class="p-4 border-b border-white/10">
            <input type="text" id="followingSearch" placeholder="Search following..." 
                   class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white placeholder-gray-500 focus:outline-none focus:border-z-purple transition">
        </div>
        
        <!-- Following List -->
        <div id="followingList" class="max-h-96 overflow-y-auto">
            <!-- JavaScript will populate this -->
            <div class="flex items-center justify-center py-12">
                <i class="fa-solid fa-spinner fa-spin text-2xl text-gray-500"></i>
            </div>
        </div>
    </div>
</div>
<!-- End Modals -->

{# UP.2 FIX PASS #5 PART A: Clipboard copy JS for Discord button #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Attach clipboard copy to all [data-copy-text] buttons
    const copyButtons = document.querySelectorAll('[data-copy-text]');
    
    copyButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const textToCopy = this.getAttribute('data-copy-text');
            
            if (navigator.clipboard && textToCopy) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Success feedback
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fa-solid fa-check text-green-400"></i>';
                    
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 1500);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Copied: ' + textToCopy);
                });
            }
        });
    });
});
</script>

{# UP PHASE 8: Follow/Unfollow AJAX Handler #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const followBtn = document.querySelector('[data-follow-btn]');
    if (!followBtn) return;
    
    const username = '{{ profile_user.username }}';
    const csrfToken = '{{ csrf_token }}';
    
    // Handle follow/unfollow clicks
    followBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const isFollowing = followBtn.dataset.isFollowing === 'true';
        const action = isFollowing ? 'unfollow' : 'follow';
        const url = `/api/profile/${username}/${action}/`;
        
        // Disable button during request
        followBtn.disabled = true;
        followBtn.style.opacity = '0.6';
        followBtn.style.cursor = 'wait';
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button state
                if (data.is_following) {
                    // Now following
                    followBtn.dataset.isFollowing = 'true';
                    followBtn.innerHTML = '<i class="fa-solid fa-user-check"></i> Following';
                    followBtn.className = 'bg-white/10 text-white font-bold uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-red-500/20 hover:text-red-400 transition flex items-center justify-center gap-2';
                } else if (data.has_pending_request) {
                    // Request sent
                    followBtn.disabled = true;
                    followBtn.innerHTML = '<i class="fa-solid fa-clock"></i> Requested';
                    followBtn.className = 'bg-gray-500/50 text-white font-bold uppercase tracking-wider px-10 py-4 rounded-xl cursor-not-allowed flex items-center justify-center gap-2';
                } else {
                    // Not following
                    followBtn.dataset.isFollowing = 'false';
                    followBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i> Follow';
                    followBtn.className = 'bg-z-cyan text-black font-black font-display uppercase tracking-wider px-10 py-4 rounded-xl hover:bg-white hover:scale-105 transition shadow-neon-cyan flex items-center justify-center gap-2';
                }
                
                // Update follower count if visible
                if (data.show_follower_count) {
                    const followerCountEl = document.querySelector('[data-follower-count]');
                    if (followerCountEl) {
                        followerCountEl.textContent = data.follower_count.toLocaleString();
                    }
                }
                
                // Show toast notification
                showToast(data.message, 'success');
            } else {
                showToast(data.error || 'An error occurred', 'error');
            }
        })
        .catch(error => {
            console.error('Follow error:', error);
            showToast('Network error. Please try again.', 'error');
        })
        .finally(() => {
            // Re-enable button
            followBtn.disabled = false;
            followBtn.style.opacity = '1';
            followBtn.style.cursor = 'pointer';
        });
    });
    
    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed bottom-8 right-8 z-[9999] px-6 py-4 rounded-xl shadow-2xl transform translate-y-0 transition-all duration-300 ${
            type === 'success' ? 'bg-green-500/90 text-white' : 'bg-red-500/90 text-white'
        }`;
        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-xl"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transform = 'translateY(100px)';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Deep link to Career tab
    const careerDeepLinkBtns = document.querySelectorAll('[data-career-deep-link]');
    careerDeepLinkBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            // Switch to Career tab
            if (window.switchTab) {
                window.switchTab('career');
                // Scroll to top of career section
                setTimeout(() => {
                    const careerTab = document.getElementById('tab-career');
                    if (careerTab) {
                        careerTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        });
    });
});
</script>

{# UP-PHASE8: Followers/Following Modal Functions #}
<script>
const currentUsername = '{{ profile_user.username }}';
const csrfToken = '{{ csrf_token }}';

// Open Followers Modal
window.openFollowersModal = function() {
    const modal = document.getElementById('followersModal');
    if (modal) {
        modal.classList.remove('hidden');
        loadFollowersList();
    }
};

// Open Following Modal
window.openFollowingModal = function() {
    const modal = document.getElementById('followingModal');
    if (modal) {
        modal.classList.remove('hidden');
        loadFollowingList();
    }
};

// Close Followers Modal
window.closeFollowersModal = function() {
    const modal = document.getElementById('followersModal');
    if (modal) {
        modal.classList.add('hidden');
    }
};

// Close Following Modal
window.closeFollowingModal = function() {
    const modal = document.getElementById('followingModal');
    if (modal) {
        modal.classList.add('hidden');
    }
};

// Load Followers List
async function loadFollowersList() {
    const container = document.getElementById('followersList');
    container.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fa-solid fa-spinner fa-spin text-2xl text-gray-500"></i></div>';
    
    try {
        const response = await fetch(`/api/profile/${currentUsername}/followers/`);
        const data = await response.json();
        
        if (data.success && data.followers) {
            if (data.followers.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400">No followers yet</div>';
                return;
            }
            
            container.innerHTML = data.followers.map(user => createUserCard(user)).join('');
            setupSearch('followersSearch', 'followersList');
        } else if (data.error) {
            container.innerHTML = `<div class="text-center py-12 text-gray-400">${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading followers:', error);
        container.innerHTML = '<div class="text-center py-12 text-gray-400">Error loading followers</div>';
    }
}

// Load Following List
async function loadFollowingList() {
    const container = document.getElementById('followingList');
    container.innerHTML = '<div class="flex items-center justify-center py-12"><i class="fa-solid fa-spinner fa-spin text-2xl text-gray-500"></i></div>';
    
    try {
        const response = await fetch(`/api/profile/${currentUsername}/following/`);
        const data = await response.json();
        
        if (data.success && data.following) {
            if (data.following.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-400">Not following anyone yet</div>';
                return;
            }
            
            container.innerHTML = data.following.map(user => createUserCard(user)).join('');
            setupSearch('followingSearch', 'followingList');
        } else if (data.error) {
            container.innerHTML = `<div class="text-center py-12 text-gray-400">${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading following:', error);
        container.innerHTML = '<div class="text-center py-12 text-gray-400">Error loading following list</div>';
    }
}

// Create User Card HTML
function createUserCard(user) {
    const isViewer = user.is_viewer;
    const isFollowing = user.is_followed_by_viewer;
    
    let buttonHTML = '';
    if (!isViewer) {
        if (isFollowing) {
            buttonHTML = `<button onclick="handleModalFollow('${user.username}', false, this)" class="px-4 py-1.5 text-xs font-bold bg-white/10 text-white rounded-lg hover:bg-red-500/20 hover:text-red-400 transition">Following</button>`;
        } else {
            buttonHTML = `<button onclick="handleModalFollow('${user.username}', true, this)" class="px-4 py-1.5 text-xs font-bold bg-z-cyan text-black rounded-lg hover:bg-white transition">Follow</button>`;
        }
    }
    
    return `
        <div class="flex items-center justify-between p-4 hover:bg-white/5 transition border-b border-white/5">
            <a href="${user.profile_url}" class="flex items-center gap-3 flex-1">
                <img src="${user.avatar_url || ''}" 
                     alt="${user.display_name}" 
                     class="w-12 h-12 rounded-full border border-white/10">
                <div>
                    <div class="font-bold text-white hover:text-z-cyan transition">${user.display_name}</div>
                    <div class="text-sm text-gray-400">@${user.username}</div>
                </div>
            </a>
            ${buttonHTML}
        </div>
    `;
}

// Handle Follow/Unfollow in Modal
async function handleModalFollow(username, isFollowAction, button) {
    const action = isFollowAction ? 'follow' : 'unfollow';
    button.disabled = true;
    button.style.opacity = '0.5';
    
    try {
        const response = await fetch(`/api/profile/${username}/${action}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (isFollowAction) {
                button.textContent = 'Following';
                button.className = 'px-4 py-1.5 text-xs font-bold bg-white/10 text-white rounded-lg hover:bg-red-500/20 hover:text-red-400 transition';
                button.onclick = function() { handleModalFollow(username, false, this); };
            } else {
                button.textContent = 'Follow';
                button.className = 'px-4 py-1.5 text-xs font-bold bg-z-cyan text-black rounded-lg hover:bg-white transition';
                button.onclick = function() { handleModalFollow(username, true, this); };
            }
        }
    } catch (error) {
        console.error('Error:', error);
    } finally {
        button.disabled = false;
        button.style.opacity = '1';
    }
}

// Setup Search Filter
function setupSearch(inputId, containerId) {
    const input = document.getElementById(inputId);
    const container = document.getElementById(containerId);
    
    if (!input || !container) return;
    
    input.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const cards = container.querySelectorAll('.flex.items-center');
        
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });
    });
}

// Close modals on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFollowersModal();
        closeFollowingModal();
    }
});

// Close modals on backdrop click
document.getElementById('followersModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeFollowersModal();
});
document.getElementById('followingModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeFollowingModal();
});
</script>

{# Phase 4: Tab System with Wide Mode Support #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get references to key elements
    const centerColumn = document.getElementById('center-column');
    const rightSidebar = document.getElementById('right-sidebar');
    
    // Global tab switching function
    window.switchTab = function(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });
        
        // Remove active state from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-z-cyan/10', 'border-b-2', 'border-z-cyan', 'text-z-cyan', 'shadow-[0_4px_20px_-10px_rgba(0,240,255,0.3)]');
            btn.classList.add('text-gray-400');
        });
        
        // Show selected tab content
        const selectedContent = document.getElementById('tab-' + tabName);
        if (selectedContent) {
            selectedContent.classList.remove('hidden');
        }
        
        // Activate selected tab button
        const selectedBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('bg-z-cyan/10', 'border-b-2', 'border-z-cyan', 'text-z-cyan', 'shadow-[0_4px_20px_-10px_rgba(0,240,255,0.3)]');
            selectedBtn.classList.remove('text-gray-400');
        }
        
        // Handle Wide Mode for Career tab
        if (tabName === 'career') {
            // Enable Wide Mode
            if (rightSidebar) {
                rightSidebar.classList.add('hidden');
            }
            if (centerColumn) {
                centerColumn.classList.remove('lg:col-span-1');
                centerColumn.classList.add('lg:col-span-2');
            }
        } else if (tabName === 'bounty') {
            // Enable Wide Mode for Bounty
            if (rightSidebar) {
                rightSidebar.classList.add('hidden');
            }
            if (centerColumn) {
                centerColumn.classList.remove('lg:col-span-1');
                centerColumn.classList.add('lg:col-span-2');
            }
        } else {
            // Restore Normal Mode
            if (rightSidebar) {
                rightSidebar.classList.remove('hidden');
            }
            if (centerColumn) {
                centerColumn.classList.remove('lg:col-span-2');
                centerColumn.classList.add('lg:col-span-1');
            }
        }
    };
    
    // Initialize: ensure Overview is active on page load
    // (already set in HTML, but this ensures consistency)
    
    // Bounty Modal Functions
    window.openBountyModal = function(title, reward) {
        const modal = document.getElementById('modal-bounty-challenge');
        const modalContent = document.getElementById('modal-bounty-content');
        
        if (!modal || !modalContent) return;
        
        document.getElementById('modal-bounty-title').innerText = title || 'Contract';
        document.getElementById('modal-bounty-reward').innerText = (reward || 0) + ' DC';
        
        modal.classList.remove('hidden');
        // Slight delay for animation
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
        }, 10);
    };
    
    window.closeBountyModal = function() {
        const modal = document.getElementById('modal-bounty-challenge');
        const modalContent = document.getElementById('modal-bounty-content');
        
        if (!modal || !modalContent) return;
        
        modal.classList.add('opacity-0');
        modalContent.classList.add('scale-95');
        modalContent.classList.remove('scale-100');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    };
});
</script>

{% endblock %}
T h u r s d a y ,   J a n u a r y   1 5 ,   2 0 2 6   1 : 0 0 : 2 5   P M 