{% extends "base.html" %}
{% load static %}

{% block title %}Control Deck | DeltaCrown{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    /* --- CORE PHYSICS --- */
    body { 
        overflow-x: hidden;
        background-image: 
            radial-gradient(circle at 15% 50%, rgba(123, 44, 191, 0.08), transparent 25%),
            radial-gradient(circle at 85% 30%, rgba(0, 240, 255, 0.05), transparent 25%);
        background-attachment: fixed;
    }

    /* Glass Panel */
    .glass-panel {
        background: rgba(15, 11, 30, 0.6);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Input Styling */
    .z-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 14px 16px;
        color: white;
        font-size: 0.95rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .z-input:focus {
        outline: none;
        border-color: #00F0FF;
        box-shadow: 0 0 0 4px rgba(0, 240, 255, 0.1);
        background: rgba(0, 240, 255, 0.02);
    }
    .z-label {
        display: flex; align-items: center; gap: 6px;
        font-size: 0.75rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.05em;
        color: #94a3b8; margin-bottom: 8px;
    }

    /* NEW LIQUID TOGGLE (Bug Free) */
    .z-toggle-wrapper {
        position: relative; display: inline-block; width: 48px; height: 26px;
    }
    .z-toggle-input {
        opacity: 0; width: 0; height: 0;
    }
    .z-toggle-slider {
        position: absolute; cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #334155;
        transition: .4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 34px;
    }
    .z-toggle-slider:before {
        position: absolute; content: "";
        height: 20px; width: 20px;
        left: 3px; bottom: 3px;
        background-color: white;
        transition: .4s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .z-toggle-input:checked + .z-toggle-slider {
        background-color: #00F0FF;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
    }
    .z-toggle-input:checked + .z-toggle-slider:before {
        transform: translateX(22px);
        background-color: #030014;
    }

    /* HOLO-TIP (Contextual Help) */
    .holo-tip-trigger {
        color: #00F0FF; cursor: help; transition: 0.2s;
    }
    .holo-tip-content {
        visibility: hidden; opacity: 0;
        position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%) translateY(10px);
        width: 260px; padding: 12px;
        background: rgba(10, 10, 20, 0.95);
        border: 1px solid rgba(0, 240, 255, 0.3);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        z-index: 50;
        text-transform: none; text-align: left;
        transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
    }
    .holo-tip-trigger:hover .holo-tip-content {
        visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0);
    }
    .holo-tip-content h5 { color: #00F0FF; font-weight: 700; font-size: 0.8rem; margin-bottom: 4px; }
    .holo-tip-content p { color: #cbd5e1; font-weight: 400; font-size: 0.75rem; line-height: 1.4; }

    /* Navigation */
    .nav-btn {
        width: 100%; text-align: left; padding: 12px 16px; border-radius: 12px;
        color: #94a3b8; font-weight: 500; font-size: 0.9rem;
        display: flex; align-items: center; gap: 12px;
        transition: all 0.2s; border-left: 3px solid transparent;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.03); color: white; }
    .nav-btn.active {
        background: rgba(0, 240, 255, 0.06); color: white;
        border-left-color: #00F0FF; font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .nav-btn.active i { color: #00F0FF; filter: drop-shadow(0 0 8px rgba(0,240,255,0.5)); }

    .mobile-nav-btn {
        padding: 10px 20px; border-radius: 100px; font-size: 0.85rem;
        font-weight: 600; white-space: nowrap; color: #94a3b8;
        background: rgba(255,255,255,0.05); border: 1px solid transparent; transition: all 0.2s;
    }
    .mobile-nav-btn.active {
        background: #00F0FF; color: black; font-weight: 800;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
    }

    /* Utilities */
    .tab-section { display: none; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    .tab-section.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    
    /* OTP Input Shake Animation */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    
    /* Avatar Ring */
    .holo-ring {
        position: absolute; inset: -4px; border-radius: 50%;
        background: conic-gradient(from 0deg, transparent, #00F0FF, #7B2CBF, #FFD60A, transparent);
        animation: spin 4s linear infinite; filter: blur(4px); z-index: 0;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Coming Soon Badge */
    .coming-soon-badge {
        background: rgba(255, 213, 10, 0.2);
        color: #FFD60A;
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 9999px;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.05em;
        margin-left: 8px;
    }

    /* Disabled Section Styling */
    .disabled-section {
        opacity: 0.5;
        pointer-events: none;
        user-select: none;
    }

    /* ============================================================================ */
    /* GUARANTEED FALLBACK: Critical z-* utilities (inline for visibility safety)  */
    /* These ensure buttons remain visible even if external CSS fails to load      */
    /* ============================================================================ */
    .bg-z-gold { background-color: #FFD700 !important; }
    .bg-z-cyan { background-color: #00F0FF !important; }
    .bg-z-purple { background-color: #7B2CBF !important; }
    .bg-z-green { background-color: #10B981 !important; }

    .text-z-gold { color: #FFD700 !important; }
    .text-z-cyan { color: #00F0FF !important; }
    .text-z-purple { color: #7B2CBF !important; }
    .text-z-green { color: #10B981 !important; }

    .border-z-gold { border-color: #FFD700 !important; }
    .border-z-cyan { border-color: #00F0FF !important; }
    .border-z-purple { border-color: #7B2CBF !important; }
    .border-z-panel { border-color: #0e141d !important; }

    .border-l-z-cyan { border-left-color: #00F0FF !important; }
    .border-l-z-purple { border-left-color: #7B2CBF !important; }
    .border-l-z-green { border-left-color: #10B981 !important; }

    /* Opacity variants - escaped backslash for Tailwind-style /opacity syntax */
    .bg-z-bg\/95 { background-color: rgba(11, 15, 22, 0.95) !important; }
    .bg-z-panel\/30 { background-color: rgba(14, 20, 29, 0.3) !important; }
    .bg-z-gold\/10 { background-color: rgba(255, 215, 0, 0.1) !important; }
    .bg-z-gold\/20 { background-color: rgba(255, 215, 0, 0.2) !important; }
    .bg-z-cyan\/10 { background-color: rgba(0, 240, 255, 0.1) !important; }
    .bg-z-purple\/10 { background-color: rgba(123, 44, 191, 0.1) !important; }
    .bg-z-green\/5 { background-color: rgba(16, 185, 129, 0.05) !important; }

    .border-z-purple\/20 { border-color: rgba(123, 44, 191, 0.2) !important; }
    .border-z-gold\/20 { border-color: rgba(255, 215, 0, 0.2) !important; }

    /* Gradient color stops */
    .from-z-gold\/10 {
        --tw-gradient-from: rgba(255, 215, 0, 0.1) !important;
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, transparent) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-screen overflow-hidden text-sm">

    <header class="h-16 z-50 bg-z-bg/95 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-4 lg:px-8 shrink-0 relative">
        <div class="flex items-center gap-4">
            <a href="{% url 'user_profile:public_profile' username=request.user.username %}" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition border border-white/10 text-gray-400 hover:text-white group">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
            </a>
            <div class="flex flex-col">
                <h1 class="text-lg font-display font-bold text-white tracking-wide">Control Deck</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <span class="text-xs text-yellow-500 font-mono hidden md:flex items-center gap-2 animate-pulse" id="unsaved-changes" style="display: none;">
                <i class="fa-solid fa-circle text-[6px]"></i> Unsaved Changes
            </span>
            <button id="save-all-btn" onclick="saveAll()" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition shadow-neon-cyan flex items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> Save
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside class="hidden lg:flex w-72 bg-z-panel/30 border-r border-white/5 flex-col overflow-y-auto no-scrollbar shrink-0 pb-10">
            <div class="p-6 space-y-8">
                
                <div>
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 pl-3">Account</div>
                    <div class="space-y-1">
                        <button onclick="switchTab('identity')" class="nav-btn active" data-target="identity" data-nav="identity"><i class="fa-regular fa-id-card w-5 text-center"></i> Identity</button>
                        <button onclick="switchTab('about')" class="nav-btn" data-target="about" data-nav="about"><i class="fa-solid fa-address-card w-5 text-center"></i> About</button>
                        <button onclick="switchTab('connections')" class="nav-btn" data-target="connections" data-nav="connections"><i class="fa-solid fa-address-book w-5 text-center"></i> Connections</button>
                        <button onclick="switchTab('security')" class="nav-btn" data-target="security" data-nav="security"><i class="fa-solid fa-shield-halved w-5 text-center"></i> Security</button>
                        <button onclick="switchTab('privacy')" class="nav-btn" data-target="privacy" data-nav="privacy"><i class="fa-solid fa-user-shield w-5 text-center"></i> Privacy & Vis.</button>
                        <button onclick="switchTab('platform')" class="nav-btn" data-target="platform" data-nav="platform"><i class="fa-solid fa-globe w-5 text-center"></i> Platform</button>
                        <button onclick="switchTab('notifications')" class="nav-btn" data-target="notifications" data-nav="notifications"><i class="fa-regular fa-bell w-5 text-center"></i> Notifications</button>
                    </div>
                </div>

                <div>
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 pl-3">Esports</div>
                    <div class="space-y-1">
                        <button onclick="switchTab('recruitment')" class="nav-btn" data-target="recruitment"><i class="fa-solid fa-briefcase w-5 text-center"></i> Career & LFT</button>
                        <button onclick="switchTab('passports')" class="nav-btn" data-target="passports"><i class="fa-solid fa-gamepad w-5 text-center"></i> Game Passports</button>
                        <button onclick="switchTab('matchmaking')" class="nav-btn" data-target="matchmaking"><i class="fa-solid fa-crosshairs w-5 text-center"></i> Bounties & Match</button>
                        <button onclick="switchTab('loadout')" class="nav-btn" data-target="loadout"><i class="fa-solid fa-computer-mouse w-5 text-center"></i> Pro Loadout</button>
                    </div>
                </div>

                <div>
                    <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 pl-3">Assets</div>
                    <div class="space-y-1">
                        <button onclick="switchTab('inventory')" class="nav-btn" data-target="inventory"><i class="fa-solid fa-box-open w-5 text-center"></i> Inventory</button>
                        <button onclick="switchTab('stream')" class="nav-btn" data-target="stream"><i class="fa-brands fa-twitch w-5 text-center"></i> Live Feed</button>
                        <button onclick="switchTab('billing')" class="nav-btn" data-target="billing"><i class="fa-solid fa-wallet w-5 text-center"></i> Wallet</button>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5">
                    <button onclick="switchTab('danger')" class="nav-btn text-red-400 hover:text-red-300 hover:bg-red-500/10" data-target="danger"><i class="fa-solid fa-power-off w-5 text-center"></i> Danger Zone</button>
                </div>
            </div>
        </aside>

        <div class="lg:hidden absolute top-0 left-0 right-0 h-14 bg-z-bg/95 border-b border-white/5 z-40 overflow-x-auto no-scrollbar flex items-center px-4 gap-3">
            <button onclick="switchTab('identity')" class="mobile-nav-btn active" data-target="identity" data-nav="identity">Identity</button>
            <button onclick="switchTab('about')" class="mobile-nav-btn" data-target="about" data-nav="about">About</button>
            <button onclick="switchTab('connections')" class="mobile-nav-btn" data-target="connections" data-nav="connections">Connections</button>
            <button onclick="switchTab('recruitment')" class="mobile-nav-btn" data-target="recruitment" data-nav="recruitment">Career</button>
            <button onclick="switchTab('matchmaking')" class="mobile-nav-btn" data-target="matchmaking" data-nav="matchmaking">Bounties</button>
            <button onclick="switchTab('privacy')" class="mobile-nav-btn" data-target="privacy" data-nav="privacy">Privacy</button>
            <button onclick="switchTab('platform')" class="mobile-nav-btn" data-target="platform" data-nav="platform">Platform</button>
            <button onclick="switchTab('passports')" class="mobile-nav-btn" data-target="passports" data-nav="passports">Games</button>
            <button onclick="switchTab('loadout')" class="mobile-nav-btn" data-target="loadout" data-nav="loadout">Loadout</button>
            <button onclick="switchTab('stream')" class="mobile-nav-btn" data-target="stream" data-nav="stream">Stream</button>
            <button onclick="switchTab('inventory')" class="mobile-nav-btn" data-target="inventory" data-nav="inventory">Inv.</button>
            <button onclick="switchTab('billing')" class="mobile-nav-btn" data-target="billing" data-nav="billing">Wallet</button>
            <button onclick="switchTab('security')" class="mobile-nav-btn" data-target="security" data-nav="security">Security</button>
        </div>

        <main class="flex-1 overflow-y-auto pt-16 lg:pt-8 p-4 lg:p-12 pb-32 scroll-smooth">
            <div class="max-w-4xl mx-auto space-y-8">

                <!-- IDENTITY TAB (READY) -->
                <div id="tab-identity" class="tab-section active">
                    <h2 class="text-3xl font-display font-bold text-white mb-2">Identity Protocol</h2>
                    <p class="text-gray-400 mb-4">Manage how you appear to the world and team scouts.</p>
                    
                    <!-- Info Card -->
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-8 flex gap-3">
                        <i class="fa-solid fa-circle-info text-blue-400 text-xl flex-shrink-0 mt-1"></i>
                        <div class="text-sm text-gray-300">
                            <strong class="text-white">Privacy Control:</strong> Use the <a href="#" onclick="switchTab('privacy'); return false;" class="text-blue-400 hover:text-blue-300 underline">Privacy tab</a> to control which information is visible on your public profile. All fields are optional except Display Name.
                        </div>
                    </div>

                    <div class="glass-panel p-1 mb-8 group overflow-hidden">
                        <div class="relative h-40 md:h-56 bg-gray-800 rounded-t-[18px] overflow-hidden">
                            {% if user_profile.banner %}
                            <img src="{{ user_profile.banner.url }}" class="w-full h-full object-cover opacity-60" data-preview="banner">
                            {% else %}
                            <img src="https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070" class="w-full h-full object-cover opacity-60" data-preview="banner">
                            {% endif %}
                            <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="document.getElementById('banner-upload').click()">
                                <span class="bg-black/60 text-white px-5 py-2 rounded-full text-xs font-bold border border-white/20 hover:bg-white hover:text-black transition flex items-center gap-2">
                                    <i class="fa-solid fa-image"></i> Change Cover
                                </span>
                            </div>
                            <input type="file" id="banner-upload" class="hidden" accept="image/*" onchange="uploadMedia(this, 'banner')">
                        </div>
                        <div class="px-8 pb-8 relative">
                            <div class="w-24 h-24 md:w-32 md:h-32 -mt-12 md:-mt-16 relative group/avatar">
                                <div class="holo-ring"></div>
                                {% if user_profile.avatar %}
                                <img src="{{ user_profile.avatar.url }}" class="relative z-10 w-full h-full object-cover rounded-full border-4 border-z-panel" data-preview="avatar">
                                {% else %}
                                <img src="https://images.unsplash.com/photo-1566492031773-4f4e44671857?q=80&w=1000" class="relative z-10 w-full h-full object-cover rounded-full border-4 border-z-panel" data-preview="avatar">
                                {% endif %}
                                <div class="absolute inset-0 z-20 flex items-center justify-center bg-black/60 rounded-full opacity-0 group-hover/avatar:opacity-100 transition cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
                                    <i class="fa-solid fa-camera text-white text-xl"></i>
                                </div>
                                <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadMedia(this, 'avatar')">
                            </div>
                        </div>
                    </div>

                    <form id="identity-form" class="glass-panel p-8 grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="saveIdentity(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="identity">
                        
                        <div class="md:col-span-2">
                            <label class="z-label">Display Name</label>
                            <input type="text" name="display_name" class="z-input" value="{{ user_profile.display_name|default:'' }}" oninput="markUnsaved()" required>
                        </div>
                        <div>
                            <label class="z-label">Gamertag (Unique ID)</label>
                            <input type="text" class="z-input text-z-cyan font-bold" value="@{{ request.user.username }}" disabled>
                        </div>
                        <div>
                            <label class="z-label">Gender <span class="text-gray-500 text-xs normal-case">(Optional)</span></label>
                            <select name="gender" id="gender-select" class="z-input" oninput="markUnsaved(); autofillPronouns()">
                                <option value="">Prefer not to say</option>
                                <option value="male" {% if user_profile.gender == 'male' %}selected{% endif %}>Male</option>
                                <option value="female" {% if user_profile.gender == 'female' %}selected{% endif %}>Female</option>
                                <option value="other" {% if user_profile.gender == 'other' %}selected{% endif %}>Other</option>
                                <option value="prefer_not_to_say" {% if user_profile.gender == 'prefer_not_to_say' %}selected{% endif %}>Prefer not to say</option>
                            </select>
                        </div>
                        <div>
                            <label class="z-label">Pronouns <span class="text-gray-500 text-xs normal-case">(Auto-suggested)</span></label>
                            <select name="pronouns" id="pronouns-select" class="z-input" oninput="markUnsaved()">
                                <option value="">Prefer not to say</option>
                                <option value="he_him" {% if user_profile.pronouns == 'he_him' %}selected{% endif %}>He/Him</option>
                                <option value="she_her" {% if user_profile.pronouns == 'she_her' %}selected{% endif %}>She/Her</option>
                                <option value="they_them" {% if user_profile.pronouns == 'they_them' %}selected{% endif %}>They/Them</option>
                                <option value="she_they" {% if user_profile.pronouns == 'she_they' %}selected{% endif %}>She/They</option>
                                <option value="he_they" {% if user_profile.pronouns == 'he_they' %}selected{% endif %}>He/They</option>
                                <option value="other" {% if user_profile.pronouns == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="z-label">Date of Birth <span class="text-gray-500 text-xs normal-case">(Required for age verification)</span></label>
                            <input type="date" name="date_of_birth" id="date-of-birth" class="z-input" value="{{ user_profile.date_of_birth|date:'Y-m-d' }}" max="{{ today|date:'Y-m-d' }}" oninput="markUnsaved()">
                            <p class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-shield-halved text-z-cyan"></i> Your exact date is hidden. We only display your Age.</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="z-label">Bio <span id="bio-counter" class="text-xs text-gray-400 font-normal">(0 / 160)</span></label>
                            <textarea id="bio-input" name="bio" class="z-input h-24 resize-none" maxlength="160" oninput="updateBioCounter(); markUnsaved()">{{ user_profile.bio|default:'' }}</textarea>
                            <p class="text-xs text-gray-500 mt-1">Short headline for your hero section (160 characters max)</p>
                        </div>

                        <!-- KYC Verification Section -->
                        <div class="md:col-span-2">
                            <div class="glass-panel p-6 border-l-4 border-l-z-cyan bg-gradient-to-br from-cyan-500/5 to-blue-500/5">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-white text-lg flex items-center gap-2">
                                            <i class="fa-solid fa-id-card text-z-cyan"></i> Identity Verification (KYC)
                                        </h3>
                                        <p class="text-sm text-gray-400 mt-1">Required for prize withdrawals and premium tournaments</p>
                                    </div>
                                    <div id="kyc-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-500/20 text-gray-400">
                                        <i class="fa-solid fa-spinner fa-spin"></i> Loading...
                                    </div>
                                </div>
                                
                                <div id="kyc-content" class="mt-4">
                                    <!-- Dynamic content loaded via JS -->
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-2 pt-6">
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save Identity
                            </button>
                        </div>
                    </form>
                </div>

                <!-- CONNECTIONS TAB (Contact & Social) -->
                <div id="tab-connections" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white mb-2">Connections Hub</h2>
                    <p class="text-gray-400 mb-4">Manage how people can reach you and connect with your social presence.</p>
                    
                    <!-- Info Card -->
                    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 mb-8 flex gap-3">
                        <i class="fa-solid fa-circle-info text-purple-400 text-xl flex-shrink-0 mt-1"></i>
                        <div class="text-sm text-gray-300">
                            <strong class="text-white">Direct Connect:</strong> Contact methods you add here will appear on your public profile with clickable buttons that take visitors directly to your messaging apps.
                        </div>
                    </div>

                    <form id="connections-form" class="space-y-8" onsubmit="saveConnections(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="connections">
                        
                        <!-- Hidden fields to preserve identity data -->
                        <input type="hidden" name="display_name" value="{{ user_profile.display_name|default:'' }}">
                        <input type="hidden" name="bio" value="{{ user_profile.bio|default:'' }}">
                        <input type="hidden" name="gender" value="{{ user_profile.gender|default:'' }}">
                        <input type="hidden" name="city" value="{{ user_profile.city|default:'' }}">
                        <input type="hidden" name="country" value="{{ user_profile.country|default:'' }}">
                        
                        <!-- Contact Information Section -->
                        <div class="glass-panel p-8">
                            <div class="mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-address-card text-3xl text-z-cyan"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Contact Information</h3>
                                    <p class="text-sm text-gray-400">Primary ways for tournament organizers and team managers to reach you</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Modern Email Verification Section -->
                                <div class="md:col-span-2">
                                    <div class="bg-gradient-to-br from-blue-500/10 to-purple-500/10 border border-white/10 rounded-2xl p-6">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center">
                                                    <i class="fa-solid fa-envelope text-2xl text-blue-400"></i>
                                                </div>
                                                <div>
                                                    <h3 class="text-lg font-bold text-white">Public Email</h3>
                                                    <p class="text-sm text-gray-400">Displayed on your profile for contact</p>
                                                </div>
                                            </div>
                                            {% if user_profile.secondary_email_verified %}
                                            <span class="px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-xs font-semibold flex items-center gap-1.5">
                                                <i class="fa-solid fa-shield-check"></i> Verified
                                            </span>
                                            {% endif %}
                                        </div>

                                        <!-- Email Source Toggle -->
                                        <div class="mb-4">
                                            <div class="grid grid-cols-2 gap-3 p-1 bg-black/30 rounded-xl">
                                                <button type="button" id="use-primary-btn" onclick="toggleEmailSource('primary')" 
                                                    class="email-source-btn py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-200 {% if user_profile.secondary_email == request.user.email %}bg-white/10 text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                                                    <i class="fa-solid fa-shield-halved mr-2"></i>Use Primary Email
                                                </button>
                                                <button type="button" id="use-custom-btn" onclick="toggleEmailSource('secondary')" 
                                                    class="email-source-btn py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-200 {% if user_profile.secondary_email != request.user.email or not user_profile.secondary_email %}bg-white/10 text-white{% else %}text-gray-400 hover:text-white{% endif %}">
                                                    <i class="fa-solid fa-at mr-2"></i>Secondary Email
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Primary Email Display (Always Verified) -->
                                        <div id="primary-email-display" class="{% if user_profile.secondary_email != request.user.email or not user_profile.secondary_email %}hidden{% endif %}">
                                            <div class="flex items-center gap-3 p-4 bg-green-500/10 border border-green-500/30 rounded-xl mb-4">
                                                <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                                                    <i class="fa-solid fa-shield-check text-green-400"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <p class="text-sm font-semibold text-white">{{ request.user.email }}</p>
                                                    <p class="text-xs text-green-400 mt-0.5">
                                                        <i class="fa-solid fa-circle-check mr-1"></i>Verified
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Secondary Email Input -->
                                        <div id="secondary-email-display" class="{% if user_profile.secondary_email == request.user.email and user_profile.secondary_email %}hidden{% endif %}">
                                            <div class="mb-4">
                                                <input type="email" 
                                                    id="secondary_email_input"
                                                    name="secondary_email" 
                                                    class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition" 
                                                    value="{% if user_profile.secondary_email != request.user.email %}{{ user_profile.secondary_email|default:'' }}{% endif %}" 
                                                    placeholder="your.public@email.com"
                                                    oninput="onEmailInputChange()"
                                                    {% if user_profile.secondary_email_verified and user_profile.secondary_email != request.user.email %}readonly{% endif %}>
                                            </div>
                                        </div>

                                        <!-- Verification Status & Actions -->
                                        <div id="verification-section">
                                            {% if user_profile.secondary_email_verified %}
                                            <!-- Verified State -->
                                            <div class="mb-3">
                                                <div class="flex items-center gap-3 p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                                                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                                                        <i class="fa-solid fa-shield-check text-green-400"></i>
                                                    </div>
                                                    <div class="flex-1">
                                                        <p class="text-sm font-semibold text-white">{{ user_profile.secondary_email }}</p>
                                                        <p class="text-xs text-green-400 mt-0.5">
                                                            <i class="fa-solid fa-circle-check mr-1"></i>Verified
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Action Buttons -->
                                            <div class="flex gap-3">
                                                <button type="button" onclick="changeVerifiedEmail()" 
                                                    class="flex-1 py-2.5 px-4 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-blue-500/50 text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                                                    <i class="fa-solid fa-pen-to-square text-sm"></i>
                                                    <span>Change Email</span>
                                                </button>
                                                <button type="button" onclick="removeSecondaryEmail()" 
                                                    class="flex-1 py-2.5 px-4 bg-white/5 hover:bg-red-500/10 border border-white/10 hover:border-red-500/50 text-white hover:text-red-400 font-medium rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                                                    <i class="fa-solid fa-trash-can text-sm"></i>
                                                    <span>Remove Email</span>
                                                </button>
                                            </div>
                                            {% else %}
                                            <!-- Unverified State -->
                                            <div id="unverified-state" class="{% if not user_profile.secondary_email %}hidden{% endif %}">
                                                <div class="flex items-center gap-3 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl mb-3">
                                                    <i class="fa-solid fa-triangle-exclamation text-amber-400"></i>
                                                    <p class="text-sm text-amber-400 flex-1">Email not verified yet</p>
                                                </div>
                                                <button type="button" onclick="startEmailVerification()" 
                                                    class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2 group">
                                                    <i class="fa-solid fa-shield-check"></i>
                                                    <span>Verify Email Now</span>
                                                    <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- OTP Verification Modal (Hidden by default) -->
                                        <div id="otp-verification-panel" class="hidden mt-4">
                                            <div class="p-4 bg-black/40 border border-white/10 rounded-xl">
                                                <div class="text-center mb-4">
                                                    <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-purple-500/20 flex items-center justify-center">
                                                        <i class="fa-solid fa-key text-3xl text-purple-400"></i>
                                                    </div>
                                                    <h4 class="text-lg font-bold text-white mb-1">Enter Verification Code</h4>
                                                    <p class="text-sm text-gray-400">We sent a 6-digit code to <span id="otp-email-display" class="text-blue-400 font-medium"></span></p>
                                                </div>
                                                
                                                <div class="flex justify-center gap-2 mb-4">
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="0">
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="1">
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="2">
                                                    <span class="flex items-center text-gray-600 text-2xl">-</span>
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="3">
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="4">
                                                    <input type="text" maxlength="1" class="otp-digit w-12 h-14 text-center text-2xl font-bold bg-black/30 border-2 border-white/10 rounded-xl text-white focus:border-blue-500 focus:outline-none transition" data-index="5">
                                                </div>

                                                <div class="flex gap-2">
                                                    <button type="button" onclick="cancelOtpVerification()" class="flex-1 py-2.5 bg-white/5 hover:bg-white/10 text-white font-semibold rounded-xl transition">
                                                        Cancel
                                                    </button>
                                                    <button type="button" id="verify-otp-btn" onclick="verifyOtpCode()" class="flex-1 py-2.5 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold rounded-xl transition">
                                                        Verify Code
                                                    </button>
                                                </div>

                                                <button type="button" onclick="resendOtpCode()" class="w-full mt-3 py-2 text-xs text-gray-400 hover:text-white transition">
                                                    Didn't receive code? <span class="text-blue-400 font-semibold">Resend</span>
                                                </button>
                                            </div>
                                        </div>

                                        <input type="hidden" name="secondary_email_hidden" id="secondary_email_hidden" value="{{ user_profile.secondary_email|default:'' }}">
                                    </div>
                                </div>
                                
                                <div class="md:col-span-2">
                                    <label class="z-label mb-3">
                                        <i class="fa-solid fa-star text-yellow-400"></i> Preferred Contact Method
                                    </label>
                                    <p class="text-sm text-gray-400 mb-4">Select your preferred way to be contacted. This will be highlighted on your profile.</p>
                                    
                                    <input type="hidden" name="preferred_contact_method" id="preferred_contact_input" value="{{ user_profile.preferred_contact_method }}">
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        <!-- Email -->
                                        <label class="cursor-pointer group" onclick="selectPreferredContact('email')">
                                            <input type="radio" name="preferred_contact_radio" value="email" class="peer sr-only" {% if user_profile.preferred_contact_method == 'email' %}checked{% endif %}>
                                            <div class="p-4 rounded-xl border-2 border-white/10 bg-white/5 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition hover:border-white/20 h-full flex flex-col items-center justify-center text-center gap-2">
                                                <i class="fa-solid fa-envelope text-3xl text-blue-400"></i>
                                                <span class="text-sm font-semibold text-white">Email</span>
                                            </div>
                                        </label>
                                        
                                        <!-- WhatsApp -->
                                        <label class="cursor-pointer group" onclick="selectPreferredContact('whatsapp')">
                                            <input type="radio" name="preferred_contact_radio" value="whatsapp" class="peer sr-only" {% if user_profile.preferred_contact_method == 'whatsapp' %}checked{% endif %}>
                                            <div class="p-4 rounded-xl border-2 border-white/10 bg-white/5 peer-checked:border-green-500 peer-checked:bg-green-500/10 transition hover:border-white/20 h-full flex flex-col items-center justify-center text-center gap-2">
                                                <i class="fa-brands fa-whatsapp text-3xl text-green-500"></i>
                                                <span class="text-sm font-semibold text-white">WhatsApp</span>
                                            </div>
                                        </label>
                                        
                                        <!-- Phone -->
                                        <label class="cursor-pointer group" onclick="selectPreferredContact('phone')">
                                            <input type="radio" name="preferred_contact_radio" value="phone" class="peer sr-only" {% if user_profile.preferred_contact_method == 'phone' %}checked{% endif %}>
                                            <div class="p-4 rounded-xl border-2 border-white/10 bg-white/5 peer-checked:border-green-500 peer-checked:bg-green-500/10 transition hover:border-white/20 h-full flex flex-col items-center justify-center text-center gap-2">
                                                <i class="fa-solid fa-phone text-3xl text-green-400"></i>
                                                <span class="text-sm font-semibold text-white">Phone</span>
                                            </div>
                                        </label>
                                        
                                        <!-- Discord -->
                                        <label class="cursor-pointer group" onclick="selectPreferredContact('discord')">
                                            <input type="radio" name="preferred_contact_radio" value="discord" class="peer sr-only" {% if user_profile.preferred_contact_method == 'discord' %}checked{% endif %}>
                                            <div class="p-4 rounded-xl border-2 border-white/10 bg-white/5 peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition hover:border-white/20 h-full flex flex-col items-center justify-center text-center gap-2">
                                                <i class="fa-brands fa-discord text-3xl text-indigo-400"></i>
                                                <span class="text-sm font-semibold text-white">Discord</span>
                                            </div>
                                        </label>
                                        
                                        <!-- Facebook -->
                                        <label class="cursor-pointer group" onclick="selectPreferredContact('facebook')">
                                            <input type="radio" name="preferred_contact_radio" value="facebook" class="peer sr-only" {% if user_profile.preferred_contact_method == 'facebook' %}checked{% endif %}>
                                            <div class="p-4 rounded-xl border-2 border-white/10 bg-white/5 peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition hover:border-white/20 h-full flex flex-col items-center justify-center text-center gap-2">
                                                <i class="fa-brands fa-facebook text-3xl text-blue-500"></i>
                                                <span class="text-sm font-semibold text-white">Facebook</span>
                                            </div>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-3">ðŸ’¡ Tip: This method will be prominently displayed on your profile with a "Contact Me" button</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">
                                        <i class="fa-solid fa-phone text-green-400"></i> Phone Number
                                    </label>
                                    <input type="tel" name="phone" class="z-input" value="{{ user_profile.phone|default:'' }}" placeholder="+880 1XXX-XXXXXX" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">For tournament verification</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-whatsapp text-green-500"></i> WhatsApp Number
                                    </label>
                                    <input type="tel" name="whatsapp" class="z-input" value="{{ user_profile.whatsapp|default:'' }}" placeholder="+880 1XXX-XXXXXX" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">For instant messaging (can be different from phone)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Location Information Section -->
                        <div class="glass-panel p-8">
                            <div class="mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-location-dot text-3xl text-blue-400"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Location Information</h3>
                                    <p class="text-sm text-gray-400">Your regional information for tournament eligibility verification</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="z-label">
                                        <i class="fa-solid fa-city text-cyan-400"></i> City
                                    </label>
                                    <input type="text" name="city" class="z-input" value="{{ user_profile.city|default:'' }}" placeholder="Dhaka, Mumbai, Seoul..." oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">Your current city of residence</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">
                                        <i class="fa-solid fa-flag text-yellow-400"></i> Country
                                    </label>
                                    <select name="country" id="country-select" class="z-input" oninput="markUnsaved()">
                                        <option value="">Select country</option>
                                        <optgroup label="ðŸŒ South Asia">
                                            <option value="BD" {% if user_profile.country.code == 'BD' %}selected{% endif %}>Bangladesh</option>
                                            <option value="IN" {% if user_profile.country.code == 'IN' %}selected{% endif %}>India</option>
                                            <option value="PK" {% if user_profile.country.code == 'PK' %}selected{% endif %}>Pakistan</option>
                                            <option value="NP" {% if user_profile.country.code == 'NP' %}selected{% endif %}>Nepal</option>
                                            <option value="LK" {% if user_profile.country.code == 'LK' %}selected{% endif %}>Sri Lanka</option>
                                            <option value="MV" {% if user_profile.country.code == 'MV' %}selected{% endif %}>Maldives</option>
                                            <option value="BT" {% if user_profile.country.code == 'BT' %}selected{% endif %}>Bhutan</option>
                                        </optgroup>
                                        <optgroup label="ðŸŒ Popular Abroad">
                                            <option value="US" {% if user_profile.country.code == 'US' %}selected{% endif %}>United States</option>
                                            <option value="CA" {% if user_profile.country.code == 'CA' %}selected{% endif %}>Canada</option>
                                            <option value="GB" {% if user_profile.country.code == 'GB' %}selected{% endif %}>United Kingdom</option>
                                            <option value="AU" {% if user_profile.country.code == 'AU' %}selected{% endif %}>Australia</option>
                                            <option value="SG" {% if user_profile.country.code == 'SG' %}selected{% endif %}>Singapore</option>
                                            <option value="AE" {% if user_profile.country.code == 'AE' %}selected{% endif %}>United Arab Emirates</option>
                                            <option value="SA" {% if user_profile.country.code == 'SA' %}selected{% endif %}>Saudi Arabia</option>
                                            <option value="MY" {% if user_profile.country.code == 'MY' %}selected{% endif %}>Malaysia</option>
                                        </optgroup>
                                        <optgroup label="ðŸŒŽ All Countries">
                                            <option value="AF" {% if user_profile.country.code == 'AF' %}selected{% endif %}>Afghanistan</option>
                                            <option value="AL" {% if user_profile.country.code == 'AL' %}selected{% endif %}>Albania</option>
                                            <option value="DZ" {% if user_profile.country.code == 'DZ' %}selected{% endif %}>Algeria</option>
                                            <option value="AR" {% if user_profile.country.code == 'AR' %}selected{% endif %}>Argentina</option>
                                            <option value="AM" {% if user_profile.country.code == 'AM' %}selected{% endif %}>Armenia</option>
                                            <option value="AT" {% if user_profile.country.code == 'AT' %}selected{% endif %}>Austria</option>
                                            <option value="AZ" {% if user_profile.country.code == 'AZ' %}selected{% endif %}>Azerbaijan</option>
                                            <option value="BH" {% if user_profile.country.code == 'BH' %}selected{% endif %}>Bahrain</option>
                                            <option value="BY" {% if user_profile.country.code == 'BY' %}selected{% endif %}>Belarus</option>
                                            <option value="BE" {% if user_profile.country.code == 'BE' %}selected{% endif %}>Belgium</option>
                                            <option value="BR" {% if user_profile.country.code == 'BR' %}selected{% endif %}>Brazil</option>
                                            <option value="BG" {% if user_profile.country.code == 'BG' %}selected{% endif %}>Bulgaria</option>
                                            <option value="KH" {% if user_profile.country.code == 'KH' %}selected{% endif %}>Cambodia</option>
                                            <option value="CL" {% if user_profile.country.code == 'CL' %}selected{% endif %}>Chile</option>
                                            <option value="CN" {% if user_profile.country.code == 'CN' %}selected{% endif %}>China</option>
                                            <option value="CO" {% if user_profile.country.code == 'CO' %}selected{% endif %}>Colombia</option>
                                            <option value="HR" {% if user_profile.country.code == 'HR' %}selected{% endif %}>Croatia</option>
                                            <option value="CZ" {% if user_profile.country.code == 'CZ' %}selected{% endif %}>Czech Republic</option>
                                            <option value="DK" {% if user_profile.country.code == 'DK' %}selected{% endif %}>Denmark</option>
                                            <option value="EG" {% if user_profile.country.code == 'EG' %}selected{% endif %}>Egypt</option>
                                            <option value="EE" {% if user_profile.country.code == 'EE' %}selected{% endif %}>Estonia</option>
                                            <option value="FI" {% if user_profile.country.code == 'FI' %}selected{% endif %}>Finland</option>
                                            <option value="FR" {% if user_profile.country.code == 'FR' %}selected{% endif %}>France</option>
                                            <option value="GE" {% if user_profile.country.code == 'GE' %}selected{% endif %}>Georgia</option>
                                            <option value="DE" {% if user_profile.country.code == 'DE' %}selected{% endif %}>Germany</option>
                                            <option value="GR" {% if user_profile.country.code == 'GR' %}selected{% endif %}>Greece</option>
                                            <option value="HK" {% if user_profile.country.code == 'HK' %}selected{% endif %}>Hong Kong</option>
                                            <option value="HU" {% if user_profile.country.code == 'HU' %}selected{% endif %}>Hungary</option>
                                            <option value="IS" {% if user_profile.country.code == 'IS' %}selected{% endif %}>Iceland</option>
                                            <option value="ID" {% if user_profile.country.code == 'ID' %}selected{% endif %}>Indonesia</option>
                                            <option value="IR" {% if user_profile.country.code == 'IR' %}selected{% endif %}>Iran</option>
                                            <option value="IQ" {% if user_profile.country.code == 'IQ' %}selected{% endif %}>Iraq</option>
                                            <option value="IE" {% if user_profile.country.code == 'IE' %}selected{% endif %}>Ireland</option>
                                            <option value="IL" {% if user_profile.country.code == 'IL' %}selected{% endif %}>Israel</option>
                                            <option value="IT" {% if user_profile.country.code == 'IT' %}selected{% endif %}>Italy</option>
                                            <option value="JP" {% if user_profile.country.code == 'JP' %}selected{% endif %}>Japan</option>
                                            <option value="JO" {% if user_profile.country.code == 'JO' %}selected{% endif %}>Jordan</option>
                                            <option value="KZ" {% if user_profile.country.code == 'KZ' %}selected{% endif %}>Kazakhstan</option>
                                            <option value="KE" {% if user_profile.country.code == 'KE' %}selected{% endif %}>Kenya</option>
                                            <option value="KW" {% if user_profile.country.code == 'KW' %}selected{% endif %}>Kuwait</option>
                                            <option value="LV" {% if user_profile.country.code == 'LV' %}selected{% endif %}>Latvia</option>
                                            <option value="LB" {% if user_profile.country.code == 'LB' %}selected{% endif %}>Lebanon</option>
                                            <option value="LT" {% if user_profile.country.code == 'LT' %}selected{% endif %}>Lithuania</option>
                                            <option value="LU" {% if user_profile.country.code == 'LU' %}selected{% endif %}>Luxembourg</option>
                                            <option value="MX" {% if user_profile.country.code == 'MX' %}selected{% endif %}>Mexico</option>
                                            <option value="MD" {% if user_profile.country.code == 'MD' %}selected{% endif %}>Moldova</option>
                                            <option value="MN" {% if user_profile.country.code == 'MN' %}selected{% endif %}>Mongolia</option>
                                            <option value="MA" {% if user_profile.country.code == 'MA' %}selected{% endif %}>Morocco</option>
                                            <option value="MM" {% if user_profile.country.code == 'MM' %}selected{% endif %}>Myanmar</option>
                                            <option value="NL" {% if user_profile.country.code == 'NL' %}selected{% endif %}>Netherlands</option>
                                            <option value="NZ" {% if user_profile.country.code == 'NZ' %}selected{% endif %}>New Zealand</option>
                                            <option value="NG" {% if user_profile.country.code == 'NG' %}selected{% endif %}>Nigeria</option>
                                            <option value="NO" {% if user_profile.country.code == 'NO' %}selected{% endif %}>Norway</option>
                                            <option value="OM" {% if user_profile.country.code == 'OM' %}selected{% endif %}>Oman</option>
                                            <option value="PH" {% if user_profile.country.code == 'PH' %}selected{% endif %}>Philippines</option>
                                            <option value="PL" {% if user_profile.country.code == 'PL' %}selected{% endif %}>Poland</option>
                                            <option value="PT" {% if user_profile.country.code == 'PT' %}selected{% endif %}>Portugal</option>
                                            <option value="QA" {% if user_profile.country.code == 'QA' %}selected{% endif %}>Qatar</option>
                                            <option value="RO" {% if user_profile.country.code == 'RO' %}selected{% endif %}>Romania</option>
                                            <option value="RU" {% if user_profile.country.code == 'RU' %}selected{% endif %}>Russia</option>
                                            <option value="RS" {% if user_profile.country.code == 'RS' %}selected{% endif %}>Serbia</option>
                                            <option value="SK" {% if user_profile.country.code == 'SK' %}selected{% endif %}>Slovakia</option>
                                            <option value="SI" {% if user_profile.country.code == 'SI' %}selected{% endif %}>Slovenia</option>
                                            <option value="ZA" {% if user_profile.country.code == 'ZA' %}selected{% endif %}>South Africa</option>
                                            <option value="KR" {% if user_profile.country.code == 'KR' %}selected{% endif %}>South Korea</option>
                                            <option value="ES" {% if user_profile.country.code == 'ES' %}selected{% endif %}>Spain</option>
                                            <option value="SE" {% if user_profile.country.code == 'SE' %}selected{% endif %}>Sweden</option>
                                            <option value="CH" {% if user_profile.country.code == 'CH' %}selected{% endif %}>Switzerland</option>
                                            <option value="TW" {% if user_profile.country.code == 'TW' %}selected{% endif %}>Taiwan</option>
                                            <option value="TH" {% if user_profile.country.code == 'TH' %}selected{% endif %}>Thailand</option>
                                            <option value="TR" {% if user_profile.country.code == 'TR' %}selected{% endif %}>Turkey</option>
                                            <option value="UA" {% if user_profile.country.code == 'UA' %}selected{% endif %}>Ukraine</option>
                                            <option value="VN" {% if user_profile.country.code == 'VN' %}selected{% endif %}>Vietnam</option>
                                        </optgroup>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Essential for regional tournament eligibility</p>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact Section -->
                        <div class="glass-panel p-8">
                            <div class="mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-user-shield text-3xl text-red-400"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Emergency Contact</h3>
                                    <p class="text-sm text-gray-400">Required for LAN events, tournaments, and international competitions</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="md:col-span-2">
                                    <label class="z-label">Emergency Contact Full Name</label>
                                    <input type="text" name="emergency_contact_name" class="z-input" value="{{ user_profile.emergency_contact_name|default:'' }}" placeholder="Full legal name" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">Emergency Contact Phone</label>
                                    <input type="tel" name="emergency_contact_phone" class="z-input" value="{{ user_profile.emergency_contact_phone|default:'' }}" placeholder="+880 1XXX-XXXXXX" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">Relationship</label>
                                    <select name="emergency_contact_relation" class="z-input" oninput="markUnsaved()">
                                        <option value="">Select relationship</option>
                                        <option value="Parent" {% if user_profile.emergency_contact_relation == 'Parent' %}selected{% endif %}>Parent</option>
                                        <option value="Guardian" {% if user_profile.emergency_contact_relation == 'Guardian' %}selected{% endif %}>Guardian</option>
                                        <option value="Spouse" {% if user_profile.emergency_contact_relation == 'Spouse' %}selected{% endif %}>Spouse</option>
                                        <option value="Sibling" {% if user_profile.emergency_contact_relation == 'Sibling' %}selected{% endif %}>Sibling</option>
                                        <option value="Friend" {% if user_profile.emergency_contact_relation == 'Friend' %}selected{% endif %}>Friend</option>
                                        <option value="Other" {% if user_profile.emergency_contact_relation == 'Other' %}selected{% endif %}>Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Social Media Section -->
                        <div class="glass-panel p-8">
                            <div class="mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-share-nodes text-3xl text-pink-400"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-white">Social Media & Streaming</h3>
                                    <p class="text-sm text-gray-400">Your social presence and content platforms - visible on your public profile</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-youtube text-red-500"></i> YouTube Channel
                                    </label>
                                    <input type="url" name="youtube_link" class="z-input" value="{{ youtube_link.url|default:'' }}" placeholder="https://youtube.com/@username" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-twitch text-purple-500"></i> Twitch Channel
                                    </label>
                                    <input type="url" name="twitch_link" class="z-input" value="{{ twitch_link.url|default:'' }}" placeholder="https://twitch.tv/username" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-x-twitter text-sky-400"></i> Twitter/X Profile
                                    </label>
                                    <input type="url" name="twitter" class="z-input" value="{{ twitter_link.url|default:'' }}" placeholder="https://twitter.com/username" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-facebook text-blue-500"></i> Facebook Profile
                                    </label>
                                    <input type="url" name="facebook" class="z-input" value="{{ facebook_link.url|default:'' }}" placeholder="https://facebook.com/username" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-instagram text-pink-500"></i> Instagram Profile
                                    </label>
                                    <input type="url" name="instagram" class="z-input" value="{{ instagram_link.url|default:'' }}" placeholder="https://instagram.com/username" oninput="markUnsaved()">
                                </div>
                                <div>
                                    <label class="z-label">
                                        <i class="fa-brands fa-tiktok text-cyan-400"></i> TikTok Profile
                                    </label>
                                    <input type="url" name="tiktok" class="z-input" value="{{ tiktok_link.url|default:'' }}" placeholder="https://tiktok.com/@username" oninput="markUnsaved()">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="z-label">
                                        <i class="fa-brands fa-discord text-indigo-400"></i> Discord Username
                                    </label>
                                    <input type="text" name="discord_username" class="z-input" value="{{ discord_link.handle|default:'' }}" placeholder="username#1234 or just username" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">Your Discord username (others can add you as a friend)</p>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="z-label">
                                        <i class="fa-solid fa-link text-indigo-400"></i> Discord Link
                                    </label>
                                    <input type="url" name="discord_link" class="z-input" value="{{ discord_link.url|default:'' }}" placeholder="https://discord.gg/invite or https://discord.com/users/123456789" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">Your Discord profile link, server invite, or friend link (shown on your public profile)</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-z-cyan text-black px-8 py-3 rounded-xl text-sm font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save All Connections
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ABOUT TAB (Phase 4C.1) -->
                <div id="tab-about" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white mb-2">About / Competitive DNA</h2>
                    <p class="text-gray-400 mb-4">Build your esports CV - visible on your public profile to recruiters and teammates.</p>
                    
                    <!-- Info Card -->
                    <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4 mb-8 flex gap-3">
                        <i class="fa-solid fa-circle-info text-cyan-400 text-xl flex-shrink-0 mt-1"></i>
                        <div class="text-sm text-gray-300">
                            <strong class="text-white">Privacy Control:</strong> Use the <a href="#" onclick="switchTab('privacy'); return false;" class="text-cyan-400 hover:text-cyan-300 underline">Privacy tab</a> to control which About fields are visible on your public profile. Unchecked fields stay completely private.
                        </div>
                    </div>

                    <form id="about-form" onsubmit="saveAboutSettings(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="about">
                        
                        <!-- Player Summary (UP.3 EXTENSION) -->
                        <div class="glass-panel p-8 space-y-4 mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-user-astronaut text-yellow-400"></i> Player Summary
                            </h3>
                            <p class="text-sm text-gray-400">A brief competitive bio shown in your About section (separate from hero headline)</p>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="z-label mb-0">Your Competitive Journey</label>
                                    <span id="summary-char-count" class="text-xs text-gray-500">
                                        <span id="summary-current">{{ user_profile.profile_story|length|default:0 }}</span> / 320
                                    </span>
                                </div>
                                <textarea name="profile_story" id="profile-story-input" class="z-input h-24 resize-none" maxlength="320" placeholder="Share your competitive journey, achievements, or what makes you unique as a player..." oninput="updateCharCount(this, 320, 'summary'); markUnsaved()">{{ user_profile.profile_story|default:'' }}</textarea>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fa-solid fa-info-circle text-cyan-400"></i> 
                                    <strong>Keep it short</strong> â€” this shows on your public profile.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Competitive Goal (UP.3 HOTFIX #3) -->
                        <div class="glass-panel p-8 space-y-4 mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-bullseye text-orange-400"></i> Competitive Goal
                            </h3>
                            <p class="text-sm text-gray-400">Your short-term competitive aspiration or objective</p>
                            
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="z-label mb-0">Current Goal</label>
                                    <span id="goal-char-count" class="text-xs text-gray-500">
                                        <span id="goal-current">{{ user_profile.competitive_goal|length|default:0 }}</span> / 160
                                    </span>
                                </div>
                                <textarea name="competitive_goal" id="competitive-goal-input" class="z-input h-16 resize-none" maxlength="160" placeholder="e.g., \"Reach Diamond rank this season\" or \"Win a regional tournament\"" oninput="updateCharCount(this, 160, 'goal'); markUnsaved()">{{ user_profile.competitive_goal|default:'' }}</textarea>
                                <p class="text-xs text-gray-500 mt-2">
                                    <i class="fa-solid fa-target text-orange-400"></i> 
                                    <strong>Be specific</strong> â€” what's your next milestone?
                                </p>
                            </div>
                        </div>
                        
                        <!-- Primary Team & Game (UP.3 EXTENSION) -->
                        <div class="glass-panel p-8 space-y-6 mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-trophy text-amber-400"></i> Primary Team & Signature Game
                            </h3>
                            <p class="text-sm text-gray-400">Set your main team and signature game - displayed prominently on your profile</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="z-label">Primary Team</label>
                                    <select name="primary_team" id="primary-team-select" class="z-input" oninput="handlePrimaryTeamChange(); markUnsaved()">
                                        <option value="">No primary team</option>
                                        {% comment %} UP.3 HOTFIX #5: Use teams_dropdown (safe dict) instead of user_teams {% endcomment %}
                                        {% if teams_dropdown %}
                                            {% for team in teams_dropdown %}
                                            <option value="{{ team.id }}" 
                                                data-game-id="{{ team.game_id }}"
                                                data-game-name="{{ team.game_name }}"
                                                {% if user_profile.primary_team.id == team.id %}selected{% endif %}>
                                                {{ team.name }}{% if team.game_name %} ({{ team.game_name }}){% endif %}
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Your home team / main roster</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">Primary Game</label>
                                    <select name="primary_game" id="primary-game-select" class="z-input" oninput="markUnsaved()">
                                        <option value="">No primary game</option>
                                        {% comment %} Games will be loaded via view context {% endcomment %}
                                        {% if user_game_profiles %}
                                            {% for gp in user_game_profiles %}
                                            <option value="{{ gp.game.id }}"
                                                {% if user_profile.primary_game.id == gp.game.id %}selected{% endif %}>
                                                {{ gp.game.display_name }}
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1" id="game-hint-text">Your signature competitive game</p>
                                </div>
                            </div>
                            
                            <div id="auto-sync-alert" class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-4 hidden">
                                <div class="flex gap-3">
                                    <i class="fa-solid fa-link text-cyan-400 text-xl flex-shrink-0 mt-0.5"></i>
                                    <div class="text-sm text-cyan-300">
                                        <strong class="text-white">Auto-Sync Active:</strong> Your primary game is automatically set to <span id="synced-game-name" class="font-bold"></span> (your team's game). Clear your team selection to choose a different game manually.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Competitive DNA -->
                        <div class="glass-panel p-8 space-y-6 mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-crosshairs text-cyan-400"></i> Competitive DNA
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="z-label">Device / Platform</label>
                                    <select name="device_platform" class="z-input" oninput="markUnsaved()">
                                        <option value="">Not specified</option>
                                        <option value="PC" {% if user_profile.device_platform == 'PC' %}selected{% endif %}>PC</option>
                                        <option value="CONSOLE_PS" {% if user_profile.device_platform == 'CONSOLE_PS' %}selected{% endif %}>PlayStation</option>
                                        <option value="CONSOLE_XBOX" {% if user_profile.device_platform == 'CONSOLE_XBOX' %}selected{% endif %}>Xbox</option>
                                        <option value="MOBILE_ANDROID" {% if user_profile.device_platform == 'MOBILE_ANDROID' %}selected{% endif %}>Mobile (Android)</option>
                                        <option value="MOBILE_IOS" {% if user_profile.device_platform == 'MOBILE_IOS' %}selected{% endif %}>Mobile (iOS)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="z-label">Play Style</label>
                                    <select name="play_style" class="z-input" oninput="markUnsaved()">
                                        <option value="">Not specified</option>
                                        <option value="CASUAL" {% if user_profile.play_style == 'CASUAL' %}selected{% endif %}>Casual Player</option>
                                        <option value="COMPETITIVE" {% if user_profile.play_style == 'COMPETITIVE' %}selected{% endif %}>Competitive</option>
                                        <option value="PROFESSIONAL" {% if user_profile.play_style == 'PROFESSIONAL' %}selected{% endif %}>Professional</option>
                                        <option value="CONTENT_CREATOR" {% if user_profile.play_style == 'CONTENT_CREATOR' %}selected{% endif %}>Content Creator</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="z-label">Main Role</label>
                                    <select name="main_role" id="main_role_select" class="z-input" oninput="markUnsaved(); toggleCustomRole('main')">
                                        <option value="">Not specified</option>
                                        <option value="IGL" {% if user_profile.main_role == 'IGL' %}selected{% endif %}>IGL (In-Game Leader)</option>
                                        <option value="Entry Fragger" {% if user_profile.main_role == 'Entry Fragger' %}selected{% endif %}>Entry Fragger</option>
                                        <option value="Support" {% if user_profile.main_role == 'Support' %}selected{% endif %}>Support</option>
                                        <option value="AWPer" {% if user_profile.main_role == 'AWPer' %}selected{% endif %}>AWPer/Sniper</option>
                                        <option value="Rifler" {% if user_profile.main_role == 'Rifler' %}selected{% endif %}>Rifler</option>
                                        <option value="Lurker" {% if user_profile.main_role == 'Lurker' %}selected{% endif %}>Lurker</option>
                                        <option value="Anchor" {% if user_profile.main_role == 'Anchor' %}selected{% endif %}>Anchor</option>
                                        <option value="Flex" {% if user_profile.main_role == 'Flex' %}selected{% endif %}>Flex</option>
                                        <option value="Controller" {% if user_profile.main_role == 'Controller' %}selected{% endif %}>Controller</option>
                                        <option value="Initiator" {% if user_profile.main_role == 'Initiator' %}selected{% endif %}>Initiator</option>
                                        <option value="Sentinel" {% if user_profile.main_role == 'Sentinel' %}selected{% endif %}>Sentinel</option>
                                        <option value="Duelist" {% if user_profile.main_role == 'Duelist' %}selected{% endif %}>Duelist</option>
                                        <option value="Coach" {% if user_profile.main_role == 'Coach' %}selected{% endif %}>Coach</option>
                                        <option value="Analyst" {% if user_profile.main_role == 'Analyst' %}selected{% endif %}>Analyst</option>
                                        <option value="Content Creator" {% if user_profile.main_role == 'Content Creator' %}selected{% endif %}>Content Creator</option>
                                        <option value="OTHER">Other (specify below)</option>
                                    </select>
                                    <input type="text" name="main_role_custom" id="main_role_custom" class="z-input mt-2" placeholder="Specify your custom role" style="display: none;" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">Your primary competitive role</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">Secondary Role</label>
                                    <select name="secondary_role" id="secondary_role_select" class="z-input" oninput="markUnsaved(); toggleCustomRole('secondary')">
                                        <option value="">Not specified</option>
                                        <option value="IGL" {% if user_profile.secondary_role == 'IGL' %}selected{% endif %}>IGL (In-Game Leader)</option>
                                        <option value="Entry Fragger" {% if user_profile.secondary_role == 'Entry Fragger' %}selected{% endif %}>Entry Fragger</option>
                                        <option value="Support" {% if user_profile.secondary_role == 'Support' %}selected{% endif %}>Support</option>
                                        <option value="AWPer" {% if user_profile.secondary_role == 'AWPer' %}selected{% endif %}>AWPer/Sniper</option>
                                        <option value="Rifler" {% if user_profile.secondary_role == 'Rifler' %}selected{% endif %}>Rifler</option>
                                        <option value="Lurker" {% if user_profile.secondary_role == 'Lurker' %}selected{% endif %}>Lurker</option>
                                        <option value="Anchor" {% if user_profile.secondary_role == 'Anchor' %}selected{% endif %}>Anchor</option>
                                        <option value="Flex" {% if user_profile.secondary_role == 'Flex' %}selected{% endif %}>Flex</option>
                                        <option value="Controller" {% if user_profile.secondary_role == 'Controller' %}selected{% endif %}>Controller</option>
                                        <option value="Initiator" {% if user_profile.secondary_role == 'Initiator' %}selected{% endif %}>Initiator</option>
                                        <option value="Sentinel" {% if user_profile.secondary_role == 'Sentinel' %}selected{% endif %}>Sentinel</option>
                                        <option value="Duelist" {% if user_profile.secondary_role == 'Duelist' %}selected{% endif %}>Duelist</option>
                                        <option value="Coach" {% if user_profile.secondary_role == 'Coach' %}selected{% endif %}>Coach</option>
                                        <option value="Analyst" {% if user_profile.secondary_role == 'Analyst' %}selected{% endif %}>Analyst</option>
                                        <option value="Content Creator" {% if user_profile.secondary_role == 'Content Creator' %}selected{% endif %}>Content Creator</option>
                                        <option value="OTHER">Other (specify below)</option>
                                    </select>
                                    <input type="text" name="secondary_role_custom" id="secondary_role_custom" class="z-input mt-2" placeholder="Specify your custom role" style="display: none;" oninput="markUnsaved()">
                                    <p class="text-xs text-gray-500 mt-1">Backup role for flexibility</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">LFT Status</label>
                                    <select name="lft_status" class="z-input" oninput="markUnsaved()">
                                        <option value="NOT_LOOKING" {% if user_profile.lft_status == 'NOT_LOOKING' %}selected{% endif %}>Not Looking</option>
                                        <option value="LFT_TEAM" {% if user_profile.lft_status == 'LFT_TEAM' %}selected{% endif %}>LFT Team</option>
                                        <option value="LFT_SCRIMS" {% if user_profile.lft_status == 'LFT_SCRIMS' %}selected{% endif %}>LFT Scrims</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Looking For Team or Scrim partners</p>
                                </div>
                            </div>
                            
                            <script>
                            // Phase 4C.1.1: Toggle custom role input when "Other" is selected
                            function toggleCustomRole(type) {
                                const select = document.getElementById(type + '_role_select');
                                const customInput = document.getElementById(type + '_role_custom');
                                if (select && customInput) {
                                    customInput.style.display = (select.value === 'OTHER') ? 'block' : 'none';
                                }
                            }
                            // Initialize on page load
                            setTimeout(() => {
                                toggleCustomRole('main');
                                toggleCustomRole('secondary');
                            }, 100);
                            </script>
                        </div>
                        
                        <!-- Logistics & Availability -->
                        <div class="glass-panel p-8 space-y-6 mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days text-purple-400"></i> Logistics & Availability
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="z-label">Active Gaming Hours (BDT)</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="text-xs text-gray-500 mb-1 block">Start Time</label>
                                            <input type="time" name="active_hours_start" id="active_hours_start" class="z-input" oninput="markUnsaved()">
                                        </div>
                                        <div>
                                            <label class="text-xs text-gray-500 mb-1 block">End Time</label>
                                            <input type="time" name="active_hours_end" id="active_hours_end" class="z-input" oninput="markUnsaved()">
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">When you're typically online (Bangladesh Time)</p>
                                </div>
                                
                                <div>
                                    <label class="z-label">Communication Languages</label>
                                    <div class="max-h-44 overflow-y-auto grid grid-cols-2 gap-2 p-3 rounded-xl bg-black/30 border border-white/10">
                                        {% for value, label in form.communication_languages.field.choices %}
                                        <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 transition cursor-pointer">
                                            <input type="checkbox" 
                                                   name="communication_languages" 
                                                   value="{{ value }}"
                                                   {% if value in user_profile.communication_languages %}checked{% endif %}
                                                   class="language-checkbox w-4 h-4 rounded border-gray-600 text-z-cyan focus:ring-z-cyan focus:ring-offset-0 bg-z-panel"
                                                   oninput="markUnsaved()">
                                            <span class="text-sm text-gray-300">{{ label }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">Select all languages you can communicate in</p>
                                </div>
                                
                                <script>
                                // Phase 4C.1.1: Parse existing active_hours into start/end time inputs
                                (function() {
                                    const existingHours = "{{ user_profile.active_hours|default:'' }}";
                                    if (existingHours) {
                                        // Try to parse "HH:MM-HH:MM" format
                                        const match = existingHours.match(/(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/);
                                        if (match) {
                                            const startInput = document.getElementById('active_hours_start');
                                            const endInput = document.getElementById('active_hours_end');
                                            if (startInput && endInput) {
                                                startInput.value = match[1];
                                                endInput.value = match[2];
                                            }
                                        }
                                    }
                                })();
                                </script>
                                
                                <div class="md:col-span-2">
                                    <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                                        <div>
                                            <label class="font-bold text-white text-sm">LAN Availability</label>
                                            <p class="text-xs text-gray-400">Available for offline/LAN tournaments</p>
                                        </div>
                                        <label class="z-toggle-wrapper">
                                            <input type="checkbox" name="lan_availability" class="z-toggle-input" {% if user_profile.lan_availability %}checked{% endif %} oninput="markUnsaved()">
                                            <span class="z-toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Removed: Preferred Contact (now managed in Connections Hub) -->
                        <!-- Phase 4C.1.1: Contact preferences are managed in Connections tab only -->
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-6 flex gap-3">
                            <i class="fa-solid fa-info-circle text-blue-400 text-xl flex-shrink-0 mt-1"></i>
                            <div class="text-sm text-gray-300">
                                <strong class="text-white">Contact Preferences:</strong> Your preferred contact method and details (Discord, WhatsApp, Email, etc.) are managed in the <a href="#" onclick="switchTab('connections'); return false;" class="text-blue-400 hover:text-blue-300 underline font-bold">Connections Hub tab</a>. Recruiters will see your preferred method if you enable "Show Preferred Contact" in Privacy settings.
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="bg-z-cyan text-black px-8 py-3 rounded-xl text-sm font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save About Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- RECRUITMENT TAB (Career & LFT) -->
                <div id="tab-recruitment" class="tab-section space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-3xl font-display font-bold text-white">Career & LFT</h2>
                        <span class="bg-z-purple/10 text-z-purple border border-z-purple/20 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">Visible to Recruiters</span>
                    </div>
                    <p class="text-gray-400">Signal your availability to team managers and scouts.</p>

                    <form id="career-form" class="glass-panel p-8 space-y-8" onsubmit="saveCareerSettings(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="recruitment">
                        
                        <!-- Career Status -->
                        <div>
                            <label class="z-label text-base mb-4">Current Status</label>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <label class="cursor-pointer group">
                                    <input type="radio" name="career_status" value="SIGNED" class="peer sr-only" {% if career_settings.career_status == 'SIGNED' %}checked{% endif %}>
                                    <div class="p-5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-z-purple/20 peer-checked:border-z-purple transition text-center h-full flex flex-col justify-center items-center hover:bg-white/10">
                                        <i class="fa-solid fa-file-signature text-2xl mb-2"></i>
                                        <div class="font-bold">Signed</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group">
                                    <input type="radio" name="career_status" value="FREE_AGENT" class="peer sr-only" {% if career_settings.career_status == 'FREE_AGENT' %}checked{% endif %}>
                                    <div class="p-5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-z-gold/20 peer-checked:border-z-gold transition text-center h-full flex flex-col justify-center items-center hover:bg-white/10">
                                        <i class="fa-solid fa-handshake text-2xl mb-2"></i>
                                        <div class="font-bold">Free Agent</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group">
                                    <input type="radio" name="career_status" value="LOOKING" class="peer sr-only" {% if career_settings.career_status == 'LOOKING' %}checked{% endif %}>
                                    <div class="p-5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-z-cyan/20 peer-checked:border-z-cyan transition text-center h-full flex flex-col justify-center items-center hover:bg-white/10">
                                        <i class="fa-solid fa-magnifying-glass text-2xl mb-2"></i>
                                        <div class="font-bold">Looking</div>
                                    </div>
                                </label>
                                <label class="cursor-pointer group">
                                    <input type="radio" name="career_status" value="NOT_LOOKING" class="peer sr-only" {% if career_settings.career_status == 'NOT_LOOKING' %}checked{% endif %}>
                                    <div class="p-5 rounded-xl border border-white/10 bg-white/5 peer-checked:bg-gray-500/20 peer-checked:border-gray-500 transition text-center h-full flex flex-col justify-center items-center hover:bg-white/10">
                                        <i class="fa-solid fa-ban text-2xl mb-2"></i>
                                        <div class="font-bold">Not Looking</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- LFT Toggle -->
                        <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                            <div>
                                <label class="font-bold text-white text-sm">Looking For Team (LFT)</label>
                                <p class="text-xs text-gray-400">Show LFT badge on your profile</p>
                            </div>
                            <label class="z-toggle-wrapper">
                                <input type="checkbox" name="lft_enabled" class="z-toggle-input" {% if career_settings.lft_enabled %}checked{% endif %}>
                                <span class="z-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Primary Roles -->
                        <div>
                            <label class="z-label text-base mb-4">Primary Roles</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {% for role in role_choices %}
                                <label class="cursor-pointer group">
                                    <input type="checkbox" name="primary_roles" value="{{ role }}" class="peer sr-only" {% if role in career_settings.primary_roles %}checked{% endif %}>
                                    <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 peer-checked:bg-z-purple/20 peer-checked:border-z-purple transition text-center hover:bg-white/10">
                                        <span class="text-sm font-medium">{{ role }}</span>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Availability -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="z-label">Availability</label>
                                <select name="availability" class="z-input w-full">
                                    {% for value, label in availability_choices %}
                                    <option value="{{ value }}" {% if career_settings.availability == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="z-label">Minimum Salary (USD/month)</label>
                                <input type="number" name="salary_expectation_min" class="z-input w-full" value="{{ career_settings.salary_expectation_min|default:'' }}" placeholder="Optional" min="0">
                            </div>
                        </div>

                        <!-- Recruiter Visibility -->
                        <div>
                            <label class="z-label text-base mb-4">Recruiter Visibility</label>
                            <select name="recruiter_visibility" class="z-input w-full">
                                {% for value, label in recruiter_visibility_choices %}
                                <option value="{{ value }}" {% if career_settings.recruiter_visibility == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-400 mt-2">Control who can see your career profile</p>
                        </div>

                        <!-- Allow Direct Contracts -->
                        <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                            <div>
                                <label class="font-bold text-white text-sm">Allow Direct Contract Offers</label>
                                <p class="text-xs text-gray-400">Teams can send you contract offers via DeltaCrown</p>
                            </div>
                            <label class="z-toggle-wrapper">
                                <input type="checkbox" name="allow_direct_contracts" class="z-toggle-input" {% if career_settings.allow_direct_contracts %}checked{% endif %}>
                                <span class="z-toggle-slider"></span>
                            </label>
                        </div>

                        <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> Save Career Settings
                        </button>
                    </form>
                </div>

                <!-- BOUNTIES & MATCHMAKING TAB (UP-PHASE2A - ENABLED) -->
                <div id="tab-matchmaking" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Bounties & Matchmaking</h2>
                    
                    <form id="matchmaking-form" class="glass-panel p-8 space-y-8" onsubmit="saveMatchmakingSettings(event)">
                        {% csrf_token %}
                        
                        <!-- Enable Matchmaking -->
                        <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                            <div>
                                <label class="font-bold text-white text-sm">Enable Matchmaking</label>
                                <p class="text-xs text-gray-400">Receive bounty invites based on your preferences</p>
                            </div>
                            <label class="z-toggle-wrapper">
                                <input type="checkbox" name="enabled" class="z-toggle-input" {% if matchmaking_settings.enabled %}checked{% endif %}>
                                <span class="z-toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Bounty Range -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="z-label">Minimum Bounty (DC)</label>
                                <input type="number" name="min_bounty" class="z-input w-full" value="{{ matchmaking_settings.min_bounty|default:'' }}" placeholder="0" min="0">
                                <p class="text-xs text-gray-400 mt-1">Reject bounties below this amount</p>
                            </div>
                            <div>
                                <label class="z-label">Maximum Bounty (DC)</label>
                                <input type="number" name="max_bounty" class="z-input w-full" value="{{ matchmaking_settings.max_bounty|default:'' }}" placeholder="No limit" min="0">
                                <p class="text-xs text-gray-400 mt-1">Optional upper limit</p>
                            </div>
                        </div>

                        <!-- Auto Accept/Reject -->
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                                <div>
                                    <label class="font-bold text-white text-sm">Auto-Accept Bounties</label>
                                    <p class="text-xs text-gray-400">Automatically accept bounties within your range</p>
                                </div>
                                <label class="z-toggle-wrapper">
                                    <input type="checkbox" name="auto_accept" class="z-toggle-input" {% if matchmaking_settings.auto_accept %}checked{% endif %}>
                                    <span class="z-toggle-slider"></span>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                                <div>
                                    <label class="font-bold text-white text-sm">Auto-Reject Below Minimum</label>
                                    <p class="text-xs text-gray-400">Automatically decline low bounties</p>
                                </div>
                                <label class="z-toggle-wrapper">
                                    <input type="checkbox" name="auto_reject_below_min" class="z-toggle-input" {% if matchmaking_settings.auto_reject_below_min %}checked{% endif %}>
                                    <span class="z-toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Games Enabled (UP-PHASE2B: Dynamic from DB) -->
                        <div>
                            <label class="z-label text-base mb-4">Enabled Games</label>
                            <p class="text-xs text-gray-400 mb-3">Select games where you accept bounties</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                {% for game in available_games_for_matchmaking %}
                                <label class="cursor-pointer group">
                                    <input type="checkbox" name="games_enabled" value="{{ game.slug }}" class="peer sr-only" {% if game.slug in matchmaking_settings.games_enabled %}checked{% endif %}>
                                    <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 peer-checked:bg-z-purple/20 peer-checked:border-z-purple transition text-center hover:bg-white/10">
                                        <span class="text-sm font-medium">{{ game.display_name }}</span>
                                    </div>
                                </label>
                                {% empty %}
                                <p class="text-gray-400 text-sm col-span-full">No active games available</p>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Team Bounties -->
                        <div class="flex items-center justify-between p-6 rounded-xl border border-white/10 bg-white/5">
                            <div>
                                <label class="font-bold text-white text-sm">Allow Team Bounties</label>
                                <p class="text-xs text-gray-400">Accept bounties that require a full team</p>
                            </div>
                            <label class="z-toggle-wrapper">
                                <input type="checkbox" name="allow_team_bounties" class="z-toggle-input" {% if matchmaking_settings.allow_team_bounties %}checked{% endif %}>
                                <span class="z-toggle-slider"></span>
                            </label>
                        </div>

                        <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> Save Matchmaking Settings
                        </button>
                    </form>
                </div>

                <!-- PRIVACY TAB (PHASE 7C-P0: FULL MATRIX) -->
                <div id="tab-privacy" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Privacy & Visibility</h2>
                    
                    <form id="privacy-form" onsubmit="savePrivacyFull(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="privacy">
                        
                        <!-- Private Account -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-2">Account Privacy</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="font-bold text-white text-sm">Private Account</h4>
                                    <p class="text-xs text-gray-400">Require approval for new followers</p>
                                </div>
                                <label class="z-toggle-wrapper">
                                    <input type="checkbox" name="is_private_account" class="z-toggle-input" {% if privacy_settings.is_private_account %}checked{% endif %} onchange="autoSavePrivacy()">
                                    <span class="z-toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Profile Visibility -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">Profile Visibility</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Real Name</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_real_name" class="z-toggle-input" {% if privacy_settings.show_real_name %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Email</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_email" class="z-toggle-input" {% if privacy_settings.show_email %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Phone</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_phone" class="z-toggle-input" {% if privacy_settings.show_phone %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Age</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_age" class="z-toggle-input" {% if privacy_settings.show_age %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Gender</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_gender" class="z-toggle-input" {% if privacy_settings.show_gender %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Country</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_country" class="z-toggle-input" {% if privacy_settings.show_country %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- About Section Privacy (Phase 4C.1) -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">About Section (Competitive DNA)</h3>
                            <div class="bg-cyan-500/10 border border-cyan-500/20 rounded-lg p-3 mb-3">
                                <p class="text-xs text-gray-300">
                                    <i class="fa-solid fa-info-circle text-cyan-400"></i> These toggles control visibility of fields in your About section. Edit values in the <a href="#" onclick="switchTab('about'); return false;" class="text-cyan-400 hover:text-cyan-300 underline">About tab</a>.
                                </p>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Nationality</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_nationality" class="z-toggle-input" {% if privacy_settings.show_nationality %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Device/Platform</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_device_platform" class="z-toggle-input" {% if privacy_settings.show_device_platform %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Play Style</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_play_style" class="z-toggle-input" {% if privacy_settings.show_play_style %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Roles (Main/Secondary)</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_roles" class="z-toggle-input" {% if privacy_settings.show_roles %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Active Hours & LAN Availability</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_active_hours" class="z-toggle-input" {% if privacy_settings.show_active_hours %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Preferred Contact Method</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_preferred_contact" class="z-toggle-input" {% if privacy_settings.show_preferred_contact %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Gaming & Activity -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">Gaming & Activity</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Game IDs</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_game_ids" class="z-toggle-input" {% if privacy_settings.show_game_ids %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Match History</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_match_history" class="z-toggle-input" {% if privacy_settings.show_match_history %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Teams</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_teams" class="z-toggle-input" {% if privacy_settings.show_teams %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Achievements</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_achievements" class="z-toggle-input" {% if privacy_settings.show_achievements %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Economy & Inventory -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">Economy & Inventory</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-sm text-gray-300 block mb-2">Inventory Visibility</label>
                                    <select name="inventory_visibility" class="z-input w-full" onchange="autoSavePrivacy()">
                                        <option value="PUBLIC" {% if privacy_settings.inventory_visibility == 'PUBLIC' %}selected{% endif %}>Everyone</option>
                                        <option value="FRIENDS" {% if privacy_settings.inventory_visibility == 'FRIENDS' %}selected{% endif %}>Friends Only</option>
                                        <option value="PRIVATE" {% if privacy_settings.inventory_visibility == 'PRIVATE' %}selected{% endif %}>Only Me</option>
                                    </select>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Inventory Value</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_inventory_value" class="z-toggle-input" {% if privacy_settings.show_inventory_value %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Level & XP</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_level_xp" class="z-toggle-input" {% if privacy_settings.show_level_xp %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Social Visibility -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">Social</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Social Links</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_social_links" class="z-toggle-input" {% if privacy_settings.show_social_links %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Show Following List</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="show_following_list" class="z-toggle-input" {% if privacy_settings.show_following_list %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Interaction Permissions -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <h3 class="font-bold text-white text-lg mb-4">Interaction Permissions</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Allow Team Invites</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="allow_team_invites" class="z-toggle-input" {% if privacy_settings.allow_team_invites %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Allow Friend Requests</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="allow_friend_requests" class="z-toggle-input" {% if privacy_settings.allow_friend_requests %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-300">Allow Direct Messages</span>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="allow_direct_messages" class="z-toggle-input" {% if privacy_settings.allow_direct_messages %}checked{% endif %} onchange="autoSavePrivacy()">
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- PHASE 7C-P0: Follow Requests Management -->
                    <div class="glass-panel p-6 space-y-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-white text-lg">Follow Requests</h3>
                            <div class="flex gap-2">
                                <button onclick="loadFollowRequests('PENDING')" class="text-xs px-3 py-1 rounded-lg bg-white/10 text-white hover:bg-white/20 transition" id="filter-pending">Pending</button>
                                <button onclick="loadFollowRequests('APPROVED')" class="text-xs px-3 py-1 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 transition" id="filter-approved">Approved</button>
                                <button onclick="loadFollowRequests('REJECTED')" class="text-xs px-3 py-1 rounded-lg bg-white/5 text-gray-400 hover:bg-white/10 transition" id="filter-rejected">Rejected</button>
                            </div>
                        </div>
                        <div id="follow-requests-list">
                            <!-- Loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- PLATFORM TAB (PHASE 5A - GLOBAL WIRING) -->
                <div id="tab-platform" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white mb-2">Platform Preferences</h2>
                    <p class="text-gray-400 mb-8">Global settings for timezone, language, time format, and currency display.</p>

                    <form id="platform-form" onsubmit="savePlatformSettings(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="platform">
                        
                        <!-- Language Selection -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <label class="z-label flex items-center gap-2">
                                <i class="fa-solid fa-language"></i> Preferred Language
                            </label>
                            <select id="preferred_language" name="preferred_language" class="z-input" onchange="markUnsaved()">
                                <option value="">Loading...</option>
                            </select>
                            <p class="text-xs text-gray-500">Bengali translation coming soon. UI language will update after page reload.</p>
                        </div>
                        
                        <!-- Timezone Selection -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <label class="z-label flex items-center gap-2">
                                <i class="fa-solid fa-clock"></i> Timezone
                            </label>
                            <select id="timezone_pref" name="timezone" class="z-input" onchange="markUnsaved()">
                                <option value="">Loading...</option>
                            </select>
                            <p class="text-xs text-gray-500">All timestamps across the platform will display in your selected timezone.</p>
                        </div>
                        
                        <!-- Time Format -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <label class="z-label flex items-center gap-2">
                                <i class="fa-solid fa-clock"></i> Time Format
                            </label>
                            <select id="time_format" name="time_format" class="z-input" onchange="markUnsaved()">
                                <option value="12h">12-hour (3:00 PM)</option>
                                <option value="24h">24-hour (15:00)</option>
                            </select>
                            <p class="text-xs text-gray-500">Choose how times are displayed throughout the platform.</p>
                        </div>
                        
                        <!-- Currency Display -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <label class="z-label flex items-center gap-2">
                                <i class="fa-solid fa-bangladeshi-taka-sign"></i> Currency
                            </label>
                            <select id="currency" name="currency" class="z-input" disabled>
                                <option value="BDT" selected>BDT (à§³) - Bangladeshi Taka</option>
                                <option value="USD">USD ($) - Coming Soon</option>
                            </select>
                            <p class="text-xs text-gray-500">Multi-currency support coming soon. Currently BDT only.</p>
                        </div>
                        
                        <!-- Theme Preference -->
                        <div class="glass-panel p-6 space-y-4 mb-6">
                            <label class="z-label flex items-center gap-2">
                                <i class="fa-solid fa-palette"></i> Theme
                            </label>
                            <select id="theme_preference" name="theme_preference" class="z-input" disabled>
                                <option value="dark" selected>Dark Mode</option>
                                <option value="light">Light Mode (Coming Soon)</option>
                                <option value="system">System Default</option>
                            </select>
                            <p class="text-xs text-gray-500">Light mode theme coming in future update.</p>
                        </div>
                        
                        <div class="mt-6">
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save Platform Settings
                            </button>
                        </div>
                    </form>
                </div>

                <!-- INVENTORY TAB (PHASE 3A - BETA, PHASE 4A UX, PHASE 4B ENHANCED) -->
                <div id="tab-inventory" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Inventory & Trade<span class="bg-yellow-500/20 text-yellow-500 px-2 py-1 rounded-lg text-xs font-bold ml-3">Beta</span></h2>
                    
                    <!-- My Inventory Viewer (PHASE 4B ENHANCED) -->
                    <div class="glass-panel p-6">
                        <h3 class="text-xl font-bold text-white mb-4">My Inventory</h3>
                        
                        <!-- PHASE 4B: Search/Filter/Sort Controls -->
                        <div class="flex flex-wrap gap-3 mb-4">
                            <input type="text" id="inventory-search" placeholder="Search items..." 
                                   class="z-input flex-1 min-w-[200px]" 
                                   oninput="applyInventoryFilters()">
                            <select id="inventory-rarity-filter" class="z-input" onchange="applyInventoryFilters()">
                                <option value="">All Rarities</option>
                                <option value="COMMON">Common</option>
                                <option value="RARE">Rare</option>
                                <option value="EPIC">Epic</option>
                                <option value="LEGENDARY">Legendary</option>
                            </select>
                            <select id="inventory-sort" class="z-input" onchange="applyInventoryFilters()">
                                <option value="name-asc">Name (Aâ€“Z)</option>
                                <option value="quantity-desc">Quantity (High to Low)</option>
                                <option value="acquired-desc">Recently Acquired</option>
                            </select>
                        </div>
                        
                        <div id="inventory-list" class="space-y-3">
                            <p class="text-sm text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</p>
                        </div>
                    </div>
                    
                    <!-- PHASE 4A/4B: Incoming Requests (ENHANCED) -->
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-4 cursor-pointer" onclick="toggleSection('incoming-requests')">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-inbox"></i> Incoming Requests
                                <i id="incoming-requests-toggle" class="fa-solid fa-chevron-down text-sm text-gray-400"></i>
                            </h3>
                        </div>
                        
                        <!-- PHASE 4B: Request Filters -->
                        <div id="incoming-requests-content" class="space-y-3">
                            <div class="flex gap-2 mb-3">
                                <button onclick="setIncomingFilter('all')" id="incoming-filter-all" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/10 text-white border border-white/20">
                                    All
                                </button>
                                <button onclick="setIncomingFilter('pending')" id="incoming-filter-pending" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Pending
                                </button>
                                <button onclick="setIncomingFilter('history')" id="incoming-filter-history" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    History
                                </button>
                                <button onclick="setIncomingFilter('gifts')" id="incoming-filter-gifts" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Gifts Only
                                </button>
                                <button onclick="setIncomingFilter('trades')" id="incoming-filter-trades" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Trades Only
                                </button>
                            </div>
                            <div id="incoming-requests-list" class="space-y-3">
                                <p class="text-sm text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PHASE 4A/4B: Outgoing Requests (ENHANCED) -->
                    <div class="glass-panel p-6">
                        <div class="flex items-center justify-between mb-4 cursor-pointer" onclick="toggleSection('outgoing-requests')">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fa-solid fa-paper-plane"></i> Sent Requests
                                <i id="outgoing-requests-toggle" class="fa-solid fa-chevron-down text-sm text-gray-400"></i>
                            </h3>
                        </div>
                        
                        <!-- PHASE 4B: Request Filters -->
                        <div id="outgoing-requests-content" class="space-y-3">
                            <div class="flex gap-2 mb-3">
                                <button onclick="setOutgoingFilter('all')" id="outgoing-filter-all" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/10 text-white border border-white/20">
                                    All
                                </button>
                                <button onclick="setOutgoingFilter('pending')" id="outgoing-filter-pending" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Pending
                                </button>
                                <button onclick="setOutgoingFilter('history')" id="outgoing-filter-history" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    History
                                </button>
                                <button onclick="setOutgoingFilter('gifts')" id="outgoing-filter-gifts" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Gifts Only
                                </button>
                                <button onclick="setOutgoingFilter('trades')" id="outgoing-filter-trades" 
                                        class="px-3 py-1 rounded-lg text-xs font-bold bg-white/5 text-gray-400 border border-white/10">
                                    Trades Only
                                </button>
                            </div>
                            <div id="outgoing-requests-list" class="space-y-3">
                                <p class="text-sm text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gift Item -->
                    <div class="glass-panel p-6">
                        <h3 class="text-xl font-bold text-white mb-4"><i class="fa-solid fa-gift"></i> Gift Item</h3>
                        <form id="gift-form" onsubmit="sendGift(event)" class="space-y-4">
                            {% csrf_token %}
                            <div><label class="z-label">Recipient Username</label><input type="text" name="recipient_username" class="z-input" required></div>
                            <div><label class="z-label">Item Slug</label><input type="text" name="item_slug" class="z-input" placeholder="e.g., awp-dragon-lore" required></div>
                            <div><label class="z-label">Quantity</label><input type="number" name="quantity" class="z-input" value="1" min="1" required></div>
                            <div><label class="z-label">Message (Optional)</label><textarea name="message" class="z-input h-20"></textarea></div>
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-paper-plane"></i> Send Gift
                            </button>
                        </form>
                    </div>
                    
                    <!-- Trade Request -->
                    <div class="glass-panel p-6">
                        <h3 class="text-xl font-bold text-white mb-4"><i class="fa-solid fa-arrows-rotate"></i> Trade Request</h3>
                        <form id="trade-form" onsubmit="proposeTrade(event)" class="space-y-4">
                            {% csrf_token %}
                            <div><label class="z-label">Target Username</label><input type="text" name="target_username" class="z-input" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="z-label">Your Item Slug</label><input type="text" name="offered_item_slug" class="z-input" required></div>
                                <div><label class="z-label">Your Quantity</label><input type="number" name="offered_quantity" class="z-input" value="1" min="1" required></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="z-label">Requested Item Slug (Optional)</label><input type="text" name="requested_item_slug" class="z-input"></div>
                                <div><label class="z-label">Requested Quantity</label><input type="number" name="requested_quantity" class="z-input" value="1" min="1"></div>
                            </div>
                            <div><label class="z-label">Message (Optional)</label><textarea name="message" class="z-input h-20"></textarea></div>
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-handshake"></i> Propose Trade
                            </button>
                        </form>
                    </div>
                </div>

                <!-- GAME PASSPORTS TAB (PHASE 7D: FULL REBUILD) -->
                {% include "user_profile/profile/settings/partials/_game_passports.html" %}

                <!-- LOADOUT TAB (READY) -->
                <div id="tab-loadout" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Pro Loadout</h2>
                    <p class="text-gray-400">Share your gear so fans can replicate your setup.</p>
                    <form id="loadout-form" class="glass-panel p-6 md:p-8" onsubmit="saveLoadout(event)">
                        {% csrf_token %}
                        <input type="hidden" name="settings_tab" value="loadout">
                        <div class="flex items-center gap-2 mb-6 text-z-purple">
                            <i class="fa-solid fa-microchip"></i>
                            <h3 class="text-sm font-bold uppercase tracking-widest">Hardware</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="z-label">Mouse</label><input type="text" name="mouse_brand" class="z-input" placeholder="e.g., Logitech G Pro X" value="{{ hardware_loadout.mouse_brand|default:'' }}" oninput="markUnsaved()"></div>
                            <div><label class="z-label">Keyboard</label><input type="text" name="keyboard_brand" class="z-input" placeholder="e.g., Wooting 60HE" value="{{ hardware_loadout.keyboard_brand|default:'' }}" oninput="markUnsaved()"></div>
                            <div><label class="z-label">Headset</label><input type="text" name="headset_brand" class="z-input" placeholder="e.g., HyperX Cloud II" value="{{ hardware_loadout.headset_brand|default:'' }}" oninput="markUnsaved()"></div>
                            <div><label class="z-label">Monitor</label><input type="text" name="monitor_brand" class="z-input" placeholder="e.g., BenQ Zowie 240Hz" value="{{ hardware_loadout.monitor_brand|default:'' }}" oninput="markUnsaved()"></div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save Loadout
                            </button>
                        </div>
                    </form>
                </div>

                <!-- STREAM TAB (READY) -->
                <div id="tab-stream" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Stream Settings</h2>
                    <p class="text-gray-400">Link your streaming channel so fans can watch you live.</p>
                    
                    <form id="stream-form" class="glass-panel p-6 md:p-8" onsubmit="saveStreamUrl(event)">
                        {% csrf_token %}
                        <label class="z-label">Platform</label>
                        <div class="flex gap-4 mt-2 mb-6">
                            <label class="flex items-center gap-3 cursor-pointer bg-white/5 border border-z-purple p-4 rounded-xl w-full hover:bg-white/10 transition">
                                <input type="radio" name="stream_platform" value="twitch" checked class="accent-z-cyan w-4 h-4" onchange="markUnsaved()">
                                <i class="fa-brands fa-twitch text-[#9146FF] text-xl"></i> 
                                <span class="font-bold">Twitch</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer bg-white/5 border border-white/10 p-4 rounded-xl w-full opacity-60 hover:opacity-100 transition">
                                <input type="radio" name="stream_platform" value="youtube" class="accent-z-cyan w-4 h-4" onchange="markUnsaved()">
                                <i class="fa-brands fa-youtube text-[#FF0000] text-xl"></i> 
                                <span class="font-bold">YouTube</span>
                            </label>
                        </div>
                        <label class="z-label">Channel URL</label>
                        <input type="url" name="stream_url" class="z-input" placeholder="https://twitch.tv/yourchannel" oninput="markUnsaved()">
                        <div class="mt-6">
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-floppy-disk"></i> Save Stream URL
                            </button>
                        </div>
                    </form>
                </div>

                <!-- SECURITY TAB (PHASE 4C.3 - PRODUCTION READY) -->
                <div id="tab-security" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Security</h2>
                    <p class="text-gray-400 mb-6">Manage your account security, password, and active sessions</p>
                    
                    <!-- Change Password -->
                    <div class="glass-panel p-8">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-key text-z-gold"></i> Change Password
                        </h3>
                        <form id="change-password-form" class="space-y-4" onsubmit="changePassword(event)">
                            {% csrf_token %}
                            
                            <div>
                                <label class="z-label">Current Password</label>
                                <input type="password" name="current_password" class="z-input" required autocomplete="current-password" oninput="markUnsaved()">
                                <p class="text-xs text-gray-500 mt-1">Enter your current password for verification</p>
                            </div>
                            
                            <div>
                                <label class="z-label">New Password</label>
                                <input type="password" name="new_password" id="new-password" class="z-input" required autocomplete="new-password" oninput="markUnsaved()">
                                <p class="text-xs text-gray-500 mt-1">Minimum 8 characters, include letters and numbers</p>
                            </div>
                            
                            <div>
                                <label class="z-label">Confirm New Password</label>
                                <input type="password" name="confirm_password" class="z-input" required autocomplete="new-password" oninput="markUnsaved()">
                                <p class="text-xs text-gray-500 mt-1">Re-enter your new password</p>
                            </div>
                            
                            <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                                <i class="fa-solid fa-shield-halved"></i> Change Password
                            </button>
                        </form>
                    </div>

                    <!-- Date of Birth -->
                    <div class="glass-panel p-8">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-cake-candles text-z-purple"></i> Date of Birth
                        </h3>
                        
                        {% if user_profile.is_kyc_verified %}
                        <!-- KYC Verified: DOB is locked -->
                        <div class="flex items-center gap-4 p-4 rounded-xl bg-green-500/10 border border-green-500/30">
                            <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-lock text-green-400 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-1">{{ user_profile.date_of_birth|date:"F d, Y"|default:"Not set" }}</div>
                                <p class="text-xs text-gray-400">
                                    <i class="fa-solid fa-info-circle"></i>
                                    Date of birth is locked after KYC verification for security
                                </p>
                            </div>
                            <div class="px-3 py-1 rounded-full bg-green-500/20 text-green-400 text-xs font-bold">
                                <i class="fa-solid fa-shield-check"></i> Verified
                            </div>
                        </div>
                        {% else %}
                        <!-- Not Verified: DOB can be edited -->
                        <form id="dob-form" class="space-y-4" onsubmit="saveDateOfBirth(event)">
                            {% csrf_token %}
                            
                            <div>
                                <label class="z-label">Date of Birth</label>
                                <input type="date" name="date_of_birth" class="z-input w-full md:w-auto" 
                                       value="{{ user_profile.date_of_birth|date:'Y-m-d' }}" 
                                       required 
                                       max="{{ today|date:'Y-m-d' }}"
                                       oninput="markUnsaved()">
                                <p class="text-xs text-gray-500 mt-1">
                                    <i class="fa-solid fa-lock-open"></i>
                                    You can update this now. It will be locked after KYC verification.
                                </p>
                            </div>
                            
                            {% if user_profile.age %}
                            <div class="flex items-center gap-3 p-4 rounded-xl bg-white/[0.02] border border-white/5">
                                <div class="w-10 h-10 rounded-lg bg-z-cyan/10 flex items-center justify-center text-z-cyan">
                                    <i class="fa-solid fa-calendar-days"></i>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wider">Your Age</div>
                                    <div class="text-lg font-bold text-white">{{ user_profile.age }} years old</div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <button type="submit" class="bg-z-purple text-white px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-z-purple/80 transition flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> Save Date of Birth
                            </button>
                        </form>
                        {% endif %}
                    </div>

                    <!-- Session Management -->
                    <div class="glass-panel p-8">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-desktop text-z-cyan"></i> Active Sessions
                        </h3>
                        
                        <div id="session-info" class="space-y-4 mb-6">
                            <div class="flex items-center gap-3 p-4 rounded-xl bg-white/[0.02] border border-white/5">
                                <div class="w-10 h-10 rounded-lg bg-z-green/10 flex items-center justify-center text-z-green">
                                    <i class="fa-solid fa-circle-check"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wider">Current Session</div>
                                    <div class="text-sm font-semibold text-white">This device</div>
                                </div>
                            </div>
                            
                            <div id="other-sessions-info" class="flex items-center gap-3 p-4 rounded-xl bg-white/[0.02] border border-white/5">
                                <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400">
                                    <i class="fa-solid fa-spinner fa-spin"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wider">Other Sessions</div>
                                    <div class="text-sm font-semibold text-white">Loading...</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/30 mb-4">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-400 text-xl mt-0.5"></i>
                            <div>
                                <div class="font-bold text-white text-sm mb-1">Security Tip</div>
                                <p class="text-xs text-gray-400">
                                    If you see suspicious activity, log out all other sessions and change your password immediately.
                                </p>
                            </div>
                        </div>
                        
                        <button onclick="logoutOtherSessions()" class="bg-red-500/20 text-red-400 border border-red-500/30 hover:bg-red-500/30 px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider transition flex items-center gap-2">
                            <i class="fa-solid fa-right-from-bracket"></i> Logout Other Sessions
                        </button>
                    </div>

                    <!-- Account Info -->
                    <div class="glass-panel p-8">
                        <h3 class="font-bold text-white mb-6 flex items-center gap-2">
                            <i class="fa-solid fa-info-circle text-gray-400"></i> Account Information
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="flex items-center gap-3 p-4 rounded-xl bg-white/[0.02] border border-white/5">
                                <div class="w-10 h-10 rounded-lg bg-z-cyan/10 flex items-center justify-center text-z-cyan">
                                    <i class="fa-solid fa-calendar-plus"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wider">Member Since</div>
                                    <div class="text-sm font-semibold text-white">{{ request.user.date_joined|date:"F d, Y" }}</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3 p-4 rounded-xl bg-white/[0.02] border border-white/5">
                                <div class="w-10 h-10 rounded-lg bg-z-gold/10 flex items-center justify-center text-z-gold">
                                    <i class="fa-solid fa-clock"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-gray-500 uppercase tracking-wider">Last Login</div>
                                    <div class="text-sm font-semibold text-white">{{ request.user.last_login|date:"F d, Y g:i A"|default:"Never" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NOTIFICATIONS TAB (NOT_IMPLEMENTED - DISABLED) -->
                <!-- NOTIFICATIONS TAB (UP-PHASE2B - ENABLED) -->
                <div id="tab-notifications" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Notifications</h2>
                    
                    <form id="notifications-form" class="space-y-6" onsubmit="saveNotificationsSettings(event)">
                        {% csrf_token %}
                        
                        <!-- Delivery Channels -->
                        <div class="glass-panel p-6">
                            <h3 class="font-bold text-white mb-4">Delivery Channels</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Email Notifications</h4>
                                        <p class="text-xs text-gray-400">Receive notifications via email</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="email_enabled" class="z-toggle-input" {% if notification_settings.email_enabled %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Push Notifications</h4>
                                        <p class="text-xs text-gray-400">Browser and mobile push notifications</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="push_enabled" class="z-toggle-input" {% if notification_settings.push_enabled %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">SMS Notifications</h4>
                                        <p class="text-xs text-gray-400">Text message alerts (requires phone verification)</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="sms_enabled" class="z-toggle-input" {% if notification_settings.sms_enabled %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notification Categories -->
                        <div class="glass-panel p-6">
                            <h3 class="font-bold text-white mb-4">Notification Categories</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Tournament Alerts</h4>
                                        <p class="text-xs text-gray-400">Match reminders & bracket updates</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="notif_tournaments" class="z-toggle-input" {% if notification_settings.notif_tournaments %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Team Updates</h4>
                                        <p class="text-xs text-gray-400">Invites, roster changes, promotions</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="notif_teams" class="z-toggle-input" {% if notification_settings.notif_teams %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Bounty Offers</h4>
                                        <p class="text-xs text-gray-400">Bounty invites and completions</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="notif_bounties" class="z-toggle-input" {% if notification_settings.notif_bounties %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">Direct Messages</h4>
                                        <p class="text-xs text-gray-400">Chat and DM notifications</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="notif_messages" class="z-toggle-input" {% if notification_settings.notif_messages %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5">
                                    <div>
                                        <h4 class="font-bold text-white text-sm">System Announcements</h4>
                                        <p class="text-xs text-gray-400">Platform updates and maintenance</p>
                                    </div>
                                    <label class="z-toggle-wrapper">
                                        <input type="checkbox" name="notif_system" class="z-toggle-input" {% if notification_settings.notif_system %}checked{% endif %}>
                                        <span class="z-toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quiet Hours -->
                        <div class="glass-panel p-6">
                            <h3 class="font-bold text-white mb-4">Quiet Hours (Do Not Disturb)</h3>
                            <div class="flex items-center justify-between p-4 rounded-lg border border-white/10 bg-white/5 mb-4">
                                <div>
                                    <h4 class="font-bold text-white text-sm">Enable Quiet Hours</h4>
                                    <p class="text-xs text-gray-400">Mute notifications during specified times</p>
                                </div>
                                <label class="z-toggle-wrapper">
                                    <input type="checkbox" name="quiet_hours_enabled" class="z-toggle-input" {% if notification_settings.quiet_hours_enabled %}checked{% endif %}>
                                    <span class="z-toggle-slider"></span>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="z-label">Start Time</label>
                                    <input type="time" name="quiet_hours_start" class="z-input w-full" value="{{ notification_settings.quiet_hours_start|time:'H:i'|default:'' }}">
                                </div>
                                <div>
                                    <label class="z-label">End Time</label>
                                    <input type="time" name="quiet_hours_end" class="z-input w-full" value="{{ notification_settings.quiet_hours_end|time:'H:i'|default:'' }}">
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-2">Can wrap over midnight (e.g., 22:00 to 08:00)</p>
                        </div>
                        
                        <button type="submit" class="bg-z-cyan text-black px-6 py-2.5 rounded-xl text-xs font-black uppercase tracking-wider hover:bg-white transition flex items-center gap-2">
                            <i class="fa-solid fa-save"></i> Save Notification Settings
                        </button>
                    </form>
                </div>

                <!-- BILLING/WALLET TAB (READY) -->
                <div id="tab-billing" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-white">Wallet</h2>
                    <div class="glass-panel p-8 bg-gradient-to-r from-z-gold/10 to-transparent border border-z-gold/20 relative overflow-hidden">
                        <div class="absolute -right-10 -top-10 w-40 h-40 bg-z-gold/20 rounded-full blur-3xl"></div>
                        <p class="text-xs text-z-gold uppercase font-bold mb-2">Available Balance</p>
                        <h1 class="text-5xl font-display font-black text-white mb-6">
                            {% if wallet %}{{ wallet.cached_balance|floatformat:0 }}{% else %}0{% endif %} 
                            <span class="text-2xl text-gray-400 font-sans font-normal">DC</span>
                        </h1>
                        <div class="flex gap-3">
                            <a href="{% url 'economy:withdrawal_request' %}" class="bg-z-gold text-black px-6 py-2 rounded-lg font-bold uppercase text-xs hover:bg-white transition">Withdraw</a>
                            <a href="{% url 'economy:transaction_history' %}" class="bg-white/10 text-white px-6 py-2 rounded-lg font-bold uppercase text-xs hover:bg-white/20 transition">History</a>
                        </div>
                    </div>

                    <!-- UP-PHASE7.6: Wallet PIN Security -->
                    <div class="glass-panel p-8">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-z-cyan to-z-green flex items-center justify-center">
                                <i class="fa-solid fa-shield-halved text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-lg">Wallet PIN</h3>
                                <p class="text-gray-400 text-xs">Secure your withdrawals with a 6-digit PIN</p>
                            </div>
                        </div>

                        <!-- PIN Status -->
                        <div class="mb-6">
                            {% if wallet and wallet.pin_enabled %}
                            <div class="flex items-center gap-2 text-z-green text-sm">
                                <i class="fa-solid fa-circle-check"></i>
                                <span class="font-bold">PIN Enabled</span>
                            </div>
                            {% else %}
                            <div class="flex items-center gap-2 text-yellow-400 text-sm">
                                <i class="fa-solid fa-triangle-exclamation"></i>
                                <span class="font-bold">PIN Not Set</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- PIN Form -->
                        <form id="pin-setup-form" class="space-y-4">
                            {% if wallet and wallet.pin_enabled %}
                            <!-- Change PIN Mode -->
                            <div>
                                <label class="z-label">
                                    <i class="fa-solid fa-lock"></i> Current PIN
                                </label>
                                <input type="password" id="current-pin" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="z-input" required>
                            </div>
                            {% endif %}

                            <div>
                                <label class="z-label">
                                    <i class="fa-solid fa-key"></i> {% if wallet and wallet.pin_enabled %}New PIN{% else %}PIN{% endif %}
                                </label>
                                <input type="password" id="pin" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="z-input" required>
                                <p class="text-gray-500 text-xs mt-1">Must be exactly 6 digits</p>
                            </div>

                            <div>
                                <label class="z-label">
                                    <i class="fa-solid fa-check-double"></i> Confirm PIN
                                </label>
                                <input type="password" id="confirm-pin" maxlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="z-input" required>
                            </div>

                            <div id="pin-error-message" class="text-xs text-red-400 mt-1 hidden"></div>
                            <div id="pin-success-message" class="text-xs text-z-green mt-1 hidden"></div>

                            <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-z-cyan to-z-green text-black font-bold hover:shadow-lg hover:shadow-z-cyan/30 transition uppercase text-sm">
                                {% if wallet and wallet.pin_enabled %}Change PIN{% else %}Set PIN{% endif %}
                            </button>
                        </form>
                    </div>
                </div>

                <!-- DANGER ZONE TAB -->
                <div id="tab-danger" class="tab-section space-y-6">
                    <h2 class="text-3xl font-display font-bold text-red-500">Danger Zone</h2>
                    
                    <!-- Deletion Status Display (shown if scheduled) -->
                    <div id="deletion-status-panel" class="glass-panel p-6 border border-orange-500/30 bg-orange-500/5" style="display: none;">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fa-solid fa-clock text-orange-500 text-2xl"></i>
                            <div>
                                <h3 class="font-bold text-white">Account Deletion Scheduled</h3>
                                <p class="text-xs text-gray-400">Your account will be deleted on <span id="deletion-date" class="text-orange-400 font-bold"></span></p>
                            </div>
                        </div>
                        <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 mb-4">
                            <p class="text-sm text-orange-200 mb-2">
                                <i class="fa-solid fa-hourglass-half"></i> 
                                <span id="days-remaining" class="font-bold"></span> days remaining
                            </p>
                            <p class="text-xs text-gray-400">You can cancel this deletion request at any time before the deadline.</p>
                        </div>
                        <button onclick="cancelDeletion(event)" class="w-full px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl text-sm font-bold uppercase transition">
                            <i class="fa-solid fa-times-circle"></i> Cancel Deletion
                        </button>
                    </div>

                    <!-- Delete Account Form (shown if not scheduled) -->
                    <div id="deletion-form-panel" class="glass-panel p-6 border border-red-500/30 bg-red-500/5">
                        <div class="mb-4">
                            <h3 class="font-bold text-white text-lg mb-2">
                                <i class="fa-solid fa-exclamation-triangle text-red-500"></i> Delete Account
                            </h3>
                            <p class="text-sm text-gray-300 mb-3">This will schedule your account for deletion after a 14-day cooling-off period. You will be immediately logged out and unable to access your account unless you cancel the deletion.</p>
                            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4">
                                <p class="text-xs text-red-200">
                                    <i class="fa-solid fa-shield-halved"></i> 
                                    <strong>What happens:</strong> Your account will be deactivated and personal information will be anonymized after 14 days. This action cannot be undone after the deadline.
                                </p>
                            </div>
                        </div>

                        <form id="deletion-form" onsubmit="scheduleDeletion(event)">
                            <!-- Confirmation Phrase -->
                            <div class="mb-4">
                                <label class="z-label">
                                    <i class="fa-solid fa-keyboard"></i> Confirmation
                                </label>
                                <p class="text-xs text-gray-400 mb-2">Type <span class="text-red-400 font-mono font-bold">DELETE MY ACCOUNT</span> to confirm:</p>
                                <input type="text" id="confirm-phrase" name="confirm_phrase" class="z-input" placeholder="DELETE MY ACCOUNT" required autocomplete="off">
                            </div>

                            <!-- Password (if user has password) -->
                            {% if user.has_usable_password %}
                            <div class="mb-4">
                                <label class="z-label">
                                    <i class="fa-solid fa-lock"></i> Verify Password
                                </label>
                                <input type="password" id="deletion-password" name="password" class="z-input" placeholder="Enter your password" required>
                            </div>
                            {% endif %}

                            <!-- Reason (optional) -->
                            <div class="mb-4">
                                <label class="z-label">
                                    <i class="fa-solid fa-comment"></i> Reason (Optional)
                                </label>
                                <textarea id="deletion-reason" name="reason" class="z-input" rows="3" placeholder="Help us improve by telling us why you're leaving..."></textarea>
                            </div>

                            <button type="submit" class="w-full px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl text-sm font-bold uppercase transition">
                                <i class="fa-solid fa-trash"></i> Schedule Account Deletion
                            </button>
                        </form>
                    </div>

                    <p class="text-xs text-gray-500">
                        <i class="fa-solid fa-info-circle"></i>
                        Need help? Contact <a href="mailto:support@deltacrown.gg" class="text-z-cyan hover:underline">support@deltacrown.gg</a> before deleting your account.
                    </p>
                </div>

            </div>
        </main>
    </div>
</div>

<script>
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // UP.3 EXTENSION: Character counter for Player Summary
    function updateCharCount(textarea, maxChars, prefix = 'summary') {
        const currentLength = textarea.value.length;
        const counter = document.getElementById(`${prefix}-current`);
        if (counter) {
            counter.textContent = currentLength;
            const charCountSpan = document.getElementById(`${prefix}-char-count`);
            if (charCountSpan) {
                if (currentLength > maxChars * 0.9) {
                    charCountSpan.classList.add('text-red-400');
                    charCountSpan.classList.remove('text-gray-500');
                } else if (currentLength > maxChars * 0.7) {
                    charCountSpan.classList.add('text-yellow-400');
                    charCountSpan.classList.remove('text-gray-500', 'text-red-400');
                } else {
                    charCountSpan.classList.remove('text-red-400', 'text-yellow-400');
                    charCountSpan.classList.add('text-gray-500');
                }
            }
        }
    }
    
    // UP.3 EXTENSION: Primary team/game auto-sync
    function handlePrimaryTeamChange() {
        const teamSelect = document.getElementById('primary-team-select');
        const gameSelect = document.getElementById('primary-game-select');
        const syncAlert = document.getElementById('auto-sync-alert');
        const syncedGameName = document.getElementById('synced-game-name');
        const gameHint = document.getElementById('game-hint-text');
        
        if (!teamSelect || !gameSelect) return;
        
        const selectedOption = teamSelect.options[teamSelect.selectedIndex];
        
        if (teamSelect.value && selectedOption.dataset.gameId) {
            // Team selected - auto-fill game and lock
            const gameId = selectedOption.dataset.gameId;
            const gameName = selectedOption.dataset.gameName;
            
            gameSelect.value = gameId;
            gameSelect.disabled = true;
            gameSelect.classList.add('opacity-60', 'cursor-not-allowed');
            
            if (syncAlert && syncedGameName) {
                syncedGameName.textContent = gameName;
                syncAlert.classList.remove('hidden');
            }
            
            if (gameHint) {
                gameHint.innerHTML = '<i class="fa-solid fa-lock mr-1"></i> Locked to team\'s game';
                gameHint.classList.add('text-cyan-400');
                gameHint.classList.remove('text-gray-500');
            }
        } else {
            // No team selected - unlock game
            gameSelect.disabled = false;
            gameSelect.classList.remove('opacity-60', 'cursor-not-allowed');
            
            if (syncAlert) {
                syncAlert.classList.add('hidden');
            }
            
            if (gameHint) {
                gameHint.innerHTML = 'Your signature competitive game';
                gameHint.classList.remove('text-cyan-400');
                gameHint.classList.add('text-gray-500');
            }
        }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize char counter
        const summaryInput = document.getElementById('profile-story-input');
        if (summaryInput) {
            updateCharCount(summaryInput, 320, 'summary');
        }
        
        // UP.3 HOTFIX #3: Initialize competitive goal counter
        const goalInput = document.getElementById('competitive-goal-input');
        if (goalInput) {
            updateCharCount(goalInput, 160, 'goal');
        }
        
        // Initialize team/game sync
        handlePrimaryTeamChange();
    });
    
    // Unsaved changes tracking (Phase 1 active controls only)
    let hasUnsavedChanges = false;
    
    function markUnsaved(event) {
        // Only track changes for enabled inputs (not disabled Phase 2 sections)
        if (event && event.target) {
            const input = event.target;
            if (input.disabled || input.closest('.disabled-section')) {
                return; // Skip disabled controls
            }
        }
        hasUnsavedChanges = true;
        const indicator = document.getElementById('unsaved-changes');
        if (indicator) indicator.style.display = 'flex';
    }
    
    function markSaved() {
        hasUnsavedChanges = false;
        const indicator = document.getElementById('unsaved-changes');
        if (indicator) indicator.style.display = 'none';
    }
    
    // Bio character counter
    function updateBioCounter() {
        const bioInput = document.getElementById('bio-input');
        const counter = document.getElementById('bio-counter');
        if (bioInput && counter) {
            const length = bioInput.value.length;
            counter.textContent = `(${length} / 160)`;
            if (length > 160) {
                counter.classList.add('text-red-500');
                counter.classList.remove('text-gray-400');
            } else {
                counter.classList.remove('text-red-500');
                counter.classList.add('text-gray-400');
            }
        }
    }
    
    // Initialize bio counter on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateBioCounter();
    });

    // Toast notification (XSS-safe)
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-[100] px-6 py-3 rounded-xl shadow-2xl ${
            type === 'success' ? 'bg-green-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
            'bg-cyan-500 text-black'
        }`;
        const content = document.createElement('div');
        content.className = 'flex items-center gap-2';
        content.textContent = message;
        toast.appendChild(content);
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // Inline feedback (XSS-safe)
    function showInlineFeedback(formId, message, type = 'success') {
        const form = document.getElementById(formId);
        if (!form) return;
        
        // Remove existing feedback
        const existing = form.querySelector('.inline-feedback');
        if (existing) existing.remove();
        
        // Create feedback element
        const feedback = document.createElement('div');
        feedback.className = `inline-feedback text-sm mt-2 p-2 rounded ${
            type === 'success' ? 'text-green-400 bg-green-500/10' :
            'text-red-400 bg-red-500/10'
        }`;
        feedback.textContent = message;
        
        // Append to form
        form.appendChild(feedback);
        
        // Auto-remove after 3 seconds
        setTimeout(() => feedback.remove(), 3000);
    }

    // Save All Forms (header button)
    async function saveAll() {
        if (!hasUnsavedChanges) {
            showToast('No unsaved changes', 'info');
            return;
        }
        
        const activeTab = document.querySelector('.tab-section.active');
        if (!activeTab) return;
        
        const tabId = activeTab.id;
        const formMap = {
            'tab-identity': 'identity-form',
            'tab-about': 'about-form',
            'tab-connections': 'connections-form',
            'tab-recruitment': 'career-form',
            'tab-matchmaking': 'matchmaking-form',
            'tab-notifications': 'notifications-form',
            'tab-loadout': 'loadout-form',
            'tab-stream': 'stream-form'
        };
        
        const formId = formMap[tabId];
        if (!formId) {
            showToast('No saveable form in current tab', 'info');
            return;
        }
        
        const form = document.getElementById(formId);
        if (!form) return;
        
        // Trigger the form's submit event
        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
        form.dispatchEvent(submitEvent);
    }

    // Tab switching
    function switchTab(targetId) {
        // Hide all tabs
        document.querySelectorAll('.tab-section').forEach(el => el.classList.remove('active'));

        // Reset buttons
        document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(el => {
            el.classList.remove('active', 'text-white', 'bg-z-cyan/10', 'border-l-z-cyan');
            if(el.classList.contains('mobile-nav-btn')) {
                el.style.backgroundColor = ''; el.style.color = '#94a3b8'; el.style.boxShadow = 'none';
            }
        });

        // Show target
        const targetSection = document.getElementById('tab-' + targetId);
        if(targetSection) targetSection.classList.add('active');

        // Highlight buttons
        document.querySelectorAll(`[data-target="${targetId}"]`).forEach(btn => {
            if(btn.classList.contains('mobile-nav-btn')) {
                btn.style.backgroundColor = '#00F0FF'; btn.style.color = 'black'; btn.style.boxShadow = '0 0 15px rgba(0, 240, 255, 0.4)';
            } else {
                btn.classList.add('active');
            }
        });

        // PHASE 9A: Initialize Game Passports tab on first activation
        if (targetId === 'passports') {
            console.log('[Settings] Passports tab activated');
            console.log('[Settings] window.gamePassports exists:', !!window.gamePassports);
            if (window.gamePassports) {
                console.log('[Settings] window.gamePassports._initialized:', window.gamePassports._initialized);
                if (!window.gamePassports._initialized) {
                    console.log('[Settings] Initializing Game Passports for first time');
                    window.gamePassports._initialized = true;
                    window.gamePassports.init();
                } else {
                    console.log('[Settings] Game Passports already initialized');
                }
            } else {
                console.error('[Settings] window.gamePassports NOT FOUND - script may not have loaded');
            }
        }

        // Scroll Mobile Nav
        if(window.innerWidth < 1024) {
            const mobileBtn = document.querySelector(`.mobile-nav-btn[data-target="${targetId}"]`);
            if(mobileBtn) mobileBtn.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
        
        // Phase 9A-10C: Persist active tab to localStorage
        try {
            localStorage.setItem('settings_active_tab', targetId);
        } catch (e) {
            // Graceful degradation if localStorage unavailable
            console.warn('Could not persist tab selection:', e);
        }
    }

    // Smart auto-fill for pronouns based on gender selection
    function autofillPronouns() {
        const genderSelect = document.getElementById('gender-select');
        const pronounsSelect = document.getElementById('pronouns-select');
        
        if (!pronounsSelect || !genderSelect) {
            return;
        }
        
        const gender = genderSelect.value;
        
        // Auto-suggest pronouns based on gender (always suggest, user can override)
        if (gender === 'male') {
            pronounsSelect.value = 'he_him';
        } else if (gender === 'female') {
            pronounsSelect.value = 'she_her';
        } else if (gender === 'other' || gender === 'prefer_not_to_say' || gender === '') {
            pronounsSelect.value = ''; // Reset to "Prefer not to say"
        }
        
        // Mark as unsaved since we changed a field
        markUnsaved();
    }

    // Save Identity (display_name, bio, city, country)
    async function saveIdentity(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('{% url "user_profile:update_basic_info" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Identity updated successfully', 'success');
                showInlineFeedback('identity-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to update identity';
                showToast(errorMsg, 'error');
                showInlineFeedback('identity-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Identity save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('identity-form', 'Network error', 'error');
        } finally {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    async function saveConnections(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('{% url "user_profile:update_basic_info" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Connections updated successfully', 'success');
                showInlineFeedback('connections-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to update connections';
                showToast(errorMsg, 'error');
                showInlineFeedback('connections-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Connections save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('connections-form', 'Network error', 'error');
        } finally {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // ========== EMAIL VERIFICATION (Simplified System) ==========
    
    let currentEmailSource = '{{ user_profile.secondary_email }}' === '{{ request.user.email }}' ? 'primary' : 'secondary';
    let currentVerificationEmail = '';

    function toggleEmailSource(source) {
        currentEmailSource = source;
        
        // Update button states
        document.getElementById('use-primary-btn').classList.toggle('bg-white/10', source === 'primary');
        document.getElementById('use-primary-btn').classList.toggle('text-white', source === 'primary');
        document.getElementById('use-primary-btn').classList.toggle('text-gray-400', source !== 'primary');
        
        document.getElementById('use-custom-btn').classList.toggle('bg-white/10', source === 'secondary');
        document.getElementById('use-custom-btn').classList.toggle('text-white', source === 'secondary');
        document.getElementById('use-custom-btn').classList.toggle('text-gray-400', source !== 'secondary');
        
        // Toggle displays
        document.getElementById('primary-email-display').classList.toggle('hidden', source !== 'primary');
        document.getElementById('secondary-email-display').classList.toggle('hidden', source !== 'secondary');
        
        // For primary email, hide verification section (already verified)
        // For secondary email, show/hide unverified state based on email input
        const verificationSection = document.getElementById('verification-section');
        if (source === 'primary') {
            verificationSection.classList.add('hidden');
        } else {
            verificationSection.classList.remove('hidden');
            const email = document.getElementById('secondary_email_input').value;
            const unverifiedState = document.getElementById('unverified-state');
            if (unverifiedState) {
                unverifiedState.classList.toggle('hidden', !email);
            }
        }
        
        markUnsaved();
    }

    function onEmailInputChange() {
        const email = document.getElementById('secondary_email_input').value;
        const unverifiedState = document.getElementById('unverified-state');
        unverifiedState.classList.toggle('hidden', !email);
        markUnsaved();
    }

    function changeVerifiedEmail() {
        // Store current email for cancel functionality
        const emailInput = document.getElementById('secondary_email_input');
        const currentEmail = emailInput.value;
        emailInput.setAttribute('data-original-email', currentEmail);
        
        // Reset verification section to editing mode
        const verificationSection = document.getElementById('verification-section');
        verificationSection.innerHTML = `
            <div id="unverified-state">
                <div class="flex items-center gap-3 p-4 bg-blue-500/10 border border-blue-500/30 rounded-xl mb-3">
                    <i class="fa-solid fa-info-circle text-blue-400"></i>
                    <p class="text-sm text-blue-400 flex-1">Enter new email and verify to update</p>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="startEmailVerification()" 
                        class="flex-1 py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-shield-check"></i>
                        <span>Verify New Email</span>
                    </button>
                    <button type="button" onclick="cancelEmailChange()" 
                        class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-red-500/50 text-white hover:text-red-400 font-medium rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-xmark"></i>
                        <span>Cancel</span>
                    </button>
                </div>
            </div>
        `;
        
        // Enable and focus the email input
        emailInput.readOnly = false;
        emailInput.classList.remove('cursor-not-allowed', 'bg-black/20');
        emailInput.focus();
        
        markUnsaved();
    }
    
    function cancelEmailChange() {
        const emailInput = document.getElementById('secondary_email_input');
        const originalEmail = emailInput.getAttribute('data-original-email');
        
        // Restore original email
        if (originalEmail) {
            emailInput.value = originalEmail;
            emailInput.removeAttribute('data-original-email');
        }
        
        // Restore verified state
        updateUIToVerified(originalEmail || emailInput.value);
        
        showToast('Changes cancelled', 'info');
    }
    
    async function removeSecondaryEmail() {
        if (!confirm('Are you sure you want to remove your secondary email? This will make your profile contact information less visible.')) {
            return;
        }
        
        showToast('Removing secondary email...', 'info');
        
        try {
            // Clear the input
            document.getElementById('secondary_email_input').value = '';
            document.getElementById('secondary_email_hidden').value = '';
            
            // Update UI to show empty state
            const verificationSection = document.getElementById('verification-section');
            verificationSection.innerHTML = `
                <div id="unverified-state" class="hidden">
                    <div class="flex items-center gap-3 p-4 bg-amber-500/10 border border-amber-500/30 rounded-xl mb-3">
                        <i class="fa-solid fa-triangle-exclamation text-amber-400"></i>
                        <p class="text-sm text-amber-400 flex-1">Email not verified yet</p>
                    </div>
                    <button type="button" onclick="startEmailVerification()" 
                        class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2 group">
                        <i class="fa-solid fa-shield-check"></i>
                        <span>Verify Email Now</span>
                        <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            `;
            
            showToast('Secondary email removed', 'success');
            markUnsaved();
            
        } catch (error) {
            console.error('Error removing email:', error);
            showToast('Failed to remove email', 'error');
        }
    }

    async function startEmailVerification() {
        let email;
        let usePrimary = currentEmailSource === 'primary';
        
        if (usePrimary) {
            email = '{{ request.user.email }}';
        } else {
            email = document.getElementById('secondary_email_input').value.trim();
        }
        
        if (!email) {
            showToast('Please enter an email address', 'warning');
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast('Please enter a valid email address', 'error');
            return;
        }
        
        showToast(usePrimary ? 'Setting primary email...' : 'Sending verification code...', 'info');
        
        try {
            const response = await fetch('{% url "user_profile:send_verification_otp" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ 
                    email: email,
                    use_primary: usePrimary
                }),
            });
            
            const result = await response.json();
            
            if (result.success) {
                if (result.already_verified) {
                    // Primary email - no OTP needed, already verified
                    showToast('Primary email set successfully!', 'success');
                    
                    // Update UI to verified state immediately
                    updateUIToVerified(email);
                } else {
                    // Custom email - show OTP panel
                    currentVerificationEmail = email;
                    showOtpPanel(email);
                    showToast('Verification code sent! Check your email.', 'success');
                }
            } else {
                showToast(result.error || 'Failed to process request', 'error');
            }
        } catch (error) {
            console.error('Verification error:', error);
            showToast('Network error. Please try again.', 'error');
        }
    }

    function showOtpPanel(email) {
        document.getElementById('otp-email-display').textContent = email;
        document.getElementById('otp-verification-panel').classList.remove('hidden');
        document.getElementById('unverified-state').classList.add('hidden');
        
        // Focus first OTP digit
        setTimeout(() => {
            document.querySelector('.otp-digit[data-index="0"]').focus();
        }, 100);
        
        // Setup OTP input behavior
        setupOtpInputs();
    }

    function setupOtpInputs() {
        const otpDigits = document.querySelectorAll('.otp-digit');
        
        otpDigits.forEach((input, index) => {
            // Clear previous listeners
            input.replaceWith(input.cloneNode(true));
        });
        
        // Re-query after cloning
        const freshDigits = document.querySelectorAll('.otp-digit');
        
        freshDigits.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                
                // Only allow numbers
                if (!/^\d$/.test(value)) {
                    e.target.value = '';
                    return;
                }
                
                // Move to next input
                if (value && index < 5) {
                    freshDigits[index + 1].focus();
                }
            });
            
            input.addEventListener('keydown', (e) => {
                // Backspace - move to previous input
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    freshDigits[index - 1].focus();
                }
                
                // Arrow keys navigation
                if (e.key === 'ArrowLeft' && index > 0) {
                    freshDigits[index - 1].focus();
                }
                if (e.key === 'ArrowRight' && index < 5) {
                    freshDigits[index + 1].focus();
                }
                
                // Enter - submit
                if (e.key === 'Enter') {
                    verifyOtpCode();
                }
            });
            
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
                
                if (pastedData.length === 6) {
                    freshDigits.forEach((digit, i) => {
                        digit.value = pastedData[i] || '';
                    });
                    freshDigits[5].focus();
                }
            });
        });
    }

    async function verifyOtpCode() {
        const otpDigits = document.querySelectorAll('.otp-digit');
        const code = Array.from(otpDigits).map(input => input.value).join('');
        
        if (code.length !== 6) {
            showToast('Please enter all 6 digits', 'warning');
            return;
        }
        
        const button = document.getElementById('verify-otp-btn');
        const originalHTML = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';
        
        try {
            const response = await fetch('{% url "user_profile:verify_otp_code" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ 
                    email: currentVerificationEmail,
                    code: code
                }),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Email verified successfully!', 'success');
                
                // Update UI to verified state
                updateUIToVerified(currentVerificationEmail);
                
                // Hide OTP panel
                document.getElementById('otp-verification-panel').classList.add('hidden');
                
            } else {
                showToast(result.error || 'Invalid verification code', 'error');
                
                // Shake animation on error
                otpDigits.forEach(input => {
                    input.classList.add('animate-shake');
                    input.value = '';
                });
                setTimeout(() => {
                    otpDigits.forEach(input => input.classList.remove('animate-shake'));
                    otpDigits[0].focus();
                }, 500);
            }
        } catch (error) {
            console.error('Verification error:', error);
            showToast('Network error. Please try again.', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    function cancelOtpVerification() {
        document.getElementById('otp-verification-panel').classList.add('hidden');
        document.getElementById('unverified-state').classList.remove('hidden');
        
        // Clear OTP inputs
        document.querySelectorAll('.otp-digit').forEach(input => input.value = '');
    }

    async function resendOtpCode() {
        showToast('Resending verification code...', 'info');
        await startEmailVerification();
    }

    function updateUIToVerified(email) {
        // Update verification section to verified state
        document.getElementById('verification-section').innerHTML = `
            <div class="mb-3">
                <div class="flex items-center gap-3 p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                    <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                        <i class="fa-solid fa-shield-check text-green-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-white">${email}</p>
                        <p class="text-xs text-green-400 mt-0.5">
                            <i class="fa-solid fa-circle-check mr-1"></i>Verified
                        </p>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="changeVerifiedEmail()" 
                    class="flex-1 py-2.5 px-4 bg-white/5 hover:bg-white/10 border border-white/10 hover:border-blue-500/50 text-white font-medium rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-pen-to-square text-sm"></i>
                    <span>Change Email</span>
                </button>
                <button type="button" onclick="removeSecondaryEmail()" 
                    class="flex-1 py-2.5 px-4 bg-white/5 hover:bg-red-500/10 border border-white/10 hover:border-red-500/50 text-white hover:text-red-400 font-medium rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can text-sm"></i>
                    <span>Remove Email</span>
                </button>
            </div>
        `;
        
        // Add verified badge to header if not present
        const headerSection = document.querySelector('.bg-gradient-to-br.from-blue-500\\/10 .flex.items-start.justify-between');
        if (headerSection && !headerSection.querySelector('.bg-green-500\\/20')) {
            const existingBadge = headerSection.querySelector('.px-3.py-1\\.5');
            if (!existingBadge) {
                const badge = document.createElement('span');
                badge.className = 'px-3 py-1.5 rounded-full bg-green-500/20 text-green-400 text-xs font-semibold flex items-center gap-1.5';
                badge.innerHTML = '<i class="fa-solid fa-shield-check"></i> Verified';
                headerSection.appendChild(badge);
            }
        }
        
        // Update hidden input
        document.getElementById('secondary_email_hidden').value = email;
        
        // Make email input readonly and update its value
        const emailInput = document.getElementById('secondary_email_input');
        emailInput.value = email;
        emailInput.readOnly = true;
        emailInput.classList.add('cursor-not-allowed', 'bg-black/20');
        
        // Clear unsaved state (no page reload needed - UI already updated)
        markSaved();
    }

    // Verify secondary email with OTP (DEPRECATED - keeping for backward compatibility)
    async function verifySecondaryEmail() {
        await startEmailVerification();
    }

    // Select preferred contact method (card UI)
    function selectPreferredContact(method) {
        document.getElementById('preferred_contact_input').value = method;
        markUnsaved();
    }

    // Upload media (avatar/banner)
    async function uploadMedia(input, type) {
        if (!input.files || !input.files[0]) return;
        
        const formData = new FormData();
        formData.append('media_type', type);
        formData.append('file', input.files[0]);
        
        try {
            const response = await fetch('{% url "user_profile:upload_media" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(type.charAt(0).toUpperCase() + type.slice(1) + ' uploaded successfully', 'success');
                
                // Update preview in DOM instead of page reload
                if (result.url) {
                    const img = document.querySelector(`[data-preview="${type}"]`);
                    if (img) {
                        img.src = result.url + '?t=' + Date.now(); // Cache bust
                    }
                }
            } else {
                showToast(result.error || 'Upload failed', 'error');
            }
        } catch (error) {
            console.error('Media upload error:', error);
            showToast('Network error', 'error');
        }
    }

    // Save Privacy Settings
    async function savePrivacy(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('privacy-form') || document.getElementById('inventory-visibility-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button ? button.innerHTML : '';
        
        // Loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }
        
        // Collect data from both forms
        const privacyForm = document.getElementById('privacy-form');
        const inventoryForm = document.getElementById('inventory-visibility-form');
        
        const data = {
            show_following_list: privacyForm ? privacyForm.querySelector('[name="show_following_list"]')?.checked !== true : true,
            inventory_visibility: inventoryForm ? inventoryForm.querySelector('[name="inventory_visibility"]')?.value : 'PUBLIC',
        };
        
        try {
            const response = await fetch('{% url "user_profile:update_privacy_settings" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Privacy settings saved', 'success');
                showInlineFeedback('privacy-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to save privacy';
                showToast(errorMsg, 'error');
                showInlineFeedback('privacy-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Privacy save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('privacy-form', 'Network error', 'error');
        } finally {
            // Restore button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }
    
    // Auto-save privacy on toggle change
    function autoSavePrivacy() {
        markUnsaved();
        // Debounce to avoid too many requests
        clearTimeout(window.privacyTimeout);
        window.privacyTimeout = setTimeout(() => {
            savePrivacy();
        }, 500);
    }

    // PHASE 5A: Load platform settings
    async function loadPlatformSettings() {
        try {
            const response = await fetch('{% url "user_profile:get_platform_global_settings" %}', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            if (!response.ok) throw new Error('Failed to load platform settings');
            
            const data = await response.json();
            
            if (data.success) {
                // Populate form fields
                const prefs = data.preferences || {};
                document.getElementById('preferred_language').value = prefs.preferred_language || 'en';
                document.getElementById('timezone_pref').value = prefs.timezone || 'Asia/Dhaka';
                document.getElementById('time_format').value = prefs.time_format || '12h';
                
                // Populate dropdowns from available options
                const options = data.available_options || {};
                if (options.languages) {
                    populateSelect('preferred_language', options.languages, prefs.preferred_language);
                }
                if (options.timezones) {
                    populateSelect('timezone_pref', options.timezones, prefs.timezone);
                }
            }
        } catch (error) {
            console.error('Error loading platform settings:', error);
            showToast('Failed to load platform settings', 'error');
        }
    }

    // PHASE 5A: Populate select dropdown dynamically
    function populateSelect(selectId, optionsArray, currentValue) {
        const select = document.getElementById(selectId);
        if (!select || !optionsArray) return;
        
        // Clear existing options
        select.innerHTML = '';
        
        // Add new options
        optionsArray.forEach(option => {
            const optionElement = document.createElement('option');
            if (Array.isArray(option)) {
                // [value, label] format
                optionElement.value = option[0];
                optionElement.textContent = option[1];
            } else {
                // String format
                optionElement.value = option;
                optionElement.textContent = option;
            }
            select.appendChild(optionElement);
        });
        
        // Restore selected value
        if (currentValue) {
            select.value = currentValue;
        }
    }

    // PHASE 5A: Save platform settings
    async function savePlatformSettings(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = {
            preferred_language: document.getElementById('preferred_language').value,
            timezone: document.getElementById('timezone_pref').value,
            time_format: document.getElementById('time_format').value,
            currency: 'BDT', // Fixed for now
        };
        
        try {
            const response = await fetch('{% url "user_profile:save_platform_global_settings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(formData),
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('âœ… Platform preferences saved successfully!', 'success');
                showInlineFeedback('platform-form', 'Saved successfully. Page will reload to apply changes.', 'success');
                markSaved();
                // Reload page to apply timezone/language changes
                setTimeout(() => window.location.reload(), 1500);
            } else {
                const errorMsg = data.error || data.message || 'Failed to save platform preferences';
                showToast(`âŒ ${errorMsg}`, 'error');
                showInlineFeedback('platform-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error saving platform settings:', error);
            showToast('âŒ Network error. Please try again.', 'error');
            showInlineFeedback('platform-form', 'Network error', 'error');
        } finally {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // UP-PHASE2A: Save Career Settings
    async function saveCareerSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('career-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button ? button.innerHTML : '';
        
        // Loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }
        
        const formData = new FormData(form);
        
        // Collect primary roles (multiple checkboxes)
        const primaryRoles = [];
        formData.getAll('primary_roles').forEach(role => {
            if (role) primaryRoles.push(role);
        });
        
        const data = {
            career_status: formData.get('career_status') || 'NOT_LOOKING',
            lft_enabled: formData.get('lft_enabled') === 'on',
            primary_roles: primaryRoles,
            availability: formData.get('availability') || 'FULL_TIME',
            salary_expectation_min: formData.get('salary_expectation_min') ? parseInt(formData.get('salary_expectation_min')) : null,
            recruiter_visibility: formData.get('recruiter_visibility') || 'PUBLIC',
            allow_direct_contracts: formData.get('allow_direct_contracts') === 'on',
        };
        
        try {
            const response = await fetch('{% url "user_profile:settings_career_save" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Career settings saved', 'success');
                showInlineFeedback('career-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to save career settings';
                showToast(errorMsg, 'error');
                showInlineFeedback('career-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Career save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('career-form', 'Network error', 'error');
        } finally {
            // Restore button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }

    // Phase 4C.1: Save About Settings
    async function saveAboutSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('about-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button ? button.innerHTML : '';
        
        // Loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }
        
        const formData = new FormData(form);
        
        // Phase 4C.1.1: Combine active_hours_start + active_hours_end into active_hours
        const startTime = formData.get('active_hours_start');
        const endTime = formData.get('active_hours_end');
        if (startTime && endTime) {
            formData.set('active_hours', `${startTime}-${endTime} BDT`);
            formData.delete('active_hours_start');
            formData.delete('active_hours_end');
        } else if (startTime || endTime) {
            // Partial data - keep as-is or clear
            formData.set('active_hours', startTime || endTime || '');
            formData.delete('active_hours_start');
            formData.delete('active_hours_end');
        }
        
        // Handle "Other" role inputs
        const mainRole = formData.get('main_role');
        if (mainRole === 'OTHER') {
            const customMain = formData.get('main_role_custom');
            if (customMain) {
                formData.set('main_role', customMain);
            }
        }
        formData.delete('main_role_custom');
        
        const secondaryRole = formData.get('secondary_role');
        if (secondaryRole === 'OTHER') {
            const customSecondary = formData.get('secondary_role_custom');
            if (customSecondary) {
                formData.set('secondary_role', customSecondary);
            }
        }
        formData.delete('secondary_role_custom');
        
        try {
            // Phase 4C.1.2 FIX: POST to profile_settings (routes via settings_tab=about)
            const response = await fetch('{% url "user_profile:profile_settings" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            // Phase 4C.1.2: Robust error parsing
            let result;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                result = await response.json();
            } else {
                // HTML response (fallback)
                const html = await response.text();
                if (response.ok) {
                    result = { success: true, message: 'About settings saved successfully' };
                } else {
                    // Parse first error from HTML if possible
                    const errorMatch = html.match(/<div class="errorlist">.*?<li>(.*?)<\/li>/s);
                    result = {
                        success: false,
                        error: errorMatch ? errorMatch[1] : `Server error (${response.status})`,
                    };
                }
            }
            
            // Phase 4C.1.2 DEBUG: Log response for debugging
            if (window.DEBUG_SETTINGS) {
                console.log('[About Save] Response:', result);
                console.log('[About Save] Status:', response.status);
            }
            
            if (response.ok && result.success) {
                // SUCCESS: Show toast and keep values (no immediate reload for debugging)
                const successMsg = String(result.message || 'About settings saved successfully');
                showToast(successMsg, 'success');
                showInlineFeedback('about-form', 'Saved successfully', 'success');
                markSaved();
                
                // Phase 4C.1.2: Delayed reload to allow user to see success message
                // Comment out for debugging, uncomment for production
                setTimeout(() => {
                    window.location.reload();
                }, 1200);
            } else {
                // ERROR: Show meaningful error message
                let errorMsg = 'Failed to save About settings';
                
                if (result.error) {
                    errorMsg = String(result.error);
                } else if (result.message) {
                    errorMsg = String(result.message);
                } else if (result.errors) {
                    // Django form errors dict
                    const errorList = [];
                    for (const [field, errors] of Object.entries(result.errors)) {
                        if (Array.isArray(errors)) {
                            errorList.push(`${field}: ${errors.join(', ')}`);
                        } else {
                            errorList.push(`${field}: ${errors}`);
                        }
                    }
                    errorMsg = errorList.join('; ');
                }
                
                console.error('About save failed:', result);
                showToast(errorMsg, 'error');
                showInlineFeedback('about-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('About save error:', error);
            const networkError = 'Network error - please check your connection and try again';
            showToast(networkError, 'error');
            showInlineFeedback('about-form', networkError, 'error');
        } finally {
            // Restore button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }

    // UP-PHASE2A: Save Matchmaking Settings
    async function saveMatchmakingSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('matchmaking-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button ? button.innerHTML : '';
        
        // Loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }
        
        const formData = new FormData(form);
        
        // Collect games enabled (multiple checkboxes)
        const gamesEnabled = [];
        formData.getAll('games_enabled').forEach(game => {
            if (game) gamesEnabled.push(game);
        });
        
        const data = {
            enabled: formData.get('enabled') === 'on',
            games_enabled: gamesEnabled,
            min_bounty: formData.get('min_bounty') ? parseInt(formData.get('min_bounty')) : null,
            max_bounty: formData.get('max_bounty') ? parseInt(formData.get('max_bounty')) : null,
            auto_accept: formData.get('auto_accept') === 'on',
            auto_reject_below_min: formData.get('auto_reject_below_min') === 'on',
            allow_team_bounties: formData.get('allow_team_bounties') === 'on',
        };
        
        try {
            const response = await fetch('{% url "user_profile:settings_matchmaking_save" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Matchmaking settings saved', 'success');
                showInlineFeedback('matchmaking-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to save matchmaking settings';
                showToast(errorMsg, 'error');
                showInlineFeedback('matchmaking-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Matchmaking save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('matchmaking-form', 'Network error', 'error');
        } finally {
            // Restore button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }

    // Save Notification Settings
    async function saveNotificationsSettings(event) {
        if (event) event.preventDefault();
        
        const form = document.getElementById('notifications-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button ? button.innerHTML : '';
        
        // Loading state
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        }
        
        const formData = new FormData(form);
        
        const data = {
            // Delivery channels
            email_enabled: formData.get('email_enabled') === 'on',
            push_enabled: formData.get('push_enabled') === 'on',
            sms_enabled: formData.get('sms_enabled') === 'on',
            
            // Categories
            notif_tournaments: formData.get('notif_tournaments') === 'on',
            notif_teams: formData.get('notif_teams') === 'on',
            notif_bounties: formData.get('notif_bounties') === 'on',
            notif_messages: formData.get('notif_messages') === 'on',
            notif_system: formData.get('notif_system') === 'on',
            
            // Quiet hours
            quiet_hours_enabled: formData.get('quiet_hours_enabled') === 'on',
            quiet_hours_start: formData.get('quiet_hours_start') || null,
            quiet_hours_end: formData.get('quiet_hours_end') || null,
        };
        
        try {
            const response = await fetch('{% url "user_profile:settings_notifications_save" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Notification settings saved', 'success');
                showInlineFeedback('notifications-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to save notification settings';
                showToast(errorMsg, 'error');
                showInlineFeedback('notifications-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Notification save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('notifications-form', 'Network error', 'error');
        } finally {
            // Restore button
            if (button) {
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        }
    }

    // Save Loadout (hardware)
    async function saveLoadout(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = new FormData(form);
        
        // Phase 4B: Use simple HardwareLoadout API (single row, 4 brand fields)
        const data = {
            mouse_brand: formData.get('mouse_brand') || '',
            keyboard_brand: formData.get('keyboard_brand') || '',
            headset_brand: formData.get('headset_brand') || '',
            monitor_brand: formData.get('monitor_brand') || '',
        };
        
        try {
            const response = await fetch('{% url "user_profile:settings_loadout_save" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Loadout saved successfully', 'success');
                showInlineFeedback('loadout-form', 'Saved successfully', 'success');
                markSaved();
            } else {
                const errorMsg = result.message || result.error || 'Failed to save loadout';
                showToast(errorMsg, 'error');
                showInlineFeedback('loadout-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Loadout save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('loadout-form', 'Network error', 'error');
        } finally {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Save Stream URL
    async function saveStreamUrl(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = new FormData(form);
        
        const platform = formData.get('stream_platform');
        const url = formData.get('stream_url');
        
        if (!url || !url.trim()) {
            showToast('âŒ Please enter a stream URL', 'error');
            button.disabled = false;
            button.innerHTML = originalHTML;
            return;
        }
        
        // Build merged links: preserve existing non-stream links from context
        const existingLinks = [];
        {% for link in social_links %}
            {% if link.platform != 'twitch' and link.platform != 'youtube' %}
                existingLinks.push({
                    platform: '{{ link.platform }}',
                    url: '{{ link.url|escapejs }}'
                });
            {% endif %}
        {% endfor %}
        
        // Add new stream link
        existingLinks.push({
            platform: platform,
            url: url
        });
        
        try {
            const response = await fetch('{% url "user_profile:update_social_links_api" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    links: existingLinks
                }),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Stream URL saved', 'success');
                showInlineFeedback('stream-form', 'Stream URL saved - refresh page to see updated link', 'success');
                markSaved();
            } else {
                const errorMsg = result.error || 'Failed to save stream URL';
                showToast(errorMsg, 'error');
                showInlineFeedback('stream-form', errorMsg, 'error');
            }
        } catch (error) {
            console.error('Stream URL save error:', error);
            showToast('Network error', 'error');
            showInlineFeedback('stream-form', 'Network error', 'error');
        } finally {
            // Restore button
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // ========== PHASE 7C-P0: PRIVACY FULL MATRIX SAVE ==========
    
    async function savePrivacyFull(event) {
        event.preventDefault();
        autoSavePrivacy();
    }
    
    let privacySaveTimeout = null;
    async function autoSavePrivacy() {
        clearTimeout(privacySaveTimeout);
        privacySaveTimeout = setTimeout(async () => {
            const form = document.getElementById('privacy-form');
            if (!form) return;
            
            const formData = new FormData(form);
            const data = {};
            
            // Collect all checkboxes and select
            const fields = [
                'is_private_account', 'show_real_name', 'show_email', 'show_phone', 'show_age', 'show_gender', 'show_country',
                'show_game_ids', 'show_match_history', 'show_teams', 'show_achievements',
                'show_inventory_value', 'show_level_xp', 'show_social_links', 'show_following_list',
                'allow_team_invites', 'allow_friend_requests', 'allow_direct_messages'
            ];
            
            fields.forEach(field => {
                const input = form.querySelector(`[name="${field}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        data[field] = input.checked;
                    } else {
                        data[field] = input.value;
                    }
                }
            });
            
            // Inventory visibility
            const invVisibility = form.querySelector('[name="inventory_visibility"]');
            if (invVisibility) {
                data.inventory_visibility = invVisibility.value;
            }
            
            try {
                const response = await fetch('{% url "user_profile:update_privacy_settings" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('âœ… Privacy settings updated', 'success');
                } else {
                    showToast(`âŒ ${result.error || 'Failed to save privacy settings'}`, 'error');
                }
            } catch (error) {
                console.error('Privacy save error:', error);
                showToast('âŒ Network error', 'error');
            }
        }, 800);
    }

    // ========== PHASE 7C-P0: FOLLOW REQUESTS ==========
    
    let currentFollowRequestFilter = 'PENDING';
    
    async function loadFollowRequests(status = 'PENDING') {
        currentFollowRequestFilter = status;
        
        // Update filter buttons
        ['pending', 'approved', 'rejected'].forEach(s => {
            const btn = document.getElementById(`filter-${s}`);
            if (btn) {
                if (s === status.toLowerCase()) {
                    btn.classList.remove('bg-white/5', 'text-gray-400');
                    btn.classList.add('bg-white/10', 'text-white');
                } else {
                    btn.classList.remove('bg-white/10', 'text-white');
                    btn.classList.add('bg-white/5', 'text-gray-400');
                }
            }
        });
        
        try {
            const response = await fetch(`{% url "user_profile:get_follow_requests_api" %}?status=${status}`);
            const result = await response.json();
            
            if (result.success) {
                renderFollowRequests(result.requests, status);
            } else {
                showToast('Failed to load follow requests', 'error');
            }
        } catch (error) {
            console.error('Error loading follow requests:', error);
            showToast('Network error', 'error');
        }
    }
    
    function renderFollowRequests(requests, status) {
        const container = document.getElementById('follow-requests-list');
        if (!container) return;
        
        if (!requests || requests.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-center py-4">No ${status.toLowerCase()} follow requests</p>`;
            return;
        }
        
        container.innerHTML = requests.map(req => `
            <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-z-cyan to-z-purple flex items-center justify-center text-white font-bold">
                        ${req.requester.display_name.charAt(0)}
                    </div>
                    <div>
                        <p class="font-bold text-white text-sm">${escapeHtml(req.requester.display_name)}</p>
                        <p class="text-xs text-gray-400">@${escapeHtml(req.requester.username)}</p>
                        <p class="text-xs text-gray-500">${new Date(req.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    ${status === 'PENDING' ? `
                        <button onclick="respondToFollowRequest(${req.id}, 'approve')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700 transition">
                            <i class="fa-solid fa-check"></i> Approve
                        </button>
                        <button onclick="respondToFollowRequest(${req.id}, 'reject')" class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700 transition">
                            <i class="fa-solid fa-times"></i> Reject
                        </button>
                    ` : `
                        <span class="px-3 py-1 bg-white/10 text-gray-400 rounded-lg text-xs">${status.charAt(0) + status.slice(1).toLowerCase()}</span>
                    `}
                </div>
            </div>
        `).join('');
    }
    
    async function respondToFollowRequest(requestId, action) {
        try {
            const response = await fetch(`/profiles/dummy/follow/respond/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ request_id: requestId, action: action })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(`âœ… ${result.message}`, 'success');
                loadFollowRequests(currentFollowRequestFilter);
            } else {
                showToast(`âŒ ${result.error || 'Failed to respond'}`, 'error');
            }
        } catch (error) {
            console.error('Error responding to follow request:', error);
            showToast('âŒ Network error', 'error');
        }
    }
    
    // Helper function
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========== LEGACY/PLACEHOLDER REMOVAL ==========
    
    // Remove old placeholder functions (replaced above)
    async function linkNewGame() {
        // DEPRECATED: Use openPassportModal() instead
        openPassportModal();
    }

    // ========== OLD LEGACY FUNCTIONS - REMOVED (See PHASE 7B above for replacements) ==========
    // These are now implemented properly above

    // GP-FE-MVP-01: Load available games for passport creation
    async function loadGamesForPassport_OLD() {
        try {
            const response = await fetch('{% url "user_profile:get_available_games" %}');
            const result = await response.json();
            
            if (result.success && result.games) {
                const select = document.getElementById('passport-game-select');
                if (select) {
                    select.innerHTML = '<option value="">Select a game...</option>';
                    result.games.forEach(game => {
                        const option = document.createElement('option');
                        option.value = game.id;
                        option.textContent = game.name;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Failed to load games:', error);
        }
    }

    // ========== PHASE 7B LEGACY - ADDITIONAL PASSPORT FUNCTION DISABLED ==========
    /*
    // GP-FE-MVP-01: Create game passport
    async function createGamePassport(data) {
        try {
            const response = await fetch('{% url "user_profile:create_game_passport_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('âœ… Game passport created successfully', 'success');
                // Close modal if exists
                const modal = document.getElementById('add-passport-modal');
                if (modal) modal.classList.add('hidden');
                // Reload page to reflect changes
                setTimeout(() => window.location.reload(), 800);
            } else {
                const errorMsg = result.error || result.message || 'Failed to create passport';
                showToast(`âŒ ${errorMsg}`, 'error');
            }
        } catch (error) {
            console.error('Create passport error:', error);
            showToast('âŒ Network error', 'error');
        }
    }
    */
    // ========== END ADDITIONAL LEGACY PASSPORT CODE ==========

    // ========== PHASE 3B: ACCOUNT DELETION ==========
    
    // Load deletion status on page load
    async function loadDeletionStatus() {
        try {
            const response = await fetch('{% url "accounts:deletion_status" %}', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            
            const result = await response.json();
            
            if (result.success && result.data) {
                // User has scheduled deletion
                const data = result.data;
                document.getElementById('deletion-status-panel').style.display = 'block';
                document.getElementById('deletion-form-panel').style.display = 'none';
                
                // Format date
                const scheduledDate = new Date(data.scheduled_for);
                document.getElementById('deletion-date').textContent = scheduledDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Show days remaining
                document.getElementById('days-remaining').textContent = data.days_remaining;
            } else {
                // No deletion scheduled - show form
                document.getElementById('deletion-status-panel').style.display = 'none';
                document.getElementById('deletion-form-panel').style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading deletion status:', error);
        }
    }
    
    // Schedule account deletion
    async function scheduleDeletion(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        const confirmPhrase = document.getElementById('confirm-phrase').value;
        const password = document.getElementById('deletion-password')?.value || '';
        const reason = document.getElementById('deletion-reason').value;
        
        // Validate confirmation phrase
        if (confirmPhrase !== 'DELETE MY ACCOUNT') {
            showToast('âŒ Please type DELETE MY ACCOUNT exactly to confirm', 'error');
            return;
        }
        
        // Confirm action
        if (!confirm('âš ï¸ WARNING: This will immediately log you out and schedule your account for deletion in 14 days. Continue?')) {
            return;
        }
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Scheduling...';
        
        try {
            const response = await fetch('{% url "accounts:schedule_deletion" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    confirm_phrase: confirmPhrase,
                    password: password,
                    reason: reason
                }),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('âœ“ Account deletion scheduled. You will be logged out.', 'success');
                // Redirect to login after brief delay
                setTimeout(() => {
                    window.location.href = '/accounts/login/?deletion_scheduled=1';
                }, 2000);
            } else {
                const errorMsg = result.error || 'Failed to schedule deletion';
                showToast(errorMsg, 'error');
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        } catch (error) {
            console.error('Deletion scheduling error:', error);
            showToast('Network error', 'error');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }
    
    // Cancel account deletion
    async function cancelDeletion(event) {
        event.preventDefault();
        const button = event.target;
        const originalHTML = button.innerHTML;
        
        if (!confirm('Cancel your account deletion? You will be able to log in again.')) {
            return;
        }
        
        // Loading state
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Canceling...';
        
        try {
            const response = await fetch('{% url "accounts:cancel_deletion" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('âœ“ Account deletion canceled successfully', 'success');
                // Reload status
                await loadDeletionStatus();
            } else {
                const errorMsg = result.message || 'Failed to cancel deletion';
                showToast(errorMsg, 'error');
                button.disabled = false;
                button.innerHTML = originalHTML;
            }
        } catch (error) {
            console.error('Deletion cancellation error:', error);
            showToast('Network error', 'error');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // ==================== PHASE 3A + 4B: INVENTORY FUNCTIONS ====================
    
    let inventoryItems = []; // PHASE 4B: Cache for client-side filtering
    
    async function loadInventory() {
        const container = document.getElementById('inventory-list');
        if (!container) return;
        
        try {
            const response = await fetch('{% url "economy:my_inventory" %}', {
                headers: { 'X-CSRFToken': getCookie('csrftoken') }
            });
            const result = await response.json();
            
            if (result.success && result.data.items.length > 0) {
                inventoryItems = result.data.items; // PHASE 4B: Store for filtering
                applyInventoryFilters();
            } else {
                inventoryItems = [];
                container.innerHTML = '<p class="text-sm text-gray-500">No items in inventory.</p>';
            }
        } catch (error) {
            inventoryItems = [];
            container.innerHTML = '<p class="text-sm text-red-400">Failed to load inventory.</p>';
            console.error('Inventory load error:', error);
        }
    }
    
    // PHASE 4B: Search/Filter/Sort
    function applyInventoryFilters() {
        const container = document.getElementById('inventory-list');
        if (!container) return;
        
        const search = document.getElementById('inventory-search').value.toLowerCase();
        const rarityFilter = document.getElementById('inventory-rarity-filter').value;
        const sortOption = document.getElementById('inventory-sort').value;
        
        let filtered = inventoryItems.filter(item => {
            const matchesSearch = item.item_name.toLowerCase().includes(search);
            const matchesRarity = !rarityFilter || item.rarity === rarityFilter;
            return matchesSearch && matchesRarity;
        });
        
        // Sort
        if (sortOption === 'name-asc') {
            filtered.sort((a, b) => a.item_name.localeCompare(b.item_name));
        } else if (sortOption === 'quantity-desc') {
            filtered.sort((a, b) => b.quantity - a.quantity);
        } else if (sortOption === 'acquired-desc') {
            filtered.sort((a, b) => {
                const dateA = a.acquired_at ? new Date(a.acquired_at) : new Date(0);
                const dateB = b.acquired_at ? new Date(b.acquired_at) : new Date(0);
                return dateB - dateA;
            });
        }
        
        if (filtered.length > 0) {
            container.innerHTML = filtered.map(item => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition" onclick="openItemModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <div>
                        <div class="font-bold text-white">${item.item_name}</div>
                        <div class="text-xs text-gray-400">Qty: ${item.quantity} | Rarity: ${item.rarity}</div>
                    </div>
                    <div class="text-xs text-gray-500">${item.acquired_from}</div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-sm text-gray-500">No matching items.</p>';
        }
    }
    
    // PHASE 4B: Item Detail Modal
    function openItemModal(item) {
        document.getElementById('item-detail-modal').classList.remove('hidden');
        document.getElementById('modal-item-name').textContent = item.item_name;
        
        const icon = document.getElementById('modal-item-icon');
        if (item.item_icon) {
            icon.src = item.item_icon;
            icon.alt = item.item_name;
            document.getElementById('modal-item-icon-container').style.display = 'flex';
        } else {
            document.getElementById('modal-item-icon-container').style.display = 'none';
        }
        
        document.getElementById('modal-item-rarity').textContent = item.rarity || '-';
        document.getElementById('modal-item-quantity').textContent = item.quantity || '-';
        document.getElementById('modal-item-tradable').textContent = item.is_tradable !== false ? 'Yes' : 'No';
        document.getElementById('modal-item-giftable').textContent = item.is_giftable !== false ? 'Yes' : 'No';
        document.getElementById('modal-item-acquired').textContent = item.acquired_from || 'Unknown';
    }
    
    function closeItemModal(event) {
        if (event && event.target.id !== 'item-detail-modal') return;
        document.getElementById('item-detail-modal').classList.add('hidden');
    }
    
    // ESC key to close modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !document.getElementById('item-detail-modal').classList.contains('hidden')) {
            closeItemModal();
        }
    });

    // PHASE 4B: Gift Confirmation
    async function sendGift(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        // Confirmation
        const recipient = form.recipient_username.value;
        const itemSlug = form.item_slug.value;
        const quantity = form.quantity.value;
        
        if (!confirm(`Send ${quantity}x ${itemSlug} to ${recipient}?`)) {
            return;
        }
        
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
        
        const data = {
            recipient_username: recipient,
            item_slug: itemSlug,
            quantity: parseInt(quantity),
            message: form.message.value
        };
        
        try {
            const response = await fetch('{% url "economy:gift_item" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast('Gift sent successfully', 'success');
                form.reset();
                loadInventory();
                loadRequests(); // Refresh outgoing requests
            } else {
                showToast(result.error || 'Failed to send gift', 'error');
            }
        } catch (error) {
            showToast('Network error', 'error');
            console.error('Gift error:', error);
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    async function proposeTrade(event) {
        event.preventDefault();
        const form = event.target;
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Proposing...';
        
        const data = {
            target_username: form.target_username.value,
            offered_item_slug: form.offered_item_slug.value,
            offered_quantity: parseInt(form.offered_quantity.value),
            requested_item_slug: form.requested_item_slug.value || null,
            requested_quantity: form.requested_quantity.value ? parseInt(form.requested_quantity.value) : null,
            message: form.message.value
        };
        
        try {
            const response = await fetch('{% url "economy:trade_request" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast('Trade request sent successfully', 'success');
                form.reset();
                loadInventory();
            } else {
                showToast(result.error || 'Failed to propose trade', 'error');
            }
        } catch (error) {
            showToast('Network error', 'error');
            console.error('Trade error:', error);
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // ==================== PHASE 4A/4C: INVENTORY REQUESTS ====================
    
    // PHASE 4C: Notification tracking
    let lastKnownRequestIds = { incoming: new Set(), outgoing: new Set() };
    let notifiedRequestIds = new Set();
    let pollingInterval = null;
    let browserNotificationsEnabled = false;
    let hasAskedForPermission = false;
    
    async function loadRequests(isPolling = false) {
        try {
            // TODO: Add 'inventory:requests_list' URL pattern or verify this is correct
            const response = await fetch('/me/inventory/requests/');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to load requests');
            }
            
            // PHASE 4C: Detect changes and trigger notifications
            if (isPolling) {
                detectAndNotifyChanges(data.data);
            } else {
                // Initial load: populate known IDs without notifying
                initializeKnownRequests(data.data);
            }
            
            renderIncomingRequests(data.data.incoming);
            renderOutgoingRequests(data.data.outgoing);
        } catch (err) {
            console.error('[Phase 4A] Failed to load requests:', err);
            document.getElementById('incoming-requests-list').innerHTML = 
                '<p class="text-sm text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> Error loading requests</p>';
            document.getElementById('outgoing-requests-list').innerHTML = 
                '<p class="text-sm text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> Error loading requests</p>';
        }
    }
    
    // PHASE 4C: Initialize known requests on first load
    function initializeKnownRequests(data) {
        const incoming = data.incoming;
        const outgoing = data.outgoing;
        
        lastKnownRequestIds.incoming = new Set(
            [...incoming.gifts, ...incoming.trades].map(r => `${r.type}-${r.id}`)
        );
        lastKnownRequestIds.outgoing = new Set(
            [...outgoing.gifts, ...outgoing.trades].map(r => `${r.type}-${r.id}`)
        );
        
        // Mark all as notified to avoid toasts on page load
        notifiedRequestIds = new Set([...lastKnownRequestIds.incoming, ...lastKnownRequestIds.outgoing]);
    }
    
    // PHASE 4C: Detect changes and trigger notifications
    function detectAndNotifyChanges(data) {
        const incoming = data.incoming;
        const outgoing = data.outgoing;
        
        const currentIncomingIds = new Set(
            [...incoming.gifts, ...incoming.trades].map(r => `${r.type}-${r.id}`)
        );
        const currentOutgoingIds = new Set(
            [...outgoing.gifts, ...outgoing.trades].map(r => `${r.type}-${r.id}`)
        );
        
        // Detect new incoming requests
        [...incoming.gifts, ...incoming.trades].forEach(request => {
            const requestKey = `${request.type}-${request.id}`;
            if (!lastKnownRequestIds.incoming.has(requestKey) && !notifiedRequestIds.has(requestKey)) {
                notifyNewIncomingRequest(request);
                notifiedRequestIds.add(requestKey);
            }
        });
        
        // Detect status changes in outgoing requests
        [...outgoing.gifts, ...outgoing.trades].forEach(request => {
            const requestKey = `${request.type}-${request.id}-${request.status}`;
            if ((request.status === 'ACCEPTED' || request.status === 'REJECTED') && !notifiedRequestIds.has(requestKey)) {
                notifyOutgoingStatusChange(request);
                notifiedRequestIds.add(requestKey);
            }
        });
        
        // Update known IDs
        lastKnownRequestIds.incoming = currentIncomingIds;
        lastKnownRequestIds.outgoing = currentOutgoingIds;
    }
    
    // PHASE 4C: Notify new incoming request
    function notifyNewIncomingRequest(request) {
        const isGift = request.type === 'gift';
        const sender = isGift ? request.sender_username : request.initiator_username;
        const message = isGift 
            ? `ðŸŽ You received a gift from ${sender}` 
            : `ðŸ” New trade request from ${sender}`;
        
        showToast(message, 'info');
        
        // Browser notification if enabled
        if (browserNotificationsEnabled && Notification.permission === 'granted') {
            const notification = new Notification('DeltaCrown - New Request', {
                body: message,
                icon: '/static/img/logo.png',
                tag: `request-${request.id}`
            });
            notification.onclick = () => {
                window.focus();
                switchTab('inventory');
            };
        }
        
        // Ask for browser notification permission on first incoming request
        if (!hasAskedForPermission && Notification.permission === 'default') {
            hasAskedForPermission = true;
            setTimeout(() => requestNotificationPermission(), 2000);
        }
    }
    
    // PHASE 4C: Notify outgoing status change
    function notifyOutgoingStatusChange(request) {
        const isGift = request.type === 'gift';
        const recipient = isGift ? request.receiver_username : request.target_username;
        const accepted = request.status === 'ACCEPTED';
        
        let message;
        if (isGift) {
            message = accepted 
                ? `âœ… ${recipient} accepted your gift` 
                : `âŒ ${recipient} rejected your gift`;
        } else {
            message = accepted 
                ? `âœ… Trade accepted by ${recipient}` 
                : `âŒ Trade rejected by ${recipient}`;
        }
        
        showToast(message, accepted ? 'success' : 'info');
        
        // Browser notification if enabled
        if (browserNotificationsEnabled && Notification.permission === 'granted') {
            const notification = new Notification('DeltaCrown - Request Update', {
                body: message,
                icon: '/static/img/logo.png',
                tag: `request-${request.id}-status`
            });
            notification.onclick = () => {
                window.focus();
                switchTab('inventory');
            };
        }
    }
    
    // PHASE 4C: Request browser notification permission
    async function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            try {
                const permission = await Notification.requestPermission();
                browserNotificationsEnabled = permission === 'granted';
                if (browserNotificationsEnabled) {
                    showToast('Browser notifications enabled', 'success');
                }
            } catch (err) {
                console.log('[Phase 4C] Notification permission denied or error:', err);
            }
        }
    }
    
    // PHASE 4C: Start polling
    function startPolling() {
        if (pollingInterval) return; // Already polling
        
        pollingInterval = setInterval(() => {
            // Only poll if on inventory tab and page is visible
            if (document.getElementById('tab-inventory').style.display !== 'none' && !document.hidden) {
                loadRequests(true);
            }
        }, 30000); // 30 seconds
    }
    
    // PHASE 4C: Stop polling on page unload
    window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
    });
    
    // PHASE 4C: Pause polling when tab hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        } else if (!document.hidden && document.getElementById('tab-inventory').style.display !== 'none') {
            startPolling();
        }
    });
    
    function renderIncomingRequests(incoming) {
        const container = document.getElementById('incoming-requests-list');
        const gifts = incoming.gifts || [];
        const trades = incoming.trades || [];
        
        if (gifts.length === 0 && trades.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400"><i class="fa-solid fa-inbox-in"></i> No incoming requests</p>';
            return;
        }
        
        let html = '';
        
        // Render Gifts
        gifts.forEach(gift => {
            const statusBadge = getStatusBadge(gift.status);
            const isPending = gift.status === 'PENDING';
            const isExpired = gift.expires_at && new Date(gift.expires_at) < new Date();
            
            html += `
                <div class="bg-black/30 rounded-xl p-4 border border-white/10">
                    <div class="flex items-start gap-4">
                        <img src="${gift.sender_avatar || '/static/img/default-avatar.png'}" alt="${gift.sender_username}" class="w-12 h-12 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-white">${gift.sender_username}</span>
                                <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
                                <span class="text-xs text-gray-400">Gift</span>
                                ${statusBadge}
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                ${gift.item_icon ? `<img src="${gift.item_icon}" alt="${gift.item_name}" class="w-8 h-8 rounded">` : '<i class="fa-solid fa-cube text-gray-500 w-8 h-8 flex items-center justify-center"></i>'}
                                <div>
                                    <span class="text-sm text-white">${gift.item_name}</span>
                                    <span class="text-xs text-gray-400 ml-1">x${gift.quantity}</span>
                                </div>
                            </div>
                            ${gift.message ? `<p class="text-xs text-gray-300 italic mb-2">"${gift.message}"</p>` : ''}
                            <div class="text-xs text-gray-500">
                                Sent ${new Date(gift.created_at).toLocaleDateString()}
                                ${isExpired ? '<span class="text-red-400 ml-2"><i class="fa-solid fa-clock"></i> Expired</span>' : ''}
                            </div>
                            ${isPending && !isExpired ? `
                                <div class="flex gap-2 mt-3">
                                    <button onclick="respondToRequest('gift', ${gift.id}, 'ACCEPT')" 
                                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1">
                                        <i class="fa-solid fa-check"></i> Accept
                                    </button>
                                    <button onclick="respondToRequest('gift', ${gift.id}, 'REJECT')" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1">
                                        <i class="fa-solid fa-times"></i> Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Render Trades
        trades.forEach(trade => {
            const statusBadge = getStatusBadge(trade.status);
            const isPending = trade.status === 'PENDING';
            const isExpired = trade.expires_at && new Date(trade.expires_at) < new Date();
            
            html += `
                <div class="bg-black/30 rounded-xl p-4 border border-white/10">
                    <div class="flex items-start gap-4">
                        <img src="${trade.initiator_avatar || '/static/img/default-avatar.png'}" alt="${trade.initiator_username}" class="w-12 h-12 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-white">${trade.initiator_username}</span>
                                <i class="fa-solid fa-arrow-right text-gray-400 text-xs"></i>
                                <span class="text-xs text-gray-400">Trade</span>
                                ${statusBadge}
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-2">
                                <div>
                                    <div class="text-xs text-gray-400 mb-1">They offer:</div>
                                    <div class="flex items-center gap-2">
                                        ${trade.offered_item_icon ? `<img src="${trade.offered_item_icon}" alt="${trade.offered_item_name}" class="w-6 h-6 rounded">` : '<i class="fa-solid fa-cube text-gray-500"></i>'}
                                        <span class="text-xs text-white">${trade.offered_item_name} x${trade.offered_quantity}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400 mb-1">For your:</div>
                                    <div class="flex items-center gap-2">
                                        ${trade.requested_item_icon ? `<img src="${trade.requested_item_icon}" alt="${trade.requested_item_name}" class="w-6 h-6 rounded">` : '<i class="fa-solid fa-cube text-gray-500"></i>'}
                                        <span class="text-xs text-white">${trade.requested_item_name} x${trade.requested_quantity}</span>
                                    </div>
                                </div>
                            </div>
                            ${trade.message ? `<p class="text-xs text-gray-300 italic mb-2">"${trade.message}"</p>` : ''}
                            <div class="text-xs text-gray-500">
                                Proposed ${new Date(trade.created_at).toLocaleDateString()}
                                ${isExpired ? '<span class="text-red-400 ml-2"><i class="fa-solid fa-clock"></i> Expired</span>' : ''}
                            </div>
                            ${isPending && !isExpired ? `
                                <div class="flex gap-2 mt-3">
                                    <button onclick='respondToRequest("trade", ${trade.id}, "ACCEPT", ${JSON.stringify({
                                        offered_item_name: trade.requested_item_name,
                                        offered_quantity: trade.requested_quantity,
                                        requested_item_name: trade.offered_item_name,
                                        requested_quantity: trade.offered_quantity
                                    })})' 
                                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1">
                                        <i class="fa-solid fa-check"></i> Accept
                                    </button>
                                    <button onclick="respondToRequest('trade', ${trade.id}, 'REJECT')" 
                                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold transition flex items-center gap-1">
                                        <i class="fa-solid fa-times"></i> Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function renderOutgoingRequests(outgoing) {
        const container = document.getElementById('outgoing-requests-list');
        const gifts = outgoing.gifts || [];
        const trades = outgoing.trades || [];
        
        if (gifts.length === 0 && trades.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400"><i class="fa-solid fa-paper-plane"></i> No outgoing requests</p>';
            return;
        }
        
        let html = '';
        
        // Render Gifts
        gifts.forEach(gift => {
            const statusBadge = getStatusBadge(gift.status);
            const isPending = gift.status === 'PENDING';
            
            html += `
                <div class="bg-black/30 rounded-xl p-4 border border-white/10">
                    <div class="flex items-start gap-4">
                        <img src="${gift.receiver_avatar || '/static/img/default-avatar.png'}" alt="${gift.receiver_username}" class="w-12 h-12 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-white">${gift.receiver_username}</span>
                                <i class="fa-solid fa-arrow-left text-gray-400 text-xs"></i>
                                <span class="text-xs text-gray-400">Gift</span>
                                ${statusBadge}
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                ${gift.item_icon ? `<img src="${gift.item_icon}" alt="${gift.item_name}" class="w-8 h-8 rounded">` : '<i class="fa-solid fa-cube text-gray-500 w-8 h-8"></i>'}
                                <div>
                                    <span class="text-sm text-white">${gift.item_name}</span>
                                    <span class="text-xs text-gray-400 ml-1">x${gift.quantity}</span>
                                </div>
                            </div>
                            ${gift.message ? `<p class="text-xs text-gray-300 italic mb-2">"${gift.message}"</p>` : ''}
                            <div class="text-xs text-gray-500">Sent ${new Date(gift.created_at).toLocaleDateString()}</div>
                            ${isPending ? `
                                <button onclick="respondToRequest('gift', ${gift.id}, 'CANCEL')" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold mt-3 transition flex items-center gap-1">
                                    <i class="fa-solid fa-ban"></i> Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        // Render Trades
        trades.forEach(trade => {
            const statusBadge = getStatusBadge(trade.status);
            const isPending = trade.status === 'PENDING';
            
            html += `
                <div class="bg-black/30 rounded-xl p-4 border border-white/10">
                    <div class="flex items-start gap-4">
                        <img src="${trade.target_avatar || '/static/img/default-avatar.png'}" alt="${trade.target_username}" class="w-12 h-12 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-sm font-bold text-white">${trade.target_username}</span>
                                <i class="fa-solid fa-arrow-left text-gray-400 text-xs"></i>
                                <span class="text-xs text-gray-400">Trade</span>
                                ${statusBadge}
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-2">
                                <div>
                                    <div class="text-xs text-gray-400 mb-1">You offer:</div>
                                    <div class="flex items-center gap-2">
                                        ${trade.offered_item_icon ? `<img src="${trade.offered_item_icon}" alt="${trade.offered_item_name}" class="w-6 h-6 rounded">` : '<i class="fa-solid fa-cube text-gray-500"></i>'}
                                        <span class="text-xs text-white">${trade.offered_item_name} x${trade.offered_quantity}</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-400 mb-1">For their:</div>
                                    <div class="flex items-center gap-2">
                                        ${trade.requested_item_icon ? `<img src="${trade.requested_item_icon}" alt="${trade.requested_item_name}" class="w-6 h-6 rounded">` : '<i class="fa-solid fa-cube text-gray-500"></i>'}
                                        <span class="text-xs text-white">${trade.requested_item_name} x${trade.requested_quantity}</span>
                                    </div>
                                </div>
                            </div>
                            ${trade.message ? `<p class="text-xs text-gray-300 italic mb-2">"${trade.message}"</p>` : ''}
                            <div class="text-xs text-gray-500">Proposed ${new Date(trade.created_at).toLocaleDateString()}</div>
                            ${isPending ? `
                                <button onclick="respondToRequest('trade', ${trade.id}, 'CANCEL')" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold mt-3 transition flex items-center gap-1">
                                    <i class="fa-solid fa-ban"></i> Cancel
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function getStatusBadge(status) {
        const badges = {
            'PENDING': '<span class="bg-yellow-500/20 text-yellow-500 px-2 py-0.5 rounded text-xs font-bold">PENDING</span>',
            'ACCEPTED': '<span class="bg-green-500/20 text-green-500 px-2 py-0.5 rounded text-xs font-bold">ACCEPTED</span>',
            'REJECTED': '<span class="bg-red-500/20 text-red-500 px-2 py-0.5 rounded text-xs font-bold">REJECTED</span>',
            'CANCELED': '<span class="bg-gray-500/20 text-gray-400 px-2 py-0.5 rounded text-xs font-bold">CANCELED</span>'
        };
        return badges[status] || '';
    }
    
    async function respondToRequest(type, requestId, action, requestData = null) {
        const actionVerb = action === 'ACCEPT' ? 'accepting' : action === 'REJECT' ? 'rejecting' : 'canceling';
        
        // PHASE 4C: Trade accept confirmation (P1 fix)
        if (action === 'ACCEPT' && type === 'trade' && requestData) {
            const offeredItem = requestData.offered_item_name || 'items';
            const offeredQty = requestData.offered_quantity || '';
            const requestedItem = requestData.requested_item_name || 'items';
            const requestedQty = requestData.requested_quantity || '';
            
            const confirmMsg = `You are about to accept this trade:\n\nYou will give:\n- ${offeredQty}x ${offeredItem}\n\nYou will receive:\n- ${requestedQty}x ${requestedItem}\n\nProceed?`;
            
            if (!confirm(confirmMsg)) {
                return; // User canceled
            }
        }
        
        try {
            // TODO: Add 'inventory:trade_respond' URL pattern or verify this is correct
            const response = await fetch('/me/inventory/trade/respond/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    request_type: type,
                    request_id: requestId,
                    action: action
                })
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || `Failed to ${actionVerb} request`);
            }
            
            showToast(data.message || `${action.toLowerCase().charAt(0).toUpperCase() + action.toLowerCase().slice(1)}ed successfully!`, 'success');
            
            // Reload requests
            loadRequests();
            
            // Reload inventory if accepted (item counts changed)
            if (action === 'ACCEPT') {
                loadInventory();
            }
        } catch (err) {
            console.error(`[Phase 4A] Failed to ${actionVerb} request:`, err);
            showToast(err.message || `Failed to ${actionVerb} request`, 'error');
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        // Phase 9A-10C: Restore last active tab from localStorage
        let initialTab = 'identity';
        try {
            const savedTab = localStorage.getItem('settings_active_tab');
            if (savedTab) {
                // Verify tab exists before restoring
                const targetSection = document.getElementById('tab-' + savedTab);
                if (targetSection) {
                    initialTab = savedTab;
                }
            }
        } catch (e) {
            console.warn('Could not restore tab selection:', e);
        }
        
        switchTab(initialTab);
        
        // Add event listeners to all inputs to track changes
        document.querySelectorAll('input, textarea, select').forEach(el => {
            if (!el.hasAttribute('oninput') && !el.hasAttribute('onchange')) {
                el.addEventListener('input', markUnsaved);
                el.addEventListener('change', markUnsaved);
            }
        });
        
        // Load deletion status (Phase 3B)
        loadDeletionStatus();
        
        // Load inventory (Phase 3A)
        loadInventory();
        
        // Load inventory requests (Phase 4A)
        loadRequests();
        
        // PHASE 4C: Start polling for updates
        startPolling();
        
        // PHASE 5A: Load platform settings if platform tab exists
        if (document.getElementById('tab-platform')) {
            loadPlatformSettings();
        }
        
        // PHASE 7B: DISABLED - Legacy passport code replaced by Phase 9A
        // Phase 9A uses on-demand initialization via switchTab() hook
        // if (document.getElementById('tab-passports')) {
        //     loadPassportsList();
        // }
        
        // PHASE 7C-P0: Load follow requests if privacy tab exists
        if (document.getElementById('tab-privacy')) {
            loadFollowRequests('PENDING');
        }
    });
    
    // PHASE 4C: Deep-link tab switching support
    // Allows profile page to link directly to specific settings tabs
    // Example: /me/settings/#identity or /me/settings/?tab=recruitment
    function initializeTabDeepLinking() {
        // Check URL hash (e.g., #identity)
        const hash = window.location.hash.slice(1); // Remove '#'
        
        // Check URL query param (e.g., ?tab=recruitment)
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        
        const targetTab = hash || tabParam;
        
        if (targetTab) {
            // Find the corresponding nav link
            const navLink = document.querySelector(`[data-nav="${targetTab}"]`);
            if (navLink) {
                // Simulate click to switch tab
                navLink.click();
                
                // Scroll to top after tab switch
                setTimeout(() => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            }
        }
    }
    
    // Run deep-linking after DOM is fully ready and tabs are initialized
    setTimeout(initializeTabDeepLinking, 500);

    // ============================================================================
    // PHASE 4C.3: SECURITY & KYC FUNCTIONS
    // ============================================================================

    // Change Password
    async function changePassword(event) {
        event.preventDefault();
        
        const form = document.getElementById('change-password-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Changing...';
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('{% url "user_profile:change_password" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(String(result.message || 'Password changed successfully'), 'success');
                form.reset();
                markSaved();
            } else {
                showToast(String(result.error || 'Failed to change password'), 'error');
            }
        } catch (error) {
            console.error('Password change error:', error);
            showToast('Network error - please try again', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Save Date of Birth
    async function saveDateOfBirth(event) {
        event.preventDefault();
        
        const form = document.getElementById('dob-form');
        const button = form.querySelector('button[type="submit"]');
        const originalHTML = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('{% url "user_profile:security_dob_save" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(String(result.message || 'Date of birth saved successfully'), 'success');
                markSaved();
                // Reload page to show age
                setTimeout(() => window.location.reload(), 1200);
            } else {
                showToast(String(result.error || 'Failed to save date of birth'), 'error');
            }
        } catch (error) {
            console.error('DOB save error:', error);
            showToast('Network error - please try again', 'error');
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Logout Other Sessions
    async function logoutOtherSessions() {
        if (!confirm('This will log you out of all other devices. Continue?')) {
            return;
        }
        
        try {
            const response = await fetch('{% url "user_profile:logout_other_sessions" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(String(result.message || 'Other sessions logged out'), 'success');
                // Refresh session info
                loadSessionInfo();
            } else {
                showToast(String(result.error || 'Failed to logout other sessions'), 'error');
            }
        } catch (error) {
            console.error('Logout sessions error:', error);
            showToast('Network error - please try again', 'error');
        }
    }

    // Load Session Info
    async function loadSessionInfo() {
        try {
            const response = await fetch('{% url "user_profile:session_info" %}');
            const result = await response.json();
            
            if (result.success) {
                const otherSessions = result.total_active_sessions - 1;
                const infoDiv = document.getElementById('other-sessions-info');
                
                if (otherSessions > 0) {
                    infoDiv.innerHTML = `
                        <div class="w-10 h-10 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-400">
                            <i class="fa-solid fa-devices"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 uppercase tracking-wider">Other Sessions</div>
                            <div class="text-sm font-semibold text-white">${otherSessions} active session${otherSessions > 1 ? 's' : ''}</div>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="w-10 h-10 rounded-lg bg-z-green/10 flex items-center justify-center text-z-green">
                            <i class="fa-solid fa-shield-check"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 uppercase tracking-wider">Other Sessions</div>
                            <div class="text-sm font-semibold text-white">No other active sessions</div>
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('Session info error:', error);
        }
    }

    // Load KYC Status
    async function loadKYCStatus() {
        try {
            const response = await fetch('{% url "user_profile:kyc_status_api" %}');
            const result = await response.json();
            
            if (result.success) {
                const badge = document.getElementById('kyc-status-badge');
                const content = document.getElementById('kyc-content');
                
                // Update badge
                const statusConfig = {
                    'verified': { 
                        color: 'bg-green-500/20 text-green-400', 
                        icon: 'fa-shield-check',
                        text: 'Verified'
                    },
                    'pending': { 
                        color: 'bg-yellow-500/20 text-yellow-400', 
                        icon: 'fa-clock',
                        text: 'Under Review'
                    },
                    'rejected': { 
                        color: 'bg-red-500/20 text-red-400', 
                        icon: 'fa-circle-xmark',
                        text: 'Rejected'
                    },
                    'unverified': { 
                        color: 'bg-gray-500/20 text-gray-400', 
                        icon: 'fa-circle-question',
                        text: 'Not Submitted'
                    }
                };
                
                const config = statusConfig[result.status] || statusConfig['unverified'];
                badge.className = `px-3 py-1 rounded-full text-xs font-bold ${config.color}`;
                badge.innerHTML = `<i class="fa-solid ${config.icon}"></i> ${config.text}`;
                
                // Update content
                if (result.status === 'verified') {
                    content.innerHTML = `
                        <div class="flex items-center gap-4 p-4 rounded-xl bg-green-500/10 border border-green-500/30">
                            <div class="w-12 h-12 rounded-full bg-green-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-shield-check text-green-400 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-1">Identity Verified</div>
                                <p class="text-xs text-gray-400">
                                    Your identity has been verified. You can now participate in premium tournaments and withdraw prizes.
                                </p>
                            </div>
                        </div>
                    `;
                } else if (result.status === 'pending') {
                    content.innerHTML = `
                        <div class="flex items-center gap-4 p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/30">
                            <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-clock text-yellow-400 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-1">Under Review</div>
                                <p class="text-xs text-gray-400">
                                    Your documents are being reviewed. This usually takes 24-48 hours.
                                </p>
                                ${result.submitted_at ? `<p class="text-xs text-gray-500 mt-2">Submitted: ${new Date(result.submitted_at).toLocaleString()}</p>` : ''}
                            </div>
                        </div>
                    `;
                } else if (result.status === 'rejected') {
                    content.innerHTML = `
                        <div class="flex items-center gap-4 p-4 rounded-xl bg-red-500/10 border border-red-500/30 mb-4">
                            <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center">
                                <i class="fa-solid fa-circle-xmark text-red-400 text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-1">Verification Rejected</div>
                                <p class="text-xs text-gray-400 mb-2">
                                    ${result.rejection_reason || 'Your documents did not meet our verification requirements.'}
                                </p>
                                <p class="text-xs text-gray-500">You can resubmit with corrected documents.</p>
                            </div>
                        </div>
                        <a href="{% url 'user_profile:kyc_upload' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-z-cyan text-black rounded-lg text-sm font-bold hover:bg-white transition">
                            <i class="fa-solid fa-upload"></i> Resubmit Documents
                        </a>
                    `;
                } else {
                    // unverified
                    content.innerHTML = `
                        <p class="text-sm text-gray-300 mb-4">
                            Complete KYC verification to unlock premium tournaments, prize withdrawals, and exclusive features.
                        </p>
                        <a href="{% url 'user_profile:kyc_upload' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-z-cyan text-black rounded-lg text-sm font-bold hover:bg-white transition">
                            <i class="fa-solid fa-id-card"></i> Start KYC Verification
                        </a>
                    `;
                }
            }
        } catch (error) {
            console.error('KYC status error:', error);
            document.getElementById('kyc-status-badge').innerHTML = '<i class="fa-solid fa-circle-exclamation"></i> Error Loading';
        }
    }

    // Initialize Security Tab on Page Load
    document.addEventListener('DOMContentLoaded', function() {
        // Load session info
        loadSessionInfo();
        
        // Load KYC status
        loadKYCStatus();

        // UP-PHASE7.6: Wallet PIN Setup Handler
        initPINSetup();
    });

    // ========================================================================
    // UP-PHASE7.6: Wallet PIN Setup/Change
    // ========================================================================
    function initPINSetup() {
        const pinForm = document.getElementById('pin-setup-form');
        if (!pinForm) return;

        pinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorDiv = document.getElementById('pin-error-message');
            const successDiv = document.getElementById('pin-success-message');
            
            // Hide messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            
            const pin = document.getElementById('pin').value;
            const confirmPin = document.getElementById('confirm-pin').value;
            const currentPinInput = document.getElementById('current-pin');
            
            // Validate PIN format
            if (pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                errorDiv.textContent = 'PIN must be exactly 6 digits';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate match
            if (pin !== confirmPin) {
                errorDiv.textContent = 'PIN and confirmation do not match';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            const submitBtn = pinForm.querySelector('button[type=submit]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Saving...';
            
            try {
                const formData = new FormData();
                formData.append('pin', pin);
                formData.append('confirm_pin', confirmPin);
                
                if (currentPinInput) {
                    const currentPin = currentPinInput.value;
                    if (!currentPin) {
                        errorDiv.textContent = 'Current PIN is required';
                        errorDiv.classList.remove('hidden');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    formData.append('current_pin', currentPin);
                }
                
                const response = await fetch('/api/wallet/pin/setup/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    successDiv.textContent = data.message || 'PIN set successfully!';
                    successDiv.classList.remove('hidden');
                    pinForm.reset();
                    
                    // Reload page after 2 seconds to update UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    errorDiv.textContent = data.error || 'Failed to set PIN';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('PIN setup error:', error);
                errorDiv.textContent = 'Failed to set PIN. Please try again.';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
</script>

<!-- PHASE 4B: Item Detail Modal -->
<div id="item-detail-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center" onclick="closeItemModal(event)">
    <div class="glass-panel p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <div class="flex items-start justify-between mb-4">
            <h3 class="text-2xl font-bold text-white" id="modal-item-name">Item Name</h3>
            <button onclick="closeItemModal()" class="text-gray-400 hover:text-white transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex items-center justify-center p-4 bg-black/30 rounded-xl" id="modal-item-icon-container">
                <img id="modal-item-icon" src="" alt="" class="w-32 h-32 rounded-lg">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <div class="text-xs text-gray-400 mb-1">Rarity</div>
                    <div id="modal-item-rarity" class="text-sm font-bold text-white">-</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1">Quantity Owned</div>
                    <div id="modal-item-quantity" class="text-sm font-bold text-white">-</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1">Tradable</div>
                    <div id="modal-item-tradable" class="text-sm font-bold text-white">-</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1">Giftable</div>
                    <div id="modal-item-giftable" class="text-sm font-bold text-white">-</div>
                </div>
            </div>
            <div id="modal-item-acquired-container">
                <div class="text-xs text-gray-400 mb-1">Acquired From</div>
                <div id="modal-item-acquired" class="text-sm text-gray-300">-</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
