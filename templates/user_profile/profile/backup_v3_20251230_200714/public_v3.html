{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ profile.display_name }} (@{{ profile_user.username }}) - DeltaCrown{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/design-tokens.css' %}">
<link rel="stylesheet" href="{% static 'user_profile/css/profile_v3.css' %}">
{% endblock %}

{% block content %}
<div class="profile-v3-container">
    <!-- HERO SECTION -->
    <section class="profile-hero">
        {% if profile.banner_url %}
        <img src="{{ profile.banner_url }}" alt="Banner" class="profile-hero-banner">
        {% endif %}
        <div class="profile-hero-overlay"></div>
        
        <div class="profile-hero-content">
            <div class="flex items-end gap-4">
                <!-- Avatar -->
                <div class="profile-avatar-wrapper">
                    {% if profile.avatar_url %}
                    <img src="{{ profile.avatar_url }}" alt="{{ profile.display_name }}" class="profile-avatar">
                    {% else %}
                    <div class="profile-avatar flex items-center justify-center text-3xl font-black text-white">
                        {{ profile.display_name|slice:":1"|upper }}
                    </div>
                    {% endif %}
                    
                    {% if profile.is_online %}
                    <div class="profile-status-indicator" title="Online"></div>
                    {% endif %}
                </div>
                
                <!-- Identity -->
                <div class="flex-1">
                    <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                        {{ profile.display_name }}
                        {% if profile.is_verified %}
                        <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        {% endif %}
                    </h1>
                    <p class="text-slate-400 text-sm">@{{ profile_user.username }}</p>
                    
                    <div class="flex items-center gap-2 mt-2">
                        <span class="badge">Lvl {{ profile.level|default:"1" }}</span>
                        {% if profile.country %}
                        <span class="badge">{{ profile.country }}</span>
                        {% endif %}
                        <span class="badge text-xs">Joined {{ profile_user.date_joined|date:"M Y" }}</span>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center gap-2">
                    {% if is_owner %}
                        <a href="{% url 'user_profile:profile_settings_v2' %}" class="btn-profile btn-primary">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Edit Profile
                        </a>
                    {% else %}
                        <button id="follow-btn" 
                                class="btn-profile {{ is_following|yesno:'btn-secondary,btn-primary' }}"
                                data-following="{{ is_following|yesno:'true,false' }}"
                                data-username="{{ profile_user.username }}">
                            <svg id="follow-icon-add" class="w-4 h-4 {{ is_following|yesno:'hidden,' }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                            </svg>
                            <svg id="follow-icon-check" class="w-4 h-4 {{ is_following|yesno:',hidden' }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span id="follow-text">{{ is_following|yesno:'Following,Follow' }}</span>
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>
    
    <!-- STATS + BIO -->
    <div class="profile-identity">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="follower-count">{{ follower_count|default:"0" }}</div>
                <div class="stat-label">Followers</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ following_count|default:"0" }}</div>
                <div class="stat-label">Following</div>
            </div>
            {% if user_stats.tournaments_played %}
            <div class="stat-item">
                <div class="stat-value">{{ user_stats.tournaments_played }}</div>
                <div class="stat-label">Tournaments</div>
            </div>
            {% endif %}
            {% if user_stats.total_wins %}
            <div class="stat-item">
                <div class="stat-value">{{ user_stats.total_wins }}</div>
                <div class="stat-label">Wins</div>
            </div>
            {% endif %}
        </div>
        
        {% if profile.bio %}
        <div class="mt-4 text-slate-300">
            <p id="bio-text" class="line-clamp-3 leading-relaxed">{{ profile.bio }}</p>
            {% if profile.bio|length > 200 %}
            <button id="bio-toggle" class="text-indigo-400 hover:text-indigo-300 text-sm font-semibold mt-1">Read more</button>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- 3-COLUMN GRID -->
        <div class="profile-grid">
            <!-- LEFT SIDEBAR -->
            <aside class="profile-sidebar-left space-y-4">
                <!-- About Section -->
                {% if about_items %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        About
                    </div>
                    
                    <div class="space-y-0">
                        {% for item in about_items %}
                        <div class="about-item">
                            <div class="about-icon">{{ item.icon_emoji|default:"üìå" }}</div>
                            <div class="flex-1">
                                <div class="font-semibold text-sm text-slate-200">{{ item.type }}</div>
                                <div class="text-sm text-slate-400">{{ item.display_text }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% elif is_owner %}
                <div class="profile-card">
                    <div class="profile-card-header">About</div>
                    <div class="profile-card-empty">
                        <svg class="empty-state-icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm">Share more about yourself</p>
                        <a href="{% url 'user_profile:profile_settings_v2' %}#about" class="btn-profile btn-secondary mt-3">Add About Info</a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Social Links -->
                {% if social_links %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                        Social Links
                    </div>
                    
                    <div class="space-y-2">
                        {% for link in social_links %}
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="social-link block">
                            <span>{{ link.platform|upper }}</span>
                            {% if link.handle %}
                            <span class="text-xs text-slate-400">@{{ link.handle }}</span>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% elif is_owner %}
                <div class="profile-card">
                    <div class="profile-card-header">Social Links</div>
                    <div class="profile-card-empty">
                        <p class="text-sm">Connect your social profiles</p>
                        <a href="{% url 'user_profile:profile_settings_v2' %}#social" class="btn-profile btn-secondary mt-3">Add Social Links</a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Public ID -->
                {% if profile.public_id %}
                <div class="profile-card">
                    <div class="profile-card-header">Public ID</div>
                    <div class="flex items-center gap-2">
                        <code class="flex-1 px-3 py-2 bg-slate-900 rounded text-sm text-indigo-300">{{ profile.public_id }}</code>
                        <button id="copy-public-id" data-public-id="{{ profile.public_id }}" class="btn-profile btn-secondary text-xs">Copy</button>
                    </div>
                </div>
                {% endif %}
            </aside>
            
            <!-- MAIN CONTENT -->
            <main class="profile-main space-y-4">
                <!-- Game Passports -->
                {% if pinned_passports or unpinned_passports %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        Game Passports
                    </div>
                    
                    <div class="space-y-3">
                        {% for passport in pinned_passports %}
                        <div class="game-passport-card pinned">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-bold text-white">{{ passport.game_display_name }}</span>
                                        <span class="text-xs px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded">Pinned</span>
                                        {% if passport.is_lft %}
                                        <span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-300 rounded">LFT</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="text-sm text-slate-300">
                                        <strong>{{ passport.in_game_name }}</strong>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 mt-2 text-xs text-slate-400">
                                        {% if passport.rank_name %}
                                        <span class="flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            {{ passport.rank_name }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if passport.region %}
                                        <span>üìç {{ passport.region }}</span>
                                        {% endif %}
                                        
                                        {% if passport.main_role %}
                                        <span>üé≠ {{ passport.main_role }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% for passport in unpinned_passports %}
                        <div class="game-passport-card">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-bold text-white">{{ passport.game_display_name }}</span>
                                        {% if passport.is_lft %}
                                        <span class="text-xs px-2 py-0.5 bg-green-500/20 text-green-300 rounded">LFT</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="text-sm text-slate-300">
                                        <strong>{{ passport.in_game_name }}</strong>
                                    </div>
                                    
                                    <div class="flex items-center gap-3 mt-2 text-xs text-slate-400">
                                        {% if passport.rank_name %}
                                        <span class="flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            {{ passport.rank_name }}
                                        </span>
                                        {% endif %}
                                        
                                        {% if passport.region %}
                                        <span>üìç {{ passport.region }}</span>
                                        {% endif %}
                                        
                                        {% if passport.main_role %}
                                        <span>üé≠ {{ passport.main_role }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% elif is_owner %}
                <div class="profile-card">
                    <div class="profile-card-header">Game Passports</div>
                    <div class="profile-card-empty">
                        <svg class="empty-state-icon mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
                        </svg>
                        <p class="text-sm">Add your game identities</p>
                        <a href="{% url 'user_profile:profile_settings_v2' %}#game-passports" class="btn-profile btn-secondary mt-3">Create Game Passport</a>
                    </div>
                </div>
                {% endif %}
                
                <!-- Achievements -->
                {% if achievements %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                        </svg>
                        Achievements
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        {% for achievement in achievements %}
                        <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded">
                            {% if achievement.icon %}
                            <div class="w-10 h-10 text-2xl">{{ achievement.icon }}</div>
                            {% else %}
                            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-full flex items-center justify-center text-xl">üèÜ</div>
                            {% endif %}
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-semibold text-white truncate">{{ achievement.name }}</div>
                                <div class="text-xs text-slate-400">{{ achievement.awarded_at|date:"M d, Y" }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Match History -->
                {% if match_history %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Recent Matches
                    </div>
                    
                    <div class="space-y-2">
                        {% for match in match_history|slice:":5" %}
                        <div class="p-3 bg-slate-800/30 rounded border border-slate-700/50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-white">{{ match.tournament_name|default:"Match" }}</span>
                                <span class="badge {% if match.is_user_winner %}badge-success{% else %}badge-warning{% endif %}">
                                    {% if match.is_user_winner %}Win{% else %}Loss{% endif %}
                                </span>
                            </div>
                            <div class="text-xs text-slate-400">{{ match.scheduled_time|date:"M d, Y" }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </main>
            
            <!-- RIGHT SIDEBAR -->
            <aside class="profile-sidebar-right space-y-4">
                <!-- Wallet (Owner Only) -->
                {% if is_owner %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Wallet
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="text-xs text-slate-400">Balance</div>
                            <div class="text-2xl font-bold text-white">{{ user_profile.deltacoin_balance|default:"0" }} DC</div>
                        </div>
                        
                        <div>
                            <div class="text-xs text-slate-400">Lifetime Earnings</div>
                            <div class="text-lg font-semibold text-green-400">{{ user_profile.lifetime_earnings|default:"0" }} DC</div>
                        </div>
                        
                        <p class="text-xs text-slate-500">View-only. Managed by Economy system.</p>
                    </div>
                </div>
                {% endif %}
                
                <!-- Teams -->
                {% if user_teams %}
                <div class="profile-card">
                    <div class="profile-card-header">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Teams
                    </div>
                    
                    <div class="space-y-2">
                        {% for team in user_teams %}
                        <div class="p-2 bg-slate-800/30 rounded">
                            <div class="font-semibold text-sm text-white">{{ team.name }}</div>
                            <div class="text-xs text-slate-400">{{ team.role|upper }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'user_profile/js/profile_v3.js' %}"></script>
{% endblock %}
