{% load profile_tags %}
<div class="space-y-8 animate-fade-in">
    
    {% if relationship_ctx.is_owner %}
    <!-- Composer -->
    <div class="glass-panel p-6 rounded-2xl border-l-4 border-z-cyan shadow-lg">
        <div class="flex gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-z-cyan to-z-purple p-0.5 flex-shrink-0">
                {% if profile.avatar %}
                <img src="{{ profile.avatar.url }}" class="w-full h-full object-cover rounded-xl bg-black">
                {% else %}
                <div class="w-full h-full rounded-xl bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold">
                    {{ profile_user.username|slice:":1"|upper }}
                </div>
                {% endif %}
            </div>
            <div class="flex-1">
                <textarea id="post-content-input" rows="2" placeholder="What's on your mind..." class="w-full bg-transparent text-white placeholder-gray-500 text-sm font-medium outline-none resize-none"></textarea>
                <div id="post-error-message" class="text-xs text-red-400 mt-1 hidden"></div>
                <div id="post-success-message" class="text-xs text-z-green mt-1 hidden"></div>
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-white/5">
                    <div class="flex gap-4 text-gray-400">
                        <button class="hover:text-z-cyan transition" title="Add media (coming soon)" disabled><i class="fa-solid fa-image"></i></button>
                        <select id="post-visibility" class="bg-transparent text-xs text-gray-400 border-none outline-none cursor-pointer">
                            <option value="public">üåç Public</option>
                            <option value="friends">üë• Friends</option>
                            <option value="private">üîí Private</option>
                        </select>
                    </div>
                    <button id="post-submit-btn" class="px-6 py-2 rounded-lg bg-z-cyan hover:bg-cyan-500 text-black text-xs font-bold uppercase transition">
                        Post
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Posts Feed -->
    <div id="posts-feed" class="space-y-6">
        {% if user_posts %}
            {% for post in user_posts %}
            <!-- Post Card -->
            <div class="post-card glass-panel p-6 rounded-2xl border {% if post.game %}border-z-green/20{% else %}border-white/5{% endif %} relative overflow-hidden group" data-post-id="{{ post.id }}">
                {% if post.game %}
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition"><i class="fa-solid fa-bullhorn text-6xl text-z-green"></i></div>
                {% endif %}
                
                <div class="flex items-start gap-3 mb-4 relative z-10">
                    <a href="/@{{ post.author.user.username }}/" class="flex-shrink-0">
                        {% if post.author.avatar %}
                        <img src="{{ post.author.avatar.url }}" class="w-10 h-10 rounded-lg object-cover">
                        {% else %}
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold text-sm">
                            {{ post.author.user.username|slice:":1"|upper }}
                        </div>
                        {% endif %}
                    </a>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <div>
                                <a href="/@{{ post.author.user.username }}/" class="text-white font-bold text-sm hover:text-z-cyan transition">
                                    {{ post.author.display_name|default:post.author.user.username }}
                                </a>
                                <a href="/@{{ post.author.user.username }}/" class="text-gray-500 font-normal text-xs hover:text-gray-400 transition ml-1">
                                    @{{ post.author.user.username }}
                                </a>
                            </div>
                            
                            {% if relationship_ctx.is_owner %}
                            <!-- Owner Actions Menu -->
                            <div class="relative">
                                <button class="post-menu-btn text-gray-500 hover:text-white p-2 rounded-lg hover:bg-white/5 transition" data-post-id="{{ post.id }}">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <div class="post-menu hidden absolute right-0 mt-2 w-40 glass-panel rounded-xl border border-white/10 shadow-xl z-50" data-menu-for="{{ post.id }}">
                                    <button class="post-edit-btn w-full text-left px-4 py-2 text-sm text-white hover:bg-white/10 rounded-t-xl transition" data-post-id="{{ post.id }}">
                                        <i class="fa-solid fa-pen mr-2 text-z-cyan"></i> Edit
                                    </button>
                                    <button class="post-delete-btn w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/10 rounded-b-xl transition" data-post-id="{{ post.id }}">
                                        <i class="fa-solid fa-trash mr-2"></i> Delete
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold flex items-center gap-2 mt-1">
                            <span>{{ post.created_at|timesince }} ago</span>
                            {% if post.game %}
                            <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                            <span class="text-z-green">{{ post.game }}</span>
                            {% endif %}
                            {% if post.visibility != 'public' %}
                            <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                            <span class="text-yellow-500">
                                {% if post.visibility == 'friends' %}üë• Friends{% elif post.visibility == 'private' %}üîí Private{% endif %}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mb-4 relative z-10">
                    {% if post.title %}
                    <h3 class="text-xl font-display font-bold text-white mb-2">{{ post.title }}</h3>
                    {% endif %}
                    <p class="post-content text-gray-300 text-sm leading-relaxed whitespace-pre-wrap">{{ post.content }}</p>
                    
                    <!-- Edit form (hidden by default) -->
                    <div class="post-edit-form hidden" data-post-id="{{ post.id }}">
                        <textarea class="edit-content-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white text-sm resize-none focus:outline-none focus:border-z-cyan" rows="3">{{ post.content }}</textarea>
                        <div class="edit-error-message text-xs text-red-400 mt-1 hidden"></div>
                        <div class="flex gap-2 mt-2">
                            <button class="save-edit-btn px-4 py-2 rounded-lg bg-z-cyan hover:bg-cyan-500 text-black text-xs font-bold transition">
                                Save
                            </button>
                            <button class="cancel-edit-btn px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white text-xs font-bold transition">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                {% if post.media.exists %}
                <div class="mb-4 grid {% if post.media.count == 1 %}grid-cols-1{% elif post.media.count == 2 %}grid-cols-2{% else %}grid-cols-2 md:grid-cols-3{% endif %} gap-2 relative z-10">
                    {% for media in post.media.all %}
                    <div class="rounded-lg overflow-hidden bg-black/20">
                        {% if media.media_type == 'image' or media.media_type == 'gif' %}
                        <img src="{{ media.file.url }}" alt="{{ media.alt_text|default:'Post media' }}" class="w-full h-full object-cover">
                        {% elif media.media_type == 'video' %}
                        <video src="{{ media.file.url }}" class="w-full h-full object-cover" controls></video>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="flex items-center gap-6 text-gray-500 text-sm relative z-10 pt-4 border-t border-white/5">
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-heart"></i> <span>{{ post.likes_count }}</span></button>
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-comment"></i> <span>{{ post.comments_count }}</span></button>
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-share-from-square"></i> <span>{{ post.shares_count }}</span></button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="glass-panel rounded-2xl p-12 text-center">
                <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-comment-dots text-gray-600 text-4xl"></i>
                </div>
                <h3 class="text-white font-bold text-lg mb-2">No posts yet</h3>
                <p class="text-gray-400 text-sm">
                    {% if relationship_ctx.is_owner %}
                    Share your first update with the community!
                    {% else %}
                    {{ profile.display_name|default:profile_user.username }} hasn't posted anything yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

{% if relationship_ctx.is_owner %}
<script>
(function() {
    const submitBtn = document.getElementById('post-submit-btn');
    const contentInput = document.getElementById('post-content-input');
    const visibilitySelect = document.getElementById('post-visibility');
    const errorMsg = document.getElementById('post-error-message');
    const successMsg = document.getElementById('post-success-message');
    const postsFeed = document.getElementById('posts-feed');
    
    if (!submitBtn || !contentInput) return;
    
    function showError(message) {
        if (errorMsg) {
            errorMsg.textContent = message;
            errorMsg.classList.remove('hidden');
        }
        if (successMsg) {
            successMsg.classList.add('hidden');
        }
    }
    
    function hideError() {
        if (errorMsg) {
            errorMsg.classList.add('hidden');
        }
    }
    
    function showSuccess(message) {
        if (successMsg) {
            successMsg.textContent = message;
            successMsg.classList.remove('hidden');
        }
        if (errorMsg) {
            errorMsg.classList.add('hidden');
        }
    }
    
    function formatTimeAgo(isoString) {
        return 'just now';
    }
    
    // Create post
    submitBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        hideError();
        
        const content = contentInput.value.trim();
        if (!content) {
            showError('Please enter some content for your post.');
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Posting...';
        
        try {
            const formData = new FormData();
            formData.append('content', content);
            formData.append('visibility', visibilitySelect.value);
            
            const response = await fetch('/api/profile/posts/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                contentInput.value = '';
                showSuccess('Posted successfully!');
                
                // Insert new post at top of feed
                const post = data.post;
                const postHTML = createPostCard(post);
                if (postsFeed.children.length > 0 && !postsFeed.children[0].classList.contains('post-card')) {
                    // Replace empty state
                    postsFeed.innerHTML = postHTML;
                } else {
                    postsFeed.insertAdjacentHTML('afterbegin', postHTML);
                }
                
                // Re-attach event listeners to new post
                attachPostEventListeners();
                
                setTimeout(() => hideError(), 3000);
            } else {
                showError(data.error || 'Failed to create post');
            }
        } catch (error) {
            console.error('Error creating post:', error);
            showError('Failed to create post. Please try again.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Post';
        }
    });
    
    function createPostCard(post) {
        const visibilityBadge = post.visibility !== 'public' ? 
            `<span class="w-1 h-1 bg-gray-600 rounded-full"></span>
            <span class="text-yellow-500">
                ${post.visibility === 'friends' ? 'üë• Friends' : 'üîí Private'}
            </span>` : '';
            
        return `
            <div class="post-card glass-panel p-6 rounded-2xl border border-white/5 relative overflow-hidden group" data-post-id="${post.id}">
                <div class="flex items-start gap-3 mb-4 relative z-10">
                    <a href="/@${post.author.username}/" class="flex-shrink-0">
                        ${post.author.avatar_url ? 
                            `<img src="${post.author.avatar_url}" class="w-10 h-10 rounded-lg object-cover">` :
                            `<div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-white font-bold text-sm">
                                ${post.author.username.charAt(0).toUpperCase()}
                            </div>`
                        }
                    </a>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <div>
                                <a href="/@${post.author.username}/" class="text-white font-bold text-sm hover:text-z-cyan transition">
                                    ${post.author.display_name}
                                </a>
                                <a href="/@${post.author.username}/" class="text-gray-500 font-normal text-xs hover:text-gray-400 transition ml-1">
                                    @${post.author.username}
                                </a>
                            </div>
                            <div class="relative">
                                <button class="post-menu-btn text-gray-500 hover:text-white p-2 rounded-lg hover:bg-white/5 transition" data-post-id="${post.id}">
                                    <i class="fa-solid fa-ellipsis"></i>
                                </button>
                                <div class="post-menu hidden absolute right-0 mt-2 w-40 glass-panel rounded-xl border border-white/10 shadow-xl z-50" data-menu-for="${post.id}">
                                    <button class="post-edit-btn w-full text-left px-4 py-2 text-sm text-white hover:bg-white/10 rounded-t-xl transition" data-post-id="${post.id}">
                                        <i class="fa-solid fa-pen mr-2 text-z-cyan"></i> Edit
                                    </button>
                                    <button class="post-delete-btn w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/10 rounded-b-xl transition" data-post-id="${post.id}">
                                        <i class="fa-solid fa-trash mr-2"></i> Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-500 uppercase font-bold flex items-center gap-2 mt-1">
                            <span>just now</span>
                            ${visibilityBadge}
                        </div>
                    </div>
                </div>
                <div class="mb-4 relative z-10">
                    <p class="post-content text-gray-300 text-sm leading-relaxed whitespace-pre-wrap">${post.content}</p>
                    <div class="post-edit-form hidden" data-post-id="${post.id}">
                        <textarea class="edit-content-input w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white text-sm resize-none focus:outline-none focus:border-z-cyan" rows="3">${post.content}</textarea>
                        <div class="edit-error-message text-xs text-red-400 mt-1 hidden"></div>
                        <div class="flex gap-2 mt-2">
                            <button class="save-edit-btn px-4 py-2 rounded-lg bg-z-cyan hover:bg-cyan-500 text-black text-xs font-bold transition">Save</button>
                            <button class="cancel-edit-btn px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white text-xs font-bold transition">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-gray-500 text-sm relative z-10 pt-4 border-t border-white/5">
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-heart"></i> <span>0</span></button>
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-comment"></i> <span>0</span></button>
                    <button class="flex items-center gap-2 hover:text-z-cyan transition"><i class="fa-regular fa-share-from-square"></i> <span>0</span></button>
                </div>
            </div>
        `;
    }
    
    // Edit/Delete functionality
    function attachPostEventListeners() {
        // Menu toggles
        document.querySelectorAll('.post-menu-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const postId = this.dataset.postId;
                const menu = document.querySelector(`[data-menu-for="${postId}"]`);
                // Close all other menus
                document.querySelectorAll('.post-menu').forEach(m => m.classList.add('hidden'));
                menu.classList.toggle('hidden');
            });
        });
        
        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.post-menu-btn') && !e.target.closest('.post-menu')) {
                document.querySelectorAll('.post-menu').forEach(m => m.classList.add('hidden'));
            }
        });
        
        // Edit buttons
        document.querySelectorAll('.post-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const postId = this.dataset.postId;
                const card = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                const content = card.querySelector('.post-content');
                const editForm = card.querySelector(`.post-edit-form[data-post-id="${postId}"]`);
                const menu = document.querySelector(`[data-menu-for="${postId}"]`);
                
                content.classList.add('hidden');
                editForm.classList.remove('hidden');
                menu.classList.add('hidden');
            });
        });
        
        // Cancel edit buttons
        document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const editForm = this.closest('.post-edit-form');
                const postId = editForm.dataset.postId;
                const card = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                const content = card.querySelector('.post-content');
                
                editForm.classList.add('hidden');
                content.classList.remove('hidden');
            });
        });
        
        // Save edit buttons
        document.querySelectorAll('.save-edit-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const editForm = this.closest('.post-edit-form');
                const postId = editForm.dataset.postId;
                const textarea = editForm.querySelector('.edit-content-input');
                const errorDiv = editForm.querySelector('.edit-error-message');
                const newContent = textarea.value.trim();
                
                if (!newContent) {
                    errorDiv.textContent = 'Content cannot be empty';
                    errorDiv.classList.remove('hidden');
                    return;
                }
                
                this.disabled = true;
                this.textContent = 'Saving...';
                
                try {
                    const formData = new FormData();
                    formData.append('content', newContent);
                    
                    const response = await fetch(`/api/profile/posts/${postId}/edit/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        const card = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                        const content = card.querySelector('.post-content');
                        content.textContent = newContent;
                        content.classList.remove('hidden');
                        editForm.classList.add('hidden');
                        errorDiv.classList.add('hidden');
                    } else {
                        errorDiv.textContent = data.error || 'Failed to update post';
                        errorDiv.classList.remove('hidden');
                    }
                } catch (error) {
                    errorDiv.textContent = 'Failed to update post. Please try again.';
                    errorDiv.classList.remove('hidden');
                } finally {
                    this.disabled = false;
                    this.textContent = 'Save';
                }
            });
        });
        
        // Delete buttons
        document.querySelectorAll('.post-delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm('Are you sure you want to delete this post?')) return;
                
                const postId = this.dataset.postId;
                const card = document.querySelector(`.post-card[data-post-id="${postId}"]`);
                
                try {
                    const response = await fetch(`/api/profile/posts/${postId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.95)';
                        card.style.transition = 'all 0.3s ease';
                        setTimeout(() => {
                            card.remove();
                            // Show empty state if no posts left
                            if (!document.querySelector('.post-card')) {
                                postsFeed.innerHTML = `
                                    <div class="glass-panel rounded-2xl p-12 text-center">
                                        <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4">
                                            <i class="fa-solid fa-comment-dots text-gray-600 text-4xl"></i>
                                        </div>
                                        <h3 class="text-white font-bold text-lg mb-2">No posts yet</h3>
                                        <p class="text-gray-400 text-sm">Share your first update with the community!</p>
                                    </div>
                                `;
                            }
                        }, 300);
                    } else {
                        alert(data.error || 'Failed to delete post');
                    }
                } catch (error) {
                    alert('Failed to delete post. Please try again.');
                }
            });
        });
    }
    
    // Attach listeners on page load
    attachPostEventListeners();
})();
</script>
{% endif %}
