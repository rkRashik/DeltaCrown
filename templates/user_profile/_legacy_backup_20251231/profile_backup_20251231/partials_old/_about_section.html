{% comment %}
UP-PHASE15: Facebook-style About Section
Displays user-curated About items with privacy filtering
Owner sees edit controls, viewers see permitted items only
{% endcomment %}

{% if about_items or is_owner %}
<section class="glass-card p-6 mb-6" id="about-section">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold text-slate-100 flex items-center gap-2">
            <span class="text-2xl">â„¹ï¸</span>
            About
        </h2>
        {% if is_owner %}
        <button 
            onclick="window.location.href='{% url 'user_profile:profile_settings_v2' %}?section=about'"
            class="btn-sm btn-secondary"
            title="Manage About section">
            <span class="text-sm">âœï¸ Edit</span>
        </button>
        {% endif %}
    </div>

    {% if about_items %}
    <div class="space-y-3" id="about-items-list">
        {% for item in about_items %}
        <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg hover:bg-slate-800/70 transition-colors"
             data-item-id="{{ item.id }}"
             data-item-type="{{ item.item_type }}">
            {% comment %} Icon/Emoji {% endcomment %}
            <div class="flex-shrink-0 text-2xl">
                {% if item.icon_emoji %}
                    {{ item.icon_emoji }}
                {% else %}
                    {% if item.item_type == 'team' %}ğŸ‘¥
                    {% elif item.item_type == 'game' %}ğŸ®
                    {% elif item.item_type == 'achievement' %}ğŸ†
                    {% elif item.item_type == 'stat' %}ğŸ“Š
                    {% elif item.item_type == 'bio' %}ğŸ‘¤
                    {% else %}ğŸ“Œ{% endif %}
                {% endif %}
            </div>

            {% comment %} Content {% endcomment %}
            <div class="flex-1">
                <p class="text-slate-200 text-sm md:text-base">
                    {{ item.display_text }}
                </p>
                {% if is_owner %}
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-slate-400">
                        {% if item.visibility == 'public' %}ğŸŒ Public
                        {% elif item.visibility == 'followers_only' %}ğŸ‘¥ Followers Only
                        {% else %}ğŸ”’ Private{% endif %}
                    </span>
                </div>
                {% endif %}
            </div>

            {% comment %} Owner Actions {% endcomment %}
            {% if is_owner %}
            <div class="flex-shrink-0 flex items-center gap-1">
                <button 
                    onclick="AboutManager.editItem({{ item.id }})"
                    class="p-2 text-slate-400 hover:text-cyan-400 transition-colors"
                    title="Edit">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </button>
                <button 
                    onclick="AboutManager.deleteItem({{ item.id }})"
                    class="p-2 text-slate-400 hover:text-red-400 transition-colors"
                    title="Delete">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    {% comment %} Empty State {% endcomment %}
    <div class="text-center py-8 text-slate-400">
        {% if is_owner %}
            <p class="text-sm mb-3">âœ¨ Showcase your achievements, roles, and highlights!</p>
            <button 
                onclick="window.location.href='{% url 'user_profile:profile_settings_v2' %}?section=about'"
                class="btn-sm btn-primary">
                + Add About Item
            </button>
        {% else %}
            <p class="text-sm">Nothing to show yet</p>
        {% endif %}
    </div>
    {% endif %}
</section>

{% comment %} Owner-only: Edit Modal {% endcomment %}
{% if is_owner %}
<div id="about-edit-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-slate-900 rounded-lg p-6 max-w-md w-full mx-4 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-white">Edit About Item</h3>
            <button onclick="AboutManager.closeModal()" class="text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="about-edit-form" onsubmit="AboutManager.saveEdit(event)">
            <input type="hidden" id="edit-item-id" name="item_id">

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">Display Text</label>
                <input 
                    type="text" 
                    id="edit-display-text" 
                    name="display_text"
                    maxlength="200"
                    required
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:border-cyan-500 focus:outline-none">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-300 mb-2">Icon (Emoji)</label>
                <input 
                    type="text" 
                    id="edit-icon-emoji" 
                    name="icon_emoji"
                    maxlength="10"
                    placeholder="ğŸ®"
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:border-cyan-500 focus:outline-none">
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-300 mb-2">Visibility</label>
                <select 
                    id="edit-visibility" 
                    name="visibility"
                    class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:border-cyan-500 focus:outline-none">
                    <option value="public">ğŸŒ Public</option>
                    <option value="followers_only">ğŸ‘¥ Followers Only</option>
                    <option value="private">ğŸ”’ Private</option>
                </select>
            </div>

            <div class="flex gap-3">
                <button 
                    type="button" 
                    onclick="AboutManager.closeModal()"
                    class="flex-1 px-4 py-2 bg-slate-700 text-white rounded hover:bg-slate-600 transition-colors">
                    Cancel
                </button>
                <button 
                    type="submit"
                    class="flex-1 px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition-colors">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

{% comment %} About Manager Script (Vanilla JS) {% endcomment %}
<script>
const AboutManager = {
    modal: null,
    form: null,

    init() {
        this.modal = document.getElementById('about-edit-modal');
        this.form = document.getElementById('about-edit-form');
    },

    editItem(itemId) {
        // Find item data in DOM
        const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
        if (!itemEl) return;

        // Get current values (would normally fetch from API for latest data)
        const displayText = itemEl.querySelector('.text-slate-200').textContent.trim();
        
        // Populate form
        document.getElementById('edit-item-id').value = itemId;
        document.getElementById('edit-display-text').value = displayText;

        // Show modal
        this.modal.style.display = 'flex';
    },

    closeModal() {
        if (this.modal) {
            this.modal.style.display = 'none';
        }
    },

    async saveEdit(event) {
        event.preventDefault();

        const formData = new FormData(this.form);
        const itemId = formData.get('item_id');
        const data = {
            display_text: formData.get('display_text'),
            icon_emoji: formData.get('icon_emoji'),
            visibility: formData.get('visibility')
        };

        try {
            const response = await fetch(`/api/profile/about/${itemId}/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Update failed');

            const result = await response.json();
            if (result.success) {
                // Reload page to show updated data
                window.location.reload();
            } else {
                alert('Error: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating About item:', error);
            alert('Failed to update item. Please try again.');
        }
    },

    async deleteItem(itemId) {
        if (!confirm('Delete this About item?')) return;

        try {
            const response = await fetch(`/api/profile/about/${itemId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Delete failed');

            const result = await response.json();
            if (result.success) {
                // Remove from DOM (or reload)
                const itemEl = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemEl) {
                    itemEl.style.opacity = '0';
                    itemEl.style.transform = 'scale(0.9)';
                    itemEl.style.transition = 'all 0.3s ease';
                    setTimeout(() => itemEl.remove(), 300);
                }
            } else {
                alert('Error: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting About item:', error);
            alert('Failed to delete item. Please try again.');
        }
    }
};

// Initialize on page load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => AboutManager.init());
} else {
    AboutManager.init();
}
</script>
{% endif %}
{% endif %}
