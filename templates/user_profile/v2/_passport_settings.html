{% comment %}
Passport Management Section for Settings Page (GP-FE-MVP-01)
- Toggle LFT, set visibility, pin/unpin, reorder
- Lock countdown warnings
- Tailwind + vanilla JS
{% endcomment %}

<div class="passport-management-section py-8">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Game Passports</h2>
    
    {% if all_passports %}
    <div class="passports-list space-y-4">
        {% for passport in all_passports %}
        <div class="passport-card bg-white dark:bg-gray-800 rounded-lg shadow p-4 border border-gray-200 dark:border-gray-700" data-game="{{ passport.game }}">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center space-x-3 mb-2">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white">{{ passport.game_display_name }}</h3>
                        <span class="text-sm font-mono text-gray-600 dark:text-gray-400">{{ passport.in_game_name }}</span>
                    </div>
                    
                    {% if passport.is_identity_locked %}
                    <div class="lock-warning bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded p-2 mb-3">
                        <p class="text-xs text-red-700 dark:text-red-300">
                            ðŸ”’ Identity locked until {{ passport.locked_until|date:"M d, Y" }} ({{ passport.locked_until|timeuntil }} remaining)
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="controls-grid grid grid-cols-1 md:grid-cols-3 gap-3">
                        {# LFT Toggle #}
                        <div class="control-item">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" 
                                       class="lft-toggle w-4 h-4 text-blue-600 rounded" 
                                       data-game="{{ passport.game }}"
                                       {% if passport.is_lft %}checked{% endif %}>
                                <span class="text-sm text-gray-700 dark:text-gray-300">Looking for Team</span>
                            </label>
                        </div>
                        
                        {# Visibility Selector #}
                        <div class="control-item">
                            <select class="visibility-selector w-full text-sm border border-gray-300 dark:border-gray-600 rounded px-2 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    data-game="{{ passport.game }}">
                                {% for choice in VISIBILITY_CHOICES %}
                                <option value="{{ choice.0 }}" {% if passport.visibility == choice.0 %}selected{% endif %}>
                                    {{ choice.1 }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        {# Pin Toggle #}
                        <div class="control-item">
                            <button class="pin-toggle w-full text-sm px-3 py-1 rounded border {% if passport.is_pinned %}bg-purple-100 dark:bg-purple-900 border-purple-500 text-purple-700 dark:text-purple-300{% else %}bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300{% endif %}"
                                    data-game="{{ passport.game }}"
                                    data-pinned="{{ passport.is_pinned|lower }}">
                                {% if passport.is_pinned %}ðŸ“Œ Pinned (#{{ passport.pinned_order }}){% else %}Pin to Profile{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
                
                {# Reorder buttons for pinned passports #}
                {% if passport.is_pinned %}
                <div class="reorder-controls flex flex-col space-y-1 ml-4">
                    <button class="move-up text-gray-600 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400"
                            data-game="{{ passport.game }}"
                            title="Move up">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    <button class="move-down text-gray-600 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400"
                            data-game="{{ passport.game }}"
                            title="Move down">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="pinned-count-info mt-4 text-sm text-gray-600 dark:text-gray-400">
        {{ pinned_passports|length }} of {{ MAX_PINNED_GAMES }} passports pinned
    </div>
    {% else %}
    <div class="no-passports text-center py-12">
        <p class="text-gray-600 dark:text-gray-400 mb-4">No game passports yet</p>
        <a href="#" class="inline-block px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
            Add Your First Game
        </a>
    </div>
    {% endif %}
</div>

<script>
// GP-FE-MVP-01: Passport management interactions
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // LFT Toggle
    document.querySelectorAll('.lft-toggle').forEach(toggle => {
        toggle.addEventListener('change', async function() {
            const game = this.dataset.game;
            const response = await fetch("{% url 'user_profile:passport_toggle_lft' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ game })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error, 'error');
                this.checked = !this.checked; // Revert on error
            }
        });
    });
    
    // Visibility Selector
    document.querySelectorAll('.visibility-selector').forEach(select => {
        select.addEventListener('change', async function() {
            const game = this.dataset.game;
            const visibility = this.value;
            
            const response = await fetch("{% url 'user_profile:passport_set_visibility' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ game, visibility })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error, 'error');
            }
        });
    });
    
    // Pin Toggle
    document.querySelectorAll('.pin-toggle').forEach(button => {
        button.addEventListener('click', async function() {
            const game = this.dataset.game;
            const isPinned = this.dataset.pinned === 'true';
            
            const response = await fetch("{% url 'user_profile:passport_pin' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ game, pin: !isPinned })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000); // Reload to update UI
            } else {
                showToast(data.error, 'error');
            }
        });
    });
    
    // Reorder buttons
    document.querySelectorAll('.move-up, .move-down').forEach(button => {
        button.addEventListener('click', async function() {
            const game = this.dataset.game;
            const direction = this.classList.contains('move-up') ? 'up' : 'down';
            
            // Get current pinned order
            const pinnedGames = Array.from(document.querySelectorAll('.passport-card[data-game]'))
                .filter(card => card.querySelector('.pin-toggle[data-pinned="true"]'))
                .map(card => card.dataset.game);
            
            const currentIndex = pinnedGames.indexOf(game);
            if (currentIndex === -1) return;
            
            // Swap
            if (direction === 'up' && currentIndex > 0) {
                [pinnedGames[currentIndex], pinnedGames[currentIndex - 1]] = 
                [pinnedGames[currentIndex - 1], pinnedGames[currentIndex]];
            } else if (direction === 'down' && currentIndex < pinnedGames.length - 1) {
                [pinnedGames[currentIndex], pinnedGames[currentIndex + 1]] = 
                [pinnedGames[currentIndex + 1], pinnedGames[currentIndex]];
            } else {
                return; // Can't move further
            }
            
            // Send new order
            const response = await fetch("{% url 'user_profile:passport_reorder' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ game_order: pinnedGames })
            });
            
            const data = await response.json();
            if (data.success) {
                showToast('Order updated', 'success');
                setTimeout(() => location.reload(), 500);
            } else {
                showToast(data.error, 'error');
            }
        });
    });
    
    // Toast notifications
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
});
</script>
