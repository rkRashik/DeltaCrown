{% extends "base.html" %}
{% load static %}

{% block title %}Profile Settings - DeltaCrown{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
{% endblock %}

{% block content %}
<div class="settings-container">
    
    <div class="settings-header">
        <h1 class="settings-title">Profile Settings</h1>
        <p class="settings-subtitle">Manage your account, privacy, and game profiles</p>
    </div>
    
    <div class="settings-layout">
        
        <!-- Sidebar Navigation -->
        <aside class="settings-sidebar">
            <nav class="settings-nav">
                <button class="nav-item active" data-section="profile">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-text">Profile</span>
                </button>
                <button class="nav-item" data-section="identity">
                    <span class="nav-icon">üÜî</span>
                    <span class="nav-text">Identity & KYC</span>
                </button>
                <button class="nav-item" data-section="games">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-text">Game IDs</span>
                </button>
                <button class="nav-item" data-section="socials">
                    <span class="nav-icon">üîó</span>
                    <span class="nav-text">Social Links</span>
                </button>
                <button class="nav-item" data-section="privacy">
                    <span class="nav-icon">üîí</span>
                    <span class="nav-text">Privacy</span>
                </button>
                <button class="nav-item" data-section="security">
                    <span class="nav-icon">üõ°Ô∏è</span>
                    <span class="nav-text">Security</span>
                </button>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="settings-main">
            
            <!-- Profile Section -->
            <section id="section-profile" class="settings-section active">
                <h2 class="section-title">Profile Information</h2>
                
                <form method="post" enctype="multipart/form-data" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label">Avatar</label>
                        <div class="avatar-upload">
                            {% if request.user.profile.avatar %}
                                <img src="{{ request.user.profile.avatar.url }}" alt="Avatar" class="avatar-preview">
                            {% else %}
                                <div class="avatar-preview default">{{ request.user.username|first|upper }}</div>
                            {% endif %}
                            <input type="file" name="avatar" accept="image/*" class="file-input" id="avatar-input">
                            <label for="avatar-input" class="btn btn-secondary">Change Avatar</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Banner Image</label>
                        <div class="banner-upload">
                            {% if request.user.profile.banner %}
                                <img src="{{ request.user.profile.banner.url }}" alt="Banner" class="banner-preview">
                            {% else %}
                                <div class="banner-preview default">No banner uploaded</div>
                            {% endif %}
                            <input type="file" name="banner" accept="image/*" class="file-input" id="banner-input">
                            <label for="banner-input" class="btn btn-secondary">Change Banner</label>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="username">Username</label>
                            <input type="text" id="username" name="username" value="{{ request.user.username }}" class="form-input" readonly>
                            <span class="form-hint">Username cannot be changed</span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="display_name">Display Name</label>
                            <input type="text" id="display_name" name="display_name" value="{{ request.user.profile.display_name }}" class="form-input" maxlength="80">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="bio">Bio</label>
                        <textarea id="bio" name="bio" class="form-input" rows="4" placeholder="Tell us about yourself...">{{ request.user.profile.bio }}</textarea>
                        <span class="form-hint">Maximum 500 characters</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="country">Country</label>
                            <input type="text" id="country" name="country" value="{{ request.user.profile.country }}" class="form-input">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="city">City</label>
                            <input type="text" id="city" name="city" value="{{ request.user.profile.city }}" class="form-input">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </section>
            
            <!-- Identity & KYC Section -->
            <section id="section-identity" class="settings-section">
                <h2 class="section-title">Identity & KYC Verification</h2>
                
                <div class="kyc-status-card">
                    {% if request.user.profile.is_kyc_verified %}
                        <div class="kyc-verified">
                            <span class="status-icon">‚úì</span>
                            <div>
                                <h3>KYC Verified</h3>
                                <p>Your identity has been verified</p>
                            </div>
                        </div>
                    {% else %}
                        <div class="kyc-unverified">
                            <span class="status-icon">‚ö†</span>
                            <div>
                                <h3>KYC Not Verified</h3>
                                <p>Verify your identity to unlock tournament features and prize withdrawals</p>
                                <a href="{% url 'user_profile:kyc_upload' %}" class="btn btn-primary">Start Verification</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <form method="post" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="real_full_name">Full Legal Name</label>
                            <input type="text" id="real_full_name" name="real_full_name" value="{{ request.user.profile.real_full_name }}" class="form-input" {% if request.user.profile.is_kyc_verified %}readonly{% endif %}>
                            {% if request.user.profile.is_kyc_verified %}
                                <span class="form-hint">Locked after KYC verification</span>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="date_of_birth">Date of Birth</label>
                            <input type="date" id="date_of_birth" name="date_of_birth" value="{{ request.user.profile.date_of_birth|date:'Y-m-d' }}" class="form-input" {% if request.user.profile.is_kyc_verified %}readonly{% endif %}>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="nationality">Nationality</label>
                        <input type="text" id="nationality" name="nationality" value="{{ request.user.profile.nationality }}" class="form-input" {% if request.user.profile.is_kyc_verified %}readonly{% endif %}>
                    </div>
                    
                    {% if not request.user.profile.is_kyc_verified %}
                        <button type="submit" class="btn btn-primary">Update Identity Info</button>
                    {% endif %}
                </form>
            </section>
            
            <!-- Game IDs Section -->
            <section id="section-games" class="settings-section">
                <h2 class="section-title">Game Profiles</h2>
                <p class="section-description">Manage your competitive gaming profiles and in-game usernames</p>
                
                <!-- Existing Game Profiles -->
                {% if game_profiles %}
                <div class="game-profiles-list" style="margin-bottom: 2rem;" x-data="{ editingId: null }">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #e2e8f0;">Your Game Profiles</h3>
                    {% for gp in game_profiles %}
                    <div class="game-profile-card" style="background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;">
                        
                        <!-- View Mode -->
                        <div x-show="editingId !== {{ gp.id }}" style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <span style="font-size: 1.5rem;">üéÆ</span>
                                    <h4 style="font-size: 1.1rem; font-weight: 700; color: white;">{{ gp.game_display_name }}</h4>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; color: #94a3b8; font-size: 0.875rem;">
                                    <div>
                                        <span style="color: #64748b;">In-Game Name:</span>
                                        <span style="color: white; font-weight: 600; margin-left: 0.25rem;">{{ gp.in_game_name }}</span>
                                    </div>
                                    {% if gp.rank_name %}
                                    <div>
                                        <span style="color: #64748b;">Rank:</span>
                                        <span style="color: #fbbf24; font-weight: 600; margin-left: 0.25rem;">{{ gp.rank_name }}</span>
                                    </div>
                                    {% endif %}
                                    {% if gp.main_role %}
                                    <div>
                                        <span style="color: #64748b;">Role:</span>
                                        <span style="color: #a78bfa; margin-left: 0.25rem;">{{ gp.main_role }}</span>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <span style="color: #64748b;">Matches:</span>
                                        <span style="color: white; margin-left: 0.25rem;">{{ gp.matches_played }}</span>
                                    </div>
                                    {% if gp.win_rate %}
                                    <div>
                                        <span style="color: #64748b;">Win Rate:</span>
                                        <span style="color: #10b981; margin-left: 0.25rem;">{{ gp.win_rate }}%</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button @click="editingId = {{ gp.id }}" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit</button>
                                <form method="post" action="{% url 'user_profile:delete_game_profile' gp.id %}" style="display: inline;" onsubmit="return confirm('Delete this game profile?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Delete</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div x-show="editingId === {{ gp.id }}" style="display: none;">
                            <form method="post" action="{% url 'user_profile:edit_game_profile' gp.id %}">
                                {% csrf_token %}
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                        <span style="font-size: 1.5rem;">üéÆ</span>
                                        <h4 style="font-size: 1.1rem; font-weight: 700; color: white;">{{ gp.game_display_name }}</h4>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        <div>
                                            <label style="display: block; color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.25rem;">In-Game Name *</label>
                                            <input type="text" name="in_game_name" value="{{ gp.in_game_name }}" required class="form-input" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                                        </div>
                                        <div>
                                            <label style="display: block; color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.25rem;">Rank</label>
                                            <input type="text" name="rank_name" value="{{ gp.rank_name }}" class="form-input" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                                        </div>
                                        <div style="grid-column: 1 / -1;">
                                            <label style="display: block; color: #94a3b8; font-size: 0.875rem; margin-bottom: 0.25rem;">Main Role</label>
                                            <input type="text" name="main_role" value="{{ gp.main_role }}" class="form-input" style="width: 100%; padding: 0.5rem; border-radius: 0.375rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button type="button" @click="editingId = null" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Cancel</button>
                                    <button type="submit" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Save Changes</button>
                                </div>
                            </form>
                        </div>
                        
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div style="background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; padding: 2rem; text-align: center; margin-bottom: 2rem;">
                    <span style="font-size: 3rem; opacity: 0.5;">üéÆ</span>
                    <p style="color: #94a3b8; margin-top: 0.5rem;">No game profiles added yet</p>
                    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0.25rem;">Add your first game profile using the form below</p>
                </div>
                {% endif %}
                
                <!-- Legacy Game IDs (Backward Compatibility) -->
                <details style="margin-bottom: 2rem;">
                    <summary style="cursor: pointer; font-weight: 600; color: #94a3b8; margin-bottom: 1rem;">Legacy Game IDs (Deprecated)</summary>
                    <form method="post" class="settings-form">
                        {% csrf_token %}
                    
                    <div class="game-id-group">
                        <h3 class="game-title">Riot Games</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="riot_id">Riot ID (Name#TAG)</label>
                                <input type="text" id="riot_id" name="riot_id" value="{{ request.user.profile.riot_id }}" class="form-input" placeholder="PlayerName#TAG">
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-id-group">
                        <h3 class="game-title">Steam Games</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="steam_id">Steam ID</label>
                                <input type="text" id="steam_id" name="steam_id" value="{{ request.user.profile.steam_id }}" class="form-input" placeholder="Your Steam ID">
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-id-group">
                        <h3 class="game-title">Mobile Legends</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="mlbb_id">Game ID</label>
                                <input type="text" id="mlbb_id" name="mlbb_id" value="{{ request.user.profile.mlbb_id }}" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="mlbb_server_id">Server ID</label>
                                <input type="text" id="mlbb_server_id" name="mlbb_server_id" value="{{ request.user.profile.mlbb_server_id }}" class="form-input">
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-id-group">
                        <h3 class="game-title">Other Games</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="ea_id">EA ID (FC 24)</label>
                                <input type="text" id="ea_id" name="ea_id" value="{{ request.user.profile.ea_id }}" class="form-input">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="pubg_mobile_id">PUBG Mobile ID</label>
                                <input type="text" id="pubg_mobile_id" name="pubg_mobile_id" value="{{ request.user.profile.pubg_mobile_id }}" class="form-input">
                            </div>
                        </div>
                    </div>
                    
                        <button type="submit" class="btn btn-primary">Save Game IDs</button>
                    </form>
                </details>
                
                <!-- Add New Game Profile -->
                <div class="add-game-profile" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 0.5rem; padding: 1.5rem;">
                    <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #e2e8f0;">Add New Game Profile</h3>
                    <form method="post" action="{% url 'user_profile:add_game_profile' %}" class="settings-form">
                        {% csrf_token %}
                        <input type="hidden" name="redirect_to" value="settings">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="game">Game</label>
                                <select id="game" name="game" class="form-input" required>
                                    <option value="">-- Select Game --</option>
                                    <option value="valorant">üéØ VALORANT</option>
                                    <option value="csgo">üî´ CS:GO</option>
                                    <option value="cs2">üî´ Counter-Strike 2</option>
                                    <option value="lol">‚öî League of Legends</option>
                                    <option value="dota2">üõ° Dota 2</option>
                                    <option value="overwatch">üéÆ Overwatch 2</option>
                                    <option value="apex">üèπ Apex Legends</option>
                                    <option value="fortnite">ü™Ç Fortnite</option>
                                    <option value="pubg">üî• PUBG</option>
                                    <option value="r6">üè∞ Rainbow Six Siege</option>
                                    <option value="rocket_league">üöó Rocket League</option>
                                    <option value="mlbb">‚ö° Mobile Legends</option>
                                    <option value="codm">üéñ Call of Duty Mobile</option>
                                    <option value="pubgm">üì± PUBG Mobile</option>
                                    <option value="freefire">üî• Free Fire</option>
                                    <option value="fc24">‚öΩ FC 24</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="in_game_name">In-Game Username</label>
                                <input type="text" id="in_game_name" name="in_game_name" class="form-input" placeholder="e.g., PlayerName#TAG" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="rank_name">Current Rank (Optional)</label>
                                <input type="text" id="rank_name" name="rank_name" class="form-input" placeholder="e.g., Diamond 2, Global Elite">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="main_role">Main Role (Optional)</label>
                                <input type="text" id="main_role" name="main_role" class="form-input" placeholder="e.g., Duelist, Support, Mid">
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">‚ûï Add Game Profile</button>
                    </form>
                </div>
            </section>
            
            <!-- Social Links Section -->
            <section id="section-socials" class="settings-section">
                <h2 class="section-title">Social Links</h2>
                
                <form method="post" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label" for="youtube_link">YouTube Channel</label>
                        <input type="url" id="youtube_link" name="youtube_link" value="{{ request.user.profile.youtube_link }}" class="form-input" placeholder="https://youtube.com/@channel">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="twitch_link">Twitch</label>
                        <input type="url" id="twitch_link" name="twitch_link" value="{{ request.user.profile.twitch_link }}" class="form-input" placeholder="https://twitch.tv/username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="discord_id">Discord ID</label>
                        <input type="text" id="discord_id" name="discord_id" value="{{ request.user.profile.discord_id }}" class="form-input" placeholder="username#1234">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="facebook">Facebook</label>
                            <input type="url" id="facebook" name="facebook" value="{{ request.user.profile.facebook }}" class="form-input" placeholder="https://facebook.com/profile">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="instagram">Instagram</label>
                            <input type="url" id="instagram" name="instagram" value="{{ request.user.profile.instagram }}" class="form-input" placeholder="https://instagram.com/username">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="twitter">Twitter/X</label>
                        <input type="url" id="twitter" name="twitter" value="{{ request.user.profile.twitter }}" class="form-input" placeholder="https://twitter.com/username">
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Social Links</button>
                </form>
            </section>
            
            <!-- Privacy Section -->
            <section id="section-privacy" class="settings-section">
                <h2 class="section-title">Privacy Settings</h2>
                
                <form method="post" class="settings-form">
                    {% csrf_token %}
                    
                    <div class="privacy-group">
                        <h3 class="privacy-title">Profile Visibility</h3>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_email" {% if request.user.profile.show_email %}checked{% endif %}>
                            <span>Show email address on public profile</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_phone" {% if request.user.profile.show_phone %}checked{% endif %}>
                            <span>Show phone number on public profile</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_real_name" {% if request.user.profile.show_real_name %}checked{% endif %}>
                            <span>Show real name on public profile</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_age" {% if request.user.profile.show_age %}checked{% endif %}>
                            <span>Show age on public profile</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_country" {% if request.user.profile.show_country %}checked{% endif %}>
                            <span>Show country on public profile</span>
                        </label>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="show_socials" {% if request.user.profile.show_socials %}checked{% endif %}>
                            <span>Show social links on public profile</span>
                        </label>
                    </div>
                    
                    <div class="privacy-group">
                        <h3 class="privacy-title">Account Privacy</h3>
                        
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_private" {% if request.user.profile.is_private %}checked{% endif %}>
                            <span>Make entire profile private</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Privacy Settings</button>
                </form>
            </section>
            
            <!-- Security Section -->
            <section id="section-security" class="settings-section">
                <h2 class="section-title">Security</h2>
                
                <div class="security-card">
                    <h3>Change Password</h3>
                    <p>Keep your account secure with a strong password</p>
                    <a href="{% url 'account:password_change' %}" class="btn btn-secondary">Change Password</a>
                </div>
                
                <div class="security-card">
                    <h3>Two-Factor Authentication</h3>
                    <p>Add an extra layer of security to your account</p>
                    <button class="btn btn-secondary" disabled>Coming Soon</button>
                </div>
                
                <div class="security-card danger">
                    <h3>Delete Account</h3>
                    <p>Permanently delete your account and all associated data</p>
                    <button class="btn btn-danger" onclick="alert('Please contact support to delete your account')">Delete Account</button>
                </div>
            </section>
            
        </main>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/settings.js' %}"></script>
{% endblock %}
