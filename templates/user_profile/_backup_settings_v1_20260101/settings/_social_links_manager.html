{% load static %}
<!-- UP-PHASE15 Session 3: Social Links Manager (Vanilla JS) -->

<div class="social-links-manager">
    <!-- Add New Link Button -->
    <button type="button" id="add-social-btn" class="btn btn-primary mb-4">
        â• Add Social Link
    </button>

    <!-- Social Links List -->
    <div id="social-links-list" class="space-y-3">
        <!-- Links will be loaded dynamically -->
        <div class="text-center py-8 text-slate-400" id="social-empty-state">
            <p>No social links yet. Connect your social media profiles!</p>
        </div>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal" id="social-modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title" id="social-modal-title">Add Social Link</h3>
            <button type="button" class="modal-close" id="close-social-modal">&times;</button>
        </div>

        <form id="social-form">
            <div class="modal-body">
                <input type="hidden" id="social-id" name="social_id">

                <div class="form-group">
                    <label class="form-label" for="social-platform">Platform *</label>
                    <select id="social-platform" name="platform" class="form-select" required>
                        <option value="">Select Platform</option>
                        <option value="facebook">ğŸ“˜ Facebook</option>
                        <option value="twitter">ğŸ¦ Twitter/X</option>
                        <option value="instagram">ğŸ“· Instagram</option>
                        <option value="youtube">â–¶ï¸ YouTube</option>
                        <option value="twitch">ğŸ® Twitch</option>
                        <option value="discord">ğŸ’¬ Discord</option>
                        <option value="tiktok">ğŸµ TikTok</option>
                        <option value="reddit">ğŸ¤– Reddit</option>
                        <option value="linkedin">ğŸ’¼ LinkedIn</option>
                        <option value="other">ğŸ”— Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="social-url">URL *</label>
                    <input type="url" id="social-url" name="url" class="form-input" 
                           placeholder="https://..." required>
                    <span class="form-hint">Enter the full URL to your profile</span>
                </div>

                <div class="form-group">
                    <label class="form-label" for="social-display-text">Display Text</label>
                    <input type="text" id="social-display-text" name="display_text" 
                           class="form-input" placeholder="e.g., @username" maxlength="50">
                    <span class="form-hint">Optional custom text to show (default: platform name)</span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-social-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-text">ğŸ’¾ Save Link</span>
                    <span class="btn-loading" style="display: none;">â³ Saving...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Social Link Card Template -->
<template id="social-link-template">
    <div class="social-link-card" data-link-id="">
        <div class="social-link-content">
            <span class="social-icon"></span>
            <div class="social-info">
                <div class="social-platform-name"></div>
                <div class="social-url"></div>
            </div>
        </div>
        <div class="social-link-actions">
            <button type="button" class="btn-icon btn-edit-social" title="Edit">âœï¸</button>
            <button type="button" class="btn-icon btn-delete-social" title="Delete">ğŸ—‘ï¸</button>
        </div>
    </div>
</template>

<style>
/* Social Links Styles */
.social-link-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.1);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.social-link-card:hover {
    border-color: rgba(59, 130, 246, 0.4);
    background: rgba(15, 23, 42, 0.8);
}

.social-link-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.social-icon {
    font-size: 1.5rem;
}

.social-info {
    flex: 1;
}

.social-platform-name {
    font-weight: 600;
    color: white;
    margin-bottom: 0.125rem;
}

.social-url {
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 400px;
}

.social-link-actions {
    display: flex;
    gap: 0.5rem;
}
</style>

<script type="module">
import { apiClient } from '{% static "js/api_client.js" %}';

class SocialLinksManager {
    constructor() {
        this.links = [];
        this.currentEditId = null;
    }

    async init() {
        this.cacheDom();
        this.bindEvents();
        await this.loadLinks();
    }

    cacheDom() {
        this.addBtn = document.getElementById('add-social-btn');
        this.linksList = document.getElementById('social-links-list');
        this.emptyState = document.getElementById('social-empty-state');
        this.modal = document.getElementById('social-modal');
        this.modalTitle = document.getElementById('social-modal-title');
        this.form = document.getElementById('social-form');
        this.closeModalBtn = document.getElementById('close-social-modal');
        this.cancelModalBtn = document.getElementById('cancel-social-btn');
        this.template = document.getElementById('social-link-template');
    }

    bindEvents() {
        this.addBtn.addEventListener('click', () => this.openModal());
        this.closeModalBtn.addEventListener('click', () => this.closeModal());
        this.cancelModalBtn.addEventListener('click', () => this.closeModal());
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        
        this.modal.addEventListener('click', (e) => {
            if (e.target === this.modal || e.target.classList.contains('modal-overlay')) {
                this.closeModal();
            }
        });
    }

    async loadLinks() {
        try {
            const response = await apiClient.get('/profile/api/social-links/');
            this.links = response.links || [];
            this.renderLinks();
        } catch (error) {
            console.error('Failed to load social links:', error);
            this.showAlert('error', 'Failed to load social links');
        }
    }

    renderLinks() {
        if (this.links.length === 0) {
            this.emptyState.style.display = 'block';
            Array.from(this.linksList.children).forEach(child => {
                if (child.id !== 'social-empty-state') child.remove();
            });
            return;
        }

        this.emptyState.style.display = 'none';
        
        Array.from(this.linksList.children).forEach(child => {
            if (child.id !== 'social-empty-state') child.remove();
        });

        this.links.forEach(link => {
            const card = this.createLinkCard(link);
            this.linksList.appendChild(card);
        });
    }

    createLinkCard(link) {
        const clone = this.template.content.cloneNode(true);
        const card = clone.querySelector('.social-link-card');
        
        card.setAttribute('data-link-id', link.id);
        
        const icon = card.querySelector('.social-icon');
        const platformName = card.querySelector('.social-platform-name');
        const url = card.querySelector('.social-url');
        
        const platformInfo = this.getPlatformInfo(link.platform);
        icon.textContent = platformInfo.icon;
        platformName.textContent = link.display_text || platformInfo.name;
        url.textContent = link.url;
        
        const editBtn = card.querySelector('.btn-edit-social');
        const deleteBtn = card.querySelector('.btn-delete-social');
        
        editBtn.addEventListener('click', () => this.editLink(link));
        deleteBtn.addEventListener('click', () => this.deleteLink(link.id));
        
        return clone;
    }

    getPlatformInfo(platform) {
        const platforms = {
            'facebook': { icon: 'ğŸ“˜', name: 'Facebook' },
            'twitter': { icon: 'ğŸ¦', name: 'Twitter/X' },
            'instagram': { icon: 'ğŸ“·', name: 'Instagram' },
            'youtube': { icon: 'â–¶ï¸', name: 'YouTube' },
            'twitch': { icon: 'ğŸ®', name: 'Twitch' },
            'discord': { icon: 'ğŸ’¬', name: 'Discord' },
            'tiktok': { icon: 'ğŸµ', name: 'TikTok' },
            'reddit': { icon: 'ğŸ¤–', name: 'Reddit' },
            'linkedin': { icon: 'ğŸ’¼', name: 'LinkedIn' },
            'other': { icon: 'ğŸ”—', name: 'Other' }
        };
        return platforms[platform] || platforms['other'];
    }

    openModal(link = null) {
        if (link) {
            this.currentEditId = link.id;
            this.modalTitle.textContent = 'Edit Social Link';
            document.getElementById('social-id').value = link.id;
            document.getElementById('social-platform').value = link.platform;
            document.getElementById('social-url').value = link.url;
            document.getElementById('social-display-text').value = link.display_text || '';
        } else {
            this.currentEditId = null;
            this.modalTitle.textContent = 'Add Social Link';
            this.form.reset();
        }
        
        this.modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    closeModal() {
        this.modal.style.display = 'none';
        document.body.style.overflow = '';
        this.form.reset();
        this.currentEditId = null;
    }

    async handleSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(this.form);
        const data = {
            platform: formData.get('platform'),
            url: formData.get('url'),
            display_text: formData.get('display_text') || null
        };
        
        // Validate URL
        try {
            new URL(data.url);
        } catch {
            this.showAlert('error', 'Please enter a valid URL');
            return;
        }
        
        const submitBtn = this.form.querySelector('button[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        
        try {
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            submitBtn.disabled = true;
            
            if (this.currentEditId) {
                data.id = this.currentEditId;
                await apiClient.post('/profile/api/social-links/update/', data);
                this.showAlert('success', 'Social link updated successfully');
            } else {
                await apiClient.post('/profile/api/social-links/create/', data);
                this.showAlert('success', 'Social link added successfully');
            }
            
            await this.loadLinks();
            this.closeModal();
            
        } catch (error) {
            console.error('Failed to save social link:', error);
            this.showAlert('error', error.message || 'Failed to save social link');
        } finally {
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            submitBtn.disabled = false;
        }
    }

    editLink(link) {
        this.openModal(link);
    }

    async deleteLink(linkId) {
        if (!confirm('Are you sure you want to delete this social link?')) {
            return;
        }
        
        try {
            await apiClient.post('/profile/api/social-links/delete/', { id: linkId });
            this.showAlert('success', 'Social link deleted successfully');
            await this.loadLinks();
        } catch (error) {
            console.error('Failed to delete social link:', error);
            this.showAlert('error', 'Failed to delete social link');
        }
    }

    showAlert(type, message) {
        if (window.settingsController) {
            window.settingsController.showAlert(type, message);
        } else {
            alert(message);
        }
    }
}

// Initialize on section activation
document.addEventListener('DOMContentLoaded', () => {
    const manager = new SocialLinksManager();
    
    const observer = new MutationObserver(() => {
        const section = document.querySelector('[data-section="social"]');
        if (section && !section.classList.contains('hidden')) {
            manager.init();
            observer.disconnect();
        }
    });
    
    observer.observe(document.body, { 
        childList: true, 
        subtree: true, 
        attributes: true,
        attributeFilter: ['class']
    });
});
</script>
