<!-- ============================================
     PASSPORT MODAL COMPONENT
     UP-INTEGRATION-HARDENING-01: Task D
     Schema-Driven Game Passport Creation
     ============================================ -->

<div x-data="passportModalData()" 
     @open-passport-modal.window="openModal()"
     @keydown.escape.window="closeModal()"
     x-show="isOpen"
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <!-- Modal Card -->
    <div @click.away="closeModal()"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         class="glass-card w-full max-w-lg max-h-[90vh] overflow-y-auto">
        
        <!-- Header -->
        <div class="sticky top-0 bg-slate-900/95 backdrop-blur-xl px-6 py-4 border-b border-white/10 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white uppercase tracking-wide">Add Game Passport</h2>
            <button @click="closeModal()" 
                    class="text-slate-400 hover:text-white text-2xl leading-none transition-colors">
                Ã—
            </button>
        </div>
        
        <!-- Body -->
        <div class="p-6">
            
            <!-- Error Message -->
            <div x-show="error" 
                 class="mb-4 p-4 rounded-lg bg-red-500/20 border border-red-500/50 text-red-300 text-sm">
                <span x-text="error"></span>
            </div>
            
            <!-- Game Selector -->
            <div class="mb-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Select Game *</label>
                <div class="relative">
                    <select x-model="formData.game_id" 
                            @change="onGameChange()"
                            required
                            class="glass-input w-full px-4 py-3 pr-10 rounded-lg text-white appearance-none cursor-pointer
                                   focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">-- Choose a Game --</option>
                        <template x-for="game in games" :key="game.id">
                            <option :value="game.id" x-text="game.display_name"></option>
                        </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- In-Game Name -->
            <div class="mb-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">
                    In-Game Name *
                    <span x-show="selectedGame?.requires_discriminator" class="text-slate-500 text-xs font-normal">
                        (without tag)
                    </span>
                </label>
                <input type="text" 
                       x-model="formData.ign"
                       :placeholder="selectedGame?.ign_placeholder || 'e.g., ProGamer'"
                       required
                       class="glass-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 
                              focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            </div>
            
            <!-- Discriminator (Riot Tag) -->
            <div x-show="selectedGame?.requires_discriminator" class="mb-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Tag / Discriminator *</label>
                <input type="text" 
                       x-model="formData.discriminator"
                       placeholder="e.g., NA1, 1234"
                       :required="selectedGame?.requires_discriminator"
                       class="glass-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 
                              focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <p class="text-slate-500 text-xs mt-1">Required for Riot Games (VALORANT, League of Legends)</p>
            </div>
            
            <!-- Platform (if applicable) -->
            <div x-show="selectedGame?.available_platforms?.length > 0" class="mb-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Platform</label>
                <div class="relative">
                    <select x-model="formData.platform"
                            class="glass-input w-full px-4 py-3 pr-10 rounded-lg text-white appearance-none cursor-pointer
                                   focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">-- Select Platform --</option>
                        <template x-for="platform in selectedGame?.available_platforms || []" :key="platform">
                            <option :value="platform" x-text="platform"></option>
                        </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Region (if applicable) -->
            <div x-show="selectedGame?.available_regions?.length > 0" class="mb-4">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Region</label>
                <div class="relative">
                    <select x-model="formData.region"
                            class="glass-input w-full px-4 py-3 pr-10 rounded-lg text-white appearance-none cursor-pointer
                                   focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="">-- Select Region --</option>
                        <template x-for="region in selectedGame?.available_regions || []" :key="region">
                            <option :value="region" x-text="region"></option>
                        </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <!-- Current Rank (Optional) -->
            <div class="mb-6">
                <label class="block text-slate-300 text-sm font-semibold mb-2">Current Rank (Optional)</label>
                <input type="text" 
                       x-model="formData.rank"
                       placeholder="e.g., Diamond 2, Immortal 3"
                       class="glass-input w-full px-4 py-3 rounded-lg text-white placeholder-slate-500 
                              focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                <p class="text-slate-500 text-xs mt-2">You can update detailed stats later</p>
            </div>
            
            <!-- Actions -->
            <div class="flex gap-3">
                <button type="button" 
                        @click="closeModal()"
                        :disabled="isSubmitting"
                        class="flex-1 px-6 py-3 rounded-lg font-bold text-white bg-slate-700 hover:bg-slate-600 transition-colors disabled:opacity-50">
                    Cancel
                </button>
                <button type="button"
                        @click="submitPassport()"
                        :disabled="isSubmitting || !formData.game_id || !formData.ign"
                        class="flex-1 px-6 py-3 rounded-lg font-bold text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <span x-show="!isSubmitting">ðŸŽ® Add Passport</span>
                    <span x-show="isSubmitting">Creating...</span>
                </button>
            </div>
            
        </div>
        
    </div>
    
</div>

<script>
function passportModalData() {
    return {
        isOpen: false,
        isSubmitting: false,
        error: null,
        games: [],
        selectedGame: null,
        formData: {
            game_id: '',
            ign: '',
            discriminator: '',
            platform: '',
            region: '',
            rank: ''
        },
        
        async init() {
            // Load games list on component init
            await this.loadGames();
        },
        
        async loadGames() {
            try {
                const response = await fetch('/api/games/', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to load games`);
                }
                
                const apiGames = await response.json();
                
                // Map API response to modal format with discriminator detection
                this.games = apiGames.map(game => ({
                    id: game.id,
                    code: game.slug,
                    display_name: game.display_name || game.name,
                    icon: game.icon || null,
                    // Riot games (VALORANT, LoL) require discriminator/tag
                    requires_discriminator: ['valorant', 'lol'].includes(game.slug.toLowerCase()),
                    ign_placeholder: this.getIGNPlaceholder(game.slug),
                    available_regions: this.getAvailableRegions(game.slug),
                    available_platforms: game.platforms || []
                }));
                
                console.log(`âœ… Loaded ${this.games.length} games from API`);
            } catch (error) {
                console.error('âŒ Failed to load games:', error);
                this.error = 'Failed to load games list. Please refresh the page.';
                
                // Graceful fallback to minimal hardcoded list
                this.games = [
                    { id: 1, code: 'valorant', display_name: 'VALORANT', requires_discriminator: true, ign_placeholder: 'YourGameName', available_regions: ['NA', 'EU'], available_platforms: [] },
                    { id: 2, code: 'lol', display_name: 'League of Legends', requires_discriminator: true, ign_placeholder: 'YourGameName', available_regions: ['NA', 'EU'], available_platforms: [] }
                ];
            }
        },
        
        getIGNPlaceholder(slug) {
            const placeholders = {
                'valorant': 'e.g., TenZ, Shroud',
                'lol': 'e.g., Faker, Caps',
                'csgo': 'e.g., s1mple, NiKo',
                'dota2': 'e.g., Miracle-, N0tail',
                'apex': 'e.g., ImperialHal',
                'overwatch': 'e.g., Proper, Kevster'
            };
            return placeholders[slug.toLowerCase()] || 'Your in-game name';
        },
        
        getAvailableRegions(slug) {
            const regionsByGame = {
                'valorant': ['NA', 'EU', 'LATAM', 'BR', 'AP', 'KR'],
                'lol': ['NA', 'EUW', 'EUNE', 'KR', 'CN', 'LAN', 'LAS', 'OCE', 'RU', 'TR'],
                'csgo': ['NA', 'EU', 'SA', 'ASIA', 'OCE'],
                'dota2': ['NA', 'EU', 'SEA', 'CN', 'SA'],
                'apex': ['NA', 'EU', 'APAC'],
                'overwatch': ['NA', 'EU', 'APAC']
            };
            return regionsByGame[slug.toLowerCase()] || ['NA', 'EU', 'APAC'];
        },
        
        openModal() {
            this.isOpen = true;
            this.error = null;
            this.resetForm();
        },
        
        closeModal() {
            this.isOpen = false;
            this.resetForm();
        },
        
        resetForm() {
            this.formData = {
                game_id: '',
                ign: '',
                discriminator: '',
                platform: '',
                region: '',
                rank: ''
            };
            this.selectedGame = null;
            this.error = null;
        },
        
        onGameChange() {
            this.selectedGame = this.games.find(g => g.id == this.formData.game_id);
            // Reset platform/region when game changes
            this.formData.platform = '';
            this.formData.region = '';
        },
        
        async submitPassport() {
            if (this.isSubmitting) return;
            
            this.isSubmitting = true;
            this.error = null;
            
            try {
                // Build payload
                const payload = {
                    game_id: parseInt(this.formData.game_id),
                    ign: this.formData.ign.trim()
                };
                
                // Add optional fields
                if (this.formData.discriminator) {
                    payload.discriminator = this.formData.discriminator.trim();
                }
                if (this.formData.platform) {
                    payload.platform = this.formData.platform;
                }
                if (this.formData.region) {
                    payload.region = this.formData.region;
                }
                if (this.formData.rank) {
                    payload.metadata = { rank: this.formData.rank.trim() };
                }
                
                // Call API (using global function from profile.js)
                if (typeof window.createPassport === 'function') {
                    const result = await window.createPassport(payload);
                    
                    // Success - add passport card dynamically without reload
                    if (typeof window.showToast === 'function') {
                        window.showToast('Game passport created successfully!');
                    }
                    
                    this.closeModal();
                    
                    // Dispatch event for profile page to handle new passport
                    window.dispatchEvent(new CustomEvent('passport-created', {
                        detail: { passport: result.passport }
                    }));
                    
                    // If addPassportCard function exists, use it
                    if (typeof window.addPassportCard === 'function') {
                        window.addPassportCard(result.passport);
                    } else {
                        // Fallback to reload if no dynamic handler
                        setTimeout(() => window.location.reload(), 500);
                    }
                } else {
                    throw new Error('Passport API not available');
                }
                
            } catch (error) {
                this.error = error.message || 'Failed to create passport';
                this.isSubmitting = false;
            }
        }
    };
}
</script>
