{% extends "base.html" %}
{% load static %}

{% block title %}{{ profile.display_name }} (@{{ profile_user.username }}) - Profile{% endblock %}

{% block extra_css %}
<link href="{% static 'css/user_profile/core.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Debug panel removed for production - only accessible via browser console for superusers -->

<!-- ============================================
     DELTACROWN ESPORTS HUD - USER PROFILE
     Phase 2 Implementation - Modular Architecture
     ============================================ -->

<div class="min-h-screen bg-slate-950" 
     x-data="{
        // Tab Management
        activeGameTab: '{{ game_profiles.0.game|default:"valorant" }}',
        mobileTab: 'info',
        
        // State Management
        isFollowing: false,
        walletBlurred: true,
        showNotifications: false,
        notificationCount: {{ unread_notification_count|default:0 }},
        
        // Toast Notification System
        toast: {
            show: false,
            message: '',
            icon: 'âœ“'
        },
        
        // Methods
        showToast(message, icon = 'âœ“') {
            this.toast.message = message;
            this.toast.icon = icon;
            this.toast.show = true;
            setTimeout(() => { this.toast.show = false; }, 3000);
        },
        
        copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                this.showToast('Copied to clipboard!', 'ðŸ“‹');
            }).catch(() => {
                this.showToast('Failed to copy', 'âŒ');
            });
        },
        
        shareProfile() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: '{{ profile.display_name }} - DeltaCrown', url: url });
            } else {
                this.copyToClipboard(url);
            }
        },
        
        toggleFollow() {
            this.isFollowing = !this.isFollowing;
            this.showToast(this.isFollowing ? 'Following!' : 'Unfollowed', this.isFollowing ? 'âœ“' : 'â„¹');
            // TODO: Implement AJAX call to backend
        }
     }">

    <!-- ============================================
         HERO BANNER SECTION (Full Width, 280px)
         Section 3.1.1 - Master Plan
         ============================================ -->
    <section class="relative w-full h-[280px] overflow-hidden">
        <!-- Background Image -->
        {% if profile.banner %}
        <img src="{{ profile.banner.url }}" 
             alt="{{ profile.display_name }} banner" 
             class="absolute inset-0 w-full h-full object-cover"
             loading="eager">
        {% else %}
        <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-indigo-900 via-slate-900 to-slate-950"></div>
        {% endif %}
        
        <!-- Gradient Fade (Bottom 120px) -->
        <div class="absolute bottom-0 left-0 right-0 h-32 hero-fade"></div>
        
        <!-- Content Layer (Bottom Aligned) -->
        <div class="absolute bottom-0 left-0 right-0 z-10">
            <div class="container mx-auto px-4 md:px-6 pb-6 max-w-7xl">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                    
                    <!-- Left: Avatar + Name + Metadata -->
                    <div class="flex items-end gap-4 md:gap-6">
                        <!-- Avatar with Online Ring -->
                        <div class="relative flex-shrink-0">
                            {% if profile.avatar %}
                            <img src="{{ profile.avatar.url }}" 
                                 alt="{{ profile.display_name }}" 
                                 class="w-32 h-32 md:w-40 md:h-40 rounded-full border-[6px] border-slate-950 object-cover
                                        {% if profile.stream_status %}ring-4 ring-emerald-500 ring-offset-4 ring-offset-slate-950 animate-pulse-border{% endif %}">
                            {% else %}
                            <div class="w-32 h-32 md:w-40 md:h-40 rounded-full border-[6px] border-slate-950 
                                        bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center 
                                        text-5xl font-black text-white
                                        {% if profile.stream_status %}ring-4 ring-emerald-500 ring-offset-4 ring-offset-slate-950 animate-pulse-border{% endif %}">
                                {{ profile.display_name|slice:":1"|upper }}
                            </div>
                            {% endif %}
                            
                            <!-- Live Badge -->
                            {% if profile.stream_status %}
                            <div class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full animate-pulse-glow">
                                ðŸ”´ LIVE
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Name, Username, Level, Team -->
                        <div class="pb-1 md:pb-2">
                            <div class="flex items-center gap-3 mb-1">
                                <h1 class="text-3xl md:text-5xl font-black text-white uppercase tracking-tight">
                                    {{ profile.display_name }}
                                </h1>
                                {% if profile.is_kyc_verified %}
                                <span class="text-blue-500 text-2xl md:text-3xl" title="KYC Verified">âœ“</span>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-3 text-slate-400 text-sm md:text-base">
                                <span>@{{ profile_user.username }}</span>
                                <span class="text-slate-600">â€¢</span>
                                <span class="text-amber-400 font-semibold">Lvl {{ profile.level }}</span>
                                {% if current_teams %}
                                <span class="text-slate-600 hidden md:inline">â€¢</span>
                                <span class="hidden md:inline">{{ current_teams.0.team.name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Floating Command Deck -->
                    <div class="flex gap-3 pb-1 md:pb-2 flex-wrap md:flex-nowrap">
                        {% if is_own_profile %}
                            <!-- Owner Actions -->
                            <a href="{% url 'user_profile:settings' %}" 
                               class="glass-card px-4 md:px-5 py-2 md:py-3 text-sm md:text-base font-semibold text-white hover-lift">
                                âš™ <span class="hidden md:inline">Settings</span>
                            </a>
                            <button @click="shareProfile()" 
                                    class="glass-card px-4 md:px-5 py-2 md:py-3 text-sm md:text-base font-semibold text-white hover-lift">
                                â†— <span class="hidden md:inline">Share</span>
                            </button>
                            
                            <!-- Notification Bell -->
                            <div class="relative">
                                <button @click="showNotifications = !showNotifications" 
                                        class="glass-card px-4 md:px-5 py-2 md:py-3 text-white hover-lift relative">
                                    ðŸ””
                                    <span x-show="notificationCount > 0" 
                                          x-text="notificationCount"
                                          class="absolute -top-1 -right-1 w-5 h-5 bg-rose-600 text-white text-xs font-bold rounded-full flex items-center justify-center animate-pulse-glow"></span>
                                </button>
                                
                                <!-- Notification Dropdown -->
                                <div x-show="showNotifications" 
                                     @click.away="showNotifications = false"
                                     x-transition
                                     class="absolute top-full right-0 mt-2 w-96 max-h-[500px] overflow-y-auto glass-card border border-slate-700 rounded-xl shadow-2xl z-50"
                                     style="display: none;">
                                    <div class="px-4 py-3 border-b border-slate-700">
                                        <h3 class="text-white font-bold">Notifications</h3>
                                    </div>
                                    <div class="px-4 py-8 text-center">
                                        <p class="text-slate-500 text-sm">All caught up! ðŸŽ‰</p>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Spectator Actions -->
                            <button @click="toggleFollow()" 
                                    class="px-5 md:px-6 py-2 md:py-3 text-sm md:text-base font-bold text-white rounded-lg transition-all duration-300 hover-lift"
                                    :class="isFollowing ? 'bg-slate-700' : 'bg-emerald-600 hover:bg-emerald-500'">
                                ðŸ‘¤ <span x-text="isFollowing ? 'Following' : 'Follow'"></span>
                            </button>
                            <button class="px-5 md:px-6 py-2 md:py-3 text-sm md:text-base font-bold text-white rounded-lg bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 transition-all duration-300 hover-lift">
                                âš” <span class="hidden md:inline">Challenge</span>
                            </button>
                            <button class="glass-card px-4 md:px-5 py-2 md:py-3 text-sm md:text-base font-semibold text-white hover-lift">
                                ðŸ’¬
                            </button>
                        {% endif %}
                    </div>
                    
                </div>
            </div>
        </div>
    </section>

    <!-- ============================================
         MAIN CONTENT AREA
         Section 3.1 & 3.2 - Master Plan
         ============================================ -->
    <div class="container mx-auto px-4 md:px-6 py-8 max-w-7xl">
        
        <!-- ============================================
             DESKTOP LAYOUT: 3-COLUMN GRID
             Hidden on Mobile (md:grid)
             ============================================ -->
        <div class="hidden md:grid md:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN (col-span-3) - Sticky -->
            <div class="col-span-3 space-y-6 sticky top-6 self-start">
                <!-- Component: Identity Card -->
                {% include 'user_profile/components/_identity_card.html' %}
                
                <!-- Component: Vital Statistics -->
                {% include 'user_profile/components/_vital_stats.html' %}
                
                <!-- Component: Connected Socials -->
                {% include 'user_profile/components/_social_links.html' %}
            </div>
            
            <!-- MIDDLE COLUMN (col-span-6) - Scrollable -->
            <div class="col-span-6 space-y-6">
                <!-- Component: Trophy Shelf -->
                {% include 'user_profile/components/_trophy_shelf.html' %}
                
                <!-- Component: Game Passport -->
                {% include 'user_profile/components/_game_passport.html' %}
                
                <!-- Component: Match History -->
                {% include 'user_profile/components/_match_history.html' %}
            </div>
            
            <!-- RIGHT COLUMN (col-span-3) - Sticky -->
            <div class="col-span-3 space-y-6 sticky top-6 self-start">
                <!-- Component: Current Team -->
                {% include 'user_profile/components/_team_card.html' %}
                
                <!-- Component: Wallet -->
                {% include 'user_profile/components/_wallet_card.html' %}
                
                <!-- Component: Certificates -->
                {% include 'user_profile/components/_certificates.html' %}
            </div>
            
        </div>
        
        <!-- ============================================
             MOBILE LAYOUT: STICKY TAB NAVIGATION
             Visible only on Mobile (md:hidden)
             Section 3.2 - Master Plan
             ============================================ -->
        <div class="md:hidden">
            
            <!-- Sticky Tab Bar -->
            <div class="sticky top-0 z-40 bg-slate-950/90 backdrop-blur-xl border-b border-white/10 -mx-4 px-4 mb-6">
                <div class="flex">
                    <button @click="mobileTab = 'info'"
                            :class="mobileTab === 'info' ? 'border-b-2 border-indigo-500 text-white' : 'text-slate-400'"
                            class="flex-1 py-4 text-sm font-bold uppercase tracking-wide transition-colors">
                        Info
                    </button>
                    <button @click="mobileTab = 'games'"
                            :class="mobileTab === 'games' ? 'border-b-2 border-indigo-500 text-white' : 'text-slate-400'"
                            class="flex-1 py-4 text-sm font-bold uppercase tracking-wide transition-colors">
                        Games
                    </button>
                    <button @click="mobileTab = 'career'"
                            :class="mobileTab === 'career' ? 'border-b-2 border-indigo-500 text-white' : 'text-slate-400'"
                            class="flex-1 py-4 text-sm font-bold uppercase tracking-wide transition-colors">
                        Career
                    </button>
                </div>
            </div>
            
            <!-- Mobile Tab Content -->
            <div class="space-y-6">
                <!-- INFO Tab (Identity + Vitals + Socials + Trophies) -->
                <div x-show="mobileTab === 'info'" class="space-y-6">
                    {% include 'user_profile/components/_identity_card.html' %}
                    {% include 'user_profile/components/_vital_stats.html' %}
                    {% include 'user_profile/components/_social_links.html' %}
                    {% include 'user_profile/components/_trophy_shelf.html' %}
                </div>
                
                <!-- GAMES Tab (Game Passport + Match History) -->
                <div x-show="mobileTab === 'games'" class="space-y-6" style="display: none;">
                    {% include 'user_profile/components/_game_passport.html' %}
                    {% include 'user_profile/components/_match_history.html' %}
                </div>
                
                <!-- CAREER Tab (Team + Wallet + Certificates) -->
                <div x-show="mobileTab === 'career'" class="space-y-6" style="display: none;">
                    {% include 'user_profile/components/_team_card.html' %}
                    {% include 'user_profile/components/_wallet_card.html' %}
                    {% include 'user_profile/components/_certificates.html' %}
                </div>
            </div>
            
        </div>
        
    </div>

    <!-- Toast Notification (Global) -->
    <div x-show="toast.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform translate-y-2"
         x-transition:enter-end="opacity-100 transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed top-4 right-4 z-50 glass-card px-6 py-4 rounded-lg shadow-2xl max-w-sm"
         style="display: none;">
        <div class="flex items-center gap-3">
            <span x-text="toast.icon" class="text-2xl"></span>
            <p x-text="toast.message" class="text-white font-semibold"></p>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- Alpine.js for Reactive Components -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
