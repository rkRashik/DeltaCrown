{% load static nav_extras dc_avatar notifications_nav %}

<!-- ============================================
     DELTACROWN PRIMARY NAVIGATION SYSTEM
     Modern 2026 Esports-Grade Design
     Liquid Glass | Cybernetic Neon | Command Search
     ============================================ -->
<!-- ============= DEBUG START ============= -->
<!-- TEMPLATE: templates/partials/primary_navigation.html -->
<!-- TEAM_VNEXT_ADAPTER_ENABLED: {{ TEAM_VNEXT_ADAPTER_ENABLED }} -->
<!-- TEAM_VNEXT_FORCE_LEGACY: {{ TEAM_VNEXT_FORCE_LEGACY }} -->
<!-- TEAM_VNEXT_ROUTING_MODE: {{ TEAM_VNEXT_ROUTING_MODE }} -->
<!-- ============= DEBUG END ============= -->

<!-- Command Search Modal (Cmd+K) - PREMIUM DESIGN -->
<div id="dc-search-overlay" class="fixed inset-0 z-[200] hidden items-start justify-center pt-[12vh] px-4 transition-opacity duration-300" style="background: linear-gradient(135deg, rgba(2,0,5,0.90) 0%, rgba(20,10,40,0.85) 50%, rgba(2,0,5,0.90) 100%); backdrop-filter: blur(8px);">
  <div class="w-full max-w-3xl rounded-2xl overflow-hidden flex flex-col transform scale-95 opacity-0 transition-all duration-300" id="dc-search-modal" style="background: linear-gradient(135deg, rgba(15, 10, 30, 0.98) 0%, rgba(10, 5, 20, 0.98) 100%); border: 1px solid rgba(138, 43, 226, 0.3); box-shadow: 0 0 60px rgba(138, 43, 226, 0.2), 0 30px 80px rgba(0,0,0,0.9), inset 0 1px 0 rgba(255,255,255,0.1);">
    
    <!-- Search Input - Premium Design -->
    <div class="flex items-center px-6 py-6 border-b border-purple-500/20 relative bg-gradient-to-r from-purple-900/10 to-transparent">
      <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-cyan-500/20 to-purple-600/20 flex items-center justify-center mr-4 border border-cyan-400/30 shadow-lg shadow-cyan-500/20">
        <i class="fa-solid fa-magnifying-glass text-cyan-400 text-2xl"></i>
      </div>
      <input type="text" id="dc-cmd-input" placeholder="Search tournaments, teams, players..." 
             class="flex-1 bg-transparent border-none outline-none text-white text-2xl font-sans placeholder-gray-400 font-medium" 
             autocomplete="off">
      <button onclick="window.dcNav.toggleSearch()" class="w-11 h-11 text-gray-400 hover:text-white transition p-2 rounded-xl hover:bg-white/5 ml-3">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    <!-- Quick Links - Enhanced Design -->
    <div class="p-4 max-h-[450px] overflow-y-auto" style="scrollbar-width: none;">
      <div class="text-xs font-bold text-purple-400/70 uppercase px-4 py-3 tracking-widest">Quick Access</div>
      
      <a href="/tournaments/" class="flex items-center gap-4 p-4 rounded-xl hover:bg-white/5 group transition-all duration-200 border border-transparent hover:border-purple-500/30 mb-2">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500/20 to-purple-700/10 text-purple-400 flex items-center justify-center border border-purple-500/30 shadow-lg shadow-purple-500/20 group-hover:shadow-purple-500/40 transition-shadow">
          <i class="fa-solid fa-trophy text-xl"></i>
        </div>
        <div class="flex-1">
          <span class="text-gray-100 font-semibold group-hover:text-white block text-lg">Browse Tournaments</span>
          <span class="text-sm text-gray-400">Find active competitions</span>
        </div>
        <i class="fa-solid fa-chevron-right text-gray-600 group-hover:text-cyan-400 transition-all group-hover:translate-x-1"></i>
      </a>

      <a href="/teams/" class="flex items-center gap-4 p-4 rounded-xl hover:bg-white/5 group transition-all duration-200 border border-transparent hover:border-cyan-400/30">
        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-400/20 to-cyan-600/10 text-cyan-400 flex items-center justify-center border border-cyan-400/30 shadow-lg shadow-cyan-400/20 group-hover:shadow-cyan-400/40 transition-shadow">
          <i class="fa-solid fa-users text-xl"></i>
        </div>
        <div class="flex-1">
          <span class="text-gray-100 font-semibold group-hover:text-white block text-lg">Find a Team</span>
          <span class="text-sm text-gray-400">Join a roster or create one</span>
        </div>
        <i class="fa-solid fa-chevron-right text-gray-600 group-hover:text-cyan-400 transition-all group-hover:translate-x-1"></i>
      </a>
    </div>

    <!-- Footer -->
    <div class="px-6 py-4 bg-black/30 border-t border-purple-500/20 flex justify-between text-xs text-gray-400 font-medium">
      <div class="flex gap-4">
        <span><kbd class="bg-white/10 px-2 py-1 rounded text-gray-300 border border-white/20">↑↓</kbd> navigate</span>
        <span><kbd class="bg-white/10 px-2 py-1 rounded text-gray-300 border border-white/20">↵</kbd> select</span>
      </div>
      <span><kbd class="bg-white/10 px-2 py-1 rounded text-gray-300 border border-white/20">ESC</kbd> close</span>
    </div>
  </div>
</div>

<!-- Mobile Header (Top Bar) -->
<header id="dc-mobile-header" class="md:hidden fixed top-0 left-0 right-0 z-[100] h-16 bg-[#020005]/95 backdrop-blur-xl border-b border-white/5 flex items-center justify-between px-5 transition-transform duration-300">
  <a href="/" class="flex items-center gap-2">
    <img src="{% static 'img/deltaCrown_logos/logo_animated.svg' %}" alt="DeltaCrown" class="w-8 h-8 drop-shadow-[0_0_8px_rgba(108,0,255,0.6)]">
    <img src="{% static 'img/deltaCrown_logos/DeltaCrown_Teal-Purple-Gold.svg' %}" alt="DELTACROWN" class="h-6 w-auto">
  </a>

  <div class="flex items-center gap-4">
    {% if request.path == '/' %}
      <button onclick="window.dcNav.toggleSearch()" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-white active:bg-white/10">
        <i class="fa-solid fa-magnifying-glass text-lg"></i>
      </button>
    {% endif %}
    {% if request.user.is_authenticated %}
      <a href="/notifications/" class="w-9 h-9 rounded-full flex items-center justify-center text-gray-400 hover:text-white active:bg-white/10 relative">
        <i class="fa-regular fa-bell text-xl"></i>
        {% with nav_unread_count|default:0 as unread_count %}
          {% if unread_count > 0 %}
            <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-[#020005] animate-pulse"></span>
          {% endif %}
        {% endwith %}
      </a>
    {% endif %}
    <button id="dc-mobile-menu-toggle" class="w-9 h-9 rounded-full flex items-center justify-center text-white active:bg-white/10">
      <i class="fa-solid fa-bars text-xl"></i>
    </button>
  </div>
</header>

<!-- Desktop Navigation - STICKY LIQUID GLASS -->
<nav id="dc-navbar" class="hidden md:flex fixed top-0 left-0 right-0 z-[100] items-center justify-center transition-all duration-500" 
     style="height: 80px; background: rgba(2, 0, 5, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.03);">
  
  <div class="w-full max-w-[1920px] px-8 lg:px-12 flex items-center justify-between h-full">
    
    <!-- Left: Logo & Brand -->
    <a href="/" class="flex items-center gap-3 group relative z-[700] focus:outline-none">
      <img src="{% static 'img/deltaCrown_logos/logo_animated.svg' %}" alt="DeltaCrown" class="w-10 h-10 drop-shadow-[0_0_12px_rgba(108,0,255,0.4)]">
      <img src="{% static 'img/deltaCrown_logos/DeltaCrown_Teal-Purple-Gold.svg' %}" alt="DELTACROWN" class="hidden md:block h-8 w-auto drop-shadow-[0_0_8px_rgba(0,229,255,0.3)]">
    </a>

    <!-- Center: Navigation Links -->
    <div class="flex items-center gap-8 h-full">
      {% nav_active '/tournaments/' '/tournaments' as tournaments_active %}
      <div class="dc-nav-item{% if tournaments_active %} active{% endif %} group cursor-pointer">
        <a href="/tournaments/" class="dc-nav-link">Tournaments</a>
      </div>

      {% nav_active '/teams/' '/teams' as teams_active %}
      <div class="dc-nav-item{% if teams_active %} active{% endif %} group cursor-pointer">
        <a href="/teams/" class="dc-nav-link">Teams</a>
      </div>

      {% if request.user.is_authenticated %}
        {% nav_active '/dashboard/' '/dashboard' as dashboard_active %}
        <div class="dc-nav-item{% if dashboard_active %} active{% endif %} group cursor-pointer">
          <a href="/dashboard/" class="dc-nav-link">Dashboard</a>
        </div>
        
        <!-- vNext Team & Org Beta -->
        {% nav_active '/teams/vnext/' '/teams' as vnext_active %}
        <div class="dc-nav-item{% if vnext_active %} active{% endif %} group cursor-pointer">
          <a href="/teams/vnext/" class="dc-nav-link flex items-center gap-2">
            Team & Org <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full font-bold">BETA</span>
          </a>
        </div>
      {% endif %}

      {% nav_active '/community/' '/community' as community_active %}
      <div class="dc-nav-item{% if community_active %} active{% endif %} group cursor-pointer">
        <a href="/community/" class="dc-nav-link">Community</a>
      </div>

      {% nav_active '/watch/' '/arena' as arena_active %}
      <div class="dc-nav-item{% if arena_active %} active{% endif %} group cursor-pointer">
        <a href="/watch/" class="dc-nav-link flex items-center gap-2">
          Arena <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-ping"></span>
        </a>
      </div>

      {% nav_active '/crownstore/' '/crownstore' as store_active %}
      <div class="dc-nav-item{% if store_active %} active{% endif %} group cursor-pointer">
        <a href="/crownstore/" class="dc-nav-link text-yellow-400/90 hover:text-white transition-colors">Store</a>
      </div>
    </div>

    <!-- Right: Actions & Profile -->
    <div class="flex items-center gap-5">
      
      <!-- Search Button - ONLY ON HOME PAGE -->
      {% if request.path == '/' %}
        <button onclick="window.dcNav.toggleSearch()" class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/5 transition-all group" title="Search (Cmd+K)">
          <i class="fa-solid fa-magnifying-glass text-[1.1rem] group-hover:scale-110 transition-transform"></i>
        </button>
      {% endif %}

      {% if request.user.is_authenticated %}
        <!-- Notifications -->
        <div class="relative z-[550]">
          <button id="dc-notif-btn" class="w-10 h-10 rounded-xl flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/5 transition-all relative group">
            <i class="fa-regular fa-bell text-[1.25rem] group-hover:rotate-12 transition-transform"></i>
            {% with nav_unread_count|default:0 as unread_count %}
              {% if unread_count > 0 %}
                <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-[#020005] animate-pulse"></span>
              {% endif %}
            {% endwith %}
          </button>
          
          <!-- Notification Dropdown -->
          <div id="dc-notif-menu" class="dc-dropdown absolute top-full right-0 mt-4 w-[400px] z-[600]">
            <div class="px-5 py-4 border-b border-white/5 bg-white/[0.02] flex justify-between items-center">
              <h4 class="font-bold text-white text-sm tracking-widest uppercase">Notifications</h4>
              <button onclick="markAllNotificationsRead()" class="text-[11px] text-cyan-400 hover:text-white transition font-bold uppercase tracking-wider">
                <i class="fa-solid fa-check-double"></i> Mark Read
              </button>
            </div>
            {% notifications_bell %}
          </div>
        </div>

        <div class="w-px h-6 bg-white/10 mx-2"></div>

        <!-- Profile Dropdown - NO TAG, LARGER AVATAR -->
        {% user_avatar_url request.user as avatar_url %}
        <div class="relative z-[150]">
          <button id="dc-profile-btn" class="flex items-center gap-3 pl-1 pr-4 py-1.5 rounded-full bg-white/[0.03] border border-white/10 hover:border-white/20 hover:bg-white/[0.08] transition-all group">
            <img src="{{ avatar_url }}" class="w-9 h-9 rounded-full object-cover ring-2 ring-transparent group-hover:ring-cyan-400 transition-all" alt="{{ request.user.username }}">
            <span class="text-sm font-semibold text-gray-200 group-hover:text-white transition-colors">{{ request.user.username }}</span>
            <i class="fa-solid fa-chevron-down text-[10px] text-gray-500 group-hover:text-white transition-transform duration-300 ml-1" id="dc-profile-chevron"></i>
          </button>

          <!-- Profile Menu -->
          <div id="dc-profile-menu" class="dc-dropdown absolute top-full right-0 mt-4 w-64 z-[600]">
            <div class="p-5 border-b border-white/5 bg-gradient-to-b from-white/[0.03] to-transparent">
              <div class="flex items-center gap-4">
                <div class="relative">
                  <img src="{{ avatar_url }}" class="w-14 h-14 rounded-full object-cover border border-white/10 shadow-lg" alt="{{ request.user.username }}">
                  <div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 border-2 border-black rounded-full" title="Online"></div>
                </div>
                <div>
                  <p class="text-white font-bold text-base">{{ request.user.get_full_name|default:request.user.username }}</p>
                  <p class="text-xs text-gray-400 mt-1">@{{ request.user.username }}</p>
                </div>
              </div>
            </div>

            <div class="py-2 px-1">
              <a href="{% url 'user_profile:public_profile' request.user.username %}" class="dc-dd-item">
                <i class="fa-regular fa-user"></i> <span>My Profile</span>
              </a>
              <a href="/dashboard/" class="dc-dd-item">
                <i class="fa-solid fa-chart-pie"></i> <span>Dashboard</span>
              </a>
              <a href="/teams/" class="dc-dd-item">
                <i class="fa-solid fa-users"></i> <span>My Teams</span>
              </a>
              <div class="h-px bg-white/5 mx-4 my-1.5"></div>
              <a href="{% url 'user_profile:settings' %}" class="dc-dd-item">
                <i class="fa-solid fa-sliders"></i> <span>Settings</span>
              </a>
            </div>

            <div class="p-2 border-t border-white/5 bg-white/[0.01] px-1">
              <a href="/accounts/logout/" class="dc-dd-item text-red-400 hover:text-red-300 hover:bg-red-500/10">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sign Out</span>
              </a>
            </div>
          </div>
        </div>
      {% else %}
        <!-- Auth Buttons -->
        <div class="flex items-center gap-3">
          <a href="/accounts/login/" class="px-4 py-2 text-gray-300 hover:text-white transition font-medium">Sign In</a>
          <a href="/accounts/signup/" class="px-5 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-semibold transition">Sign Up</a>
        </div>
      {% endif %}
    </div>
  </div>
</nav>

<!-- Mobile Bottom Navigation - NEW MENU ITEMS -->
<nav class="md:hidden fixed bottom-0 left-0 right-0 h-[70px] bg-[#020005]/95 backdrop-blur-2xl border-t border-white/10 z-[90] flex items-center justify-around px-2 pb-safe transition-transform duration-300">
  {% nav_active '/tournaments/' '/tournaments' as tournaments_active %}
  <a href="/tournaments/" class="flex flex-col items-center gap-1 p-2 flex-1 group">
    <i class="fa-solid fa-trophy text-xl {% if tournaments_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} transition"></i>
    <span class="text-[10px] {% if tournaments_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} font-medium tracking-wide">Tournament</span>
  </a>
  
  {% nav_active '/teams/' '/teams' as teams_active %}
  <a href="/teams/" class="flex flex-col items-center gap-1 p-2 flex-1 group">
    <i class="fa-solid fa-users text-xl {% if teams_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} transition"></i>
    <span class="text-[10px] {% if teams_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} tracking-wide">Team</span>
  </a>
  
  {% if request.user.is_authenticated %}
    {% nav_active '/dashboard/' '/dashboard' as dashboard_active %}
    <a href="/dashboard/" class="flex flex-col items-center gap-1 p-2 flex-1 group">
      <i class="fa-solid fa-chart-pie text-xl {% if dashboard_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} transition"></i>
      <span class="text-[10px] {% if dashboard_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} tracking-wide">Dashboard</span>
    </a>
  {% endif %}
  
  {% nav_active '/watch/' '/arena' as arena_active %}
  <a href="/watch/" class="flex flex-col items-center gap-1 p-2 flex-1 group relative">
    <i class="fa-solid fa-gamepad text-xl {% if arena_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} transition"></i>
    <span class="text-[10px] {% if arena_active %}text-cyan-400{% else %}text-gray-500 group-hover:text-white{% endif %} tracking-wide">Arena</span>
    <span class="absolute top-1 right-1/4 w-1.5 h-1.5 bg-red-500 rounded-full animate-ping"></span>
  </a>
  
  {% nav_active '/crownstore/' '/crownstore' as store_active %}
  <a href="/crownstore/" class="flex flex-col items-center gap-1 p-2 flex-1 group">
    <i class="fa-solid fa-store text-xl {% if store_active %}text-yellow-400{% else %}text-gray-500 group-hover:text-yellow-400{% endif %} transition"></i>
    <span class="text-[10px] {% if store_active %}text-yellow-400{% else %}text-gray-500 group-hover:text-yellow-400{% endif %} tracking-wide">Store</span>
  </a>
</nav>

<!-- Mobile Drawer Menu -->
<div id="dc-mobile-drawer" class="md:hidden fixed top-0 right-0 w-80 h-full bg-[#020005]/98 backdrop-blur-xl border-l border-white/10 z-[110] transform translate-x-full transition-transform duration-300 overflow-y-auto">
  <div class="p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold text-white">Menu</h2>
      <button id="dc-mobile-drawer-close" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-white hover:bg-white/10">
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    {% if request.user.is_authenticated %}
      <div class="mb-6 p-4 bg-white/5 rounded-xl">
        {% user_avatar_url request.user as drawer_avatar %}
        <div class="flex items-center gap-3">
          <img src="{{ drawer_avatar }}" class="w-12 h-12 rounded-full border-2 border-white/20" alt="{{ request.user.username }}">
          <div>
            <p class="text-white font-bold">{{ request.user.get_full_name|default:request.user.username }}</p>
            <p class="text-sm text-gray-400">@{{ request.user.username }}</p>
          </div>
        </div>
      </div>

      <div class="space-y-2">
        <a href="/dashboard/" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition">
          <i class="fa-solid fa-chart-pie w-5"></i> Dashboard
        </a>
        <a href="{% url 'user_profile:public_profile' request.user.username %}" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition">
          <i class="fa-solid fa-user w-5"></i> Profile
        </a>
        <a href="{% url 'teams:my_invites' %}" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition relative">
          <i class="fa-solid fa-user-plus w-5"></i> Team Invites
          {% if pending_invites_count > 0 %}
            <span class="absolute top-2 right-2 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-red-500 rounded-full">{{ pending_invites_count }}</span>
          {% endif %}
        </a>
        
        <!-- vNext Team & Org Beta (Mobile Drawer) -->
        {% if TEAM_VNEXT_ADAPTER_ENABLED and not TEAM_VNEXT_FORCE_LEGACY and TEAM_VNEXT_ROUTING_MODE != 'legacy_only' %}
          <a href="/teams/vnext/" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition">
            <i class="fa-solid fa-sitemap w-5"></i> Team & Org 
            <span class="ml-2 text-xs bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-full font-bold">BETA</span>
          </a>
        {% endif %}
        
        <a href="/notifications/" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition">
          <i class="fa-solid fa-bell w-5"></i> Notifications
        </a>
        <a href="{% url 'user_profile:settings' %}" class="block px-4 py-3 text-gray-300 hover:text-white hover:bg-white/5 rounded-lg transition">
          <i class="fa-solid fa-cog w-5"></i> Settings
        </a>
        <div class="h-px bg-white/10 my-2"></div>
        <a href="/accounts/logout/" class="block px-4 py-3 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition">
          <i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Sign Out
        </a>
      </div>
    {% else %}
      <div class="space-y-3">
        <a href="/accounts/login/" class="block w-full px-6 py-3 bg-cyan-500 hover:bg-cyan-600 text-white text-center rounded-lg font-semibold transition">
          Sign In
        </a>
        <a href="/accounts/signup/" class="block w-full px-6 py-3 border border-white/20 hover:bg-white/5 text-white text-center rounded-lg font-semibold transition">
          Create Account
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Mobile Drawer Backdrop -->
<div id="dc-mobile-backdrop" class="md:hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-[105] hidden"></div>

<script>
// Notification functions for dropdown
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

async function markAllNotificationsRead() {
  try {
    const csrftoken = getCookie('csrftoken');
    const response = await fetch('/notifications/mark-all-read/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      // Remove unread indicators
      document.querySelectorAll('.notification-dropdown-item').forEach(item => {
        item.classList.remove('bg-cyan-500/5');
        const indicator = item.querySelector('.bg-cyan-400');
        if (indicator) indicator.remove();
      });
      
      // Update badge
      const badge = document.querySelector('#dc-notif-btn .animate-pulse');
      if (badge) badge.remove();
      
      // Optionally reload to refresh count
      setTimeout(() => window.location.reload(), 1000);
    }
  } catch (error) {
    console.error('Failed to mark notifications as read:', error);
  }
}

// ========== REAL-TIME NOTIFICATION UPDATES (Navigation) ==========
let lastNavNotifCount = 0;
let navNotifSound = null;

// Create notification sound
function initNavNotificationSound() {
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    
    navNotifSound = function() {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      
      const now = audioCtx.currentTime;
      const duration = 0.3;
      
      // Soft pleasant chord (C-E-G)
      [523.25, 659.25, 783.99].forEach((freq, i) => {
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.08, now + 0.01);
        gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
        
        oscillator.start(now + i * 0.02);
        oscillator.stop(now + duration + i * 0.02);
      });
    };
  } catch (e) {
    console.warn('Web Audio API not supported:', e);
  }
}

// Initialize sound on user interaction
document.addEventListener('click', () => {
  if (!navNotifSound) {
    initNavNotificationSound();
  }
}, { once: true });

// Check for new notifications
async function checkNavNotifications() {
  try {
    const response = await fetch('/notifications/api/unread-count/', {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    
    if (!response.ok) return;
    
    const data = await response.json();
    const currentCount = data.count || 0;
    
    // Update badge
    const badge = document.querySelector('#dc-notif-btn .animate-pulse');
    if (currentCount > 0) {
      if (!badge) {
        const notifBtn = document.getElementById('dc-notif-btn');
        if (notifBtn) {
          const newBadge = document.createElement('span');
          newBadge.className = 'absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-[#020005] animate-pulse';
          notifBtn.appendChild(newBadge);
        }
      }
      
      // Play sound for new notifications
      if (currentCount > lastNavNotifCount && lastNavNotifCount > 0) {
        if (navNotifSound && document.visibilityState === 'visible') {
          navNotifSound();
        }
      }
    } else {
      if (badge) badge.remove();
    }
    
    lastNavNotifCount = currentCount;
  } catch (error) {
    console.error('Failed to check nav notifications:', error);
  }
}

// Poll for notifications every 15 seconds
let navNotifInterval;
function startNavNotificationPolling() {
  checkNavNotifications();
  navNotifInterval = setInterval(checkNavNotifications, 15000);
}

// Pause polling when page is hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    if (navNotifInterval) clearInterval(navNotifInterval);
  } else {
    startNavNotificationPolling();
  }
});

// Start polling if user is authenticated
{% if request.user.is_authenticated %}
  startNavNotificationPolling();
{% endif %}
</script>
