{% extends "base.html" %}
{% block title %}Notifications — DeltaCrown{% endblock %}

{% block content %}
{% meta_tags title="Notifications — DeltaCrown"
             description="Your recent activity: invites, registrations, matches, and updates." %}

<section aria-labelledby="h1" data-testid="notifications-index">
  <header class="d-flex align-items-center justify-content-between">
    <div>
      <h1 id="h1" class="mb-3">Notifications</h1>
      <p class="text-muted mb-0">Stay on top of team invites, registrations, matches, and updates.</p>
    </div>

    <div class="d-flex gap-2">
      {# Prefer named URL if available; fallback to literal to avoid template errors #}
      <form method="post" action="{% url 'notifications:mark_all' %}" onsubmit="this.querySelector('button[type=submit]').setAttribute('disabled','disabled')" class="d-flex gap-2">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <button class="btn btn-outline btn-sm" type="submit" data-busy-text="Marking…">Mark all as read</button>
      </form>
    </div>
  </header>

  {% with items=notifications|default:object_list %}
    {% if items %}
      <ul class="list-unstyled mb-0">
        {% for n in items %}
          <li class="card p-3 mb-2" data-id="{{ n.id }}">
            <div class="d-flex align-items-center justify-content-between">
              <div style="min-width:0">
                <div class="fw-medium" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                  {{ n.title|default:n.verb|default:"Notification" }}
                  {% if not n.read %}<span class="badge">New</span>{% endif %}
                </div>
                <div class="text-muted small">
                  {% if n.timestamp %}{{ n.timestamp|date:"M d, Y h:i A" }}{% endif %}
                  {% if n.actor %} · {{ n.actor }}{% endif %}
                </div>
              </div>

              <div class="d-flex gap-2">
                {% if n.target_url %}
                  <a class="btn btn-outline btn-sm" href="{{ n.target_url }}">Open</a>
                {% endif %}

                {# Mark read form; includes ?next= so we stay on this page #}
                {% if not n.read %}
                <form method="post" action="{% url 'notifications:mark_read' n.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-primary btn-sm" type="submit" data-busy-text="Marking…">Mark read</button>
                </form>
                {% endif %}
              </div>
            </div>

            {% if n.description or n.text %}
              <p class="mb-0 mt-2 text-muted" style="white-space:pre-wrap">{{ n.description|default:n.text }}</p>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div class="mt-3" data-testid="pagination">
        {% include "partials/pagination.html" %}
      </div>
    {% else %}
      <article class="card p-3">
        <div class="fw-medium mb-1">You’re all caught up</div>
        <p class="mb-0 text-muted">No notifications right now. You’ll see team invites, match updates, and more here.</p>
      </article>
    {% endif %}
  {% endwith %}
</section>
{% endblock %}
