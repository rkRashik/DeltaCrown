{% extends "base.html" %}
{% load static %}
{% block og_title %}Notifications â€” DeltaCrown{% endblock %}

{% block content %}
<section class="container my-8 max-w-5xl">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-white">Notifications</h1>
      <p class="text-gray-400 mt-1">Stay updated with your latest activity</p>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="markAllRead()" 
              class="px-4 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Mark all read
      </button>
      <button onclick="clearAll()" 
              class="px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Clear all
      </button>
    </div>
  </div>

  <!-- Notifications List -->
  <div class="glass-panel rounded-2xl divide-y divide-white/10">
    {% if page and page.object_list %}
      {% for n in page.object_list %}
        <div class="notification-item p-5 flex items-start gap-4 hover:bg-white/5 transition {% if not n.is_read %}bg-cyan-500/5{% endif %}" 
             data-notification-id="{{ n.id }}"
             data-type="{{ n.type }}"
             data-follow-request-id="{{ n.action_object_id|default:'' }}">
          
          <!-- Avatar -->
          <div class="flex-shrink-0">
            {% if n.type == 'follow_request' or n.type == 'follow_request_approved' %}
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
              </div>
            {% elif n.type == 'match_scheduled' or n.type == 'match_result' %}
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
            {% elif n.type == 'achievement_earned' %}
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
              </div>
            {% else %}
              <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-500 to-gray-700 flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                </svg>
              </div>
            {% endif %}
          </div>

          <!-- Content -->
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="font-medium text-white mb-1">
                  {{ n.title|default:"Notification" }}
                  {% if not n.is_read %}
                    <span class="inline-block w-2 h-2 bg-cyan-400 rounded-full ml-2"></span>
                  {% endif %}
                </div>
                <div class="text-sm text-gray-400 mb-2">{{ n.body|default:n.message }}</div>
                <div class="text-xs text-gray-500">{{ n.created_at|timesince }} ago</div>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 mt-3 flex-wrap">
              <!-- Follow Request Actions (for pending requests) -->
              {% if n.type == 'follow_request' and n.action_object_id %}
                <button onclick="acceptFollowRequest({{ n.action_object_id }}, {{ n.id }})"
                        class="follow-request-action px-3 py-1.5 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg text-sm transition flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Accept
                </button>
                <button onclick="rejectFollowRequest({{ n.action_object_id }}, {{ n.id }})"
                        class="follow-request-action px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Reject
                </button>
              {% endif %}

              <!-- View Button -->
              {% if n.url %}
                <a href="{{ n.url }}" 
                   class="px-3 py-1.5 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 rounded-lg text-sm transition flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  View
                </a>
              {% endif %}

              <!-- Mark Read -->
              {% if not n.is_read %}
                <button onclick="markRead({{ n.id }})"
                        class="mark-read-btn px-3 py-1.5 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm transition">
                  Mark read
                </button>
              {% endif %}

              <!-- Delete Button -->
              <button onclick="deleteNotification({{ n.id }})"
                      class="delete-btn px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm transition flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete
              </button>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- Pagination -->
      <div class="p-4 flex items-center justify-between">
        {% if page.has_previous %}
          <a class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition" 
             href="?page={{ page.previous_page_number }}">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            Previous
          </a>
        {% else %}
          <div></div>
        {% endif %}
        
        <span class="text-gray-400 text-sm">
          Page {{ page.number }} of {{ page.paginator.num_pages }}
        </span>
        
        {% if page.has_next %}
          <a class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition" 
             href="?page={{ page.next_page_number }}">
            Next
            <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        {% else %}
          <div></div>
        {% endif %}
      </div>
    {% else %}
      <!-- Empty State -->
      <div class="p-16 text-center">
        <div class="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-to-br from-cyan-500/20 to-blue-600/20 flex items-center justify-center">
          <svg class="w-12 h-12 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
        <p class="text-xl text-gray-400 mb-2">No notifications yet</p>
        <p class="text-sm text-gray-500">We'll notify you when something happens</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

<script>
// Get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Toast notification
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `px-6 py-4 rounded-lg shadow-lg text-white transform transition-all duration-300 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-cyan-600'
  }`;
  toast.textContent = message;
  toast.style.animation = 'slideIn 0.3s ease-out';
  
  document.getElementById('toast-container').appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Mark all as read
async function markAllRead() {
  try {
    const response = await fetch('/notifications/mark-all-read/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      showToast(`Marked ${data.updated_count} notifications as read`);
      // Remove unread indicators
      document.querySelectorAll('.notification-item').forEach(item => {
        item.classList.remove('bg-cyan-500/5');
        const indicator = item.querySelector('.bg-cyan-400');
        if (indicator) indicator.remove();
        const markReadBtn = item.querySelector('.mark-read-btn');
        if (markReadBtn) markReadBtn.remove();
      });
    }
  } catch (error) {
    showToast('Failed to mark notifications as read', 'error');
  }
}

// Clear all notifications
async function clearAll() {
  if (!confirm('Delete all notifications? This cannot be undone.')) return;
  
  try {
    const response = await fetch('/notifications/clear-all/', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      showToast(`Deleted ${data.deleted_count} notifications`);
      location.reload();
    }
  } catch (error) {
    showToast('Failed to clear notifications', 'error');
  }
}

// Mark single as read
async function markRead(notificationId) {
  try {
    const response = await fetch(`/notifications/${notificationId}/mark-read/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
      item.classList.remove('bg-cyan-500/5');
      const indicator = item.querySelector('.bg-cyan-400');
      if (indicator) indicator.remove();
      const markReadBtn = item.querySelector('.mark-read-btn');
      if (markReadBtn) markReadBtn.remove();
      showToast('Marked as read');
    }
  } catch (error) {
    showToast('Failed to mark as read', 'error');
  }
}

// Delete notification
async function deleteNotification(notificationId) {
  if (!confirm('Delete this notification?')) return;
  
  try {
    const response = await fetch(`/notifications/${notificationId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
      item.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => item.remove(), 300);
      showToast('Notification deleted');
    }
  } catch (error) {
    showToast('Failed to delete notification', 'error');
  }
}

// Accept follow request
async function acceptFollowRequest(requestId, notificationId) {
  try {
    const response = await fetch(`/notifications/api/follow-request/${requestId}/accept/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      showToast('Follow request accepted!', 'success');
      
      // Update UI
      const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
      const actions = item.querySelectorAll('.follow-request-action');
      actions.forEach(btn => btn.remove());
      
      // Add accepted badge
      const content = item.querySelector('.flex-1 > .flex > .flex-1');
      const badge = document.createElement('span');
      badge.className = 'inline-block px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded mt-2';
      badge.textContent = 'Accepted';
      content.appendChild(badge);
    } else {
      showToast(data.error || 'Failed to accept request', 'error');
    }
  } catch (error) {
    showToast('Failed to accept follow request', 'error');
  }
}

// Reject follow request
async function rejectFollowRequest(requestId, notificationId) {
  if (!confirm('Reject this follow request?')) return;
  
  try {
    const response = await fetch(`/notifications/api/follow-request/${requestId}/reject/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    if (data.success) {
      showToast('Follow request rejected', 'info');
      
      // Update UI
      const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
      const actions = item.querySelectorAll('.follow-request-action');
      actions.forEach(btn => btn.remove());
      
      // Add rejected badge
      const content = item.querySelector('.flex-1 > .flex > .flex-1');
      const badge = document.createElement('span');
      badge.className = 'inline-block px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded mt-2';
      badge.textContent = 'Rejected';
      content.appendChild(badge);
    } else {
      showToast(data.error || 'Failed to reject request', 'error');
    }
  } catch (error) {
    showToast('Failed to reject follow request', 'error');
  }
}

// Animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideOut {
    to { transform: translateX(100%); opacity: 0; }
  }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}
