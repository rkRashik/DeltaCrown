{% extends "base.html" %}
{% load static humanize %}

{% block title %}Clone {{ original_tournament.name }} | DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tokens.css' %}">
<link rel="stylesheet" href="{% static 'siteui/css/tournaments.css' %}">
<link rel="stylesheet" href="{% static 'siteui/css/clone-form.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'siteui/js/clone-form.js' %}"></script>
{% endblock %}

{% block content %}
<section class="dc-container clone-form-page">

  {# Breadcrumb #}
  <div class="breadcrumb">
    <a href="{% url 'tournaments:hub' %}">Tournaments</a>
    <span class="separator">/</span>
    <a href="{% url 'tournaments:archive_list' %}">Archives</a>
    <span class="separator">/</span>
    <a href="{% url 'tournaments:archive_detail' original_tournament.slug %}">{{ original_tournament.name }}</a>
    <span class="separator">/</span>
    <span>Clone</span>
  </div>

  {# Page Header #}
  <header class="page-header">
    <h1 class="page-title">
      <i class="fas fa-copy"></i>
      Clone Tournament
    </h1>
    <p class="page-description">
      Create a copy of <strong>{{ original_tournament.name }}</strong> with all its configuration and optionally copy registrations and matches.
    </p>
  </header>

  <div class="clone-content">
    {# Original Tournament Preview #}
    <div class="original-preview">
      <h2 class="section-title">Original Tournament</h2>
      
      <div class="preview-card">
        <div class="preview-header">
          <h3>{{ original_tournament.name }}</h3>
          <span class="game-badge">{{ original_tournament.game.name }}</span>
        </div>

        <div class="preview-details">
          {% if schedule %}
            <div class="detail-item">
              <label>Schedule</label>
              <p>{{ schedule.start_at|date:"M d, Y" }} - {{ schedule.end_at|date:"M d, Y" }}</p>
            </div>
          {% endif %}

          {% if capacity %}
            <div class="detail-item">
              <label>Capacity</label>
              <p>{{ capacity.max_teams }} teams ({{ capacity.current_teams }} registered)</p>
            </div>
          {% endif %}

          {% if finance %}
            <div class="detail-item">
              <label>Finance</label>
              <p>Entry: {{ finance.entry_fee_display }} â€¢ Prize: {{ finance.prize_pool_display }}</p>
            </div>
          {% endif %}

          {% if rules %}
            <div class="detail-item">
              <label>Requirements</label>
              <ul class="requirements-compact">
                {% for req in rules.requirements_list|slice:":3" %}
                  <li>{{ req }}</li>
                {% endfor %}
                {% if rules.requirements_list|length > 3 %}
                  <li class="more">+{{ rules.requirements_list|length|add:"-3" }} more</li>
                {% endif %}
              </ul>
            </div>
          {% endif %}
        </div>

        <div class="preview-note">
          <i class="fas fa-info-circle"></i>
          All Phase 1 model data (schedule, capacity, finance, media, rules, archive) will be copied to the new tournament.
        </div>
      </div>
    </div>

    {# Clone Configuration Form #}
    <div class="clone-form-container">
      <h2 class="section-title">Clone Configuration</h2>

      {% if errors %}
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle"></i>
          <div>
            <h4>Please fix the following errors:</h4>
            <ul>
              {% for field, error_list in errors.items %}
                {% for error in error_list %}
                  <li><strong>{{ field }}:</strong> {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}

      <form method="post" class="clone-form" id="clone-form">
        {% csrf_token %}

        {# Basic Information #}
        <div class="form-section">
          <h3 class="form-section-title">Basic Information</h3>

          <div class="form-group">
            <label for="name" class="required">Tournament Name</label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              class="form-control" 
              value="{{ form_data.name|default:suggested_name }}"
              required
              maxlength="200"
            >
            <small class="form-text">
              A unique name for the cloned tournament. Must be different from the original.
            </small>
          </div>
        </div>

        {# Clone Options #}
        <div class="form-section">
          <h3 class="form-section-title">Clone Options</h3>

          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="clone_registrations" 
                value="true"
                {% if form_data.clone_registrations == 'true' %}checked{% endif %}
              >
              <span class="checkbox-text">
                <strong>Clone Registrations</strong>
                <small>Copy all team/player registrations to the new tournament</small>
              </span>
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="clone_matches" 
                value="true"
                {% if form_data.clone_matches == 'true' %}checked{% endif %}
              >
              <span class="checkbox-text">
                <strong>Clone Matches</strong>
                <small>Copy all match results and brackets to the new tournament</small>
              </span>
            </label>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-lightbulb"></i>
            <div>
              <strong>Tip:</strong> Leave these unchecked if you want a fresh tournament with the same structure but no participants or results.
            </div>
          </div>
        </div>

        {# Date Adjustment #}
        <div class="form-section">
          <h3 class="form-section-title">Date Adjustment</h3>

          <div class="form-group">
            <label for="days_offset">Days to Shift Dates</label>
            <input 
              type="number" 
              id="days_offset" 
              name="days_offset" 
              class="form-control" 
              value="{{ form_data.days_offset|default:'0' }}"
              min="-365"
              max="365"
            >
            <small class="form-text">
              Positive number shifts dates forward, negative shifts backward. 
              For example, <code>7</code> moves all dates 7 days into the future.
              {% if schedule %}
                <br>
                <strong>Current registration opens:</strong> {{ schedule.registration_open_at|date:"M d, Y H:i" }}
                <br>
                <strong>Current tournament start:</strong> {{ schedule.start_at|date:"M d, Y H:i" }}
              {% endif %}
            </small>
          </div>

          <div id="date-preview" class="date-preview" style="display: none;">
            <h4>New Dates Preview</h4>
            <div class="preview-dates">
              {% if schedule %}
                <div class="date-item">
                  <label>Registration Opens</label>
                  <p id="preview-reg-open">-</p>
                </div>
                <div class="date-item">
                  <label>Registration Closes</label>
                  <p id="preview-reg-close">-</p>
                </div>
                <div class="date-item">
                  <label>Tournament Start</label>
                  <p id="preview-start">-</p>
                </div>
                <div class="date-item">
                  <label>Tournament End</label>
                  <p id="preview-end">-</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        {# What Will Be Cloned #}
        <div class="form-section">
          <h3 class="form-section-title">What Will Be Cloned</h3>
          
          <div class="clone-checklist">
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Tournament settings and configuration</span>
            </div>
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Schedule dates (with optional adjustment)</span>
            </div>
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Capacity settings (max teams, waitlist)</span>
            </div>
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Finance settings (entry fee, prize pool)</span>
            </div>
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Media assets (logo, banner, thumbnail)</span>
            </div>
            <div class="checklist-item checked">
              <i class="fas fa-check-circle"></i>
              <span>Rules and requirements</span>
            </div>
            <div class="checklist-item" id="registrations-check">
              <i class="fas fa-circle"></i>
              <span>Registrations (if checked above)</span>
            </div>
            <div class="checklist-item" id="matches-check">
              <i class="fas fa-circle"></i>
              <span>Matches and brackets (if checked above)</span>
            </div>
          </div>
        </div>

        {# Form Actions #}
        <div class="form-actions">
          <a href="{% url 'tournaments:archive_detail' original_tournament.slug %}" 
             class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-copy"></i>
            Clone Tournament
          </button>
        </div>

      </form>
    </div>
  </div>

</section>

<script>
// Original dates (from server)
const originalDates = {
  regOpen: {% if schedule.registration_open_at %}'{{ schedule.registration_open_at|date:"c" }}'{% else %}null{% endif %},
  regClose: {% if schedule.registration_close_at %}'{{ schedule.registration_close_at|date:"c" }}'{% else %}null{% endif %},
  start: {% if schedule.start_at %}'{{ schedule.start_at|date:"c" }}'{% else %}null{% endif %},
  end: {% if schedule.end_at %}'{{ schedule.end_at|date:"c" }}'{% else %}null{% endif %}
};

// Update date preview when offset changes
document.getElementById('days_offset').addEventListener('input', function() {
  updateDatePreview(parseInt(this.value) || 0);
});

// Update checklist when options change
document.querySelectorAll('input[name="clone_registrations"], input[name="clone_matches"]').forEach(checkbox => {
  checkbox.addEventListener('change', updateChecklist);
});

function updateDatePreview(days) {
  const preview = document.getElementById('date-preview');
  
  if (days === 0) {
    preview.style.display = 'none';
    return;
  }
  
  preview.style.display = 'block';
  
  const msPerDay = 24 * 60 * 60 * 1000;
  const offset = days * msPerDay;
  
  if (originalDates.regOpen) {
    const newDate = new Date(new Date(originalDates.regOpen).getTime() + offset);
    document.getElementById('preview-reg-open').textContent = formatDate(newDate);
  }
  
  if (originalDates.regClose) {
    const newDate = new Date(new Date(originalDates.regClose).getTime() + offset);
    document.getElementById('preview-reg-close').textContent = formatDate(newDate);
  }
  
  if (originalDates.start) {
    const newDate = new Date(new Date(originalDates.start).getTime() + offset);
    document.getElementById('preview-start').textContent = formatDate(newDate);
  }
  
  if (originalDates.end) {
    const newDate = new Date(new Date(originalDates.end).getTime() + offset);
    document.getElementById('preview-end').textContent = formatDate(newDate);
  }
}

function formatDate(date) {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function updateChecklist() {
  const regCheck = document.querySelector('input[name="clone_registrations"]').checked;
  const matchCheck = document.querySelector('input[name="clone_matches"]').checked;
  
  const regItem = document.getElementById('registrations-check');
  const matchItem = document.getElementById('matches-check');
  
  regItem.querySelector('i').className = regCheck ? 'fas fa-check-circle' : 'fas fa-circle';
  regItem.classList.toggle('checked', regCheck);
  
  matchItem.querySelector('i').className = matchCheck ? 'fas fa-check-circle' : 'fas fa-circle';
  matchItem.classList.toggle('checked', matchCheck);
}
</script>

{% endblock %}
