{% extends "base.html" %}
{% load static humanize %}

{% block title %}Archive History - {{ tournament.name }} | DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tokens.css' %}">
<link rel="stylesheet" href="{% static 'siteui/css/tournaments.css' %}">
<link rel="stylesheet" href="{% static 'siteui/css/archive-history.css' %}">
{% endblock %}

{% block content %}
<section class="dc-container archive-history-page">

  {# Breadcrumb #}
  <div class="breadcrumb">
    <a href="{% url 'tournaments:hub' %}">Tournaments</a>
    <span class="separator">/</span>
    <a href="{% url 'tournaments:archive_list' %}">Archives</a>
    <span class="separator">/</span>
    <a href="{% url 'tournaments:archive_detail' tournament.slug %}">{{ tournament.name }}</a>
    <span class="separator">/</span>
    <span>History</span>
  </div>

  {# Page Header #}
  <header class="page-header">
    <div class="header-left">
      <h1 class="page-title">
        <i class="fas fa-history"></i>
        Archive History
      </h1>
      <p class="page-description">
        Complete timeline of all archive, restore, and clone events for <strong>{{ tournament.name }}</strong>
      </p>
    </div>
    <div class="header-actions">
      <a href="{% url 'tournaments:archive_detail' tournament.slug %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to Details
      </a>
    </div>
  </header>

  <div class="history-content">
    
    {# Summary Stats #}
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-archive"></i>
        </div>
        <div class="stat-details">
          <p class="stat-label">Times Archived</p>
          <p class="stat-value">{{ stats.archive_count }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-undo"></i>
        </div>
        <div class="stat-details">
          <p class="stat-label">Times Restored</p>
          <p class="stat-value">{{ stats.restore_count }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-copy"></i>
        </div>
        <div class="stat-details">
          <p class="stat-label">Clones Created</p>
          <p class="stat-value">{{ stats.clone_count }}</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-details">
          <p class="stat-label">Last Event</p>
          <p class="stat-value">{{ stats.last_event|naturaltime }}</p>
        </div>
      </div>
    </div>

    {# Timeline #}
    <div class="timeline-section">
      <h2 class="section-title">Event Timeline</h2>

      {% if events %}
        <div class="timeline">
          {% for event in events %}
            <div class="timeline-item {% if event.is_current %}current{% endif %}">
              <div class="timeline-marker {{ event.event_type }}">
                {% if event.event_type == 'archive' %}
                  <i class="fas fa-archive"></i>
                {% elif event.event_type == 'restore' %}
                  <i class="fas fa-undo"></i>
                {% elif event.event_type == 'clone' %}
                  <i class="fas fa-copy"></i>
                {% else %}
                  <i class="fas fa-circle"></i>
                {% endif %}
              </div>

              <div class="timeline-content">
                <div class="event-header">
                  <h3 class="event-title">
                    {% if event.event_type == 'archive' %}
                      Tournament Archived
                    {% elif event.event_type == 'restore' %}
                      Tournament Restored
                    {% elif event.event_type == 'clone' %}
                      Tournament Cloned
                    {% endif %}
                    {% if event.is_current %}
                      <span class="current-badge">Current State</span>
                    {% endif %}
                  </h3>
                  <p class="event-date">
                    <i class="fas fa-clock"></i>
                    {{ event.timestamp|date:"M d, Y H:i" }}
                    <span class="relative-time">({{ event.timestamp|naturaltime }})</span>
                  </p>
                </div>

                <div class="event-details">
                  <div class="detail-row">
                    <label>User</label>
                    <p>
                      {% if event.user %}
                        {{ event.user.get_full_name|default:event.user.username }}
                      {% else %}
                        System
                      {% endif %}
                    </p>
                  </div>

                  {% if event.reason %}
                    <div class="detail-row">
                      <label>Reason</label>
                      <p>{{ event.reason }}</p>
                    </div>
                  {% endif %}

                  {% if event.event_type == 'clone' and event.cloned_tournament %}
                    <div class="detail-row">
                      <label>Cloned To</label>
                      <p>
                        <a href="{% url 'tournaments:detail' event.cloned_tournament.slug %}">
                          {{ event.cloned_tournament.name }}
                        </a>
                      </p>
                    </div>
                  {% endif %}

                  {% if event.metadata %}
                    <div class="detail-row">
                      <label>Additional Info</label>
                      <div class="metadata-list">
                        {% if event.metadata.preserve_registrations %}
                          <span class="metadata-tag">
                            <i class="fas fa-users"></i>
                            Registrations Preserved
                          </span>
                        {% endif %}
                        {% if event.metadata.preserve_matches %}
                          <span class="metadata-tag">
                            <i class="fas fa-trophy"></i>
                            Matches Preserved
                          </span>
                        {% endif %}
                        {% if event.metadata.preserve_media %}
                          <span class="metadata-tag">
                            <i class="fas fa-image"></i>
                            Media Preserved
                          </span>
                        {% endif %}
                        {% if event.metadata.preserve_finance %}
                          <span class="metadata-tag">
                            <i class="fas fa-dollar-sign"></i>
                            Finance Preserved
                          </span>
                        {% endif %}
                        {% if event.metadata.days_offset %}
                          <span class="metadata-tag">
                            <i class="fas fa-calendar"></i>
                            Dates Shifted: {{ event.metadata.days_offset }} days
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                </div>

                {% if event.notes %}
                  <div class="event-notes">
                    <i class="fas fa-sticky-note"></i>
                    {{ event.notes }}
                  </div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fas fa-history"></i>
          <h3>No History Yet</h3>
          <p>This tournament hasn't been archived, restored, or cloned yet.</p>
        </div>
      {% endif %}
    </div>

    {# Clone Family Tree #}
    {% if clone_family %}
      <div class="clone-family-section">
        <h2 class="section-title">Clone Family Tree</h2>

        <div class="family-tree">
          {% if clone_family.parent %}
            <div class="tree-node parent">
              <div class="node-header">
                <i class="fas fa-arrow-up"></i>
                <span>Cloned From</span>
              </div>
              <div class="node-content">
                <a href="{% url 'tournaments:archive_detail' clone_family.parent.slug %}">
                  {{ clone_family.parent.name }}
                </a>
                <p class="node-meta">
                  {{ clone_family.parent.game.name }} • 
                  Created {{ clone_family.parent.created_at|date:"M d, Y" }}
                </p>
              </div>
            </div>
          {% endif %}

          <div class="tree-node current">
            <div class="node-header">
              <i class="fas fa-circle"></i>
              <span>Current Tournament</span>
            </div>
            <div class="node-content">
              <strong>{{ tournament.name }}</strong>
              <p class="node-meta">
                {{ tournament.game.name }} • 
                Created {{ tournament.created_at|date:"M d, Y" }}
              </p>
            </div>
          </div>

          {% if clone_family.children %}
            <div class="tree-node children">
              <div class="node-header">
                <i class="fas fa-arrow-down"></i>
                <span>Clones ({{ clone_family.children|length }})</span>
              </div>
              <div class="node-content">
                <ul class="clone-list">
                  {% for clone in clone_family.children %}
                    <li>
                      <a href="{% url 'tournaments:detail' clone.slug %}">
                        {{ clone.name }}
                      </a>
                      <p class="node-meta">
                        {{ clone.game.name }} • 
                        Created {{ clone.created_at|date:"M d, Y" }}
                        {% if clone.is_archived %}
                          <span class="archived-badge">Archived</span>
                        {% endif %}
                      </p>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    {% endif %}

    {# Phase 1 Model History (if available) #}
    {% if model_history %}
      <div class="model-history-section">
        <h2 class="section-title">Phase 1 Model Changes</h2>

        <div class="model-cards">
          {% for model_type, changes in model_history.items %}
            <div class="model-card">
              <h3 class="model-title">
                {% if model_type == 'schedule' %}
                  <i class="fas fa-calendar"></i> Schedule
                {% elif model_type == 'capacity' %}
                  <i class="fas fa-users"></i> Capacity
                {% elif model_type == 'finance' %}
                  <i class="fas fa-dollar-sign"></i> Finance
                {% elif model_type == 'media' %}
                  <i class="fas fa-image"></i> Media
                {% elif model_type == 'rules' %}
                  <i class="fas fa-gavel"></i> Rules
                {% elif model_type == 'archive' %}
                  <i class="fas fa-archive"></i> Archive
                {% endif %}
              </h3>

              {% if changes %}
                <div class="change-list">
                  {% for change in changes %}
                    <div class="change-item">
                      <div class="change-header">
                        <span class="change-date">{{ change.timestamp|date:"M d, Y H:i" }}</span>
                        <span class="change-user">{{ change.user.username }}</span>
                      </div>
                      <div class="change-details">
                        {% for field, old_val, new_val in change.fields %}
                          <div class="field-change">
                            <strong>{{ field }}:</strong>
                            <span class="old-value">{{ old_val }}</span>
                            <i class="fas fa-arrow-right"></i>
                            <span class="new-value">{{ new_val }}</span>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="no-changes">No changes recorded</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>

</section>
{% endblock %}
