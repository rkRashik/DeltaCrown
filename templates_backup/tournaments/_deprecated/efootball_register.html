{% extends "base.html" %}
{% load static %}

{% block title %}eFootball Tournament Registration - {{ title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tokens.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
/* eFootball Gaming Theme */
:root {
  --efootball-green: #00ff41;
  --efootball-blue: #0066cc;
  --efootball-dark: #0a1a0a;
  --efootball-light: #e8f5e8;
  --efootball-accent: #1a4a1a;
  --gaming-gradient: linear-gradient(135deg, #0a1a0a 0%, #1a4a1a 50%, #00ff41 100%);
  --card-shadow: 0 8px 32px rgba(0, 255, 65, 0.15);
  --glow-effect: 0 0 20px rgba(0, 255, 65, 0.3);
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #0a1a0a 0%, #1a2a1a 100%);
  color: var(--efootball-light);
  min-height: 100vh;
}

.efootball-container {
  max-width: 1000px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

.efootball-header {
  text-align: center;
  margin-bottom: 3rem;
  position: relative;
}

.efootball-title {
  font-family: 'Orbitron', monospace;
  font-size: 3rem;
  font-weight: 900;
  background: var(--gaming-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.efootball-subtitle {
  font-size: 1.2rem;
  color: #a8a8a8;
  margin-bottom: 0.5rem;
}

.tournament-info-banner {
  background: rgba(0, 255, 65, 0.1);
  border: 2px solid var(--efootball-green);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  backdrop-filter: blur(10px);
}

.form-container {
  background: rgba(10, 26, 10, 0.9);
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 255, 65, 0.2);
  overflow: hidden;
}

.form-section {
  padding: 2rem;
  border-bottom: 1px solid rgba(0, 255, 65, 0.1);
}

.form-section:last-child {
  border-bottom: none;
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
}

.section-number {
  background: var(--efootball-green);
  color: var(--efootball-dark);
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  margin-right: 1rem;
  font-family: 'Orbitron', monospace;
}

.section-title {
  font-family: 'Orbitron', monospace;
  font-size: 1.3rem;
  font-weight: 600;
  color: var(--efootball-light);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-grid {
  display: grid;
  gap: 1.5rem;
}

.form-grid-2 {
  grid-template-columns: 1fr 1fr;
}

.form-grid-3 {
  grid-template-columns: 1fr 1fr 1fr;
}

@media (max-width: 768px) {
  .form-grid-2,
  .form-grid-3 {
    grid-template-columns: 1fr;
  }
}

.form-group {
  position: relative;
}

.form-label {
  display: block;
  font-weight: 500;
  color: var(--efootball-light);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.form-label .required {
  color: var(--efootball-green);
  margin-left: 4px;
}

.form-input {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(0, 255, 65, 0.3);
  border-radius: 8px;
  padding: 12px 16px;
  color: var(--efootball-light);
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus {
  outline: none;
  border-color: var(--efootball-green);
  background: rgba(0, 255, 65, 0.05);
  box-shadow: var(--glow-effect);
}

.form-input::placeholder {
  color: #666;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2300ff41' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 12px center;
  background-repeat: no-repeat;
  background-size: 16px;
  padding-right: 40px;
}

.file-upload-zone {
  border: 2px dashed rgba(0, 255, 65, 0.3);
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  background: rgba(0, 255, 65, 0.02);
  transition: all 0.3s ease;
  cursor: pointer;
}

.file-upload-zone:hover {
  border-color: var(--efootball-green);
  background: rgba(0, 255, 65, 0.05);
}

.player-roster {
  background: rgba(0, 255, 65, 0.05);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.player-card {
  background: rgba(10, 26, 10, 0.8);
  border: 1px solid rgba(0, 255, 65, 0.2);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  position: relative;
}

.player-card:last-child {
  margin-bottom: 0;
}

.player-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
}

.player-role-badge {
  background: var(--efootball-green);
  color: var(--efootball-dark);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.player-role-badge.partner {
  background: var(--efootball-blue);
  color: white;
}

.checkbox-group {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 1rem;
  background: rgba(0, 255, 65, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(0, 255, 65, 0.2);
  margin: 1rem 0;
}

.checkbox-input {
  width: 20px;
  height: 20px;
  accent-color: var(--efootball-green);
  margin-top: 2px;
  flex-shrink: 0;
}

.rules-section {
  background: rgba(0, 255, 65, 0.08);
  border: 1px solid rgba(0, 255, 65, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.rules-link {
  color: var(--efootball-green);
  text-decoration: underline;
  font-weight: 500;
  transition: color 0.3s ease;
}

.rules-link:hover {
  color: #33ff66;
}

.submit-section {
  background: var(--gaming-gradient);
  padding: 2rem;
  text-align: center;
}

.submit-button {
  background: var(--efootball-green);
  color: var(--efootball-dark);
  border: none;
  padding: 16px 48px;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: 'Orbitron', monospace;
  box-shadow: 0 4px 20px rgba(0, 255, 65, 0.3);
}

.submit-button:hover {
  background: #33ff66;
  transform: translateY(-2px);
  box-shadow: 0 8px 30px rgba(0, 255, 65, 0.4);
}

.submit-button:active {
  transform: translateY(0);
}

.info-note {
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  padding: 1rem;
  color: #93c5fd;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 6px;
  padding: 12px;
  color: #fca5a5;
  font-size: 0.9rem;
}

/* Enhanced validation styles */
.validation-error {
  color: #f87171;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: none;
}

.validation-success {
  color: #4ade80;
  font-size: 0.875rem;
  margin-top: 0.25rem;
  display: none;
}

.form-input.error {
  border-color: #ef4444 !important;
  background: rgba(239, 68, 68, 0.05);
  box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.2);
}

.form-input.success {
  border-color: #22c55e !important;
  background: rgba(34, 197, 94, 0.05);
  box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.2);
}

.form-input:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
}

.loading {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn-loading {
  position: relative;
}

.btn-loading::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 0.5rem;
  animation: pulse 2s infinite;
  margin-top: 8px;
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-section {
  animation: fadeInUp 0.6s ease forwards;
}

.form-section:nth-child(2) { animation-delay: 0.1s; }
.form-section:nth-child(3) { animation-delay: 0.2s; }
.form-section:nth-child(4) { animation-delay: 0.3s; }
.form-section:nth-child(5) { animation-delay: 0.4s; }

/* Gaming effects */
.form-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--gaming-gradient);
  z-index: 1;
}

.glow-text {
  text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
}

.team-duo-info {
  background: rgba(0, 102, 204, 0.1);
  border: 1px solid rgba(0, 102, 204, 0.3);
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
  text-align: center;
}

.duo-icon {
  font-size: 2rem;
  color: var(--efootball-blue);
  margin-bottom: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="efootball-container">
    {% if messages %}
        {% for message in messages %}
            <div class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}error-message{% elif message.tags == 'success' %}bg-green-500/10 text-green-300 border border-green-500/30{% else %}info-note{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# Check registration status #}
    {% if already_registered %}
        <div class="bg-green-500/10 border border-green-500/30 p-6 rounded-lg text-center mb-6">
            <h2 class="text-2xl font-bold text-green-400 mb-2">✓ Already Registered</h2>
            <p class="text-green-300">Your team is already registered for this tournament.</p>
        </div>
    {% elif pending_request %}
        <div class="bg-yellow-500/10 border border-yellow-500/30 p-6 rounded-lg text-center mb-6">
            <h2 class="text-2xl font-bold text-yellow-400 mb-2">⏳ Request Pending</h2>
            <p class="text-yellow-300">You've requested your team captain to register for this tournament.</p>
            <p class="text-yellow-200 text-sm mt-2">Waiting for captain approval...</p>
        </div>
    {% elif user_team and not is_captain %}
        <div class="bg-blue-500/10 border border-blue-500/30 p-6 rounded-lg mb-6">
            <h2 class="text-2xl font-bold text-blue-400 mb-3">⚽ Request Team Registration</h2>
            <p class="text-blue-300 mb-4">You're not the captain of {{ user_team.name }}. Request your captain to register for this tournament.</p>
            
            <form method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="action" value="request_approval">
                
                <div class="form-group">
                    <label class="form-label">Message to Captain (Optional)</label>
                    <textarea name="request_message" rows="3" class="form-input" 
                              placeholder="Add a message for your captain..."></textarea>
                </div>
                
                <button type="submit" class="submit-button w-full">
                    📨 Send Registration Request to Captain
                </button>
            </form>
        </div>
    {% endif %}

    <!-- Header Section -->
    <div class="efootball-header">
        <h1 class="efootball-title glow-text">eFootball Tournament</h1>
        <h2 class="efootball-subtitle">{{ title }}</h2>
        
        <div class="tournament-info-banner">
            <div class="flex items-center justify-center gap-6">
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-efootball-green">Entry Fee</div>
                    <div class="text-2xl font-bold">{% if entry_fee %}৳{{ entry_fee }}{% else %}FREE{% endif %}</div>
                </div>
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-efootball-green">Format</div>
                    <div class="text-2xl font-bold">2v2 Duo Tournament</div>
                </div>
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-efootball-green">Region</div>
                    <div class="text-2xl font-bold">Bangladesh</div>
                </div>
            </div>
        </div>
        
        <div class="team-duo-info">
            <div class="duo-icon">⚽👥</div>
            <div class="font-medium text-efootball-light">eFootball 2v2 Team Registration</div>
            <div class="text-sm text-gray-300 mt-1">Form a duo with your partner and compete in professional eFootball matches</div>
        </div>
    </div>

    {# Only show registration form for captains or users without a team #}
    {% if not already_registered and not pending_request %}
        {% if not user_team or is_captain %}
    <!-- Registration Form -->
    <form method="post" enctype="multipart/form-data" class="form-container">
        {% csrf_token %}
        
        <!-- Honeypot -->
        <input type="text" name="website" style="display:none;" tabindex="-1" autocomplete="off">

        <!-- Section 1: Team Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">1</div>
                <h3 class="section-title">Duo Team Information</h3>
            </div>
            
            {% if user_team %}
                <div class="info-note mb-4 bg-green-500/5 border-green-500/20">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-efootball-green">⚽</span>
                        <strong>Using Existing Duo: {{ user_team.name }}</strong>
                    </div>
                    <div class="text-sm text-gray-300">
                        Registering with your saved eFootball duo. Team details are locked to maintain consistency.
                        {% if team_members %}
                        <br><strong class="text-white">Duo Partners ({{ team_members|length }}):</strong> 
                        {% for member in team_members %}{{ member.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% endif %}
                    </div>
                </div>
                <input type="hidden" name="use_existing_team" value="true">
                <input type="hidden" name="team_id" value="{{ user_team.id }}">
            {% else %}
                <div class="info-note mb-4 bg-blue-500/5 border-blue-500/20">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-efootball-green">➕</span>
                        <strong>Create New eFootball Duo</strong>
                    </div>
                    <div class="text-sm text-gray-300">
                        Create a new 2-player team for this tournament. You'll become the team captain automatically.
                    </div>
                </div>
            {% endif %}
            
            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">
                        Duo Team Name <span class="required">*</span>
                    </label>
                    <input type="text" name="team_name" class="form-input" 
                           value="{% if user_team %}{{ user_team.name }}{% endif %}"
                           placeholder="Enter your duo team name" required
                           {% if user_team %}readonly title="Team name is locked for existing duos"{% endif %}>
                    {% if not user_team %}
                    <div class="info-note">
                        Choose a unique name for your eFootball duo (e.g., "FC Strikers", "Goal Masters")
                    </div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Team Tag <span class="text-gray-400">(Optional)</span>
                    </label>
                    <input type="text" name="team_tag" class="form-input" 
                           value="{% if user_team %}{{ user_team.tag|default:'' }}{% endif %}"
                           placeholder="e.g., FC, EFC, STK" maxlength="5"
                           {% if user_team %}readonly title="Team tag is locked for existing duos"{% endif %}>
                    {% if not user_team %}
                    <div class="info-note">
                        Short abbreviation (max 5 chars) - e.g., "FC", "EFC", "STK"
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Team Logo <span class="text-gray-400">(Optional)</span></label>
                <div class="file-upload-zone">
                    <input type="file" name="team_logo" accept="image/*" style="display: none;" id="team-logo-input"
                           {% if user_team %}disabled title="Logo cannot be changed during registration"{% endif %}>
                    <label for="team-logo-input" class="cursor-pointer">
                        {% if user_team and user_team.logo %}
                            <img src="{{ user_team.logo.url }}" alt="Current team logo" class="max-h-16 mb-2 mx-auto">
                            <div class="font-medium text-gray-400">Duo logo (locked)</div>
                        {% elif user_team %}
                            <div class="text-gray-400 text-2xl mb-2">⚽</div>
                            <div class="font-medium text-gray-400">No logo set</div>
                        {% else %}
                            <div class="text-efootball-green text-2xl mb-2">⚽</div>
                            <div class="font-medium">Click to upload team logo</div>
                            <div class="text-sm text-gray-400 mt-1">PNG, JPG up to 5MB (Recommended: 512x512px)</div>
                        {% endif %}
                    </label>
                </div>
            </div>
            
            {% if not user_team %}
                <div class="checkbox-group">
                    <input type="checkbox" name="save_team" class="checkbox-input" id="save-duo-check" checked>
                    <label for="save-duo-check" class="text-sm cursor-pointer">
                        <span class="font-medium text-efootball-light">💾 Save this duo to my profile</span>
                        <div class="text-gray-400 mt-1">
                            Recommended: Creates a permanent duo for future eFootball tournaments and easier management.
                        </div>
                    </label>
                </div>
            {% endif %}
        </div>

        <!-- Section 2: Team Captain Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">2</div>
                <h3 class="section-title">Team Captain Information</h3>
            </div>
            
            <div class="info-note mb-4">
                The Team Captain is the primary player and main point of contact for tournament-related updates and communications.
            </div>

            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">
                        Full Name <span class="required">*</span>
                    </label>
              <input type="text" name="captain_full_name" class="form-input" 
                  placeholder="Enter captain's full name" required
                  value="{{ prefill.full_name|default:'' }}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Email Address <span class="required">*</span>
                    </label>
              <input type="email" name="captain_email" class="form-input" 
                  placeholder="captain@example.com" required
                  value="{{ prefill.email|default:'' }}" {% if lock_email %}readonly{% endif %}>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="captain_efootball_id">
                        eFootball ID <span class="required">*</span>
                    </label>
              <input type="text" 
                           name="captain_efootball_id" 
                           id="captain_efootball_id"
                           class="form-input" 
                           placeholder="Your eFootball/Konami ID" 
                           required
                           minlength="3"
                           maxlength="50"
                           title="Enter your eFootball game ID as it appears in-game"
                           aria-describedby="efootball-id-help efootball-id-error">
              <script>document.addEventListener('DOMContentLoaded',function(){var f=document.getElementById('captain_efootball_id');if(f&&'{{ prefill.efootball_id|default:'' }}'){f.value='{{ prefill.efootball_id|escapejs }}';}});</script>
                    <div class="info-note" id="efootball-id-help">
                        Enter your eFootball game ID or Konami ID exactly as it appears in-game.
                    </div>
                    <div class="validation-error" id="efootball-id-error" style="display: none;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Discord ID <span class="required">*</span>
                    </label>
              <input type="text" name="captain_discord" class="form-input" 
                  placeholder="Username#1234" required
                  value="{{ prefill.discord_id|default:'' }}">
                    <div class="info-note">
                        Your Discord username with discriminator for tournament communications.
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Phone Number <span class="required">*</span>
                    </label>
                    <input type="tel" name="captain_phone" class="form-input" 
                           placeholder="+880 1XXX-XXXXXX" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Country <span class="required">*</span>
                    </label>
                    <select name="captain_country" class="form-input form-select" required>
                        <option value="">Select Country</option>
                        <option value="BD">Bangladesh</option>
                        <option value="IN">India</option>
                        <option value="PK">Pakistan</option>
                        <option value="LK">Sri Lanka</option>
                        <option value="NP">Nepal</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Section 3: Team Partner Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">3</div>
                <h3 class="section-title">Team Partner Information</h3>
            </div>
            
            <div class="info-note mb-4">
                Your team partner is the second player who will form the duo team with you for this eFootball tournament.
            </div>

            <div class="player-roster">
                <!-- Player 1 (Captain) -->
                <div class="player-card">
                    <div class="player-card-header">
                        <div class="flex items-center gap-3">
                            <span class="player-role-badge">Captain</span>
                            <span class="font-medium">Player 1 (Team Captain)</span>
                        </div>
                    </div>
                    
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Full Name <span class="required">*</span></label>
                <input type="text" name="player_1_name" class="form-input" required 
                    placeholder="Same as captain name above" value="{{ prefill.full_name|default:'' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">eFootball ID <span class="required">*</span></label>
                <input type="text" name="player_1_efootball_id" class="form-input" required
                    placeholder="Same as captain eFootball ID above" value="{{ prefill.efootball_id|default:'' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord ID <span class="required">*</span></label>
                <input type="text" name="player_1_discord" class="form-input" required
                    placeholder="Same as captain Discord above" value="{{ prefill.discord_id|default:'' }}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                <input type="email" name="player_1_email" class="form-input" required
                    placeholder="Same as captain email above" value="{{ prefill.email|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Player 2 (Partner) -->
                <div class="player-card">
                    <div class="player-card-header">
                        <div class="flex items-center gap-3">
                            <span class="player-role-badge partner">Partner</span>
                            <span class="font-medium">Player 2 (Team Partner)</span>
                        </div>
                    </div>
                    
                    <div class="form-grid form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Full Name <span class="required">*</span></label>
                            <input type="text" name="player_2_name" class="form-input" required
                                   placeholder="Enter partner's full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">eFootball ID <span class="required">*</span></label>
                            <input type="text" name="player_2_efootball_id" class="form-input" required
                                   placeholder="Partner's eFootball/Konami ID">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Discord ID <span class="required">*</span></label>
                            <input type="text" name="player_2_discord" class="form-input" required
                                   placeholder="Partner's Discord ID">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                            <input type="email" name="player_2_email" class="form-input" required
                                   placeholder="Partner's email address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone <span class="text-gray-400">(Optional)</span></label>
                            <input type="tel" name="player_2_phone" class="form-input"
                                   placeholder="Partner's phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Country <span class="required">*</span></label>
                            <select name="player_2_country" class="form-input form-select" required>
                                <option value="">Select Country</option>
                                <option value="BD">Bangladesh</option>
                                <option value="IN">India</option>
                                <option value="PK">Pakistan</option>
                                <option value="LK">Sri Lanka</option>
                                <option value="NP">Nepal</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Tournament Rules & Agreement -->
        {% if tournament_rules.has_rules %}
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">4</div>
                <h3 class="section-title">Tournament Rules & Agreement</h3>
            </div>
            
            <div class="rules-section">
                {% if tournament_rules.rules_pdf_url %}
                    <div class="mb-4">
                        <a href="{{ tournament_rules.rules_pdf_url }}" target="_blank" class="rules-link">
                            📄 Download Tournament Rules PDF
                        </a>
                    </div>
                {% endif %}

                {% if tournament_rules.rules_text %}
                    <div class="mb-4">
                        <h5 class="font-medium text-efootball-light mb-2">Tournament Rules:</h5>
                        <div class="text-sm text-gray-300 prose prose-sm max-w-none">
                            {{ tournament_rules.rules_text|safe }}
                        </div>
                    </div>
                {% endif %}

                {% if tournament_rules.extra_rules %}
                    <div class="mb-4">
                        <h5 class="font-medium text-efootball-light mb-2">Additional Rules:</h5>
                        <div class="text-sm text-gray-300 prose prose-sm max-w-none">
                            {{ tournament_rules.extra_rules|safe }}
                        </div>
                    </div>
                {% endif %}
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="agree_rules" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-efootball-light">I acknowledge that I have read and agree to the tournament's rules and conditions.</span>
                    <div class="text-gray-400 mt-1">
                        By checking this box, you confirm that both team members will abide by the tournament rules and regulations.
                    </div>
                </label>
            </div>
        </div>
        {% endif %}

        <!-- Section 5: Payment Information -->
        {% if entry_fee %}
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">{% if tournament_rules.has_rules %}5{% else %}4{% endif %}</div>
                <h3 class="section-title">Payment Information</h3>
            </div>
            
            <div class="tournament-info-banner mb-4">
                <div class="text-center">
                    <div class="font-orbitron text-lg font-bold text-efootball-green mb-2">Entry Fee Required</div>
                    <div class="text-2xl font-bold">৳{{ entry_fee }}</div>
                    <div class="text-sm text-gray-300 mt-2">Payment verification will be done manually by organizers</div>
                </div>
            </div>

            <div class="form-grid form-grid-2">
                <div class="form-group">
                    <label class="form-label">Payment Method <span class="required">*</span></label>
                    <select name="payment_method" class="form-input form-select" required>
                        <option value="">Select Payment Method</option>
                        {% if payment_config.bkash %}
                            <option value="bkash">bKash - {{ payment_config.bkash }}</option>
                        {% endif %}
                        {% if payment_config.nagad %}
                            <option value="nagad">Nagad - {{ payment_config.nagad }}</option>
                        {% endif %}
                        {% if payment_config.rocket %}
                            <option value="rocket">Rocket - {{ payment_config.rocket }}</option>
                        {% endif %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Account Number <span class="required">*</span></label>
                    <input type="text" name="payer_account_number" class="form-input" 
                           placeholder="Account number used for payment" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Transaction ID <span class="required">*</span></label>
                    <input type="text" name="payment_reference" class="form-input" 
                           placeholder="Enter transaction ID/reference" required minlength="6">
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" name="agree_payment" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-efootball-light">I agree to pay the entry fee of ৳{{ entry_fee }}.</span>
                    <div class="text-gray-400 mt-1">
                        Payment verification will be completed after registration. You'll receive confirmation within 24 hours.
                    </div>
                </label>
            </div>
        </div>
        {% endif %}

        <!-- Section 6: Privacy & Communication -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-number">{% if entry_fee %}{% if tournament_rules.has_rules %}6{% else %}5{% endif %}{% else %}{% if tournament_rules.has_rules %}5{% else %}4{% endif %}{% endif %}</div>
                <h3 class="section-title">Privacy & Communication</h3>
            </div>

            <div class="space-y-4">
                <div class="checkbox-group">
                    <input type="checkbox" name="agree_visibility" class="checkbox-input" required>
                    <label class="text-sm">
                        <span class="font-medium text-efootball-light">I agree that team and player information will be visible to other participants.</span>
                    </label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" name="agree_communication" class="checkbox-input" required>
                    <label class="text-sm">
                        <span class="font-medium text-efootball-light">I consent to receive communications regarding match details and tournament updates.</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <div class="checkbox-group mb-6">
                <input type="checkbox" name="confirm_accuracy" class="checkbox-input" required>
                <label class="text-sm">
                    <span class="font-medium text-white">I confirm that all provided information is accurate and complete.</span>
                    <div class="text-gray-200 mt-1">
                        Incorrect information may lead to disqualification. Please double-check all details before submitting.
                    </div>
                </label>
            </div>

            <button type="submit" class="submit-button">
                Submit Team Registration
            </button>
            
            <div class="text-sm text-gray-200 mt-4">
                After submission, you can update your registration details in your dashboard before the tournament begins.
            </div>
        </div>
    </form>
        {% endif %}
    {% endif %}
</div>

<script>
// Enhanced eFootball registration with validation and UX
document.addEventListener('DOMContentLoaded', function() {
    initializeFormValidation();
    initializeUserExperience();
    setupTeamDataSync();
    initializeProgressTracking();
});

// Real-time form validation
function initializeFormValidation() {
    const form = document.querySelector('form[method="post"]');
    if (!form) return;
    
    // eFootball ID validation
    const efootballIdFields = document.querySelectorAll('input[name*="efootball_id"]');
    efootballIdFields.forEach(field => {
        addRealTimeValidation(field, validateEFootballId, field.name + '-error');
    });
    
    // Discord ID validation  
    const discordFields = document.querySelectorAll('input[name*="discord"]');
    discordFields.forEach(field => {
        addRealTimeValidation(field, validateDiscordId, field.name + '-error');
    });
    
    // Email validation
    const emailFields = document.querySelectorAll('input[type="email"]');
    emailFields.forEach(field => {
        addRealTimeValidation(field, validateEmail, field.name + '-error');
    });
}

function addRealTimeValidation(field, validator, errorId) {
    let errorDiv = document.getElementById(errorId);
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = errorId;
        errorDiv.className = 'validation-error';
        field.parentNode.appendChild(errorDiv);
    }
    
    field.addEventListener('input', function() {
        clearTimeout(field.validationTimeout);
        field.validationTimeout = setTimeout(() => {
            const result = validator(field.value);
            showValidationResult(field, errorDiv, result);
        }, 300);
    });
    
    field.addEventListener('blur', function() {
        const result = validator(field.value);
        showValidationResult(field, errorDiv, result);
    });
}

function showValidationResult(field, errorDiv, result) {
    field.classList.remove('error', 'success');
    errorDiv.style.display = 'none';
    
    if (field.value && result.isValid) {
        field.classList.add('success');
    } else if (field.value && !result.isValid && result.message) {
        field.classList.add('error');
        errorDiv.textContent = result.message;
        errorDiv.style.display = 'block';
    }
}

// Validation functions
function validateEFootballId(value) {
    if (!value) return { isValid: false, message: '' };
    
    if (value.length < 3) {
        return { isValid: false, message: '⚽ eFootball ID must be at least 3 characters' };
    }
    
    if (value.length > 50) {
        return { isValid: false, message: '⚽ eFootball ID must be less than 50 characters' };
    }
    
    // Check for invalid characters (basic validation)
    const validPattern = /^[a-zA-Z0-9_.-]+$/;
    if (!validPattern.test(value)) {
        return { isValid: false, message: '⚽ Only letters, numbers, underscore, dot and dash allowed' };
    }
    
    return { isValid: true };
}

function validateDiscordId(value) {
    if (!value) return { isValid: false, message: '' };
    
    const discordPattern = /^.{2,32}#[0-9]{4}$/;
    if (!discordPattern.test(value)) {
        return { isValid: false, message: '⚽ Format: Username#1234' };
    }
    
    return { isValid: true };
}

function validateEmail(value) {
    if (!value) return { isValid: true }; // Optional field
    
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(value)) {
        return { isValid: false, message: '⚽ Please enter a valid email address' };
    }
    
    return { isValid: true };
}

// Enhanced user experience
function initializeUserExperience() {
    // Form submission with validation
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validateAllRequiredFields()) {
                e.preventDefault();
                showNotification('⚠️ Please fill in all required fields correctly', 'error');
                return false;
            }
            
            handleFormSubmission();
        });
    }
    
    // Enhance input formatting
    formatInputFields();
    
    // Add keyboard navigation
    addKeyboardSupport();
}

function setupTeamDataSync() {
    // Auto-populate captain fields to player 1
    const captainFields = ['full_name', 'efootball_id', 'discord', 'email'];
    
    captainFields.forEach(field => {
        const captainInput = document.querySelector(`input[name="captain_${field}"]`);
        const player1Input = document.querySelector(`input[name="player_1_${field}"]`);
        
        if (captainInput && player1Input) {
            captainInput.addEventListener('input', function() {
                player1Input.value = this.value;
            });
        }
    });
    
    // Load existing team member data if available
    {% if team_members %}
        loadExistingTeamData({{ team_members|safe }});
    {% endif %}
}

function loadExistingTeamData(teamMembers) {
    console.log('Auto-filling eFootball duo members:', teamMembers);
    
    teamMembers.forEach((member, index) => {
        if (index === 0) {
            // Captain (Player 1) - auto-populated from profile and team
            if (member.name) {
                const nameInput = document.querySelector('input[name="captain_full_name"]');
                if (nameInput && !nameInput.value) nameInput.value = member.name;
            }
            if (member.email) {
                const emailInput = document.querySelector('input[name="captain_email"]');
                if (emailInput && !emailInput.value) emailInput.value = member.email;
            }
            if (member.efootball_id) {
                const efootballInput = document.querySelector('input[name="captain_efootball_id"]');
                if (efootballInput && !efootballInput.value) efootballInput.value = member.efootball_id;
            }
            if (member.discord_id) {
                const discordInput = document.querySelector('input[name="captain_discord"]');
                if (discordInput && !discordInput.value) discordInput.value = member.discord_id;
            }
            if (member.phone) {
                const phoneInput = document.querySelector('input[name="captain_phone"]');
                if (phoneInput && !phoneInput.value) phoneInput.value = member.phone;
            }
            if (member.country) {
                const countryInput = document.querySelector('select[name="captain_country"]');
                if (countryInput) countryInput.value = member.country;
            }
        } else if (index === 1) {
            // Player 2 (Partner) - auto-fill from team member
            if (member.name) {
                const nameInput = document.querySelector('input[name="player_2_name"]');
                if (nameInput && !nameInput.value) nameInput.value = member.name;
            }
            if (member.efootball_id) {
                const efootballInput = document.querySelector('input[name="player_2_efootball_id"]');
                if (efootballInput && !efootballInput.value) efootballInput.value = member.efootball_id;
            }
            if (member.discord_id) {
                const discordInput = document.querySelector('input[name="player_2_discord"]');
                if (discordInput && !discordInput.value) discordInput.value = member.discord_id;
            }
            if (member.email) {
                const emailInput = document.querySelector('input[name="player_2_email"]');
                if (emailInput && !emailInput.value) emailInput.value = member.email;
            }
            if (member.phone) {
                const phoneInput = document.querySelector('input[name="player_2_phone"]');
                if (phoneInput && !phoneInput.value) phoneInput.value = member.phone;
            }
            if (member.country) {
                const countryInput = document.querySelector('select[name="player_2_country"]');
                if (countryInput) countryInput.value = member.country;
            }
        }
    });
    
    console.log(`Auto-filled ${teamMembers.length} duo members`);
}

function initializeProgressTracking() {
    const requiredFields = document.querySelectorAll('input[required]');
    let completedFields = 0;
    
    requiredFields.forEach(field => {
        field.addEventListener('input', function() {
            completedFields = Array.from(requiredFields).filter(f => f.value.trim()).length;
            const progress = (completedFields / requiredFields.length) * 100;
            updateProgressIndicator(progress);
        });
    });
    
    createProgressIndicator();
}

function createProgressIndicator() {
    const container = document.createElement('div');
    container.className = 'progress-container fixed top-0 left-0 right-0 z-50';
    container.innerHTML = `
        <div class="bg-gray-800 h-1">
            <div class="form-progress-bar bg-green-500 h-1 transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="progress-text text-xs text-gray-400 text-center py-1 bg-gray-900">⚽ eFootball Registration: 0% Complete</div>
    `;
    
    document.body.insertBefore(container, document.body.firstChild);
}

function updateProgressIndicator(percentage) {
    const progressBar = document.querySelector('.form-progress-bar');
    const progressText = document.querySelector('.progress-text');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    if (progressText) {
        progressText.textContent = `⚽ eFootball Registration: ${Math.round(percentage)}% Complete`;
        
        if (percentage >= 100) {
            progressText.textContent = '⚽ Ready to submit your duo team!';
            progressText.classList.add('text-green-400');
        }
    }
}

function formatInputFields() {
    // Format eFootball IDs
    const efootballFields = document.querySelectorAll('input[name*="efootball_id"]');
    efootballFields.forEach(field => {
        field.addEventListener('input', function(e) {
            // Remove any invalid characters
            e.target.value = e.target.value.replace(/[^a-zA-Z0-9_.-]/g, '');
        });
    });
}

function addKeyboardSupport() {
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.type !== 'submit') {
            e.preventDefault();
            const nextField = getNextField(e.target);
            if (nextField) {
                nextField.focus();
            }
        }
    });
}

function getNextField(currentField) {
    const formFields = Array.from(document.querySelectorAll('input, select, textarea'));
    const currentIndex = formFields.indexOf(currentField);
    return formFields[currentIndex + 1];
}

function validateAllRequiredFields() {
    const requiredFields = document.querySelectorAll('input[required]');
    let allValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('error');
            allValid = false;
        } else {
            field.classList.remove('error');
        }
    });
    
    return allValid;
}

function handleFormSubmission() {
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>⚽ Processing Registration...';
        submitBtn.classList.add('btn-loading');
        
        showNotification('⚽ Registering your eFootball duo team...', 'info');
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform ${
        type === 'error' ? 'bg-red-600' : 
        type === 'success' ? 'bg-green-600' : 'bg-blue-600'
    } text-white max-w-sm`;
    
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.remove('translate-x-full'), 100);
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}