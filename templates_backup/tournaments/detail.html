{% extends "base.html" %}
{% load static humanize %}

{% block title %}{{ ctx.title|default:"Tournament" }} — DeltaCrown{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'siteui/css/tournament-detail-neo.css' %}?v=5" />
<link rel="stylesheet" href="{% static 'siteui/css/tournament-detail-pro.css' %}?v=2" />
<link rel="stylesheet" href="{% static 'siteui/css/tournament-hub-modern.css' %}?v=2" />
<link rel="stylesheet" href="{% static 'css/tournament-state-poller.css' %}?v=1" />
<link rel="stylesheet" href="{% static 'siteui/css/countdown-timer.css' %}?v=1" />
<link rel="stylesheet" href="{% static 'siteui/css/capacity-animations.css' %}?v=1" />
{% if ctx.pdf_viewer %}
<link rel="stylesheet" href="{% static 'siteui/css/pdfjs-skin.css' %}?v=1" />
{% endif %}
{% endblock %}

{% block content %}
<section class="dc-container tneo" data-game="{{ ctx.game_slug|default:'generic' }}" data-slug="{{ ctx.t.slug|default:'' }}" data-tournament-slug="{{ ctx.t.slug }}">
  <div class="neo-hero">
    <div class="bg" aria-hidden="true">
      <div class="glow a"></div><div class="glow b"></div><div class="grid"></div><div class="shine"></div>
    </div>

    <div class="wrap">
      <div class="media">
        {% if ctx.banner %}<img src="{{ ctx.banner }}" alt="{{ ctx.title|default:'Tournament' }} banner" loading="eager" />{% else %}
          <div class="fallback" aria-hidden="true"></div>
        {% endif %}
        {% if ctx.ui.show_live %}<span class="pill live">LIVE</span>{% endif %}
      </div>

      <div class="head">
        <nav class="crumbs small" aria-label="Breadcrumb">
          <a href="{% url 'tournaments:hub' %}">Tournaments</a>
          <span aria-hidden="true">›</span>
          {% if ctx.game_slug %}<a href="{% url 'tournaments:game' ctx.game_slug %}">{{ ctx.game|default:ctx.game_slug|title }}</a><span aria-hidden="true">›</span>{% endif %}
          <span class="muted" aria-current="page">Details</span>
        </nav>

        <h1 class="title"><span class="grad">{{ ctx.title|default:"Tournament" }}</span></h1>
        {% if ctx.short_desc %}<p class="sub">{{ ctx.short_desc|safe }}</p>{% endif %}

        <div class="chips">
          {% if ctx.schedule.starts_at %}<span class="chip">Starts {{ ctx.schedule.starts_at|date:"M j, H:i" }}</span>{% endif %}
          {% if ctx.schedule.ends_at %}<span class="chip">Ends {{ ctx.schedule.ends_at|date:"M j, H:i" }}</span>{% endif %}
          {% if ctx.format.type %}<span class="chip">{{ ctx.format.type|title }}</span>{% endif %}
          {% if ctx.format.best_of %}<span class="chip">Bo{{ ctx.format.best_of }}</span>{% endif %}
          {% if ctx.format.team_min or ctx.format.team_max %}
            <span class="chip">
              {% if ctx.format.team_min and ctx.format.team_max %}{{ ctx.format.team_min }}–{{ ctx.format.team_max }}
              {% else %}{{ ctx.format.team_min|default:ctx.format.team_max }}{% endif %} players
            </span>
          {% endif %}
          {% if ctx.region %}<span class="chip">{{ ctx.region }}</span>{% endif %}
          {% if ctx.platform %}<span class="chip">{{ ctx.platform }}</span>{% endif %}
          {% if ctx.entry_fee is not None %}
            <span class="chip">{% if ctx.entry_fee == 0 %}Free Entry{% else %}৳{{ ctx.entry_fee|intcomma }} Entry{% endif %}</span>
          {% endif %}
          {% if ctx.prize_pool %}<span class="chip">Prize ৳{{ ctx.prize_pool|intcomma }}</span>{% endif %}
          {% if ctx.slots.capacity %}<span class="chip">{{ ctx.slots.current|default:0 }}/{{ ctx.slots.capacity }} slots</span>{% endif %}
        </div>
      </div>

      <aside class="buy">
        <div class="card cta">
          {% if ctx.hero.countdown and ctx.hero.countdown.target_iso %}
            <div class="small muted">Countdown ({{ ctx.hero.tz_label|default:"local" }})</div>
            <div class="countdown" data-countdown="{{ ctx.hero.countdown.target_iso }}">
              <span class="unit"><span class="num" data-d>0</span>d</span>
              <span class="unit"><span class="num" data-h>00</span>h</span>
              <span class="unit"><span class="num" data-m>00</span>m</span>
              <span class="unit"><span class="num" data-s>00</span>s</span>
            </div>
          {% endif %}

          <div class="price">
            {% if ctx.entry_fee is not None %}
              <strong>{% if ctx.entry_fee == 0 %}Free{% else %}৳{{ ctx.entry_fee|intcomma }}{% endif %}</strong>
              <span class="muted small">Entry Fee</span>
            {% endif %}
          </div>

          <ul class="ticks small">
            <li><i class="fa-solid fa-bolt"></i> Easy registration</li>
            <li><i class="fa-solid fa-shield"></i> Verified payouts</li>
            <li><i class="fa-solid fa-trophy"></i> Public standings</li>
            {% if ctx.format.check_in_required %}<li><i class="fa-solid fa-circle-check"></i> Check-in required</li>{% endif %}
          </ul>

          <div id="hero-registration-btn" data-tournament-slug="{{ ctx.t.slug }}">
            {# Dynamic registration button loaded via AJAX #}
            <div class="btn-skeleton-large">
              <div class="skeleton-shimmer"></div>
            </div>
          </div>

          {% if ctx.ui.user_registration %}
            <div class="tag" style="background: var(--success); color: white;">
              <i class="fa-solid fa-check-circle"></i> Registered
            </div>
          {% endif %}
        </div>
      </aside>
    </div>
  </div>

  <div class="neo-body">
    <div>
      <div class="tabs" role="tablist" aria-label="Tournament sections">
        {% for tab in ctx.tabs %}
          <button class="tab{% if tab == ctx.active_tab %} is-active{% endif %}"
                  data-tab="{{ tab }}" role="tab"
                  aria-selected="{% if tab == ctx.active_tab %}true{% else %}false{% endif %}">
            {% if tab == 'overview' %}Overview{% endif %}
            {% if tab == 'info' %}Info{% endif %}
            {% if tab == 'prizes' %}Prizes{% endif %}
            {% if tab == 'participants' %}Participants{% endif %}
            {% if tab == 'bracket' %}Bracket{% endif %}
            {% if tab == 'standings' %}Standings{% endif %}
            {% if tab == 'live' %}Live{% endif %}
            {% if tab == 'rules' %}Rules{% endif %}
            {% if tab == 'policy' %}Coin Policy{% endif %}
            {% if tab == 'support' %}Support{% endif %}
          </button>
        {% endfor %}
      </div>

      <!-- OVERVIEW -->
      <section class="pane {% if 'overview' == ctx.active_tab %}is-active{% endif %}" data-pane="overview">
        <div class="split">
          <article class="card">
            <h2 class="h2">About</h2>
            {% if ctx.desc_html %}<div class="rich">{{ ctx.desc_html|safe }}</div>{% else %}
              <p class="muted">Full description will appear here.</p>
            {% endif %}
          </article>

          <aside class="side">
            <div class="sticky">
              <div class="card">
                <h3 class="h3">Quick Facts</h3>
                
                {# Countdown Timer - Shows most relevant countdown #}
                {% if schedule %}
                  {% if schedule.registration_open_at and not ctx.t.registration_open %}
                    {# Registration hasn't opened yet #}
                    <div class="countdown-timer" 
                         data-countdown-type="registration-open"
                         data-target-time="{{ schedule.registration_open_at|date:'c' }}"
                         data-tournament-slug="{{ ctx.t.slug }}">
                    </div>
                  {% elif schedule.registration_close_at and ctx.t.registration_open and not ctx.t.has_started %}
                    {# Registration is open - show closing countdown #}
                    <div class="countdown-timer" 
                         data-countdown-type="registration-close"
                         data-target-time="{{ schedule.registration_close_at|date:'c' }}"
                         data-tournament-slug="{{ ctx.t.slug }}">
                    </div>
                  {% elif schedule.start_at and not ctx.t.has_started %}
                    {# Registration closed - show tournament start countdown #}
                    <div class="countdown-timer" 
                         data-countdown-type="tournament-start"
                         data-target-time="{{ schedule.start_at|date:'c' }}"
                         data-tournament-slug="{{ ctx.t.slug }}">
                    </div>
                  {% endif %}
                {% endif %}
                
                <dl class="meta compact">
                  {% if schedule %}
                    {# Phase 1 Schedule Data #}
                    <div><dt>Starts</dt><dd>{{ schedule.start_at|date:"M j, H:i" }}</dd></div>
                    <div><dt>Ends</dt><dd>{{ schedule.end_at|date:"M j, H:i" }}</dd></div>
                    <div><dt>Reg. open</dt><dd>{{ schedule.registration_open_at|date:"M j, H:i" }}</dd></div>
                    <div><dt>Reg. close</dt><dd>{{ schedule.registration_close_at|date:"M j, H:i" }}</dd></div>
                  {% else %}
                    {# Fallback to old context #}
                    {% if ctx.schedule.starts_at %}<div><dt>Starts</dt><dd>{{ ctx.schedule.starts_at|date:"M j, H:i" }}</dd></div>{% endif %}
                    {% if ctx.schedule.ends_at %}<div><dt>Ends</dt><dd>{{ ctx.schedule.ends_at|date:"M j, H:i" }}</dd></div>{% endif %}
                    {% if ctx.schedule.reg_open %}<div><dt>Reg. open</dt><dd>{{ ctx.schedule.reg_open|date:"M j, H:i" }}</dd></div>{% endif %}
                    {% if ctx.schedule.reg_close %}<div><dt>Reg. close</dt><dd>{{ ctx.schedule.reg_close|date:"M j, H:i" }}</dd></div>{% endif %}
                  {% endif %}
                  {% if ctx.format.type %}<div><dt>Format</dt><dd>{{ ctx.format.type|title }}</dd></div>{% endif %}
                  {% if ctx.format.best_of %}<div><dt>Best of</dt><dd>Bo{{ ctx.format.best_of }}</dd></div>{% endif %}
                  {% if ctx.platform %}<div><dt>Platform</dt><dd>{{ ctx.platform }}</dd></div>{% endif %}
                  {% if ctx.region %}<div><dt>Region</dt><dd>{{ ctx.region }}</dd></div>{% endif %}
                  {% if capacity %}
                    {# Phase 1 Capacity Data - with live updates #}
                    <div>
                      <dt>Capacity</dt>
                      <dd data-tournament-slots data-previous-count="0">
                        {{ capacity.current_teams }}/{{ capacity.max_teams }}
                      </dd>
                    </div>
                  {% elif ctx.slots.capacity %}
                    {# Fallback to old context #}
                    <div><dt>Slots</dt><dd>{{ ctx.slots.current|default:0 }}/{{ ctx.slots.capacity }}</dd></div>
                  {% endif %}
                </dl>
              </div>

              {% if finance %}
                {# Phase 1 Finance Data #}
                <div class="card">
                  <h3 class="h3">Prize Pool</h3>
                  <p><strong>{{ finance.prize_pool_display }}</strong></p>
                  {% if ctx.prizes %}
                    <p class="small muted" style="margin-top: 4px;">{{ ctx.prizes|length }} prize{{ ctx.prizes|length|pluralize }} available</p>
                  {% endif %}
                </div>
              {% elif ctx.prize_pool %}
                {# Fallback to old context #}
                <div class="card">
                  <h3 class="h3">Prize Pool</h3>
                  <p><strong>৳{{ ctx.prize_pool|intcomma }}</strong></p>
                  {% if ctx.prizes %}
                    <p class="small muted" style="margin-top: 4px;">{{ ctx.prizes|length }} prize{{ ctx.prizes|length|pluralize }} available</p>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </aside>
        </div>
      </section>

      <!-- INFO -->
      <section class="pane {% if 'info' == ctx.active_tab %}is-active{% endif %}" data-pane="info">
        <article class="card">
          <h2 class="h2">Schedule & Format</h2>
          <div class="grid2">
            <div>
              <h3 class="h3">Schedule</h3>
              <ul class="timeline small">
                {% if ctx.schedule.reg_open %}<li><span class="muted">Registration opens</span><span>{{ ctx.schedule.reg_open|date:"M j, H:i" }}</span></li>{% endif %}
                {% if ctx.schedule.reg_close %}<li><span class="muted">Registration closes</span><span>{{ ctx.schedule.reg_close|date:"M j, H:i" }}</span></li>{% endif %}
                {% if ctx.schedule.checkin_open %}<li><span class="muted">Check-in opens</span><span>{{ ctx.schedule.checkin_open|date:"M j, H:i" }}</span></li>{% endif %}
                {% if ctx.schedule.checkin_close %}<li><span class="muted">Check-in closes</span><span>{{ ctx.schedule.checkin_close|date:"M j, H:i" }}</span></li>{% endif %}
                {% if ctx.schedule.starts_at %}<li><span class="muted">Tournament starts</span><span>{{ ctx.schedule.starts_at|date:"M j, H:i" }}</span></li>{% endif %}
                {% if ctx.schedule.ends_at %}<li><span class="muted">Tournament ends</span><span>{{ ctx.schedule.ends_at|date:"M j, H:i" }}</span></li>{% endif %}
              </ul>
            </div>
            <div>
              <h3 class="h3">Format</h3>
              <dl class="meta">
                {% if ctx.format.type %}<div><dt>Type</dt><dd>{{ ctx.format.type|title }}</dd></div>{% endif %}
                {% if ctx.format.best_of %}<div><dt>Best of</dt><dd>Bo{{ ctx.format.best_of }}</dd></div>{% endif %}
                {% if ctx.format.team_min or ctx.format.team_max %}
                  <div><dt>Team size</dt><dd>
                    {% if ctx.format.team_min and ctx.format.team_max %}{{ ctx.format.team_min }}–{{ ctx.format.team_max }}
                    {% else %}{{ ctx.format.team_min|default:ctx.format.team_max }}{% endif %}
                  </dd></div>
                {% endif %}
                {% if ctx.format.check_in_required %}<div><dt>Check-in</dt><dd>Required</dd></div>{% endif %}
              </dl>
            </div>
          </div>
        </article>
      </section>

      <!-- PRIZES -->
      <section class="pane {% if 'prizes' == ctx.active_tab %}is-active{% endif %}" data-pane="prizes">
        <article class="card">
          <h2 class="h2">Prizes</h2>

          {% if ctx.prizes %}
            <div class="podium">
              <div class="podium-row">
                <div class="slot second">
                  <div class="rank">2</div>
                  <div class="reward">
                    {% for p in ctx.prizes %}{% if p.place == 2 %}
                      {% if p.cash %}<div class="cash">৳{{ p.cash }}</div>{% endif %}
                      {% if p.coin %}<div class="coin">Δ {{ p.coin }}</div>{% endif %}
                    {% endif %}{% endfor %}
                  </div>
                </div>
                <div class="slot first">
                  <div class="rank">1</div>
                  <div class="reward">
                    {% for p in ctx.prizes %}{% if p.place == 1 %}
                      {% if p.cash %}<div class="cash">৳{{ p.cash }}</div>{% endif %}
                      {% if p.coin %}<div class="coin">Δ {{ p.coin }}</div>{% endif %}
                    {% endif %}{% endfor %}
                  </div>
                </div>
                <div class="slot third">
                  <div class="rank">3</div>
                  <div class="reward">
                    {% for p in ctx.prizes %}{% if p.place == 3 %}
                      {% if p.cash %}<div class="cash">৳{{ p.cash }}</div>{% endif %}
                      {% if p.coin %}<div class="coin">Δ {{ p.coin }}</div>{% endif %}
                    {% endif %}{% endfor %}
                  </div>
                </div>
              </div>
            </div>

            {# 4th+ compact list #}
            <div class="prizegrid">
              {% for p in ctx.prizes %}
                {% if p.place > 3 %}
                  <div class="prize">
                    <span class="muted">#{{ p.place }}</span>
                    <div>
                      {% if p.cash %}<strong>৳{{ p.cash }}</strong>{% endif %}
                      {% if p.coin %}<span class="muted"> • Δ {{ p.coin }}</span>{% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>

          {% elif ctx.prize_pool %}
            <p>Total prize pool: <strong>৳{{ ctx.prize_pool_fmt|default:ctx.prize_pool }}</strong>. Breakdown will be announced soon.</p>
          {% else %}
            <p class="muted">Prize breakdown will be announced soon.</p>
          {% endif %}
        </article>
      </section>

      <!-- PARTICIPANTS (GATED) -->
      <section class="pane {% if 'participants' == ctx.active_tab %}is-active{% endif %}" data-pane="participants">
        <article class="card">
          <h2 class="h2">Participants</h2>

          {% if not ctx.can_view_sensitive %}
            <div class="locked">
              <i class="fa-solid fa-lock" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
              <p class="muted">Participants will be visible once the tournament starts and only to registered players.</p>
              {% if not ctx.is_registered_user %}
                <p class="small" style="margin-top: 16px;"><a href="{{ ctx.register_url }}" class="btn-neo">Register to join</a></p>
              {% endif %}
            </div>
          {% else %}
            {% if ctx.participants %}
              <div class="table">
                <div class="tr th"><div>Seed</div><div>Participant</div><div>Status</div></div>
                {% for p in ctx.participants %}
                  {% with logo=p.team_logo|default:p.logo avatar=p.avatar name=p.team_name|default:p.name %}
                  <div class="tr">
                    <div><strong>#{{ p.seed|default:"–" }}</strong></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      {% if logo %}
                        <img src="{{ logo }}" alt="" style="width:28px;height:28px;border-radius:4px;object-fit:cover;">
                      {% elif avatar %}
                        <img src="{{ avatar }}" alt="" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">
                      {% else %}
                        <div style="width:28px;height:28px;border-radius:50%;background:var(--glass);display:flex;align-items:center;justify-content:center;">
                          <i class="fa-solid fa-user" style="font-size:14px;opacity:0.5;"></i>
                        </div>
                      {% endif %}
                      <div>
                        <strong>{{ name|default:"Unnamed" }}</strong>
                        {% if p.captain %}<div class="muted small">Captain: {{ p.captain }}</div>{% endif %}
                      </div>
                    </div>
                    <div>
                      {% if p.status == 'verified' %}
                        <span class="badge badge-success"><i class="fa-solid fa-check"></i> Verified</span>
                      {% elif p.status == 'pending' %}
                        <span class="badge badge-warning"><i class="fa-solid fa-clock"></i> Pending</span>
                      {% else %}
                        <span class="muted">{{ p.status|default:"–" }}</span>
                      {% endif %}
                    </div>
                  </div>
                  {% endwith %}
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <i class="fa-solid fa-users" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                <p class="muted">No participants registered yet.</p>
              </div>
            {% endif %}
          {% endif %}
        </article>
      </section>

      <!-- BRACKET (GATED) -->
      <section class="pane {% if 'bracket' == ctx.active_tab %}is-active{% endif %}" data-pane="bracket">
        <article class="card">
          <h2 class="h2">Bracket</h2>
          {% if not ctx.can_view_sensitive %}
            <div class="locked">
              <i class="fa-solid fa-lock" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
              <p class="muted">Bracket will unlock at tournament start for registered players.</p>
            </div>
          {% else %}
            {% if ctx.bracket_url %}
              <div class="embed">
                <iframe title="Bracket" data-src="{{ ctx.bracket_url }}" allowfullscreen loading="lazy"></iframe>
              </div>
            {% else %}
              <div class="empty-state">
                <i class="fa-solid fa-diagram-project" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                <p class="muted">Bracket will be generated when the tournament starts.</p>
              </div>
            {% endif %}
          {% endif %}
        </article>
      </section>

      <!-- STANDINGS -->
      <section class="pane {% if 'standings' == ctx.active_tab %}is-active{% endif %}" data-pane="standings">
        <article class="card">
          <h2 class="h2">Standings</h2>
          {% if ctx.standings %}
            <div class="table">
              <div class="tr th"><div>Rank</div><div>Team/Player</div><div>Wins</div><div>Losses</div><div>Points</div></div>
              {% for r in ctx.standings %}
                <div class="tr">
                  <div>
                    {% if r.rank == 1 %}<i class="fa-solid fa-trophy" style="color: #facc15;"></i>{% endif %}
                    <strong>{{ r.rank|default:"–" }}</strong>
                  </div>
                  <div><strong>{{ r.name|default:"" }}</strong></div>
                  <div class="muted">{{ r.wins|default:"0" }}</div>
                  <div class="muted">{{ r.losses|default:"0" }}</div>
                  <div><strong>{{ r.points|default:"0" }}</strong></div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <i class="fa-solid fa-ranking-star" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
              <p class="muted">Standings will populate as matches are completed.</p>
            </div>
          {% endif %}
        </article>
      </section>

      <!-- LIVE -->
      <section class="pane {% if 'live' == ctx.active_tab %}is-active{% endif %}" data-pane="live">
        <article class="card">
          <h2 class="h2">Live</h2>
          {% if ctx.live.stream %}
            <div class="embed live">
              <iframe title="Live Stream" data-src="{{ ctx.live.stream }}" allow="autoplay; encrypted-media" allowfullscreen loading="lazy"></iframe>
            </div>
            <p class="small muted" style="margin-top:.4rem;">
              <i class="fa-solid fa-circle" style="color: #ef4444;"></i> {{ ctx.live.status|title|default:"Offline" }}
              {% if ctx.live.viewers %} • <i class="fa-solid fa-eye"></i> {{ ctx.live.viewers|intcomma }} watching{% endif %}
            </p>
          {% else %}
            <div class="empty-state">
              <i class="fa-solid fa-video-slash" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
              <p class="muted">Live stream is currently offline.</p>
              <p class="small muted" style="margin-top: 8px;">The stream will begin when the tournament starts.</p>
            </div>
          {% endif %}
        </article>
      </section>

      <!-- RULES -->
      <section class="pane {% if 'rules' == ctx.active_tab %}is-active{% endif %}" data-pane="rules">
        <article class="card">
          <h2 class="h2">Rules</h2>

          {# Phase 1: Tournament Rules #}
          {% if rules %}
            {% if rules.requirements_list %}
            <div style="margin-bottom: 16px;">
              <h3 class="h3">Requirements</h3>
              <ul class="requirements-list">
                {% for req in rules.requirements_list %}
                  <li><i class="fa-solid fa-check-circle"></i> {{ req }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            {% if rules.min_age %}
            <p class="small"><strong>Age Requirement:</strong> {{ rules.min_age }}+ years old</p>
            {% endif %}

            {% if rules.region_lock %}
            <p class="small"><strong>Region:</strong> {{ rules.region_lock }}</p>
            {% endif %}

            {% if rules.rank_restriction %}
            <p class="small"><strong>Rank Restriction:</strong> {{ rules.rank_restriction }}</p>
            {% endif %}
          {% endif %}

          {# Original rules content #}
          {% if ctx.rules.text %}<div class="rich" style="margin-top: 16px;">{{ ctx.rules.text|safe }}</div>{% endif %}
          {% if ctx.rules.extra %}<div class="rich" style="margin-top:.6rem;">{{ ctx.rules.extra|safe }}</div>{% endif %}

          {% if ctx.pdf_viewer %}
            <div class="pdfwrap" style="margin-top:.8rem;">
              {% include "tournaments/partials/_pdf_viewer.html" with cfg=ctx.pdf_viewer %}
            </div>
          {% elif ctx.rules.pdf_url %}
            <div class="embed" style="margin-top:.8rem;">
              <iframe title="Rules PDF" data-src="{{ ctx.rules.pdf_url }}" loading="lazy"></iframe>
            </div>
            <p class="small" style="margin-top:.4rem;">
              <a class="btn-neo btn-ghost" href="{{ ctx.rules.pdf_url }}" target="_blank" rel="noopener">Open rules PDF</a>
            </p>
          {% endif %}

          {% if not rules and not ctx.rules.text and not ctx.rules.extra and not ctx.rules.pdf_url %}
            <p class="muted">Rules will be posted soon.</p>
          {% endif %}
        </article>
      </section>

      <!-- COIN POLICY -->
      <section class="pane {% if 'policy' == ctx.active_tab %}is-active{% endif %}" data-pane="policy">
        <article class="card">
          <h2 class="h2">Coin / Wallet Policy</h2>
          {% if ctx.coin_policy %}<div class="rich">{{ ctx.coin_policy|safe }}</div>
          {% else %}<p class="muted">No coin policy specified for this tournament.</p>{% endif %}
        </article>
      </section>

      <!-- SUPPORT -->
      <section class="pane {% if 'support' == ctx.active_tab %}is-active{% endif %}" data-pane="support">
        <article class="card">
          <h2 class="h2">Support & Disputes</h2>
          <p>If you have an issue with registration, check-in, or match results, please open a ticket.</p>
          <div style="margin-top:.6rem; display:flex; gap:.5rem; flex-wrap:wrap;">
            <a class="btn-neo" href="/support/tickets/new/?ref={{ ctx.t.slug|default:'' }}">Open a ticket</a>
            <a class="btn-neo btn-ghost" href="/discord" target="_blank" rel="noopener"><i class="fa-brands fa-discord"></i> Join Discord</a>
          </div>
        </article>
      </section>

      {% if ctx.related %}
        <section class="pane is-active" data-pane="related" style="margin-top: .8rem;">
          <article class="card">
            <h2 class="h2">Related Tournaments</h2>
            <div class="prizegrid">
              {% for t2 in ctx.related %}
                <div class="prize" style="display:grid; grid-template-columns: 60px 1fr auto; gap:.6rem; align-items:center;">
                  {% if t2.dc_banner_url %}<img src="{{ t2.dc_banner_url }}" alt="" style="width:60px;height:40px;object-fit:cover;border-radius:.4rem;">{% endif %}
                  <div>
                    <div class="small"><a href="{{ t2.dc_url|default:'#' }}">{{ t2.dc_title|default:'Tournament' }}</a></div>
                    <div class="muted small">{{ t2.dc_game|default:'' }}{% if t2.starts_at %} • {{ t2.starts_at|date:"M j" }}{% endif %}</div>
                  </div>
                  <div class="muted small">{% if t2.dc_fee_amount == 0 %}Free{% elif t2.dc_fee_amount %}৳{{ t2.dc_fee_amount }}{% endif %}</div>
                </div>
              {% endfor %}
            </div>
          </article>
        </section>
      {% endif %}
    </div>

    <aside class="side">
      <div class="sticky">
        <div class="card">
          <h3 class="h3">Actions</h3>
          <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
            <div id="sidebar-registration-btn" data-tournament-slug="{{ ctx.t.slug }}" style="flex:1;">
              {# Dynamic registration button loaded via AJAX #}
              <div class="btn-skeleton-compact">
                <div class="skeleton-shimmer"></div>
              </div>
            </div>
            <button class="btn-neo btn-ghost" data-share><i class="fa-solid fa-share"></i> Share</button>
          </div>
        </div>

        <div class="card">
          <h3 class="h3">Contact</h3>
          <p class="small muted">For schedule or bracket issues, contact support via ticket or Discord.</p>
          <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
            <a class="btn-neo btn-ghost" href="/support/tickets/new/?ref={{ ctx.t.slug|default:'' }}">Support</a>
            <a class="btn-neo btn-ghost" href="/discord" target="_blank" rel="noopener"><i class="fa-brands fa-discord"></i> Discord</a>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <div class="mobile-cta" id="mobile-registration-btn" data-tournament-slug="{{ ctx.t.slug }}">
    {# Dynamic registration button loaded via AJAX #}
    <div class="btn-skeleton-large">
      <div class="skeleton-shimmer"></div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="{% static 'siteui/js/tournament-detail-neo.js' %}?v=5"></script>
<script src="{% static 'siteui/js/tournaments-detail.js' %}?v=1"></script>
<script src="{% static 'siteui/js/tournaments-hub-modern.js' %}?v=2"></script>
<script src="{% static 'js/tournament-card-dynamic.js' %}?v=4"></script>
<script src="{% static 'js/tournament-detail-modern.js' %}?v=4"></script>
<script src="{% static 'js/countdown-timer.js' %}?v=1"></script>
<script src="{% static 'js/tournament-state-poller.js' %}?v=2"></script>
{% if ctx.pdf_viewer %}
  <script src="{% static 'siteui/pdfjs/pdf.js' %}"></script>
  <script>window.pdfjsLib && (pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'siteui/pdfjs/pdf.worker.js' %}");</script>
  <script src="{% static 'siteui/js/pdfjs-init.js' %}?v=1"></script>
{% endif %}
{% endblock %}
