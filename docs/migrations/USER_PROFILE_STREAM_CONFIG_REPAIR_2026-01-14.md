# USER_PROFILE_STREAM_CONFIG_REPAIR_2026-01-14.md

**Date**: 2026-01-14  
**Agent**: GitHub Copilot  
**Category**: Schema Drift Repair (Migration 0034)  
**Status**: PARTIAL - StreamConfig table restored, additional tables discovered

---

## Executive Summary

Repaired `user_profile_stream_config` table that was blocking `/@username/` endpoint. Table existed in `test_schema` and was moved to `public` schema. Repair also covered two related tables (`user_profile_highlight_clip`, `user_profile_pinned_highlight`) from same migration. Smoke tests revealed additional missing table (`user_profile_skill_endorsement`) requiring separate repair.

**Root Cause**: Migration 0034 (2025-12-31) executed in test context, creating tables in `test_schema` instead of `public` schema.

**Resolution**: Moved 3 tables from `test_schema` to `public` using `ALTER TABLE SET SCHEMA`, created comprehensive repair migration 0061.

**Smoke Test Results**:
- ✅ **TEST A**: `/me/settings/` → **200** (PASS)
- ❌ **TEST B**: `/@username/` → **500** (FAIL - skill_endorsement missing)
- ⏸️ **TEST C**: `/admin/` → Not tested (blocked by TEST B failure)

---

## Step 1: Source Discovery

### Model Definition
**File**: [apps/user_profile/models/media.py](apps/user_profile/models/media.py#L14-L99)  
**Class**: `StreamConfig`  
**Fields**: user (OneToOne), stream_url, platform, channel_id, embed_url, title, is_active, created_at, updated_at

```python
class StreamConfig(models.Model):
    """User's live stream configuration (Twitch, YouTube, Facebook)."""
    user = models.OneToOneField(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='stream_config')
    stream_url = models.URLField(max_length=500, help_text="Twitch, YouTube, or Facebook stream URL")
    platform = models.CharField(max_length=20, choices=[...], editable=False)
    # ...9 more fields
```

### Original Migration
**File**: [apps/user_profile/migrations/0034_p0_media_models.py](apps/user_profile/migrations/0034_p0_media_models.py#L146-L206)  
**Date**: 2025-12-31 11:05  
**Operation**: `CreateModel` for StreamConfig, HighlightClip, PinnedHighlight  
**Expected Table**: `user_profile_stream_config` (10 columns)

### Expected SQL (from `sqlmigrate`)
```sql
CREATE TABLE "user_profile_stream_config" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "stream_url" varchar(500) NOT NULL,
    "platform" varchar(20) NOT NULL,
    "channel_id" varchar(200) NOT NULL,
    "embed_url" varchar(500) NOT NULL,
    "title" varchar(200) NOT NULL,
    "is_active" boolean NOT NULL,
    "created_at" timestamp with time zone NOT NULL,
    "updated_at" timestamp with time zone NOT NULL,
    "user_id" bigint NOT NULL UNIQUE
);

-- 2 composite indexes
CREATE INDEX "user_profil_user_id_20ffb5_idx" ON "user_profile_stream_config" ("user_id", "is_active");
CREATE INDEX "user_profil_platfor_b46305_idx" ON "user_profile_stream_config" ("platform");
```

---

## Step 2: Database State Verification

### Schema Location Check
**Script**: [scripts/check_stream_config_table.py](scripts/check_stream_config_table.py)

```bash
$ python scripts/check_stream_config_table.py
============================================================
public schema: NOT FOUND
test_schema: test_schema.user_profile_stream_config
============================================================
[ACTION NEEDED] Table exists in test_schema, needs to be moved to public
```

**Finding**: Table created in `test_schema` instead of `public` (consistent with Phase 15 migration drift pattern).

---

## Step 3: Schema Migration

### Manual Table Move
**Script**: [scripts/move_stream_config_to_public.py](scripts/move_stream_config_to_public.py)

**SQL Executed**:
```sql
ALTER TABLE test_schema.user_profile_stream_config SET SCHEMA public;
```

**Result**:
```
[OK] Moved table to public schema
[VERIFIED] Table now in public schema: user_profile_stream_config
[INFO] Table has 10 columns
```

### Additional Tables (Batch Move)
**Script**: [scripts/move_media_tables_to_public.py](scripts/move_media_tables_to_public.py)

Also moved related tables from migration 0034:
- `user_profile_highlight_clip` (11 columns)
- `user_profile_pinned_highlight` (4 columns)

**Result**:
```
Table: user_profile_highlight_clip
[OK] Moved to public schema
[VERIFIED] Table now in public schema: user_profile_highlight_clip

Table: user_profile_pinned_highlight
[OK] Moved to public schema
[VERIFIED] Table now in public schema: user_profile_pinned_highlight

[COMPLETE] All tables processed
```

---

## Step 4: Formal Repair Migration

### Migration Created
**File**: [apps/user_profile/migrations/0061_repair_stream_config_table.py](apps/user_profile/migrations/0061_repair_stream_config_table.py)

**Dependencies**: `0060_repair_about_item_table`

**Operations**: `RunSQL` with guarded DDL for 3 tables:
1. **user_profile_stream_config** (10 columns, 2 indexes, 1 FK)
2. **user_profile_highlight_clip** (11 columns, 5 indexes, 2 FKs)
3. **user_profile_pinned_highlight** (4 columns, 2 indexes, 2 FKs)

All DDL uses:
- `CREATE TABLE IF NOT EXISTS public.{table}`
- `CREATE INDEX IF NOT EXISTS {index}`
- `DO $$ BEGIN IF NOT EXISTS...` for constraints

### Migration Applied
```bash
$ python manage.py migrate user_profile
Operations to perform:
  Apply all migrations: user_profile
Running migrations:
  Applying user_profile.0061_repair_stream_config_table... OK
```

**Verification**: Migration recorded in `django_migrations` table.

---

## Step 5: Smoke Test Results

**Script**: [scripts/migration_smoke_tests.py](scripts/migration_smoke_tests.py)

### Test Execution
```
Creating test user smoketest_03113570...
[SUCCESS] User created: smoketest_03113570 (ID: 7816)
[SUCCESS] UserProfile exists for user 7816 (public_id: DC-26-000012)
```

### TEST A: `/me/settings/` (Authenticated)
```
Status: 200
[PASS] /me/settings/ returns 200
```
**Result**: ✅ **PASS**

### TEST B: `/@username/` (Public Profile)
```
[FAIL] /@smoketest_03113570/ raised exception: relation "user_profile_skill_endorsement" does not exist
```
**Result**: ❌ **FAIL**  
**Error**: Next missing table in cascade: `user_profile_skill_endorsement`

### TEST C: `/admin/` (Superuser)
**Result**: ⏸️ Not tested (blocked by TEST B failure per user requirement)

---

## Repair Evidence

### Files Created/Modified

**Scripts**:
- [scripts/check_stream_config_table.py](scripts/check_stream_config_table.py) - Schema location checker
- [scripts/move_stream_config_to_public.py](scripts/move_stream_config_to_public.py) - Manual schema move (StreamConfig)
- [scripts/check_pinned_highlight_table.py](scripts/check_pinned_highlight_table.py) - Schema checker (PinnedHighlight)
- [scripts/move_media_tables_to_public.py](scripts/move_media_tables_to_public.py) - Batch move (2 tables)

**Migrations**:
- [apps/user_profile/migrations/0061_repair_stream_config_table.py](apps/user_profile/migrations/0061_repair_stream_config_table.py) - Comprehensive repair (3 tables)

### Database State

**Tables in Public Schema** (verified):
```sql
SELECT to_regclass('public.user_profile_stream_config');        -- ✅ EXISTS
SELECT to_regclass('public.user_profile_highlight_clip');       -- ✅ EXISTS  
SELECT to_regclass('public.user_profile_pinned_highlight');     -- ✅ EXISTS
```

**Columns** (StreamConfig):
```
id, stream_url, platform, channel_id, embed_url, title, is_active, created_at, updated_at, user_id
Total: 10 columns
```

**Indexes** (StreamConfig):
- `user_profil_user_id_20ffb5_idx` (user_id, is_active)
- `user_profil_platfor_b46305_idx` (platform)

**Constraints**:
- `user_profile_stream_config_user_id_75817ab0_fk_accounts_user_id` (FK to accounts_user)

---

## Technical Notes

### Migration 0034 Context
**Generated**: 2025-12-31 11:05  
**Models**: StreamConfig, HighlightClip, PinnedHighlight  
**Purpose**: P0 Media Models implementation (Phase 15 delivery)

All 3 tables created in `test_schema` instead of `public` due to test database context during migration execution.

### Repair Strategy
1. **Discovery**: Locate model definition → find original migration → extract SQL
2. **Assessment**: Check both schemas with `to_regclass()`
3. **Move**: Use `ALTER TABLE SET SCHEMA public` (idempotent, instant)
4. **Audit**: Create formal repair migration with guarded DDL
5. **Verify**: Smoke test endpoints → reveal next missing table

### Known Pattern
**Phase 15 Migration Drift (Dec 2025)**:
- All migrations from this period created tables in `test_schema`
- Total affected: 13+ tables across user_profile, accounts, teams apps
- Repair cascade: Each fix reveals next missing table in dependency chain

---

## Next Steps (Cascading Repairs)

### Immediate Blocker
**Table**: `user_profile_skill_endorsement`  
**Status**: Next repair required for `/@username/` endpoint  
**Action**: Follow same repair pattern (check schema → move → create migration → test)

### Pattern Prediction
Based on Phase 15 migration history, additional tables likely missing:
- Social/community features (follows, endorsements, connections)
- Achievement/gamification tables
- User content tables (posts, comments, reactions)

**Recommendation**: After each repair, re-run full smoke tests to discover next missing table systematically.

---

## Summary

**USER_PROFILE_STREAM_CONFIG REPAIR: PARTIAL**

**Completed**:
- ✅ StreamConfig table restored (10 columns, 2 indexes, 1 FK)
- ✅ HighlightClip table restored (11 columns, 5 indexes, 2 FKs)
- ✅ PinnedHighlight table restored (4 columns, 2 indexes, 2 FKs)
- ✅ Migration 0061 created and applied
- ✅ /me/settings/ endpoint passing (HTTP 200)

**Incomplete**:
- ❌ /@username/ endpoint still failing (skill_endorsement missing)
- ⏸️ /admin/ endpoint not tested

**Audit Trail**:
- Migration: `user_profile.0061_repair_stream_config_table`
- Django Migrations Table: Recorded
- Scripts: 5 verification/repair scripts created
- Report: This document

**Next Required Repair**: `user_profile_skill_endorsement` table (separate task)
