# USER_PROFILE_SKILL_ENDORSEMENT_REPAIR_2026-01-14.md

**Date**: 2026-01-14  
**Agent**: GitHub Copilot  
**Category**: Schema Drift Repair (Migration 0037)  
**Status**: PARTIAL - Endorsement tables restored, bounty table discovered

---

## Executive Summary

Repaired `user_profile_skill_endorsement` and `user_profile_endorsement_opportunity` tables that were blocking `/@username/` endpoint. Both tables existed in `test_schema` and were moved to `public` schema. Smoke tests revealed next missing table (`user_profile_bounty`) requiring separate repair.

**Root Cause**: Migration 0037 (2025-12-31) executed in test context, creating tables in `test_schema` instead of `public` schema.

**Resolution**: Moved 2 tables from `test_schema` to `public` using `ALTER TABLE SET SCHEMA`, created comprehensive repair migration 0062.

**Smoke Test Results**:
- ✅ **TEST A**: `/me/settings/` → **200** (PASS)
- ❌ **TEST B**: `/@username/` → **500** (FAIL - bounty table missing)
- ✅ **TEST C**: `/admin/` → **200** (PASS)
- ✅ **TEST C2**: `/admin/user_profile/userprofile/` → **200** (PASS)

---

## Step 1: Source Discovery

### Model Definition
**File**: [apps/user_profile/models/endorsements.py](apps/user_profile/models/endorsements.py#L43-L161)  
**Class**: `SkillEndorsement`  
**Fields**: match FK, bounty FK, endorser FK, receiver FK, skill_name, comment, created_at, ip_address, user_agent, is_flagged, flag_reason, reviewed_at, reviewed_by FK

```python
class SkillEndorsement(models.Model):
    """Peer-awarded skill recognition from post-match endorsement."""
    match = models.ForeignKey('tournaments.Match', ...)
    bounty = models.ForeignKey('user_profile.Bounty', ...)  # UP-PHASE2E addition
    endorser = models.ForeignKey(User, ...)
    receiver = models.ForeignKey(User, ...)
    skill_name = models.CharField(max_length=20, ...)
    # ...9 more fields
```

**File**: [apps/user_profile/models/endorsements.py](apps/user_profile/models/endorsements.py#L164-L235)  
**Class**: `EndorsementOpportunity`  
**Fields**: match FK, player FK, expires_at, is_used, used_at, notified, notified_at, created_at

### Original Migration
**File**: [apps/user_profile/migrations/0037_p0_skill_endorsements.py](apps/user_profile/migrations/0037_p0_skill_endorsements.py)  
**Date**: 2025-12-31 13:03  
**Operation**: `CreateModel` for SkillEndorsement, EndorsementOpportunity  
**Expected Tables**: 
- `user_profile_skill_endorsement` (14 columns)
- `user_profile_endorsement_opportunity` (9 columns)

### Expected SQL (from `sqlmigrate`)
```sql
CREATE TABLE "user_profile_skill_endorsement" (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "skill_name" varchar(20) NOT NULL,
    "comment" text NOT NULL,
    "created_at" timestamp with time zone NOT NULL,
    "ip_address" inet NULL,
    "user_agent" varchar(500) NOT NULL,
    "is_flagged" boolean NOT NULL,
    "flag_reason" text NOT NULL,
    "reviewed_at" timestamp with time zone NULL,
    "endorser_id" bigint NOT NULL,
    "match_id" bigint NOT NULL,
    "receiver_id" bigint NOT NULL,
    "reviewed_by_id" bigint NULL,
    CONSTRAINT "unique_endorsement_per_match_endorser" UNIQUE ("match_id", "endorser_id"),
    CONSTRAINT "no_self_endorsement" CHECK (NOT ("endorser_id" = ("receiver_id")))
);

-- 11 indexes for query performance
-- 4 FK constraints (endorser, match, receiver, reviewed_by)
```

---

## Step 2: Database State Verification

### Schema Location Check
**Script**: [scripts/check_endorsement_tables.py](scripts/check_endorsement_tables.py)

```bash
$ python scripts/check_endorsement_tables.py
============================================================
Table: user_profile_skill_endorsement
public schema: NOT FOUND
test_schema: test_schema.user_profile_skill_endorsement
[ACTION NEEDED] Table exists in test_schema, needs to be moved to public

============================================================
Table: user_profile_endorsement_opportunity
public schema: NOT FOUND
test_schema: test_schema.user_profile_endorsement_opportunity
[ACTION NEEDED] Table exists in test_schema, needs to be moved to public
```

**Finding**: Both tables created in `test_schema` instead of `public` (consistent with Phase 15 migration drift pattern).

---

## Step 3: Schema Migration

### Manual Table Move
**Script**: [scripts/move_endorsement_tables_to_public.py](scripts/move_endorsement_tables_to_public.py)

**SQL Executed**:
```sql
ALTER TABLE test_schema.user_profile_skill_endorsement SET SCHEMA public;
ALTER TABLE test_schema.user_profile_endorsement_opportunity SET SCHEMA public;
```

**Result**:
```
Table: user_profile_skill_endorsement
[OK] Moved to public schema
[VERIFIED] Table now in public schema: user_profile_skill_endorsement
[INFO] Table has 14 columns

Table: user_profile_endorsement_opportunity
[OK] Moved to public schema
[VERIFIED] Table now in public schema: user_profile_endorsement_opportunity
[INFO] Table has 9 columns

[COMPLETE] All tables processed
```

---

## Step 4: Formal Repair Migration

### Migration Created
**File**: [apps/user_profile/migrations/0062_repair_skill_endorsement_tables.py](apps/user_profile/migrations/0062_repair_skill_endorsement_tables.py)

**Dependencies**: `0061_repair_stream_config_table`

**Operations**: `RunSQL` with guarded DDL for 2 tables:
1. **user_profile_skill_endorsement** (14 columns, 11 indexes, 4 FKs)
2. **user_profile_endorsement_opportunity** (9 columns, 5 indexes, 2 FKs)

All DDL uses:
- `CREATE TABLE IF NOT EXISTS public.{table}`
- `CREATE INDEX IF NOT EXISTS {index}`
- `DO $$ BEGIN IF NOT EXISTS...` for constraints

**Key Constraints**:
- `unique_endorsement_per_match_endorser` (prevents duplicate endorsements)
- `no_self_endorsement` (CHECK constraint blocking self-endorsement)
- `unique_opportunity_per_match_player` (one opportunity per player per match)

### Migration Applied
```bash
$ python manage.py migrate user_profile
Operations to perform:
  Apply all migrations: user_profile
Running migrations:
  Applying user_profile.0062_repair_skill_endorsement_tables... OK
```

**Verification**: Migration recorded in `django_migrations` table.

---

## Step 5: Smoke Test Results

**Script**: [scripts/migration_smoke_tests.py](scripts/migration_smoke_tests.py) (updated to always run admin test)

### Test Execution
```
Creating test user smoketest_03545783...
[SUCCESS] User created: smoketest_03545783 (ID: 7817)
[SUCCESS] UserProfile exists for user 7817 (public_id: DC-26-000013)
```

### TEST A: `/me/settings/` (Authenticated)
```
Status: 200
[PASS] /me/settings/ returns 200
```
**Result**: ✅ **PASS**

### TEST B: `/@username/` (Public Profile)
```
[FAIL] /@smoketest_03545783/ raised exception: relation "user_profile_bounty" does not exist
```
**Result**: ❌ **FAIL**  
**Error**: Next missing table in cascade: `user_profile_bounty`

### TEST C: `/admin/` (Superuser)
```
Status: 200
[PASS] /admin/ returns 200
Admin UserProfile list status: 200
[PASS] /admin/user_profile/userprofile/ returns 200
```
**Result**: ✅ **PASS** (both admin dashboard and UserProfile admin)

---

## Repair Evidence

### Files Created/Modified

**Scripts**:
- [scripts/check_endorsement_tables.py](scripts/check_endorsement_tables.py) - Schema location checker (2 tables)
- [scripts/move_endorsement_tables_to_public.py](scripts/move_endorsement_tables_to_public.py) - Batch schema move
- [scripts/migration_smoke_tests.py](scripts/migration_smoke_tests.py) - Updated to always run admin test

**Migrations**:
- [apps/user_profile/migrations/0062_repair_skill_endorsement_tables.py](apps/user_profile/migrations/0062_repair_skill_endorsement_tables.py) - Comprehensive repair (2 tables)

### Database State

**Tables in Public Schema** (verified):
```sql
SELECT to_regclass('public.user_profile_skill_endorsement');        -- ✅ EXISTS
SELECT to_regclass('public.user_profile_endorsement_opportunity');  -- ✅ EXISTS
```

**Columns** (SkillEndorsement):
```
id, skill_name, comment, created_at, ip_address, user_agent, is_flagged, flag_reason, 
reviewed_at, endorser_id, match_id, receiver_id, reviewed_by_id
Total: 14 columns (includes bounty_id from Phase 2E update)
```

**Indexes** (SkillEndorsement):
- `user_profile_skill_endorsement_skill_name_39e7906f` (skill_name)
- `user_profile_skill_endorsement_skill_name_39e7906f_like` (skill_name pattern ops)
- `user_profile_skill_endorsement_created_at_450df565` (created_at)
- `user_profil_receive_a4e8c9_idx` (receiver_id, created_at DESC)
- `user_profil_match_i_8b9e49_idx` (match_id, created_at)
- `user_profil_receive_2d9b44_idx` (receiver_id, skill_name)
- `user_profil_is_flag_148abd_idx` (is_flagged, created_at)
- +4 FK indexes (endorser, match, receiver, reviewed_by)

**Constraints**:
- `unique_endorsement_per_match_endorser` (UNIQUE match_id, endorser_id)
- `no_self_endorsement` (CHECK endorser_id != receiver_id)
- 4 FK constraints to accounts_user, tournament_engine_match_match

**Columns** (EndorsementOpportunity):
```
id, expires_at, is_used, used_at, notified, notified_at, created_at, match_id, player_id
Total: 9 columns
```

**Indexes** (EndorsementOpportunity):
- `user_profile_endorsement_opportunity_expires_at_005fac76` (expires_at)
- `user_profil_expires_630798_idx` (expires_at, is_used)
- `user_profil_player__6b9b5a_idx` (player_id, is_used, expires_at)
- +2 FK indexes (match, player)

---

## Technical Notes

### Migration 0037 Context
**Generated**: 2025-12-31 13:03  
**Models**: SkillEndorsement, EndorsementOpportunity  
**Purpose**: P0 Skill Endorsement System (Phase 15 delivery)  
**Feature**: Post-match peer recognition with moderation controls

Both tables created in `test_schema` instead of `public` due to test database context during migration execution.

### Repair Strategy
1. **Discovery**: Locate model definitions → find original migration → extract SQL
2. **Assessment**: Check both schemas with `to_regclass()`
3. **Move**: Use `ALTER TABLE SET SCHEMA public` (idempotent, instant, preserves data/indexes)
4. **Audit**: Create formal repair migration with guarded DDL
5. **Verify**: Smoke test all endpoints (A/B/C) → reveal next missing table

### Smoke Test Enhancement
**Updated**: [scripts/migration_smoke_tests.py](scripts/migration_smoke_tests.py)  
**Change**: Admin test (C) now runs regardless of profile test (B) failure  
**Rationale**: Per user requirement, must verify admin functionality independently

### Known Pattern
**Phase 15 Migration Drift (Dec 2025)**:
- All migrations from this period created tables in `test_schema`
- Total affected: 15+ tables across user_profile, accounts, teams apps
- Repair cascade: Each fix reveals next missing table in dependency chain
- Current sequence: left_at → about_item → stream_config → endorsement → **bounty** (next)

---

## Next Steps (Cascading Repairs)

### Immediate Blocker
**Table**: `user_profile_bounty`  
**Status**: Next repair required for `/@username/` endpoint  
**Action**: Follow same repair pattern (check schema → move → create migration → test)  
**Context**: Bounty system introduced in UP-PHASE2E, referenced by SkillEndorsement.bounty FK

### Pattern Prediction
Based on Phase 15 migration history and FK dependencies, additional tables likely missing:
- Bounty-related tables (bounty, bounty_participant, bounty_result)
- Social features (follows, connections, reactions)
- User content (posts, comments)

**Recommendation**: After each repair, re-run full smoke tests (A/B/C) to discover next missing table systematically.

---

## Summary

**USER_PROFILE_SKILL_ENDORSEMENT REPAIR: PARTIAL**

**Completed**:
- ✅ SkillEndorsement table restored (14 columns, 11 indexes, 4 FKs)
- ✅ EndorsementOpportunity table restored (9 columns, 5 indexes, 2 FKs)
- ✅ Migration 0062 created and applied
- ✅ /me/settings/ endpoint passing (HTTP 200)
- ✅ /admin/ endpoints passing (HTTP 200 for dashboard + UserProfile admin)

**Incomplete**:
- ❌ /@username/ endpoint still failing (bounty table missing)

**Audit Trail**:
- Migration: `user_profile.0062_repair_skill_endorsement_tables`
- Django Migrations Table: Recorded
- Scripts: 3 verification/repair scripts created/modified
- Report: This document

**Next Required Repair**: `user_profile_bounty` table (separate task - related to UP-PHASE2E bounty system)
