# Migration Integrity Repair Report
**Date:** 2026-01-14  
**Author:** GitHub Copilot  
**Status:** CRITICAL FAILURE - Widespread migration integrity issues discovered

---

## Executive Summary

**MIGRATION INTEGRITY: FAIL**

Database schema is severely out of sync with applied migrations. At least **8 tables are missing** despite migrations being marked as applied in the `django_migrations` table. This is a critical infrastructure failure that blocks:
- User creation (fixed)
- Endpoint access (blocked)
- Feature functionality (blocked)

**Root Cause:** Migrations were marked as applied (possibly via `--fake` or database restoration) without executing the actual SQL DDL statements.

---

## Part 1: Initial Problem Discovery

### Issue: PublicIDCounter Table Missing
**Discovered:** During C1 cleanup runtime verification  
**Error:**
```
psycopg2.errors.UndefinedTable: relation "user_profile_publicidcounter" does not exist
```

**Expected Migration:** `0016_restore_publicidcounter` or `0020_restore_publicidcounter_for_tests`  
**Status in django_migrations:** Marked as [X] APPLIED  
**Actual Schema:** Table DID NOT EXIST

### Migration History Anomaly
PublicIDCounter has been created and deleted multiple times:
- **0013**: Created PublicIDCounter  
- **0014**: DELETED PublicIDCounter  
- **0016**: Restored PublicIDCounter  
- **0017**: DELETED PublicIDCounter again  
- **0018**: DELETED PublicIDCounter (again)  
- **0020**: Attempted restore (but migration numbered 0020, depends on 0027 - out of order)

---

## Part 2: Repair Actions Taken

### Action 1: Manual Table Creation (PublicIDCounter)
**File:** `scripts/manual_create_publicidcounter.py`

**SQL Executed:**
```sql
CREATE TABLE IF NOT EXISTS user_profile_publicidcounter (
    id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    year integer NOT NULL UNIQUE,
    counter integer NOT NULL DEFAULT 0,
    created_at timestamp with time zone NOT NULL,
    updated_at timestamp with time zone NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_publicid_year 
ON user_profile_publicidcounter (year);
```

**Result:** ✅ SUCCESS - Table created  
**Verification:** User creation now works with public ID generation

### Action 2: Formal Repair Migration Created
**File:** `apps/user_profile/migrations/0056_repair_publicidcounter_table.py`

**Purpose:** Document the manual repair in migration history using `migrations.RunSQL` with `CREATE TABLE IF NOT EXISTS` logic.

**Result:** ✅ Migration applied successfully

---

## Part 3: Comprehensive Schema Audit

**Script:** `scripts/audit_migration_integrity.py`

### Audit Results

**Checks Passed:** 6  
**Checks Failed:** 7

#### ✅ PASS - Tables/Columns Verified
1. `0001_initial` - user_profile_userprofile base fields
2. `0005_badge_userbadge` - user_profile_badge table
3. `0007_userprofile_pronouns_achievement_certificate_and_more` - user_profile_achievement table
4. `0013_add_public_id_system` - public_id column in UserProfile
5. `0016_restore_publicidcounter` - user_profile_publicidcounter table (AFTER MANUAL FIX)
6. `0020_gp0_game_passport_rebuild` - user_profile_gameprofile table

#### ❌ FAIL - Missing Tables/Columns

| Migration | Expected Table/Column | Status |
|-----------|----------------------|--------|
| `0030_phase6c_settings_models` | `user_profile_privacysettings.user_id` | Column MISSING |
| `0031_add_profile_showcase_model` | `user_profile_profileshowcase` | Table MISSING |
| `0034_p0_media_models` | `user_profile_highlight` | Table MISSING |
| `0035_p0_loadout_models` | `user_profile_hardwareloadout` | Table MISSING |
| `0036_p0_trophy_showcase` | `user_profile_trophyshowcase` | Table MISSING |
| `0046_careerprofile_matchmakingpreferences` | `user_profile_careerprofile` | Table MISSING |
| `0048_phase6a_private_account_and_follow_requests` | `user_profile_followrequest` | Table MISSING |

---

## Part 4: Additional Missing Tables Discovered

### During Endpoint Testing
**Test:** GET `/me/settings/` (Control Deck endpoint)

**Error:**
```
psycopg2.errors.UndefinedTable: relation "accounts_accountdeletionrequest" does not exist
LINE 1: ...ts_accountdeletionrequest"."last_user_agent" FROM "accounts_...
```

**Expected Migration:** `accounts.0002_phase3b_account_deletion`  
**Status:** Marked as [X] APPLIED  
**Actual Schema:** Table DOES NOT EXIST

---

## Part 5: Runtime Smoke Test Results

### Test Setup
**Script:** `scripts/c1_verification_test.py`  
**Environment:** DEBUG=True, PostgreSQL, Python 3.12.10  
**Database:** deltacrown (localhost:5432)

### Test 1: User Creation
**Status:** ✅ PASS (after PublicIDCounter fix)
```
[SUCCESS] User created: test_migration_check
           User ID: 7802
           Public ID: DC-26-000001
```

### Test 2: GET /me/settings/
**Status:** ❌ FAIL  
**Error:** Missing table `accounts_accountdeletionrequest`  
**Impact:** Cannot access Control Deck settings page

### Test 3: GET /@username/
**Status:** NOT TESTED (blocked by Test 2 failure)

### Test 4: GET /admin/user_profile/userprofile/
**Status:** NOT TESTED (blocked by Test 2 failure)

---

## Part 6: Database State Analysis

### Confirmed Missing Tables (Minimum)
1. `user_profile_publicidcounter` (FIXED manually)
2. `user_profile_profileshowcase`
3. `user_profile_highlight`
4. `user_profile_hardwareloadout`
5. `user_profile_trophyshowcase`
6. `user_profile_careerprofile`
7. `user_profile_followrequest`
8. `accounts_accountdeletionrequest`

### Missing Columns
1. `user_profile_privacysettings.user_id` (if table exists but column missing)

### Migrations Marked Applied But Not Executed
Based on audit, at least **7-8 migrations** across 2 apps (`user_profile`, `accounts`) have this issue.

---

## Part 7: Root Cause Analysis

### Hypothesis 1: Fake Migration
**Likelihood:** HIGH  
**Evidence:**
- Multiple migrations marked applied
- No corresponding schema changes
- Pattern matches `--fake` command usage

**Possible Command:**
```bash
python manage.py migrate --fake user_profile 0055
python manage.py migrate --fake accounts 0002
```

### Hypothesis 2: Database Restoration
**Likelihood:** MEDIUM  
**Evidence:**
- Database may have been restored from old backup
- `django_migrations` table updated separately
- Schema DDL not re-applied after restore

### Hypothesis 3: Migration System Bug
**Likelihood:** LOW  
**Evidence:**
- Django 5.2.8 is stable
- Would affect wider community if systemic
- More likely human error or operational issue

---

## Part 8: Attempted Repair Strategy

### Option A: Re-run Migrations (Attempted, Failed)
**Command:**
```bash
python manage.py migrate user_profile 0054  # Rollback
python manage.py migrate user_profile 0055  # Re-apply
```

**Result:** Migration reported "OK" but columns still missing  
**Conclusion:** Migration system believes they're already applied, skips SQL execution

### Option B: Manual SQL + Repair Migration (Partially Successful)
**For PublicIDCounter:**
1. Created manual script to execute DDL
2. Created formal repair migration using `RunSQL` with `CREATE IF NOT EXISTS`
3. ✅ SUCCESS

**Limitation:** 7+ more tables need same treatment

### Option C: Full Migration Reset (NOT ATTEMPTED - Too Risky)
**Would require:**
1. Drop all `user_profile` and `accounts` tables
2. Delete migration records from `django_migrations`
3. Re-run migrations from scratch
4. **RISK:** Data loss, cascade deletion issues, downtime

---

## Part 9: Comprehensive Repair Plan (Not Yet Executed)

### Required Repair Migrations

#### Migration: 0057_repair_privacysettings_user_id
**Purpose:** Add missing `user_id` column to `PrivacySettings` table (if table exists)

#### Migration: 0058_repair_missing_profile_tables
**Purpose:** Create all missing user_profile tables:
- `user_profile_profileshowcase`
- `user_profile_highlight`
- `user_profile_hardwareloadout`
- `user_profile_trophyshowcase`
- `user_profile_careerprofile`
- `user_profile_followrequest`

**Strategy:**
- Use `migrations.RunSQL`
- Generate SQL via `python manage.py sqlmigrate user_profile <number>`
- Wrap in `CREATE TABLE IF NOT EXISTS` 
- Add all FK constraints, indexes
- Idempotent execution

#### Migration: accounts/0003_repair_account_deletion_request
**Purpose:** Create missing `accounts_accountdeletionrequest` table

---

## Part 10: Immediate Workarounds

### For Development/Testing
**Option:** Use fresh database from migrations
```bash
# WARNING: Destroys data
dropdb deltacrown
createdb deltacrown
python manage.py migrate
```

### For Production (If This Was Prod)
**Option:** Staged repair migrations with zero-downtime strategy
1. Create all missing tables in maintenance window
2. Deploy repair migrations (marked as no-op if tables exist)
3. Verify schema integrity
4. Resume normal operations

---

## Part 11: Lessons Learned

1. **Never use `--fake` without documentation** - Always record why migrations were faked
2. **Schema drift detection needed** - CI/CD should compare `django_migrations` vs actual schema
3. **Migration integrity checks** - Add automated audit script to deployment pipeline
4. **Database backups must include migration state** - Document which migrations were applied at backup time
5. **Post-restoration verification** - Always run schema audit after DB restore

---

## Part 12: Execution Summary

### What Was Fixed
✅ `user_profile_publicidcounter` table created  
✅ User creation with public ID generation restored  
✅ Migration integrity audit script created  
✅ Repair migration 0056 applied and documented

### What Remains Broken
❌ 7+ tables still missing across `user_profile` and `accounts` apps  
❌ Control Deck `/me/settings/` endpoint fails  
❌ Profile showcase features unavailable  
❌ Account deletion request functionality broken  
❌ Career profile, trophy showcase, highlights, follow requests all broken

### C1 Cleanup Status
**C1 cleanup itself is NOT at fault.** All issues are pre-existing migration integrity failures unrelated to recent code changes.

---

## Commands Executed

```bash
# 1. Diagnosis
python scripts/check_publicidcounter_table.py
python manage.py showmigrations user_profile
python manage.py sqlmigrate user_profile 0016

# 2. Manual Repair
python scripts/manual_create_publicidcounter.py
# Result: Table created successfully

# 3. Formal Migration
python manage.py migrate user_profile 0056
# Result: Migration applied

# 4. Audit
python scripts/audit_migration_integrity.py
# Result: 7 failures found

# 5. Test User Creation
python scripts/test_user_creation.py
# Result: SUCCESS (PublicIDCounter working)

# 6. Endpoint Tests
python scripts/c1_verification_test.py
# Result: FAIL (accounts_accountdeletionrequest missing)

# 7. Additional Discovery
python manage.py showmigrations accounts
# Result: 0002_phase3b_account_deletion marked applied but table missing
```

---

## SQL Verification Queries

```sql
-- Check PublicIDCounter (FIXED)
SELECT to_regclass('user_profile_publicidcounter');
-- Result: user_profile_publicidcounter (exists)

-- Check missing tables
SELECT to_regclass('user_profile_profileshowcase');       -- NULL
SELECT to_regclass('user_profile_highlight');             -- NULL
SELECT to_regclass('user_profile_hardwareloadout');       -- NULL
SELECT to_regclass('user_profile_trophyshowcase');        -- NULL
SELECT to_regclass('user_profile_careerprofile');         -- NULL
SELECT to_regclass('user_profile_followrequest');         -- NULL
SELECT to_regclass('accounts_accountdeletionrequest');    -- NULL
```

---

## Recommendation

### Immediate Action Required
1. **DO NOT proceed with feature work** until schema integrity is restored
2. **Create comprehensive repair migration suite** for all missing tables
3. **Run full migration audit** across ALL apps (not just user_profile/accounts)
4. **Document migration history** - Find out when/why migrations were faked

### Medium Term (This Week)
1. Execute repair migrations in order
2. Re-run endpoint smoke tests
3. Add migration integrity checks to CI/CD
4. Update runbook for database operations

### Long Term (This Month)
1. Implement automated schema drift detection
2. Add pre-deployment schema validation
3. Create migration rollback procedures
4. Train team on Django migration best practices

---

## Files Created/Modified

### New Scripts
- `scripts/check_publicidcounter_table.py` - Diagnostic tool
- `scripts/manual_create_publicidcounter.py` - Manual table creation
- `scripts/audit_migration_integrity.py` - Comprehensive schema audit
- `scripts/test_user_creation.py` - User creation smoke test

### New Migrations
- `apps/user_profile/migrations/0056_repair_publicidcounter_table.py` - Repair migration for PublicIDCounter

### Documentation
- `docs/migrations/MIGRATION_INTEGRITY_REPAIR_2026-01-14.md` - This report

---

## Sign-Off

**Migration Integrity Status:** ❌ CRITICAL FAILURE  
**User Creation:** ✅ WORKING (after PublicIDCounter fix)  
**Endpoint Tests:** ❌ BLOCKED (8+ missing tables)  
**C1 Cleanup:** ✅ NOT AT FAULT (pre-existing issue)

**Next Steps:**  
1. Create repair migrations for remaining 7+ tables
2. Re-test all endpoints after repair
3. Implement schema integrity checks in CI/CD

**Estimated Repair Time:** 4-6 hours (creating + testing repair migrations)  
**Risk Level:** HIGH (widespread schema corruption)  
**Urgency:** CRITICAL (blocks development and testing)

---

**Report Completed:** 2026-01-14 20:10 UTC  
**Database:** deltacrown (PostgreSQL localhost:5432)  
**Django Version:** 5.2.8  
**Python Version:** 3.12.10
