{% extends "tournaments/manage/_base.html" %}
{% load humanize %}

{% block manage_content %}

<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
  <div class="metric-card text-center">
    <p class="text-xs font-semibold uppercase tracking-widest text-white/45 mb-2">Total</p>
    <p class="text-2xl font-display font-bold text-white">{{ total_count|default:"0" }}</p>
  </div>
  <div class="metric-card text-center" style="border-color: rgba(239,68,68,0.12);">
    <p class="text-xs font-semibold uppercase tracking-widest text-white/45 mb-2">Open</p>
    <p class="text-2xl font-display font-bold text-red-400">{{ open_count|default:"0" }}</p>
  </div>
  <div class="metric-card text-center" style="border-color: rgba(250,204,21,0.12);">
    <p class="text-xs font-semibold uppercase tracking-widest text-white/45 mb-2">Under Review</p>
    <p class="text-2xl font-display font-bold text-yellow-400">{{ under_review_count|default:"0" }}</p>
  </div>
  <div class="metric-card text-center" style="border-color: rgba(34,197,94,0.12);">
    <p class="text-xs font-semibold uppercase tracking-widest text-white/45 mb-2">Resolved</p>
    <p class="text-2xl font-display font-bold text-emerald-400">{{ resolved_count|default:"0" }}</p>
  </div>
</div>

<div class="flex items-center gap-2 mb-6 flex-wrap">
  <a href="?status="
     class="text-xs px-3 py-1.5 rounded-lg transition font-medium
       {% if not request.GET.status %}bg-cyan-500/10 text-cyan-400 border border-cyan-500/20{% else %}bg-white/[0.03] text-white/40 border border-white/[0.06] hover:text-white/60{% endif %}">
    All <span class="font-mono ml-1 opacity-70">{{ total_count }}</span>
  </a>
  <a href="?status=open"
     class="text-xs px-3 py-1.5 rounded-lg transition font-medium
       {% if request.GET.status == 'open' %}bg-red-500/10 text-red-400 border border-red-500/20{% else %}bg-white/[0.03] text-white/40 border border-white/[0.06] hover:text-white/60{% endif %}">
    Open <span class="font-mono ml-1 opacity-70">{{ open_count }}</span>
  </a>
  <a href="?status=under_review"
     class="text-xs px-3 py-1.5 rounded-lg transition font-medium
       {% if request.GET.status == 'under_review' %}bg-yellow-500/10 text-yellow-400 border border-yellow-500/20{% else %}bg-white/[0.03] text-white/40 border border-white/[0.06] hover:text-white/60{% endif %}">
    Under Review <span class="font-mono ml-1 opacity-70">{{ under_review_count }}</span>
  </a>
  <a href="?status=resolved"
     class="text-xs px-3 py-1.5 rounded-lg transition font-medium
       {% if request.GET.status == 'resolved' %}bg-emerald-500/10 text-emerald-400 border border-emerald-500/20{% else %}bg-white/[0.03] text-white/40 border border-white/[0.06] hover:text-white/60{% endif %}">
    Resolved <span class="font-mono ml-1 opacity-70">{{ resolved_count }}</span>
  </a>
</div>

{% if disputes %}
  <div class="space-y-3">
    {% for dispute in disputes %}
      <div class="liquid-glass rounded-2xl p-5 hover:border-white/[0.15] transition group
        {% if dispute.status == 'open' %}border-l-2 border-l-red-400/50{% elif dispute.status == 'under_review' %}border-l-2 border-l-yellow-400/50{% endif %}">
        <div class="flex items-start gap-4">
          <div class="w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0
            {% if dispute.status == 'open' %}bg-red-500/10
            {% elif dispute.status == 'under_review' %}bg-yellow-500/10
            {% elif dispute.status == 'resolved' %}bg-emerald-500/10
            {% else %}bg-white/[0.04]{% endif %}">
            <i data-lucide="{% if dispute.status == 'open' %}alert-circle{% elif dispute.status == 'under_review' %}search{% elif dispute.status == 'resolved' %}check-circle{% else %}help-circle{% endif %}"
               class="w-5 h-5
                 {% if dispute.status == 'open' %}text-red-400
                 {% elif dispute.status == 'under_review' %}text-yellow-400
                 {% elif dispute.status == 'resolved' %}text-emerald-400
                 {% else %}text-white/35{% endif %}"></i>
          </div>

          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-1.5 flex-wrap">
              <h4 class="text-sm font-semibold text-white/80 truncate">
                {{ dispute.title|default:"Dispute" }}
              </h4>
              <span class="badge
                {% if dispute.status == 'open' %}badge-red
                {% elif dispute.status == 'under_review' %}badge-yellow
                {% elif dispute.status == 'resolved' %}badge-green
                {% else %}badge-gray{% endif %}">
                {{ dispute.status|title }}
              </span>
            </div>

            <p class="text-sm text-white/40 mb-3 line-clamp-2">
              {{ dispute.description|default:dispute.reason|default:"No description provided"|truncatewords:30 }}
            </p>

            <div class="flex flex-wrap items-center gap-4 text-xs text-white/35">
              <span class="flex items-center gap-1">
                <i data-lucide="swords" class="w-3 h-3"></i>
                Match R{{ dispute.match.round_number|default:"?" }}M{{ dispute.match.match_number|default:"?" }}
              </span>
              <span class="flex items-center gap-1">
                <i data-lucide="user" class="w-3 h-3"></i>
                {{ dispute.filed_by|default:"Unknown" }}
              </span>
              <span class="flex items-center gap-1">
                <i data-lucide="clock" class="w-3 h-3"></i>
                {{ dispute.created_at|timesince }} ago
              </span>
            </div>
          </div>

          {% if can_resolve %}
            <div class="flex items-center gap-1 flex-shrink-0 opacity-0 group-hover:opacity-100 transition">
              {% if dispute.status == 'open' %}
                <button onclick="startReview('{{ tournament.slug }}', {{ dispute.id }})"
                        title="Start Review"
                        class="p-2 rounded-lg hover:bg-yellow-500/15 text-white/30 hover:text-yellow-400 transition">
                  <i data-lucide="search" class="w-4 h-4"></i>
                </button>
              {% endif %}
              {% if dispute.status == 'open' or dispute.status == 'under_review' %}
                <button onclick="openResolveModal({{ dispute.id }}, {{ dispute.match.id }})"
                        title="Resolve"
                        class="p-2 rounded-lg hover:bg-emerald-500/15 text-white/30 hover:text-emerald-400 transition">
                  <i data-lucide="check-circle" class="w-4 h-4"></i>
                </button>
                <button onclick="escalateDispute('{{ tournament.slug }}', {{ dispute.id }})"
                        title="Escalate"
                        class="p-2 rounded-lg hover:bg-orange-500/15 text-white/30 hover:text-orange-400 transition">
                  <i data-lucide="arrow-up-circle" class="w-4 h-4"></i>
                </button>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="liquid-glass rounded-2xl">
    <div class="empty-state py-16">
      <i data-lucide="shield-check" class="w-12 h-12 mx-auto"></i>
      <p>No disputes found</p>
      <p class="sub">All clear! Disputes will appear here when players report them.</p>
    </div>
  </div>
{% endif %}

{# ── Resolution Modal ── #}
<div id="resolve-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60">
  <div class="liquid-glass rounded-2xl p-6 w-full max-w-lg">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-display font-bold text-white">Resolve Dispute</h3>
      <button onclick="closeResolveModal()" class="text-white/30 hover:text-white transition">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    <input type="hidden" id="rm-dispute-id" value="">
    <input type="hidden" id="rm-match-id" value="">
    <div class="space-y-4">
      <div>
        <label class="block text-xs text-white/50 mb-1.5">Decision</label>
        <select id="rm-decision" class="form-input w-full" onchange="toggleOverrideScores()">
          <option value="ACCEPT_A">Accept Participant A's Claim</option>
          <option value="ACCEPT_B">Accept Participant B's Claim</option>
          <option value="OVERRIDE">Override — Set Custom Scores</option>
          <option value="REJECT">Reject Dispute</option>
        </select>
      </div>
      <div id="rm-scores" class="hidden grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs text-white/50 mb-1">Participant A Score</label>
          <input type="number" id="rm-score-a" class="form-input w-full" min="0" value="0" />
        </div>
        <div>
          <label class="block text-xs text-white/50 mb-1">Participant B Score</label>
          <input type="number" id="rm-score-b" class="form-input w-full" min="0" value="0" />
        </div>
      </div>
      <div>
        <label class="block text-xs text-white/50 mb-1.5">Resolution Notes <span class="text-red-400">*</span></label>
        <textarea id="rm-notes" class="form-input w-full" rows="3" placeholder="Explain the decision..."></textarea>
      </div>
      <button onclick="submitResolve('{{ tournament.slug }}')" class="btn-primary w-full">
        <i data-lucide="gavel" class="w-4 h-4"></i> Submit Resolution
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
  const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return v ? v.pop() : '';
}
const csrfH = { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' };

function postJSON(url, body) {
  return fetch(url, { method: 'POST', headers: csrfH, credentials: 'same-origin', body: JSON.stringify(body) })
    .then(r => r.json());
}

/* Start Review: transition dispute from open → under_review */
function startReview(slug, disputeId) {
  postJSON(`/tournaments/organizer/${slug}/update-dispute-status/${disputeId}/`, { status: 'under_review' })
    .then(data => { if (data.status === 'success' || data.success) location.reload(); else alert(data.message || data.error || 'Failed'); })
    .catch(() => alert('Network error'));
}

/* Escalate dispute */
function escalateDispute(slug, disputeId) {
  if (!confirm('Escalate this dispute to admin?')) return;
  postJSON(`/tournaments/organizer/${slug}/update-dispute-status/${disputeId}/`, { status: 'escalated' })
    .then(data => { if (data.status === 'success' || data.success) location.reload(); else alert(data.message || data.error || 'Failed'); })
    .catch(() => alert('Network error'));
}

/* Resolution modal */
function openResolveModal(disputeId, matchId) {
  document.getElementById('rm-dispute-id').value = disputeId;
  document.getElementById('rm-match-id').value = matchId;
  document.getElementById('rm-notes').value = '';
  document.getElementById('rm-decision').value = 'ACCEPT_A';
  toggleOverrideScores();
  document.getElementById('resolve-modal').classList.remove('hidden');
}
function closeResolveModal() { document.getElementById('resolve-modal').classList.add('hidden'); }

function toggleOverrideScores() {
  const dec = document.getElementById('rm-decision').value;
  document.getElementById('rm-scores').classList.toggle('hidden', dec !== 'OVERRIDE');
}

function submitResolve(slug) {
  const disputeId = document.getElementById('rm-dispute-id').value;
  const decision = document.getElementById('rm-decision').value;
  const notes = document.getElementById('rm-notes').value.trim();
  if (!notes) { alert('Resolution notes are required.'); return; }

  const body = { decision, resolution_notes: notes };
  if (decision === 'OVERRIDE') {
    body.final_score_a = parseInt(document.getElementById('rm-score-a').value) || 0;
    body.final_score_b = parseInt(document.getElementById('rm-score-b').value) || 0;
  }

  postJSON(`/tournaments/organizer/${slug}/resolve-dispute/${disputeId}/`, body)
    .then(data => {
      if (data.status === 'success' || data.success) { closeResolveModal(); location.reload(); }
      else alert(data.message || data.error || 'Failed');
    })
    .catch(() => alert('Network error'));
}
</script>
{% endblock %}
