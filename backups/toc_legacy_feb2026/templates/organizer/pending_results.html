{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Pending Results — FE-T-015
   Context: tournament, pending_matches, checker,
            pending_count, total_matches
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}Pending Results — {{ tournament.name }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-5xl mx-auto px-4 sm:px-6 py-8">

  {# ── Header ── #}
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <a href="{% url 'tournaments:organizer_tournament_detail' tournament.slug %}" class="text-xs text-gray-500 hover:text-dc-cyan transition mb-2 inline-block">
        <i data-lucide="arrow-left" class="w-3 h-3 inline mr-1"></i> Organizer Hub
      </a>
      <h1 class="text-2xl font-display font-bold text-white">Pending Results</h1>
      <p class="text-sm text-gray-400 mt-1">{{ pending_count }} match{{ pending_count|pluralize:"es" }} awaiting confirmation</p>
    </div>
    <span class="text-xs text-gray-500">{{ pending_count }}/{{ total_matches }} total</span>
  </div>

  {% if pending_matches %}
    <div class="space-y-4">
      {% for match in pending_matches %}
        <div class="glass rounded-xl p-6 hover:bg-white/[0.02] transition">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <span class="text-[10px] text-gray-600 font-mono">R{{ match.round_number }} · M{{ match.match_number }}</span>
                <span class="px-2 py-0.5 text-[10px] rounded-full bg-yellow-900/40 text-yellow-400 border border-yellow-700/30">
                  Pending
                </span>
              </div>
              <p class="text-sm text-white">
                {% if match.participant1 %}{{ match.participant1.username }}{% else %}TBD{% endif %}
                <span class="text-gray-600 mx-2">vs</span>
                {% if match.participant2 %}{{ match.participant2.username }}{% else %}TBD{% endif %}
              </p>
              <p class="text-[10px] text-gray-500 mt-1">Submitted {{ match.updated_at|timesince }} ago</p>
            </div>

            {# Score Comparison #}
            <div class="flex items-center gap-6">
              <div class="text-center">
                <p class="text-xl font-display font-bold text-white">
                  {{ match.participant1_score|default:"—" }} - {{ match.participant2_score|default:"—" }}
                </p>
                <p class="text-[10px] text-gray-500">Reported Score</p>
              </div>

              {# Actions #}
              <div class="flex items-center gap-2">
                <button onclick="confirmResult({{ match.id }})"
                        class="px-3 py-2 bg-green-900/40 text-green-400 text-xs rounded-lg border border-green-700/30 hover:bg-green-900/60 transition">
                  <i data-lucide="check" class="w-3 h-3 inline mr-1"></i> Approve
                </button>
                <button onclick="rejectResult({{ match.id }})"
                        class="px-3 py-2 bg-red-900/40 text-red-400 text-xs rounded-lg border border-red-700/30 hover:bg-red-900/60 transition">
                  <i data-lucide="x" class="w-3 h-3 inline mr-1"></i> Reject
                </button>
                <a href="{% url 'tournaments:match_detail' tournament.slug match.id %}"
                   class="px-3 py-2 bg-white/5 text-gray-400 text-xs rounded-lg border border-dc-border hover:bg-white/10 transition">
                  <i data-lucide="eye" class="w-3 h-3 inline mr-1"></i> View
                </a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {% include "tournaments/components/_pagination.html" %}

  {% else %}
    <div class="glass rounded-xl p-12 text-center">
      <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-green-900/10 flex items-center justify-center">
        <i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>
      </div>
      <h2 class="text-lg font-display font-bold text-white mb-2">All Clear</h2>
      <p class="text-sm text-gray-400">No match results pending approval.</p>
    </div>
  {% endif %}

</div>

{% endblock %}

{% block tournament_js %}
<script>
  async function confirmResult(matchId) {
    if (!confirm('Approve this match result?')) return;
    const res = await fetch(`/tournaments/organizer/{{ tournament.slug }}/confirm-result/${matchId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '', 'X-Requested-With': 'XMLHttpRequest' }
    });
    if (res.ok) location.reload();
    else alert('Failed to confirm result');
  }
  async function rejectResult(matchId) {
    if (!confirm('Reject this result? Participants will need to resubmit.')) return;
    const res = await fetch(`/tournaments/organizer/{{ tournament.slug }}/reject-result/${matchId}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '', 'X-Requested-With': 'XMLHttpRequest' }
    });
    if (res.ok) location.reload();
    else alert('Failed to reject result');
  }
</script>
{% endblock %}
