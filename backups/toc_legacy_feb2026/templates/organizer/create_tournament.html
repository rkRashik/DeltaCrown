{% extends "tournaments/base.html" %}
{% load static humanize %}

{# ─────────────────────────────────────────────────────────
   Create Tournament — Multi-section form
   Phase 4 Frontend Rebuild
   ───────────────────────────────────────────────────────── #}

{% block title %}{{ page_title }} | DeltaCrown{% endblock %}

{% block tournament_content %}

<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  {# ── Breadcrumb ── #}
  <div class="flex items-center gap-2 text-xs text-gray-500 mb-6">
    <a href="{% url 'tournaments:organizer_dashboard' %}" class="hover:text-white transition">Dashboard</a>
    <i data-lucide="chevron-right" class="w-3 h-3"></i>
    <span class="text-white">{{ page_title }}</span>
  </div>

  {# ── Page Header ── #}
  <div class="mb-8">
    <h1 class="text-2xl font-display font-bold text-white">{{ page_title }}</h1>
    <p class="text-sm text-gray-500 mt-1">Fill in the details below to set up your tournament. You can edit everything later.</p>
  </div>

  {# ── Form Errors ── #}
  {% if form.errors %}
    <div class="glass rounded-xl p-4 mb-6 border border-red-600/30">
      <div class="flex items-center gap-2 mb-2">
        <i data-lucide="alert-circle" class="w-4 h-4 text-red-400"></i>
        <span class="text-sm font-semibold text-red-400">Please fix the errors below</span>
      </div>
      <ul class="text-xs text-red-400/80 list-disc pl-5 space-y-1">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ field|title }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# ── Main Form ── #}
  <form method="post" class="space-y-6">
    {% csrf_token %}

    {# ── Section: Basic Info ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="trophy" class="w-4 h-4 inline mr-1 text-dc-cyan"></i>
        Basic Information
      </h2>
      <div class="space-y-4">
        {# Name #}
        <div>
          <label for="id_name" class="block text-xs text-gray-400 mb-1.5">Tournament Name <span class="text-red-400">*</span></label>
          {{ form.name }}
          {% if form.name.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.name.errors.0 }}</p>{% endif %}
        </div>

        {# Slug #}
        <div>
          <label for="id_slug" class="block text-xs text-gray-400 mb-1.5">URL Slug <span class="text-red-400">*</span></label>
          {{ form.slug }}
          <p class="text-[10px] text-gray-600 mt-1">deltacrown.com/tournaments/<span class="text-dc-cyan">your-slug</span>/</p>
          {% if form.slug.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.slug.errors.0 }}</p>{% endif %}
        </div>

        {# Game & Format row #}
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="id_game" class="block text-xs text-gray-400 mb-1.5">Game <span class="text-red-400">*</span></label>
            {{ form.game }}
            {% if form.game.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.game.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="id_format" class="block text-xs text-gray-400 mb-1.5">Format <span class="text-red-400">*</span></label>
            {{ form.format }}
            {% if form.format.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.format.errors.0 }}</p>{% endif %}
          </div>
        </div>

        {# Participation, Platform, Mode row #}
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label for="id_participation_type" class="block text-xs text-gray-400 mb-1.5">Participation <span class="text-red-400">*</span></label>
            {{ form.participation_type }}
            {% if form.participation_type.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.participation_type.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="id_platform" class="block text-xs text-gray-400 mb-1.5">Platform <span class="text-red-400">*</span></label>
            {{ form.platform }}
            {% if form.platform.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.platform.errors.0 }}</p>{% endif %}
          </div>
          <div>
            <label for="id_mode" class="block text-xs text-gray-400 mb-1.5">Mode <span class="text-red-400">*</span></label>
            {{ form.mode }}
            {% if form.mode.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.mode.errors.0 }}</p>{% endif %}
          </div>
        </div>

        {# Description #}
        <div>
          <label for="id_description" class="block text-xs text-gray-400 mb-1.5">Description</label>
          {{ form.description }}
          {% if form.description.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.description.errors.0 }}</p>{% endif %}
        </div>
      </div>
    </div>

    {# ── Section: Schedule ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="calendar" class="w-4 h-4 inline mr-1 text-dc-purple"></i>
        Schedule
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="id_registration_start" class="block text-xs text-gray-400 mb-1.5">Registration Opens <span class="text-red-400">*</span></label>
          {{ form.registration_start }}
          {% if form.registration_start.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.registration_start.errors.0 }}</p>{% endif %}
        </div>
        <div>
          <label for="id_registration_end" class="block text-xs text-gray-400 mb-1.5">Registration Closes <span class="text-red-400">*</span></label>
          {{ form.registration_end }}
          {% if form.registration_end.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.registration_end.errors.0 }}</p>{% endif %}
        </div>
        <div class="sm:col-span-2">
          <label for="id_tournament_start" class="block text-xs text-gray-400 mb-1.5">Tournament Start <span class="text-red-400">*</span></label>
          {{ form.tournament_start }}
          {% if form.tournament_start.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.tournament_start.errors.0 }}</p>{% endif %}
        </div>
      </div>
    </div>

    {# ── Section: Capacity & Fees ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="users" class="w-4 h-4 inline mr-1 text-dc-gold"></i>
        Capacity &amp; Fees
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label for="id_max_participants" class="block text-xs text-gray-400 mb-1.5">Max Participants <span class="text-red-400">*</span></label>
          {{ form.max_participants }}
          {% if form.max_participants.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.max_participants.errors.0 }}</p>{% endif %}
        </div>
        <div>
          <label for="id_min_participants" class="block text-xs text-gray-400 mb-1.5">Min Participants</label>
          {{ form.min_participants }}
          <p class="text-[10px] text-gray-600 mt-1">Minimum needed to start (default: 2)</p>
          {% if form.min_participants.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.min_participants.errors.0 }}</p>{% endif %}
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        <div>
          <label for="id_entry_fee_amount" class="block text-xs text-gray-400 mb-1.5">Entry Fee (৳)</label>
          {{ form.entry_fee_amount }}
          <p class="text-[10px] text-gray-600 mt-1">Set 0 for free entry</p>
          {% if form.entry_fee_amount.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.entry_fee_amount.errors.0 }}</p>{% endif %}
        </div>
        <div>
          <label for="id_prize_pool" class="block text-xs text-gray-400 mb-1.5">Prize Pool (৳)</label>
          {{ form.prize_pool }}
          {% if form.prize_pool.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.prize_pool.errors.0 }}</p>{% endif %}
        </div>
      </div>
    </div>

    {# ── Section: Rules ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="scroll-text" class="w-4 h-4 inline mr-1 text-gray-400"></i>
        Rules
      </h2>
      <div>
        <label for="id_rules_text" class="block text-xs text-gray-400 mb-1.5">Tournament Rules</label>
        {{ form.rules_text }}
        <p class="text-[10px] text-gray-600 mt-1">Markdown is supported</p>
        {% if form.rules_text.errors %}<p class="text-[10px] text-red-400 mt-1">{{ form.rules_text.errors.0 }}</p>{% endif %}
      </div>
    </div>

    {# ── Section: Registration Form Config ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="file-text" class="w-4 h-4 inline mr-1 text-dc-cyan"></i>
        Registration Form
      </h2>
      <div class="space-y-4">
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.use_default_form }}
          <div>
            <span class="text-sm text-white">Use Default Form</span>
            <p class="text-[10px] text-gray-500">Standard solo or team registration fields</p>
          </div>
        </label>
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.use_custom_form }}
          <div>
            <span class="text-sm text-white">Use Custom Form</span>
            <p class="text-[10px] text-gray-500">Build a custom registration form with extra fields</p>
          </div>
        </label>
        <div>
          <label for="id_custom_form_template" class="block text-xs text-gray-400 mb-1.5">Custom Form Template</label>
          {{ form.custom_form_template }}
        </div>
      </div>
    </div>

    {# ── Section: Options ── #}
    <div class="glass rounded-xl p-6">
      <h2 class="text-sm font-display font-semibold text-white mb-4">
        <i data-lucide="settings" class="w-4 h-4 inline mr-1 text-gray-400"></i>
        Options & Features
      </h2>
      <div class="space-y-3">
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.is_official }}
          <div>
            <span class="text-sm text-white">Official Tournament</span>
            <p class="text-[10px] text-gray-500">Mark as an official DeltaCrown tournament</p>
          </div>
        </label>
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.is_featured }}
          <div>
            <span class="text-sm text-white">Featured</span>
            <p class="text-[10px] text-gray-500">Show on the homepage featured section</p>
          </div>
        </label>
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.enable_check_in }}
          <div>
            <span class="text-sm text-white">Enable Check-In</span>
            <p class="text-[10px] text-gray-500">Require participants to check in before matches</p>
          </div>
        </label>
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.enable_certificates }}
          <div>
            <span class="text-sm text-white">Generate Certificates</span>
            <p class="text-[10px] text-gray-500">Auto-generate certificates for winners</p>
          </div>
        </label>
        <label class="flex items-center gap-3 px-4 py-3 rounded-lg bg-white/[0.03] border border-dc-border cursor-pointer hover:bg-white/[0.05] transition">
          {{ form.enable_live_updates }}
          <div>
            <span class="text-sm text-white">Live Updates</span>
            <p class="text-[10px] text-gray-500">Real-time bracket and score updates for spectators</p>
          </div>
        </label>
      </div>
    </div>

    {# ── Submit ── #}
    <div class="flex items-center justify-between pt-4">
      <a href="{% url 'tournaments:organizer_dashboard' %}" class="text-sm text-gray-500 hover:text-white transition">
        <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Back to Dashboard
      </a>
      <button type="submit" class="px-6 py-3 bg-dc-cyan text-black font-bold text-sm rounded-xl hover:bg-dc-cyan/90 transition-all shadow-[0_0_20px_rgba(6,182,212,0.3)]">
        <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Create Tournament
      </button>
    </div>

  </form>

</div>

{% endblock %}

{% block tournament_js %}
<script>
  // Auto-generate slug from name
  const nameInput = document.getElementById('id_name');
  const slugInput = document.getElementById('id_slug');
  if (nameInput && slugInput) {
    nameInput.addEventListener('input', () => {
      if (!slugInput.dataset.manual) {
        slugInput.value = nameInput.value
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .substring(0, 50);
      }
    });
    slugInput.addEventListener('input', () => {
      slugInput.dataset.manual = 'true';
    });
  }
</script>
{% endblock %}
