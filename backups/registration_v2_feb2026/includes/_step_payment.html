{% load humanize %}

<div data-wizard-step="payment" class="wizard-step step-hidden animate-slide-in-right">
    <div class="mb-8 border-b border-white/10 pb-6">
        <h2 class="font-gaming font-bold text-3xl text-white mb-2">Entry Fee</h2>
        <p class="text-sm text-gray-400 max-w-lg">Complete payment to secure your {% if registration_type == 'team' %}team's{% else %}{% endif %} spot in the tournament. Funds are held securely until the event concludes.</p>
    </div>

    <div class="flex items-center justify-between p-5 rounded-2xl bg-white/[0.03] border border-white/5 mb-8">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg" style="background: rgba(var(--accent-rgb), 0.2);">
                <i data-lucide="receipt" class="w-6 h-6" style="color: var(--accent);"></i>
            </div>
            <div>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Entry Fee</p>
                <p class="text-2xl font-display font-black text-white">৳{{ tournament.entry_fee_amount|floatformat:0 }} <span class="text-sm text-gray-400 font-normal">{{ tournament.entry_fee_currency|default:"BDT" }}</span></p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">Type</p>
            <p class="text-sm font-bold text-white">{% if registration_type == 'team' %}Team{% else %}Solo{% endif %} Entry</p>
        </div>
    </div>

    <h3 class="text-xs font-black text-gray-400 uppercase tracking-[0.15em] mb-4 flex items-center gap-2">
        <i data-lucide="wallet" class="w-4 h-4" style="color: var(--accent);"></i> Select Payment Method
    </h3>

    <div class="grid grid-cols-1 {% if deltacoin_can_afford %}md:grid-cols-2{% endif %} gap-4 mb-8">
        {% if deltacoin_can_afford %}
        <label class="payment-method-card relative cursor-pointer group" data-method="deltacoin">
            <input type="radio" name="payment_method" value="deltacoin" class="peer sr-only" onchange="selectPaymentMethod('deltacoin')">
            <div class="p-5 rounded-2xl border-2 border-white/10 bg-black/30 peer-checked:border-dc-cyan peer-checked:bg-dc-cyan/5 transition-all group-hover:border-white/20">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-dc-cyan to-dc-purple flex items-center justify-center shadow-lg">
                        <i data-lucide="coins" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm">DeltaCoin</h4>
                        <p class="text-[10px] text-gray-500">Instant auto-debit</p>
                    </div>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Your Balance</p>
                        <p class="text-lg font-display font-bold text-dc-cyan">{{ deltacoin_balance|intcomma }} DC</p>
                    </div>
                    <span class="text-[9px] font-bold text-green-400 bg-green-500/10 px-2 py-1 rounded border border-green-500/20">Sufficient</span>
                </div>
            </div>
        </label>
        {% endif %}

        <label class="payment-method-card relative cursor-pointer group" data-method="mobile">
            <input type="radio" name="payment_method" value="bkash" class="peer sr-only" onchange="selectPaymentMethod('mobile')" {% if not deltacoin_can_afford %}checked{% endif %}>
            <div class="p-5 rounded-2xl border-2 border-white/10 bg-black/30 peer-checked:border-bkash-pink peer-checked:bg-bkash-pink/5 transition-all group-hover:border-white/20">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 rounded-xl bg-bkash-pink flex items-center justify-center shadow-lg shadow-pink-600/30">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-white text-sm">Mobile Payment</h4>
                        <p class="text-[10px] text-gray-500">bKash / Nagad / Rocket</p>
                    </div>
                </div>
                <p class="text-[10px] text-gray-500">Manual verification (5-15 min)</p>
            </div>
        </label>
    </div>

    <div id="panel-deltacoin" class="{% if not deltacoin_can_afford %}step-hidden{% endif %}">
        <div class="bg-gradient-to-r from-dc-cyan/10 to-transparent border border-dc-cyan/20 rounded-2xl p-6 md:p-8 text-center">
            <i data-lucide="zap" class="w-12 h-12 text-dc-cyan mx-auto mb-4"></i>
            <h3 class="font-display font-bold text-2xl text-white mb-2">Instant DeltaCoin Payment</h3>
            <p class="text-gray-400 text-sm mb-6">Your account will be automatically debited upon submission.</p>
            <div class="flex items-baseline justify-center gap-2">
                <span class="text-5xl font-display font-black text-white">{{ tournament.entry_fee_amount|floatformat:0 }}</span>
                <span class="text-lg font-bold text-dc-cyan">DC</span>
            </div>
            <p class="text-xs text-gray-500 mt-3">Remaining balance after debit: <strong class="text-white">{{ deltacoin_balance|intcomma }} → ???</strong> DC</p>
        </div>
    </div>

    <div id="panel-mobile" class="{% if deltacoin_can_afford %}step-hidden{% endif %}">
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="w-full lg:w-1/3">
                <div class="bg-gradient-to-b from-bkash-pink/10 to-transparent border border-bkash-pink/20 rounded-2xl p-6 md:p-8 relative overflow-hidden shadow-xl">
                    <div class="absolute -right-6 -bottom-6 opacity-5 pointer-events-none">
                        <svg width="150" height="150" viewBox="0 0 24 24" fill="none" stroke="#e2136e" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-12 h-12 rounded-xl bg-bkash-pink flex items-center justify-center shadow-lg shadow-pink-600/30">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <h3 class="font-display font-bold text-xl text-white tracking-tight">Mobile Payment</h3>
                    </div>
                    <div class="mb-8">
                        <p class="text-[10px] font-black text-bkash-pink uppercase tracking-widest mb-1">Amount Due</p>
                        <div class="flex items-baseline gap-2">
                            <span class="text-6xl font-display font-black text-white tracking-tighter">৳{{ tournament.entry_fee_amount|floatformat:0 }}</span>
                            <span class="text-sm font-bold text-gray-400">BDT</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 font-medium">{% if registration_type == 'team' %}Team{% else %}Solo{% endif %} Entry Fee</p>
                    </div>
                    <div class="pt-5 border-t border-bkash-pink/20">
                        <div class="flex items-start gap-2">
                            <i data-lucide="shield-check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                            <p class="text-[10px] text-gray-400 leading-relaxed font-medium">
                                Protected by DeltaCrown Escrow. {{ refund_policy_display|default:"Non-refundable" }}.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-2/3 flex flex-col">
                <div class="flex gap-2 mb-4">
                    <button type="button" class="mobile-tab px-4 py-2 rounded-xl text-xs font-bold border transition-all bg-bkash-pink/10 border-bkash-pink/30 text-bkash-pink" data-mobile-method="bkash" onclick="selectMobileMethod('bkash')">bKash</button>
                    <button type="button" class="mobile-tab px-4 py-2 rounded-xl text-xs font-bold border transition-all bg-white/5 border-white/10 text-gray-400 hover:text-white" data-mobile-method="nagad" onclick="selectMobileMethod('nagad')">Nagad</button>
                    <button type="button" class="mobile-tab px-4 py-2 rounded-xl text-xs font-bold border transition-all bg-white/5 border-white/10 text-gray-400 hover:text-white" data-mobile-method="rocket" onclick="selectMobileMethod('rocket')">Rocket</button>
                </div>

                <div class="bg-dc-card/50 border border-white/5 rounded-2xl p-6 md:p-8 flex-1">
                    <h4 class="font-bold text-white mb-6 flex items-center gap-2">
                        <i data-lucide="smartphone" class="w-5 h-5 text-gray-400"></i> Payment Instructions
                    </h4>
                    <ol class="space-y-6 text-sm text-gray-300 font-medium mb-8">
                        <li class="flex gap-4 items-start">
                            <span class="w-6 h-6 rounded-full bg-white/10 text-white flex items-center justify-center text-xs font-bold shrink-0">1</span>
                            <p class="pt-0.5">Open your payment app and select <strong class="text-white">Send Money</strong>.</p>
                        </li>
                        <li class="flex gap-4 items-start">
                            <span class="w-6 h-6 rounded-full bg-white/10 text-white flex items-center justify-center text-xs font-bold shrink-0">2</span>
                            <div class="w-full pt-0.5">
                                <p>Send to the Official DeltaCrown Number:</p>
                                <div class="mt-3 flex items-center justify-between px-5 py-4 bg-black rounded-xl border border-white/10 group cursor-pointer hover:border-[color:var(--accent)]/50 transition-colors" onclick="copyNumber(this)">
                                    <span class="font-mono font-bold tracking-[0.1em] text-lg select-all" style="color: var(--accent);">01799-XXXXXX</span>
                                    <button type="button" class="text-gray-500 group-hover:text-[color:var(--accent)] transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                                        <i data-lucide="copy" class="w-4 h-4"></i> <span>Copy</span>
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li class="flex gap-4 items-start">
                            <span class="w-6 h-6 rounded-full bg-white/10 text-white flex items-center justify-center text-xs font-bold shrink-0">3</span>
                            <p class="pt-0.5">Enter exactly <strong class="text-white">৳{{ tournament.entry_fee_amount|floatformat:0 }}</strong>. Reference: <strong style="color: var(--accent);">{% if registration_type == 'team' and team %}{{ team.name }}{% else %}{{ request.user.username }}{% endif %}</strong>.</p>
                        </li>
                    </ol>

                    <div class="bg-white/[0.02] p-6 rounded-xl border border-white/10">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3" for="trxid">Transaction ID (TrxID) <span class="text-red-400">*</span></label>
                        <div class="relative">
                            <input type="text" name="transaction_id" id="trxid" class="input-premium input-bkash font-mono tracking-widest text-xl text-center uppercase" placeholder="e.g. 9F8A7B6C5D" maxlength="10" oninput="validateTrxId()">
                            <div id="trx-icon" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600">
                                <i data-lucide="hash" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <div id="trx-status" class="mt-3 flex items-center justify-center gap-2 text-xs font-medium text-gray-500 h-5">
                            Awaiting 10-character alphanumeric ID
                        </div>
                    </div>

                    {% if form_config.enable_payment_screenshot_field %}
                    <div class="mt-4">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2">Payment Screenshot <span class="text-gray-600">(Optional)</span></label>
                        <label class="flex items-center gap-3 p-4 rounded-xl border border-dashed border-white/10 bg-black/30 cursor-pointer hover:border-white/20 transition-all">
                            <i data-lucide="upload" class="w-5 h-5 text-gray-500"></i>
                            <span class="text-sm text-gray-400" id="proof-label">Choose file (max 5MB)</span>
                            <input type="file" name="payment_proof" accept="image/*" class="sr-only" onchange="this.previousElementSibling.textContent = this.files[0]?.name || 'Choose file (max 5MB)'">
                        </label>
                    </div>
                    {% endif %}

                    {% if form_config.enable_payment_mobile_number_field %}
                    <div class="mt-4">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2" for="payment_mobile">Mobile Number Used for Payment <span class="text-red-400">*</span></label>
                        <div class="relative">
                            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                            </div>
                            <input type="tel" name="payment_mobile_number" id="payment_mobile" class="input-premium input-bkash pl-12 font-mono" placeholder="01XXX-XXXXXXX" oninput="checkStep('payment')">
                        </div>
                    </div>
                    {% endif %}

                    {% if form_config.enable_payment_notes_field %}
                    <div class="mt-4">
                        <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2" for="payment_notes">Payment Notes <span class="text-gray-600">(Optional)</span></label>
                        <textarea name="payment_notes" id="payment_notes" class="input-premium" rows="2" maxlength="300" placeholder="Any additional payment details..."></textarea>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
