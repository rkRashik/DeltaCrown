{% extends "tournaments/organizer_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Group Configuration - {{ tournament.name }} - Organizer Console{% endblock %}

{% block page_title %}Group Stage Configuration{% endblock %}

{% block extra_css %}
<style>
.group-preview-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background: #f8f9fa;
}
.group-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.group-preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}
.preview-stat {
    background: white;
    padding: 10px 15px;
    border-radius: 6px;
    border-left: 3px solid #007bff;
}
.preview-stat-label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 5px;
}
.preview-stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: #212529;
}
.tiebreaker-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}
.tiebreaker-badge {
    background: #e7f3ff;
    color: #004085;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    border: 1px solid #b8daff;
}
.form-section {
    background: white;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.form-section-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}
</style>
{% endblock %}

{% block organizer_content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-3">
                <a href="{% url 'tournaments:organizer_hub' slug=tournament.slug tab='groups' %}" class="btn btn-outline-secondary btn-sm me-3">
                    <i class="fas fa-arrow-left"></i> Back to Tournament
                </a>
                <div>
                    <h4 class="mb-1">Configure Group Stage</h4>
                    <p class="text-muted mb-0">Set up groups, points system, and advancement rules</p>
                </div>
            </div>
        </div>
        <div class="col-lg-4 text-end">
            <span class="badge bg-info fs-6">{{ tournament.participants.count }} Participants</span>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <form method="post" id="groupConfigForm">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Group Configuration Section -->
                <div class="form-section">
                    <h5 class="form-section-title"><i class="fas fa-layer-group me-2"></i>Group Configuration</h5>
                    {{ form.num_groups|as_crispy_field }}
                    {{ form.participants_per_group|as_crispy_field }}
                    {{ form.advancement_count|as_crispy_field }}
                </div>

                <!-- Points System Section -->
                <div class="form-section">
                    <h5 class="form-section-title"><i class="fas fa-trophy me-2"></i>Points System</h5>
                    <div class="row">
                        <div class="col-md-4">{{ form.points_for_win|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.points_for_draw|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.points_for_loss|as_crispy_field }}</div>
                    </div>
                </div>

                <!-- Tiebreaker Rules Section -->
                <div class="form-section">
                    <h5 class="form-section-title"><i class="fas fa-scale-balanced me-2"></i>Tiebreaker Rules</h5>
                    {{ form.tiebreaker_order|as_crispy_field }}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Tiebreaker Priority:</strong> When teams have equal points, they will be ranked using the selected criteria in order.
                    </div>
                </div>

                <!-- Advanced Settings Section -->
                <div class="form-section">
                    <h5 class="form-section-title"><i class="fas fa-cogs me-2"></i>Advanced Settings</h5>
                    <div class="form-check mb-3">
                        {{ form.head_to_head_enabled }}
                        <label class="form-check-label" for="{{ form.head_to_head_enabled.id_for_label }}">
                            Use head-to-head record as first tiebreaker
                        </label>
                    </div>
                    {{ form.custom_rules|as_crispy_field }}
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Save Configuration
                    </button>
                </div>
            </div>

            <!-- Preview Sidebar -->
            <div class="col-lg-4">
                <div class="position-sticky" style="top: 20px;">
                    <div class="group-preview-card">
                        <div class="group-preview-header">
                            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Configuration Preview</h6>
                        </div>
                        
                        <div class="group-preview-grid">
                            <div class="preview-stat">
                                <div class="preview-stat-label">Number of Groups</div>
                                <div class="preview-stat-value" id="preview-num-groups">-</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-label">Per Group</div>
                                <div class="preview-stat-value" id="preview-per-group">-</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-label">Advance</div>
                                <div class="preview-stat-value" id="preview-advance">-</div>
                            </div>
                            <div class="preview-stat">
                                <div class="preview-stat-label">Win / Draw / Loss</div>
                                <div class="preview-stat-value" id="preview-points">
                                    <span id="preview-win">-</span> / 
                                    <span id="preview-draw">-</span> / 
                                    <span id="preview-loss">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <div class="preview-stat-label mb-2">Tiebreakers (in order):</div>
                            <div class="tiebreaker-list" id="preview-tiebreakers">
                                <span class="tiebreaker-badge">Not configured</span>
                            </div>
                        </div>

                        <div class="mt-3 p-3 bg-white rounded">
                            <small class="text-muted">
                                <i class="fas fa-calculator me-1"></i>
                                <strong>Total Advancing:</strong> <span id="preview-total-advance">-</span> participants
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('groupConfigForm');
    const numGroupsField = document.getElementById('{{ form.num_groups.id_for_label }}');
    const perGroupField = document.getElementById('{{ form.participants_per_group.id_for_label }}');
    const advanceField = document.getElementById('{{ form.advancement_count.id_for_label }}');
    const winField = document.getElementById('{{ form.points_for_win.id_for_label }}');
    const drawField = document.getElementById('{{ form.points_for_draw.id_for_label }}');
    const lossField = document.getElementById('{{ form.points_for_loss.id_for_label }}');
    const tiebreakerField = document.getElementById('{{ form.tiebreaker_order.id_for_label }}');

    function updatePreview() {
        // Update numeric values
        document.getElementById('preview-num-groups').textContent = numGroupsField.value || '-';
        document.getElementById('preview-per-group').textContent = perGroupField.value || '-';
        document.getElementById('preview-advance').textContent = advanceField.value || '-';
        document.getElementById('preview-win').textContent = winField.value || '-';
        document.getElementById('preview-draw').textContent = drawField.value || '-';
        document.getElementById('preview-loss').textContent = lossField.value || '-';

        // Calculate total advancing
        const numGroups = parseInt(numGroupsField.value) || 0;
        const advance = parseInt(advanceField.value) || 0;
        document.getElementById('preview-total-advance').textContent = (numGroups * advance);

        // Update tiebreakers
        const selectedOptions = Array.from(tiebreakerField.selectedOptions);
        const tiebreakerContainer = document.getElementById('preview-tiebreakers');
        
        if (selectedOptions.length === 0) {
            tiebreakerContainer.innerHTML = '<span class="tiebreaker-badge">Not configured</span>';
        } else {
            tiebreakerContainer.innerHTML = selectedOptions
                .map((opt, idx) => `<span class="tiebreaker-badge">${idx + 1}. ${opt.text}</span>`)
                .join('');
        }
    }

    // Attach listeners
    [numGroupsField, perGroupField, advanceField, winField, drawField, lossField].forEach(field => {
        field.addEventListener('input', updatePreview);
    });
    tiebreakerField.addEventListener('change', updatePreview);

    // Initial update
    updatePreview();
});
</script>
{% endblock %}
