{% extends "base.html" %}
{% load static %}

{% block title %}Export Registrations - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Export Registrations</h1>
                    <div class="text-gray-400">
                        <a href="{% url 'tournaments:detail' tournament.slug %}" class="hover:text-white">{{ tournament.name }}</a>
                        <span class="mx-2">/</span>
                        <span>Export Data</span>
                    </div>
                </div>
                
                <a href="{% url 'tournaments:form_analytics' tournament.slug %}" 
                   class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded font-semibold transition">
                    üìä View Analytics
                </a>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Export Configuration -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold mb-6">Export Configuration</h2>
                    
                    <form id="exportForm">
                        <!-- Export Format -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Export Format</label>
                            <div class="grid grid-cols-3 gap-4">
                                <label class="bg-gray-700 hover:bg-gray-600 p-4 rounded cursor-pointer transition">
                                    <input type="radio" name="format" value="csv" checked class="mr-2">
                                    <span class="font-bold">CSV</span>
                                    <p class="text-xs text-gray-400 mt-1">Comma-separated values</p>
                                </label>
                                
                                <label class="bg-gray-700 hover:bg-gray-600 p-4 rounded cursor-pointer transition">
                                    <input type="radio" name="format" value="excel" class="mr-2">
                                    <span class="font-bold">Excel</span>
                                    <p class="text-xs text-gray-400 mt-1">Formatted spreadsheet</p>
                                </label>
                                
                                <label class="bg-gray-700 hover:bg-gray-600 p-4 rounded cursor-pointer transition">
                                    <input type="radio" name="format" value="json" class="mr-2">
                                    <span class="font-bold">JSON</span>
                                    <p class="text-xs text-gray-400 mt-1">Complete data structure</p>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Filter by Status</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="checkbox" name="status" value="draft" checked>
                                    <span>Drafts</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="checkbox" name="status" value="submitted" checked>
                                    <span>Submitted</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="checkbox" name="status" value="approved" checked>
                                    <span>Approved</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="checkbox" name="status" value="rejected">
                                    <span>Rejected</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Date Range</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">From</label>
                                    <input type="date" name="date_from" 
                                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-400 mb-1">To</label>
                                    <input type="date" name="date_to" 
                                           class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Filters -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Payment Status</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="radio" name="has_paid" value="">
                                    <span>All</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="radio" name="has_paid" value="true">
                                    <span>Paid Only</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="radio" name="has_paid" value="false">
                                    <span>Unpaid Only</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-700 px-3 py-2 rounded cursor-pointer">
                                    <input type="radio" name="payment_verified" value="true">
                                    <span>Verified Only</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Additional Options -->
                        <div class="mb-6" id="csvOptions">
                            <label class="block text-sm font-semibold mb-2">CSV Options</label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="include_metadata" checked>
                                <span class="text-sm">Include metadata (timestamps, user info)</span>
                            </label>
                        </div>
                        
                        <div class="mb-6 hidden" id="jsonOptions">
                            <label class="block text-sm font-semibold mb-2">JSON Options</label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="include_analytics">
                                <span class="text-sm">Include analytics summary</span>
                            </label>
                        </div>
                        
                        <!-- Search -->
                        <div class="mb-6">
                            <label class="block text-sm font-semibold mb-2">Search</label>
                            <input type="text" name="search" placeholder="Search by username or team name..."
                                   class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-purple-500">
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex gap-4">
                            <button type="button" onclick="previewExport()" 
                                    class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded font-bold transition">
                                üëÅÔ∏è Preview
                            </button>
                            <button type="submit" 
                                    class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded font-bold transition">
                                ‚¨áÔ∏è Download Export
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-lg p-6 sticky top-4">
                    <h3 class="text-xl font-bold mb-4">Export Preview</h3>
                    
                    <div id="previewStats" class="space-y-3 mb-6">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Total Records</span>
                            <span class="font-bold" id="totalRecords">-</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Format</span>
                            <span class="font-bold uppercase" id="selectedFormat">CSV</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Estimated Size</span>
                            <span class="font-bold" id="estimatedSize">-</span>
                        </div>
                    </div>
                    
                    <div class="bg-gray-700 rounded p-4 mb-4">
                        <div class="text-xs text-gray-400 mb-2">Quick Stats</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Drafts</span>
                                <span class="font-bold">{{ stats.drafts }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Submitted</span>
                                <span class="font-bold text-blue-400">{{ stats.submitted }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Approved</span>
                                <span class="font-bold text-green-400">{{ stats.approved }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Rejected</span>
                                <span class="font-bold text-red-400">{{ stats.rejected }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-400">
                        <p class="mb-2">üí° Tips:</p>
                        <ul class="space-y-1 list-disc list-inside">
                            <li>CSV is best for spreadsheet apps</li>
                            <li>Excel includes formatting & summary</li>
                            <li>JSON includes full nested data</li>
                            <li>Use filters to export specific groups</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Preview Modal -->
        <div id="previewModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between p-6 border-b border-gray-700">
                    <h3 class="text-2xl font-bold">Export Preview</h3>
                    <button onclick="closePreview()" class="text-gray-400 hover:text-white text-2xl">√ó</button>
                </div>
                
                <div class="p-6 overflow-auto max-h-[70vh]" id="previewContent">
                    <div class="text-center text-gray-400 py-8">
                        Click "Preview" to see sample data
                    </div>
                </div>
                
                <div class="flex items-center justify-between p-6 border-t border-gray-700">
                    <div class="text-sm text-gray-400">
                        Showing first <span id="previewCount">0</span> of <span id="previewTotal">0</span> records
                    </div>
                    <button onclick="closePreview()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Format selector
document.querySelectorAll('input[name="format"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        document.getElementById('selectedFormat').textContent = e.target.value.toUpperCase();
        
        // Show/hide format-specific options
        document.getElementById('csvOptions').classList.toggle('hidden', e.target.value !== 'csv');
        document.getElementById('jsonOptions').classList.toggle('hidden', e.target.value !== 'json');
    });
});

// Preview export
function previewExport() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    // Only add selected statuses
    formData.getAll('status').forEach(val => params.append('status', val));
    params.append('limit', '10');
    
    fetch(`/tournaments/{{ tournament.slug }}/export/preview/?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('previewCount').textContent = data.preview_count;
            document.getElementById('previewTotal').textContent = data.total_count;
            document.getElementById('totalRecords').textContent = data.total_count;
            
            // Estimate size (rough)
            const avgRowSize = 200; // bytes
            const estimatedBytes = data.total_count * avgRowSize;
            const estimatedKB = (estimatedBytes / 1024).toFixed(1);
            document.getElementById('estimatedSize').textContent = `~${estimatedKB} KB`;
            
            // Render preview table
            let html = '<div class="overflow-x-auto"><table class="w-full text-sm"><thead><tr class="bg-gray-700">';
            html += '<th class="px-4 py-2 text-left">ID</th>';
            html += '<th class="px-4 py-2 text-left">Status</th>';
            html += '<th class="px-4 py-2 text-left">User</th>';
            html += '<th class="px-4 py-2 text-left">Submitted</th>';
            
            data.fields.slice(0, 3).forEach(field => {
                html += `<th class="px-4 py-2 text-left">${field.label}</th>`;
            });
            
            html += '</tr></thead><tbody>';
            
            data.rows.forEach(row => {
                html += '<tr class="border-b border-gray-700">';
                html += `<td class="px-4 py-2">${row.id}</td>`;
                html += `<td class="px-4 py-2"><span class="text-xs bg-gray-600 px-2 py-1 rounded">${row.status}</span></td>`;
                html += `<td class="px-4 py-2">${row.user}</td>`;
                html += `<td class="px-4 py-2 text-xs">${row.submitted_at}</td>`;
                
                data.fields.slice(0, 3).forEach(field => {
                    const value = row.fields[field.id] || '-';
                    const truncated = value.length > 30 ? value.substring(0, 30) + '...' : value;
                    html += `<td class="px-4 py-2">${truncated}</td>`;
                });
                
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Preview error:', error);
            alert('Failed to load preview');
        });
}

function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
}

// Export form submission
document.getElementById('exportForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const params = new URLSearchParams(formData);
    
    // Trigger download
    window.location.href = `/tournaments/{{ tournament.slug }}/export/?${params.toString()}`;
});
</script>
{% endblock %}
