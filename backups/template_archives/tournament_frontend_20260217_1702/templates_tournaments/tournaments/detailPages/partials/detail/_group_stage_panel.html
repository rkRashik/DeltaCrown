{# Group Stage Panel - Displays group standings for GROUP_PLAYOFF tournaments #}
{% load dict_utils %}

{% if groups %}
  <div class="td-groupstage-layout">
    {% for group in groups %}
      <section class="td-group-card">
        <header class="td-group-card-header">
          <div class="td-group-title">
            <span class="td-group-label">Group</span>
            <h3 class="td-group-name">{{ group.name }}</h3>
          </div>
          <div class="td-group-meta">
            <span class="td-group-meta-text">Top {{ group.advancement_count }} advance</span>
          </div>
        </header>

        <div class="td-group-standings">
          <div class="td-group-standings-header">
            <span class="td-gs-col td-gs-col-team">Team</span>
            <span class="td-gs-col td-gs-col-mp">P</span>
            <span class="td-gs-col td-gs-col-w">W</span>
            <span class="td-gs-col td-gs-col-d">D</span>
            <span class="td-gs-col td-gs-col-l">L</span>
            <span class="td-gs-col td-gs-col-gd">Â±</span>
            <span class="td-gs-col td-gs-col-pts">Pts</span>
          </div>

          <div class="td-group-standings-body">
            {% with standings=group_standings|get_item:group.id %}
              {% if standings %}
                {% for s in standings %}
                  {# Determine if this row advances (top N from group.advancement_count) #}
                  <div class="td-gs-row {% if forloop.counter <= group.advancement_count %}is-advancing{% endif %}">
                    <div class="td-gs-cell td-gs-col-team">
                      <span class="td-gs-rank">{{ forloop.counter }}</span>
                      <div class="td-gs-team">
                        {# Use team or user, depending on tournament type #}
                        {% if s.team %}
                          <span class="td-gs-team-name">{{ s.team.name }}</span>
                        {% elif s.user %}
                          {% if s.user.profile and s.user.profile.display_name %}
                            <span class="td-gs-team-name">{{ s.user.profile.display_name }}</span>
                          {% else %}
                            <span class="td-gs-team-name">{{ s.user.username }}</span>
                          {% endif %}
                        {% else %}
                          <span class="td-gs-team-name">Unknown</span>
                        {% endif %}
                      </div>
                    </div>

                    <div class="td-gs-cell td-gs-col-mp">{{ s.matches_played }}</div>
                    <div class="td-gs-cell td-gs-col-w">{{ s.matches_won }}</div>
                    <div class="td-gs-cell td-gs-col-d">{{ s.matches_drawn }}</div>
                    <div class="td-gs-cell td-gs-col-l">{{ s.matches_lost }}</div>
                    <div class="td-gs-cell td-gs-col-gd">
                      {# Game-specific stats: use goal_difference or round_difference if available #}
                      {% if s.goal_difference is not None %}
                        {% if s.goal_difference > 0 %}+{% endif %}{{ s.goal_difference }}
                      {% elif s.round_difference is not None %}
                        {% if s.round_difference > 0 %}+{% endif %}{{ s.round_difference }}
                      {% else %}
                        -
                      {% endif %}
                    </div>
                    <div class="td-gs-cell td-gs-col-pts">
                      <span class="td-gs-points">{{ s.points|floatformat:"0" }}</span>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="td-gs-empty-row">
                  <span>No standings yet.</span>
                </div>
              {% endif %}
            {% endwith %}
          </div>
        </div>

        {# Optional: footer for group matches link #}
        {# <footer class="td-group-card-footer">
          <button type="button" class="td-group-matches-button">View matches</button>
        </footer> #}
      </section>
    {% endfor %}
  </div>
{% else %}
  <div class="td-groupstage-empty">
    <div class="td-empty-icon">ðŸ“Š</div>
    <p class="td-empty-title">No groups configured yet.</p>
    <p class="td-empty-subtitle">Group stage will appear here once groups are configured for this tournament.</p>
  </div>
{% endif %}
