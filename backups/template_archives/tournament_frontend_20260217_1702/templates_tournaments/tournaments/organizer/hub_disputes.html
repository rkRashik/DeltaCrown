{% extends "tournaments/organizer/hub_overview.html" %}

{% block hub_content %}
<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Dispute Management</h2>
        
        <!-- Filters -->
        <select onchange="window.location.search='?status='+this.value" class="px-4 py-2 border rounded">
            <option value="">All Statuses</option>
            <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>Open</option>
            <option value="under_review" {% if request.GET.status == 'under_review' %}selected{% endif %}>Under Review</option>
            <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>Resolved</option>
        </select>
    </div>

    <!-- Disputes List -->
    <div class="space-y-4">
        {% for dispute in disputes %}
        <div class="border rounded-lg p-4" id="dispute-{{ dispute.id }}">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-3 py-1 rounded-full text-sm {% if dispute.status == 'open' %}bg-red-100 text-red-800{% elif dispute.status == 'under_review' %}bg-yellow-100 text-yellow-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ dispute.get_status_display }}
                        </span>
                        <span class="text-sm text-gray-600">
                            Filed {{ dispute.created_at|timesince }} ago
                        </span>
                    </div>
                    <div class="mb-2">
                        <strong>Match:</strong> {{ dispute.match.participant1_name }} vs {{ dispute.match.participant2_name }}
                    </div>
                    <div class="mb-2">
                        <strong>Filed by:</strong> {{ dispute.filed_by.username }}
                    </div>
                    <div class="text-gray-700 mb-3">
                        {{ dispute.description }}
                    </div>
                    
                    {% if dispute.resolution_notes %}
                    <div class="bg-gray-50 p-3 rounded border-l-4 border-green-500">
                        <strong class="text-green-700">Resolution Notes:</strong>
                        <p class="text-gray-700 mt-1">{{ dispute.resolution_notes }}</p>
                        <p class="text-xs text-gray-500 mt-2">Resolved by {{ dispute.resolved_by.username }} on {{ dispute.resolved_at|date:"M d, Y H:i" }}</p>
                    </div>
                    {% endif %}
                </div>
                
                {% if can_resolve and dispute.status != 'resolved' %}
                <div class="ml-4 flex flex-col gap-2">
                    {% if dispute.status == 'open' %}
                    <button onclick="updateDisputeStatus({{ dispute.id }}, 'under_review')" 
                            class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 whitespace-nowrap">
                        Mark Under Review
                    </button>
                    {% endif %}
                    
                    {% if dispute.status == 'under_review' %}
                    <button onclick="openResolveModal({{ dispute.id }})" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 whitespace-nowrap">
                        Resolve Dispute
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">⚖️</div>
            <p>No disputes to review</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Resolution Modal -->
<div id="resolveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Resolve Dispute</h3>
        <form id="resolveForm">
            <div class="mb-4">
                <label class="block text-sm font-semibold mb-2">Resolution Notes</label>
                <textarea id="resolutionNotes" rows="4" 
                          class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                          placeholder="Enter resolution details..."></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="closeResolveModal()" 
                        class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Resolve
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentDisputeId = null;

function updateDisputeStatus(disputeId, status) {
    fetch(`/tournaments/organizer/{{ tournament.slug }}/update-dispute/${disputeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function openResolveModal(disputeId) {
    currentDisputeId = disputeId;
    document.getElementById('resolveModal').classList.remove('hidden');
}

function closeResolveModal() {
    currentDisputeId = null;
    document.getElementById('resolveModal').classList.add('hidden');
    document.getElementById('resolutionNotes').value = '';
}

document.getElementById('resolveForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const notes = document.getElementById('resolutionNotes').value.trim();
    
    if (!notes) {
        alert('Please enter resolution notes');
        return;
    }
    
    fetch(`/tournaments/organizer/{{ tournament.slug }}/resolve-dispute/${currentDisputeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ resolution_notes: notes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
});
</script>
{% endblock %}
