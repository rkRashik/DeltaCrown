# Generated by Copilot Agent on 2026-01-14 (REPAIR)

"""
REPAIR MIGRATION: Restore P0 Bounty System Tables
==================================================
Context: Migration 0038 created 4 tables in test_schema instead of public.
Action: Ensure all bounty tables exist in public schema with correct structure.
Source: apps/user_profile/models/bounties.py (Bounty, BountyProof, BountyAcceptance, BountyDispute)
Audit: Tables already moved from test_schema to public via ALTER TABLE SET SCHEMA
Purpose: Record repair in django_migrations table for audit trail
"""

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("user_profile", "0062_repair_skill_endorsement_tables"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            -- ============================================================
            -- TABLE 1: user_profile_bounty
            -- ============================================================
            -- Source: Bounty (apps/user_profile/models/bounties.py:36-176)
            -- Original: apps/user_profile/migrations/0038_p0_bounty_system.py
            
            CREATE TABLE IF NOT EXISTS public.user_profile_bounty (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                title varchar(200) NOT NULL,
                description text NOT NULL,
                stake_amount integer NOT NULL,
                payout_amount integer NULL,
                platform_fee integer NULL,
                status varchar(20) NOT NULL,
                created_at timestamp with time zone NOT NULL,
                accepted_at timestamp with time zone NULL,
                started_at timestamp with time zone NULL,
                result_submitted_at timestamp with time zone NULL,
                completed_at timestamp with time zone NULL,
                expires_at timestamp with time zone NOT NULL,
                ip_address inet NULL,
                user_agent varchar(255) NULL,
                acceptor_id bigint NULL,
                creator_id bigint NOT NULL,
                game_id bigint NOT NULL,
                match_id bigint NULL,
                target_user_id bigint NULL,
                winner_id bigint NULL
            );
            
            -- Indexes from migration 0038
            CREATE INDEX IF NOT EXISTS user_profile_bounty_status_205258ca 
                ON public.user_profile_bounty (status);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_status_205258ca_like 
                ON public.user_profile_bounty (status varchar_pattern_ops);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_created_at_9c6d08c2 
                ON public.user_profile_bounty (created_at);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_expires_at_c9641910 
                ON public.user_profile_bounty (expires_at);
            
            CREATE INDEX IF NOT EXISTS user_profil_status_c29cf7_idx 
                ON public.user_profile_bounty (status, expires_at);
            
            CREATE INDEX IF NOT EXISTS user_profil_creator_46af72_idx 
                ON public.user_profile_bounty (creator_id, status);
            
            CREATE INDEX IF NOT EXISTS user_profil_accepto_c96449_idx 
                ON public.user_profile_bounty (acceptor_id, status);
            
            CREATE INDEX IF NOT EXISTS user_profil_game_id_a39717_idx 
                ON public.user_profile_bounty (game_id, status);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_acceptor_id_e0f3db51 
                ON public.user_profile_bounty (acceptor_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_creator_id_4f24bc37 
                ON public.user_profile_bounty (creator_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_game_id_60aefdb3 
                ON public.user_profile_bounty (game_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_match_id_4e127632 
                ON public.user_profile_bounty (match_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_target_user_id_abcf72b0 
                ON public.user_profile_bounty (target_user_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bounty_winner_id_c2de7062 
                ON public.user_profile_bounty (winner_id);
            
            -- Foreign key constraints (NOT VALID allows existing data)
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_acceptor_id_e0f3db51_fk_accounts_user_id'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_acceptor_id_e0f3db51_fk_accounts_user_id 
                    FOREIGN KEY (acceptor_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_creator_id_4f24bc37_fk_accounts_user_id'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_creator_id_4f24bc37_fk_accounts_user_id 
                    FOREIGN KEY (creator_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_game_id_60aefdb3_fk_tournaments_game_id'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_game_id_60aefdb3_fk_tournaments_game_id 
                    FOREIGN KEY (game_id) REFERENCES tournaments_game(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_match_id_4e127632_fk_tournamen'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_match_id_4e127632_fk_tournamen 
                    FOREIGN KEY (match_id) REFERENCES tournament_engine_match_match(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_target_user_id_abcf72b0_fk_accounts_user_id'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_target_user_id_abcf72b0_fk_accounts_user_id 
                    FOREIGN KEY (target_user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bounty_winner_id_c2de7062_fk_accounts_user_id'
                    AND table_name = 'user_profile_bounty'
                ) THEN
                    ALTER TABLE public.user_profile_bounty 
                    ADD CONSTRAINT user_profile_bounty_winner_id_c2de7062_fk_accounts_user_id 
                    FOREIGN KEY (winner_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 2: user_profile_bountyproof
            -- ============================================================
            -- Source: BountyProof (apps/user_profile/models/bounties.py:274-340)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_bountyproof (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                proof_url varchar(500) NOT NULL,
                proof_type varchar(20) NOT NULL,
                description text NOT NULL,
                submitted_at timestamp with time zone NOT NULL,
                ip_address inet NULL,
                bounty_id bigint NOT NULL,
                claimed_winner_id bigint NOT NULL,
                submitted_by_id bigint NOT NULL
            );
            
            CREATE INDEX IF NOT EXISTS user_profil_bounty__92928e_idx 
                ON public.user_profile_bountyproof (bounty_id, submitted_at);
            
            CREATE INDEX IF NOT EXISTS user_profile_bountyproof_bounty_id_133bf4ad 
                ON public.user_profile_bountyproof (bounty_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bountyproof_claimed_winner_id_ce2d7909 
                ON public.user_profile_bountyproof (claimed_winner_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bountyproof_submitted_by_id_77cfcee3 
                ON public.user_profile_bountyproof (submitted_by_id);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyp_bounty_id_133bf4ad_fk_user_prof'
                    AND table_name = 'user_profile_bountyproof'
                ) THEN
                    ALTER TABLE public.user_profile_bountyproof 
                    ADD CONSTRAINT user_profile_bountyp_bounty_id_133bf4ad_fk_user_prof 
                    FOREIGN KEY (bounty_id) REFERENCES user_profile_bounty(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyp_claimed_winner_id_ce2d7909_fk_accounts_'
                    AND table_name = 'user_profile_bountyproof'
                ) THEN
                    ALTER TABLE public.user_profile_bountyproof 
                    ADD CONSTRAINT user_profile_bountyp_claimed_winner_id_ce2d7909_fk_accounts_ 
                    FOREIGN KEY (claimed_winner_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyp_submitted_by_id_77cfcee3_fk_accounts_'
                    AND table_name = 'user_profile_bountyproof'
                ) THEN
                    ALTER TABLE public.user_profile_bountyproof 
                    ADD CONSTRAINT user_profile_bountyp_submitted_by_id_77cfcee3_fk_accounts_ 
                    FOREIGN KEY (submitted_by_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 3: user_profile_bountyacceptance
            -- ============================================================
            -- Source: BountyAcceptance (apps/user_profile/models/bounties.py:241-271)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_bountyacceptance (
                bounty_id bigint NOT NULL PRIMARY KEY,
                accepted_at timestamp with time zone NOT NULL,
                ip_address inet NULL,
                user_agent varchar(255) NULL,
                acceptor_id bigint NOT NULL
            );
            
            CREATE INDEX IF NOT EXISTS user_profile_bountyacceptance_acceptor_id_ae19dd48 
                ON public.user_profile_bountyacceptance (acceptor_id);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountya_bounty_id_05c4086d_fk_user_prof'
                    AND table_name = 'user_profile_bountyacceptance'
                ) THEN
                    ALTER TABLE public.user_profile_bountyacceptance 
                    ADD CONSTRAINT user_profile_bountya_bounty_id_05c4086d_fk_user_prof 
                    FOREIGN KEY (bounty_id) REFERENCES user_profile_bounty(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountya_acceptor_id_ae19dd48_fk_accounts_'
                    AND table_name = 'user_profile_bountyacceptance'
                ) THEN
                    ALTER TABLE public.user_profile_bountyacceptance 
                    ADD CONSTRAINT user_profile_bountya_acceptor_id_ae19dd48_fk_accounts_ 
                    FOREIGN KEY (acceptor_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 4: user_profile_bountydispute
            -- ============================================================
            -- Source: BountyDispute (apps/user_profile/models/bounties.py:357-433)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_bountydispute (
                bounty_id bigint NOT NULL PRIMARY KEY,
                reason text NOT NULL,
                status varchar(20) NOT NULL,
                moderator_notes text NOT NULL,
                resolution text NOT NULL,
                created_at timestamp with time zone NOT NULL,
                resolved_at timestamp with time zone NULL,
                assigned_moderator_id bigint NULL,
                disputer_id bigint NOT NULL
            );
            
            CREATE INDEX IF NOT EXISTS user_profile_bountydispute_assigned_moderator_id_23e8d783 
                ON public.user_profile_bountydispute (assigned_moderator_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_bountydispute_disputer_id_8fdbbd44 
                ON public.user_profile_bountydispute (disputer_id);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyd_bounty_id_ef6f38ab_fk_user_prof'
                    AND table_name = 'user_profile_bountydispute'
                ) THEN
                    ALTER TABLE public.user_profile_bountydispute 
                    ADD CONSTRAINT user_profile_bountyd_bounty_id_ef6f38ab_fk_user_prof 
                    FOREIGN KEY (bounty_id) REFERENCES user_profile_bounty(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyd_assigned_moderator_i_23e8d783_fk_accounts_'
                    AND table_name = 'user_profile_bountydispute'
                ) THEN
                    ALTER TABLE public.user_profile_bountydispute 
                    ADD CONSTRAINT user_profile_bountyd_assigned_moderator_i_23e8d783_fk_accounts_ 
                    FOREIGN KEY (assigned_moderator_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_bountyd_disputer_id_8fdbbd44_fk_accounts_'
                    AND table_name = 'user_profile_bountydispute'
                ) THEN
                    ALTER TABLE public.user_profile_bountydispute 
                    ADD CONSTRAINT user_profile_bountyd_disputer_id_8fdbbd44_fk_accounts_ 
                    FOREIGN KEY (disputer_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
