# Generated by migration integrity repair on 2026-01-14
# Repairs missing tables from migrations 0046, 0048
# CareerProfile, MatchmakingPreferences, FollowRequest tables

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("user_profile", "0057_repair_missing_profile_tables_batch1"),
    ]

    operations = [
        # CareerProfile (from 0046)
        migrations.RunSQL(
            sql="""
            CREATE TABLE IF NOT EXISTS user_profile_career_profile (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                career_status varchar(20) NOT NULL,
                lft_enabled boolean NOT NULL,
                primary_roles jsonb NOT NULL,
                secondary_roles jsonb NOT NULL,
                preferred_region varchar(10) NOT NULL,
                availability varchar(20) NOT NULL,
                salary_expectation_min integer NULL,
                contract_type varchar(20) NOT NULL,
                recruiter_visibility varchar(20) NOT NULL,
                allow_direct_contracts boolean NOT NULL,
                last_updated timestamp with time zone NOT NULL,
                created_at timestamp with time zone NOT NULL,
                user_profile_id bigint NOT NULL UNIQUE,
                CONSTRAINT user_profile_career__user_profile_id_138cb99e_fk_user_prof
                    FOREIGN KEY (user_profile_id) 
                    REFERENCES user_profile_userprofile (id) 
                    DEFERRABLE INITIALLY DEFERRED
            );
            """,
            reverse_sql="-- DROP TABLE IF EXISTS user_profile_career_profile;",
        ),
        
        # MatchmakingPreferences (from 0046)
        migrations.RunSQL(
            sql="""
            CREATE TABLE IF NOT EXISTS user_profile_matchmaking_preferences (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                enabled boolean NOT NULL,
                games_enabled jsonb NOT NULL,
                preferred_modes jsonb NOT NULL,
                min_bounty integer NULL,
                max_bounty integer NULL,
                auto_accept boolean NOT NULL,
                auto_reject_below_min boolean NOT NULL,
                region_lock varchar(10) NOT NULL,
                skill_range_min integer NULL,
                skill_range_max integer NULL,
                allow_team_bounties boolean NOT NULL,
                updated_at timestamp with time zone NOT NULL,
                created_at timestamp with time zone NOT NULL,
                user_profile_id bigint NOT NULL UNIQUE,
                CONSTRAINT user_profile_matchma_user_profile_id_3fc24f49_fk_user_prof
                    FOREIGN KEY (user_profile_id) 
                    REFERENCES user_profile_userprofile (id) 
                    DEFERRABLE INITIALLY DEFERRED
            );
            """,
            reverse_sql="-- DROP TABLE IF EXISTS user_profile_matchmaking_preferences;",
        ),
        
        # FollowRequest (from 0048)
        migrations.RunSQL(
            sql="""
            CREATE TABLE IF NOT EXISTS user_profile_follow_request (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                status varchar(20) NOT NULL,
                created_at timestamp with time zone NOT NULL,
                resolved_at timestamp with time zone NULL,
                requester_id bigint NOT NULL,
                target_id bigint NOT NULL,
                CONSTRAINT follow_request_no_self_request CHECK (NOT (requester_id = target_id)),
                CONSTRAINT user_profile_follow_requ_requester_id_target_id_s_07b2787e_uniq 
                    UNIQUE (requester_id, target_id, status),
                CONSTRAINT user_profile_follow__requester_id_3a113a73_fk_user_prof
                    FOREIGN KEY (requester_id) 
                    REFERENCES user_profile_userprofile (id) 
                    DEFERRABLE INITIALLY DEFERRED,
                CONSTRAINT user_profile_follow__target_id_59c2705f_fk_user_prof
                    FOREIGN KEY (target_id) 
                    REFERENCES user_profile_userprofile (id) 
                    DEFERRABLE INITIALLY DEFERRED
            );
            
            CREATE INDEX IF NOT EXISTS user_profile_follow_request_status_d952ea54 
                ON user_profile_follow_request (status);
            CREATE INDEX IF NOT EXISTS user_profile_follow_request_status_d952ea54_like 
                ON user_profile_follow_request (status varchar_pattern_ops);
            CREATE INDEX IF NOT EXISTS user_profile_follow_request_requester_id_3a113a73 
                ON user_profile_follow_request (requester_id);
            CREATE INDEX IF NOT EXISTS user_profile_follow_request_target_id_59c2705f 
                ON user_profile_follow_request (target_id);
            CREATE INDEX IF NOT EXISTS user_profil_target__663713_idx 
                ON user_profile_follow_request (target_id, status, created_at);
            CREATE INDEX IF NOT EXISTS user_profil_request_59dc59_idx 
                ON user_profile_follow_request (requester_id, status);
            CREATE INDEX IF NOT EXISTS user_profil_status_19cb79_idx 
                ON user_profile_follow_request (status, created_at);
            """,
            reverse_sql="-- DROP TABLE IF EXISTS user_profile_follow_request;",
        ),
        
        # is_private_account column (from 0048)
        migrations.RunSQL(
            sql="""
            DO $$ 
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.columns 
                    WHERE table_name = 'user_profile_privacysettings' 
                    AND column_name = 'is_private_account'
                ) THEN
                    ALTER TABLE user_profile_privacysettings 
                    ADD COLUMN is_private_account boolean DEFAULT false NOT NULL;
                    
                    ALTER TABLE user_profile_privacysettings 
                    ALTER COLUMN is_private_account DROP DEFAULT;
                END IF;
            END $$;
            """,
            reverse_sql="-- ALTER TABLE user_profile_privacysettings DROP COLUMN IF EXISTS is_private_account;",
        ),
    ]
