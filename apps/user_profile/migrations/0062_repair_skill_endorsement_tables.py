# Generated by Copilot Agent on 2026-01-14 (REPAIR)

"""
REPAIR MIGRATION: Restore P0 Skill Endorsement Tables
======================================================
Context: Migration 0037 created 2 tables in test_schema instead of public.
Action: Ensure all endorsement tables exist in public schema with correct structure.
Source: apps/user_profile/models/endorsements.py (SkillEndorsement, EndorsementOpportunity)
Audit: Tables already moved from test_schema to public via ALTER TABLE SET SCHEMA
Purpose: Record repair in django_migrations table for audit trail
"""

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("user_profile", "0061_repair_stream_config_table"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            -- ============================================================
            -- TABLE 1: user_profile_skill_endorsement
            -- ============================================================
            -- Source: SkillEndorsement (apps/user_profile/models/endorsements.py:43-161)
            -- Original: apps/user_profile/migrations/0037_p0_skill_endorsements.py
            
            CREATE TABLE IF NOT EXISTS public.user_profile_skill_endorsement (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                skill_name varchar(20) NOT NULL,
                comment text NOT NULL,
                created_at timestamp with time zone NOT NULL,
                ip_address inet NULL,
                user_agent varchar(500) NOT NULL,
                is_flagged boolean NOT NULL,
                flag_reason text NOT NULL,
                reviewed_at timestamp with time zone NULL,
                endorser_id bigint NOT NULL,
                match_id bigint NOT NULL,
                receiver_id bigint NOT NULL,
                reviewed_by_id bigint NULL,
                CONSTRAINT unique_endorsement_per_match_endorser UNIQUE (match_id, endorser_id),
                CONSTRAINT no_self_endorsement CHECK (NOT (endorser_id = receiver_id))
            );
            
            -- Indexes from migration 0037
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_skill_name_39e7906f 
                ON public.user_profile_skill_endorsement (skill_name);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_skill_name_39e7906f_like 
                ON public.user_profile_skill_endorsement (skill_name varchar_pattern_ops);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_created_at_450df565 
                ON public.user_profile_skill_endorsement (created_at);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_endorser_id_df28d154 
                ON public.user_profile_skill_endorsement (endorser_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_match_id_c3b57f58 
                ON public.user_profile_skill_endorsement (match_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_receiver_id_a71dbb04 
                ON public.user_profile_skill_endorsement (receiver_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_skill_endorsement_reviewed_by_id_059d3a1d 
                ON public.user_profile_skill_endorsement (reviewed_by_id);
            
            CREATE INDEX IF NOT EXISTS user_profil_receive_a4e8c9_idx 
                ON public.user_profile_skill_endorsement (receiver_id, created_at DESC);
            
            CREATE INDEX IF NOT EXISTS user_profil_match_i_8b9e49_idx 
                ON public.user_profile_skill_endorsement (match_id, created_at);
            
            CREATE INDEX IF NOT EXISTS user_profil_receive_2d9b44_idx 
                ON public.user_profile_skill_endorsement (receiver_id, skill_name);
            
            CREATE INDEX IF NOT EXISTS user_profil_is_flag_148abd_idx 
                ON public.user_profile_skill_endorsement (is_flagged, created_at);
            
            -- Foreign key constraints
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_skill_e_endorser_id_df28d154_fk_accounts_'
                    AND table_name = 'user_profile_skill_endorsement'
                ) THEN
                    ALTER TABLE public.user_profile_skill_endorsement 
                    ADD CONSTRAINT user_profile_skill_e_endorser_id_df28d154_fk_accounts_ 
                    FOREIGN KEY (endorser_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_skill_e_match_id_c3b57f58_fk_tournamen'
                    AND table_name = 'user_profile_skill_endorsement'
                ) THEN
                    ALTER TABLE public.user_profile_skill_endorsement 
                    ADD CONSTRAINT user_profile_skill_e_match_id_c3b57f58_fk_tournamen 
                    FOREIGN KEY (match_id) REFERENCES tournament_engine_match_match(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_skill_e_receiver_id_a71dbb04_fk_accounts_'
                    AND table_name = 'user_profile_skill_endorsement'
                ) THEN
                    ALTER TABLE public.user_profile_skill_endorsement 
                    ADD CONSTRAINT user_profile_skill_e_receiver_id_a71dbb04_fk_accounts_ 
                    FOREIGN KEY (receiver_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_skill_e_reviewed_by_id_059d3a1d_fk_accounts_'
                    AND table_name = 'user_profile_skill_endorsement'
                ) THEN
                    ALTER TABLE public.user_profile_skill_endorsement 
                    ADD CONSTRAINT user_profile_skill_e_reviewed_by_id_059d3a1d_fk_accounts_ 
                    FOREIGN KEY (reviewed_by_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 2: user_profile_endorsement_opportunity
            -- ============================================================
            -- Source: EndorsementOpportunity (apps/user_profile/models/endorsements.py:164-235)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_endorsement_opportunity (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                expires_at timestamp with time zone NOT NULL,
                is_used boolean NOT NULL,
                used_at timestamp with time zone NULL,
                notified boolean NOT NULL,
                notified_at timestamp with time zone NULL,
                created_at timestamp with time zone NOT NULL,
                match_id bigint NOT NULL,
                player_id bigint NOT NULL,
                CONSTRAINT unique_opportunity_per_match_player UNIQUE (match_id, player_id)
            );
            
            -- Indexes
            CREATE INDEX IF NOT EXISTS user_profile_endorsement_opportunity_expires_at_005fac76 
                ON public.user_profile_endorsement_opportunity (expires_at);
            
            CREATE INDEX IF NOT EXISTS user_profile_endorsement_opportunity_match_id_56617c41 
                ON public.user_profile_endorsement_opportunity (match_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_endorsement_opportunity_player_id_25bcce33 
                ON public.user_profile_endorsement_opportunity (player_id);
            
            CREATE INDEX IF NOT EXISTS user_profil_expires_630798_idx 
                ON public.user_profile_endorsement_opportunity (expires_at, is_used);
            
            CREATE INDEX IF NOT EXISTS user_profil_player__6b9b5a_idx 
                ON public.user_profile_endorsement_opportunity (player_id, is_used, expires_at);
            
            -- Foreign key constraints
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_endorse_match_id_56617c41_fk_tournamen'
                    AND table_name = 'user_profile_endorsement_opportunity'
                ) THEN
                    ALTER TABLE public.user_profile_endorsement_opportunity 
                    ADD CONSTRAINT user_profile_endorse_match_id_56617c41_fk_tournamen 
                    FOREIGN KEY (match_id) REFERENCES tournament_engine_match_match(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_endorse_player_id_25bcce33_fk_accounts_'
                    AND table_name = 'user_profile_endorsement_opportunity'
                ) THEN
                    ALTER TABLE public.user_profile_endorsement_opportunity 
                    ADD CONSTRAINT user_profile_endorse_player_id_25bcce33_fk_accounts_ 
                    FOREIGN KEY (player_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
            END $$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
