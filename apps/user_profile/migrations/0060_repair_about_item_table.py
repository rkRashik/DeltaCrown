# Generated for schema drift repair
# Date: 2026-01-14
# Purpose: Restore missing user_profile_about_item table
#          Table was created by migration 0032 but ended up in test_schema

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('user_profile', '0059_repair_settings_tables'),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            -- Repair: Create user_profile_about_item table if missing
            -- Target public schema explicitly to avoid test_schema drift
            CREATE TABLE IF NOT EXISTS public.user_profile_about_item (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                created_at timestamp with time zone NOT NULL,
                updated_at timestamp with time zone NOT NULL,
                item_type varchar(20) NOT NULL,
                visibility varchar(20) NOT NULL,
                source_model varchar(100) NOT NULL,
                source_id integer NULL CHECK (source_id >= 0),
                display_text varchar(200) NOT NULL,
                icon_emoji varchar(10) NOT NULL,
                order_index integer NOT NULL CHECK (order_index >= 0),
                is_active boolean NOT NULL,
                user_profile_id bigint NOT NULL,
                CONSTRAINT user_profile_about_i_user_profile_id_43dd89ae_fk_user_prof
                    FOREIGN KEY (user_profile_id)
                    REFERENCES public.user_profile_userprofile (id)
                    DEFERRABLE INITIALLY DEFERRED
            );
            
            -- Create indexes if missing
            CREATE INDEX IF NOT EXISTS user_profile_about_item_user_profile_id_43dd89ae
                ON public.user_profile_about_item (user_profile_id);
            
            CREATE INDEX IF NOT EXISTS user_profil_user_pr_c20dce_idx
                ON public.user_profile_about_item (user_profile_id, is_active, order_index);
            
            CREATE INDEX IF NOT EXISTS user_profil_user_pr_d7c270_idx
                ON public.user_profile_about_item (user_profile_id, item_type);
            """,
            reverse_sql="-- No reverse operation needed (idempotent)",
        ),
    ]
