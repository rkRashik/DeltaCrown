# Generated repair migration for GamePassport tables (from test_schema)
# Original migrations: 0023 (GamePassportSchema), 0053 (Cooldown + DeleteOTP)
#
# This migration ensures all 3 GamePassport tables exist in the public schema.
# Tables were created in test_schema during Phase 15 (Dec 2025) and need to be
# restored to public schema for proper Django ORM access.
#
# Repair Date: 2026-01-14
# Tables: GamePassportSchema, GamePassportCooldown, GamePassportDeleteOTP
# Source: migrations 0023_gp1_step1_add_schema_and_game_fk, 0053_phase_9a27_otp_cooldown

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('user_profile', '0063_repair_bounty_tables'),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            -- ================================================================
            -- GAMEPASSPORTSCHEMA TABLE (from migration 0023)
            -- ================================================================
            CREATE TABLE IF NOT EXISTS public.user_profile_gamepassportschema (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                identity_fields jsonb NOT NULL,
                identity_format varchar(200) NOT NULL,
                identity_key_format varchar(200) NOT NULL,
                region_choices jsonb NOT NULL,
                region_required boolean NOT NULL,
                role_choices jsonb NOT NULL,
                rank_system varchar(50) NOT NULL,
                rank_choices jsonb NOT NULL,
                normalization_rules jsonb NOT NULL,
                platform_specific boolean NOT NULL,
                requires_verification boolean NOT NULL,
                notes text NOT NULL,
                created_at timestamp with time zone NOT NULL,
                updated_at timestamp with time zone NOT NULL,
                game_id bigint NOT NULL UNIQUE,
                -- Phase 15 additions (migration 0052)
                email_required boolean NULL,
                secondary_id_field varchar(50) NULL,
                secondary_id_required boolean NULL,
                verification_method varchar(30) NULL,
                auto_verification boolean NULL
            );

            -- Indexes for GamePassportSchema
            CREATE INDEX IF NOT EXISTS user_profile_gamepassportschema_game_id_c23a57e0 
                ON public.user_profile_gamepassportschema (game_id);

            -- FK constraints for GamePassportSchema (NOT VALID allows existing data)
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_game_id_c23a57e0_fk_games_gam'
                    AND table_name = 'user_profile_gamepassportschema'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassportschema 
                    ADD CONSTRAINT user_profile_gamepas_game_id_c23a57e0_fk_games_gam 
                    FOREIGN KEY (game_id) REFERENCES games_game(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;

            -- ================================================================
            -- GAMEPASSPORT_COOLDOWN TABLE (from migration 0053)
            -- ================================================================
            CREATE TABLE IF NOT EXISTS public.user_profile_gamepassport_cooldown (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                cooldown_type varchar(20) NOT NULL,
                reason text NOT NULL,
                created_at timestamp with time zone NOT NULL,
                expires_at timestamp with time zone NOT NULL,
                overridden boolean NOT NULL,
                overridden_at timestamp with time zone NULL,
                override_reason text NOT NULL,
                game_id bigint NOT NULL,
                overridden_by_id bigint NULL,
                user_id bigint NOT NULL,
                CONSTRAINT user_profile_gamepasspor_user_id_game_id_cooldow_468ae957_uniq 
                    UNIQUE (user_id, game_id, cooldown_type)
            );

            -- Indexes for GamePassportCooldown
            CREATE INDEX IF NOT EXISTS user_profile_gamepassport_cooldown_game_id_ef486af9 
                ON public.user_profile_gamepassport_cooldown (game_id);

            CREATE INDEX IF NOT EXISTS user_profile_gamepassport_cooldown_overridden_by_id_2f7e182a 
                ON public.user_profile_gamepassport_cooldown (overridden_by_id);

            CREATE INDEX IF NOT EXISTS user_profile_gamepassport_cooldown_user_id_1696de37 
                ON public.user_profile_gamepassport_cooldown (user_id);

            CREATE INDEX IF NOT EXISTS user_profil_user_id_13144b_idx 
                ON public.user_profile_gamepassport_cooldown (user_id, game_id, created_at DESC);

            CREATE INDEX IF NOT EXISTS user_profil_expires_2bcb99_idx 
                ON public.user_profile_gamepassport_cooldown (expires_at, overridden);

            -- FK constraints for GamePassportCooldown (NOT VALID allows existing data)
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_game_id_ef486af9_fk_games_gam'
                    AND table_name = 'user_profile_gamepassport_cooldown'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassport_cooldown 
                    ADD CONSTRAINT user_profile_gamepas_game_id_ef486af9_fk_games_gam 
                    FOREIGN KEY (game_id) REFERENCES games_game(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_overridden_by_id_2f7e182a_fk_accounts_'
                    AND table_name = 'user_profile_gamepassport_cooldown'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassport_cooldown 
                    ADD CONSTRAINT user_profile_gamepas_overridden_by_id_2f7e182a_fk_accounts_ 
                    FOREIGN KEY (overridden_by_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_user_id_1696de37_fk_accounts_'
                    AND table_name = 'user_profile_gamepassport_cooldown'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassport_cooldown 
                    ADD CONSTRAINT user_profile_gamepas_user_id_1696de37_fk_accounts_ 
                    FOREIGN KEY (user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;

            -- ================================================================
            -- GAMEPASSPORT_DELETE_OTP TABLE (from migration 0053)
            -- ================================================================
            CREATE TABLE IF NOT EXISTS public.user_profile_gamepassport_delete_otp (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                code varchar(6) NOT NULL,
                created_at timestamp with time zone NOT NULL,
                expires_at timestamp with time zone NOT NULL,
                used boolean NOT NULL,
                used_at timestamp with time zone NULL,
                ip_address inet NULL,
                passport_id bigint NOT NULL,
                user_id bigint NOT NULL
            );

            -- Indexes for GamePassportDeleteOTP
            CREATE INDEX IF NOT EXISTS user_profile_gamepassport_delete_otp_passport_id_cb8bde93 
                ON public.user_profile_gamepassport_delete_otp (passport_id);

            CREATE INDEX IF NOT EXISTS user_profile_gamepassport_delete_otp_user_id_178dbd79 
                ON public.user_profile_gamepassport_delete_otp (user_id);

            CREATE INDEX IF NOT EXISTS user_profil_user_id_d11755_idx 
                ON public.user_profile_gamepassport_delete_otp (user_id, passport_id, created_at DESC);

            CREATE INDEX IF NOT EXISTS user_profil_code_43345f_idx 
                ON public.user_profile_gamepassport_delete_otp (code, expires_at);

            -- FK constraints for GamePassportDeleteOTP (NOT VALID allows existing data)
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_passport_id_cb8bde93_fk_user_prof'
                    AND table_name = 'user_profile_gamepassport_delete_otp'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassport_delete_otp 
                    ADD CONSTRAINT user_profile_gamepas_passport_id_cb8bde93_fk_user_prof 
                    FOREIGN KEY (passport_id) REFERENCES user_profile_gameprofile(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_gamepas_user_id_178dbd79_fk_accounts_'
                    AND table_name = 'user_profile_gamepassport_delete_otp'
                ) THEN
                    ALTER TABLE public.user_profile_gamepassport_delete_otp 
                    ADD CONSTRAINT user_profile_gamepas_user_id_178dbd79_fk_accounts_ 
                    FOREIGN KEY (user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED NOT VALID;
                END IF;
            END $$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
