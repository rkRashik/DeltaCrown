# Generated by Copilot Agent on 2026-01-14 (REPAIR)

"""
REPAIR MIGRATION: Restore P0 Media Models (StreamConfig, HighlightClip, PinnedHighlight)
=========================================================================================
Context: Migration 0034 created 3 tables in test_schema instead of public.
Action: Ensure all tables exist in public schema with correct structure.
Source: apps/user_profile/models/media.py (StreamConfig, HighlightClip, PinnedHighlight)
Audit: Tables already moved from test_schema to public via ALTER TABLE SET SCHEMA
Purpose: Record repair in django_migrations table for audit trail
"""

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("user_profile", "0060_repair_about_item_table"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
            -- ============================================================
            -- TABLE 1: user_profile_stream_config
            -- ============================================================
            -- Source: StreamConfig (apps/user_profile/models/media.py:14-99)
            -- Original: apps/user_profile/migrations/0034_p0_media_models.py
            
            CREATE TABLE IF NOT EXISTS public.user_profile_stream_config (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                stream_url varchar(500) NOT NULL,
                platform varchar(20) NOT NULL,
                channel_id varchar(200) NOT NULL,
                embed_url varchar(500) NOT NULL,
                title varchar(200) NOT NULL,
                is_active boolean NOT NULL,
                created_at timestamp with time zone NOT NULL,
                updated_at timestamp with time zone NOT NULL,
                user_id bigint NOT NULL UNIQUE
            );
            
            CREATE INDEX IF NOT EXISTS user_profil_user_id_20ffb5_idx 
                ON public.user_profile_stream_config (user_id, is_active);
            
            CREATE INDEX IF NOT EXISTS user_profil_platfor_b46305_idx 
                ON public.user_profile_stream_config (platform);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_stream_config_user_id_75817ab0_fk_accounts_user_id'
                    AND table_name = 'user_profile_stream_config'
                ) THEN
                    ALTER TABLE public.user_profile_stream_config 
                    ADD CONSTRAINT user_profile_stream_config_user_id_75817ab0_fk_accounts_user_id 
                    FOREIGN KEY (user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 2: user_profile_highlight_clip
            -- ============================================================
            -- Source: HighlightClip (apps/user_profile/models/media.py:101-192)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_highlight_clip (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                clip_url varchar(500) NOT NULL,
                platform varchar(20) NOT NULL,
                video_id varchar(200) NOT NULL,
                embed_url varchar(500) NOT NULL,
                thumbnail_url varchar(500) NOT NULL,
                title varchar(200) NOT NULL,
                display_order integer NOT NULL,
                created_at timestamp with time zone NOT NULL,
                updated_at timestamp with time zone NOT NULL,
                game_id bigint NULL,
                user_id bigint NOT NULL
            );
            
            CREATE INDEX IF NOT EXISTS user_profil_user_id_70caa8_idx 
                ON public.user_profile_highlight_clip (user_id, display_order);
            
            CREATE INDEX IF NOT EXISTS user_profil_platfor_1975d9_idx 
                ON public.user_profile_highlight_clip (platform);
            
            CREATE INDEX IF NOT EXISTS user_profil_game_id_7b125a_idx 
                ON public.user_profile_highlight_clip (game_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_highlight_clip_game_id_99c6bfc4 
                ON public.user_profile_highlight_clip (game_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_highlight_clip_user_id_02b7bc42 
                ON public.user_profile_highlight_clip (user_id);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_highlight_clip_game_id_99c6bfc4_fk_games_game_id'
                    AND table_name = 'user_profile_highlight_clip'
                ) THEN
                    ALTER TABLE public.user_profile_highlight_clip 
                    ADD CONSTRAINT user_profile_highlight_clip_game_id_99c6bfc4_fk_games_game_id 
                    FOREIGN KEY (game_id) REFERENCES games_game(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_highlig_user_id_02b7bc42_fk_accounts_'
                    AND table_name = 'user_profile_highlight_clip'
                ) THEN
                    ALTER TABLE public.user_profile_highlight_clip 
                    ADD CONSTRAINT user_profile_highlig_user_id_02b7bc42_fk_accounts_ 
                    FOREIGN KEY (user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
            END $$;
            
            -- ============================================================
            -- TABLE 3: user_profile_pinned_highlight
            -- ============================================================
            -- Source: PinnedHighlight (apps/user_profile/models/media.py:194-226)
            
            CREATE TABLE IF NOT EXISTS public.user_profile_pinned_highlight (
                id bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                pinned_at timestamp with time zone NOT NULL,
                clip_id bigint NOT NULL,
                user_id bigint NOT NULL UNIQUE
            );
            
            CREATE INDEX IF NOT EXISTS user_profil_user_id_25f975_idx 
                ON public.user_profile_pinned_highlight (user_id);
            
            CREATE INDEX IF NOT EXISTS user_profile_pinned_highlight_clip_id_ec938f9b 
                ON public.user_profile_pinned_highlight (clip_id);
            
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_pinned__clip_id_ec938f9b_fk_user_prof'
                    AND table_name = 'user_profile_pinned_highlight'
                ) THEN
                    ALTER TABLE public.user_profile_pinned_highlight 
                    ADD CONSTRAINT user_profile_pinned__clip_id_ec938f9b_fk_user_prof 
                    FOREIGN KEY (clip_id) REFERENCES user_profile_highlight_clip(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
                
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.table_constraints 
                    WHERE constraint_name = 'user_profile_pinned__user_id_ea62901b_fk_accounts_'
                    AND table_name = 'user_profile_pinned_highlight'
                ) THEN
                    ALTER TABLE public.user_profile_pinned_highlight 
                    ADD CONSTRAINT user_profile_pinned__user_id_ea62901b_fk_accounts_ 
                    FOREIGN KEY (user_id) REFERENCES accounts_user(id) 
                    DEFERRABLE INITIALLY DEFERRED;
                END IF;
            END $$;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
