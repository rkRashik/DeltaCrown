# Generated by DeltaCrown vNext on 2026-02-04
"""
Data migration to normalize MembershipRole.OWNER → MembershipRole.MANAGER

vNext platform rule: OWNER role is forbidden in vNext architecture.
Use created_by + MembershipRole.MANAGER for team administration.

This migration is safe:
- Only updates rows where role == 'OWNER'
- If no OWNER rows exist, this is a no-op
- Preserves created_by field which is the true ownership indicator
"""

from django.db import migrations


def normalize_owner_to_manager(apps, schema_editor):
    """Convert all OWNER roles to MANAGER in team memberships"""
    TeamMembership = apps.get_model('organizations', 'TeamMembership')
    
    # Count OWNER memberships before normalization
    owner_count = TeamMembership.objects.filter(role='OWNER').count()
    
    if owner_count > 0:
        # Update all OWNER roles to MANAGER
        updated = TeamMembership.objects.filter(role='OWNER').update(role='MANAGER')
        print(f"✅ Normalized {updated} OWNER memberships → MANAGER")
    else:
        print("✅ No OWNER memberships found, migration is no-op")


def reverse_normalize(apps, schema_editor):
    """Reverse migration: MANAGER → OWNER (for rollback only, not recommended)"""
    # Note: We cannot safely determine which MANAGERs were originally OWNERs
    # This reverse is provided for Django migration system compatibility only
    print("⚠️  Reverse migration does not restore OWNER roles (cannot determine originals)")


class Migration(migrations.Migration):

    dependencies = [
        ('organizations', '0015_teammembershipevent'),
    ]

    operations = [
        migrations.RunPython(normalize_owner_to_manager, reverse_normalize),
    ]
