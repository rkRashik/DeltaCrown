# Generated by Django 5.2.8 on 2025-11-09
# Module 5.1: Winner Determination & Verification

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('tournaments', '0004_add_checkin_actor'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='TournamentResult',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(db_index=True, default=False, help_text='Flag indicating if this record has been soft-deleted')),
                ('deleted_at', models.DateTimeField(blank=True, help_text='Timestamp when this record was deleted', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, help_text='Timestamp when this record was created')),
                ('updated_at', models.DateTimeField(auto_now=True, help_text='Timestamp when this record was last updated')),
                ('determination_method', models.CharField(choices=[('normal', 'Normal Bracket Resolution'), ('tiebreaker', 'Tie-Breaking Rules Applied'), ('forfeit_chain', 'Forfeit Chain Winner'), ('manual', 'Manual Organizer Selection')], default='normal', help_text='Method used to determine winner', max_length=20)),
                ('rules_applied', models.JSONField(default=dict, help_text='JSONB audit trail of determination logic')),
                ('requires_review', models.BooleanField(default=False, help_text='Flag indicating organizer review needed')),
                ('created_by', models.ForeignKey(blank=True, help_text='User who triggered determination', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_tournament_results', to=settings.AUTH_USER_MODEL)),
                ('deleted_by', models.ForeignKey(blank=True, help_text='User who deleted this record', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='%(class)s_deletions', to=settings.AUTH_USER_MODEL)),
                ('final_bracket', models.ForeignKey(blank=True, help_text='Bracket used for determination', null=True, on_delete=django.db.models.deletion.SET_NULL, to='tournaments.bracket')),
                ('runner_up', models.ForeignKey(blank=True, help_text='Second place participant', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='runner_up_tournaments', to='tournaments.registration')),
                ('third_place', models.ForeignKey(blank=True, help_text='Third place participant', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='third_place_tournaments', to='tournaments.registration')),
                ('tournament', models.OneToOneField(help_text='Tournament this result belongs to', on_delete=django.db.models.deletion.CASCADE, related_name='result', to='tournaments.tournament')),
                ('winner', models.ForeignKey(help_text='Winner participant', on_delete=django.db.models.deletion.PROTECT, related_name='won_tournaments', to='tournaments.registration')),
            ],
            options={
                'verbose_name': 'Tournament Result',
                'verbose_name_plural': 'Tournament Results',
                'db_table': 'tournament_engine_result_tournamentresult',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddIndex(
            model_name='tournamentresult',
            index=models.Index(fields=['tournament'], name='idx_result_tournament'),
        ),
        migrations.AddIndex(
            model_name='tournamentresult',
            index=models.Index(fields=['winner'], name='idx_result_winner'),
        ),
        migrations.AddIndex(
            model_name='tournamentresult',
            index=models.Index(fields=['determination_method'], name='idx_result_method'),
        ),
        migrations.AddIndex(
            model_name='tournamentresult',
            index=models.Index(fields=['requires_review'], name='idx_result_review'),
        ),
        migrations.AddIndex(
            model_name='tournamentresult',
            index=models.Index(fields=['created_at'], name='idx_result_created'),
        ),
        migrations.AddConstraint(
            model_name='tournamentresult',
            constraint=models.CheckConstraint(check=~models.Q(runner_up=models.F('winner')), name='runner_up_not_winner'),
        ),
        migrations.AddConstraint(
            model_name='tournamentresult',
            constraint=models.CheckConstraint(check=models.Q(third_place__isnull=True) | (~models.Q(third_place=models.F('winner')) & ~models.Q(third_place=models.F('runner_up'))), name='third_place_unique'),
        ),
    ]
